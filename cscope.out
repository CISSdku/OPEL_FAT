cscope 15 $HOME/Îã§Ïö¥Î°úÎìú/OPEL/filesystem/fat_test/OPEL_FAT               0000248699
	@cache.c

11 
	~<löux/fs.h
>

12 
	~<löux/¶ab.h
>

13 
	~<löux/buf„r_hód.h
>

14 
	~"Át.h
"

17 
	#FAT_MAX_CACHE
 8

	)

19 
	sÁt_ˇche
 {

20 
li°_hód
 
	mˇche_li°
;

21 
	mƒ_c⁄tig
;

22 
	mf˛u°î
;

23 
	md˛u°î
;

26 
	sÁt_ˇche_id
 {

27 
	mid
;

28 
	mƒ_c⁄tig
;

29 
	mf˛u°î
;

30 
	md˛u°î
;

33 
ölöe
 
	$Át_max_ˇche
(
öode
 *inode)

35  
FAT_MAX_CACHE
;

36 
	}
}

38 
kmem_ˇche
 *
	gÁt_ˇche_ˇchï
;

40 
	$öô_⁄˚
(*
foo
)

42 
Át_ˇche
 *
ˇche
 = (Át_ˇchê*)
foo
;

44 
	`INIT_LIST_HEAD
(&
ˇche
->
ˇche_li°
);

45 
	}
}

47 
__öô
 
	$Át_ˇche_öô
()

49 
Át_ˇche_ˇchï
 = 
	`kmem_ˇche_¸óã
("fat_cache",

50 (
Át_ˇche
),

51 0, 
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
,

52 
öô_⁄˚
);

53 i‡(
Át_ˇche_ˇchï
 =
NULL
)

54  -
ENOMEM
;

56 
	}
}

58 
	$Át_ˇche_de°roy
()

60 
	`kmem_ˇche_de°roy
(
Át_ˇche_ˇchï
);

61 
	}
}

63 
ölöe
 
Át_ˇche
 *
	$Át_ˇche_Æloc
(
öode
 *inode)

65  
	`kmem_ˇche_Æloc
(
Át_ˇche_ˇchï
, 
GFP_NOFS
);

66 
	}
}

68 
ölöe
 
	$Át_ˇche_‰ì
(
Át_ˇche
 *
ˇche
)

70 
	`BUG_ON
(!
	`li°_em±y
(&
ˇche
->
ˇche_li°
));

71 
	`kmem_ˇche_‰ì
(
Át_ˇche_ˇchï
, 
ˇche
);

72 
	}
}

74 
ölöe
 
	$Át_ˇche_upd©e_Ãu
(
öode
 *inode,

75 
Át_ˇche
 *
ˇche
)

77 i‡(
	`MSDOS_I
(
öode
)->
ˇche_Ãu
.
√xt
 !&
ˇche
->
ˇche_li°
)

78 
	`li°_move
(&
ˇche
->
ˇche_li°
, &
	`MSDOS_I
(
öode
)->
ˇche_Ãu
);

79 
	}
}

81 
	$Át_ˇche_lookup
(
öode
 *öode, 
f˛us
,

82 
Át_ˇche_id
 *
cid
,

83 *
ˇched_f˛us
, *
ˇched_d˛us
)

85 
Át_ˇche
 
nohô
 = { .
f˛u°î
 = 0, };

87 
Át_ˇche
 *
hô
 = &
nohô
, *
p
;

88 
off£t
 = -1;

90 
	`•ö_lock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

91 
	`li°_f‹_óch_íåy
(
p
, &
	`MSDOS_I
(
öode
)->
ˇche_Ãu
, 
ˇche_li°
) {

93 i‡(
p
->
f˛u°î
 <
f˛us
 && 
hô
->fcluster <Ö->fcluster) {

94 
hô
 = 
p
;

95 i‡((
hô
->
f˛u°î
 + hô->
ƒ_c⁄tig
Ë< 
f˛us
) {

96 
off£t
 = 
hô
->
ƒ_c⁄tig
;

98 
off£t
 = 
f˛us
 - 
hô
->
f˛u°î
;

103 i‡(
hô
 !&
nohô
) {

104 
	`Át_ˇche_upd©e_Ãu
(
öode
, 
hô
);

106 
cid
->
id
 = 
	`MSDOS_I
(
öode
)->
ˇche_vÆid_id
;

107 
cid
->
ƒ_c⁄tig
 = 
hô
->nr_contig;

108 
cid
->
f˛u°î
 = 
hô
->fcluster;

109 
cid
->
d˛u°î
 = 
hô
->dcluster;

110 *
ˇched_f˛us
 = 
cid
->
f˛u°î
 + 
off£t
;

111 *
ˇched_d˛us
 = 
cid
->
d˛u°î
 + 
off£t
;

113 
	`•ö_u∆ock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

115  
off£t
;

116 
	}
}

118 
Át_ˇche
 *
	$Át_ˇche_mîge
(
öode
 *inode,

119 
Át_ˇche_id
 *
√w
)

121 
Át_ˇche
 *
p
;

123 
	`li°_f‹_óch_íåy
(
p
, &
	`MSDOS_I
(
öode
)->
ˇche_Ãu
, 
ˇche_li°
) {

125 i‡(
p
->
f˛u°î
 =
√w
->fcluster) {

126 
	`BUG_ON
(
p
->
d˛u°î
 !
√w
->dcluster);

127 i‡(
√w
->
ƒ_c⁄tig
 > 
p
->nr_contig)

128 
p
->
ƒ_c⁄tig
 = 
√w
->nr_contig;

129  
p
;

132  
NULL
;

133 
	}
}

135 
	$Át_ˇche_add
(
öode
 *öode, 
Át_ˇche_id
 *
√w
)

137 
Át_ˇche
 *
ˇche
, *
tmp
;

139 i‡(
√w
->
f˛u°î
 == -1)

142 
	`•ö_lock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

143 i‡(
√w
->
id
 !
FAT_CACHE_VALID
 &&

144 
√w
->
id
 !
	`MSDOS_I
(
öode
)->
ˇche_vÆid_id
)

145 
out
;

147 
ˇche
 = 
	`Át_ˇche_mîge
(
öode
, 
√w
);

148 i‡(
ˇche
 =
NULL
) {

149 i‡(
	`MSDOS_I
(
öode
)->
ƒ_ˇches
 < 
	`Át_max_ˇche
(inode)) {

150 
	`MSDOS_I
(
öode
)->
ƒ_ˇches
++;

151 
	`•ö_u∆ock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

153 
tmp
 = 
	`Át_ˇche_Æloc
(
öode
);

154 i‡(!
tmp
) {

155 
	`•ö_lock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

156 
	`MSDOS_I
(
öode
)->
ƒ_ˇches
--;

157 
	`•ö_u∆ock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

161 
	`•ö_lock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

162 
ˇche
 = 
	`Át_ˇche_mîge
(
öode
, 
√w
);

163 i‡(
ˇche
 !
NULL
) {

164 
	`MSDOS_I
(
öode
)->
ƒ_ˇches
--;

165 
	`Át_ˇche_‰ì
(
tmp
);

166 
out_upd©e_Ãu
;

168 
ˇche
 = 
tmp
;

170 
li°_hód
 *
p
 = 
	`MSDOS_I
(
öode
)->
ˇche_Ãu
.
¥ev
;

171 
ˇche
 = 
	`li°_íåy
(
p
, 
Át_ˇche
, 
ˇche_li°
);

173 
ˇche
->
f˛u°î
 = 
√w
->fcluster;

174 
ˇche
->
d˛u°î
 = 
√w
->dcluster;

175 
ˇche
->
ƒ_c⁄tig
 = 
√w
->nr_contig;

177 
out_upd©e_Ãu
:

178 
	`Át_ˇche_upd©e_Ãu
(
öode
, 
ˇche
);

179 
out
:

180 
	`•ö_u∆ock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

181 
	}
}

187 
	$__Át_ˇche_övÆ_öode
(
öode
 *inode)

189 
msdos_öode_öfo
 *
i
 = 
	`MSDOS_I
(
öode
);

190 
Át_ˇche
 *
ˇche
;

192 !
	`li°_em±y
(&
i
->
ˇche_Ãu
)) {

193 
ˇche
 = 
	`li°_íåy
(
i
->
ˇche_Ãu
.
√xt
,

194 
Át_ˇche
, 
ˇche_li°
);

195 
	`li°_dñ_öô
(&
ˇche
->
ˇche_li°
);

196 
i
->
ƒ_ˇches
--;

197 
	`Át_ˇche_‰ì
(
ˇche
);

200 
i
->
ˇche_vÆid_id
++;

201 i‡(
i
->
ˇche_vÆid_id
 =
FAT_CACHE_VALID
)

202 
i
->
ˇche_vÆid_id
++;

203 
	}
}

205 
	$Át_ˇche_övÆ_öode
(
öode
 *inode)

207 
	`•ö_lock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

208 
	`__Át_ˇche_övÆ_öode
(
öode
);

209 
	`•ö_u∆ock
(&
	`MSDOS_I
(
öode
)->
ˇche_Ãu_lock
);

210 
	}
}

212 
ölöe
 
	$ˇche_c⁄tiguous
(
Át_ˇche_id
 *
cid
, 
d˛us
)

214 
cid
->
ƒ_c⁄tig
++;

215  ((
cid
->
d˛u°î
 + cid->
ƒ_c⁄tig
Ë=
d˛us
);

216 
	}
}

218 
ölöe
 
	$ˇche_öô
(
Át_ˇche_id
 *
cid
, 
f˛us
, 
d˛us
)

220 
cid
->
id
 = 
FAT_CACHE_VALID
;

221 
cid
->
f˛u°î
 = 
f˛us
;

222 
cid
->
d˛u°î
 = 
d˛us
;

223 
cid
->
ƒ_c⁄tig
 = 0;

224 
	}
}

226 
	$Át_gë_˛u°î
(
öode
 *öode, 
˛u°î
, *
f˛us
, *
d˛us
)

228 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

229 c⁄° 
limô
 = 
sb
->
s_maxbyãs
 >> 
	`MSDOS_SB
(sb)->
˛u°î_bôs
;

230 
Át_íåy
 
Áã¡
;

231 
Át_ˇche_id
 
cid
;

232 
ƒ
;

234 
	`BUG_ON
(
	`MSDOS_I
(
öode
)->
i_°¨t
 == 0);

236 *
f˛us
 = 0;

237 *
d˛us
 = 
	`MSDOS_I
(
öode
)->
i_°¨t
;

238 i‡(
˛u°î
 == 0)

241 i‡(
	`Át_ˇche_lookup
(
öode
, 
˛u°î
, &
cid
, 
f˛us
, 
d˛us
) < 0) {

246 
	`ˇche_öô
(&
cid
, -1, -1);

249 
	`Áã¡_öô
(&
Áã¡
);

250 *
f˛us
 < 
˛u°î
) {

252 i‡(*
f˛us
 > 
limô
) {

253 
	`Át_fs_îr‹_øãlimô
(
sb
,

255 " (i_po†%Œd)", 
__func__
,

256 
	`MSDOS_I
(
öode
)->
i_pos
);

257 
ƒ
 = -
EIO
;

258 
out
;

261 
ƒ
 = 
	`Át_ít_ªad
(
öode
, &
Áã¡
, *
d˛us
);

262 i‡(
ƒ
 < 0)

263 
out
;

264 i‡(
ƒ
 =
FAT_ENT_FREE
) {

265 
	`Át_fs_îr‹_øãlimô
(
sb
,

267 
__func__
,

268 
	`MSDOS_I
(
öode
)->
i_pos
);

269 
ƒ
 = -
EIO
;

270 
out
;

271 } i‡(
ƒ
 =
FAT_ENT_EOF
) {

272 
	`Át_ˇche_add
(
öode
, &
cid
);

273 
out
;

275 (*
f˛us
)++;

276 *
d˛us
 = 
ƒ
;

277 i‡(!
	`ˇche_c⁄tiguous
(&
cid
, *
d˛us
))

278 
	`ˇche_öô
(&
cid
, *
f˛us
, *
d˛us
);

280 
ƒ
 = 0;

281 
	`Át_ˇche_add
(
öode
, &
cid
);

282 
out
:

283 
	`Áã¡_bªl£
(&
Áã¡
);

284  
ƒ
;

285 
	}
}

287 
	$Át_bm≠_˛u°î
(
öode
 *öode, 
˛u°î
)

289 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

290 
ªt
, 
f˛us
, 
d˛us
;

292 i‡(
	`MSDOS_I
(
öode
)->
i_°¨t
 == 0)

295 
ªt
 = 
	`Át_gë_˛u°î
(
öode
, 
˛u°î
, &
f˛us
, &
d˛us
);

296 i‡(
ªt
 < 0)

297  
ªt
;

298 i‡(
ªt
 =
FAT_ENT_EOF
) {

299 
	`Át_fs_îr‹
(
sb
, "%s:Ñequest beyond EOF (i_pos %lld)",

300 
__func__
, 
	`MSDOS_I
(
öode
)->
i_pos
);

301  -
EIO
;

303  
d˛us
;

304 
	}
}

306 
	$Át_bm≠
(
öode
 *öode, 
£˘‹_t
 
£˘‹
, se˘‹_à*
phys
,

307 *
m≠≥d_blocks
, 
¸óã
)

309 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

310 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

311 c⁄° 
blocksize
 = 
sb
->
s_blocksize
;

312 c⁄° 
blocksize_bôs
 = 
sb
->
s_blocksize_bôs
;

313 
£˘‹_t
 
œ°_block
;

314 
˛u°î
, 
off£t
;

316 *
phys
 = 0;

317 *
m≠≥d_blocks
 = 0;

318 i‡((
sbi
->
Át_bôs
 !32Ë&& (
öode
->
i_öo
 =
MSDOS_ROOT_INO
)) {

319 i‡(
£˘‹
 < (
sbi
->
dú_íåõs
 >> sbi->
dú_≥r_block_bôs
)) {

320 *
phys
 = 
£˘‹
 + 
sbi
->
dú_°¨t
;

321 *
m≠≥d_blocks
 = 1;

326 
œ°_block
 = (
	`i_size_ªad
(
öode
Ë+ (
blocksize
 - 1)Ë>> 
blocksize_bôs
;

327 i‡(
£˘‹
 >
œ°_block
) {

328 i‡(!
¸óã
)

335 
œ°_block
 = (
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 + (
blocksize
 - 1))

336 >> 
blocksize_bôs
;

337 i‡(
£˘‹
 >
œ°_block
)

341 
˛u°î
 = 
£˘‹
 >> (
sbi
->
˛u°î_bôs
 - 
sb
->
s_blocksize_bôs
);

342 
off£t
 = 
£˘‹
 & (
sbi
->
£c_≥r_˛us
 - 1);

343 
˛u°î
 = 
	`Át_bm≠_˛u°î
(
öode
, cluster);

344 i‡(
˛u°î
 < 0)

345  
˛u°î
;

346 i‡(
˛u°î
) {

347 *
phys
 = 
	`Át_˛us_to_blkƒ
(
sbi
, 
˛u°î
Ë+ 
off£t
;

348 *
m≠≥d_blocks
 = 
sbi
->
£c_≥r_˛us
 - 
off£t
;

349 i‡(*
m≠≥d_blocks
 > 
œ°_block
 - 
£˘‹
)

350 *
m≠≥d_blocks
 = 
œ°_block
 - 
£˘‹
;

353 
	}
}

	@config.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/öô.h
>

3 
	~<löux/time.h
>

4 
	~<löux/¶ab.h
>

5 
	~<löux/£q_fûe.h
>

6 
	~<löux/∑gem≠.h
>

7 
	~<löux/m∑ge.h
>

8 
	~<löux/buf„r_hód.h
>

9 
	~<löux/exp‹tfs.h
>

10 
	~<löux/mou¡.h
>

11 
	~<löux/vfs.h
>

12 
	~<löux/∑r£r.h
>

13 
	~<löux/uio.h
>

14 
	~<löux/wrôeback.h
>

15 
	~<löux/log2.h
>

16 
	~<löux/hash.h
>

17 
	~<asm/u«lig√d.h
>

18 
	~"Át.h
"

20 
	gmsdos_«me
[ 
MSDOS_NAME
 ] = "BXFS_CONFAT";

24 
	$buûd_c⁄fig_fûe
–
öode
 *
dú
, 
díåy
 *díåy, 
mode
 )

26 
msdos_dú_íåy
 
de
;

27 
Át_¶Ÿ_öfo
 
söfo
;

28 
Át_¶Ÿ_öfo
 *
_söfo
 = &
söfo
;

29 
öode
 *öodê
NULL
;

30 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

32 
˛u°î_num
 = 0;

33 
îr
;

38 
	`mem˝y
–
de
.
«me
, 
msdos_«me
, 
MSDOS_NAME
 );

40 
de
.
©å
 = 0 ? 
ATTR_DIR
 : 
ATTR_ARCH
;

41 
de
.
lˇ£
 = 0;

42 
de
.
cd©e
 = de.
ad©e
 = 0;

43 
de
.
˘ime
 = 0;

44 
de
.
˘ime_cs
 = 0;

45 
de
.
time
 = 0;

46 
de
.
d©e
 = 0;

47 
de
.
°¨t
 = 
	`˝u_to_À16
(
˛u°î_num
);

48 
de
.
°¨thi
 = 
	`˝u_to_À16
(
˛u°î_num
) >> 16;

49 
de
.
size
 = 272 ;

51 
îr
 = 
	`Át_add_íåõs
–
dú
, &
de
, 1, 
_söfo
 );

52 
öode
 = 
	`Át_buûd_öode
–
sb
, 
söfo
.
de
, söfo.
i_pos
 );

54 
	`bªl£
–
söfo
.
bh
 );

56 i‡(
	`IS_ERR
(
öode
)) {

57 
îr
 = 
	`PTR_ERR
(
öode
);

58 
	`¥ötk
("[gandan] Errorábout inode...\n");

59 
out
;

61 
	`¥ötk
("[gandan] Complete Create Config File \n");

63 
out
:

64  
îr
;

65 
	}
}

70 
	$Át_c⁄fig_öô
(
su≥r_block
 *
sb
)

72 
Át_¶Ÿ_öfo
 
söfo
;

73 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

74 
díåy
 *
roŸ_de
 = 
sb
->
s_roŸ
;

75 
öode
 *
roŸ
 = 
roŸ_de
->
d_öode
;

76 
îr
;

78 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_config_initÅest\n");

80 
sbi
->
bx_¨ó_øtio
[ 
BB_ETC
 ] = 7;

81 
sbi
->
bx_¨ó_øtio
[ 
BB_NORMAL
 ] = 70;

82 
sbi
->
bx_¨ó_øtio
[ 
BB_NORMAL_EVENT
 ] = 20;

83 
sbi
->
bx_¨ó_øtio
[ 
BB_PARKING
 ] = 7;

84 
sbi
->
bx_¨ó_øtio
[ 
BB_MANUAL
 ] = 2;

85 
sbi
->
bx_¨ó_øtio
[ 
BB_IMAGE
 ] = 2;

93 if–!
	`Át_sˇn
–
roŸ
, 
msdos_«me
, &
söfo
 ) )

95 
	`bªl£
–
söfo
.
bh
 );

96 
	`¥ötk
–
KERN_ALERT
 "[cheon] config fileálreadyÉxist\n");

97 
exi°
;

101 
	`¥ötk
–
KERN_ALERT
 "[cheon] Create config file \n ");

102 
îr
 = 
	`buûd_c⁄fig_fûe
–
roŸ
, 
roŸ_de
, 0 );

105 
exi°
:

108 
	}
}

109 
EXPORT_SYMBOL_GPL
–
Át_c⁄fig_öô
 );

	@dir.c

16 
	~<löux/moduÀ.h
>

17 
	~<löux/¶ab.h
>

18 
	~<löux/time.h
>

19 
	~<löux/buf„r_hód.h
>

20 
	~<löux/com∑t.h
>

21 
	~<löux/uac˚ss.h
>

22 
	~<löux/kî√l.h
>

23 
	~"Át.h
"

30 
	#FAT_MAX_SHORT_SIZE
 ((
MSDOS_NAME
 + 1Ë* 
NLS_MAX_CHARSET_SIZE
 + 1)

	)

35 
	#FAT_MAX_UNI_CHARS
 ((
MSDOS_SLOTS
 - 1Ë* 13 + 1)

	)

36 
	#FAT_MAX_UNI_SIZE
 (
FAT_MAX_UNI_CHARS
 * (
wch¨_t
))

	)

38 
ölöe
 
	$Át_tﬁowî
(
c
)

40  ((
c
 >= 'A') && (c <= 'Z')) ? c+32 : c;

41 
	}
}

43 
ölöe
 
loff_t
 
	$Át_make_i_pos
(
su≥r_block
 *
sb
,

44 
buf„r_hód
 *
bh
,

45 
msdos_dú_íåy
 *
de
)

47  ((
loff_t
)
bh
->
b_blockƒ
 << 
	`MSDOS_SB
(
sb
)->
dú_≥r_block_bôs
)

48 | (
de
 - (
msdos_dú_íåy
 *)
bh
->
b_d©a
);

49 
	}
}

51 
ölöe
 
	$Át_dú_ªadahód
(
öode
 *
dú
, 
£˘‹_t
 
iblock
,

52 
£˘‹_t
 
phys
)

54 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

55 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

56 
buf„r_hód
 *
bh
;

57 
£c
;

60 i‡((
iblock
 & (
sbi
->
£c_≥r_˛us
 - 1)) || sbi->sec_per_clus == 1)

63 i‡((
sbi
->
Át_bôs
 !32Ë&& (
dú
->
i_öo
 =
MSDOS_ROOT_INO
))

66 
bh
 = 
	`sb_föd_gë_block
(
sb
, 
phys
);

67 i‡(
bh
 =
NULL
 || !
	`buf„r_u±od©e
(bh)) {

68 
£c
 = 0; se¯< 
sbi
->
£c_≥r_˛us
; sec++)

69 
	`sb_bªadahód
(
sb
, 
phys
 + 
£c
);

71 
	`bªl£
(
bh
);

72 
	}
}

84 
	$Át__gë_íåy
(
öode
 *
dú
, 
loff_t
 *
pos
,

85 
buf„r_hód
 **
bh
, 
msdos_dú_íåy
 **
de
)

87 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

88 
£˘‹_t
 
phys
, 
iblock
;

89 
m≠≥d_blocks
;

90 
îr
, 
off£t
;

92 
√xt
:

93 i‡(*
bh
)

94 
	`bªl£
(*
bh
);

96 *
bh
 = 
NULL
;

97 
iblock
 = *
pos
 >> 
sb
->
s_blocksize_bôs
;

98 
îr
 = 
	`Át_bm≠
(
dú
, 
iblock
, &
phys
, &
m≠≥d_blocks
, 0);

99 i‡(
îr
 || !
phys
)

102 
	`Át_dú_ªadahód
(
dú
, 
iblock
, 
phys
);

104 *
bh
 = 
	`sb_bªad
(
sb
, 
phys
);

105 i‡(*
bh
 =
NULL
) {

106 
	`Át_msg_øãlimô
(
sb
, 
KERN_ERR
,

107 "Dúe˘‹y bªad(block %ŒuËÁûed", (
Œu
)
phys
);

109 *
pos
 = (
iblock
 + 1Ë<< 
sb
->
s_blocksize_bôs
;

110 
√xt
;

113 
off£t
 = *
pos
 & (
sb
->
s_blocksize
 - 1);

114 *
pos
 +(
msdos_dú_íåy
);

115 *
de
 = (
msdos_dú_íåy
 *)((*
bh
)->
b_d©a
 + 
off£t
);

118 
	}
}

120 
ölöe
 
	$Át_gë_íåy
(
öode
 *
dú
, 
loff_t
 *
pos
,

121 
buf„r_hód
 **
bh
,

122 
msdos_dú_íåy
 **
de
)

125 i‡(*
bh
 && *
de
 &&

126 (*
de
 - (
msdos_dú_íåy
 *)(*
bh
)->
b_d©a
) <

127 
	`MSDOS_SB
(
dú
->
i_sb
)->
dú_≥r_block
 - 1) {

128 *
pos
 +(
msdos_dú_íåy
);

129 (*
de
)++;

132  
	`Át__gë_íåy
(
dú
, 
pos
, 
bh
, 
de
);

133 
	}
}

145 
	$uni16_to_x8
(
su≥r_block
 *
sb
, *
ascii
,

146 c⁄° 
wch¨_t
 *
uni
, 
Àn
, 
∆s_èbÀ
 *
∆s
)

148 
uni_xœã
 = 
	`MSDOS_SB
(
sb
)->
›ti⁄s
.
unicode_xœã
;

149 c⁄° 
wch¨_t
 *
ù
;

150 
wch¨_t
 
ec
;

151 *
›
;

152 
ch¨Àn
;

154 
ù
 = 
uni
;

155 
›
 = 
ascii
;

157 *
ù
 && ((
Àn
 - 
NLS_MAX_CHARSET_SIZE
) > 0)) {

158 
ec
 = *
ù
++;

159 
ch¨Àn
 = 
∆s
->
	`uni2ch¨
(
ec
, 
›
, 
NLS_MAX_CHARSET_SIZE
);

160 i‡(
ch¨Àn
 > 0) {

161 
›
 +
ch¨Àn
;

162 
Àn
 -
ch¨Àn
;

164 i‡(
uni_xœã
 == 1) {

165 *
›
++ = ':';

166 
›
 = 
	`hex_byã_∑ck
(›, 
ec
 >> 8);

167 
›
 = 
	`hex_byã_∑ck
(›, 
ec
);

168 
Àn
 -= 5;

170 *
›
++ = '?';

171 
Àn
--;

176 i‡(
	`u∆ikñy
(*
ù
)) {

177 
	`Át_msg
(
sb
, 
KERN_WARNING
,

181 *
›
 = 0;

182  
›
 - 
ascii
;

183 
	}
}

185 
ölöe
 
	$Át_uni_to_x8
(
su≥r_block
 *
sb
, c⁄° 
wch¨_t
 *
uni
,

186 *
buf
, 
size
)

188 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

189 i‡(
sbi
->
›ti⁄s
.
utf8
)

190  
	`utf16s_to_utf8s
(
uni
, 
FAT_MAX_UNI_CHARS
,

191 
UTF16_HOST_ENDIAN
, 
buf
, 
size
);

193  
	`uni16_to_x8
(
sb
, 
buf
, 
uni
, 
size
, 
sbi
->
∆s_io
);

194 
	}
}

196 
ölöe
 

197 
	$Át_sh‹t2uni
(
∆s_èbÀ
 *
t
, *
c
, 
˛í
, 
wch¨_t
 *
uni
)

199 
ch¨Àn
;

201 
ch¨Àn
 = 
t
->
	`ch¨2uni
(
c
, 
˛í
, 
uni
);

202 i‡(
ch¨Àn
 < 0) {

203 *
uni
 = 0x003f;

204 
ch¨Àn
 = 1;

206  
ch¨Àn
;

207 
	}
}

209 
ölöe
 

210 
	$Át_sh‹t2lowî_uni
(
∆s_èbÀ
 *
t
, *
c
,

211 
˛í
, 
wch¨_t
 *
uni
)

213 
ch¨Àn
;

214 
wch¨_t
 
wc
;

216 
ch¨Àn
 = 
t
->
	`ch¨2uni
(
c
, 
˛í
, &
wc
);

217 i‡(
ch¨Àn
 < 0) {

218 *
uni
 = 0x003f;

219 
ch¨Àn
 = 1;

220 } i‡(
ch¨Àn
 <= 1) {

221 
nc
 = 
t
->
ch¨£t2lowî
[*
c
];

223 i‡(!
nc
)

224 
nc
 = *
c
;

226 
ch¨Àn
 = 
t
->
	`ch¨2uni
(&
nc
, 1, 
uni
);

227 i‡(
ch¨Àn
 < 0) {

228 *
uni
 = 0x003f;

229 
ch¨Àn
 = 1;

232 *
uni
 = 
wc
;

234  
ch¨Àn
;

235 
	}
}

237 
ölöe
 

238 
	$Át_sh‹äame2uni
(
∆s_èbÀ
 *
∆s
, *
buf
, 
buf_size
,

239 
wch¨_t
 *
uni_buf
, 
›t
, 
lowî
)

241 
Àn
 = 0;

243 i‡(
›t
 & 
VFAT_SFN_DISPLAY_LOWER
)

244 
Àn
 = 
	`Át_sh‹t2lowî_uni
(
∆s
, 
buf
, 
buf_size
, 
uni_buf
);

245 i‡(
›t
 & 
VFAT_SFN_DISPLAY_WIN95
)

246 
Àn
 = 
	`Át_sh‹t2uni
(
∆s
, 
buf
, 
buf_size
, 
uni_buf
);

247 i‡(
›t
 & 
VFAT_SFN_DISPLAY_WINNT
) {

248 i‡(
lowî
)

249 
Àn
 = 
	`Át_sh‹t2lowî_uni
(
∆s
, 
buf
, 
buf_size
, 
uni_buf
);

251 
Àn
 = 
	`Át_sh‹t2uni
(
∆s
, 
buf
, 
buf_size
, 
uni_buf
);

253 
Àn
 = 
	`Át_sh‹t2uni
(
∆s
, 
buf
, 
buf_size
, 
uni_buf
);

255  
Àn
;

256 
	}
}

258 
ölöe
 
	$Át_«me_m©ch
(
msdos_sb_öfo
 *
sbi
,

259 c⁄° *
a
, 
a_Àn
,

260 c⁄° *
b
, 
b_Àn
)

262 i‡(
a_Àn
 !
b_Àn
)

265 i‡(
sbi
->
›ti⁄s
.
«me_check
 != 's')

266  !
	`∆s_°∫icmp
(
sbi
->
∆s_io
, 
a
, 
b
, 
a_Àn
);

268  !
	`memcmp
(
a
, 
b
, 
a_Àn
);

269 
	}
}

271 íum { 
	mPARSE_INVALID
 = 1, 
	mPARSE_NOT_LONGNAME
, 
	mPARSE_EOF
, };

283 
	$Át_∑r£_l⁄g
(
öode
 *
dú
, 
loff_t
 *
pos
,

284 
buf„r_hód
 **
bh
, 
msdos_dú_íåy
 **
de
,

285 
wch¨_t
 **
unicode
, *
ƒ_¶Ÿs
)

287 
msdos_dú_¶Ÿ
 *
ds
;

288 
id
, 
¶Ÿ
, 
¶Ÿs
, 
Æüs_checksum
;

290 i‡(!*
unicode
) {

291 *
unicode
 = 
	`__gë«me
();

292 i‡(!*
unicode
) {

293 
	`bªl£
(*
bh
);

294  -
ENOMEM
;

297 
∑r£_l⁄g
:

298 
¶Ÿs
 = 0;

299 
ds
 = (
msdos_dú_¶Ÿ
 *)*
de
;

300 
id
 = 
ds
->id;

301 i‡(!(
id
 & 0x40))

302  
PARSE_INVALID
;

303 
¶Ÿs
 = 
id
 & ~0x40;

304 i‡(
¶Ÿs
 > 20 || !slots)

305  
PARSE_INVALID
;

306 *
ƒ_¶Ÿs
 = 
¶Ÿs
;

307 
Æüs_checksum
 = 
ds
->alias_checksum;

309 
¶Ÿ
 = 
¶Ÿs
;

311 
off£t
;

313 
¶Ÿ
--;

314 
off£t
 = 
¶Ÿ
 * 13;

315 
	`Át16_towch¨
(*
unicode
 + 
off£t
, 
ds
->
«me0_4
, 5);

316 
	`Át16_towch¨
(*
unicode
 + 
off£t
 + 5, 
ds
->
«me5_10
, 6);

317 
	`Át16_towch¨
(*
unicode
 + 
off£t
 + 11, 
ds
->
«me11_12
, 2);

319 i‡(
ds
->
id
 & 0x40)

320 (*
unicode
)[
off£t
 + 13] = 0;

321 i‡(
	`Át_gë_íåy
(
dú
, 
pos
, 
bh
, 
de
) < 0)

322  
PARSE_EOF
;

323 i‡(
¶Ÿ
 == 0)

325 
ds
 = (
msdos_dú_¶Ÿ
 *)*
de
;

326 i‡(
ds
->
©å
 !
ATTR_EXT
)

327  
PARSE_NOT_LONGNAME
;

328 i‡((
ds
->
id
 & ~0x40Ë!
¶Ÿ
)

329 
∑r£_l⁄g
;

330 i‡(
ds
->
Æüs_checksum
 !=álias_checksum)

331 
∑r£_l⁄g
;

333 i‡((*
de
)->
«me
[0] =
DELETED_FLAG
)

335 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_parse_long / DELETED_FLAG \n ");

336  
PARSE_INVALID
;

338 i‡((*
de
)->
©å
 =
ATTR_EXT
)

339 
∑r£_l⁄g
;

340 i‡(
	`IS_FREE
((*
de
)->
«me
Ë|| ((*de)->
©å
 & 
ATTR_VOLUME
))

341  
PARSE_INVALID
;

342 i‡(
	`Át_checksum
((*
de
)->
«me
Ë!
Æüs_checksum
)

343 *
ƒ_¶Ÿs
 = 0;

346 
	}
}

357 
	$Át_∑r£_sh‹t
(
su≥r_block
 *
sb
,

358 c⁄° 
msdos_dú_íåy
 *
de
,

359 *
«me
, 
dŸ_hiddí
)

361 c⁄° 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

362 
isvÁt
 = 
sbi
->
›ti⁄s
.isvfat;

363 
noˇ£
 = 
sbi
->
›ti⁄s
.nocase;

364 
›t_sh‹äame
 = 
sbi
->
›ti⁄s
.
sh‹äame
;

365 
∆s_èbÀ
 *
∆s_disk
 = 
sbi
->nls_disk;

366 
wch¨_t
 
uni_«me
[14];

367 
c
, 
w‹k
[
MSDOS_NAME
];

368 *
±«me
 = 
«me
;

369 
chi
, 
chl
, 
i
, 
j
, 
k
;

370 
dŸoff£t
 = 0;

371 
«me_Àn
 = 0, 
uni_Àn
 = 0;

373 i‡(!
isvÁt
 && 
dŸ_hiddí
 && (
de
->
©å
 & 
ATTR_HIDDEN
)) {

374 *
±«me
++ = '.';

375 
dŸoff£t
 = 1;

378 
	`mem˝y
(
w‹k
, 
de
->
«me
, (work));

380 i‡(
w‹k
[0] == 0x05)

381 
w‹k
[0] = 0xE5;

384 
i
 = 0, 
j
 = 0; i < 8;) {

385 
c
 = 
w‹k
[
i
];

386 i‡(!
c
)

388 
chl
 = 
	`Át_sh‹äame2uni
(
∆s_disk
, &
w‹k
[
i
], 8 - i,

389 &
uni_«me
[
j
++], 
›t_sh‹äame
,

390 
de
->
lˇ£
 & 
CASE_LOWER_BASE
);

391 i‡(
chl
 <= 1) {

392 i‡(!
isvÁt
)

393 
±«me
[
i
] = 
noˇ£
 ? 
c
 : 
	`Át_tﬁowî
(c);

394 
i
++;

395 i‡(
c
 != ' ') {

396 
«me_Àn
 = 
i
;

397 
uni_Àn
 = 
j
;

400 
uni_Àn
 = 
j
;

401 i‡(
isvÁt
)

402 
i
 +
	`mö
(
chl
, 8-i);

404 
chi
 = 0; chò< 
chl
 && 
i
 < 8; chi++, i++)

405 
±«me
[
i
] = 
w‹k
[i];

407 i‡(
chl
)

408 
«me_Àn
 = 
i
;

412 
i
 = 
«me_Àn
;

413 
j
 = 
uni_Àn
;

414 
	`Át_sh‹t2uni
(
∆s_disk
, ".", 1, &
uni_«me
[
j
++]);

415 i‡(!
isvÁt
)

416 
±«me
[
i
] = '.';

417 
i
++;

420 
k
 = 8; k < 
MSDOS_NAME
;) {

421 
c
 = 
w‹k
[
k
];

422 i‡(!
c
)

424 
chl
 = 
	`Át_sh‹äame2uni
(
∆s_disk
, &
w‹k
[
k
], 
MSDOS_NAME
 - k,

425 &
uni_«me
[
j
++], 
›t_sh‹äame
,

426 
de
->
lˇ£
 & 
CASE_LOWER_EXT
);

427 i‡(
chl
 <= 1) {

428 
k
++;

429 i‡(!
isvÁt
)

430 
±«me
[
i
] = 
noˇ£
 ? 
c
 : 
	`Át_tﬁowî
(c);

431 
i
++;

432 i‡(
c
 != ' ') {

433 
«me_Àn
 = 
i
;

434 
uni_Àn
 = 
j
;

437 
uni_Àn
 = 
j
;

438 i‡(
isvÁt
) {

439 
off£t
 = 
	`mö
(
chl
, 
MSDOS_NAME
-
k
);

440 
k
 +
off£t
;

441 
i
 +
off£t
;

443 
chi
 = 0; chò< 
chl
 && 
k
 < 
MSDOS_NAME
;

444 
chi
++, 
i
++, 
k
++) {

445 
±«me
[
i
] = 
w‹k
[
k
];

448 i‡(
chl
)

449 
«me_Àn
 = 
i
;

453 i‡(
«me_Àn
 > 0) {

454 
«me_Àn
 +
dŸoff£t
;

456 i‡(
sbi
->
›ti⁄s
.
isvÁt
) {

457 
uni_«me
[
uni_Àn
] = 0x0000;

458 
«me_Àn
 = 
	`Át_uni_to_x8
(
sb
, 
uni_«me
, 
«me
,

459 
FAT_MAX_SHORT_SIZE
);

463  
«me_Àn
;

464 
	}
}

469 
	$Át_£¨ch_l⁄g
(
öode
 *öode, c⁄° *
«me
,

470 
«me_Àn
, 
Át_¶Ÿ_öfo
 *
söfo
)

472 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

473 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

474 
buf„r_hód
 *
bh
 = 
NULL
;

475 
msdos_dú_íåy
 *
de
;

476 
ƒ_¶Ÿs
;

477 
wch¨_t
 *
unicode
 = 
NULL
;

478 
bu‚ame
[
FAT_MAX_SHORT_SIZE
];

479 
loff_t
 
˝os
 = 0;

480 
îr
, 
Àn
;

482 
îr
 = -
ENOENT
;

484 i‡(
	`Át_gë_íåy
(
öode
, &
˝os
, &
bh
, &
de
) == -1)

485 
íd_of_dú
;

486 
∑r£_ªc‹d
:

487 
ƒ_¶Ÿs
 = 0;

488 i‡(
de
->
«me
[0] =
DELETED_FLAG
)

493 i‡(
de
->
©å
 !
ATTR_EXT
 && (de->©å & 
ATTR_VOLUME
))

495 i‡(
de
->
©å
 !
ATTR_EXT
 && 
	`IS_FREE
(de->
«me
))

497 i‡(
de
->
©å
 =
ATTR_EXT
) {

498 
°©us
 = 
	`Át_∑r£_l⁄g
(
öode
, &
˝os
, &
bh
, &
de
,

499 &
unicode
, &
ƒ_¶Ÿs
);

500 i‡(
°©us
 < 0) {

501 
îr
 = 
°©us
;

502 
íd_of_dú
;

503 } i‡(
°©us
 =
PARSE_INVALID
)

505 i‡(
°©us
 =
PARSE_NOT_LONGNAME
)

506 
∑r£_ªc‹d
;

507 i‡(
°©us
 =
PARSE_EOF
)

508 
íd_of_dú
;

516 
Àn
 = 
	`Át_∑r£_sh‹t
(
sb
, 
de
, 
bu‚ame
, 0);

517 i‡(
Àn
 == 0)

521 i‡(
	`Át_«me_m©ch
(
sbi
, 
«me
, 
«me_Àn
, 
bu‚ame
, 
Àn
))

522 
found
;

524 i‡(
ƒ_¶Ÿs
) {

525 *
l⁄g«me
 = 
unicode
 + 
FAT_MAX_UNI_CHARS
;

526 
size
 = 
PATH_MAX
 - 
FAT_MAX_UNI_SIZE
;

529 
Àn
 = 
	`Át_uni_to_x8
(
sb
, 
unicode
, 
l⁄g«me
, 
size
);

530 i‡(
	`Át_«me_m©ch
(
sbi
, 
«me
, 
«me_Àn
, 
l⁄g«me
, 
Àn
))

531 
found
;

535 
found
:

536 
ƒ_¶Ÿs
++;

537 
söfo
->
¶Ÿ_off
 = 
˝os
 - 
ƒ_¶Ÿs
 * (*
de
);

538 
söfo
->
ƒ_¶Ÿs
 =Çr_slots;

539 
söfo
->
de
 = de;

540 
söfo
->
bh
 = bh;

541 
söfo
->
i_pos
 = 
	`Át_make_i_pos
(
sb
, söfo->
bh
, söfo->
de
);

542 
îr
 = 0;

543 
íd_of_dú
:

544 i‡(
unicode
)

545 
	`__puäame
(
unicode
);

547  
îr
;

548 
	}
}

549 
EXPORT_SYMBOL_GPL
(
Át_£¨ch_l⁄g
);

551 
	sÁt_io˘l_fûldú_ˇŒback
 {

552 
__u£r
 *
	mdúít
;

553 
	mªsu…
;

555 c⁄° *
	ml⁄g«me
;

556 
	ml⁄g_Àn
;

557 c⁄° *
	msh‹äame
;

558 
	msh‹t_Àn
;

561 
	$__Át_ªaddú
(
öode
 *öode, 
fûe
 *
fûp
, *
dúít
,

562 
fûldú_t
 
fûldú
, 
sh‹t_⁄ly
, 
bŸh
)

564 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

565 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

566 
buf„r_hód
 *
bh
;

567 
msdos_dú_íåy
 *
de
;

568 
ƒ_¶Ÿs
;

569 
wch¨_t
 *
unicode
 = 
NULL
;

570 
bu‚ame
[
FAT_MAX_SHORT_SIZE
];

571 
isvÁt
 = 
sbi
->
›ti⁄s
.isvfat;

572 c⁄° *
fûl_«me
 = 
NULL
;

573 
öum
;

574 
Õos
, 
dummy
, *
fuºfu
 = &lpos;

575 
loff_t
 
˝os
;

576 
sh‹t_Àn
 = 0, 
fûl_Àn
 = 0;

577 
ªt
 = 0;

579 
	`muãx_lock
(&
sbi
->
s_lock
);

581 
˝os
 = 
fûp
->
f_pos
;

583 i‡(
öode
->
i_öo
 =
MSDOS_ROOT_INO
) {

584 
˝os
 < 2) {

585 i‡(
	`fûldú
(
dúít
, "..", 
˝os
+1, cpos,

586 
MSDOS_ROOT_INO
, 
DT_DIR
) < 0)

587 
out
;

588 
˝os
++;

589 
fûp
->
f_pos
++;

591 i‡(
˝os
 == 2) {

592 
dummy
 = 2;

593 
fuºfu
 = &
dummy
;

594 
˝os
 = 0;

597 i‡(
˝os
 & ((
msdos_dú_íåy
) - 1)) {

598 
ªt
 = -
ENOENT
;

599 
out
;

602 
bh
 = 
NULL
;

603 
gë_√w
:

604 i‡(
	`Át_gë_íåy
(
öode
, &
˝os
, &
bh
, &
de
) == -1)

605 
íd_of_dú
;

606 
∑r£_ªc‹d
:

607 
ƒ_¶Ÿs
 = 0;

612 i‡(
isvÁt
 && !
sh‹t_⁄ly
) {

613 i‡(
de
->
«me
[0] =
DELETED_FLAG
)

616 
ªc‹d_íd
;

618 i‡(
de
->
©å
 !
ATTR_EXT
 && (de->©å & 
ATTR_VOLUME
))

621 
ªc‹d_íd
;

623 i‡(
de
->
©å
 !
ATTR_EXT
 && 
	`IS_FREE
(de->
«me
))

625 
ªc‹d_íd
;

628 i‡((
de
->
©å
 & 
ATTR_VOLUME
Ë|| 
	`IS_FREE
(de->
«me
))

629 
ªc‹d_íd
;

632 i‡(
isvÁt
 && 
de
->
©å
 =
ATTR_EXT
) {

633 
°©us
 = 
	`Át_∑r£_l⁄g
(
öode
, &
˝os
, &
bh
, &
de
,

634 &
unicode
, &
ƒ_¶Ÿs
);

635 i‡(
°©us
 < 0) {

636 
fûp
->
f_pos
 = 
˝os
;

637 
ªt
 = 
°©us
;

638 
out
;

639 } i‡(
°©us
 =
PARSE_INVALID
)

640 
ªc‹d_íd
;

641 i‡(
°©us
 =
PARSE_NOT_LONGNAME
)

642 
∑r£_ªc‹d
;

643 i‡(
°©us
 =
PARSE_EOF
)

644 
íd_of_dú
;

646 i‡(
ƒ_¶Ÿs
) {

647 *
l⁄g«me
 = 
unicode
 + 
FAT_MAX_UNI_CHARS
;

648 
size
 = 
PATH_MAX
 - 
FAT_MAX_UNI_SIZE
;

649 
Àn
 = 
	`Át_uni_to_x8
(
sb
, 
unicode
, 
l⁄g«me
, 
size
);

651 
fûl_«me
 = 
l⁄g«me
;

652 
fûl_Àn
 = 
Àn
;

654 i‡(!
bŸh
)

655 
°¨t_fûldú
;

659 
sh‹t_Àn
 = 
	`Át_∑r£_sh‹t
(
sb
, 
de
, 
bu‚ame
, 
sbi
->
›ti⁄s
.
dŸsOK
);

660 i‡(
sh‹t_Àn
 == 0)

661 
ªc‹d_íd
;

663 i‡(
ƒ_¶Ÿs
) {

665 
Át_io˘l_fûldú_ˇŒback
 *
p
 = 
dúít
;

667 
p
->
l⁄g«me
 = 
fûl_«me
;

668 
p
->
l⁄g_Àn
 = 
fûl_Àn
;

669 
p
->
sh‹äame
 = 
bu‚ame
;

670 
p
->
sh‹t_Àn
 = short_len;

671 
fûl_«me
 = 
NULL
;

672 
fûl_Àn
 = 0;

674 
fûl_«me
 = 
bu‚ame
;

675 
fûl_Àn
 = 
sh‹t_Àn
;

678 
°¨t_fûldú
:

679 
Õos
 = 
˝os
 - (
ƒ_¶Ÿs
 + 1Ë* (
msdos_dú_íåy
);

680 i‡(!
	`memcmp
(
de
->
«me
, 
MSDOS_DOT
, 
MSDOS_NAME
))

681 
öum
 = 
öode
->
i_öo
;

682 i‡(!
	`memcmp
(
de
->
«me
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
)) {

683 
öum
 = 
	`∑ª¡_öo
(
fûp
->
f_∑th
.
díåy
);

685 
loff_t
 
i_pos
 = 
	`Át_make_i_pos
(
sb
, 
bh
, 
de
);

686 
öode
 *
tmp
 = 
	`Át_igë
(
sb
, 
i_pos
);

687 i‡(
tmp
) {

688 
öum
 = 
tmp
->
i_öo
;

689 
	`ùut
(
tmp
);

691 
öum
 = 
	`iunique
(
sb
, 
MSDOS_ROOT_INO
);

694 i‡(
	`fûldú
(
dúít
, 
fûl_«me
, 
fûl_Àn
, *
fuºfu
, 
öum
,

695 (
de
->
©å
 & 
ATTR_DIR
Ë? 
DT_DIR
 : 
DT_REG
) < 0)

696 
fûl_Áûed
;

698 
ªc‹d_íd
:

699 
fuºfu
 = &
Õos
;

700 
fûp
->
f_pos
 = 
˝os
;

701 
gë_√w
;

702 
íd_of_dú
:

703 
fûp
->
f_pos
 = 
˝os
;

704 
fûl_Áûed
:

705 
	`bªl£
(
bh
);

706 i‡(
unicode
)

707 
	`__puäame
(
unicode
);

708 
out
:

709 
	`muãx_u∆ock
(&
sbi
->
s_lock
);

710  
ªt
;

711 
	}
}

713 
	$Át_ªaddú
(
fûe
 *
fûp
, *
dúít
, 
fûldú_t
 
fûldú
)

715 
öode
 *öodê
	`fûe_öode
(
fûp
);

716  
	`__Át_ªaddú
(
öode
, 
fûp
, 
dúít
, 
fûldú
, 0, 0);

717 
	}
}

719 
	#FAT_IOCTL_FILLDIR_FUNC
(
func
, 
dúít_ty≥
) \

720 
	`func
(*
__buf
, c⁄° *
«me
, 
«me_Àn
, \

721 
loff_t
 
off£t
, 
u64
 
öo
, 
d_ty≥
) \

723 
Át_io˘l_fûldú_ˇŒback
 *
buf
 = 
__buf
; \

724 
dúít_ty≥
 
__u£r
 *
d1
 = 
buf
->
dúít
; \

725 
dúít_ty≥
 
__u£r
 *
d2
 = 
d1
 + 1; \

727 i‡(
buf
->
ªsu…
) \

728  -
EINVAL
; \

729 
buf
->
ªsu…
++; \

731 i‡(
«me
 !
NULL
) { \

733 i‡(
«me_Àn
 >(
d1
->
d_«me
)) \

734 
«me_Àn
 = (
d1
->
d_«me
) - 1; \

736 i‡(
	`put_u£r
(0, 
d2
->
d_«me
) || \

737 
	`put_u£r
(0, &
d2
->
d_ª˛í
) || \

738 
	`c›y_to_u£r
(
d1
->
d_«me
, 
«me
, 
«me_Àn
) || \

739 
	`put_u£r
(0, 
d1
->
d_«me
 + 
«me_Àn
) || \

740 
	`put_u£r
(
«me_Àn
, &
d1
->
d_ª˛í
)) \

741 
eÁu…
; \

744 c⁄° *
l⁄g«me
 = 
buf
->longname; \

745 
l⁄g_Àn
 = 
buf
->long_len; \

746 c⁄° *
sh‹äame
 = 
buf
->shortname; \

747 
sh‹t_Àn
 = 
buf
->short_len; \

749 i‡(
l⁄g_Àn
 >(
d1
->
d_«me
)) \

750 
l⁄g_Àn
 = (
d1
->
d_«me
) - 1; \

751 i‡(
sh‹t_Àn
 >(
d1
->
d_«me
)) \

752 
sh‹t_Àn
 = (
d1
->
d_«me
) - 1; \

754 i‡(
	`c›y_to_u£r
(
d2
->
d_«me
, 
l⁄g«me
, 
l⁄g_Àn
) || \

755 
	`put_u£r
(0, 
d2
->
d_«me
 + 
l⁄g_Àn
) || \

756 
	`put_u£r
(
l⁄g_Àn
, &
d2
->
d_ª˛í
) || \

757 
	`put_u£r
(
öo
, &
d2
->
d_öo
) || \

758 
	`put_u£r
(
off£t
, &
d2
->
d_off
) || \

759 
	`c›y_to_u£r
(
d1
->
d_«me
, 
sh‹äame
, 
sh‹t_Àn
) || \

760 
	`put_u£r
(0, 
d1
->
d_«me
 + 
sh‹t_Àn
) || \

761 
	`put_u£r
(
sh‹t_Àn
, &
d1
->
d_ª˛í
)) \

762 
eÁu…
; \

765 
eÁu…
: \

766 
buf
->
ªsu…
 = -
EFAULT
; \

767  -
EFAULT
; \

768 }

	)

770 
	$FAT_IOCTL_FILLDIR_FUNC
(
Át_io˘l_fûldú
, 
__Át_dúít
)

772 
	$Át_io˘l_ªaddú
(
öode
 *öode, 
fûe
 *
fûp
,

773 
__u£r
 *
dúít
, 
fûldú_t
 
fûldú
,

774 
sh‹t_⁄ly
, 
bŸh
)

776 
Át_io˘l_fûldú_ˇŒback
 
buf
;

777 
ªt
;

779 
buf
.
dúít
 = dirent;

780 
buf
.
ªsu…
 = 0;

781 
	`muãx_lock
(&
öode
->
i_muãx
);

782 
ªt
 = -
ENOENT
;

783 i‡(!
	`IS_DEADDIR
(
öode
)) {

784 
ªt
 = 
	`__Át_ªaddú
(
öode
, 
fûp
, &
buf
, 
fûldú
,

785 
sh‹t_⁄ly
, 
bŸh
);

787 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

788 i‡(
ªt
 >= 0)

789 
ªt
 = 
buf
.
ªsu…
;

790  
ªt
;

791 
	}
}

793 
	$Át_dú_io˘l
(
fûe
 *
fûp
, 
cmd
,

794 
¨g
)

796 
öode
 *öodê
	`fûe_öode
(
fûp
);

797 
__Át_dúít
 
__u£r
 *
d1
 = (__Át_dúíà__u£∏*)
¨g
;

798 
sh‹t_⁄ly
, 
bŸh
;

800 
cmd
) {

801 
VFAT_IOCTL_READDIR_SHORT
:

802 
sh‹t_⁄ly
 = 1;

803 
bŸh
 = 0;

805 
VFAT_IOCTL_READDIR_BOTH
:

806 
sh‹t_⁄ly
 = 0;

807 
bŸh
 = 1;

810  
	`Át_gíîic_io˘l
(
fûp
, 
cmd
, 
¨g
);

813 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
d1
, (
__Át_dúít
[2])))

814  -
EFAULT
;

820 i‡(
	`put_u£r
(0, &
d1
->
d_ª˛í
))

821  -
EFAULT
;

823  
	`Át_io˘l_ªaddú
(
öode
, 
fûp
, 
d1
, 
Át_io˘l_fûldú
,

824 
sh‹t_⁄ly
, 
bŸh
);

825 
	}
}

827 #ifde‡
CONFIG_COMPAT


828 
	#VFAT_IOCTL_READDIR_BOTH32
 
	`_IOR
('r', 1, 
com∑t_dúít
[2])

	)

829 
	#VFAT_IOCTL_READDIR_SHORT32
 
	`_IOR
('r', 2, 
com∑t_dúít
[2])

	)

831 
	$FAT_IOCTL_FILLDIR_FUNC
(
Át_com∑t_io˘l_fûldú
, 
com∑t_dúít
)

833 
	$Át_com∑t_dú_io˘l
(
fûe
 *
fûp
, 
cmd
,

834 
¨g
)

836 
öode
 *öodê
	`fûe_öode
(
fûp
);

837 
com∑t_dúít
 
__u£r
 *
d1
 = 
	`com∑t_±r
(
¨g
);

838 
sh‹t_⁄ly
, 
bŸh
;

840 
cmd
) {

841 
VFAT_IOCTL_READDIR_SHORT32
:

842 
sh‹t_⁄ly
 = 1;

843 
bŸh
 = 0;

845 
VFAT_IOCTL_READDIR_BOTH32
:

846 
sh‹t_⁄ly
 = 0;

847 
bŸh
 = 1;

850  
	`Át_gíîic_io˘l
(
fûp
, 
cmd
, ()
¨g
);

853 i‡(!
	`ac˚ss_ok
(
VERIFY_WRITE
, 
d1
, (
com∑t_dúít
[2])))

854  -
EFAULT
;

860 i‡(
	`put_u£r
(0, &
d1
->
d_ª˛í
))

861  -
EFAULT
;

863  
	`Át_io˘l_ªaddú
(
öode
, 
fûp
, 
d1
, 
Át_com∑t_io˘l_fûldú
,

864 
sh‹t_⁄ly
, 
bŸh
);

865 
	}
}

868 c⁄° 
fûe_›î©i⁄s
 
	gÁt_dú_›î©i⁄s
 = {

869 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
,

870 .
	gªad
 = 
gíîic_ªad_dú
,

871 .
	gªaddú
 = 
Át_ªaddú
,

872 .
	gu∆ocked_io˘l
 = 
Át_dú_io˘l
,

873 #ifde‡
CONFIG_COMPAT


874 .
	gcom∑t_io˘l
 = 
Át_com∑t_dú_io˘l
,

876 .
	gfsync
 = 
Át_fûe_fsync
,

879 
	$Át_gë_sh‹t_íåy
(
öode
 *
dú
, 
loff_t
 *
pos
,

880 
buf„r_hód
 **
bh
,

881 
msdos_dú_íåy
 **
de
)

883 
	`Át_gë_íåy
(
dú
, 
pos
, 
bh
, 
de
) >= 0) {

885 i‡(!
	`IS_FREE
((*
de
)->
«me
Ë&& !((*de)->
©å
 & 
ATTR_VOLUME
))

888  -
ENOENT
;

889 
	}
}

900 
	$Át_gë_dŸdŸ_íåy
(
öode
 *
dú
, 
buf„r_hód
 **
bh
,

901 
msdos_dú_íåy
 **
de
)

903 
loff_t
 
off£t
 = 0;

905 *
de
 = 
NULL
;

906 
	`Át_gë_sh‹t_íåy
(
dú
, &
off£t
, 
bh
, 
de
) >= 0) {

907 i‡(!
	`°∫cmp
((*
de
)->
«me
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
))

910  -
ENOENT
;

911 
	}
}

912 
EXPORT_SYMBOL_GPL
(
Át_gë_dŸdŸ_íåy
);

915 
	$Át_dú_em±y
(
öode
 *
dú
)

917 
buf„r_hód
 *
bh
;

918 
msdos_dú_íåy
 *
de
;

919 
loff_t
 
˝os
;

920 
ªsu…
 = 0;

922 
bh
 = 
NULL
;

923 
˝os
 = 0;

924 
	`Át_gë_sh‹t_íåy
(
dú
, &
˝os
, &
bh
, &
de
) >= 0) {

925 i‡(
	`°∫cmp
(
de
->
«me
, 
MSDOS_DOT
 , 
MSDOS_NAME
) &&

926 
	`°∫cmp
(
de
->
«me
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
)) {

927 
ªsu…
 = -
ENOTEMPTY
;

931 
	`bªl£
(
bh
);

932  
ªsu…
;

933 
	}
}

934 
EXPORT_SYMBOL_GPL
(
Át_dú_em±y
);

940 
	$Át_subdús
(
öode
 *
dú
)

942 
buf„r_hód
 *
bh
;

943 
msdos_dú_íåy
 *
de
;

944 
loff_t
 
˝os
;

945 
cou¡
 = 0;

947 
bh
 = 
NULL
;

948 
˝os
 = 0;

949 
	`Át_gë_sh‹t_íåy
(
dú
, &
˝os
, &
bh
, &
de
) >= 0) {

950 i‡(
de
->
©å
 & 
ATTR_DIR
)

951 
cou¡
++;

953 
	`bªl£
(
bh
);

954  
cou¡
;

955 
	}
}

961 
	$Át_sˇn
(
öode
 *
dú
, c⁄° *
«me
,

962 
Át_¶Ÿ_öfo
 *
söfo
)

964 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

966 
söfo
->
¶Ÿ_off
 = 0;

967 
söfo
->
bh
 = 
NULL
;

968 
	`Át_gë_sh‹t_íåy
(
dú
, &
söfo
->
¶Ÿ_off
, &söfo->
bh
,

969 &
söfo
->
de
) >= 0) {

970 i‡(!
	`°∫cmp
(
söfo
->
de
->
«me
,Çame, 
MSDOS_NAME
)) {

971 
söfo
->
¶Ÿ_off
 -(*söfo->
de
);

972 
söfo
->
ƒ_¶Ÿs
 = 1;

973 
söfo
->
i_pos
 = 
	`Át_make_i_pos
(
sb
, söfo->
bh
, söfo->
de
);

977  -
ENOENT
;

978 
	}
}

979 
EXPORT_SYMBOL_GPL
(
Át_sˇn
);

985 
	$Át_sˇn_log°¨t
(
öode
 *
dú
, 
i_log°¨t
,

986 
Át_¶Ÿ_öfo
 *
söfo
)

988 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

990 
söfo
->
¶Ÿ_off
 = 0;

991 
söfo
->
bh
 = 
NULL
;

992 
	`Át_gë_sh‹t_íåy
(
dú
, &
söfo
->
¶Ÿ_off
, &söfo->
bh
,

993 &
söfo
->
de
) >= 0) {

994 i‡(
	`Át_gë_°¨t
(
	`MSDOS_SB
(
sb
), 
söfo
->
de
Ë=
i_log°¨t
) {

995 
söfo
->
¶Ÿ_off
 -(*söfo->
de
);

996 
söfo
->
ƒ_¶Ÿs
 = 1;

997 
söfo
->
i_pos
 = 
	`Át_make_i_pos
(
sb
, söfo->
bh
, söfo->
de
);

1001  -
ENOENT
;

1002 
	}
}

1004 
	$__Át_ªmove_íåõs
(
öode
 *
dú
, 
loff_t
 
pos
, 
ƒ_¶Ÿs
)

1006 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1007 
buf„r_hód
 *
bh
;

1008 
msdos_dú_íåy
 *
de
, *
ídp
;

1009 
îr
 = 0, 
‹ig_¶Ÿs
;

1011 
ƒ_¶Ÿs
) {

1012 
bh
 = 
NULL
;

1013 i‡(
	`Át_gë_íåy
(
dú
, &
pos
, &
bh
, &
de
) < 0) {

1014 
îr
 = -
EIO
;

1018 
‹ig_¶Ÿs
 = 
ƒ_¶Ÿs
;

1019 
ídp
 = (
msdos_dú_íåy
 *)(
bh
->
b_d©a
 + 
sb
->
s_blocksize
);

1020 
ƒ_¶Ÿs
 && 
de
 < 
ídp
) {

1024 
de
->
«me
[0] = 
DELETED_FLAG
;

1025 
de
++;

1026 
ƒ_¶Ÿs
--;

1028 
	`m¨k_buf„r_dúty_öode
(
bh
, 
dú
);

1029 i‡(
	`IS_DIRSYNC
(
dú
))

1030 
îr
 = 
	`sync_dúty_buf„r
(
bh
);

1031 
	`bªl£
(
bh
);

1032 i‡(
îr
)

1036 
pos
 +((
‹ig_¶Ÿs
 - 
ƒ_¶Ÿs
Ë* (*
de
)) - (*de);

1039  
îr
;

1040 
	}
}

1042 
	$Át_ªmove_íåõs
(
öode
 *
dú
, 
Át_¶Ÿ_öfo
 *
söfo
)

1044 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1045 
msdos_dú_íåy
 *
de
;

1046 
buf„r_hód
 *
bh
;

1047 
îr
 = 0, 
ƒ_¶Ÿs
;

1053 
ƒ_¶Ÿs
 = 
söfo
->nr_slots;

1054 
de
 = 
söfo
->de;

1055 
söfo
->
de
 = 
NULL
;

1056 
bh
 = 
söfo
->bh;

1057 
söfo
->
bh
 = 
NULL
;

1058 
ƒ_¶Ÿs
 && 
de
 >(
msdos_dú_íåy
 *)
bh
->
b_d©a
) {

1060 
de
->
«me
[0] = 
DELETED_FLAG
;

1061 
de
--;

1062 
ƒ_¶Ÿs
--;

1064 
	`m¨k_buf„r_dúty_öode
(
bh
, 
dú
);

1065 i‡(
	`IS_DIRSYNC
(
dú
))

1066 
îr
 = 
	`sync_dúty_buf„r
(
bh
);

1067 
	`bªl£
(
bh
);

1068 i‡(
îr
)

1069  
îr
;

1070 
dú
->
i_vîsi⁄
++;

1072 i‡(
ƒ_¶Ÿs
) {

1078 
îr
 = 
	`__Át_ªmove_íåõs
(
dú
, 
söfo
->
¶Ÿ_off
, 
ƒ_¶Ÿs
);

1079 i‡(
îr
) {

1080 
	`Át_msg
(
sb
, 
KERN_WARNING
,

1086 
dú
->
i_mtime
 = dú->
i_©ime
 = 
CURRENT_TIME_SEC_OPEL
;

1094 i‡(
	`IS_DIRSYNC
(
dú
))

1095 ()
	`Át_sync_öode
(
dú
);

1097 
	`m¨k_öode_dúty
(
dú
);

1100 
	}
}

1101 
EXPORT_SYMBOL_GPL
(
Át_ªmove_íåõs
);

1103 
	$Át_zî€d_˛u°î
(
öode
 *
dú
, 
£˘‹_t
 
blkƒ
, 
ƒ_u£d
,

1104 
buf„r_hód
 **
bhs
, 
ƒ_bhs
)

1106 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1107 
£˘‹_t
 
œ°_blkƒ
 = 
blkƒ
 + 
	`MSDOS_SB
(
sb
)->
£c_≥r_˛us
;

1108 
îr
, 
i
, 
n
;

1111 
blkƒ
 +
ƒ_u£d
;

1112 
n
 = 
ƒ_u£d
;

1113 
blkƒ
 < 
œ°_blkƒ
) {

1114 
bhs
[
n
] = 
	`sb_gëblk
(
sb
, 
blkƒ
);

1115 i‡(!
bhs
[
n
]) {

1116 
îr
 = -
ENOMEM
;

1117 
îr‹
;

1119 
	`mem£t
(
bhs
[
n
]->
b_d©a
, 0, 
sb
->
s_blocksize
);

1120 
	`£t_buf„r_u±od©e
(
bhs
[
n
]);

1121 
	`m¨k_buf„r_dúty_öode
(
bhs
[
n
], 
dú
);

1123 
n
++;

1124 
blkƒ
++;

1125 i‡(
n
 =
ƒ_bhs
) {

1126 i‡(
	`IS_DIRSYNC
(
dú
)) {

1127 
îr
 = 
	`Át_sync_bhs
(
bhs
, 
n
);

1128 i‡(
îr
)

1129 
îr‹
;

1131 
i
 = 0; i < 
n
; i++)

1132 
	`bªl£
(
bhs
[
i
]);

1133 
n
 = 0;

1136 i‡(
	`IS_DIRSYNC
(
dú
)) {

1137 
îr
 = 
	`Át_sync_bhs
(
bhs
, 
n
);

1138 i‡(
îr
)

1139 
îr‹
;

1141 
i
 = 0; i < 
n
; i++)

1142 
	`bªl£
(
bhs
[
i
]);

1146 
îr‹
:

1147 
i
 = 0; i < 
n
; i++)

1148 
	`bf‹gë
(
bhs
[
i
]);

1149  
îr
;

1150 
	}
}

1152 
	$Át_Æloc_√w_dú
(
öode
 *
dú
, 
time•ec
 *
ts
)

1154 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1155 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1156 
buf„r_hód
 *
bhs
[
MAX_BUF_PER_PAGE
];

1157 
msdos_dú_íåy
 *
de
;

1158 
£˘‹_t
 
blkƒ
;

1159 
__À16
 
d©e
, 
time
;

1160 
u8
 
time_cs
;

1161 
îr
, 
˛u°î
;

1163 
îr
 = 
	`Át_Æloc_˛u°îs
(
dú
, &
˛u°î
, 1);

1164 i‡(
îr
)

1165 
îr‹
;

1167 
blkƒ
 = 
	`Át_˛us_to_blkƒ
(
sbi
, 
˛u°î
);

1168 
bhs
[0] = 
	`sb_gëblk
(
sb
, 
blkƒ
);

1169 i‡(!
bhs
[0]) {

1170 
îr
 = -
ENOMEM
;

1171 
îr‹_‰ì
;

1174 
	`Át_time_unix2Át
(
sbi
, 
ts
, &
time
, &
d©e
, &
time_cs
);

1176 
de
 = (
msdos_dú_íåy
 *)
bhs
[0]->
b_d©a
;

1178 
	`mem˝y
(
de
[0].
«me
, 
MSDOS_DOT
, 
MSDOS_NAME
);

1179 
	`mem˝y
(
de
[1].
«me
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
);

1180 
de
->
©å
 = de[1].©å = 
ATTR_DIR
;

1181 
de
[0].
lˇ£
 = de[1].lcase = 0;

1182 
de
[0].
time
 = de[1].time =Åime;

1183 
de
[0].
d©e
 = de[1].date = date;

1184 i‡(
sbi
->
›ti⁄s
.
isvÁt
) {

1186 
de
[0].
˘ime
 = de[1].˘imê
time
;

1187 
de
[0].
˘ime_cs
 = de[1].˘ime_c†
time_cs
;

1188 
de
[0].
ad©e
 = de[0].
cd©e
 = de[1].ad©êde[1].cd©ê
d©e
;

1190 
de
[0].
˘ime
 = de[1].ctime = 0;

1191 
de
[0].
˘ime_cs
 = de[1].ctime_cs = 0;

1192 
de
[0].
ad©e
 = de[0].
cd©e
 = de[1].adate = de[1].cdate = 0;

1194 
	`Át_£t_°¨t
(&
de
[0], 
˛u°î
);

1195 
	`Át_£t_°¨t
(&
de
[1], 
	`MSDOS_I
(
dú
)->
i_log°¨t
);

1196 
de
[0].
size
 = de[1].size = 0;

1197 
	`mem£t
(
de
 + 2, 0, 
sb
->
s_blocksize
 - 2 * (*de));

1198 
	`£t_buf„r_u±od©e
(
bhs
[0]);

1199 
	`m¨k_buf„r_dúty_öode
(
bhs
[0], 
dú
);

1201 
îr
 = 
	`Át_zî€d_˛u°î
(
dú
, 
blkƒ
, 1, 
bhs
, 
MAX_BUF_PER_PAGE
);

1202 i‡(
îr
)

1203 
îr‹_‰ì
;

1205  
˛u°î
;

1207 
îr‹_‰ì
:

1208 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_alloc_new_dir, fat_free_clusters \n");

1209 
	`Át_‰ì_˛u°îs
(
dú
, 
˛u°î
);

1210 
îr‹
:

1211  
îr
;

1212 
	}
}

1213 
EXPORT_SYMBOL_GPL
(
Át_Æloc_√w_dú
);

1215 
	$Át_add_√w_íåõs
(
öode
 *
dú
, *
¶Ÿs
, 
ƒ_¶Ÿs
,

1216 *
ƒ_˛u°î
, 
msdos_dú_íåy
 **
de
,

1217 
buf„r_hód
 **
bh
, 
loff_t
 *
i_pos
)

1219 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1220 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1221 
buf„r_hód
 *
bhs
[
MAX_BUF_PER_PAGE
];

1222 
£˘‹_t
 
blkƒ
, 
°¨t_blkƒ
, 
œ°_blkƒ
;

1223 
size
, 
c›y
;

1224 
îr
, 
i
, 
n
, 
off£t
, 
˛u°î
[2];

1231 
size
 = 
ƒ_¶Ÿs
 * (
msdos_dú_íåy
);

1232 *
ƒ_˛u°î
 = (
size
 + (
sbi
->
˛u°î_size
 - 1)Ë>> sbi->
˛u°î_bôs
;

1233 
	`BUG_ON
(*
ƒ_˛u°î
 > 2);

1235 
îr
 = 
	`Át_Æloc_˛u°îs
(
dú
, 
˛u°î
, *
ƒ_˛u°î
);

1236 i‡(
îr
)

1237 
îr‹
;

1244 
i
 = 
n
 = 
c›y
 = 0;

1246 
°¨t_blkƒ
 = 
blkƒ
 = 
	`Át_˛us_to_blkƒ
(
sbi
, 
˛u°î
[
i
]);

1247 
œ°_blkƒ
 = 
°¨t_blkƒ
 + 
sbi
->
£c_≥r_˛us
;

1248 
blkƒ
 < 
œ°_blkƒ
) {

1249 
bhs
[
n
] = 
	`sb_gëblk
(
sb
, 
blkƒ
);

1250 i‡(!
bhs
[
n
]) {

1251 
îr
 = -
ENOMEM
;

1252 
îr‹_nomem
;

1256 
c›y
 = 
	`mö
(
size
, 
sb
->
s_blocksize
);

1257 
	`mem˝y
(
bhs
[
n
]->
b_d©a
, 
¶Ÿs
, 
c›y
);

1258 
¶Ÿs
 +
c›y
;

1259 
size
 -
c›y
;

1260 
	`£t_buf„r_u±od©e
(
bhs
[
n
]);

1261 
	`m¨k_buf„r_dúty_öode
(
bhs
[
n
], 
dú
);

1262 i‡(!
size
)

1264 
n
++;

1265 
blkƒ
++;

1267 } ++
i
 < *
ƒ_˛u°î
);

1269 
	`mem£t
(
bhs
[
n
]->
b_d©a
 + 
c›y
, 0, 
sb
->
s_blocksize
 - copy);

1270 
off£t
 = 
c›y
 - (
msdos_dú_íåy
);

1271 
	`gë_bh
(
bhs
[
n
]);

1272 *
bh
 = 
bhs
[
n
];

1273 *
de
 = (
msdos_dú_íåy
 *)((*
bh
)->
b_d©a
 + 
off£t
);

1274 *
i_pos
 = 
	`Át_make_i_pos
(
sb
, *
bh
, *
de
);

1277 
îr
 = 
	`Át_zî€d_˛u°î
(
dú
, 
°¨t_blkƒ
, ++
n
, 
bhs
, 
MAX_BUF_PER_PAGE
);

1278 i‡(
îr
)

1279 
îr‹_‰ì
;

1281  
˛u°î
[0];

1283 
îr‹_‰ì
:

1284 
	`bªl£
(*
bh
);

1285 *
bh
 = 
NULL
;

1286 
n
 = 0;

1287 
îr‹_nomem
:

1288 
i
 = 0; i < 
n
; i++)

1289 
	`bf‹gë
(
bhs
[
i
]);

1291 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_add_new_entries, fat_free_clusters \n");

1292 
	`Át_‰ì_˛u°îs
(
dú
, 
˛u°î
[0]);

1293 
îr‹
:

1294  
îr
;

1295 
	}
}

1297 
	$Át_add_íåõs
(
öode
 *
dú
, *
¶Ÿs
, 
ƒ_¶Ÿs
,

1298 
Át_¶Ÿ_öfo
 *
söfo
)

1300 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1301 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1302 
buf„r_hód
 *
bh
, *
¥ev
, *
bhs
[3];

1303 
msdos_dú_íåy
 *
	`unöôülized_v¨
(
de
);

1304 
îr
, 
‰ì_¶Ÿs
, 
i
, 
ƒ_bhs
;

1305 
loff_t
 
pos
, 
i_pos
;

1307 
söfo
->
ƒ_¶Ÿs
 =Çr_slots;

1310 
‰ì_¶Ÿs
 = 
ƒ_bhs
 = 0;

1311 
bh
 = 
¥ev
 = 
NULL
;

1312 
pos
 = 0;

1313 
îr
 = -
ENOSPC
;

1314 
	`Át_gë_íåy
(
dú
, &
pos
, &
bh
, &
de
) > -1) {

1316 i‡(
pos
 >
FAT_MAX_DIR_SIZE
)

1317 
îr‹
;

1319 i‡(
	`IS_FREE
(
de
->
«me
)) {

1320 i‡(
¥ev
 !
bh
) {

1321 
	`gë_bh
(
bh
);

1322 
bhs
[
ƒ_bhs
] = 
¥ev
 = 
bh
;

1323 
ƒ_bhs
++;

1325 
‰ì_¶Ÿs
++;

1326 i‡(
‰ì_¶Ÿs
 =
ƒ_¶Ÿs
)

1327 
found
;

1329 
i
 = 0; i < 
ƒ_bhs
; i++)

1330 
	`bªl£
(
bhs
[
i
]);

1331 
¥ev
 = 
NULL
;

1332 
‰ì_¶Ÿs
 = 
ƒ_bhs
 = 0;

1335 i‡(
dú
->
i_öo
 =
MSDOS_ROOT_INO
) {

1336 i‡(
sbi
->
Át_bôs
 != 32)

1337 
îr‹
;

1338 } i‡(
	`MSDOS_I
(
dú
)->
i_°¨t
 == 0) {

1339 
	`Át_msg
(
sb
, 
KERN_ERR
, "Corrupted directory (i_pos %lld)",

1340 
	`MSDOS_I
(
dú
)->
i_pos
);

1341 
îr
 = -
EIO
;

1342 
îr‹
;

1345 
found
:

1346 
îr
 = 0;

1347 
pos
 -
‰ì_¶Ÿs
 * (*
de
);

1348 
ƒ_¶Ÿs
 -
‰ì_¶Ÿs
;

1349 i‡(
‰ì_¶Ÿs
) {

1355 
size
 = 
‰ì_¶Ÿs
 * (*
de
);

1356 
off£t
 = 
pos
 & (
sb
->
s_blocksize
 - 1);

1357 
l⁄g_bhs
 = 
ƒ_bhs
 - (
ƒ_¶Ÿs
 == 0);

1360 
i
 = 0; i < 
l⁄g_bhs
; i++) {

1361 
c›y
 = 
	`mö_t
(, 
sb
->
s_blocksize
 - 
off£t
, 
size
);

1362 
	`mem˝y
(
bhs
[
i
]->
b_d©a
 + 
off£t
, 
¶Ÿs
, 
c›y
);

1363 
	`m¨k_buf„r_dúty_öode
(
bhs
[
i
], 
dú
);

1364 
off£t
 = 0;

1365 
¶Ÿs
 +
c›y
;

1366 
size
 -
c›y
;

1368 i‡(
l⁄g_bhs
 && 
	`IS_DIRSYNC
(
dú
))

1369 
îr
 = 
	`Át_sync_bhs
(
bhs
, 
l⁄g_bhs
);

1370 i‡(!
îr
 && 
i
 < 
ƒ_bhs
) {

1372 
c›y
 = 
	`mö_t
(, 
sb
->
s_blocksize
 - 
off£t
, 
size
);

1373 
	`mem˝y
(
bhs
[
i
]->
b_d©a
 + 
off£t
, 
¶Ÿs
, 
c›y
);

1374 
	`m¨k_buf„r_dúty_öode
(
bhs
[
i
], 
dú
);

1375 i‡(
	`IS_DIRSYNC
(
dú
))

1376 
îr
 = 
	`sync_dúty_buf„r
(
bhs
[
i
]);

1378 
i
 = 0; i < 
ƒ_bhs
; i++)

1379 
	`bªl£
(
bhs
[
i
]);

1380 i‡(
îr
)

1381 
îr‹_ªmove
;

1384 i‡(
ƒ_¶Ÿs
) {

1385 
˛u°î
, 
ƒ_˛u°î
;

1392 
˛u°î
 = 
	`Át_add_√w_íåõs
(
dú
, 
¶Ÿs
, 
ƒ_¶Ÿs
, &
ƒ_˛u°î
,

1393 &
de
, &
bh
, &
i_pos
);

1394 i‡(
˛u°î
 < 0) {

1395 
îr
 = 
˛u°î
;

1396 
îr‹_ªmove
;

1398 
îr
 = 
	`Át_chaö_add
(
dú
, 
˛u°î
, 
ƒ_˛u°î
);

1399 i‡(
îr
) {

1401 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_add_entries, fat_free_clusters \n");

1403 
	`Át_‰ì_˛u°îs
(
dú
, 
˛u°î
);

1404 
îr‹_ªmove
;

1406 i‡(
dú
->
i_size
 & (
sbi
->
˛u°î_size
 - 1)) {

1407 
	`Át_fs_îr‹
(
sb
, "Odd directory size");

1408 
dú
->
i_size
 = (dú->i_sizê+ 
sbi
->
˛u°î_size
 - 1)

1409 & ~((
loff_t
)
sbi
->
˛u°î_size
 - 1);

1411 
dú
->
i_size
 +
ƒ_˛u°î
 << 
sbi
->
˛u°î_bôs
;

1412 
	`MSDOS_I
(
dú
)->
mmu_¥iv©e
 +
ƒ_˛u°î
 << 
sbi
->
˛u°î_bôs
;

1414 
söfo
->
¶Ÿ_off
 = 
pos
;

1415 
söfo
->
de
 = de;

1416 
söfo
->
bh
 = bh;

1417 
söfo
->
i_pos
 = 
	`Át_make_i_pos
(
sb
, söfo->
bh
, söfo->
de
);

1421 
îr‹
:

1422 
	`bªl£
(
bh
);

1423 
i
 = 0; i < 
ƒ_bhs
; i++)

1424 
	`bªl£
(
bhs
[
i
]);

1425  
îr
;

1427 
îr‹_ªmove
:

1428 
	`bªl£
(
bh
);

1429 i‡(
‰ì_¶Ÿs
)

1430 
	`__Át_ªmove_íåõs
(
dú
, 
pos
, 
‰ì_¶Ÿs
);

1431  
îr
;

1432 
	}
}

1433 
EXPORT_SYMBOL_GPL
(
Át_add_íåõs
);

	@fat.h

1 #i‚de‡
_FAT_H


2 
	#_FAT_H


	)

4 
	~<löux/buf„r_hód.h
>

5 
	~<löux/°rög.h
>

6 
	~<löux/∆s.h
>

7 
	~<löux/fs.h
>

8 
	~<löux/hash.h
>

9 
	~<löux/muãx.h
>

10 
	~<löux/øãlimô.h
>

11 
	~<löux/msdos_fs.h
>

15 
	#NUM_1
 1

16 
	#NUM_2
 2

17 
	#NUM_3
 3

18 
	#NUM_4
 4

19 
	#NUM_5
 5

20 

	)

21 
	#NUM_6
 0

22 

	)

25 
	#DIR_1
 "n‹mÆ"

	)

26 
	#DIR_2
 "n‹mÆ_evít"

	)

27 
	#DIR_3
 "∑rkög"

	)

28 
	#DIR_4
 "∑rkög_evít"

	)

29 
	#DIR_5
 "h™dw‹k"

	)

37 
	#BB_NORMAL
 1

38 
	#BB_NORMAL_EVENT
 2

39 
	#BB_PARKING
 3

40 
	#BB_MANUAL
 4

41 
	#BB_IMAGE
 5

42 

	)

43 
	#BB_ETC
 0

44 

	)

47 
	#NORMAL_DIRECTORY
 "n‹mÆ"

	)

48 
	#NORMAL_EVENT_DIRECTORY
 "n‹mÆ_evít"

	)

49 
	#PARKING_DIRECTORY
 "∑rkög"

	)

50 
	#MANUAL_DIRECTORY
 "∑rkög_evít"

	)

51 
	#HANDWORK_DIRECTORY
 "h™dw‹k"

	)

53 
	#ETC_DIRECTORY
 "ëc"

	)

63 
	#SD_PAGE_SIZE
 4

	)

65 
	#CLUSTER_IN_PAGE
 (
SD_PAGE_SIZE
*256)

66 
	#CLUSTER_IN_BLOCK
 (128)

67 
	#BLOCK_IN_PAGE
 (
SD_PAGE_SIZE
 * 2)

70 

	)

72 
	#˚û
(
x
, 
y
Ë((xË+ (y - 1))/ (y)

	)

73 
	#Êo‹
(
x
, 
y
Ë(x)/(y)

	)

74 
	#FAT_ALLOC_CLUSTER
 0

	)

75 
	#FAT_FREE_CLUSTER
 1

	)

76 
	#BX_START
 0

	)

77 
	#BX_END
 1

	)

85 
	#BX_REUPDATE_META_DIFFER
 6

86 

	)

87 
	#NUM_EVNET
 5

88 

	)

89 
	#BX_NORMAL
 0

	)

90 
	#BX_NORMAL_EVENT
 1

	)

91 
	#BX_PARKING_EVENT
 2

	)

92 
	#BX_MANUAL
 3

	)

93 
	#BX_IMAGE
 4

	)

94 
	#BX_ETC
 9

	)

96 
	#NUM_EVNET_DIRECTORY
 6

97 

	)

99 
	#NORMAL_AREA_RATIO
 70

	)

100 
	#NORMAL_EVENT_AREA_RATIO
 20

	)

101 
	#PARKING_EVENT_AREA_RATIO
 10

	)

102 
	#MANUAL_AREA_RATIO
 1

	)

103 
	#IMAGE_AREA_RATIO
 1

	)

104 
	#ETC_AREA_RATIO
 7

	)

115 
	#VFAT_SFN_DISPLAY_LOWER
 0x0001

	)

116 
	#VFAT_SFN_DISPLAY_WIN95
 0x0002

	)

117 
	#VFAT_SFN_DISPLAY_WINNT
 0x0004

	)

118 
	#VFAT_SFN_CREATE_WIN95
 0x0100

	)

119 
	#VFAT_SFN_CREATE_WINNT
 0x0200

	)

121 
	#FAT_ERRORS_CONT
 1

	)

122 
	#FAT_ERRORS_PANIC
 2

	)

123 
	#FAT_ERRORS_RO
 3

	)

125 
	#FAT_NFS_STALE_RW
 1

	)

126 
	#FAT_NFS_NOSTALE_RO
 2

	)

128 
	sÁt_mou¡_›ti⁄s
 {

129 
kuid_t
 
	mfs_uid
;

130 
kgid_t
 
	mfs_gid
;

131 
	mfs_fmask
;

132 
	mfs_dmask
;

133 
	mcodïage
;

134 
	mtime_off£t
;

135 *
	mioch¨£t
;

136 
	msh‹äame
;

137 
	m«me_check
;

138 
	mîr‹s
;

139 
	mnfs
;

140 
	mÆlow_utime
;

141 
	mquõt
:1,

142 
	mshowexec
:1,

143 
	msys_immuèbÀ
:1,

144 
	mdŸsOK
:1,

145 
	misvÁt
:1,

146 
	mutf8
:1,

147 
	municode_xœã
:1,

148 
	mnumèû
:1,

149 
	mÊush
:1,

150 
	mnoˇ£
:1,

151 
	mu£‰ì
:1,

152 
	mtz_£t
:1,

153 
	mrodú
:1,

154 
	mdisˇrd
:1;

157 
	#FAT_HASH_BITS
 8

	)

158 
	#FAT_HASH_SIZE
 (1UL << 
FAT_HASH_BITS
)

	)

163 
	smsdos_sb_öfo
 {

164 
	m£c_≥r_˛us
;

165 
	m˛u°î_bôs
;

166 
	m˛u°î_size
;

167 
	mÁts
, 
	mÁt_bôs
;

168 
	mÁt_°¨t
;

169 
	mÁt_Àngth
;

170 
	mdú_°¨t
;

171 
	mdú_íåõs
;

172 
	md©a_°¨t
;

173 
	mmax_˛u°î
;

174 
	mroŸ_˛u°î
;

175 
	mfsöfo_£˘‹
;

176 
muãx
 
	mÁt_lock
;

177 
muãx
 
	mnfs_buûd_öode_lock
;

178 
muãx
 
	ms_lock
;

179 
	m¥ev_‰ì
;

180 
	m‰ì_˛u°îs
;

181 
	m‰ì_˛us_vÆid
;

182 
Át_mou¡_›ti⁄s
 
	m›ti⁄s
;

183 
∆s_èbÀ
 *
	m∆s_disk
;

184 
∆s_èbÀ
 *
	m∆s_io
;

185 c⁄° *
	mdú_›s
;

186 
	mdú_≥r_block
;

187 
	mdú_≥r_block_bôs
;

189 
	mÁã¡_shi·
;

190 
Áã¡_›î©i⁄s
 *
	mÁã¡_›s
;

191 
öode
 *
	mÁt_öode
;

192 
öode
 *
	mfsöfo_öode
;

194 
øãlimô_°©e
 
	møãlimô
;

196 
•ölock_t
 
	möode_hash_lock
;

197 
hli°_hód
 
	möode_hashèbÀ
[
FAT_HASH_SIZE
];

199 
•ölock_t
 
	mdú_hash_lock
;

200 
hli°_hód
 
	mdú_hashèbÀ
[
FAT_HASH_SIZE
];

202 
	mdúty
;

205 
	mbx_°¨t_˛u°î
[10];

206 
	mbx_íd_˛u°î
[10];

207 
	mbx_‰ì_˛u°îs
[10] ;

208 
	mbx_¥ev_‰ì
[10];

209 
	mbx_√xt_°¨t
[10];

210 
	mbx_‰ì_vÆid
;

212 
	mbx_¨ó_øtio
[10];

213 
	mbx_¥e_size
[10];

216 
	mi_öo
;

217 * 
	mfûe_«me
;

218 
	mtime
;

219 
	mcou¡
;

222 
	mbb_fûe_°¨t
;

223 
	mbb_•a˚_fuŒ
;

224 
	mbb_no_Æloc
;

228 
	#FAT_CACHE_VALID
 0

	)

233 
	smsdos_öode_öfo
 {

234 
•ölock_t
 
	mˇche_Ãu_lock
;

235 
li°_hód
 
	mˇche_Ãu
;

236 
	mƒ_ˇches
;

238 
	mˇche_vÆid_id
;

241 
loff_t
 
	mmmu_¥iv©e
;

243 
	mi_°¨t
;

244 
	mi_log°¨t
;

245 
	mi_©ås
;

246 
loff_t
 
	mi_pos
;

247 
hli°_node
 
	mi_Át_hash
;

248 
hli°_node
 
	mi_dú_hash
;

249 
rw_£m≠h‹e
 
	måunˇã_lock
;

250 
öode
 
	mvfs_öode
;

253 
	sÁt_¶Ÿ_öfo
 {

254 
loff_t
 
	mi_pos
;

255 
loff_t
 
	m¶Ÿ_off
;

256 
	mƒ_¶Ÿs
;

257 
msdos_dú_íåy
 *
	mde
;

258 
buf„r_hód
 *
	mbh
;

261 
ölöe
 
msdos_sb_öfo
 *
	$MSDOS_SB
(
su≥r_block
 *
sb
)

263  
sb
->
s_fs_öfo
;

264 
	}
}

266 
ölöe
 
msdos_öode_öfo
 *
	$MSDOS_I
(
öode
 *inode)

268  
	`c⁄èöî_of
(
öode
, 
msdos_öode_öfo
, 
vfs_öode
);

269 
	}
}

278 
ölöe
 
	$Át_mode_ˇn_hﬁd_ro
(
öode
 *inode)

280 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

281 
umode_t
 
mask
;

283 i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

284 i‡(!
sbi
->
›ti⁄s
.
rodú
)

286 
mask
 = ~
sbi
->
›ti⁄s
.
fs_dmask
;

288 
mask
 = ~
sbi
->
›ti⁄s
.
fs_fmask
;

290 i‡(!(
mask
 & 
S_IWUGO
))

293 
	}
}

296 
ölöe
 
umode_t
 
	$Át_make_mode
(
msdos_sb_öfo
 *
sbi
,

297 
u8
 
©ås
, 
umode_t
 
mode
)

299 i‡(
©ås
 & 
ATTR_RO
 && !(◊âr†& 
ATTR_DIR
Ë&& !
sbi
->
›ti⁄s
.
rodú
))

300 
mode
 &~
S_IWUGO
;

302 i‡(
©ås
 & 
ATTR_DIR
)

303  (
mode
 & ~
sbi
->
›ti⁄s
.
fs_dmask
Ë| 
S_IFDIR
;

305  (
mode
 & ~
sbi
->
›ti⁄s
.
fs_fmask
Ë| 
S_IFREG
;

306 
	}
}

309 
ölöe
 
u8
 
	$Át_make_©ås
(
öode
 *inode)

311 
u8
 
©ås
 = 
	`MSDOS_I
(
öode
)->
i_©ås
;

312 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

313 
©ås
 |
ATTR_DIR
;

314 i‡(
	`Át_mode_ˇn_hﬁd_ro
(
öode
Ë&& !(öode->
i_mode
 & 
S_IWUGO
))

315 
©ås
 |
ATTR_RO
;

316  
©ås
;

317 
	}
}

319 
ölöe
 
	$Át_ßve_©ås
(
öode
 *öode, 
u8
 
©ås
)

321 i‡(
	`Át_mode_ˇn_hﬁd_ro
(
öode
))

322 
	`MSDOS_I
(
öode
)->
i_©ås
 = 
©ås
 & 
ATTR_UNUSED
;

324 
	`MSDOS_I
(
öode
)->
i_©ås
 = 
©ås
 & (
ATTR_UNUSED
 | 
ATTR_RO
);

325 
	}
}

327 
ölöe
 
	$Át_checksum
(c⁄° 
__u8
 *
«me
)

329 
s
 = 
«me
[0];

330 
s
 = (s<<7Ë+ (s>>1Ë+ 
«me
[1]; s = (s<<7) + (s>>1) +Çame[2];

331 
s
 = (s<<7Ë+ (s>>1Ë+ 
«me
[3]; s = (s<<7) + (s>>1) +Çame[4];

332 
s
 = (s<<7Ë+ (s>>1Ë+ 
«me
[5]; s = (s<<7) + (s>>1) +Çame[6];

333 
s
 = (s<<7Ë+ (s>>1Ë+ 
«me
[7]; s = (s<<7) + (s>>1) +Çame[8];

334 
s
 = (s<<7Ë+ (s>>1Ë+ 
«me
[9]; s = (s<<7) + (s>>1) +Çame[10];

335  
s
;

336 
	}
}

338 
ölöe
 
£˘‹_t
 
	$Át_˛us_to_blkƒ
(
msdos_sb_öfo
 *
sbi
, 
˛us
)

340  ((
£˘‹_t
)
˛us
 - 
FAT_START_ENT
Ë* 
sbi
->
£c_≥r_˛us


341 + 
sbi
->
d©a_°¨t
;

342 
	}
}

344 
ölöe
 
	$Át_gë_blkƒ_off£t
(
msdos_sb_öfo
 *
sbi
,

345 
loff_t
 
i_pos
, 
£˘‹_t
 *
blkƒ
, *
off£t
)

347 *
blkƒ
 = 
i_pos
 >> 
sbi
->
dú_≥r_block_bôs
;

348 *
off£t
 = 
i_pos
 & (
sbi
->
dú_≥r_block
 - 1);

349 
	}
}

351 
ölöe
 
loff_t
 
	$Át_i_pos_ªad
(
msdos_sb_öfo
 *
sbi
,

352 
öode
 *inode)

354 
loff_t
 
i_pos
;

355 #i‡
BITS_PER_LONG
 == 32

356 
	`•ö_lock
(&
sbi
->
öode_hash_lock
);

358 
i_pos
 = 
	`MSDOS_I
(
öode
)->i_pos;

359 #i‡
BITS_PER_LONG
 == 32

360 
	`•ö_u∆ock
(&
sbi
->
öode_hash_lock
);

362  
i_pos
;

363 
	}
}

365 
ölöe
 
	$Át16_towch¨
(
wch¨_t
 *
d°
, c⁄° 
__u8
 *
§c
, 
size_t
 
Àn
)

367 #ifde‡
__BIG_ENDIAN


368 
Àn
--) {

369 *
d°
++ = 
§c
[0] | (src[1] << 8);

370 
§c
 += 2;

373 
	`mem˝y
(
d°
, 
§c
, 
Àn
 * 2);

375 
	}
}

377 
ölöe
 
	$Át_gë_°¨t
(c⁄° 
msdos_sb_öfo
 *
sbi
,

378 c⁄° 
msdos_dú_íåy
 *
de
)

380 
˛u°î
 = 
	`À16_to_˝u
(
de
->
°¨t
);

381 i‡(
sbi
->
Át_bôs
 == 32)

382 
˛u°î
 |(
	`À16_to_˝u
(
de
->
°¨thi
) << 16);

383  
˛u°î
;

384 
	}
}

386 
ölöe
 
	$Át_£t_°¨t
(
msdos_dú_íåy
 *
de
, 
˛u°î
)

388 
de
->
°¨t
 = 
	`˝u_to_À16
(
˛u°î
);

389 
de
->
°¨thi
 = 
	`˝u_to_À16
(
˛u°î
 >> 16);

390 
	}
}

392 
ölöe
 
	$Átwch¨_to16
(
__u8
 *
d°
, c⁄° 
wch¨_t
 *
§c
, 
size_t
 
Àn
)

394 #ifde‡
__BIG_ENDIAN


395 
Àn
--) {

396 
d°
[0] = *
§c
 & 0x00FF;

397 
d°
[1] = (*
§c
 & 0xFF00) >> 8;

398 
d°
 += 2;

399 
§c
++;

402 
	`mem˝y
(
d°
, 
§c
, 
Àn
 * 2);

404 
	}
}

407 
Át_ˇche_övÆ_öode
(
öode
 *inode);

408 
Át_gë_˛u°î
(
öode
 *öode, 
˛u°î
,

409 *
f˛us
, *
d˛us
);

410 
Át_bm≠
(
öode
 *öode, 
£˘‹_t
 
£˘‹
, se˘‹_à*
phys
,

411 *
m≠≥d_blocks
, 
¸óã
);

414 c⁄° 
fûe_›î©i⁄s
 
Át_dú_›î©i⁄s
;

415 
Át_£¨ch_l⁄g
(
öode
 *öode, c⁄° *
«me
,

416 
«me_Àn
, 
Át_¶Ÿ_öfo
 *
söfo
);

417 
Át_dú_em±y
(
öode
 *
dú
);

418 
Át_subdús
(
öode
 *
dú
);

419 
Át_sˇn
(
öode
 *
dú
, c⁄° *
«me
,

420 
Át_¶Ÿ_öfo
 *
söfo
);

421 
Át_sˇn_log°¨t
(
öode
 *
dú
, 
i_log°¨t
,

422 
Át_¶Ÿ_öfo
 *
söfo
);

423 
Át_gë_dŸdŸ_íåy
(
öode
 *
dú
, 
buf„r_hód
 **
bh
,

424 
msdos_dú_íåy
 **
de
);

425 
Át_Æloc_√w_dú
(
öode
 *
dú
, 
time•ec
 *
ts
);

426 
Át_add_íåõs
(
öode
 *
dú
, *
¶Ÿs
, 
ƒ_¶Ÿs
,

427 
Át_¶Ÿ_öfo
 *
söfo
);

428 
Át_ªmove_íåõs
(
öode
 *
dú
, 
Át_¶Ÿ_öfo
 *
söfo
);

431 
	sÁt_íåy
 {

432 
	míåy
;

434 
u8
 *
	mít12_p
[2];

435 
__À16
 *
	mít16_p
;

436 
__À32
 *
	mít32_p
;

437 } 
	mu
;

438 
	mƒ_bhs
;

439 
buf„r_hód
 *
	mbhs
[2];

440 
öode
 *
	mÁt_öode
;

443 
ölöe
 
	$Áã¡_öô
(
Át_íåy
 *
Áã¡
)

445 
Áã¡
->
ƒ_bhs
 = 0;

446 
Áã¡
->
íåy
 = 0;

447 
Áã¡
->
u
.
ít32_p
 = 
NULL
;

448 
Áã¡
->
bhs
[0] = f©ít->bhs[1] = 
NULL
;

449 
Áã¡
->
Át_öode
 = 
NULL
;

450 
	}
}

452 
ölöe
 
	$Áã¡_£t_íåy
(
Át_íåy
 *
Áã¡
, 
íåy
)

454 
Áã¡
->
íåy
 =Éntry;

455 
Áã¡
->
u
.
ít32_p
 = 
NULL
;

456 
	}
}

458 
ölöe
 
	$Áã¡_bªl£
(
Át_íåy
 *
Áã¡
)

460 
i
;

461 
Áã¡
->
u
.
ít32_p
 = 
NULL
;

462 
i
 = 0; i < 
Áã¡
->
ƒ_bhs
; i++)

463 
	`bªl£
(
Áã¡
->
bhs
[
i
]);

464 
Áã¡
->
ƒ_bhs
 = 0;

465 
Áã¡
->
bhs
[0] = f©ít->bhs[1] = 
NULL
;

466 
Áã¡
->
Át_öode
 = 
NULL
;

467 
	}
}

472 
võw_Áã¡_íåy
( );

473 
gë_¨ó_numbî
–*
¨ó
, 
öode
 *inode );

479 
Át_upd©e_su≥r
(
su≥r_block
 *
sb
);

480 
Át_c⁄fig_öô
(
su≥r_block
 *
sb
);

483 
Át_ít_ac˚ss_öô
(
su≥r_block
 *
sb
);

484 
Át_ít_ªad
(
öode
 *öode, 
Át_íåy
 *
Áã¡
,

485 
íåy
);

486 
Át_ít_wrôe
(
öode
 *öode, 
Át_íåy
 *
Áã¡
,

487 
√w
, 
waô
);

488 
Át_Æloc_˛u°îs
(
öode
 *öode, *
˛u°î
,

489 
ƒ_˛u°î
);

490 
Át_‰ì_˛u°îs
(
öode
 *öode, 
˛u°î
);

491 
Át_cou¡_‰ì_˛u°îs
(
su≥r_block
 *
sb
);

493 
Át_cou¡_‰ì_˛u°îs_f‹_¨ó
(
su≥r_block
 *
sb
);

497 
Át_gíîic_io˘l
(
fûe
 *
fûp
, 
cmd
,

498 
¨g
);

499 c⁄° 
fûe_›î©i⁄s
 
Át_fûe_›î©i⁄s
;

500 c⁄° 
öode_›î©i⁄s
 
Át_fûe_öode_›î©i⁄s
;

501 
Át_£èâr
(
díåy
 *díåy, 
üâr
 *
©å
);

502 
Át_åunˇã_blocks
(
öode
 *öode, 
loff_t
 
off£t
);

503 
Át_gë©å
(
vfsmou¡
 *
m¡
, 
díåy
 *dentry,

504 
k°©
 *
°©
);

505 
Át_fûe_fsync
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
,

506 
d©async
);

509 
Át_©èch
(
öode
 *öode, 
loff_t
 
i_pos
);

510 
Át_dëach
(
öode
 *inode);

511 
öode
 *
Át_igë
(
su≥r_block
 *
sb
, 
loff_t
 
i_pos
);

512 
öode
 *
Át_buûd_öode
(
su≥r_block
 *
sb
,

513 
msdos_dú_íåy
 *
de
, 
loff_t
 
i_pos
);

514 
Át_sync_öode
(
öode
 *inode);

515 
Át_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
,

516 
isvÁt
, (*
£tup
)(
su≥r_block
 *));

517 
	`Át_fûl_öode
(
öode
 *öode, 
msdos_dú_íåy
 *
de
);

519 
	`Át_Êush_öodes
(
su≥r_block
 *
sb
, 
öode
 *
i1
,

520 
öode
 *
i2
);

521 
ölöe
 
	$Át_dú_hash
(
log°¨t
)

523  
	`hash_32
(
log°¨t
, 
FAT_HASH_BITS
);

524 
	}
}

527 
	$__¥ötf
(3, 4Ë
__cﬁd


528 
	`__Át_fs_îr‹
(
su≥r_block
 *
sb
, 
ªp‹t
, c⁄° *
fmt
, ...);

529 
	#Át_fs_îr‹
(
sb
, 
fmt
, 
¨gs
...) \

530 
	`__Át_fs_îr‹
(
sb
, 1, 
fmt
 , ## 
¨gs
)

	)

531 
	#Át_fs_îr‹_øãlimô
(
sb
, 
fmt
, 
¨gs
...) \

532 
	`__Át_fs_îr‹
(
sb
, 
	`__øãlimô
(&
	`MSDOS_SB
(sb)->
øãlimô
), 
fmt
 , ## 
¨gs
)

	)

533 
	$__¥ötf
(3, 4Ë
__cﬁd


534 
	`Át_msg
(
su≥r_block
 *
sb
, c⁄° *
Àvñ
, c⁄° *
fmt
, ...);

535 
	#Át_msg_øãlimô
(
sb
, 
Àvñ
, 
fmt
, 
¨gs
...) \

537 i‡(
	`__øãlimô
(&
	`MSDOS_SB
(
sb
)->
øãlimô
)) \

538 
	`Át_msg
(
sb
, 
Àvñ
, 
fmt
, ## 
¨gs
); \

539 
	}
} 0)

	)

540 
Át_˛u°îs_Êush
(
su≥r_block
 *
sb
);

541 
Át_chaö_add
(
öode
 *öode, 
√w_d˛us
, 
ƒ_˛u°î
);

542 
Át_time_Át2unix
(
msdos_sb_öfo
 *
sbi
, 
time•ec
 *
ts
,

543 
__À16
 
__time
, __À16 
__d©e
, 
u8
 
time_cs
);

544 
Át_time_unix2Át
(
msdos_sb_öfo
 *
sbi
, 
time•ec
 *
ts
,

545 
__À16
 *
time
, __À16 *
d©e
, 
u8
 *
time_cs
);

546 
Át_sync_bhs
(
buf„r_hód
 **
bhs
, 
ƒ_bhs
);

548 
Át_ˇche_öô
();

549 
Át_ˇche_de°roy
();

552 c⁄° 
exp‹t_›î©i⁄s
 
Át_exp‹t_›s
;

553 c⁄° 
exp‹t_›î©i⁄s
 
Át_exp‹t_›s_no°Æe
;

556 
	tŒu
;

560 
time_‹dîög
( );

563 
‹dî
 = 0;

564 
u64
 
¥evious_£c
 = 0;

566 if–
¥evious_£c
 =
gë_£c⁄ds
() )

568 
‹dî
++;

572 
‹dî
 = 0;

575 
¥evious_£c
 = 
gë_£c⁄ds
();

577  
‹dî
;

581 
	#CURRENT_TIME_SEC_OPEL
 ( ( 
time•ec
 ){ 
	`gë_£c⁄ds
(), 
	`time_‹dîög
(Ë} )

	)

	@fat.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

18 
__u£d


19 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

20 { 0x1da0d6ˇ, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

21 { 0xØb31904, 
__VMLINUX_SYMBOL_STR
(
blkdev_issue_disˇrd
) },

22 { 0xb3f803ab, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_de°roy
) },

23 { 0x„6823e6, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

24 { 0x405c1144, 
__VMLINUX_SYMBOL_STR
(
gë_£c⁄ds
) },

25 { 0x7129e5f8, 
__VMLINUX_SYMBOL_STR
(
hex_asc
) },

26 { 0xa27a64bc, 
__VMLINUX_SYMBOL_STR
(
sb_mö_blocksize
) },

27 { 0x343ff613, 
__VMLINUX_SYMBOL_STR
(
m¨k_buf„r_dúty_öode
) },

28 { 0xf5893abf, 
__VMLINUX_SYMBOL_STR
(
up_ªad
) },

29 { 0x75656941, 
__VMLINUX_SYMBOL_STR
(
__bªad
) },

30 { 0x4c4„f19, 
__VMLINUX_SYMBOL_STR
(
kî√l_°ack
) },

31 { 0x4986f7dc, 
__VMLINUX_SYMBOL_STR
(
u∆ﬂd_∆s
) },

32 { 0x4e80e6a4, 
__VMLINUX_SYMBOL_STR
(
gíîic_fûe_Œ£ek
) },

33 { 0xd6fbe4Á, 
__VMLINUX_SYMBOL_STR
(
__m¨k_öode_dúty
) },

34 { 0xadØbe1b, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

35 { 0x60a13e90, 
__VMLINUX_SYMBOL_STR
(
rcu_b¨rõr
) },

36 { 0x815b5dd4, 
__VMLINUX_SYMBOL_STR
(
m©ch_o˘Æ
) },

37 { 0x64999478, 
__VMLINUX_SYMBOL_STR
(
c⁄ge°i⁄_waô
) },

38 { 0x92a9c60c, 
__VMLINUX_SYMBOL_STR
(
time_to_tm
) },

39 { 0x751b22f5, 
__VMLINUX_SYMBOL_STR
(
gíîic_fh_to_∑ª¡
) },

40 { 0xd00630ó, 
__VMLINUX_SYMBOL_STR
(
£q_puts
) },

41 { 0xacf4d843, 
__VMLINUX_SYMBOL_STR
(
m©ch_°rdup
) },

42 { 0xˇe232b, 
__VMLINUX_SYMBOL_STR
(
utf16s_to_utf8s
) },

43 { 0x60022c76, 
__VMLINUX_SYMBOL_STR
(
gíîic_fûe_aio_ªad
) },

44 { 0x5f2ó640, 
__VMLINUX_SYMBOL_STR
(
£q_¥ötf
) },

45 { 0x6729d3df, 
__VMLINUX_SYMBOL_STR
(
__gë_u£r_4
) },

46 { 0x44e9a829, 
__VMLINUX_SYMBOL_STR
(
m©ch_tokí
) },

47 { 0xb1bf412a, 
__VMLINUX_SYMBOL_STR
(
«mes_ˇchï
) },

48 { 0xa4c87a2b, 
__VMLINUX_SYMBOL_STR
(
fûem≠_fd©awaô_ønge
) },

49 { 0xe48e40c2, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

50 { 0x85df9b6c, 
__VMLINUX_SYMBOL_STR
(
°r£p
) },

51 { 0x9958f35f, 
__VMLINUX_SYMBOL_STR
(
gíîic_ªad_dú
) },

52 { 0x9dfd9691, 
__VMLINUX_SYMBOL_STR
(
igøb
) },

53 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
•rötf
) },

54 { 0xd55bd8eb, 
__VMLINUX_SYMBOL_STR
(
gíîic_fûe_aio_wrôe
) },

55 { 0x3ed15e48, 
__VMLINUX_SYMBOL_STR
(
åunˇã_£tsize
) },

56 { 0x57a6ccd0, 
__VMLINUX_SYMBOL_STR
(
down_ªad
) },

57 { 0x4f8b5ddb, 
__VMLINUX_SYMBOL_STR
(
_c›y_to_u£r
) },

58 { 0xc2d4ac46, 
__VMLINUX_SYMBOL_STR
(
__ö£π_öode_hash
) },

59 { 0x42600f0c, 
__VMLINUX_SYMBOL_STR
(
m∑ge_ªad∑ges
) },

60 { 0xb8e7˚2c, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_8
) },

61 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

62 { 0xe51af1c5, 
__VMLINUX_SYMBOL_STR
(
m∑ge_ªad∑ge
) },

63 { 0xa9997d55, 
__VMLINUX_SYMBOL_STR
(
cuºít_èsk
) },

64 { 0x737bì94, 
__VMLINUX_SYMBOL_STR
(
cuºít_fs_time
) },

65 { 0xe76c7326, 
__VMLINUX_SYMBOL_STR
(
__muãx_öô
) },

66 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

67 { 0x35799Ø2, 
__VMLINUX_SYMBOL_STR
(
d_obèö_Æüs
) },

68 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

69 { 0x43a46f63, 
__VMLINUX_SYMBOL_STR
(
wrôe_öode_now
) },

70 { 0x7c1372e8, 
__VMLINUX_SYMBOL_STR
(
∑nic
) },

71 { 0x8628b40f, 
__VMLINUX_SYMBOL_STR
(
m∑ge_wrôïages
) },

72 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_c⁄d_ªsched
) },

73 { 0x5a921311, 
__VMLINUX_SYMBOL_STR
(
°∫cmp
) },

74 { 0x626ac375, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_‰ì
) },

75 { 0x16305289, 
__VMLINUX_SYMBOL_STR
(
w¨n_¶ow∑th_nuŒ
) },

76 { 0xc3Øf0a9, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_1
) },

77 { 0xf676ffba, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

78 { 0xa7190c66, 
__VMLINUX_SYMBOL_STR
(
£t_∆ök
) },

79 { 0xe6d10d80, 
__VMLINUX_SYMBOL_STR
(
__waô_⁄_buf„r
) },

80 { 0xf9b41805, 
__VMLINUX_SYMBOL_STR
(
£èâr_c›y
) },

81 { 0x29009cbb, 
__VMLINUX_SYMBOL_STR
(
sync_dúty_buf„r
) },

82 { 0x9d8589c1, 
__VMLINUX_SYMBOL_STR
(
åunˇã_∑geˇche
) },

83 { 0x4e3567f7, 
__VMLINUX_SYMBOL_STR
(
m©ch_öt
) },

84 { 0x3b4˚b4a, 
__VMLINUX_SYMBOL_STR
(
up_wrôe
) },

85 { 0xe6e3b875, 
__VMLINUX_SYMBOL_STR
(
down_wrôe
) },

86 { 0x4Ø4713, 
__VMLINUX_SYMBOL_STR
(
__bªl£
) },

87 { 0x„5d4bb2, 
__VMLINUX_SYMBOL_STR
(
sys_tz
) },

88 { 0xab905185, 
__VMLINUX_SYMBOL_STR
(
__f¢Ÿify_∑ª¡
) },

89 { 0x5bd4450b, 
__VMLINUX_SYMBOL_STR
(
öode_öô_⁄˚
) },

90 { 0xd4919e6b, 
__VMLINUX_SYMBOL_STR
(
m¡_dr›_wrôe_fûe
) },

91 { 0xc6cbbc89, 
__VMLINUX_SYMBOL_STR
(
ˇ∑bÀ
) },

92 { 0xfˇfd8cb, 
__VMLINUX_SYMBOL_STR
(
övÆid©e_öode_buf„rs
) },

93 { 0x7171121c, 
__VMLINUX_SYMBOL_STR
(
ovîÊowgid
) },

94 { 0x5590a034, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc
) },

95 { 0x9´39cc5, 
__VMLINUX_SYMBOL_STR
(
ûookup
) },

96 { 0xb2fd5˚b, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_4
) },

97 { 0xa116b0f6, 
__VMLINUX_SYMBOL_STR
(
sync_m≠pög_buf„rs
) },

98 { 0x5de28794, 
__VMLINUX_SYMBOL_STR
(
gíîic_fûe_mm≠
) },

99 { 0xac36df2, 
__VMLINUX_SYMBOL_STR
(
block_wrôe_fuŒ_∑ge
) },

100 { 0x908e63e, 
__VMLINUX_SYMBOL_STR
(
gíîic_c⁄t_ex∑nd_sim∂e
) },

101 { 0x96e6623c, 
__VMLINUX_SYMBOL_STR
(
lﬂd_∆s
) },

102 { 0xf0fdf6cb, 
__VMLINUX_SYMBOL_STR
(
__°ack_chk_Áû
) },

103 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___øãlimô
) },

104 { 0xe81e9d1f, 
__VMLINUX_SYMBOL_STR
(
gíîic_wrôe_íd
) },

105 { 0x6d052c02, 
__VMLINUX_SYMBOL_STR
(
__bªadahód
) },

106 { 0x1dd92de7, 
__VMLINUX_SYMBOL_STR
(
do_sync_ªad
) },

107 { 0x2d93f738, 
__VMLINUX_SYMBOL_STR
(
m¡_w™t_wrôe_fûe
) },

108 { 0x3ec16c3b, 
__VMLINUX_SYMBOL_STR
(
ö_group_p
) },

109 { 0x5e95b1cd, 
__VMLINUX_SYMBOL_STR
(
cuºít_umask
) },

110 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

111 { 0x99630e45, 
__VMLINUX_SYMBOL_STR
(
öode_ch™ge_ok
) },

112 { 0x721679Ø, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

113 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

114 { 0xad1d320b, 
__VMLINUX_SYMBOL_STR
(
sync_öode_mëad©a
) },

115 { 0xb9506c98, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_¸óã
) },

116 { 0x1cd1ba02, 
__VMLINUX_SYMBOL_STR
(
ùut
) },

117 { 0xbdf99021, 
__VMLINUX_SYMBOL_STR
(
c⁄t_wrôe_begö
) },

118 { 0x3e75e752, 
__VMLINUX_SYMBOL_STR
(
gíîic_fûe_fsync
) },

119 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

120 { 0x30d371fd, 
__VMLINUX_SYMBOL_STR
(
iunique
) },

121 { 0xe553891f, 
__VMLINUX_SYMBOL_STR
(
öode_dio_waô
) },

122 { 0xc4d30941, 
__VMLINUX_SYMBOL_STR
(
do_sync_wrôe
) },

123 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

124 { 0xa75312bc, 
__VMLINUX_SYMBOL_STR
(
ˇŒ_rcu_sched
) },

125 { 0x78594202, 
__VMLINUX_SYMBOL_STR
(
f¢Ÿify
) },

126 { 0x28d3˚d7, 
__VMLINUX_SYMBOL_STR
(
wrôe_dúty_buf„r
) },

127 { 0x87295294, 
__VMLINUX_SYMBOL_STR
(
sb_£t_blocksize
) },

128 { 0x4af4e52a, 
__VMLINUX_SYMBOL_STR
(
__bf‹gë
) },

129 { 0xc88f4d64, 
__VMLINUX_SYMBOL_STR
(
d_make_roŸ
) },

130 { 0xb4309756, 
__VMLINUX_SYMBOL_STR
(
__blockdev_dúe˘_IO
) },

131 { 0x5a4896a8, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_2
) },

132 { 0xa6d0dbc, 
__VMLINUX_SYMBOL_STR
(
öode_√eds_sync
) },

133 { 0xb81015e0, 
__VMLINUX_SYMBOL_STR
(
fûem≠_fd©awrôe_ønge
) },

134 { 0xa869b68c, 
__VMLINUX_SYMBOL_STR
(
__föd_gë_block
) },

135 { 0x8b618d08, 
__VMLINUX_SYMBOL_STR
(
ovîÊowuid
) },

136 { 0x3e72e2df, 
__VMLINUX_SYMBOL_STR
(
£curôy_öode_£èâr
) },

137 { 0x13cdcb34, 
__VMLINUX_SYMBOL_STR
(
m¨k_buf„r_dúty
) },

138 { 0xf728a9c1, 
__VMLINUX_SYMBOL_STR
(
√w_öode
) },

139 { 0x384f8773, 
__VMLINUX_SYMBOL_STR
(
gíîic_fûe_•li˚_ªad
) },

140 { 0xe61b840b, 
__VMLINUX_SYMBOL_STR
(
__gëblk
) },

141 { 0xd57d5acc, 
__VMLINUX_SYMBOL_STR
(
gíîic_fh_to_díåy
) },

142 { 0xÁbe19a3, 
__VMLINUX_SYMBOL_STR
(
˛ór_öode
) },

143 { 0x2a6e6109, 
__VMLINUX_SYMBOL_STR
(
__öô_rw£m
) },

144 { 0x73b6f85d, 
__VMLINUX_SYMBOL_STR
(
fûem≠_Êush
) },

145 { 0x7ˇ6d8ì, 
__VMLINUX_SYMBOL_STR
(
gíîic_block_bm≠
) },

146 { 0x9c43´Ø, 
__VMLINUX_SYMBOL_STR
(
gíîic_fûœâr
) },

147 { 0xfd0abc8, 
__VMLINUX_SYMBOL_STR
(
fûem≠_fd©awrôe
) },

148 { 0x7331c998, 
__VMLINUX_SYMBOL_STR
(
åunˇã_öode_∑ges
) },

151 c⁄° 
	g__moduÀ_dïíds
[]

152 
__u£d


153 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

157 
MODULE_INFO
(
§cvîsi⁄
, "D98CCCAC310048BE49D64F7");

	@fatent.c

6 
	~<löux/moduÀ.h
>

7 
	~<löux/fs.h
>

8 
	~<löux/msdos_fs.h
>

9 
	~<löux/blkdev.h
>

10 
	~"Át.h
"

16 
su≥r_block
 *
	gãmp_sb
;

18 
	sÁã¡_›î©i⁄s
 {

19 (*
	mít_blockƒ
)(
	msu≥r_block
 *, , *, 
	m£˘‹_t
 *);

20 (*
	mít_£t_±r
)(
	mÁt_íåy
 *, );

21 (*
	mít_bªad
)(
	msu≥r_block
 *, 
	mÁt_íåy
 *,

22 , 
	m£˘‹_t
);

23 (*
	mít_gë
)(
	mÁt_íåy
 *);

24 (*
	mít_put
)(
	mÁt_íåy
 *, );

25 (*
	mít_√xt
)(
	mÁt_íåy
 *);

28 
DEFINE_SPINLOCK
(
Át12_íåy_lock
);

30 
	$Át12_ít_blockƒ
(
su≥r_block
 *
sb
, 
íåy
,

31 *
off£t
, 
£˘‹_t
 *
blockƒ
)

33 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

34 
byãs
 = 
íåy
 + (entry >> 1);

35 
	`WARN_ON
(
íåy
 < 
FAT_START_ENT
 || 
sbi
->
max_˛u°î
 <=Éntry);

36 *
off£t
 = 
byãs
 & (
sb
->
s_blocksize
 - 1);

37 *
blockƒ
 = 
sbi
->
Át_°¨t
 + (
byãs
 >> 
sb
->
s_blocksize_bôs
);

38 
	}
}

40 
	$Át_ít_blockƒ
(
su≥r_block
 *
sb
, 
íåy
,

41 *
off£t
, 
£˘‹_t
 *
blockƒ
)

43 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

44 
byãs
 = (
íåy
 << 
sbi
->
Áã¡_shi·
);

45 
	`WARN_ON
(
íåy
 < 
FAT_START_ENT
 || 
sbi
->
max_˛u°î
 <=Éntry);

46 *
off£t
 = 
byãs
 & (
sb
->
s_blocksize
 - 1);

47 *
blockƒ
 = 
sbi
->
Át_°¨t
 + (
byãs
 >> 
sb
->
s_blocksize_bôs
);

48 
	}
}

50 
	$Át12_ít_£t_±r
(
Át_íåy
 *
Áã¡
, 
off£t
)

52 
buf„r_hód
 **
bhs
 = 
Áã¡
->bhs;

53 i‡(
Áã¡
->
ƒ_bhs
 == 1) {

54 
	`WARN_ON
(
off£t
 >(
bhs
[0]->
b_size
 - 1));

55 
Áã¡
->
u
.
ít12_p
[0] = 
bhs
[0]->
b_d©a
 + 
off£t
;

56 
Áã¡
->
u
.
ít12_p
[1] = 
bhs
[0]->
b_d©a
 + (
off£t
 + 1);

58 
	`WARN_ON
(
off£t
 !(
bhs
[0]->
b_size
 - 1));

59 
Áã¡
->
u
.
ít12_p
[0] = 
bhs
[0]->
b_d©a
 + 
off£t
;

60 
Áã¡
->
u
.
ít12_p
[1] = 
bhs
[1]->
b_d©a
;

62 
	}
}

64 
	$Át16_ít_£t_±r
(
Át_íåy
 *
Áã¡
, 
off£t
)

66 
	`WARN_ON
(
off£t
 & (2 - 1));

67 
Áã¡
->
u
.
ít16_p
 = (
__À16
 *)(Áã¡->
bhs
[0]->
b_d©a
 + 
off£t
);

68 
	}
}

70 
	$Át32_ít_£t_±r
(
Át_íåy
 *
Áã¡
, 
off£t
)

72 
	`WARN_ON
(
off£t
 & (4 - 1));

73 
Áã¡
->
u
.
ít32_p
 = (
__À32
 *)(Áã¡->
bhs
[0]->
b_d©a
 + 
off£t
);

74 
	}
}

76 
	$Át12_ít_bªad
(
su≥r_block
 *
sb
, 
Át_íåy
 *
Áã¡
,

77 
off£t
, 
£˘‹_t
 
blockƒ
)

79 
buf„r_hód
 **
bhs
 = 
Áã¡
->bhs;

81 
	`WARN_ON
(
blockƒ
 < 
	`MSDOS_SB
(
sb
)->
Át_°¨t
);

82 
Áã¡
->
Át_öode
 = 
	`MSDOS_SB
(
sb
)->fat_inode;

84 
bhs
[0] = 
	`sb_bªad
(
sb
, 
blockƒ
);

85 i‡(!
bhs
[0])

86 
îr
;

88 i‡((
off£t
 + 1Ë< 
sb
->
s_blocksize
)

89 
Áã¡
->
ƒ_bhs
 = 1;

92 
blockƒ
++;

93 
bhs
[1] = 
	`sb_bªad
(
sb
, 
blockƒ
);

94 i‡(!
bhs
[1])

95 
îr_bªl£
;

96 
Áã¡
->
ƒ_bhs
 = 2;

98 
	`Át12_ít_£t_±r
(
Áã¡
, 
off£t
);

101 
îr_bªl£
:

102 
	`bªl£
(
bhs
[0]);

103 
îr
:

104 
	`Át_msg
(
sb
, 
KERN_ERR
, "FATÑód faûed (blockƒ %Œu)", (
Œu
)
blockƒ
);

105  -
EIO
;

106 
	}
}

108 
	$Át_ít_bªad
(
su≥r_block
 *
sb
, 
Át_íåy
 *
Áã¡
,

109 
off£t
, 
£˘‹_t
 
blockƒ
)

111 
Áã¡_›î©i⁄s
 *
›s
 = 
	`MSDOS_SB
(
sb
)->
Áã¡_›s
;

113 
	`WARN_ON
(
blockƒ
 < 
	`MSDOS_SB
(
sb
)->
Át_°¨t
);

114 
Áã¡
->
Át_öode
 = 
	`MSDOS_SB
(
sb
)->fat_inode;

115 
Áã¡
->
bhs
[0] = 
	`sb_bªad
(
sb
, 
blockƒ
);

116 i‡(!
Áã¡
->
bhs
[0]) {

117 
	`Át_msg
(
sb
, 
KERN_ERR
, "FATÑead failed (blocknr %llu)",

118 (
Œu
)
blockƒ
);

119  -
EIO
;

121 
Áã¡
->
ƒ_bhs
 = 1;

122 
›s
->
	`ít_£t_±r
(
Áã¡
, 
off£t
);

124 
	}
}

126 
	$Át12_ít_gë
(
Át_íåy
 *
Áã¡
)

128 
u8
 **
ít12_p
 = 
Áã¡
->
u
.ent12_p;

129 
√xt
;

131 
	`•ö_lock
(&
Át12_íåy_lock
);

132 i‡(
Áã¡
->
íåy
 & 1)

133 
√xt
 = (*
ít12_p
[0] >> 4) | (*ent12_p[1] << 4);

135 
√xt
 = (*
ít12_p
[1] << 8) | *ent12_p[0];

136 
	`•ö_u∆ock
(&
Át12_íåy_lock
);

138 
√xt
 &= 0x0fff;

139 i‡(
√xt
 >
BAD_FAT12
)

140 
√xt
 = 
FAT_ENT_EOF
;

141  
√xt
;

142 
	}
}

144 
	$Át16_ít_gë
(
Át_íåy
 *
Áã¡
)

146 
√xt
 = 
	`À16_to_˝u
(*
Áã¡
->
u
.
ít16_p
);

147 
	`WARN_ON
(()
Áã¡
->
u
.
ít16_p
 & (2 - 1));

148 i‡(
√xt
 >
BAD_FAT16
)

149 
√xt
 = 
FAT_ENT_EOF
;

150  
√xt
;

151 
	}
}

153 
	$Át32_ít_gë
(
Át_íåy
 *
Áã¡
)

155 
√xt
 = 
	`À32_to_˝u
(*
Áã¡
->
u
.
ít32_p
) & 0x0fffffff;

159 
	`WARN_ON
(()
Áã¡
->
u
.
ít32_p
 & (4 - 1));

160 i‡(
√xt
 >
BAD_FAT32
)

164 
√xt
 = 
FAT_ENT_EOF
;

166  
√xt
;

167 
	}
}

169 
	$Át12_ít_put
(
Át_íåy
 *
Áã¡
, 
√w
)

171 
u8
 **
ít12_p
 = 
Áã¡
->
u
.ent12_p;

173 i‡(
√w
 =
FAT_ENT_EOF
)

174 
√w
 = 
EOF_FAT12
;

176 
	`•ö_lock
(&
Át12_íåy_lock
);

177 i‡(
Áã¡
->
íåy
 & 1) {

178 *
ít12_p
[0] = (
√w
 << 4) | (*ent12_p[0] & 0x0f);

179 *
ít12_p
[1] = 
√w
 >> 4;

181 *
ít12_p
[0] = 
√w
 & 0xff;

182 *
ít12_p
[1] = (*ít12_p[1] & 0xf0Ë| (
√w
 >> 8);

184 
	`•ö_u∆ock
(&
Át12_íåy_lock
);

186 
	`m¨k_buf„r_dúty_öode
(
Áã¡
->
bhs
[0], f©ít->
Át_öode
);

187 i‡(
Áã¡
->
ƒ_bhs
 == 2)

188 
	`m¨k_buf„r_dúty_öode
(
Áã¡
->
bhs
[1], f©ít->
Át_öode
);

189 
	}
}

191 
	$Át16_ít_put
(
Át_íåy
 *
Áã¡
, 
√w
)

193 i‡(
√w
 =
FAT_ENT_EOF
)

194 
√w
 = 
EOF_FAT16
;

196 *
Áã¡
->
u
.
ít16_p
 = 
	`˝u_to_À16
(
√w
);

197 
	`m¨k_buf„r_dúty_öode
(
Áã¡
->
bhs
[0], f©ít->
Át_öode
);

198 
	}
}

200 
	$Át32_ít_put
(
Át_íåy
 *
Áã¡
, 
√w
)

203 if–
√w
 =
FAT_ENT_FREE
 )

208 
	`WARN_ON
(
√w
 & 0xf0000000);

209 
√w
 |
	`À32_to_˝u
(*
Áã¡
->
u
.
ít32_p
) & ~0x0fffffff;

210 *
Áã¡
->
u
.
ít32_p
 = 
	`˝u_to_À32
(
√w
);

211 
	`m¨k_buf„r_dúty_öode
(
Áã¡
->
bhs
[0], f©ít->
Át_öode
);

212 
	}
}

214 
	$Át12_ít_√xt
(
Át_íåy
 *
Áã¡
)

216 
u8
 **
ít12_p
 = 
Áã¡
->
u
.ent12_p;

217 
buf„r_hód
 **
bhs
 = 
Áã¡
->bhs;

218 
u8
 *
√xç
 = 
ít12_p
[1] + 1 + (
Áã¡
->
íåy
 & 1);

220 
Áã¡
->
íåy
++;

221 i‡(
Áã¡
->
ƒ_bhs
 == 1) {

222 
	`WARN_ON
(
ít12_p
[0] > (
u8
 *)(
bhs
[0]->
b_d©a
 +

223 (
bhs
[0]->
b_size
 - 2)));

224 
	`WARN_ON
(
ít12_p
[1] > (
u8
 *)(
bhs
[0]->
b_d©a
 +

225 (
bhs
[0]->
b_size
 - 1)));

226 i‡(
√xç
 < (
u8
 *)(
bhs
[0]->
b_d©a
 + (bhs[0]->
b_size
 - 1))) {

227 
ít12_p
[0] = 
√xç
 - 1;

228 
ít12_p
[1] = 
√xç
;

232 
	`WARN_ON
(
ít12_p
[0] !(
u8
 *)(
bhs
[0]->
b_d©a
 +

233 (
bhs
[0]->
b_size
 - 1)));

234 
	`WARN_ON
(
ít12_p
[1] !(
u8
 *)
bhs
[1]->
b_d©a
);

235 
ít12_p
[0] = 
√xç
 - 1;

236 
ít12_p
[1] = 
√xç
;

237 
	`bªl£
(
bhs
[0]);

238 
bhs
[0] = bhs[1];

239 
Áã¡
->
ƒ_bhs
 = 1;

242 
ít12_p
[0] = 
NULL
;

243 
ít12_p
[1] = 
NULL
;

245 
	}
}

247 
	$Át16_ít_√xt
(
Át_íåy
 *
Áã¡
)

249 c⁄° 
buf„r_hód
 *
bh
 = 
Áã¡
->
bhs
[0];

250 
Áã¡
->
íåy
++;

251 i‡(
Áã¡
->
u
.
ít16_p
 < (
__À16
 *)(
bh
->
b_d©a
 + (bh->
b_size
 - 2))) {

252 
Áã¡
->
u
.
ít16_p
++;

255 
Áã¡
->
u
.
ít16_p
 = 
NULL
;

257 
	}
}

259 
	$Át32_ít_√xt
(
Át_íåy
 *
Áã¡
)

261 c⁄° 
buf„r_hód
 *
bh
 = 
Áã¡
->
bhs
[0];

262 
Áã¡
->
íåy
++;

263 i‡(
Áã¡
->
u
.
ít32_p
 < (
__À32
 *)(
bh
->
b_d©a
 + (bh->
b_size
 - 4))) {

264 
Áã¡
->
u
.
ít32_p
++;

267 
Áã¡
->
u
.
ít32_p
 = 
NULL
;

269 
	}
}

271 
Áã¡_›î©i⁄s
 
	gÁt12_›s
 = {

272 .
ít_blockƒ
 = 
Át12_ít_blockƒ
,

273 .
	gít_£t_±r
 = 
Át12_ít_£t_±r
,

274 .
	gít_bªad
 = 
Át12_ít_bªad
,

275 .
	gít_gë
 = 
Át12_ít_gë
,

276 .
	gít_put
 = 
Át12_ít_put
,

277 .
	gít_√xt
 = 
Át12_ít_√xt
,

280 
Áã¡_›î©i⁄s
 
	gÁt16_›s
 = {

281 .
ít_blockƒ
 = 
Át_ít_blockƒ
,

282 .
	gít_£t_±r
 = 
Át16_ít_£t_±r
,

283 .
	gít_bªad
 = 
Át_ít_bªad
,

284 .
	gít_gë
 = 
Át16_ít_gë
,

285 .
	gít_put
 = 
Át16_ít_put
,

286 .
	gít_√xt
 = 
Át16_ít_√xt
,

289 
Áã¡_›î©i⁄s
 
	gÁt32_›s
 = {

290 .
ít_blockƒ
 = 
Át_ít_blockƒ
,

291 .
	gít_£t_±r
 = 
Át32_ít_£t_±r
,

292 .
	gít_bªad
 = 
Át_ít_bªad
,

293 .
	gít_gë
 = 
Át32_ít_gë
,

294 .
	gít_put
 = 
Át32_ít_put
,

295 .
	gít_√xt
 = 
Át32_ít_√xt
,

298 
ölöe
 
	$lock_Át
(
msdos_sb_öfo
 *
sbi
)

300 
	`muãx_lock
(&
sbi
->
Át_lock
);

301 
	}
}

303 
ölöe
 
	$u∆ock_Át
(
msdos_sb_öfo
 *
sbi
)

305 
	`muãx_u∆ock
(&
sbi
->
Át_lock
);

306 
	}
}

308 
	$Át_ít_ac˚ss_öô
(
su≥r_block
 *
sb
)

310 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

312 
	`muãx_öô
(&
sbi
->
Át_lock
);

314 
sbi
->
Át_bôs
) {

316 
sbi
->
Áã¡_shi·
 = 2;

317 
sbi
->
Áã¡_›s
 = &
Át32_›s
;

320 
sbi
->
Áã¡_shi·
 = 1;

321 
sbi
->
Áã¡_›s
 = &
Át16_›s
;

324 
sbi
->
Áã¡_shi·
 = -1;

325 
sbi
->
Áã¡_›s
 = &
Át12_›s
;

328 
	}
}

330 
	$m¨k_fsöfo_dúty
(
su≥r_block
 *
sb
)

332 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

334 i‡(
sb
->
s_Êags
 & 
MS_RDONLY
 || 
sbi
->
Át_bôs
 != 32)

337 
	`__m¨k_öode_dúty
(
sbi
->
fsöfo_öode
, 
I_DIRTY_SYNC
);

338 
	}
}

340 
ölöe
 
	$Át_ít_upd©e_±r
(
su≥r_block
 *
sb
,

341 
Át_íåy
 *
Áã¡
,

342 
off£t
, 
£˘‹_t
 
blockƒ
)

344 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

345 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

346 
buf„r_hód
 **
bhs
 = 
Áã¡
->bhs;

349 i‡(!
Áã¡
->
ƒ_bhs
 || 
bhs
[0]->
b_blockƒ
 !
blockƒ
)

351 i‡(
sbi
->
Át_bôs
 == 12) {

352 i‡((
off£t
 + 1Ë< 
sb
->
s_blocksize
) {

354 i‡(
Áã¡
->
ƒ_bhs
 == 2) {

355 
	`bªl£
(
bhs
[1]);

356 
Áã¡
->
ƒ_bhs
 = 1;

360 i‡(
Áã¡
->
ƒ_bhs
 != 2)

362 i‡(
bhs
[1]->
b_blockƒ
 !(
blockƒ
 + 1))

366 
›s
->
	`ít_£t_±r
(
Áã¡
, 
off£t
);

368 
	}
}

370 
	$Át_ít_ªad
(
öode
 *öode, 
Át_íåy
 *
Áã¡
, 
íåy
)

372 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

373 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

374 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

375 
îr
, 
off£t
;

376 
£˘‹_t
 
blockƒ
;

378 i‡(
íåy
 < 
FAT_START_ENT
 || 
sbi
->
max_˛u°î
 <=Éntry) {

379 
	`Áã¡_bªl£
(
Áã¡
);

380 
	`Át_fs_îr‹
(
sb
, "övÆidác˚s†tÿFAT (íåy 0x%08x)", 
íåy
);

381  -
EIO
;

384 
	`Áã¡_£t_íåy
(
Áã¡
, 
íåy
);

385 
›s
->
	`ít_blockƒ
(
sb
, 
íåy
, &
off£t
, &
blockƒ
);

387 i‡(!
	`Át_ít_upd©e_±r
(
sb
, 
Áã¡
, 
off£t
, 
blockƒ
)) {

388 
	`Áã¡_bªl£
(
Áã¡
);

389 
îr
 = 
›s
->
	`ít_bªad
(
sb
, 
Áã¡
, 
off£t
, 
blockƒ
);

390 i‡(
îr
)

391  
îr
;

393  
›s
->
	`ít_gë
(
Áã¡
);

394 
	}
}

397 
	$Át_múr‹_bhs
(
su≥r_block
 *
sb
, 
buf„r_hód
 **
bhs
,

398 
ƒ_bhs
)

400 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

401 
buf„r_hód
 *
c_bh
;

402 
îr
, 
n
, 
c›y
;

404 
îr
 = 0;

405 
c›y
 = 1; c›y < 
sbi
->
Áts
; copy++) {

406 
£˘‹_t
 
backup_Át
 = 
sbi
->
Át_Àngth
 * 
c›y
;

408 
n
 = 0;Ç < 
ƒ_bhs
;Ç++) {

409 
c_bh
 = 
	`sb_gëblk
(
sb
, 
backup_Át
 + 
bhs
[
n
]->
b_blockƒ
);

410 i‡(!
c_bh
) {

411 
îr
 = -
ENOMEM
;

412 
îr‹
;

414 
	`mem˝y
(
c_bh
->
b_d©a
, 
bhs
[
n
]->b_d©a, 
sb
->
s_blocksize
);

415 
	`£t_buf„r_u±od©e
(
c_bh
);

416 
	`m¨k_buf„r_dúty_öode
(
c_bh
, 
sbi
->
Át_öode
);

417 i‡(
sb
->
s_Êags
 & 
MS_SYNCHRONOUS
)

418 
îr
 = 
	`sync_dúty_buf„r
(
c_bh
);

419 
	`bªl£
(
c_bh
);

420 i‡(
îr
)

421 
îr‹
;

424 
îr‹
:

425  
îr
;

426 
	}
}

428 
	$Át_ít_wrôe
(
öode
 *öode, 
Át_íåy
 *
Áã¡
,

429 
√w
, 
waô
)

431 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

432 
Áã¡_›î©i⁄s
 *
›s
 = 
	`MSDOS_SB
(
sb
)->
Áã¡_›s
;

433 
îr
;

435 
›s
->
	`ít_put
(
Áã¡
, 
√w
);

436 i‡(
waô
) {

437 
îr
 = 
	`Át_sync_bhs
(
Áã¡
->
bhs
, f©ít->
ƒ_bhs
);

438 i‡(
îr
)

439  
îr
;

441  
	`Át_múr‹_bhs
(
sb
, 
Áã¡
->
bhs
, f©ít->
ƒ_bhs
);

442 
	}
}

444 
ölöe
 
	$Át_ít_√xt
(
msdos_sb_öfo
 *
sbi
,

445 
Át_íåy
 *
Áã¡
)

447 i‡(
sbi
->
Áã¡_›s
->
	`ít_√xt
(
Áã¡
)) {

448 i‡(
Áã¡
->
íåy
 < 
sbi
->
max_˛u°î
)

452 
	}
}

454 
ölöe
 
	$Át_ít_ªad_block
(
su≥r_block
 *
sb
,

455 
Át_íåy
 *
Áã¡
)

457 
Áã¡_›î©i⁄s
 *
›s
 = 
	`MSDOS_SB
(
sb
)->
Áã¡_›s
;

458 
£˘‹_t
 
blockƒ
;

459 
off£t
;

461 
	`Áã¡_bªl£
(
Áã¡
);

462 
›s
->
	`ít_blockƒ
(
sb
, 
Áã¡
->
íåy
, &
off£t
, &
blockƒ
);

463  
›s
->
	`ít_bªad
(
sb
, 
Áã¡
, 
off£t
, 
blockƒ
);

464 
	}
}

466 
	$Át_cﬁÀ˘_bhs
(
buf„r_hód
 **
bhs
, *
ƒ_bhs
,

467 
Át_íåy
 *
Áã¡
)

469 
n
, 
i
;

471 
n
 = 0;Ç < 
Áã¡
->
ƒ_bhs
;Ç++) {

472 
i
 = 0; i < *
ƒ_bhs
; i++) {

473 i‡(
Áã¡
->
bhs
[
n
] =bhs[
i
])

476 i‡(
i
 =*
ƒ_bhs
) {

477 
	`gë_bh
(
Áã¡
->
bhs
[
n
]);

478 
bhs
[
i
] = 
Áã¡
->bhs[
n
];

479 (*
ƒ_bhs
)++;

482 
	}
}

484 
	$võw_Áã¡_íåy
( )

486 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
–
ãmp_sb
 );

487 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

488 
Át_íåy
 
Áã¡
;

489 
cou¡
, 
îr
, 
i
;

490 
íåy
 = 0;

492 
suc˚ssive_d©a
 = 1;

493 
ãmp_íåy
 = 0;

494 
Êag
 = 0, 
°¨t
 = 0, 
íd
 = 0;

496 
	`¥ötk
–
KERN_ALERT
 "[cheon] view_fatent_entry()Åest \n");

497 
cou¡
 = 
FAT_START_ENT
;

499  
i
 = 1 ; i <= 4; i++ )

501 
	`Áã¡_öô
–&
Áã¡
 );

502 
	`Áã¡_£t_íåy
–&
Áã¡
, 
sbi
->
bx_°¨t_˛u°î
[ 
i
 ] );

504  
cou¡
 < 
sbi
->
max_˛u°î
 )

506 if–
Áã¡
.
íåy
 >
sbi
->
max_˛u°î
 )

507 
Áã¡
.
íåy
 = 
FAT_START_ENT
;

509 
	`Áã¡_£t_íåy
–&
Áã¡
, f©ít.
íåy
 );

510 
îr
 = 
	`Át_ít_ªad_block
–
ãmp_sb
, &
Áã¡
 );

511 if–
îr
 )

512 
out
;

516 if–
›s
->
	`ít_gë
–&
Áã¡
 ) =
FAT_ENT_FREE
 )

518 
íåy
 = 
Áã¡
.entry;

519 if–
íåy
 =
ãmp_íåy
 + 1 )

521 
suc˚ssive_d©a
++;

523 if–
Êag
 =0 ) 
°¨t
 = 
ãmp_íåy
;

525 
íd
 = 
íåy
;

527 
Êag
 = 1;

529 
ãmp_íåy
 = 
íåy
;

534 if–
Êag
 == 1 )

536 
	`¥ötk
–
KERN_ALERT
 "[che⁄] [%d ~ %d ]\t: %luM \n",
°¨t
, 
íd
, 
suc˚ssive_d©a
 * 4096 / 1024 / 1024 );

538 
suc˚ssive_d©a
 = 1;

539 
Êag
 = 0;

542 if–
Áã¡
.
íåy
 =
sbi
->
bx_íd_˛u°î
[ 
i
 ] )

544 if–
Êag
 == 1 )

546 
	`¥ötk
–
KERN_ALERT
 "[che⁄] [%d ~ %d ]\t: %luM \n",
°¨t
, 
íd
, 
suc˚ssive_d©a
 * 4096 / 1024 / 1024 );

548 
suc˚ssive_d©a
 = 1;

549 
Êag
 = 0;

551 
out
;

554  
	`Át_ít_√xt
–
sbi
, &
Áã¡
 ) );

556 
out
:

557 
	`Áã¡_bªl£
–&
Áã¡
 );

561 
	}
}

562 
EXPORT_SYMBOL_GPL
–
võw_Áã¡_íåy
 );

572 
	$võw_Áã¡_íåy
( )

574 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
–
ãmp_sb
 );

575 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

576 
Át_íåy
 
Áã¡
;

577 
cou¡
, 
îr
, 
i
;

579 
	`¥ötk
–
KERN_ALERT
 "[cheon] view_fatent_entry() \n");

581 
cou¡
 = 
FAT_START_ENT
;

583  
i
 = 
BB_NORMAL
 ; i <
BB_IMAGE
 ; i++ )

585 
	`Áã¡_öô
–&
Áã¡
 );

586 
	`Áã¡_£t_íåy
–&
Áã¡
, 
sbi
->
bx_°¨t_˛u°î
[ 
i
 ] );

588  
cou¡
 < 
sbi
->
max_˛u°î
 )

590 if–
Áã¡
.
íåy
 >
sbi
->
max_˛u°î
 )

591 
Áã¡
.
íåy
 = 
FAT_START_ENT
;

593 
	`Áã¡_£t_íåy
–&
Áã¡
, f©ít.
íåy
 );

594 
îr
 = 
	`Át_ít_ªad_block
–
ãmp_sb
, &
Áã¡
 );

595 if–
îr
 )

596 
out
;

599 if–
›s
->
	`ít_gë
–&
Áã¡
 ) =
FAT_ENT_FREE
 )

601 
íåy
 = 
Áã¡
.entry;

603 
	`¥ötk
–
KERN_ALERT
 "[che⁄]É¡ry : %d \n", 
íåy
 );

608 if–
Áã¡
.
íåy
 =
sbi
->
bx_íd_˛u°î
[ 
i
 ] )

609 
out
;

612  
	`Át_ít_√xt
–
sbi
, &
Áã¡
 ) );

615 
out
:

617 
	`Áã¡_bªl£
–&
Áã¡
 );

622 
	}
}

623 
EXPORT_SYMBOL_GPL
–
võw_Áã¡_íåy
 );

625 
	$Át_Æloc_˛u°îs
(
öode
 *öode, *
˛u°î
, 
ƒ_˛u°î
)

627 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

630 
ãmp_sb
 = 
sb
;

632 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

633 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

634 
Át_íåy
 
Áã¡
, 
¥ev_ít
;

635 
buf„r_hód
 *
bhs
[
MAX_BUF_PER_PAGE
];

636 
i
, 
cou¡
, 
îr
, 
ƒ_bhs
, 
idx_˛us
;

638 
díåy
 *díåy = 
NULL
;

639 
díåy
 *
p_díåy
 = 
NULL
;

640 
¨ó
;

642 
	`BUG_ON
(
ƒ_˛u°î
 > (
MAX_BUF_PER_PAGE
 / 2));

648 
díåy
 = 
	`li°_íåy
–
öode
->
i_díåy
.
fú°
, díåy, 
d_u
.
d_Æüs
 );

649 
p_díåy
 = 
díåy
->
d_∑ª¡
;

652 
	`gë_¨ó_numbî
–&
¨ó
, 
öode
 );

654 #ifde‡
__ORIGINAL_FAT_TEST__


655 if–
¨ó
 =
BB_ETC
 )

656 
¨ó
 = 
BB_ETC
;

658 
¨ó
 = 
BB_NORMAL
;

666 
	`lock_Át
(
sbi
);

667 i‡(
sbi
->
‰ì_˛u°îs
 !-1 && sbi->
‰ì_˛us_vÆid
 &&

668 
sbi
->
‰ì_˛u°îs
 < 
ƒ_˛u°î
) {

669 
	`¥ötk
–
KERN_ALERT
 "[che⁄] Nÿ•a˚ st‹agê/ cuºíà‰ì %u /Çr_˛u°î %d \n", 
sbi
->
‰ì_˛u°îs
, 
ƒ_˛u°î
 );

670 
	`u∆ock_Át
(
sbi
);

671  -
ENOSPC
;

673 #i‚de‡
__ORIGINAL_FAT_TEST__


675 if–
sbi
->
bx_‰ì_˛u°îs
[ 
¨ó
 ] < 
ƒ_˛u°î
 )

677 
	`¥ötk
–
KERN_ALERT
 "[che⁄] Nÿ•a˚ st‹agê/ bx cuºíà‰ì %u /Çr_˛u°î %d /áª®: %d \n", 
sbi
->
bx_‰ì_˛u°îs
[ 
¨ó
 ], 
ƒ_˛u°î
,área );

681 
	`u∆ock_Át
(
sbi
);

682  -
ENOSPC
;

689 
îr
 = 
ƒ_bhs
 = 
idx_˛us
 = 0;

690 
cou¡
 = 
FAT_START_ENT
;

691 
	`Áã¡_öô
(&
¥ev_ít
);

692 
	`Áã¡_öô
(&
Áã¡
);

695 
	`Áã¡_£t_íåy
(&
Áã¡
, 
sbi
->
bx_¥ev_‰ì
[
¨ó
] + 0 );

697 
cou¡
 < 
sbi
->
max_˛u°î
) {

698 i‡(
Áã¡
.
íåy
 >
sbi
->
max_˛u°î
)

699 
Áã¡
.
íåy
 = 
FAT_START_ENT
;

700 
	`Áã¡_£t_íåy
(&
Áã¡
, f©ít.
íåy
);

701 
îr
 = 
	`Át_ít_ªad_block
(
sb
, &
Áã¡
);

702 i‡(
îr
)

703 
out
;

707 i‡(
›s
->
	`ít_gë
(&
Áã¡
Ë=
FAT_ENT_FREE
 && 
sbi
->
bx_°¨t_˛u°î
[ 
¨ó
 ] <Áã¡.
íåy
 && sbi->
bx_íd_˛u°î
[área ] >= fatent.entry )

709 
íåy
 = 
Áã¡
.entry;

729 
›s
->
	`ít_put
(&
Áã¡
, 
FAT_ENT_EOF
);

730 i‡(
¥ev_ít
.
ƒ_bhs
)

731 
›s
->
	`ít_put
(&
¥ev_ít
, 
íåy
);

735 
sbi
->
bb_fûe_°¨t
 = 
Áã¡
.
íåy
 + 1;

741 
	`Át_cﬁÀ˘_bhs
(
bhs
, &
ƒ_bhs
, &
Áã¡
);

743 
sbi
->
¥ev_‰ì
 = 
íåy
;

744 
sbi
->
bx_¥ev_‰ì
[ 
¨ó
 ] = 
íåy
;

747 i‡(
sbi
->
‰ì_˛u°îs
 != -1)

749 
sbi
->
‰ì_˛u°îs
--;

750 
sbi
->
bx_‰ì_˛u°îs
[ 
¨ó
 ]--;

752 if–
sbi
->
bx_‰ì_˛u°îs
[ 
¨ó
 ] == 0 )

754 
	`¥ötk
–
KERN_ALERT
 "[cheon[área is full \n");

755 
sbi
->
bb_•a˚_fuŒ
 = 1;

756 
	`u∆ock_Át
(
sbi
);

757 
	`m¨k_fsöfo_dúty
(
sb
);

758 
	`Áã¡_bªl£
(&
Áã¡
);

760  -
ENOSPC
;

766 
˛u°î
[
idx_˛us
] = 
íåy
;

767 
idx_˛us
++;

768 i‡(
idx_˛us
 =
ƒ_˛u°î
)

769 
out
;

775 
¥ev_ít
 = 
Áã¡
;

777 
cou¡
++;

778 i‡(
cou¡
 =
sbi
->
max_˛u°î
)

780 } 
	`Át_ít_√xt
(
sbi
, &
Áã¡
));

784 
sbi
->
‰ì_˛u°îs
 = 0;

785 
sbi
->
‰ì_˛us_vÆid
 = 1;

786 
îr
 = -
ENOSPC
;

788 
out
:

790 
	`u∆ock_Át
(
sbi
);

791 
	`m¨k_fsöfo_dúty
(
sb
);

792 
	`Áã¡_bªl£
(&
Áã¡
);

793 i‡(!
îr
) {

794 i‡(
	`öode_√eds_sync
(
öode
))

795 
îr
 = 
	`Át_sync_bhs
(
bhs
, 
ƒ_bhs
);

796 i‡(!
îr
)

797 
îr
 = 
	`Át_múr‹_bhs
(
sb
, 
bhs
, 
ƒ_bhs
);

799 
i
 = 0; i < 
ƒ_bhs
; i++)

800 
	`bªl£
(
bhs
[
i
]);

802 i‡(
îr
 && 
idx_˛us
)

804 
	`¥ötk
–
KERN_ALERT
 "[cheon] ==========fat_free_clustersÅest \n" );

805 
	`Át_‰ì_˛u°îs
(
öode
, 
˛u°î
[0]);

808 #ifde‡
__DEBUG__


809 
	`¥ötk
–
KERN_ALERT
 "[che⁄] f©ít.íåy : %d, sbi->‰ì_˛u°î†: %d, sbi->bx_‰ì_˛u°îs[ %d ] : %d \n", 
Áã¡
.
íåy
, 
sbi
->
‰ì_˛u°îs
, 
¨ó
, sbi->
bx_‰ì_˛u°îs
[area] );

811  
îr
;

812 
	}
}

814 
	$Át_‰ì_˛u°îs
(
öode
 *öode, 
˛u°î
)

816 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

817 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

818 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

819 
Át_íåy
 
Áã¡
;

820 
buf„r_hód
 *
bhs
[
MAX_BUF_PER_PAGE
];

821 
i
, 
îr
, 
ƒ_bhs
;

822 
fú°_˛
 = 
˛u°î
, 
dúty_fsöfo
 = 0;

825 
¨ó
;

827 
ƒ_bhs
 = 0;

828 
	`Áã¡_öô
(&
Áã¡
);

829 
	`lock_Át
(
sbi
);

831 
˛u°î
 = 
	`Át_ít_ªad
(
öode
, &
Áã¡
, cluster);

832 i‡(
˛u°î
 < 0) {

833 
îr
 = 
˛u°î
;

834 
îr‹
;

835 } i‡(
˛u°î
 =
FAT_ENT_FREE
) {

836 
	`Át_fs_îr‹
(
sb
, "%s: deleting FATÉntry beyond EOF",

837 
__func__
);

838 
îr
 = -
EIO
;

839 
îr‹
;

842 i‡(
sbi
->
›ti⁄s
.
disˇrd
) {

848 i‡(
˛u°î
 !
Áã¡
.
íåy
 + 1) {

849 
ƒ_˛us
 = 
Áã¡
.
íåy
 - 
fú°_˛
 + 1;

851 
	`sb_issue_disˇrd
(
sb
,

852 
	`Át_˛us_to_blkƒ
(
sbi
, 
fú°_˛
),

853 
ƒ_˛us
 * 
sbi
->
£c_≥r_˛us
,

854 
GFP_NOFS
, 0);

856 
fú°_˛
 = 
˛u°î
;

861 if–
›s
->
	`ít_gë
(&
Áã¡
Ë=
FAT_ENT_EOF
 )

864 
	`¥ötk
–
KERN_ALERT
 "[cheon] FAT_ENT_EOF \n");

871 
›s
->
	`ít_put
(&
Áã¡
, 
FAT_ENT_FREE
);

872 i‡(
sbi
->
‰ì_˛u°îs
 != -1) {

873 
sbi
->
‰ì_˛u°îs
++;

875 #ifde‡
__ORIGINAL_FAT_TEST__


877 if–
sbi
->
bx_°¨t_˛u°î
[ 
BB_ETC
 ] <
Áã¡
.
íåy
 && f©ít.íåy <sbi->
bx_íd_˛u°î
[ BB_ETC ] )

878 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_ETC
 ])++;

880 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
 ]++;

883 #i‚de‡
__ORIGINAL_FAT_TEST__


884 if–
sbi
->
bx_°¨t_˛u°î
[ 
BB_ETC
 ] <
Áã¡
.
íåy
 && f©ít.íåy <sbi->
bx_íd_˛u°î
[ BB_ETC ] )

885 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_ETC
 ])++;

887 if–
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ] <
Áã¡
.
íåy
 && f©ít.íåy <sbi->
bx_íd_˛u°î
[ BB_NORMAL ] )

888 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
 ])++;

890 if–
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL_EVENT
 ] <
Áã¡
.
íåy
 && f©ít.íåy <sbi->
bx_íd_˛u°î
[ BB_NORMAL_EVENT ] )

891 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL_EVENT
 ])++;

893 if–
sbi
->
bx_°¨t_˛u°î
[ 
BB_PARKING
 ] <
Áã¡
.
íåy
 && f©ít.íåy <sbi->
bx_íd_˛u°î
[ BB_PARKING ] )

894 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_PARKING
 ])++;

896 if–
sbi
->
bx_°¨t_˛u°î
[ 
BB_MANUAL
 ] <
Áã¡
.
íåy
 && f©ít.íåy <sbi->
bx_íd_˛u°î
[ BB_MANUAL ] )

897 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_MANUAL
 ])++;

899 if–
sbi
->
bx_°¨t_˛u°î
[ 
BB_IMAGE
 ] <
Áã¡
.
íåy
 && f©ít.íåy <sbi->
bx_íd_˛u°î
[ BB_IMAGE ] )

900 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_IMAGE
 ])++;

904 if–
sbi
->
bb_•a˚_fuŒ
 == 1 )

906 if–
sbi
->
bb_fûe_°¨t
 >
Áã¡
.
íåy
 && sbi->
bb_no_Æloc
 == 0 )

907 
nŸ_rm
;

912 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
 ] +–
Áã¡
.
íåy
 - sbi->
bb_fûe_°¨t
 ) + 1;

915 if–
Áã¡
.
íåy
 =
sbi
->
bx_íd_˛u°î
[ 1 ] )

916 
sbi
->
bb_fûe_°¨t
 = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ];

918 
sbi
->
bb_fûe_°¨t
 = 
Áã¡
.
íåy
 + 1;

922 
sbi
->
bb_•a˚_fuŒ
 = 0;

924 
	`¥ötk
–
KERN_ALERT
 "[che⁄] f©_‰ì_˛u°î†1, sbi->‰ì_˛u°îs++ : %d, f©ít.íåy : %d, sbi->bx_‰ì_˛u°îs[1] : %d, sbi->bb_fûe_°¨à: %d \n", 
sbi
->
‰ì_˛u°îs
, 
Áã¡
.
íåy
, sbi->
bx_‰ì_˛u°îs
[1], sbi->
bb_fûe_°¨t
 );

928 
nŸ_rm
:

929 if–
Áã¡
.
íåy
 > 
sbi
->
bx_íd_˛u°î
[ 1 ] )

930 
sbi
->
bb_fûe_°¨t
 = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ];

931 if–
Áã¡
.
íåy
 =
sbi
->
bb_fûe_°¨t
 )

932 
sbi
->
bb_fûe_°¨t
++;

937 if–
›s
->
	`ít_gë
(&
Áã¡
Ë=
FAT_ENT_EOF
 )

940 
	`¥ötk
–
KERN_ALERT
 "[cheon] FAT_ENT_EOF \n");

944 if–
sbi
->
bb_fûe_°¨t
 > sbi->
bx_íd_˛u°î
[ 1 ] )

945 
sbi
->
bb_fûe_°¨t
 = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ];

948 
sbi
->
bb_no_Æloc
 = 0;

949 
	`¥ötk
–
KERN_ALERT
 "[che⁄] f©_‰ì_˛u°î†2, sbi->‰ì_˛u°îs++ : %d, f©ít.íåy : %d, sbi->bx_‰ì_˛u°îs[1] : %d, sbi->bb_fûe_°¨à: %d \n", 
sbi
->
‰ì_˛u°îs
, 
Áã¡
.
íåy
, sbi->
bx_‰ì_˛u°îs
[1], sbi->
bb_fûe_°¨t
 );

951 if–
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
 ] =0 && ( 
Áã¡
.
íåy
 < sbi->
bb_fûe_°¨t
 ) )

953 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
 ]–()sbi->
bx_íd_˛u°î
[ 1 ] - sbi->
bb_fûe_°¨t
 ) + 1 ;

954 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->bx_‰ì_˛u°î†: %d \n", 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
] );

959 if–
sbi
->
bx_‰ì_˛u°îs
[ 1 ] =0 && sbi->
bb_no_Æloc
 == 1 )

963 
sbi
->
bb_•a˚_fuŒ
 = 1;

967 #ifde‡
__DEBUG__


968 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_free_clusters , sbi->free_clusters : %d, fatent.entry : %d, sbi->bx_free_clusters[1] : %d \n", \

969 
sbi
->
‰ì_˛u°îs
, 
Áã¡
.
íåy
, sbi->
bx_‰ì_˛u°îs
[1] );

971 
dúty_fsöfo
 = 1;

975 i‡(
ƒ_bhs
 + 
Áã¡
.ƒ_bh†> 
MAX_BUF_PER_PAGE
) {

976 i‡(
sb
->
s_Êags
 & 
MS_SYNCHRONOUS
) {

977 
îr
 = 
	`Át_sync_bhs
(
bhs
, 
ƒ_bhs
);

978 i‡(
îr
)

979 
îr‹
;

981 
îr
 = 
	`Át_múr‹_bhs
(
sb
, 
bhs
, 
ƒ_bhs
);

982 i‡(
îr
)

983 
îr‹
;

984 
i
 = 0; i < 
ƒ_bhs
; i++)

985 
	`bªl£
(
bhs
[
i
]);

986 
ƒ_bhs
 = 0;

988 
	`Át_cﬁÀ˘_bhs
(
bhs
, &
ƒ_bhs
, &
Áã¡
);

989 } 
˛u°î
 !
FAT_ENT_EOF
);

991 i‡(
sb
->
s_Êags
 & 
MS_SYNCHRONOUS
) {

992 
îr
 = 
	`Át_sync_bhs
(
bhs
, 
ƒ_bhs
);

993 i‡(
îr
)

994 
îr‹
;

996 
îr
 = 
	`Át_múr‹_bhs
(
sb
, 
bhs
, 
ƒ_bhs
);

997 
îr‹
:

998 
	`Áã¡_bªl£
(&
Áã¡
);

999 
i
 = 0; i < 
ƒ_bhs
; i++)

1000 
	`bªl£
(
bhs
[
i
]);

1001 
	`u∆ock_Át
(
sbi
);

1002 i‡(
dúty_fsöfo
)

1003 
	`m¨k_fsöfo_dúty
(
sb
);

1005  
îr
;

1006 
	}
}

1007 
EXPORT_SYMBOL_GPL
(
Át_‰ì_˛u°îs
);

1010 
	#FAT_READA_SIZE
 (128 * 1024)

	)

1012 
	$Át_ít_ªada
(
su≥r_block
 *
sb
, 
Át_íåy
 *
Áã¡
,

1013 
ªada_blocks
)

1015 
Áã¡_›î©i⁄s
 *
›s
 = 
	`MSDOS_SB
(
sb
)->
Áã¡_›s
;

1016 
£˘‹_t
 
blockƒ
;

1017 
i
, 
off£t
;

1019 
›s
->
	`ít_blockƒ
(
sb
, 
Áã¡
->
íåy
, &
off£t
, &
blockƒ
);

1021 
i
 = 0; i < 
ªada_blocks
; i++)

1022 
	`sb_bªadahód
(
sb
, 
blockƒ
 + 
i
);

1023 
	}
}

1025 
	$gë_¨ó_numbî
–*
¨ó
, 
öode
 *inode )

1027 
díåy
 *díåy = 
NULL
;

1028 
díåy
 *
uµî_díåy
 = 
NULL
;

1029 
ãmp_¨ó
 = -1;

1031 
díåy
 = 
	`li°_íåy
–
öode
->
i_díåy
.
fú°
, díåy, 
d_u
.
d_Æüs
 );

1033 if–
	`S_ISDIR
–
öode
->
i_mode
Ë|| 
díåy
->
d_∑ª¡
 =
NULL
)

1035 
ãmp_¨ó
 = 
BB_ETC
;

1037 
	`¥ötk
( "[cheon] DE,álloc ETC \n");

1041 
uµî_díåy
 = 
díåy
->
d_∑ª¡
;

1043  
uµî_díåy
 !
NULL
 )

1045 if–
uµî_díåy
->
d_«me
.
«me
 =
NULL
 )

1053 if(
	`°rcmp
(
uµî_díåy
->
d_«me
.
«me
, 
DIR_1
 ) == 0 )

1054 
ãmp_¨ó
 = 
NUM_1
;

1056 if(
	`°rcmp
(
uµî_díåy
->
d_«me
.
«me
, 
DIR_2
 ) == 0 )

1057 
ãmp_¨ó
 = 
NUM_2
;

1059 if(
	`°rcmp
(
uµî_díåy
->
d_«me
.
«me
, 
DIR_3
 ) == 0 )

1060 
ãmp_¨ó
 = 
NUM_3
;

1062 if(
	`°rcmp
(
uµî_díåy
->
d_«me
.
«me
, 
DIR_4
 ) == 0 )

1063 
ãmp_¨ó
 = 
NUM_4
;

1065 if(
	`°rcmp
(
uµî_díåy
->
d_«me
.
«me
, 
DIR_5
 ) == 0 )

1066 
ãmp_¨ó
 = 
NUM_5
;

1069 if–
ãmp_¨ó
 != -1 )

1071 if–!
	`°rcmp
("/", 
uµî_díåy
->
d_«me
.
«me
 ) )

1074 
uµî_díåy
 =uµî_díåy->
d_∑ª¡
;

1079 if–
ãmp_¨ó
 == -1 )

1081 *
¨ó
 = 
BB_ETC
;

1085 *
¨ó
 =
ãmp_¨ó
;

1089 
	}
}

1091 
	$Át_cou¡_‰ì_˛u°îs_f‹_¨ó
(
su≥r_block
 *
sb
)

1093 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1094 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

1095 
Át_íåy
 
Áã¡
;

1096 
ªada_blocks
, 
ªada_mask
, 
cur_block
;

1097 
‰ì
;

1099 
ªada_blocks
 = 
FAT_READA_SIZE
 >> 
sb
->
s_blocksize_bôs
;

1100 
ªada_mask
 = 
ªada_blocks
 - 1;

1101 
cur_block
 = 0;

1103 
‰ì
 = 0;

1104 
	`Áã¡_öô
(&
Áã¡
);

1105 
	`Áã¡_£t_íåy
(&
Áã¡
, 
FAT_START_ENT
);

1107 if–
sbi
->
bx_‰ì_vÆid
 != -1 )

1108 
¨ó_out
;

1111 
Áã¡
.
íåy
 < 
sbi
->
max_˛u°î
) {

1113 i‡((
cur_block
 & 
ªada_mask
) == 0) {

1114 
ª°
 = 
sbi
->
Át_Àngth
 - 
cur_block
;

1115 
	`Át_ít_ªada
(
sb
, &
Áã¡
, 
	`mö
(
ªada_blocks
, 
ª°
));

1117 
cur_block
++;

1119 
	`Át_ít_ªad_block
(
sb
, &
Áã¡
);

1122 i‡(
›s
->
	`ít_gë
(&
Áã¡
Ë=
FAT_ENT_FREE
)

1124 
‰ì
++;

1127 if–
Áã¡
.
íåy
 < 
sbi
->
bx_°¨t_˛u°î
[ 
BB_ETC
 ] );

1129 if–
Áã¡
.
íåy
 <
sbi
->
bx_íd_˛u°î
[ 
BB_ETC
 ] )

1130 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_ETC
 ])++;

1132 if–
Áã¡
.
íåy
 <
sbi
->
bx_íd_˛u°î
[ 
BB_NORMAL
 ] )

1133 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
 ])++;

1135 if–
Áã¡
.
íåy
 <
sbi
->
bx_íd_˛u°î
[ 
BB_NORMAL_EVENT
 ] )

1136 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL_EVENT
 ])++;

1138 if–
Áã¡
.
íåy
 <
sbi
->
bx_íd_˛u°î
[ 
BB_PARKING
 ] )

1139 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_PARKING
 ])++;

1141 if–
Áã¡
.
íåy
 <
sbi
->
bx_íd_˛u°î
[ 
BB_MANUAL
 ] )

1142 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_MANUAL
 ])++;

1144 if–
Áã¡
.
íåy
 <
sbi
->
bx_íd_˛u°î
[ 
BB_IMAGE
 ] )

1145 (
sbi
->
bx_‰ì_˛u°îs
[ 
BB_IMAGE
 ])++;

1153 } 
	`Át_ít_√xt
(
sbi
, &
Áã¡
));

1156 
sbi
->
bx_‰ì_vÆid
 = 1;

1158 
sbi
->
‰ì_˛u°îs
 = 
‰ì
;

1159 
sbi
->
‰ì_˛us_vÆid
 = 1;

1160 
	`m¨k_fsöfo_dúty
(
sb
);

1161 
	`Áã¡_bªl£
(&
Áã¡
);

1163 
¨ó_out
:

1165 
	}
}

1168 
	$Át_cou¡_‰ì_˛u°îs
(
su≥r_block
 *
sb
)

1170 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1171 
Áã¡_›î©i⁄s
 *
›s
 = 
sbi
->
Áã¡_›s
;

1172 
Át_íåy
 
Áã¡
;

1173 
ªada_blocks
, 
ªada_mask
, 
cur_block
;

1174 
îr
 = 0, 
‰ì
;

1176 
	`lock_Át
(
sbi
);

1177 i‡(
sbi
->
‰ì_˛u°îs
 !-1 && sbi->
‰ì_˛us_vÆid
)

1178 
out
;

1180 
ªada_blocks
 = 
FAT_READA_SIZE
 >> 
sb
->
s_blocksize_bôs
;

1181 
ªada_mask
 = 
ªada_blocks
 - 1;

1182 
cur_block
 = 0;

1184 
‰ì
 = 0;

1185 
	`Áã¡_öô
(&
Áã¡
);

1186 
	`Áã¡_£t_íåy
(&
Áã¡
, 
FAT_START_ENT
);

1187 
Áã¡
.
íåy
 < 
sbi
->
max_˛u°î
) {

1189 i‡((
cur_block
 & 
ªada_mask
) == 0) {

1190 
ª°
 = 
sbi
->
Át_Àngth
 - 
cur_block
;

1191 
	`Át_ít_ªada
(
sb
, &
Áã¡
, 
	`mö
(
ªada_blocks
, 
ª°
));

1193 
cur_block
++;

1195 
îr
 = 
	`Át_ít_ªad_block
(
sb
, &
Áã¡
);

1196 i‡(
îr
)

1197 
out
;

1200 i‡(
›s
->
	`ít_gë
(&
Áã¡
Ë=
FAT_ENT_FREE
)

1202 
	`¥ötk
–
KERN_ALERT
 "fat_count_free_clusters free++ \n" );

1203 
‰ì
++;

1205 } 
	`Át_ít_√xt
(
sbi
, &
Áã¡
));

1207 
sbi
->
‰ì_˛u°îs
 = 
‰ì
;

1208 
sbi
->
‰ì_˛us_vÆid
 = 1;

1209 
	`m¨k_fsöfo_dúty
(
sb
);

1210 
	`Áã¡_bªl£
(&
Áã¡
);

1211 
out
:

1212 
	`u∆ock_Át
(
sbi
);

1213  
îr
;

1214 
	}
}

	@file.c

9 
	~<löux/ˇ∑bûôy.h
>

10 
	~<löux/moduÀ.h
>

11 
	~<löux/com∑t.h
>

12 
	~<löux/mou¡.h
>

13 
	~<löux/time.h
>

14 
	~<löux/buf„r_hód.h
>

15 
	~<löux/wrôeback.h
>

16 
	~<löux/backög-dev.h
>

17 
	~<löux/blkdev.h
>

18 
	~<löux/f¢Ÿify.h
>

19 
	~<löux/£curôy.h
>

20 
	~"Át.h
"

22 
	$Át_io˘l_gë_©åibuãs
(
öode
 *öode, 
u32
 
__u£r
 *
u£r_©å
)

24 
u32
 
©å
;

26 
	`muãx_lock
(&
öode
->
i_muãx
);

27 
©å
 = 
	`Át_make_©ås
(
öode
);

28 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

30  
	`put_u£r
(
©å
, 
u£r_©å
);

31 
	}
}

33 
	$Át_io˘l_£t_©åibuãs
(
fûe
 *fûe, 
u32
 
__u£r
 *
u£r_©å
)

35 
öode
 *öodê
	`fûe_öode
(
fûe
);

36 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

37 
is_dú
 = 
	`S_ISDIR
(
öode
->
i_mode
);

38 
u32
 
©å
, 
ﬁd©å
;

39 
üâr
 
ü
;

40 
îr
;

42 
îr
 = 
	`gë_u£r
(
©å
, 
u£r_©å
);

43 i‡(
îr
)

44 
out
;

46 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

47 i‡(
îr
)

48 
out
;

49 
	`muãx_lock
(&
öode
->
i_muãx
);

57 
©å
 &0xf‡& ~(
ATTR_VOLUME
 | 
ATTR_DIR
);

59 
©å
 |(
	`MSDOS_I
(
öode
)->
i_©ås
 & 
ATTR_VOLUME
) |

60 (
is_dú
 ? 
ATTR_DIR
 : 0);

61 
ﬁd©å
 = 
	`Át_make_©ås
(
öode
);

64 
ü
.
ü_vÆid
 = 
ATTR_MODE
 | 
ATTR_CTIME
;

65 
ü
.
ü_˘ime
 = 
	`cuºít_fs_time
(
öode
->
i_sb
);

66 i‡(
is_dú
)

67 
ü
.
ü_mode
 = 
	`Át_make_mode
(
sbi
, 
©å
, 
S_IRWXUGO
);

69 
ü
.
ü_mode
 = 
	`Át_make_mode
(
sbi
, 
©å
,

70 
S_IRUGO
 | 
S_IWUGO
 | (
öode
->
i_mode
 & 
S_IXUGO
));

74 i‡(
öode
->
i_öo
 =
MSDOS_ROOT_INO
 && 
©å
 !
ATTR_DIR
) {

75 
îr
 = -
EINVAL
;

76 
out_u∆ock_öode
;

79 i‡(
sbi
->
›ti⁄s
.
sys_immuèbÀ
 &&

80 ((
©å
 | 
ﬁd©å
Ë& 
ATTR_SYS
) &&

81 !
	`ˇ∑bÀ
(
CAP_LINUX_IMMUTABLE
)) {

82 
îr
 = -
EPERM
;

83 
out_u∆ock_öode
;

91 
îr
 = 
	`£curôy_öode_£èâr
(
fûe
->
f_∑th
.
díåy
, &
ü
);

92 i‡(
îr
)

93 
out_u∆ock_öode
;

96 
îr
 = 
	`Át_£èâr
(
fûe
->
f_∑th
.
díåy
, &
ü
);

97 i‡(
îr
)

98 
out_u∆ock_öode
;

100 
	`f¢Ÿify_ch™ge
(
fûe
->
f_∑th
.
díåy
, 
ü
.
ü_vÆid
);

101 i‡(
sbi
->
›ti⁄s
.
sys_immuèbÀ
) {

102 i‡(
©å
 & 
ATTR_SYS
)

103 
öode
->
i_Êags
 |
S_IMMUTABLE
;

105 
öode
->
i_Êags
 &~
S_IMMUTABLE
;

108 
	`Át_ßve_©ås
(
öode
, 
©å
);

109 
	`m¨k_öode_dúty
(
öode
);

110 
out_u∆ock_öode
:

111 
	`muãx_u∆ock
(&
öode
->
i_muãx
);

112 
	`m¡_dr›_wrôe_fûe
(
fûe
);

113 
out
:

114  
îr
;

115 
	}
}

117 
	$Át_gíîic_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
)

119 
öode
 *öodê
	`fûe_öode
(
fûp
);

120 
u32
 
__u£r
 *
u£r_©å
 = (u32 __u£∏*)
¨g
;

122 
cmd
) {

123 
FAT_IOCTL_GET_ATTRIBUTES
:

124  
	`Át_io˘l_gë_©åibuãs
(
öode
, 
u£r_©å
);

125 
FAT_IOCTL_SET_ATTRIBUTES
:

126  
	`Át_io˘l_£t_©åibuãs
(
fûp
, 
u£r_©å
);

128  -
ENOTTY
;

130 
	}
}

132 #ifde‡
CONFIG_COMPAT


133 
	$Át_gíîic_com∑t_io˘l
(
fûe
 *
fûp
, 
cmd
,

134 
¨g
)

137  
	`Át_gíîic_io˘l
(
fûp
, 
cmd
, ()
	`com∑t_±r
(
¨g
));

138 
	}
}

141 
	$Át_fûe_ªÀa£
(
öode
 *öode, 
fûe
 *
fûp
)

143 i‡((
fûp
->
f_mode
 & 
FMODE_WRITE
) &&

144 
	`MSDOS_SB
(
öode
->
i_sb
)->
›ti⁄s
.
Êush
) {

145 
	`Át_Êush_öodes
(
öode
->
i_sb
, inode, 
NULL
);

146 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/10);

149 
	}
}

151 
	$Át_fûe_fsync
(
fûe
 *
fûp
, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

153 
öode
 *öodê
fûp
->
f_m≠pög
->
ho°
;

154 
ªs
, 
îr
;

156 
ªs
 = 
	`gíîic_fûe_fsync
(
fûp
, 
°¨t
, 
íd
, 
d©async
);

157 
îr
 = 
	`sync_m≠pög_buf„rs
(
	`MSDOS_SB
(
öode
->
i_sb
)->
Át_öode
->
i_m≠pög
);

159  
ªs
 ?Ñe†: 
îr
;

160 
	}
}

163 c⁄° 
fûe_›î©i⁄s
 
	gÁt_fûe_›î©i⁄s
 = {

164 .
Œ£ek
 = 
gíîic_fûe_Œ£ek
,

165 .
	gªad
 = 
do_sync_ªad
,

166 .
	gwrôe
 = 
do_sync_wrôe
,

167 .
	gaio_ªad
 = 
gíîic_fûe_aio_ªad
,

168 .
	gaio_wrôe
 = 
gíîic_fûe_aio_wrôe
,

169 .
	gmm≠
 = 
gíîic_fûe_mm≠
,

170 .
	gªÀa£
 = 
Át_fûe_ªÀa£
,

171 .
	gu∆ocked_io˘l
 = 
Át_gíîic_io˘l
,

172 #ifde‡
CONFIG_COMPAT


173 .
	gcom∑t_io˘l
 = 
Át_gíîic_com∑t_io˘l
,

175 .
	gfsync
 = 
Át_fûe_fsync
,

176 .
	g•li˚_ªad
 = 
gíîic_fûe_•li˚_ªad
,

179 
	$Át_c⁄t_ex∑nd
(
öode
 *öode, 
loff_t
 
size
)

181 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

182 
loff_t
 
°¨t
 = 
öode
->
i_size
, 
cou¡
 = 
size
 - inode->i_size;

183 
îr
;

185 
îr
 = 
	`gíîic_c⁄t_ex∑nd_sim∂e
(
öode
, 
size
);

186 i‡(
îr
)

187 
out
;

189 
öode
->
i_˘ime
 = inode->
i_mtime
 = 
CURRENT_TIME_SEC_OPEL
;

191 
	`m¨k_öode_dúty
(
öode
);

192 i‡(
	`IS_SYNC
(
öode
)) {

193 
îr2
;

199 
îr
 = 
	`fûem≠_fd©awrôe_ønge
(
m≠pög
, 
°¨t
,

200 
°¨t
 + 
cou¡
 - 1);

201 
îr2
 = 
	`sync_m≠pög_buf„rs
(
m≠pög
);

202 i‡(!
îr
)

203 
îr
 = 
îr2
;

204 
îr2
 = 
	`wrôe_öode_now
(
öode
, 1);

205 i‡(!
îr
)

206 
îr
 = 
îr2
;

207 i‡(!
îr
) {

208 
îr
 = 
	`fûem≠_fd©awaô_ønge
(
m≠pög
, 
°¨t
,

209 
°¨t
 + 
cou¡
 - 1);

212 
out
:

213  
îr
;

214 
	}
}

217 
	$Át_‰ì
(
öode
 *öode, 
skù
)

219 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

220 
îr
, 
waô
, 
‰ì_°¨t
, 
i_°¨t
, 
i_log°¨t
;

222 i‡(
	`MSDOS_I
(
öode
)->
i_°¨t
 == 0)

225 
	`Át_ˇche_övÆ_öode
(
öode
);

227 
waô
 = 
	`IS_DIRSYNC
(
öode
);

228 
i_°¨t
 = 
‰ì_°¨t
 = 
	`MSDOS_I
(
öode
)->i_start;

229 
i_log°¨t
 = 
	`MSDOS_I
(
öode
)->i_logstart;

232 i‡(!
skù
) {

234 
	`MSDOS_I
(
öode
)->
i_°¨t
 = 0;

235 
	`MSDOS_I
(
öode
)->
i_log°¨t
 = 0;

237 
	`MSDOS_I
(
öode
)->
i_©ås
 |
ATTR_ARCH
;

238 
öode
->
i_˘ime
 = inode->
i_mtime
 = 
CURRENT_TIME_SEC_OPEL
;

240 i‡(
waô
) {

241 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_free skip wait1 \n");

242 
îr
 = 
	`Át_sync_öode
(
öode
);

243 i‡(
îr
) {

244 
	`MSDOS_I
(
öode
)->
i_°¨t
 = i_start;

245 
	`MSDOS_I
(
öode
)->
i_log°¨t
 = i_logstart;

246  
îr
;

249 
	`m¨k_öode_dúty
(
öode
);

252 i‡(
skù
) {

253 
Át_íåy
 
Áã¡
;

254 
ªt
, 
f˛us
, 
d˛us
;

256 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_free skipÅest2 \n");

257 
ªt
 = 
	`Át_gë_˛u°î
(
öode
, 
skù
 - 1, &
f˛us
, &
d˛us
);

258 i‡(
ªt
 < 0)

259  
ªt
;

260 i‡(
ªt
 =
FAT_ENT_EOF
)

263 
	`Áã¡_öô
(&
Áã¡
);

264 
ªt
 = 
	`Át_ít_ªad
(
öode
, &
Áã¡
, 
d˛us
);

265 i‡(
ªt
 =
FAT_ENT_EOF
) {

266 
	`Áã¡_bªl£
(&
Áã¡
);

268 } i‡(
ªt
 =
FAT_ENT_FREE
) {

269 
	`Át_fs_îr‹
(
sb
,

271 
__func__
, 
	`MSDOS_I
(
öode
)->
i_pos
);

272 
ªt
 = -
EIO
;

273 } i‡(
ªt
 > 0) {

274 
îr
 = 
	`Át_ít_wrôe
(
öode
, &
Áã¡
, 
FAT_ENT_EOF
, 
waô
);

275 i‡(
îr
)

276 
ªt
 = 
îr
;

278 
	`Áã¡_bªl£
(&
Áã¡
);

279 i‡(
ªt
 < 0)

280  
ªt
;

282 
‰ì_°¨t
 = 
ªt
;

284 
öode
->
i_blocks
 = 
skù
 << (
	`MSDOS_SB
(
sb
)->
˛u°î_bôs
 - 9);

288  
	`Át_‰ì_˛u°îs
(
öode
, 
‰ì_°¨t
);

289 
	}
}

291 
	$Át_åunˇã_blocks
(
öode
 *öode, 
loff_t
 
off£t
)

293 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

294 c⁄° 
˛u°î_size
 = 
sbi
->cluster_size;

295 
ƒ_˛u°îs
;

301 i‡(
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 > 
off£t
)

302 
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 = 
off£t
;

304 
ƒ_˛u°îs
 = (
off£t
 + (
˛u°î_size
 - 1)Ë>> 
sbi
->
˛u°î_bôs
;

306 
	`Át_‰ì
(
öode
, 
ƒ_˛u°îs
);

307 
	`Át_Êush_öodes
(
öode
->
i_sb
, inode, 
NULL
);

308 
	}
}

310 
	$Át_gë©å
(
vfsmou¡
 *
m¡
, 
díåy
 *díåy, 
k°©
 *
°©
)

312 
öode
 *öodê
díåy
->
d_öode
;

316 
	`gíîic_fûœâr
(
öode
, 
°©
);

317 
°©
->
blksize
 = 
	`MSDOS_SB
(
öode
->
i_sb
)->
˛u°î_size
;

319 i‡(
	`MSDOS_SB
(
öode
->
i_sb
)->
›ti⁄s
.
nfs
 =
FAT_NFS_NOSTALE_RO
) {

321 
°©
->
öo
 = 
	`Át_i_pos_ªad
(
	`MSDOS_SB
(
öode
->
i_sb
), inode);

324 
	}
}

325 
EXPORT_SYMBOL_GPL
(
Át_gë©å
);

327 
	$Át_ßnôize_mode
(c⁄° 
msdos_sb_öfo
 *
sbi
,

328 
öode
 *öode, 
umode_t
 *
mode_±r
)

330 
umode_t
 
mask
, 
≥rm
;

337 i‡(
	`S_ISREG
(
öode
->
i_mode
))

338 
mask
 = 
sbi
->
›ti⁄s
.
fs_fmask
;

340 
mask
 = 
sbi
->
›ti⁄s
.
fs_dmask
;

342 
≥rm
 = *
mode_±r
 & ~(
S_IFMT
 | 
mask
);

350 i‡((
≥rm
 & (
S_IRUGO
 | 
S_IXUGO
)Ë!(
öode
->
i_mode
 & (S_IRUGO|S_IXUGO)))

351  -
EPERM
;

352 i‡(
	`Át_mode_ˇn_hﬁd_ro
(
öode
)) {

353 i‡((
≥rm
 & 
S_IWUGO
Ë&& (’îm & S_IWUGOË!(S_IWUGO & ~
mask
)))

354  -
EPERM
;

356 i‡((
≥rm
 & 
S_IWUGO
Ë!(S_IWUGO & ~
mask
))

357  -
EPERM
;

360 *
mode_±r
 &
S_IFMT
 | 
≥rm
;

363 
	}
}

365 
	$Át_Ælow_£t_time
(
msdos_sb_öfo
 *
sbi
, 
öode
 *inode)

367 
umode_t
 
Ælow_utime
 = 
sbi
->
›ti⁄s
.allow_utime;

369 i‡(!
	`uid_eq
(
	`cuºít_fsuid
(), 
öode
->
i_uid
)) {

370 i‡(
	`ö_group_p
(
öode
->
i_gid
))

371 
Ælow_utime
 >>= 3;

372 i‡(
Ælow_utime
 & 
MAY_WRITE
)

378 
	}
}

380 
	#TIMES_SET_FLAGS
 (
ATTR_MTIME_SET
 | 
ATTR_ATIME_SET
 | 
ATTR_TIMES_SET
)

	)

382 
	#FAT_VALID_MODE
 (
S_IFREG
 | 
S_IFDIR
 | 
S_IRWXUGO
)

	)

384 
	$Át_£èâr
(
díåy
 *díåy, 
üâr
 *
©å
)

386 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
díåy
->
d_sb
);

387 
öode
 *öodê
díåy
->
d_öode
;

388 
ü_vÆid
;

389 
îr‹
;

394 
ü_vÆid
 = 
©å
->ia_valid;

395 i‡(
ü_vÆid
 & 
TIMES_SET_FLAGS
) {

396 i‡(
	`Át_Ælow_£t_time
(
sbi
, 
öode
))

397 
©å
->
ü_vÆid
 &~
TIMES_SET_FLAGS
;

400 
îr‹
 = 
	`öode_ch™ge_ok
(
öode
, 
©å
);

401 
©å
->
ü_vÆid
 = ia_valid;

402 i‡(
îr‹
) {

403 i‡(
sbi
->
›ti⁄s
.
quõt
)

404 
îr‹
 = 0;

405 
out
;

414 i‡(
©å
->
ü_vÆid
 & 
ATTR_SIZE
) {

415 
	`öode_dio_waô
(
öode
);

417 i‡(
©å
->
ü_size
 > 
öode
->
i_size
) {

418 
îr‹
 = 
	`Át_c⁄t_ex∑nd
(
öode
, 
©å
->
ü_size
);

419 i‡(
îr‹
 || 
©å
->
ü_vÆid
 =
ATTR_SIZE
)

420 
out
;

421 
©å
->
ü_vÆid
 &~
ATTR_SIZE
;

425 i‡(((
©å
->
ü_vÆid
 & 
ATTR_UID
) &&

426 (!
	`uid_eq
(
©å
->
ü_uid
, 
sbi
->
›ti⁄s
.
fs_uid
))) ||

427 ((
©å
->
ü_vÆid
 & 
ATTR_GID
) &&

428 (!
	`gid_eq
(
©å
->
ü_gid
, 
sbi
->
›ti⁄s
.
fs_gid
))) ||

429 ((
©å
->
ü_vÆid
 & 
ATTR_MODE
) &&

430 (
©å
->
ü_mode
 & ~
FAT_VALID_MODE
)))

431 
îr‹
 = -
EPERM
;

433 i‡(
îr‹
) {

434 i‡(
sbi
->
›ti⁄s
.
quõt
)

435 
îr‹
 = 0;

436 
out
;

443 i‡(
©å
->
ü_vÆid
 & 
ATTR_MODE
) {

444 i‡(
	`Át_ßnôize_mode
(
sbi
, 
öode
, &
©å
->
ü_mode
) < 0)

445 
©å
->
ü_vÆid
 &~
ATTR_MODE
;

448 i‡(
©å
->
ü_vÆid
 & 
ATTR_SIZE
) {

449 
	`down_wrôe
(&
	`MSDOS_I
(
öode
)->
åunˇã_lock
);

450 
	`åunˇã_£tsize
(
öode
, 
©å
->
ü_size
);

451 
	`Át_åunˇã_blocks
(
öode
, 
©å
->
ü_size
);

452 
	`up_wrôe
(&
	`MSDOS_I
(
öode
)->
åunˇã_lock
);

455 
	`£èâr_c›y
(
öode
, 
©å
);

456 
	`m¨k_öode_dúty
(
öode
);

457 
out
:

458  
îr‹
;

459 
	}
}

460 
EXPORT_SYMBOL_GPL
(
Át_£èâr
);

462 c⁄° 
öode_›î©i⁄s
 
	gÁt_fûe_öode_›î©i⁄s
 = {

463 .
£èâr
 = 
Át_£èâr
,

464 .
	ggë©å
 = 
Át_gë©å
,

	@inode.c

13 
	~<löux/moduÀ.h
>

14 
	~<löux/öô.h
>

15 
	~<löux/time.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/£q_fûe.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/m∑ge.h
>

20 
	~<löux/buf„r_hód.h
>

21 
	~<löux/mou¡.h
>

22 
	~<löux/aio.h
>

23 
	~<löux/vfs.h
>

24 
	~<löux/∑r£r.h
>

25 
	~<löux/uio.h
>

26 
	~<löux/wrôeback.h
>

27 
	~<löux/log2.h
>

28 
	~<löux/hash.h
>

29 
	~<löux/blkdev.h
>

30 
	~<asm/u«lig√d.h
>

31 
	~"Át.h
"

33 #i‚de‡
CONFIG_FAT_DEFAULT_IOCHARSET


35 
	#CONFIG_FAT_DEFAULT_IOCHARSET
 ""

	)

41 
	#COUNT_AREA_0
 76800

42 
	#COUNT_AREA_1
 524288

43 
	#COUNT_AREA_2
 262144

44 
	#COUNT_AREA_3
 262144

45 
	#COUNT_AREA_4
 131072

46 
	#COUNT_AREA_5
 131072

49 
	#COUNT_AREA_0
 76800

50 
	#COUNT_AREA_1
 1310720

	)

51 
	#COUNT_AREA_2
 100

	)

52 
	#COUNT_AREA_3
 100

	)

53 
	#COUNT_AREA_4
 100

	)

54 
	#COUNT_AREA_5
 100

	)

58 
	#COUNT_AREA_0
 76800

59 
	#COUNT_AREA_1
 10240

60 
	#COUNT_AREA_2
 5120

	)

61 
	#COUNT_AREA_3
 5120

	)

62 
	#COUNT_AREA_4
 2560

	)

63 
	#COUNT_AREA_5
 2560

	)

66 
	gÁt_deÁu…_codïage
 = 
CONFIG_FAT_DEFAULT_CODEPAGE
;

67 
	gÁt_deÁu…_ioch¨£t
[] = 
CONFIG_FAT_DEFAULT_IOCHARSET
;

69 
	$time_‹dîög
( )

71 
‹dî
 = 0;

72 
u64
 
¥evious_£c
 = 0;

74 if–
¥evious_£c
 =
	`gë_£c⁄ds
() )

76 
‹dî
++;

80 
‹dî
 = 0;

83 
¥evious_£c
 = 
	`gë_£c⁄ds
();

85  
‹dî
;

86 
	}
}

87 
EXPORT_SYMBOL_GPL
–
time_‹dîög
 );

90 
	$Át_add_˛u°î
(
öode
 *inode)

93 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

98 
îr
, 
˛u°î
;

102 
díåy
 = 
	`li°_íåy
–
öode
->
i_díåy
.
fú°
, díåy, 
d_u
.
d_Æüs
 );

103 
p_díåy
 = 
díåy
->
d_∑ª¡
;

106 
	`gë_¨ó_numbî
–&
¨ó
, 
öode
 );

108 
	`¥ötk
–
KERN_ALERT
 "[che⁄]áª®: %d \n", 
¨ó
 );

111 
îr
 = 
	`Át_Æloc_˛u°îs
(
öode
, &
˛u°î
, 1);

112 i‡(
îr
)

113  
îr
;

118 if–
	`li°_íåy
–
öode
->
i_díåy
.
fú°
, 
díåy
, 
d_u
.
d_Æüs
 ) )

120 
díåy
 = 
	`li°_íåy
–
öode
->
i_díåy
.
fú°
, díåy, 
d_u
.
d_Æüs
 );

122 
sbi
->
fûe_«me
 = ( * )
díåy
->
d_«me
.
«me
;

124 if–
sbi
->
fûe_«me
 )

125 
	`¥ötk
–
KERN_ALERT
 "díåy->d_«me.«mê: %†\n", 
sbi
->
fûe_«me
 );

133 
îr
 = 
	`Át_chaö_add
(
öode
, 
˛u°î
, 1);

134 i‡(
îr
)

136 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_chain_addÉrror !!!, fat_free_clusters\n");

137 
	`Át_‰ì_˛u°îs
(
öode
, 
˛u°î
);

139  
îr
;

140 
	}
}

141 
	$check_∑ge_Æign
–*
˛u°î
, 
max_˛u°î
, 
Át_°¨t
 )

145 
adju°
 = 
Át_°¨t
 % 
BLOCK_IN_PAGE
;

146 
off£t
 = (*
˛u°î
 + 
adju°
*
CLUSTER_IN_BLOCK
Ë% 
CLUSTER_IN_PAGE
;

148 *
˛u°î
 = *˛u°î + (
CLUSTER_IN_PAGE
 - 
off£t
);

150 if(*
˛u°î
 >
max_˛u°î
)

151 *
˛u°î
 = *˛u°î - 
CLUSTER_IN_PAGE
;

153 
	}
}

155 
	$Át_upd©e_su≥r
(
su≥r_block
 *
sb
){

156 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

167 
sbi
->
bx_‰ì_vÆid
 = -1;

168 
sbi
->
bx_°¨t_˛u°î
[ 
BB_ETC
 ] = 
FAT_START_ENT
 + 2;

169 
	`check_∑ge_Æign
–&
sbi
->
bx_°¨t_˛u°î
[ 
BX_ETC
 ], sbi->
max_˛u°î
, sbi->
Át_°¨t
 );

173 
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ] = sbi->bx_°¨t_˛u°î[ 
BB_ETC
 ] + ( sbi->
max_˛u°î
 * sbi->
bx_¨ó_øtio
[ 
BX_ETC
 ] ) / 100;

174 
	`check_∑ge_Æign
–&
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ], sbi->
max_˛u°î
, sbi->
Át_°¨t
 );

176 
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL_EVENT
 ] = sbi->bx_°¨t_˛u°î[ 
BB_NORMAL
 ] + ( sbi->
max_˛u°î
 * sbi->
bx_¨ó_øtio
[ BB_NORMAL ] ) / 100;

177 
	`check_∑ge_Æign
–&
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL_EVENT
 ], sbi->
max_˛u°î
, sbi->
Át_°¨t
 );

179 
sbi
->
bx_°¨t_˛u°î
[ 
BB_PARKING
 ] = sbi->bx_°¨t_˛u°î[ 
BB_NORMAL_EVENT
 ] + ( sbi->
max_˛u°î
 * sbi->
bx_¨ó_øtio
[ BB_NORMAL_EVENT ] ) / 100;

180 
	`check_∑ge_Æign
–&
sbi
->
bx_°¨t_˛u°î
[ 
BB_PARKING
 ], sbi->
max_˛u°î
, sbi->
Át_°¨t
 );

182 
sbi
->
bx_°¨t_˛u°î
[ 
BB_MANUAL
 ] = sbi->bx_°¨t_˛u°î[ 
BB_PARKING
 ] + ( sbi->
max_˛u°î
 * sbi->
bx_¨ó_øtio
[ BB_PARKING ] ) / 100;

183 
	`check_∑ge_Æign
–&
sbi
->
bx_°¨t_˛u°î
[ 
BB_MANUAL
 ], sbi->
max_˛u°î
, sbi->
Át_°¨t
 );

185 
sbi
->
bx_°¨t_˛u°î
[ 
BB_IMAGE
 ] = sbi->bx_°¨t_˛u°î[ 
BB_MANUAL
 ] + ( sbi->
max_˛u°î
 * sbi->
bx_¨ó_øtio
[ BB_MANUAL ] ) / 100;

186 
	`check_∑ge_Æign
–&
sbi
->
bx_°¨t_˛u°î
[ 
BB_IMAGE
 ], sbi->
max_˛u°î
, sbi->
Át_°¨t
 );

188 
sbi
->
bx_íd_˛u°î
[ 
BB_ETC
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ] - 1;

189 
sbi
->
bx_íd_˛u°î
[ 
BB_NORMAL
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL_EVENT
 ] - 1;

190 
sbi
->
bx_íd_˛u°î
[ 
BB_NORMAL_EVENT
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_PARKING
 ] - 1;

191 
sbi
->
bx_íd_˛u°î
[ 
BB_PARKING
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_MANUAL
 ] - 1;

192 
sbi
->
bx_íd_˛u°î
[ 
BB_MANUAL
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_IMAGE
 ] - 1;

193 
sbi
->
bx_íd_˛u°î
[ 
BB_IMAGE
 ] = sbi->
max_˛u°î
;

197 
sbi
->
bx_°¨t_˛u°î
[ 
BB_ETC
 ] = 
FAT_START_ENT
 + 2;

198 
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
;

199 
sbi
->
bx_°¨t_˛u°î
[ 
BB_NORMAL_EVENT
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 );

200 
sbi
->
bx_°¨t_˛u°î
[ 
BB_PARKING
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 ) + 
COUNT_AREA_2
;

201 
sbi
->
bx_°¨t_˛u°î
[ 
BB_MANUAL
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 ) + 
COUNT_AREA_2
 + 
COUNT_AREA_3
;

202 
sbi
->
bx_°¨t_˛u°î
[ 
BB_IMAGE
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 ) + 
COUNT_AREA_2
 + 
COUNT_AREA_3
 + 
COUNT_AREA_4
;

204 
sbi
->
bx_íd_˛u°î
[ 
BB_ETC
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ] - 1;

205 
sbi
->
bx_íd_˛u°î
[ 
BB_NORMAL
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL_EVENT
 ] - 1;

206 
sbi
->
bx_íd_˛u°î
[ 
BB_NORMAL_EVENT
] = sbi->
bx_°¨t_˛u°î
[ 
BB_PARKING
 ] - 1;

207 
sbi
->
bx_íd_˛u°î
[ 
BB_PARKING
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_MANUAL
 ] - 1;

208 
sbi
->
bx_íd_˛u°î
[ 
BB_MANUAL
 ] = sbi->
bx_°¨t_˛u°î
[ 
BB_IMAGE
 ] - 1;

209 
sbi
->
bx_íd_˛u°î
[ 
BB_IMAGE
 ] = sbi->
bx_°¨t_˛u°î
[ BB_IMAGE ] + 
COUNT_AREA_5
 - 1;

211 
sbi
->
bx_¥ev_‰ì
[ 
BB_ETC
 ] = sbi->
bx_°¨t_˛u°î
[ BB_ETC ];

212 
sbi
->
bx_¥ev_‰ì
[ 
BB_NORMAL
 ] = sbi->
bx_°¨t_˛u°î
[ BB_NORMAL ];

213 
sbi
->
bx_¥ev_‰ì
[ 
BB_NORMAL_EVENT
 ] = sbi->
bx_°¨t_˛u°î
[ BB_NORMAL_EVENT ];

214 
sbi
->
bx_¥ev_‰ì
[ 
BB_PARKING
 ] = sbi->
bx_°¨t_˛u°î
[ BB_PARKING ];

215 
sbi
->
bx_¥ev_‰ì
[ 
BB_MANUAL
 ] = sbi->
bx_°¨t_˛u°î
[ BB_MANUAL ];

216 
sbi
->
bx_¥ev_‰ì
[ 
BB_IMAGE
 ] = sbi->
bx_°¨t_˛u°î
[ BB_IMAGE ];

218 
sbi
->
bx_√xt_°¨t
[ 
BB_ETC
 ] = -1;

219 
sbi
->
bx_√xt_°¨t
[ 
BB_NORMAL
 ] = -1;

220 
sbi
->
bx_√xt_°¨t
[ 
BB_NORMAL_EVENT
 ] = -1;

221 
sbi
->
bx_√xt_°¨t
[ 
BB_PARKING
 ] = -1;

222 
sbi
->
bx_√xt_°¨t
[ 
BB_MANUAL
 ] = -1;

223 
sbi
->
bx_√xt_°¨t
[ 
BB_IMAGE
 ] = -1;

225 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_ETC
 ] = 0;

226 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL
 ] = 0;

227 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_NORMAL_EVENT
 ] = 0;

228 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_PARKING
 ] = 0;

229 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_MANUAL
 ] = 0;

230 
sbi
->
bx_‰ì_˛u°îs
[ 
BB_IMAGE
 ] = 0;

232 
sbi
->
bb_fûe_°¨t
 = sbi->
bx_°¨t_˛u°î
[ 
BB_NORMAL
 ];

234 
sbi
->
bb_•a˚_fuŒ
 = 0;

235 
sbi
->
bb_no_Æloc
 = 0;

240 
	`Át_cou¡_‰ì_˛u°îs_f‹_¨ó
–
sb
 );

242 
	`¥ötk
("[cheon] Complete cluster calculation \n");

243 
	`¥ötk
("[che⁄] 1. [%2d%%] ETC [%6d ~%6d] / Fªê%6d(%3d%%Ë \n", 
sbi
->
bx_¨ó_øtio
[
BB_ETC
], sbi->
bx_°¨t_˛u°î
[BB_ETC], sbi->
bx_íd_˛u°î
[BB_ETC],sbi->
bx_‰ì_˛u°îs
[BB_ETC], \

244 (
sbi
->
bx_‰ì_˛u°îs
[
BB_ETC
] * 100Ë/ (sbi->
bx_íd_˛u°î
[BB_ETC] - sbi->
bx_°¨t_˛u°î
[BB_ETC] + 1 ) );

246 
	`¥ötk
("[che⁄] 2. [%2d%%] N‹mÆ [%6d ~%6d] / Fªê%6d(%3d%%Ë \n", 
sbi
->
bx_¨ó_øtio
[
BB_NORMAL
], sbi->
bx_°¨t_˛u°î
[BB_NORMAL], sbi->
bx_íd_˛u°î
[BB_NORMAL],sbi->
bx_‰ì_˛u°îs
[BB_NORMAL], \

247 (
sbi
->
bx_‰ì_˛u°îs
[
BB_NORMAL
] * 100Ë/ (sbi->
bx_íd_˛u°î
[BB_NORMAL]-sbi->
bx_°¨t_˛u°î
[BB_NORMAL] + 1 ) );

249 
	`¥ötk
("[che⁄] 3. [%2d%%] N‹mÆ Evíà[%6d ~%6d] / Fªê%6d(%3d%%Ë \n", 
sbi
->
bx_¨ó_øtio
[
BB_NORMAL_EVENT
], sbi->
bx_°¨t_˛u°î
[BB_NORMAL_EVENT], sbi->
bx_íd_˛u°î
[BB_NORMAL_EVENT],sbi->
bx_‰ì_˛u°îs
[BB_NORMAL_EVENT], \

250 (
sbi
->
bx_‰ì_˛u°îs
[
BB_NORMAL_EVENT
] * 100Ë/ (sbi->
bx_íd_˛u°î
[BB_NORMAL_EVENT]-sbi->
bx_°¨t_˛u°î
[BB_NORMAL_EVENT] + 1 ) );

252 
	`¥ötk
("[che⁄] 4. [%2d%%] P¨kög [%6d ~%6d] / Fªê%6d(%3d%%Ë \n", 
sbi
->
bx_¨ó_øtio
[
BB_PARKING
], sbi->
bx_°¨t_˛u°î
[BB_PARKING], sbi->
bx_íd_˛u°î
[BB_PARKING],sbi->
bx_‰ì_˛u°îs
[BB_PARKING], \

253 (
sbi
->
bx_‰ì_˛u°îs
[
BB_PARKING
] * 100Ë/ (sbi->
bx_íd_˛u°î
[BB_PARKING]-sbi->
bx_°¨t_˛u°î
[ BB_PARKING ] + 1) );

255 
	`¥ötk
("[che⁄] 5. [%2d%%] P¨kög Evíà [%6d ~%6d] / Fªê%6d(%3d%%Ë \n", 
sbi
->
bx_¨ó_øtio
[
BB_MANUAL
], sbi->
bx_°¨t_˛u°î
[BB_MANUAL], sbi->
bx_íd_˛u°î
[BB_MANUAL],sbi->
bx_‰ì_˛u°îs
[BB_MANUAL], \

256 (
sbi
->
bx_‰ì_˛u°îs
[
BB_MANUAL
] * 100Ë/ (sbi->
bx_íd_˛u°î
[BB_MANUAL]-sbi->
bx_°¨t_˛u°î
[BB_MANUAL] + 1) );

258 
	`¥ötk
("[che⁄] 6. [%2d%%] H™dW‹k [%6d ~%6d] / Fªê%6d(%3d%%Ë \n", 
sbi
->
bx_¨ó_øtio
[
BB_IMAGE
], sbi->
bx_°¨t_˛u°î
[BB_IMAGE], sbi->
bx_íd_˛u°î
[BB_IMAGE],sbi->
bx_‰ì_˛u°îs
[BB_IMAGE], \

259 (
sbi
->
bx_‰ì_˛u°îs
[
BB_IMAGE
] * 100Ë/ (sbi->
bx_íd_˛u°î
[BB_IMAGE]-sbi->
bx_°¨t_˛u°î
[BB_IMAGE] + 1) );

263 
	`¥ötk
("[che⁄] sbi->‰ì_˛u°î†: %d \n", 
sbi
->
‰ì_˛u°îs
 );

266 
	}
}

267 
EXPORT_SYMBOL_GPL
–
Át_upd©e_su≥r
 );

280 
ölöe
 
	$__Át_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

281 *
max_blocks
,

282 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

284 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

285 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

286 
m≠≥d_blocks
;

287 
£˘‹_t
 
phys
;

288 
îr
, 
off£t
;

290 
îr
 = 
	`Át_bm≠
(
öode
, 
iblock
, &
phys
, &
m≠≥d_blocks
, 
¸óã
);

291 i‡(
îr
)

292  
îr
; i‡(
phys
Ë{ 
	`m≠_bh
(
bh_ªsu…
, 
sb
,Öhys); *
max_blocks
 = 
	`mö
(
m≠≥d_blocks
, *max_blocks);

295 i‡(!
¸óã
)

298 i‡(
iblock
 !
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 >> 
sb
->
s_blocksize_bôs
) {

299 
	`Át_fs_îr‹
(
sb
, "corrupted file size (i_pos %lld, %lld)",

300 
	`MSDOS_I
(
öode
)->
i_pos
, MSDOS_I(öode)->
mmu_¥iv©e
);

301  -
EIO
;

304 
off£t
 = ()
iblock
 & (
sbi
->
£c_≥r_˛us
 - 1);

305 i‡(!
off£t
) {

307 
îr
 = 
	`Át_add_˛u°î
(
öode
);

308 i‡(
îr
)

309  
îr
;

312 
m≠≥d_blocks
 = 
sbi
->
£c_≥r_˛us
 - 
off£t
;

314 *
max_blocks
 = 
	`mö
(
m≠≥d_blocks
, *max_blocks);

315 
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 +*
max_blocks
 << 
sb
->
s_blocksize_bôs
;

317 
îr
 = 
	`Át_bm≠
(
öode
, 
iblock
, &
phys
, &
m≠≥d_blocks
, 
¸óã
);

318 i‡(
îr
)

319  
îr
;

321 
	`BUG_ON
(!
phys
);

322 
	`BUG_ON
(*
max_blocks
 !
m≠≥d_blocks
);

323 
	`£t_buf„r_√w
(
bh_ªsu…
);

324 
	`m≠_bh
(
bh_ªsu…
, 
sb
, 
phys
);

327 
	}
}

329 
	$Át_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

330 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

332 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

333 
max_blocks
 = 
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
;

334 
îr
;

336 
îr
 = 
	`__Át_gë_block
(
öode
, 
iblock
, &
max_blocks
, 
bh_ªsu…
, 
¸óã
);

337 i‡(
îr
)

338  
îr
;

339 
bh_ªsu…
->
b_size
 = 
max_blocks
 << 
sb
->
s_blocksize_bôs
;

341 
	}
}

343 
	$Át_wrôïage
(
∑ge
 *∑ge, 
wrôeback_c⁄åﬁ
 *
wbc
)

345  
	`block_wrôe_fuŒ_∑ge
(
∑ge
, 
Át_gë_block
, 
wbc
);

346 
	}
}

348 
	$Át_wrôïages
(
addªss_•a˚
 *
m≠pög
,

349 
wrôeback_c⁄åﬁ
 *
wbc
)

351  
	`m∑ge_wrôïages
(
m≠pög
, 
wbc
, 
Át_gë_block
);

352 
	}
}

354 
	$Át_ªad∑ge
(
fûe
 *fûe, 
∑ge
 *page)

356  
	`m∑ge_ªad∑ge
(
∑ge
, 
Át_gë_block
);

357 
	}
}

359 
	$Át_ªad∑ges
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

360 
li°_hód
 *
∑ges
, 
ƒ_∑ges
)

362  
	`m∑ge_ªad∑ges
(
m≠pög
, 
∑ges
, 
ƒ_∑ges
, 
Át_gë_block
);

363 
	}
}

365 
	$Át_wrôe_Áûed
(
addªss_•a˚
 *
m≠pög
, 
loff_t
 
to
)

367 
öode
 *öodê
m≠pög
->
ho°
;

369 i‡(
to
 > 
öode
->
i_size
) {

370 
	`åunˇã_∑geˇche
(
öode
, 
to
, inode->
i_size
);

371 
	`Át_åunˇã_blocks
(
öode
, inode->
i_size
);

373 
	}
}

375 
	$Át_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

376 
loff_t
 
pos
, 
Àn
, 
Êags
,

377 
∑ge
 **
∑gï
, **
fsd©a
)

379 
îr
;

381 *
∑gï
 = 
NULL
;

382 
îr
 = 
	`c⁄t_wrôe_begö
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
Êags
,

383 
∑gï
, 
fsd©a
, 
Át_gë_block
,

384 &
	`MSDOS_I
(
m≠pög
->
ho°
)->
mmu_¥iv©e
);

385 i‡(
îr
 < 0)

386 
	`Át_wrôe_Áûed
(
m≠pög
, 
pos
 + 
Àn
);

387  
îr
;

388 
	}
}

390 
	$Át_wrôe_íd
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

391 
loff_t
 
pos
, 
Àn
, 
c›õd
,

392 
∑ge
 *
∑gï
, *
fsd©a
)

394 
öode
 *öodê
m≠pög
->
ho°
;

395 
îr
;

396 
îr
 = 
	`gíîic_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
c›õd
, 
∑gï
, 
fsd©a
);

397 i‡(
îr
 < 
Àn
)

398 
	`Át_wrôe_Áûed
(
m≠pög
, 
pos
 + 
Àn
);

399 i‡(!(
îr
 < 0Ë&& !(
	`MSDOS_I
(
öode
)->
i_©ås
 & 
ATTR_ARCH
)) {

400 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
CURRENT_TIME_SEC_OPEL
;

402 
	`MSDOS_I
(
öode
)->
i_©ås
 |
ATTR_ARCH
;

403 
	`m¨k_öode_dúty
(
öode
);

405  
îr
;

406 
	}
}

408 
ssize_t
 
	$Át_dúe˘_IO
(
rw
, 
kiocb
 *
iocb
,

409 c⁄° 
iovec
 *
iov
,

410 
loff_t
 
off£t
, 
ƒ_£gs
)

412 
fûe
 *fûê
iocb
->
ki_fûp
;

413 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

414 
öode
 *öodê
m≠pög
->
ho°
;

415 
ssize_t
 
ªt
;

417 i‡(
rw
 =
WRITE
) {

427 
loff_t
 
size
 = 
off£t
 + 
	`iov_Àngth
(
iov
, 
ƒ_£gs
);

428 i‡(
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 < 
size
)

436 
ªt
 = 
	`blockdev_dúe˘_IO
(
rw
, 
iocb
, 
öode
, 
iov
, 
off£t
, 
ƒ_£gs
,

437 
Át_gë_block
);

438 i‡(
ªt
 < 0 && (
rw
 & 
WRITE
))

439 
	`Át_wrôe_Áûed
(
m≠pög
, 
off£t
 + 
	`iov_Àngth
(
iov
, 
ƒ_£gs
));

441  
ªt
;

442 
	}
}

444 
£˘‹_t
 
	$_Át_bm≠
(
addªss_•a˚
 *
m≠pög
, 
£˘‹_t
 
block
)

446 
£˘‹_t
 
blockƒ
;

449 
	`down_ªad
(&
	`MSDOS_I
(
m≠pög
->
ho°
)->
åunˇã_lock
);

450 
blockƒ
 = 
	`gíîic_block_bm≠
(
m≠pög
, 
block
, 
Át_gë_block
);

451 
	`up_ªad
(&
	`MSDOS_I
(
m≠pög
->
ho°
)->
åunˇã_lock
);

453  
blockƒ
;

454 
	}
}

456 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gÁt_a›s
 = {

457 .
ªad∑ge
 = 
Át_ªad∑ge
,

458 .
	gªad∑ges
 = 
Át_ªad∑ges
,

459 .
	gwrôïage
 = 
Át_wrôïage
,

460 .
	gwrôïages
 = 
Át_wrôïages
,

461 .
	gwrôe_begö
 = 
Át_wrôe_begö
,

462 .
	gwrôe_íd
 = 
Át_wrôe_íd
,

463 .
	gdúe˘_IO
 = 
Át_dúe˘_IO
,

464 .
	gbm≠
 = 
_Át_bm≠


491 
	$Át_hash_öô
(
su≥r_block
 *
sb
)

493 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

494 
i
;

496 
	`•ö_lock_öô
(&
sbi
->
öode_hash_lock
);

497 
i
 = 0; i < 
FAT_HASH_SIZE
; i++)

498 
	`INIT_HLIST_HEAD
(&
sbi
->
öode_hashèbÀ
[
i
]);

499 
	}
}

501 
ölöe
 
	$Át_hash
(
loff_t
 
i_pos
)

503  
	`hash_32
(
i_pos
, 
FAT_HASH_BITS
);

504 
	}
}

506 
	$dú_hash_öô
(
su≥r_block
 *
sb
)

508 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

509 
i
;

511 
	`•ö_lock_öô
(&
sbi
->
dú_hash_lock
);

512 
i
 = 0; i < 
FAT_HASH_SIZE
; i++)

513 
	`INIT_HLIST_HEAD
(&
sbi
->
dú_hashèbÀ
[
i
]);

514 
	}
}

516 
	$Át_©èch
(
öode
 *öode, 
loff_t
 
i_pos
)

518 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

520 i‡(
öode
->
i_öo
 !
MSDOS_ROOT_INO
) {

521 
hli°_hód
 *
hód
 = 
sbi
->
öode_hashèbÀ


522 + 
	`Át_hash
(
i_pos
);

524 
	`•ö_lock
(&
sbi
->
öode_hash_lock
);

525 
	`MSDOS_I
(
öode
)->
i_pos
 = i_pos;

526 
	`hli°_add_hód
(&
	`MSDOS_I
(
öode
)->
i_Át_hash
, 
hód
);

527 
	`•ö_u∆ock
(&
sbi
->
öode_hash_lock
);

534 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë&& 
sbi
->
›ti⁄s
.
nfs
) {

535 
hli°_hód
 *
d_hód
 = 
sbi
->
dú_hashèbÀ
;

536 
d_hód
 +
	`Át_dú_hash
(
	`MSDOS_I
(
öode
)->
i_log°¨t
);

538 
	`•ö_lock
(&
sbi
->
dú_hash_lock
);

539 
	`hli°_add_hód
(&
	`MSDOS_I
(
öode
)->
i_dú_hash
, 
d_hód
);

540 
	`•ö_u∆ock
(&
sbi
->
dú_hash_lock
);

542 
	}
}

543 
EXPORT_SYMBOL_GPL
(
Át_©èch
);

545 
	$Át_dëach
(
öode
 *inode)

547 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

548 
	`•ö_lock
(&
sbi
->
öode_hash_lock
);

549 
	`MSDOS_I
(
öode
)->
i_pos
 = 0;

550 
	`hli°_dñ_öô
(&
	`MSDOS_I
(
öode
)->
i_Át_hash
);

551 
	`•ö_u∆ock
(&
sbi
->
öode_hash_lock
);

553 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë&& 
sbi
->
›ti⁄s
.
nfs
) {

554 
	`•ö_lock
(&
sbi
->
dú_hash_lock
);

555 
	`hli°_dñ_öô
(&
	`MSDOS_I
(
öode
)->
i_dú_hash
);

556 
	`•ö_u∆ock
(&
sbi
->
dú_hash_lock
);

558 
	}
}

559 
EXPORT_SYMBOL_GPL
(
Át_dëach
);

561 
öode
 *
	$Át_igë
(
su≥r_block
 *
sb
, 
loff_t
 
i_pos
)

563 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

564 
hli°_hód
 *
hód
 = 
sbi
->
öode_hashèbÀ
 + 
	`Át_hash
(
i_pos
);

565 
msdos_öode_öfo
 *
i
;

566 
öode
 *öodê
NULL
;

568 
	`•ö_lock
(&
sbi
->
öode_hash_lock
);

569 
	`hli°_f‹_óch_íåy
(
i
, 
hód
, 
i_Át_hash
) {

570 
	`BUG_ON
(
i
->
vfs_öode
.
i_sb
 !
sb
);

571 i‡(
i
->
i_pos
 != i_pos)

573 
öode
 = 
	`igøb
(&
i
->
vfs_öode
);

574 i‡(
öode
)

577 
	`•ö_u∆ock
(&
sbi
->
öode_hash_lock
);

578  
öode
;

579 
	}
}

581 
	$is_exec
(*
exãnsi⁄
)

583 *
exe_exãnsi⁄s
 = "EXECOMBAT", *
wÆk
;

585 
wÆk
 = 
exe_exãnsi⁄s
; *walk; walk += 3)

586 i‡(!
	`°∫cmp
(
exãnsi⁄
, 
wÆk
, 3))

589 
	}
}

591 
	$Át_ˇlc_dú_size
(
öode
 *inode)

593 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

594 
ªt
, 
f˛us
, 
d˛us
;

596 
öode
->
i_size
 = 0;

597 i‡(
	`MSDOS_I
(
öode
)->
i_°¨t
 == 0)

600 
ªt
 = 
	`Át_gë_˛u°î
(
öode
, 
FAT_ENT_EOF
, &
f˛us
, &
d˛us
);

601 i‡(
ªt
 < 0)

602  
ªt
;

603 
öode
->
i_size
 = (
f˛us
 + 1Ë<< 
sbi
->
˛u°î_bôs
;

606 
	}
}

609 
	$Át_fûl_öode
(
öode
 *öode, 
msdos_dú_íåy
 *
de
)

611 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

612 
îr‹
;

614 
	`MSDOS_I
(
öode
)->
i_pos
 = 0;

615 
öode
->
i_uid
 = 
sbi
->
›ti⁄s
.
fs_uid
;

616 
öode
->
i_gid
 = 
sbi
->
›ti⁄s
.
fs_gid
;

617 
öode
->
i_vîsi⁄
++;

618 
öode
->
i_gíî©i⁄
 = 
	`gë_£c⁄ds
();

620 i‡((
de
->
©å
 & 
ATTR_DIR
Ë&& !
	`IS_FREE
(de->
«me
)) {

621 
öode
->
i_gíî©i⁄
 &= ~1;

622 
öode
->
i_mode
 = 
	`Át_make_mode
(
sbi
, 
de
->
©å
, 
S_IRWXUGO
);

623 
öode
->
i_›
 = 
sbi
->
dú_›s
;

624 
öode
->
i_f›
 = &
Át_dú_›î©i⁄s
;

626 
	`MSDOS_I
(
öode
)->
i_°¨t
 = 
	`Át_gë_°¨t
(
sbi
, 
de
);

627 
	`MSDOS_I
(
öode
)->
i_log°¨t
 = MSDOS_I(öode)->
i_°¨t
;

628 
îr‹
 = 
	`Át_ˇlc_dú_size
(
öode
);

629 i‡(
îr‹
 < 0)

630  
îr‹
;

631 
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 = inode->
i_size
;

633 
	`£t_∆ök
(
öode
, 
	`Át_subdús
(inode));

635 
öode
->
i_gíî©i⁄
 |= 1;

636 
öode
->
i_mode
 = 
	`Át_make_mode
(
sbi
, 
de
->
©å
,

637 ((
sbi
->
›ti⁄s
.
showexec
 && !
	`is_exec
(
de
->
«me
 + 8))

638 ? 
S_IRUGO
|
S_IWUGO
 : 
S_IRWXUGO
));

639 
	`MSDOS_I
(
öode
)->
i_°¨t
 = 
	`Át_gë_°¨t
(
sbi
, 
de
);

641 
	`MSDOS_I
(
öode
)->
i_log°¨t
 = MSDOS_I(öode)->
i_°¨t
;

642 
öode
->
i_size
 = 
	`À32_to_˝u
(
de
->
size
);

643 
öode
->
i_›
 = &
Át_fûe_öode_›î©i⁄s
;

644 
öode
->
i_f›
 = &
Át_fûe_›î©i⁄s
;

645 
öode
->
i_m≠pög
->
a_›s
 = &
Át_a›s
;

646 
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 = inode->
i_size
;

648 i‡(
de
->
©å
 & 
ATTR_SYS
) {

649 i‡(
sbi
->
›ti⁄s
.
sys_immuèbÀ
)

650 
öode
->
i_Êags
 |
S_IMMUTABLE
;

652 
	`Át_ßve_©ås
(
öode
, 
de
->
©å
);

654 
öode
->
i_blocks
 = ((öode->
i_size
 + (
sbi
->
˛u°î_size
 - 1))

655 & ~((
loff_t
)
sbi
->
˛u°î_size
 - 1)) >> 9;

657 
	`Át_time_Át2unix
(
sbi
, &
öode
->
i_mtime
, 
de
->
time
, de->
d©e
, 0);

658 i‡(
sbi
->
›ti⁄s
.
isvÁt
) {

659 
	`Át_time_Át2unix
(
sbi
, &
öode
->
i_˘ime
, 
de
->
˘ime
,

660 
de
->
cd©e
, de->
˘ime_cs
);

661 
	`Át_time_Át2unix
(
sbi
, &
öode
->
i_©ime
, 0, 
de
->
ad©e
, 0);

664 
öode
->
i_˘ime
 = inode->
i_©ime
 = inode->
i_mtime
;

667 
	`¥ötk
("[cheon] fat_fill_inode \n");

668 
	`¥ötk
("öode->i_mtime.tv_£¯: %lu \n", 
öode
->
i_mtime
.
tv_£c
 );

669 
	`¥ötk
("öode->i_mtime.tv_n£¯: %ld \n", 
öode
->
i_mtime
.
tv_n£c
 );

675 
	}
}

677 
ölöe
 
	$Át_lock_buûd_öode
(
msdos_sb_öfo
 *
sbi
)

679 i‡(
sbi
->
›ti⁄s
.
nfs
 =
FAT_NFS_NOSTALE_RO
)

680 
	`muãx_lock
(&
sbi
->
nfs_buûd_öode_lock
);

681 
	}
}

683 
ölöe
 
	$Át_u∆ock_buûd_öode
(
msdos_sb_öfo
 *
sbi
)

685 i‡(
sbi
->
›ti⁄s
.
nfs
 =
FAT_NFS_NOSTALE_RO
)

686 
	`muãx_u∆ock
(&
sbi
->
nfs_buûd_öode_lock
);

687 
	}
}

689 
öode
 *
	$Át_buûd_öode
(
su≥r_block
 *
sb
,

690 
msdos_dú_íåy
 *
de
, 
loff_t
 
i_pos
)

692 
öode
 *inode;

693 
îr
;

695 
	`Át_lock_buûd_öode
(
	`MSDOS_SB
(
sb
));

696 
öode
 = 
	`Át_igë
(
sb
, 
i_pos
);

697 i‡(
öode
)

698 
out
;

699 
öode
 = 
	`√w_öode
(
sb
);

700 i‡(!
öode
) {

701 
öode
 = 
	`ERR_PTR
(-
ENOMEM
);

702 
out
;

704 
öode
->
i_öo
 = 
	`iunique
(
sb
, 
MSDOS_ROOT_INO
);

705 
öode
->
i_vîsi⁄
 = 1;

706 
îr
 = 
	`Át_fûl_öode
(
öode
, 
de
);

707 i‡(
îr
) {

708 
	`ùut
(
öode
);

709 
öode
 = 
	`ERR_PTR
(
îr
);

710 
out
;

712 
	`Át_©èch
(
öode
, 
i_pos
);

713 
	`ö£π_öode_hash
(
öode
);

714 
out
:

715 
	`Át_u∆ock_buûd_öode
(
	`MSDOS_SB
(
sb
));

716  
öode
;

717 
	}
}

719 
EXPORT_SYMBOL_GPL
(
Át_buûd_öode
);

721 
	$Át_evi˘_öode
(
öode
 *inode)

723 
	`åunˇã_öode_∑ges
(&
öode
->
i_d©a
, 0);

724 i‡(!
öode
->
i_∆ök
) {

725 
öode
->
i_size
 = 0;

726 
	`Át_åunˇã_blocks
(
öode
, 0);

728 
	`övÆid©e_öode_buf„rs
(
öode
);

729 
	`˛ór_öode
(
öode
);

730 
	`Át_ˇche_övÆ_öode
(
öode
);

731 
	`Át_dëach
(
öode
);

732 
	}
}

734 
	$Át_£t_°©e
(
su≥r_block
 *
sb
,

735 
£t
, 
f‹˚
)

737 
buf„r_hód
 *
bh
;

738 
Át_boŸ_£˘‹
 *
b
;

739 
msdos_sb_öfo
 *
sbi
 = 
sb
->
s_fs_öfo
;

742 i‡((
sb
->
s_Êags
 & 
MS_RDONLY
Ë&& !
f‹˚
)

746 i‡(
sbi
->
dúty
) {

748 i‡(
£t
)

749 
	`Át_msg
(
sb
, 
KERN_WARNING
, "Volume wasÇotÖroperly "

755 
bh
 = 
	`sb_bªad
(
sb
, 0);

756 i‡(
bh
 =
NULL
) {

757 
	`Át_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead boot sector "

762 
b
 = (
Át_boŸ_£˘‹
 *Ë
bh
->
b_d©a
;

764 i‡(
sbi
->
Át_bôs
 == 32) {

765 i‡(
£t
)

766 
b
->
Át32
.
°©e
 |
FAT_STATE_DIRTY
;

768 
b
->
Át32
.
°©e
 &~
FAT_STATE_DIRTY
;

770 i‡(
£t
)

771 
b
->
Át16
.
°©e
 |
FAT_STATE_DIRTY
;

773 
b
->
Át16
.
°©e
 &~
FAT_STATE_DIRTY
;

776 
	`m¨k_buf„r_dúty
(
bh
);

777 
	`sync_dúty_buf„r
(
bh
);

778 
	`bªl£
(
bh
);

779 
	}
}

781 
	$Át_put_su≥r
(
su≥r_block
 *
sb
)

783 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

785 
	`Át_£t_°©e
(
sb
, 0, 0);

787 
	`ùut
(
sbi
->
fsöfo_öode
);

788 
	`ùut
(
sbi
->
Át_öode
);

790 
	`u∆ﬂd_∆s
(
sbi
->
∆s_disk
);

791 
	`u∆ﬂd_∆s
(
sbi
->
∆s_io
);

793 i‡(
sbi
->
›ti⁄s
.
ioch¨£t
 !
Át_deÁu…_ioch¨£t
)

794 
	`k‰ì
(
sbi
->
›ti⁄s
.
ioch¨£t
);

796 
sb
->
s_fs_öfo
 = 
NULL
;

797 
	`k‰ì
(
sbi
);

798 
	}
}

800 
kmem_ˇche
 *
	gÁt_öode_ˇchï
;

802 
öode
 *
	$Át_Æloc_öode
(
su≥r_block
 *
sb
)

804 
msdos_öode_öfo
 *
ei
;

805 
ei
 = 
	`kmem_ˇche_Æloc
(
Át_öode_ˇchï
, 
GFP_NOFS
);

806 i‡(!
ei
)

807  
NULL
;

809 
	`öô_rw£m
(&
ei
->
åunˇã_lock
);

810  &
ei
->
vfs_öode
;

811 
	}
}

813 
	$Át_i_ˇŒback
(
rcu_hód
 *
hód
)

815 
öode
 *öodê
	`c⁄èöî_of
(
hód
, öode, 
i_rcu
);

816 
	`kmem_ˇche_‰ì
(
Át_öode_ˇchï
, 
	`MSDOS_I
(
öode
));

817 
	}
}

819 
	$Át_de°roy_öode
(
öode
 *inode)

821 
	`ˇŒ_rcu
(&
öode
->
i_rcu
, 
Át_i_ˇŒback
);

822 
	}
}

824 
	$öô_⁄˚
(*
foo
)

826 
msdos_öode_öfo
 *
ei
 = (msdos_öode_öfÿ*)
foo
;

828 
	`•ö_lock_öô
(&
ei
->
ˇche_Ãu_lock
);

829 
ei
->
ƒ_ˇches
 = 0;

830 
ei
->
ˇche_vÆid_id
 = 
FAT_CACHE_VALID
 + 1;

831 
	`INIT_LIST_HEAD
(&
ei
->
ˇche_Ãu
);

832 
	`INIT_HLIST_NODE
(&
ei
->
i_Át_hash
);

833 
	`INIT_HLIST_NODE
(&
ei
->
i_dú_hash
);

834 
	`öode_öô_⁄˚
(&
ei
->
vfs_öode
);

835 
	}
}

837 
__öô
 
	$Át_öô_öodeˇche
()

839 
Át_öode_ˇchï
 = 
	`kmem_ˇche_¸óã
("fat_inode_cache",

840 (
msdos_öode_öfo
),

841 0, (
SLAB_RECLAIM_ACCOUNT
|

842 
SLAB_MEM_SPREAD
),

843 
öô_⁄˚
);

844 i‡(
Át_öode_ˇchï
 =
NULL
)

845  -
ENOMEM
;

847 
	}
}

849 
__exô
 
	$Át_de°roy_öodeˇche
()

855 
	`rcu_b¨rõr
();

856 
	`kmem_ˇche_de°roy
(
Át_öode_ˇchï
);

857 
	}
}

859 
	$Át_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
)

861 
√w_rd⁄ly
;

862 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

863 *
Êags
 |
MS_NODIRATIME
 | (
sbi
->
›ti⁄s
.
isvÁt
 ? 0 : 
MS_NOATIME
);

866 
√w_rd⁄ly
 = *
Êags
 & 
MS_RDONLY
;

867 i‡(
√w_rd⁄ly
 !(
sb
->
s_Êags
 & 
MS_RDONLY
)) {

868 i‡(
√w_rd⁄ly
)

869 
	`Át_£t_°©e
(
sb
, 0, 0);

871 
	`Át_£t_°©e
(
sb
, 1, 1);

874 
	}
}

876 
	$Át_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
)

878 
su≥r_block
 *
sb
 = 
díåy
->
d_sb
;

879 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

880 
u64
 
id
 = 
	`huge_ícode_dev
(
sb
->
s_bdev
->
bd_dev
);

883 i‡(
sbi
->
‰ì_˛u°îs
 =-1 || !sbi->
‰ì_˛us_vÆid
) {

884 
îr
 = 
	`Át_cou¡_‰ì_˛u°îs
(
díåy
->
d_sb
);

885 i‡(
îr
)

886  
îr
;

889 
buf
->
f_ty≥
 = 
díåy
->
d_sb
->
s_magic
;

890 
buf
->
f_bsize
 = 
sbi
->
˛u°î_size
;

891 
buf
->
f_blocks
 = 
sbi
->
max_˛u°î
 - 
FAT_START_ENT
;

892 
buf
->
f_b‰ì
 = 
sbi
->
‰ì_˛u°îs
;

893 
buf
->
f_bavaû
 = 
sbi
->
‰ì_˛u°îs
;

894 
buf
->
f_fsid
.
vÆ
[0] = (
u32
)
id
;

895 
buf
->
f_fsid
.
vÆ
[1] = (
u32
)(
id
 >> 32);

896 
buf
->
f_«mñí
 =

897 (
sbi
->
›ti⁄s
.
isvÁt
 ? 
FAT_LFN_LEN
 : 12Ë* 
NLS_MAX_CHARSET_SIZE
;

900 
	}
}

902 
	$__Át_wrôe_öode
(
öode
 *öode, 
waô
)

904 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

905 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

906 
buf„r_hód
 *
bh
;

907 
msdos_dú_íåy
 *
øw_íåy
;

908 
loff_t
 
i_pos
;

909 
£˘‹_t
 
blockƒ
;

910 
îr
, 
off£t
;

912 i‡(
öode
->
i_öo
 =
MSDOS_ROOT_INO
)

915 
ªåy
:

916 
i_pos
 = 
	`Át_i_pos_ªad
(
sbi
, 
öode
);

917 i‡(!
i_pos
)

920 
	`Át_gë_blkƒ_off£t
(
sbi
, 
i_pos
, &
blockƒ
, &
off£t
);

921 
bh
 = 
	`sb_bªad
(
sb
, 
blockƒ
);

922 i‡(!
bh
) {

923 
	`Át_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead inode block "

924 "f‹ upd©ög (i_po†%Œd)", 
i_pos
);

925  -
EIO
;

927 
	`•ö_lock
(&
sbi
->
öode_hash_lock
);

928 i‡(
i_pos
 !
	`MSDOS_I
(
öode
)->i_pos) {

929 
	`•ö_u∆ock
(&
sbi
->
öode_hash_lock
);

930 
	`bªl£
(
bh
);

931 
ªåy
;

934 
øw_íåy
 = &((
msdos_dú_íåy
 *Ë(
bh
->
b_d©a
))[
off£t
];

935 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

936 
øw_íåy
->
size
 = 0;

938 
øw_íåy
->
size
 = 
	`˝u_to_À32
(
öode
->
i_size
);

939 
øw_íåy
->
©å
 = 
	`Át_make_©ås
(
öode
);

940 
	`Át_£t_°¨t
(
øw_íåy
, 
	`MSDOS_I
(
öode
)->
i_log°¨t
);

941 
	`Át_time_unix2Át
(
sbi
, &
öode
->
i_mtime
, &
øw_íåy
->
time
,

942 &
øw_íåy
->
d©e
, 
NULL
);

944 
öode
->
i_mtime
 = 
CURRENT_TIME_SEC_OPEL
;

946 i‡(
sbi
->
›ti⁄s
.
isvÁt
) {

947 
__À16
 
©ime
;

948 
	`Át_time_unix2Át
(
sbi
, &
öode
->
i_˘ime
, &
øw_íåy
->
˘ime
,

949 &
øw_íåy
->
cd©e
, &øw_íåy->
˘ime_cs
);

950 
	`Át_time_unix2Át
(
sbi
, &
öode
->
i_©ime
, &
©ime
,

951 &
øw_íåy
->
ad©e
, 
NULL
);

954 
öode
->
i_˘ime
 = inode->
i_©ime
 = 
CURRENT_TIME_SEC_OPEL
;

968 
	`¥ötk
("[cheon] __fat_write_inode \n");

969 
	`¥ötk
("öode->i_mtime.tv_£¯: %lu \n", 
öode
->
i_mtime
.
tv_£c
 );

970 
	`¥ötk
("öode->i_mtime.tv_n£¯: %ld \n", 
öode
->
i_mtime
.
tv_n£c
 );

977 
	`•ö_u∆ock
(&
sbi
->
öode_hash_lock
);

978 
	`m¨k_buf„r_dúty
(
bh
);

979 
îr
 = 0;

980 i‡(
waô
)

981 
îr
 = 
	`sync_dúty_buf„r
(
bh
);

982 
	`bªl£
(
bh
);

983  
îr
;

984 
	}
}

986 
	$Át_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
)

988 
îr
;

990 i‡(
öode
->
i_öo
 =
MSDOS_FSINFO_INO
) {

991 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

993 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

994 
îr
 = 
	`Át_˛u°îs_Êush
(
sb
);

995 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

997 
îr
 = 
	`__Át_wrôe_öode
(
öode
, 
wbc
->
sync_mode
 =
WB_SYNC_ALL
);

999  
îr
;

1000 
	}
}

1002 
	$Át_sync_öode
(
öode
 *inode)

1004 
	`¥ötk
–
KERN_ALERT
 "[cheon] fat_sync_inode \n");

1005  
	`__Át_wrôe_öode
(
öode
, 1);

1006 
	}
}

1008 
EXPORT_SYMBOL_GPL
(
Át_sync_öode
);

1010 
Át_show_›ti⁄s
(
£q_fûe
 *
m
, 
díåy
 *
roŸ
);

1011 c⁄° 
su≥r_›î©i⁄s
 
	gÁt_s›s
 = {

1012 .
Æloc_öode
 = 
Át_Æloc_öode
,

1013 .
	gde°roy_öode
 = 
Át_de°roy_öode
,

1014 .
	gwrôe_öode
 = 
Át_wrôe_öode
,

1015 .
	gevi˘_öode
 = 
Át_evi˘_öode
,

1016 .
	gput_su≥r
 = 
Át_put_su≥r
,

1017 .
	g°©fs
 = 
Át_°©fs
,

1018 .
	gªmou¡_fs
 = 
Át_ªmou¡
,

1020 .
	gshow_›ti⁄s
 = 
Át_show_›ti⁄s
,

1023 
	$Át_show_›ti⁄s
(
£q_fûe
 *
m
, 
díåy
 *
roŸ
)

1025 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
roŸ
->
d_sb
);

1026 
Át_mou¡_›ti⁄s
 *
›ts
 = &
sbi
->
›ti⁄s
;

1027 
isvÁt
 = 
›ts
->isvfat;

1029 i‡(!
	`uid_eq
(
›ts
->
fs_uid
, 
GLOBAL_ROOT_UID
))

1030 
	`£q_¥ötf
(
m
, ",uid=%u",

1031 
	`‰om_kuid_munged
(&
öô_u£r_ns
, 
›ts
->
fs_uid
));

1032 i‡(!
	`gid_eq
(
›ts
->
fs_gid
, 
GLOBAL_ROOT_GID
))

1033 
	`£q_¥ötf
(
m
, ",gid=%u",

1034 
	`‰om_kgid_munged
(&
öô_u£r_ns
, 
›ts
->
fs_gid
));

1035 
	`£q_¥ötf
(
m
, ",fmask=%04o", 
›ts
->
fs_fmask
);

1036 
	`£q_¥ötf
(
m
, ",dmask=%04o", 
›ts
->
fs_dmask
);

1037 i‡(
›ts
->
Ælow_utime
)

1038 
	`£q_¥ötf
(
m
, ",Ælow_utime=%04o", 
›ts
->
Ælow_utime
);

1039 i‡(
sbi
->
∆s_disk
)

1041 
	`£q_¥ötf
(
m
, ",codïage=%s", &
sbi
->
∆s_disk
->
ch¨£t
[2]);

1042 i‡(
isvÁt
) {

1043 i‡(
sbi
->
∆s_io
)

1044 
	`£q_¥ötf
(
m
, ",ioch¨£t=%s", 
sbi
->
∆s_io
->
ch¨£t
);

1046 
›ts
->
sh‹äame
) {

1047 
VFAT_SFN_DISPLAY_WIN95
 | 
VFAT_SFN_CREATE_WIN95
:

1048 
	`£q_puts
(
m
, ",shortname=win95");

1050 
VFAT_SFN_DISPLAY_WINNT
 | 
VFAT_SFN_CREATE_WINNT
:

1051 
	`£q_puts
(
m
, ",shortname=winnt");

1053 
VFAT_SFN_DISPLAY_WINNT
 | 
VFAT_SFN_CREATE_WIN95
:

1054 
	`£q_puts
(
m
, ",shortname=mixed");

1056 
VFAT_SFN_DISPLAY_LOWER
 | 
VFAT_SFN_CREATE_WIN95
:

1057 
	`£q_puts
(
m
, ",shortname=lower");

1060 
	`£q_puts
(
m
, ",shortname=unknown");

1064 i‡(
›ts
->
«me_check
 != 'n')

1065 
	`£q_¥ötf
(
m
, ",check=%c", 
›ts
->
«me_check
);

1066 i‡(
›ts
->
u£‰ì
)

1067 
	`£q_puts
(
m
, ",usefree");

1068 i‡(
›ts
->
quõt
)

1069 
	`£q_puts
(
m
, ",quiet");

1070 i‡(
›ts
->
showexec
)

1071 
	`£q_puts
(
m
, ",showexec");

1072 i‡(
›ts
->
sys_immuèbÀ
)

1073 
	`£q_puts
(
m
, ",sys_immutable");

1074 i‡(!
isvÁt
) {

1075 i‡(
›ts
->
dŸsOK
)

1076 
	`£q_puts
(
m
, ",dotsOK=yes");

1077 i‡(
›ts
->
noˇ£
)

1078 
	`£q_puts
(
m
, ",nocase");

1080 i‡(
›ts
->
utf8
)

1081 
	`£q_puts
(
m
, ",utf8");

1082 i‡(
›ts
->
unicode_xœã
)

1083 
	`£q_puts
(
m
, ",uni_xlate");

1084 i‡(!
›ts
->
numèû
)

1085 
	`£q_puts
(
m
, ",nonumtail");

1086 i‡(
›ts
->
rodú
)

1087 
	`£q_puts
(
m
, ",rodir");

1089 i‡(
›ts
->
Êush
)

1090 
	`£q_puts
(
m
, ",flush");

1091 i‡(
›ts
->
tz_£t
) {

1092 i‡(
›ts
->
time_off£t
)

1093 
	`£q_¥ötf
(
m
, ",time_off£t=%d", 
›ts
->
time_off£t
);

1095 
	`£q_puts
(
m
, ",tz=UTC");

1097 i‡(
›ts
->
îr‹s
 =
FAT_ERRORS_CONT
)

1098 
	`£q_puts
(
m
, ",errors=continue");

1099 i‡(
›ts
->
îr‹s
 =
FAT_ERRORS_PANIC
)

1100 
	`£q_puts
(
m
, ",errors=panic");

1102 
	`£q_puts
(
m
, ",errors=remount-ro");

1103 i‡(
›ts
->
nfs
 =
FAT_NFS_NOSTALE_RO
)

1104 
	`£q_puts
(
m
, ",nfs=nostale_ro");

1105 i‡(
›ts
->
nfs
)

1106 
	`£q_puts
(
m
, ",nfs=stale_rw");

1107 i‡(
›ts
->
disˇrd
)

1108 
	`£q_puts
(
m
, ",discard");

1111 
	}
}

1114 
	mO±_check_n
, 
	mO±_check_r
, 
	mO±_check_s
, 
	mO±_uid
, 
	mO±_gid
,

1115 
	mO±_umask
, 
	mO±_dmask
, 
	mO±_fmask
, 
	mO±_Ælow_utime
, 
	mO±_codïage
,

1116 
	mO±_u£‰ì
, 
	mO±_noˇ£
, 
	mO±_quõt
, 
	mO±_showexec
, 
	mO±_debug
,

1117 
	mO±_immuèbÀ
, 
	mO±_dŸs
, 
	mO±_nodŸs
,

1118 
	mO±_ch¨£t
, 
	mO±_sh‹äame_lowî
, 
	mO±_sh‹äame_wö95
,

1119 
	mO±_sh‹äame_wö¡
, 
	mO±_sh‹äame_mixed
, 
	mO±_utf8_no
, 
	mO±_utf8_yes
,

1120 
	mO±_uni_xl_no
, 
	mO±_uni_xl_yes
, 
	mO±_n⁄umèû_no
, 
	mO±_n⁄umèû_yes
,

1121 
	mO±_obsﬁëe
, 
	mO±_Êush
, 
	mO±_tz_utc
, 
	mO±_rodú
, 
	mO±_îr_c⁄t
,

1122 
	mO±_îr_∑nic
, 
	mO±_îr_ro
, 
	mO±_disˇrd
, 
	mO±_nfs
, 
	mO±_time_off£t
,

1123 
	mO±_nfs_°Æe_rw
, 
	mO±_nfs_no°Æe_ro
, 
	mO±_îr
,

1126 c⁄° 
m©ch_èbÀ_t
 
	gÁt_tokís
 = {

1127 {
O±_check_r
, "check=relaxed"},

1128 {
O±_check_s
, "check=strict"},

1129 {
O±_check_n
, "check=normal"},

1130 {
O±_check_r
, "check=r"},

1131 {
O±_check_s
, "check=s"},

1132 {
O±_check_n
, "check=n"},

1133 {
O±_uid
, "uid=%u"},

1134 {
O±_gid
, "gid=%u"},

1135 {
O±_umask
, "umask=%o"},

1136 {
O±_dmask
, "dmask=%o"},

1137 {
O±_fmask
, "fmask=%o"},

1138 {
O±_Ælow_utime
, "allow_utime=%o"},

1139 {
O±_codïage
, "codepage=%u"},

1140 {
O±_u£‰ì
, "usefree"},

1141 {
O±_noˇ£
, "nocase"},

1142 {
O±_quõt
, "quiet"},

1143 {
O±_showexec
, "showexec"},

1144 {
O±_debug
, "debug"},

1145 {
O±_immuèbÀ
, "sys_immutable"},

1146 {
O±_Êush
, "flush"},

1147 {
O±_tz_utc
, "tz=UTC"},

1148 {
O±_time_off£t
, "time_offset=%d"},

1149 {
O±_îr_c⁄t
, "errors=continue"},

1150 {
O±_îr_∑nic
, "errors=panic"},

1151 {
O±_îr_ro
, "errors=remount-ro"},

1152 {
O±_disˇrd
, "discard"},

1153 {
O±_nfs_°Æe_rw
, "nfs"},

1154 {
O±_nfs_°Æe_rw
, "nfs=stale_rw"},

1155 {
O±_nfs_no°Æe_ro
, "nfs=nostale_ro"},

1156 {
O±_obsﬁëe
, "conv=binary"},

1157 {
O±_obsﬁëe
, "conv=text"},

1158 {
O±_obsﬁëe
, "conv=auto"},

1159 {
O±_obsﬁëe
, "conv=b"},

1160 {
O±_obsﬁëe
, "conv=t"},

1161 {
O±_obsﬁëe
, "conv=a"},

1162 {
O±_obsﬁëe
, "fat=%u"},

1163 {
O±_obsﬁëe
, "blocksize=%u"},

1164 {
O±_obsﬁëe
, "cvf_format=%20s"},

1165 {
O±_obsﬁëe
, "cvf_options=%100s"},

1166 {
O±_obsﬁëe
, "posix"},

1167 {
O±_îr
, 
NULL
},

1169 c⁄° 
m©ch_èbÀ_t
 
	gmsdos_tokís
 = {

1170 {
O±_nodŸs
, "nodots"},

1171 {
O±_nodŸs
, "dotsOK=no"},

1172 {
O±_dŸs
, "dots"},

1173 {
O±_dŸs
, "dotsOK=yes"},

1174 {
O±_îr
, 
NULL
}

1176 c⁄° 
m©ch_èbÀ_t
 
	gvÁt_tokís
 = {

1177 {
O±_ch¨£t
, "iocharset=%s"},

1178 {
O±_sh‹äame_lowî
, "shortname=lower"},

1179 {
O±_sh‹äame_wö95
, "shortname=win95"},

1180 {
O±_sh‹äame_wö¡
, "shortname=winnt"},

1181 {
O±_sh‹äame_mixed
, "shortname=mixed"},

1182 {
O±_utf8_no
, "utf8=0"},

1183 {
O±_utf8_no
, "utf8=no"},

1184 {
O±_utf8_no
, "utf8=false"},

1185 {
O±_utf8_yes
, "utf8=1"},

1186 {
O±_utf8_yes
, "utf8=yes"},

1187 {
O±_utf8_yes
, "utf8=true"},

1188 {
O±_utf8_yes
, "utf8"},

1189 {
O±_uni_xl_no
, "uni_xlate=0"},

1190 {
O±_uni_xl_no
, "uni_xlate=no"},

1191 {
O±_uni_xl_no
, "uni_xlate=false"},

1192 {
O±_uni_xl_yes
, "uni_xlate=1"},

1193 {
O±_uni_xl_yes
, "uni_xlate=yes"},

1194 {
O±_uni_xl_yes
, "uni_xlate=true"},

1195 {
O±_uni_xl_yes
, "uni_xlate"},

1196 {
O±_n⁄umèû_no
, "nonumtail=0"},

1197 {
O±_n⁄umèû_no
, "nonumtail=no"},

1198 {
O±_n⁄umèû_no
, "nonumtail=false"},

1199 {
O±_n⁄umèû_yes
, "nonumtail=1"},

1200 {
O±_n⁄umèû_yes
, "nonumtail=yes"},

1201 {
O±_n⁄umèû_yes
, "nonumtail=true"},

1202 {
O±_n⁄umèû_yes
, "nonumtail"},

1203 {
O±_rodú
, "rodir"},

1204 {
O±_îr
, 
NULL
}

1207 
	$∑r£_›ti⁄s
(
su≥r_block
 *
sb
, *
›ti⁄s
, 
is_vÁt
,

1208 
sûít
, *
debug
, 
Át_mou¡_›ti⁄s
 *
›ts
)

1210 *
p
;

1211 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

1212 
›ti⁄
;

1213 *
ioch¨£t
;

1215 
›ts
->
isvÁt
 = 
is_vÁt
;

1217 
›ts
->
fs_uid
 = 
	`cuºít_uid
();

1218 
›ts
->
fs_gid
 = 
	`cuºít_gid
();

1219 
›ts
->
fs_fmask
 = o±s->
fs_dmask
 = 
	`cuºít_umask
();

1220 
›ts
->
Ælow_utime
 = -1;

1221 
›ts
->
codïage
 = 
Át_deÁu…_codïage
;

1222 
›ts
->
ioch¨£t
 = 
Át_deÁu…_ioch¨£t
;

1223 i‡(
is_vÁt
) {

1224 
›ts
->
sh‹äame
 = 
VFAT_SFN_DISPLAY_WINNT
|
VFAT_SFN_CREATE_WIN95
;

1225 
›ts
->
rodú
 = 0;

1227 
›ts
->
sh‹äame
 = 0;

1228 
›ts
->
rodú
 = 1;

1230 
›ts
->
«me_check
 = 'n';

1231 
›ts
->
quõt
 = o±s->
showexec
 = o±s->
sys_immuèbÀ
 = o±s->
dŸsOK
 = 0;

1232 
›ts
->
utf8
 = o±s->
unicode_xœã
 = 0;

1233 
›ts
->
numèû
 = 1;

1234 
›ts
->
u£‰ì
 = o±s->
noˇ£
 = 0;

1235 
›ts
->
tz_£t
 = 0;

1236 
›ts
->
nfs
 = 0;

1237 
›ts
->
îr‹s
 = 
FAT_ERRORS_RO
;

1238 *
debug
 = 0;

1240 i‡(!
›ti⁄s
)

1241 
out
;

1243 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

1244 
tokí
;

1245 i‡(!*
p
)

1248 
tokí
 = 
	`m©ch_tokí
(
p
, 
Át_tokís
, 
¨gs
);

1249 i‡(
tokí
 =
O±_îr
) {

1250 i‡(
is_vÁt
)

1251 
tokí
 = 
	`m©ch_tokí
(
p
, 
vÁt_tokís
, 
¨gs
);

1253 
tokí
 = 
	`m©ch_tokí
(
p
, 
msdos_tokís
, 
¨gs
);

1255 
tokí
) {

1256 
O±_check_s
:

1257 
›ts
->
«me_check
 = 's';

1259 
O±_check_r
:

1260 
›ts
->
«me_check
 = 'r';

1262 
O±_check_n
:

1263 
›ts
->
«me_check
 = 'n';

1265 
O±_u£‰ì
:

1266 
›ts
->
u£‰ì
 = 1;

1268 
O±_noˇ£
:

1269 i‡(!
is_vÁt
)

1270 
›ts
->
noˇ£
 = 1;

1273 
›ts
->
sh‹äame
 = 
VFAT_SFN_DISPLAY_WIN95


1274 | 
VFAT_SFN_CREATE_WIN95
;

1277 
O±_quõt
:

1278 
›ts
->
quõt
 = 1;

1280 
O±_showexec
:

1281 
›ts
->
showexec
 = 1;

1283 
O±_debug
:

1284 *
debug
 = 1;

1286 
O±_immuèbÀ
:

1287 
›ts
->
sys_immuèbÀ
 = 1;

1289 
O±_uid
:

1290 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

1291  -
EINVAL
;

1292 
›ts
->
fs_uid
 = 
	`make_kuid
(
	`cuºít_u£r_ns
(), 
›ti⁄
);

1293 i‡(!
	`uid_vÆid
(
›ts
->
fs_uid
))

1294  -
EINVAL
;

1296 
O±_gid
:

1297 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

1298  -
EINVAL
;

1299 
›ts
->
fs_gid
 = 
	`make_kgid
(
	`cuºít_u£r_ns
(), 
›ti⁄
);

1300 i‡(!
	`gid_vÆid
(
›ts
->
fs_gid
))

1301  -
EINVAL
;

1303 
O±_umask
:

1304 i‡(
	`m©ch_o˘Æ
(&
¨gs
[0], &
›ti⁄
))

1305  -
EINVAL
;

1306 
›ts
->
fs_fmask
 = o±s->
fs_dmask
 = 
›ti⁄
;

1308 
O±_dmask
:

1309 i‡(
	`m©ch_o˘Æ
(&
¨gs
[0], &
›ti⁄
))

1310  -
EINVAL
;

1311 
›ts
->
fs_dmask
 = 
›ti⁄
;

1313 
O±_fmask
:

1314 i‡(
	`m©ch_o˘Æ
(&
¨gs
[0], &
›ti⁄
))

1315  -
EINVAL
;

1316 
›ts
->
fs_fmask
 = 
›ti⁄
;

1318 
O±_Ælow_utime
:

1319 i‡(
	`m©ch_o˘Æ
(&
¨gs
[0], &
›ti⁄
))

1320  -
EINVAL
;

1321 
›ts
->
Ælow_utime
 = 
›ti⁄
 & (
S_IWGRP
 | 
S_IWOTH
);

1323 
O±_codïage
:

1324 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

1325  -
EINVAL
;

1326 
›ts
->
codïage
 = 
›ti⁄
;

1328 
O±_Êush
:

1329 
›ts
->
Êush
 = 1;

1331 
O±_time_off£t
:

1332 i‡(
	`m©ch_öt
(&
¨gs
[0], &
›ti⁄
))

1333  -
EINVAL
;

1334 i‡(
›ti⁄
 < -12 * 60 || option > 12 * 60)

1335  -
EINVAL
;

1336 
›ts
->
tz_£t
 = 1;

1337 
›ts
->
time_off£t
 = 
›ti⁄
;

1339 
O±_tz_utc
:

1340 
›ts
->
tz_£t
 = 1;

1341 
›ts
->
time_off£t
 = 0;

1343 
O±_îr_c⁄t
:

1344 
›ts
->
îr‹s
 = 
FAT_ERRORS_CONT
;

1346 
O±_îr_∑nic
:

1347 
›ts
->
îr‹s
 = 
FAT_ERRORS_PANIC
;

1349 
O±_îr_ro
:

1350 
›ts
->
îr‹s
 = 
FAT_ERRORS_RO
;

1352 
O±_nfs_°Æe_rw
:

1353 
›ts
->
nfs
 = 
FAT_NFS_STALE_RW
;

1355 
O±_nfs_no°Æe_ro
:

1356 
›ts
->
nfs
 = 
FAT_NFS_NOSTALE_RO
;

1360 
O±_dŸs
:

1361 
›ts
->
dŸsOK
 = 1;

1363 
O±_nodŸs
:

1364 
›ts
->
dŸsOK
 = 0;

1368 
O±_ch¨£t
:

1369 i‡(
›ts
->
ioch¨£t
 !
Át_deÁu…_ioch¨£t
)

1370 
	`k‰ì
(
›ts
->
ioch¨£t
);

1371 
ioch¨£t
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

1372 i‡(!
ioch¨£t
)

1373  -
ENOMEM
;

1374 
›ts
->
ioch¨£t
 = iocharset;

1376 
O±_sh‹äame_lowî
:

1377 
›ts
->
sh‹äame
 = 
VFAT_SFN_DISPLAY_LOWER


1378 | 
VFAT_SFN_CREATE_WIN95
;

1380 
O±_sh‹äame_wö95
:

1381 
›ts
->
sh‹äame
 = 
VFAT_SFN_DISPLAY_WIN95


1382 | 
VFAT_SFN_CREATE_WIN95
;

1384 
O±_sh‹äame_wö¡
:

1385 
›ts
->
sh‹äame
 = 
VFAT_SFN_DISPLAY_WINNT


1386 | 
VFAT_SFN_CREATE_WINNT
;

1388 
O±_sh‹äame_mixed
:

1389 
›ts
->
sh‹äame
 = 
VFAT_SFN_DISPLAY_WINNT


1390 | 
VFAT_SFN_CREATE_WIN95
;

1392 
O±_utf8_no
:

1393 
›ts
->
utf8
 = 0;

1395 
O±_utf8_yes
:

1396 
›ts
->
utf8
 = 1;

1398 
O±_uni_xl_no
:

1399 
›ts
->
unicode_xœã
 = 0;

1401 
O±_uni_xl_yes
:

1402 
›ts
->
unicode_xœã
 = 1;

1404 
O±_n⁄umèû_no
:

1405 
›ts
->
numèû
 = 1;

1407 
O±_n⁄umèû_yes
:

1408 
›ts
->
numèû
 = 0;

1410 
O±_rodú
:

1411 
›ts
->
rodú
 = 1;

1413 
O±_disˇrd
:

1414 
›ts
->
disˇrd
 = 1;

1418 
O±_obsﬁëe
:

1419 
	`Át_msg
(
sb
, 
KERN_INFO
, "\"%s\" option is obsolete, "

1420 "nŸ suµ‹ãdÇow", 
p
);

1424 i‡(!
sûít
) {

1425 
	`Át_msg
(
sb
, 
KERN_ERR
,

1427 "‹ missög vÆue", 
p
);

1429  -
EINVAL
;

1433 
out
:

1435 i‡(!
	`°rcmp
(
›ts
->
ioch¨£t
, "utf8")) {

1436 
	`Át_msg
(
sb
, 
KERN_WARNING
, "utf8 isÇotáÑecommended IO charset"

1442 i‡(
›ts
->
Ælow_utime
 == ()-1)

1443 
›ts
->
Ælow_utime
 = ~›ts->
fs_dmask
 & (
S_IWGRP
 | 
S_IWOTH
);

1444 i‡(
›ts
->
unicode_xœã
)

1445 
›ts
->
utf8
 = 0;

1446 i‡(
›ts
->
nfs
 =
FAT_NFS_NOSTALE_RO
) {

1447 
sb
->
s_Êags
 |
MS_RDONLY
;

1448 
sb
->
s_exp‹t_›
 = &
Át_exp‹t_›s_no°Æe
;

1452 
	}
}

1454 
	$Át_ªad_roŸ
(
öode
 *inode)

1456 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1457 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1458 
îr‹
;

1460 
	`MSDOS_I
(
öode
)->
i_pos
 = 
MSDOS_ROOT_INO
;

1461 
öode
->
i_uid
 = 
sbi
->
›ti⁄s
.
fs_uid
;

1462 
öode
->
i_gid
 = 
sbi
->
›ti⁄s
.
fs_gid
;

1463 
öode
->
i_vîsi⁄
++;

1464 
öode
->
i_gíî©i⁄
 = 0;

1465 
öode
->
i_mode
 = 
	`Át_make_mode
(
sbi
, 
ATTR_DIR
, 
S_IRWXUGO
);

1466 
öode
->
i_›
 = 
sbi
->
dú_›s
;

1467 
öode
->
i_f›
 = &
Át_dú_›î©i⁄s
;

1468 i‡(
sbi
->
Át_bôs
 == 32) {

1469 
	`MSDOS_I
(
öode
)->
i_°¨t
 = 
sbi
->
roŸ_˛u°î
;

1470 
îr‹
 = 
	`Át_ˇlc_dú_size
(
öode
);

1471 i‡(
îr‹
 < 0)

1472  
îr‹
;

1474 
	`MSDOS_I
(
öode
)->
i_°¨t
 = 0;

1475 
öode
->
i_size
 = 
sbi
->
dú_íåõs
 * (
msdos_dú_íåy
);

1477 
öode
->
i_blocks
 = ((öode->
i_size
 + (
sbi
->
˛u°î_size
 - 1))

1478 & ~((
loff_t
)
sbi
->
˛u°î_size
 - 1)) >> 9;

1479 
	`MSDOS_I
(
öode
)->
i_log°¨t
 = 0;

1480 
	`MSDOS_I
(
öode
)->
mmu_¥iv©e
 = inode->
i_size
;

1482 
	`Át_ßve_©ås
(
öode
, 
ATTR_DIR
);

1483 
öode
->
i_mtime
.
tv_£c
 = inode->
i_©ime
.tv_£¯öode->
i_˘ime
.tv_sec = 0;

1484 
öode
->
i_mtime
.
tv_n£c
 = inode->
i_©ime
.tv_n£¯öode->
i_˘ime
.tv_nsec = 0;

1485 
	`£t_∆ök
(
öode
, 
	`Át_subdús
(inode)+2);

1488 
	}
}

1490 
	$ˇlc_Át_˛u°îs
(
su≥r_block
 *
sb
)

1492 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1495 i‡(
sbi
->
Át_bôs
 != 12) {

1496 
ít_≥r_£c
 = 
sb
->
s_blocksize
 * 8 / 
sbi
->
Át_bôs
;

1497  
ít_≥r_£c
 * 
sbi
->
Át_Àngth
;

1500  
sbi
->
Át_Àngth
 * 
sb
->
s_blocksize
 * 8 / sbi->
Át_bôs
;

1501 
	}
}

1506 
Át_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
, 
isvÁt
,

1507 (*
£tup
)(
su≥r_block
 *))

1509 
öode
 *
roŸ_öode
 = 
NULL
, *
Át_öode
 = NULL;

1510 
öode
 *
fsöfo_öode
 = 
NULL
;

1511 
buf„r_hód
 *
bh
;

1512 
Át_boŸ_£˘‹
 *
b
;

1513 
msdos_sb_öfo
 *
sbi
;

1514 
u16
 
logiˇl_£˘‹_size
;

1515 
u32
 
tŸÆ_£˘‹s
, 
tŸÆ_˛u°îs
, 
Át_˛u°îs
, 
roŸdú_£˘‹s
;

1516 
debug
;

1517 
medü
;

1518 
îr‹
;

1519 
buf
[50];

1527 
sbi
 = 
	`kzÆloc
((
msdos_sb_öfo
), 
GFP_KERNEL
);

1528 i‡(!
sbi
)

1529  -
ENOMEM
;

1530 
sb
->
s_fs_öfo
 = 
sbi
;

1532 
sb
->
s_Êags
 |
MS_NODIRATIME
;

1533 
sb
->
s_magic
 = 
MSDOS_SUPER_MAGIC
;

1534 
sb
->
s_›
 = &
Át_s›s
;

1535 
sb
->
s_exp‹t_›
 = &
Át_exp‹t_›s
;

1536 
	`muãx_öô
(&
sbi
->
nfs_buûd_öode_lock
);

1537 
	`øãlimô_°©e_öô
(&
sbi
->
øãlimô
, 
DEFAULT_RATELIMIT_INTERVAL
,

1538 
DEFAULT_RATELIMIT_BURST
);

1540 
îr‹
 = 
	`∑r£_›ti⁄s
(
sb
, 
d©a
, 
isvÁt
, 
sûít
, &
debug
, &
sbi
->
›ti⁄s
);

1541 i‡(
îr‹
)

1542 
out_Áû
;

1544 
	`£tup
(
sb
);

1546 
îr‹
 = -
EIO
;

1547 
	`sb_mö_blocksize
(
sb
, 512);

1549 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sb->blocksizê: %u\n", 
sb
->
s_blocksize
);

1552 
bh
 = 
	`sb_bªad
(
sb
, 0);

1553 i‡(
bh
 =
NULL
) {

1554 
	`Át_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead boot sector");

1555 
out_Áû
;

1558 
b
 = (
Át_boŸ_£˘‹
 *Ë
bh
->
b_d©a
;

1559 i‡(!
b
->
ª£rved
) {

1560 i‡(!
sûít
)

1561 
	`Át_msg
(
sb
, 
KERN_ERR
, "bogusÇumber ofÑeserved sectors");

1562 
	`bªl£
(
bh
);

1563 
out_övÆid
;

1565 i‡(!
b
->
Áts
) {

1566 i‡(!
sûít
)

1567 
	`Át_msg
(
sb
, 
KERN_ERR
, "bogusÇumber of FAT structure");

1568 
	`bªl£
(
bh
);

1569 
out_övÆid
;

1577 
medü
 = 
b
->media;

1578 i‡(!
	`Át_vÆid_medü
(
medü
)) {

1579 i‡(!
sûít
)

1580 
	`Át_msg
(
sb
, 
KERN_ERR
, "invalid media value (0x%02x)",

1581 
medü
);

1582 
	`bªl£
(
bh
);

1583 
out_övÆid
;

1585 
logiˇl_£˘‹_size
 = 
	`gë_u«lig√d_À16
(&
b
->
£˘‹_size
);

1586 
	`¥ötk
–
KERN_ALERT
 "[che⁄]Üogiˇl_£˘‹_sizê: %u\n", 
logiˇl_£˘‹_size
 );

1588 i‡(!
	`is_powî_of_2
(
logiˇl_£˘‹_size
)

1589 || (
logiˇl_£˘‹_size
 < 512)

1590 || (
logiˇl_£˘‹_size
 > 4096)) {

1591 i‡(!
sûít
)

1592 
	`Át_msg
(
sb
, 
KERN_ERR
, "bogusÜogical sector size %u",

1593 
logiˇl_£˘‹_size
);

1594 
	`bªl£
(
bh
);

1595 
out_övÆid
;

1597 
sbi
->
£c_≥r_˛us
 = 
b
->sec_per_clus;

1599 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sec_≥r_˛u†: %u \n", 
sbi
->
£c_≥r_˛us
 );

1601 i‡(!
	`is_powî_of_2
(
sbi
->
£c_≥r_˛us
)) {

1602 i‡(!
sûít
)

1603 
	`Át_msg
(
sb
, 
KERN_ERR
, "bogus sectorsÖer cluster %u",

1604 
sbi
->
£c_≥r_˛us
);

1605 
	`bªl£
(
bh
);

1606 
out_övÆid
;

1610 i‡(
logiˇl_£˘‹_size
 < 
sb
->
s_blocksize
) {

1611 
	`Át_msg
(
sb
, 
KERN_ERR
, "logical sector sizeÅoo small for device"

1612 " (logiˇ»£˘‹ sizê%u)", 
logiˇl_£˘‹_size
);

1613 
	`bªl£
(
bh
);

1614 
out_Áû
;

1616 i‡(
logiˇl_£˘‹_size
 > 
sb
->
s_blocksize
) {

1617 
	`bªl£
(
bh
);

1619 i‡(!
	`sb_£t_blocksize
(
sb
, 
logiˇl_£˘‹_size
)) {

1620 
	`Át_msg
(
sb
, 
KERN_ERR
, "unableÅo set blocksize %u",

1621 
logiˇl_£˘‹_size
);

1622 
out_Áû
;

1624 
bh
 = 
	`sb_bªad
(
sb
, 0);

1625 i‡(
bh
 =
NULL
) {

1626 
	`Át_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead boot sector"

1628 
sb
->
s_blocksize
);

1629 
out_Áû
;

1631 
b
 = (
Át_boŸ_£˘‹
 *Ë
bh
->
b_d©a
;

1634 
	`muãx_öô
(&
sbi
->
s_lock
);

1635 
sbi
->
˛u°î_size
 = 
sb
->
s_blocksize
 * sbi->
£c_≥r_˛us
;

1636 
sbi
->
˛u°î_bôs
 = 
	`ffs
(sbi->
˛u°î_size
) - 1;

1637 
sbi
->
Áts
 = 
b
->fats;

1638 
sbi
->
Át_bôs
 = 0;

1639 
sbi
->
Át_°¨t
 = 
	`À16_to_˝u
(
b
->
ª£rved
);

1640 
sbi
->
Át_Àngth
 = 
	`À16_to_˝u
(
b
->fat_length);

1641 
sbi
->
roŸ_˛u°î
 = 0;

1642 
sbi
->
‰ì_˛u°îs
 = -1;

1643 
sbi
->
‰ì_˛us_vÆid
 = 0;

1644 
sbi
->
¥ev_‰ì
 = 
FAT_START_ENT
;

1645 
sb
->
s_maxbyãs
 = 0xffffffff;

1647 i‡(!
sbi
->
Át_Àngth
 && 
b
->
Át32
.
Àngth
) {

1648 
Át_boŸ_fsöfo
 *
fsöfo
;

1649 
buf„r_hód
 *
fsöfo_bh
;

1652 
sbi
->
Át_bôs
 = 32;

1653 
sbi
->
Át_Àngth
 = 
	`À32_to_˝u
(
b
->
Át32
.
Àngth
);

1654 
sbi
->
roŸ_˛u°î
 = 
	`À32_to_˝u
(
b
->
Át32
.root_cluster);

1657 
sbi
->
fsöfo_£˘‹
 = 
	`À16_to_˝u
(
b
->
Át32
.
öfo_£˘‹
);

1658 i‡(
sbi
->
fsöfo_£˘‹
 == 0)

1659 
sbi
->
fsöfo_£˘‹
 = 1;

1661 
fsöfo_bh
 = 
	`sb_bªad
(
sb
, 
sbi
->
fsöfo_£˘‹
);

1662 i‡(
fsöfo_bh
 =
NULL
) {

1663 
	`Át_msg
(
sb
, 
KERN_ERR
, "bread failed, FSINFO block"

1664 " (£˘‹ = %lu)", 
sbi
->
fsöfo_£˘‹
);

1665 
	`bªl£
(
bh
);

1666 
out_Áû
;

1669 
fsöfo
 = (
Át_boŸ_fsöfo
 *)
fsöfo_bh
->
b_d©a
;

1670 i‡(!
	`IS_FSINFO
(
fsöfo
)) {

1671 
	`Át_msg
(
sb
, 
KERN_WARNING
, "Invalid FSINFO signature: "

1673 
	`À32_to_˝u
(
fsöfo
->
sig«tuª1
),

1674 
	`À32_to_˝u
(
fsöfo
->
sig«tuª2
),

1675 
sbi
->
fsöfo_£˘‹
);

1677 i‡(
sbi
->
›ti⁄s
.
u£‰ì
)

1678 
sbi
->
‰ì_˛us_vÆid
 = 1;

1679 
sbi
->
‰ì_˛u°îs
 = 
	`À32_to_˝u
(
fsöfo
->free_clusters);

1680 
sbi
->
¥ev_‰ì
 = 
	`À32_to_˝u
(
fsöfo
->
√xt_˛u°î
);

1683 
	`bªl£
(
fsöfo_bh
);

1686 
sbi
->
dú_≥r_block
 = 
sb
->
s_blocksize
 / (
msdos_dú_íåy
);

1687 
sbi
->
dú_≥r_block_bôs
 = 
	`ffs
(sbi->
dú_≥r_block
) - 1;

1689 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sb->s_blocksizê: %u \n", 
sb
->
s_blocksize
 );

1690 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->˛u°î_sizêsb->s_blocksizê* sbi->£c_≥r_˛u†: %u\n", 
sbi
->
˛u°î_size
 );

1691 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->Át†“umbî o‡ÁtË: %u \n", 
sbi
->
Áts
 );

1692 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->Át_Àngth : %u \n", 
sbi
->
Át_Àngth
 );

1693 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->Át_°¨à: %u \n", 
sbi
->
Át_°¨t
 );

1695 
sbi
->
dú_°¨t
 = sbi->
Át_°¨t
 + sbi->
Áts
 * sbi->
Át_Àngth
;

1696 
sbi
->
dú_íåõs
 = 
	`gë_u«lig√d_À16
(&
b
->dir_entries);

1698 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->dú_°¨à : %u \n", 
sbi
->
dú_°¨t
 );

1699 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->dú_íåõ† : %u \n", 
sbi
->
dú_íåõs
 );

1701 i‡(
sbi
->
dú_íåõs
 & (sbi->
dú_≥r_block
 - 1)) {

1702 i‡(!
sûít
)

1703 
	`Át_msg
(
sb
, 
KERN_ERR
, "bogus directory-entriesÖer block"

1704 " (%u)", 
sbi
->
dú_íåõs
);

1705 
	`bªl£
(
bh
);

1706 
out_övÆid
;

1709 
roŸdú_£˘‹s
 = 
sbi
->
dú_íåõs


1710 * (
msdos_dú_íåy
Ë/ 
sb
->
s_blocksize
;

1711 
sbi
->
d©a_°¨t
 = sbi->
dú_°¨t
 + 
roŸdú_£˘‹s
;

1713 
	`¥ötk
–
KERN_ALERT
 "[che⁄] sbi->d©a_°¨à : %u \n", 
sbi
->
d©a_°¨t
 );

1715 
tŸÆ_£˘‹s
 = 
	`gë_u«lig√d_À16
(&
b
->
£˘‹s
);

1716 i‡(
tŸÆ_£˘‹s
 == 0)

1717 
tŸÆ_£˘‹s
 = 
	`À32_to_˝u
(
b
->
tŸÆ_£˘
);

1719 
tŸÆ_˛u°îs
 = (
tŸÆ_£˘‹s
 - 
sbi
->
d©a_°¨t
Ë/ sbi->
£c_≥r_˛us
;

1721 
	`¥ötk
–
KERN_ALERT
 "[che⁄]ÅŸÆ_˛u°î†—ŸÆ_£˘‹†- sbi->d©a_°¨tË/ sbi->£c_≥r_˛u† : %u \n", 
tŸÆ_˛u°îs
 );

1723 i‡(
sbi
->
Át_bôs
 != 32)

1724 
sbi
->
Át_bôs
 = (
tŸÆ_˛u°îs
 > 
MAX_FAT12
) ? 16 : 12;

1727 i‡(
sbi
->
Át_bôs
 == 32)

1728 
sbi
->
dúty
 = 
b
->
Át32
.
°©e
 & 
FAT_STATE_DIRTY
;

1730 
sbi
->
dúty
 = 
b
->
Át16
.
°©e
 & 
FAT_STATE_DIRTY
;

1733 
Át_˛u°îs
 = 
	`ˇlc_Át_˛u°îs
(
sb
);

1734 
tŸÆ_˛u°îs
 = 
	`mö
—ŸÆ_˛u°îs, 
Át_˛u°îs
 - 
FAT_START_ENT
);

1736 
	`¥ötk
–
KERN_ALERT
 "[che⁄] f©_˛u°î†ˇlc_Át_˛u°îs(sb): %u \n", 
Át_˛u°îs
 );

1737 
	`¥ötk
–
KERN_ALERT
 "[che⁄]ÅŸÆ_˛u°î†: mö—ŸÆ_˛u°îs, f©_˛u°î†- FAT_START_ENTË: %u \n", 
tŸÆ_˛u°îs
 );

1739 i‡(
tŸÆ_˛u°îs
 > 
	`MAX_FAT
(
sb
)) {

1740 i‡(!
sûít
)

1741 
	`Át_msg
(
sb
, 
KERN_ERR
, "count of clustersÅoo big (%u)",

1742 
tŸÆ_˛u°îs
);

1743 
	`bªl£
(
bh
);

1744 
out_övÆid
;

1747 
sbi
->
max_˛u°î
 = 
tŸÆ_˛u°îs
 + 
FAT_START_ENT
;

1749 i‡(
sbi
->
‰ì_˛u°îs
 !-1 && sbi->‰ì_˛u°î†> 
tŸÆ_˛u°îs
)

1750 
sbi
->
‰ì_˛u°îs
 = -1;

1752 
sbi
->
¥ev_‰ì
 %sbi->
max_˛u°î
;

1753 i‡(
sbi
->
¥ev_‰ì
 < 
FAT_START_ENT
)

1754 
sbi
->
¥ev_‰ì
 = 
FAT_START_ENT
;

1756 
	`bªl£
(
bh
);

1759 
	`Át_hash_öô
(
sb
);

1760 
	`dú_hash_öô
(
sb
);

1761 
	`Át_ít_ac˚ss_öô
(
sb
);

1771 
îr‹
 = -
EINVAL
;

1772 
	`•rötf
(
buf
, "˝%d", 
sbi
->
›ti⁄s
.
codïage
);

1773 
sbi
->
∆s_disk
 = 
	`lﬂd_∆s
(
buf
);

1774 i‡(!
sbi
->
∆s_disk
) {

1775 
	`Át_msg
(
sb
, 
KERN_ERR
, "codïagê%†nŸ found", 
buf
);

1776 
out_Áû
;

1780 i‡(
sbi
->
›ti⁄s
.
isvÁt
) {

1781 
sbi
->
∆s_io
 = 
	`lﬂd_∆s
(sbi->
›ti⁄s
.
ioch¨£t
);

1782 i‡(!
sbi
->
∆s_io
) {

1783 
	`Át_msg
(
sb
, 
KERN_ERR
, "IO charset %sÇot found",

1784 
sbi
->
›ti⁄s
.
ioch¨£t
);

1785 
out_Áû
;

1789 
îr‹
 = -
ENOMEM
;

1790 
Át_öode
 = 
	`√w_öode
(
sb
);

1791 i‡(!
Át_öode
)

1792 
out_Áû
;

1793 
	`MSDOS_I
(
Át_öode
)->
i_pos
 = 0;

1794 
sbi
->
Át_öode
 = fat_inode;

1796 
fsöfo_öode
 = 
	`√w_öode
(
sb
);

1797 i‡(!
fsöfo_öode
)

1798 
out_Áû
;

1799 
fsöfo_öode
->
i_öo
 = 
MSDOS_FSINFO_INO
;

1800 
sbi
->
fsöfo_öode
 = fsinfo_inode;

1801 
	`ö£π_öode_hash
(
fsöfo_öode
);

1803 
roŸ_öode
 = 
	`√w_öode
(
sb
);

1804 i‡(!
roŸ_öode
)

1805 
out_Áû
;

1806 
roŸ_öode
->
i_öo
 = 
MSDOS_ROOT_INO
;

1807 
roŸ_öode
->
i_vîsi⁄
 = 1;

1808 
îr‹
 = 
	`Át_ªad_roŸ
(
roŸ_öode
);

1809 i‡(
îr‹
 < 0) {

1810 
	`ùut
(
roŸ_öode
);

1811 
out_Áû
;

1813 
îr‹
 = -
ENOMEM
;

1814 
	`ö£π_öode_hash
(
roŸ_öode
);

1815 
	`Át_©èch
(
roŸ_öode
, 0);

1816 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
roŸ_öode
);

1817 i‡(!
sb
->
s_roŸ
) {

1818 
	`Át_msg
(
sb
, 
KERN_ERR
, "getÑoot inode failed");

1819 
out_Áû
;

1822 i‡(
sbi
->
›ti⁄s
.
disˇrd
) {

1823 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

1824 i‡(!
	`blk_queue_disˇrd
(
q
))

1825 
	`Át_msg
(
sb
, 
KERN_WARNING
,

1830 
	`Át_£t_°©e
(
sb
, 1, 0);

1833 
out_övÆid
:

1834 
îr‹
 = -
EINVAL
;

1835 i‡(!
sûít
)

1836 
	`Át_msg
(
sb
, 
KERN_INFO
, "Can't findá valid FAT filesystem");

1838 
out_Áû
:

1839 i‡(
fsöfo_öode
)

1840 
	`ùut
(
fsöfo_öode
);

1841 i‡(
Át_öode
)

1842 
	`ùut
(
Át_öode
);

1843 
	`u∆ﬂd_∆s
(
sbi
->
∆s_io
);

1844 
	`u∆ﬂd_∆s
(
sbi
->
∆s_disk
);

1845 i‡(
sbi
->
›ti⁄s
.
ioch¨£t
 !
Át_deÁu…_ioch¨£t
)

1846 
	`k‰ì
(
sbi
->
›ti⁄s
.
ioch¨£t
);

1847 
sb
->
s_fs_öfo
 = 
NULL
;

1848 
	`k‰ì
(
sbi
);

1849  
îr‹
;

1850 
	}
}

1852 
EXPORT_SYMBOL_GPL
(
Át_fûl_su≥r
);

1860 
	$wrôeback_öode
(
öode
 *inode)

1863 
ªt
;

1869 
ªt
 = 
	`sync_öode_mëad©a
(
öode
, 0);

1870 i‡(!
ªt
)

1871 
ªt
 = 
	`fûem≠_fd©awrôe
(
öode
->
i_m≠pög
);

1872  
ªt
;

1873 
	}
}

1883 
	$Át_Êush_öodes
(
su≥r_block
 *
sb
, 
öode
 *
i1
, öodê*
i2
)

1885 
ªt
 = 0;

1886 i‡(!
	`MSDOS_SB
(
sb
)->
›ti⁄s
.
Êush
)

1888 i‡(
i1
)

1889 
ªt
 = 
	`wrôeback_öode
(
i1
);

1890 i‡(!
ªt
 && 
i2
)

1891 
ªt
 = 
	`wrôeback_öode
(
i2
);

1892 i‡(!
ªt
) {

1893 
addªss_•a˚
 *
m≠pög
 = 
sb
->
s_bdev
->
bd_öode
->
i_m≠pög
;

1894 
ªt
 = 
	`fûem≠_Êush
(
m≠pög
);

1896  
ªt
;

1897 
	}
}

1898 
EXPORT_SYMBOL_GPL
(
Át_Êush_öodes
);

1900 
__öô
 
	$öô_Át_fs
()

1902 
îr
;

1904 
îr
 = 
	`Át_ˇche_öô
();

1905 i‡(
îr
)

1906  
îr
;

1908 
îr
 = 
	`Át_öô_öodeˇche
();

1909 i‡(
îr
)

1910 
Áûed
;

1914 
Áûed
:

1915 
	`Át_ˇche_de°roy
();

1916  
îr
;

1917 
	}
}

1919 
__exô
 
	$exô_Át_fs
()

1921 
	`Át_ˇche_de°roy
();

1922 
	`Át_de°roy_öodeˇche
();

1923 
	}
}

1925 
	$moduÀ_öô
(
öô_Át_fs
)

1926 
	$moduÀ_exô
(
exô_Át_fs
)

1928 
	`MODULE_LICENSE
("GPL");

	@misc.c

9 
	~<löux/moduÀ.h
>

10 
	~<löux/fs.h
>

11 
	~<löux/buf„r_hód.h
>

12 
	~<löux/time.h
>

13 
	~"Át.h
"

23 
	$__Át_fs_îr‹
(
su≥r_block
 *
sb
, 
ªp‹t
, c⁄° *
fmt
, ...)

25 
Át_mou¡_›ti⁄s
 *
›ts
 = &
	`MSDOS_SB
(
sb
)->
›ti⁄s
;

26 
va_li°
 
¨gs
;

27 
va_f‹m©
 
vaf
;

29 i‡(
ªp‹t
) {

30 
	`va_°¨t
(
¨gs
, 
fmt
);

31 
vaf
.
fmt
 = fmt;

32 
vaf
.
va
 = &
¨gs
;

33 
	`¥ötk
(
KERN_ERR
 "FAT-f†(%s):Éº‹, %pV\n", 
sb
->
s_id
, &
vaf
);

34 
	`va_íd
(
¨gs
);

37 i‡(
›ts
->
îr‹s
 =
FAT_ERRORS_PANIC
)

38 
	`∑nic
("FAT-f†(%s): f†∑ni¯‰omÖªviou†îr‹\n", 
sb
->
s_id
);

39 i‡(
›ts
->
îr‹s
 =
FAT_ERRORS_RO
 && !(
sb
->
s_Êags
 & 
MS_RDONLY
)) {

40 
sb
->
s_Êags
 |
MS_RDONLY
;

41 
	`¥ötk
(
KERN_ERR
 "FAT-fs (%s): Filesystem has been "

42 "£àªad-⁄ly\n", 
sb
->
s_id
);

44 
	}
}

45 
EXPORT_SYMBOL_GPL
(
__Át_fs_îr‹
);

51 
	$Át_msg
(
su≥r_block
 *
sb
, c⁄° *
Àvñ
, c⁄° *
fmt
, ...)

53 
va_f‹m©
 
vaf
;

54 
va_li°
 
¨gs
;

56 
	`va_°¨t
(
¨gs
, 
fmt
);

57 
vaf
.
fmt
 = fmt;

58 
vaf
.
va
 = &
¨gs
;

59 
	`¥ötk
("%sFAT-f†(%s): %pV\n", 
Àvñ
, 
sb
->
s_id
, &
vaf
);

60 
	`va_íd
(
¨gs
);

61 
	}
}

65 
	$Át_˛u°îs_Êush
(
su≥r_block
 *
sb
)

67 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

68 
buf„r_hód
 *
bh
;

69 
Át_boŸ_fsöfo
 *
fsöfo
;

71 i‡(
sbi
->
Át_bôs
 != 32)

74 
bh
 = 
	`sb_bªad
(
sb
, 
sbi
->
fsöfo_£˘‹
);

75 i‡(
bh
 =
NULL
) {

76 
	`Át_msg
(
sb
, 
KERN_ERR
, "bread failed in fat_clusters_flush");

77  -
EIO
;

80 
fsöfo
 = (
Át_boŸ_fsöfo
 *)
bh
->
b_d©a
;

82 i‡(!
	`IS_FSINFO
(
fsöfo
)) {

83 
	`Át_msg
(
sb
, 
KERN_ERR
, "Invalid FSINFO signature: "

85 
	`À32_to_˝u
(
fsöfo
->
sig«tuª1
),

86 
	`À32_to_˝u
(
fsöfo
->
sig«tuª2
),

87 
sbi
->
fsöfo_£˘‹
);

89 i‡(
sbi
->
‰ì_˛u°îs
 != -1)

90 
fsöfo
->
‰ì_˛u°îs
 = 
	`˝u_to_À32
(
sbi
->free_clusters);

91 i‡(
sbi
->
¥ev_‰ì
 != -1)

92 
fsöfo
->
√xt_˛u°î
 = 
	`˝u_to_À32
(
sbi
->
¥ev_‰ì
);

93 
	`m¨k_buf„r_dúty
(
bh
);

95 
	`bªl£
(
bh
);

98 
	}
}

104 
	$Át_chaö_add
(
öode
 *öode, 
√w_d˛us
, 
ƒ_˛u°î
)

106 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

107 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

108 
ªt
, 
√w_f˛us
, 
œ°
;

114 
œ°
 = 
√w_f˛us
 = 0;

115 i‡(
	`MSDOS_I
(
öode
)->
i_°¨t
) {

116 
f˛us
, 
d˛us
;

118 
ªt
 = 
	`Át_gë_˛u°î
(
öode
, 
FAT_ENT_EOF
, &
f˛us
, &
d˛us
);

119 i‡(
ªt
 < 0)

120  
ªt
;

121 
√w_f˛us
 = 
f˛us
 + 1;

122 
œ°
 = 
d˛us
;

126 i‡(
œ°
) {

127 
Át_íåy
 
Áã¡
;

129 
	`Áã¡_öô
(&
Áã¡
);

130 
ªt
 = 
	`Át_ít_ªad
(
öode
, &
Áã¡
, 
œ°
);

131 i‡(
ªt
 >= 0) {

132 
waô
 = 
	`öode_√eds_sync
(
öode
);

133 
ªt
 = 
	`Át_ít_wrôe
(
öode
, &
Áã¡
, 
√w_d˛us
, 
waô
);

134 
	`Áã¡_bªl£
(&
Áã¡
);

136 i‡(
ªt
 < 0)

137  
ªt
;

144 
	`MSDOS_I
(
öode
)->
i_°¨t
 = 
√w_d˛us
;

145 
	`MSDOS_I
(
öode
)->
i_log°¨t
 = 
√w_d˛us
;

150 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë&& 
	`IS_DIRSYNC
(inode)) {

151 
ªt
 = 
	`Át_sync_öode
(
öode
);

152 i‡(
ªt
)

153  
ªt
;

155 
	`m¨k_öode_dúty
(
öode
);

157 i‡(
√w_f˛us
 !(
öode
->
i_blocks
 >> (
sbi
->
˛u°î_bôs
 - 9))) {

158 
	`Át_fs_îr‹
(
sb
, "clusters badly computed (%d != %llu)",

159 
√w_f˛us
,

160 (
Œu
)(
öode
->
i_blocks
 >> (
sbi
->
˛u°î_bôs
 - 9)));

161 
	`Át_ˇche_övÆ_öode
(
öode
);

163 
öode
->
i_blocks
 +
ƒ_˛u°î
 << (
sbi
->
˛u°î_bôs
 - 9);

166 
	}
}

168 
timez⁄e
 
sys_tz
;

180 
	#SECS_PER_MIN
 60

	)

181 
	#SECS_PER_HOUR
 (60 * 60)

	)

182 
	#SECS_PER_DAY
 (
SECS_PER_HOUR
 * 24)

	)

184 
	#DAYS_DELTA
 (365 * 10 + 2)

	)

186 
	#YEAR_2100
 120

	)

187 
	#IS_LEAP_YEAR
(
y
Ë(!((yË& 3Ë&& (yË!
YEAR_2100
)

	)

190 
time_t
 
	gdays_ö_yór
[] = {

196 
	$Át_time_Át2unix
(
msdos_sb_öfo
 *
sbi
, 
time•ec
 *
ts
,

197 
__À16
 
__time
, __À16 
__d©e
, 
u8
 
time_cs
)

199 
u16
 
time
 = 
	`À16_to_˝u
(
__time
), 
d©e
 =Üe16_to_˝u(
__d©e
);

200 
time_t
 
£c⁄d
, 
day
, 
À≠_day
, 
m⁄th
, 
yór
;

206 
yór
 = 
d©e
 >> 9;

207 
m⁄th
 = 
	`max
(1, (
d©e
 >> 5) & 0xf);

208 
day
 = 
	`max
(1, 
d©e
 & 0x1f) - 1;

210 
À≠_day
 = (
yór
 + 3) / 4;

211 i‡(
yór
 > 
YEAR_2100
)

212 
À≠_day
--;

213 i‡(
	`IS_LEAP_YEAR
(
yór
Ë&& 
m⁄th
 > 2)

214 
À≠_day
++;

216 
£c⁄d
 = (
time
 & 0x1f) << 1;

217 
£c⁄d
 +((
time
 >> 5Ë& 0x3fË* 
SECS_PER_MIN
;

218 
£c⁄d
 +(
time
 >> 11Ë* 
SECS_PER_HOUR
;

219 
£c⁄d
 +(
yór
 * 365 + 
À≠_day


220 + 
days_ö_yór
[
m⁄th
] + 
day


221 + 
DAYS_DELTA
Ë* 
SECS_PER_DAY
;

223 i‡(!
sbi
->
›ti⁄s
.
tz_£t
)

224 
£c⁄d
 +
sys_tz
.
tz_möuãswe°
 * 
SECS_PER_MIN
;

226 
£c⁄d
 -
sbi
->
›ti⁄s
.
time_off£t
 * 
SECS_PER_MIN
;

228 i‡(
time_cs
) {

229 
ts
->
tv_£c
 = 
£c⁄d
 + (
time_cs
 / 100);

230 
ts
->
tv_n£c
 = (
time_cs
 % 100) * 10000000;

239 
ts
->
tv_£c
 = 
£c⁄d
;

240 
ts
->
tv_n£c
 = 0;

251 
	}
}

254 
	$Át_time_unix2Át
(
msdos_sb_öfo
 *
sbi
, 
time•ec
 *
ts
,

255 
__À16
 *
time
, __À16 *
d©e
, 
u8
 *
time_cs
)

257 
tm
Åm;

258 
	`time_to_tm
(
ts
->
tv_£c
,

259 (
sbi
->
›ti⁄s
.
tz_£t
 ? sbi->›ti⁄s.
time_off£t
 :

260 -
sys_tz
.
tz_möuãswe°
Ë* 
SECS_PER_MIN
, &
tm
);

263 i‡(
tm
.
tm_yór
 < 1980 - 1900) {

264 *
time
 = 0;

265 *
d©e
 = 
	`˝u_to_À16
((0 << 9) | (1 << 5) | 1);

266 i‡(
time_cs
)

267 *
time_cs
 = 0;

270 i‡(
tm
.
tm_yór
 > 2107 - 1900) {

271 *
time
 = 
	`˝u_to_À16
((23 << 11) | (59 << 5) | 29);

272 *
d©e
 = 
	`˝u_to_À16
((127 << 9) | (12 << 5) | 31);

273 i‡(
time_cs
)

274 *
time_cs
 = 199;

279 
tm
.
tm_yór
 -= 80;

281 
tm
.
tm_m⁄
++;

283 
tm
.
tm_£c
 >>= 1;

285 *
time
 = 
	`˝u_to_À16
(
tm
.
tm_hour
 << 11 |Åm.
tm_mö
 << 5 |Åm.
tm_£c
);

286 *
d©e
 = 
	`˝u_to_À16
(
tm
.
tm_yór
 << 9 |Åm.
tm_m⁄
 << 5 |Åm.
tm_mday
);

287 i‡(
time_cs
)

289 *
time_cs
 = (
ts
->
tv_£c
 & 1Ë* 100 +Ås->
tv_n£c
 / 10000000;

295 
	}
}

296 
EXPORT_SYMBOL_GPL
(
Át_time_unix2Át
);

298 
	$Át_sync_bhs
(
buf„r_hód
 **
bhs
, 
ƒ_bhs
)

300 
i
, 
îr
 = 0;

302 
i
 = 0; i < 
ƒ_bhs
; i++)

303 
	`wrôe_dúty_buf„r
(
bhs
[
i
], 
WRITE
);

305 
i
 = 0; i < 
ƒ_bhs
; i++) {

306 
	`waô_⁄_buf„r
(
bhs
[
i
]);

307 i‡(!
îr
 && !
	`buf„r_u±od©e
(
bhs
[
i
]))

308 
îr
 = -
EIO
;

310  
îr
;

311 
	}
}

	@namei_msdos.c

9 
	~<löux/moduÀ.h
>

10 
	~<löux/time.h
>

11 
	~<löux/buf„r_hód.h
>

12 
	~"Át.h
"

15 
	gbad_ch¨s
[] = "*?<>|\"";

16 
	gbad_if_°ri˘
[] = "+=,; ";

19 
	$msdos_f‹m©_«me
(c⁄° *
«me
, 
Àn
,

20 *
ªs
, 
Át_mou¡_›ti⁄s
 *
›ts
)

28 *
wÆk
;

29 
c
;

30 
•a˚
;

32 i‡(
«me
[0] == '.') {

33 i‡(
›ts
->
dŸsOK
) {

35 
«me
++;

36 
Àn
--;

38  -
EINVAL
;

43 
•a˚
 = 1;

44 
c
 = 0;

45 
wÆk
 = 
ªs
; 
Àn
 && walk -Ñes < 8; walk++) {

46 
c
 = *
«me
++;

47 
Àn
--;

48 i‡(
›ts
->
«me_check
 !'r' && 
	`°rchr
(
bad_ch¨s
, 
c
))

49  -
EINVAL
;

50 i‡(
›ts
->
«me_check
 ='s' && 
	`°rchr
(
bad_if_°ri˘
, 
c
))

51  -
EINVAL
;

52 i‡(
c
 >'A' && c <'Z' && 
›ts
->
«me_check
 == 's')

53  -
EINVAL
;

54 i‡(
c
 < ' ' || c == ':' || c == '\\')

55  -
EINVAL
;

64 i‡((
ªs
 =
wÆk
Ë&& (
c
 == 0xE5))

65 
c
 = 0x05;

66 i‡(
c
 == '.')

68 
•a˚
 = (
c
 == ' ');

69 *
wÆk
 = (!
›ts
->
noˇ£
 && 
c
 >= 'a' && c <= 'z') ? c - 32 : c;

71 i‡(
•a˚
)

72  -
EINVAL
;

73 i‡(
›ts
->
«me_check
 ='s' && 
Àn
 && 
c
 != '.') {

74 
c
 = *
«me
++;

75 
Àn
--;

76 i‡(
c
 != '.')

77  -
EINVAL
;

79 
c
 !'.' && 
Àn
--)

80 
c
 = *
«me
++;

81 i‡(
c
 == '.') {

82 
wÆk
 - 
ªs
 < 8)

83 *
wÆk
++ = ' ';

84 
Àn
 > 0 && 
wÆk
 - 
ªs
 < 
MSDOS_NAME
) {

85 
c
 = *
«me
++;

86 
Àn
--;

87 i‡(
›ts
->
«me_check
 !'r' && 
	`°rchr
(
bad_ch¨s
, 
c
))

88  -
EINVAL
;

89 i‡(
›ts
->
«me_check
 == 's' &&

90 
	`°rchr
(
bad_if_°ri˘
, 
c
))

91  -
EINVAL
;

92 i‡(
c
 < ' ' || c == ':' || c == '\\')

93  -
EINVAL
;

94 i‡(
c
 == '.') {

95 i‡(
›ts
->
«me_check
 == 's')

96  -
EINVAL
;

99 i‡(
c
 >'A' && c <'Z' && 
›ts
->
«me_check
 == 's')

100  -
EINVAL
;

101 
•a˚
 = 
c
 == ' ';

102 i‡(!
›ts
->
noˇ£
 && 
c
 >= 'a' && c <= 'z')

103 *
wÆk
++ = 
c
 - 32;

105 *
wÆk
++ = 
c
;

107 i‡(
•a˚
)

108  -
EINVAL
;

109 i‡(
›ts
->
«me_check
 ='s' && 
Àn
)

110  -
EINVAL
;

112 
wÆk
 - 
ªs
 < 
MSDOS_NAME
)

113 *
wÆk
++ = ' ';

116 
	}
}

119 
	$msdos_föd
(
öode
 *
dú
, c⁄° *
«me
, 
Àn
,

120 
Át_¶Ÿ_öfo
 *
söfo
)

122 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
dú
->
i_sb
);

123 
msdos_«me
[
MSDOS_NAME
];

124 
îr
;

126 
îr
 = 
	`msdos_f‹m©_«me
(
«me
, 
Àn
, 
msdos_«me
, &
sbi
->
›ti⁄s
);

127 i‡(
îr
)

128  -
ENOENT
;

130 
îr
 = 
	`Át_sˇn
(
dú
, 
msdos_«me
, 
söfo
);

131 i‡(!
îr
 && 
sbi
->
›ti⁄s
.
dŸsOK
) {

132 i‡(
«me
[0] == '.') {

133 i‡(!(
söfo
->
de
->
©å
 & 
ATTR_HIDDEN
))

134 
îr
 = -
ENOENT
;

136 i‡(
söfo
->
de
->
©å
 & 
ATTR_HIDDEN
)

137 
îr
 = -
ENOENT
;

139 i‡(
îr
)

140 
	`bªl£
(
söfo
->
bh
);

142  
îr
;

143 
	}
}

151 
	$msdos_hash
(c⁄° 
díåy
 *díåy, c⁄° 
öode
 *inode,

152 
q°r
 *qstr)

154 
Át_mou¡_›ti⁄s
 *
›ti⁄s
 = &
	`MSDOS_SB
(
díåy
->
d_sb
)->options;

155 
msdos_«me
[
MSDOS_NAME
];

156 
îr‹
;

158 
îr‹
 = 
	`msdos_f‹m©_«me
(
q°r
->
«me
, q°r->
Àn
, 
msdos_«me
, 
›ti⁄s
);

159 i‡(!
îr‹
)

160 
q°r
->
hash
 = 
	`fuŒ_«me_hash
(
msdos_«me
, 
MSDOS_NAME
);

162 
	}
}

168 
	$msdos_cmp
(c⁄° 
díåy
 *
∑ª¡
, c⁄° 
öode
 *
pöode
,

169 c⁄° 
díåy
 *díåy, c⁄° 
öode
 *inode,

170 
Àn
, c⁄° *
°r
, c⁄° 
q°r
 *
«me
)

172 
Át_mou¡_›ti⁄s
 *
›ti⁄s
 = &
	`MSDOS_SB
(
∑ª¡
->
d_sb
)->options;

173 
a_msdos_«me
[
MSDOS_NAME
], 
b_msdos_«me
[MSDOS_NAME];

174 
îr‹
;

176 
îr‹
 = 
	`msdos_f‹m©_«me
(
«me
->«me,Çame->
Àn
, 
a_msdos_«me
, 
›ti⁄s
);

177 i‡(
îr‹
)

178 
ﬁd_com∑ª
;

179 
îr‹
 = 
	`msdos_f‹m©_«me
(
°r
, 
Àn
, 
b_msdos_«me
, 
›ti⁄s
);

180 i‡(
îr‹
)

181 
ﬁd_com∑ª
;

182 
îr‹
 = 
	`memcmp
(
a_msdos_«me
, 
b_msdos_«me
, 
MSDOS_NAME
);

183 
out
:

184  
îr‹
;

186 
ﬁd_com∑ª
:

187 
îr‹
 = 1;

188 i‡(
«me
->
Àn
 ==Üen)

189 
îr‹
 = 
	`memcmp
(
«me
->«me, 
°r
, 
Àn
);

190 
out
;

191 
	}
}

193 c⁄° 
díåy_›î©i⁄s
 
	gmsdos_díåy_›î©i⁄s
 = {

194 .
d_hash
 = 
msdos_hash
,

195 .
	gd_com∑ª
 = 
msdos_cmp
,

203 
díåy
 *
	$msdos_lookup
(
öode
 *
dú
, 
díåy
 *dentry,

204 
Êags
)

206 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

207 
Át_¶Ÿ_öfo
 
söfo
;

208 
öode
 *inode;

209 
îr
;

211 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

212 
îr
 = 
	`msdos_föd
(
dú
, 
díåy
->
d_«me
.
«me
, díåy->d_«me.
Àn
, &
söfo
);

213 
îr
) {

214 -
ENOENT
:

215 
öode
 = 
NULL
;

218 
öode
 = 
	`Át_buûd_öode
(
sb
, 
söfo
.
de
, söfo.
i_pos
);

219 
	`bªl£
(
söfo
.
bh
);

222 
öode
 = 
	`ERR_PTR
(
îr
);

224 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

225  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

226 
	}
}

229 
	$msdos_add_íåy
(
öode
 *
dú
, c⁄° *
«me
,

230 
is_dú
, 
is_hid
, 
˛u°î
,

231 
time•ec
 *
ts
, 
Át_¶Ÿ_öfo
 *
söfo
)

233 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
dú
->
i_sb
);

234 
msdos_dú_íåy
 
de
;

235 
__À16
 
time
, 
d©e
;

236 
îr
;

238 
	`mem˝y
(
de
.
«me
,Çame, 
MSDOS_NAME
);

239 
de
.
©å
 = 
is_dú
 ? 
ATTR_DIR
 : 
ATTR_ARCH
;

240 i‡(
is_hid
)

241 
de
.
©å
 |
ATTR_HIDDEN
;

242 
de
.
lˇ£
 = 0;

243 
	`Át_time_unix2Át
(
sbi
, 
ts
, &
time
, &
d©e
, 
NULL
);

244 
de
.
cd©e
 = de.
ad©e
 = 0;

245 
de
.
˘ime
 = 0;

246 
de
.
˘ime_cs
 = 0;

247 
de
.
time
 =Åime;

248 
de
.
d©e
 = date;

249 
	`Át_£t_°¨t
(&
de
, 
˛u°î
);

250 
de
.
size
 = 0;

252 
îr
 = 
	`Át_add_íåõs
(
dú
, &
de
, 1, 
söfo
);

253 i‡(
îr
)

254  
îr
;

256 
dú
->
i_˘ime
 = dú->
i_mtime
 = *
ts
;

257 i‡(
	`IS_DIRSYNC
(
dú
))

258 ()
	`Át_sync_öode
(
dú
);

260 
	`m¨k_öode_dúty
(
dú
);

263 
	}
}

266 
	$msdos_¸óã
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
,

267 
boﬁ
 
ex˛
)

269 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

270 
öode
 *öodê
NULL
;

271 
Át_¶Ÿ_öfo
 
söfo
;

272 
time•ec
 
ts
;

273 
msdos_«me
[
MSDOS_NAME
];

274 
îr
, 
is_hid
;

276 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

278 
îr
 = 
	`msdos_f‹m©_«me
(
díåy
->
d_«me
.
«me
, díåy->d_«me.
Àn
,

279 
msdos_«me
, &
	`MSDOS_SB
(
sb
)->
›ti⁄s
);

280 i‡(
îr
)

281 
out
;

282 
is_hid
 = (
díåy
->
d_«me
.
«me
[0] ='.'Ë&& (
msdos_«me
[0] != '.');

284 i‡(!
	`Át_sˇn
(
dú
, 
msdos_«me
, &
söfo
)) {

285 
	`bªl£
(
söfo
.
bh
);

286 
îr
 = -
EINVAL
;

287 
out
;

291 
ts
 = 
CURRENT_TIME_SEC_OPEL
;

292 
îr
 = 
	`msdos_add_íåy
(
dú
, 
msdos_«me
, 0, 
is_hid
, 0, &
ts
, &
söfo
);

293 i‡(
îr
)

294 
out
;

295 
öode
 = 
	`Át_buûd_öode
(
sb
, 
söfo
.
de
, söfo.
i_pos
);

296 
	`bªl£
(
söfo
.
bh
);

297 i‡(
	`IS_ERR
(
öode
)) {

298 
îr
 = 
	`PTR_ERR
(
öode
);

299 
out
;

301 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
ts
;

304 
	`d_ö°™tüã
(
díåy
, 
öode
);

305 
out
:

306 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

307 i‡(!
îr
)

308 
îr
 = 
	`Át_Êush_öodes
(
sb
, 
dú
, 
öode
);

309  
îr
;

310 
	}
}

313 
	$msdos_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

315 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

316 
öode
 *öodê
díåy
->
d_öode
;

317 
Át_¶Ÿ_öfo
 
söfo
;

318 
îr
;

320 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

325 
îr
 = 
	`Át_dú_em±y
(
öode
);

326 i‡(
îr
)

327 
out
;

328 
îr
 = 
	`msdos_föd
(
dú
, 
díåy
->
d_«me
.
«me
, díåy->d_«me.
Àn
, &
söfo
);

329 i‡(
îr
)

330 
out
;

332 
	`¥ötk
–
KERN_ALERT
 "[cheon] msdos_rmdir \n" );

333 
îr
 = 
	`Át_ªmove_íåõs
(
dú
, &
söfo
);

334 i‡(
îr
)

335 
out
;

336 
	`dr›_∆ök
(
dú
);

338 
	`˛ór_∆ök
(
öode
);

340 
öode
->
i_˘ime
 = 
CURRENT_TIME_SEC_OPEL
;

341 
	`Át_dëach
(
öode
);

342 
out
:

343 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

344 i‡(!
îr
)

345 
îr
 = 
	`Át_Êush_öodes
(
sb
, 
dú
, 
öode
);

347  
îr
;

348 
	}
}

351 
	$msdos_mkdú
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

353 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

354 
Át_¶Ÿ_öfo
 
söfo
;

355 
öode
 *inode;

356 
msdos_«me
[
MSDOS_NAME
];

357 
time•ec
 
ts
;

358 
îr
, 
is_hid
, 
˛u°î
;

360 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

362 
îr
 = 
	`msdos_f‹m©_«me
(
díåy
->
d_«me
.
«me
, díåy->d_«me.
Àn
,

363 
msdos_«me
, &
	`MSDOS_SB
(
sb
)->
›ti⁄s
);

364 i‡(
îr
)

365 
out
;

366 
is_hid
 = (
díåy
->
d_«me
.
«me
[0] ='.'Ë&& (
msdos_«me
[0] != '.');

368 i‡(!
	`Át_sˇn
(
dú
, 
msdos_«me
, &
söfo
)) {

369 
	`bªl£
(
söfo
.
bh
);

370 
îr
 = -
EINVAL
;

371 
out
;

374 
ts
 = 
CURRENT_TIME_SEC_OPEL
;

376 
˛u°î
 = 
	`Át_Æloc_√w_dú
(
dú
, &
ts
);

377 i‡(
˛u°î
 < 0) {

378 
îr
 = 
˛u°î
;

379 
out
;

381 
îr
 = 
	`msdos_add_íåy
(
dú
, 
msdos_«me
, 1, 
is_hid
, 
˛u°î
, &
ts
, &
söfo
);

382 i‡(
îr
)

383 
out_‰ì
;

384 
	`öc_∆ök
(
dú
);

386 
öode
 = 
	`Át_buûd_öode
(
sb
, 
söfo
.
de
, söfo.
i_pos
);

387 
	`bªl£
(
söfo
.
bh
);

388 i‡(
	`IS_ERR
(
öode
)) {

389 
îr
 = 
	`PTR_ERR
(
öode
);

391 
out
;

393 
	`£t_∆ök
(
öode
, 2);

394 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
ts
;

397 
	`d_ö°™tüã
(
díåy
, 
öode
);

399 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

400 
	`Át_Êush_öodes
(
sb
, 
dú
, 
öode
);

403 
out_‰ì
:

404 
	`¥ötk
–
KERN_ALERT
 "[cheon] msdos_mkdir, fat_free_clusters \n" );

405 
	`Át_‰ì_˛u°îs
(
dú
, 
˛u°î
);

406 
out
:

407 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

408  
îr
;

409 
	}
}

412 
	$msdos_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

414 
öode
 *öodê
díåy
->
d_öode
;

415 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

416 
Át_¶Ÿ_öfo
 
söfo
;

417 
îr
;

419 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

420 
îr
 = 
	`msdos_föd
(
dú
, 
díåy
->
d_«me
.
«me
, díåy->d_«me.
Àn
, &
söfo
);

421 i‡(
îr
)

422 
out
;

424 
	`¥ötk
–
KERN_ALERT
 "[cheon] msdos_unlink \n" );

425 
îr
 = 
	`Át_ªmove_íåõs
(
dú
, &
söfo
);

426 i‡(
îr
)

427 
out
;

428 
	`˛ór_∆ök
(
öode
);

429 
öode
->
i_˘ime
 = 
CURRENT_TIME_SEC_OPEL
;

431 
	`Át_dëach
(
öode
);

432 
out
:

433 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

434 i‡(!
îr
)

435 
îr
 = 
	`Át_Êush_öodes
(
sb
, 
dú
, 
öode
);

437  
îr
;

438 
	}
}

440 
	$do_msdos_ª«me
(
öode
 *
ﬁd_dú
, *
ﬁd_«me
,

441 
díåy
 *
ﬁd_díåy
,

442 
öode
 *
√w_dú
, *
√w_«me
,

443 
díåy
 *
√w_díåy
, 
is_hid
)

445 
buf„r_hód
 *
dŸdŸ_bh
;

446 
msdos_dú_íåy
 *
dŸdŸ_de
;

447 
öode
 *
ﬁd_öode
, *
√w_öode
;

448 
Át_¶Ÿ_öfo
 
ﬁd_söfo
, 
söfo
;

449 
time•ec
 
ts
;

450 
loff_t
 
√w_i_pos
;

451 
îr
, 
ﬁd_©ås
, 
is_dú
, 
upd©e_dŸdŸ
, 
c‹ru±
 = 0;

453 
ﬁd_söfo
.
bh
 = 
söfo
.bh = 
dŸdŸ_bh
 = 
NULL
;

454 
ﬁd_öode
 = 
ﬁd_díåy
->
d_öode
;

455 
√w_öode
 = 
√w_díåy
->
d_öode
;

457 
îr
 = 
	`Át_sˇn
(
ﬁd_dú
, 
ﬁd_«me
, &
ﬁd_söfo
);

458 i‡(
îr
) {

459 
îr
 = -
EIO
;

460 
out
;

463 
is_dú
 = 
	`S_ISDIR
(
ﬁd_öode
->
i_mode
);

464 
upd©e_dŸdŸ
 = (
is_dú
 && 
ﬁd_dú
 !
√w_dú
);

465 i‡(
upd©e_dŸdŸ
) {

466 i‡(
	`Át_gë_dŸdŸ_íåy
(
ﬁd_öode
, &
dŸdŸ_bh
, &
dŸdŸ_de
)) {

467 
îr
 = -
EIO
;

468 
out
;

472 
ﬁd_©ås
 = 
	`MSDOS_I
(
ﬁd_öode
)->
i_©ås
;

473 
îr
 = 
	`Át_sˇn
(
√w_dú
, 
√w_«me
, &
söfo
);

474 i‡(!
îr
) {

475 i‡(!
√w_öode
) {

477 i‡(
söfo
.
de
 !
ﬁd_söfo
.de) {

478 
îr
 = -
EINVAL
;

479 
out
;

481 i‡(
is_hid
)

482 
	`MSDOS_I
(
ﬁd_öode
)->
i_©ås
 |
ATTR_HIDDEN
;

484 
	`MSDOS_I
(
ﬁd_öode
)->
i_©ås
 &~
ATTR_HIDDEN
;

485 i‡(
	`IS_DIRSYNC
(
ﬁd_dú
)) {

486 
îr
 = 
	`Át_sync_öode
(
ﬁd_öode
);

487 i‡(
îr
) {

488 
	`MSDOS_I
(
ﬁd_öode
)->
i_©ås
 = 
ﬁd_©ås
;

489 
out
;

492 
	`m¨k_öode_dúty
(
ﬁd_öode
);

494 
ﬁd_dú
->
i_vîsi⁄
++;

495 
ﬁd_dú
->
i_˘ime
 = old_dú->
i_mtime
 = 
CURRENT_TIME_SEC_OPEL
;

497 i‡(
	`IS_DIRSYNC
(
ﬁd_dú
))

498 ()
	`Át_sync_öode
(
ﬁd_dú
);

500 
	`m¨k_öode_dúty
(
ﬁd_dú
);

501 
out
;

506 
ts
 = 
CURRENT_TIME_SEC_OPEL
;

507 i‡(
√w_öode
) {

508 i‡(
îr
)

509 
out
;

510 i‡(
is_dú
) {

511 
îr
 = 
	`Át_dú_em±y
(
√w_öode
);

512 i‡(
îr
)

513 
out
;

515 
√w_i_pos
 = 
	`MSDOS_I
(
√w_öode
)->
i_pos
;

516 
	`Át_dëach
(
√w_öode
);

518 
îr
 = 
	`msdos_add_íåy
(
√w_dú
, 
√w_«me
, 
is_dú
, 
is_hid
, 0,

519 &
ts
, &
söfo
);

520 i‡(
îr
)

521 
out
;

522 
√w_i_pos
 = 
söfo
.
i_pos
;

524 
√w_dú
->
i_vîsi⁄
++;

526 
	`Át_dëach
(
ﬁd_öode
);

527 
	`Át_©èch
(
ﬁd_öode
, 
√w_i_pos
);

528 i‡(
is_hid
)

529 
	`MSDOS_I
(
ﬁd_öode
)->
i_©ås
 |
ATTR_HIDDEN
;

531 
	`MSDOS_I
(
ﬁd_öode
)->
i_©ås
 &~
ATTR_HIDDEN
;

532 i‡(
	`IS_DIRSYNC
(
√w_dú
)) {

533 
îr
 = 
	`Át_sync_öode
(
ﬁd_öode
);

534 i‡(
îr
)

535 
îr‹_öode
;

537 
	`m¨k_öode_dúty
(
ﬁd_öode
);

539 i‡(
upd©e_dŸdŸ
) {

540 
	`Át_£t_°¨t
(
dŸdŸ_de
, 
	`MSDOS_I
(
√w_dú
)->
i_log°¨t
);

541 
	`m¨k_buf„r_dúty_öode
(
dŸdŸ_bh
, 
ﬁd_öode
);

542 i‡(
	`IS_DIRSYNC
(
√w_dú
)) {

543 
îr
 = 
	`sync_dúty_buf„r
(
dŸdŸ_bh
);

544 i‡(
îr
)

545 
îr‹_dŸdŸ
;

547 
	`dr›_∆ök
(
ﬁd_dú
);

548 i‡(!
√w_öode
)

549 
	`öc_∆ök
(
√w_dú
);

552 
	`¥ötk
–
KERN_ALERT
 "[cheon] do_msdos_rename \n");

553 
îr
 = 
	`Át_ªmove_íåõs
(
ﬁd_dú
, &
ﬁd_söfo
);

554 
ﬁd_söfo
.
bh
 = 
NULL
;

555 i‡(
îr
)

556 
îr‹_dŸdŸ
;

557 
ﬁd_dú
->
i_vîsi⁄
++;

558 
ﬁd_dú
->
i_˘ime
 = old_dú->
i_mtime
 = 
ts
;

559 i‡(
	`IS_DIRSYNC
(
ﬁd_dú
))

560 ()
	`Át_sync_öode
(
ﬁd_dú
);

562 
	`m¨k_öode_dúty
(
ﬁd_dú
);

564 i‡(
√w_öode
) {

565 
	`dr›_∆ök
(
√w_öode
);

566 i‡(
is_dú
)

567 
	`dr›_∆ök
(
√w_öode
);

568 
√w_öode
->
i_˘ime
 = 
ts
;

570 
out
:

571 
	`bªl£
(
söfo
.
bh
);

572 
	`bªl£
(
dŸdŸ_bh
);

573 
	`bªl£
(
ﬁd_söfo
.
bh
);

574  
îr
;

576 
îr‹_dŸdŸ
:

578 
c‹ru±
 = 1;

580 i‡(
upd©e_dŸdŸ
) {

581 
	`Át_£t_°¨t
(
dŸdŸ_de
, 
	`MSDOS_I
(
ﬁd_dú
)->
i_log°¨t
);

582 
	`m¨k_buf„r_dúty_öode
(
dŸdŸ_bh
, 
ﬁd_öode
);

583 
c‹ru±
 |
	`sync_dúty_buf„r
(
dŸdŸ_bh
);

585 
îr‹_öode
:

586 
	`Át_dëach
(
ﬁd_öode
);

587 
	`Át_©èch
(
ﬁd_öode
, 
ﬁd_söfo
.
i_pos
);

588 
	`MSDOS_I
(
ﬁd_öode
)->
i_©ås
 = 
ﬁd_©ås
;

589 i‡(
√w_öode
) {

590 
	`Át_©èch
(
√w_öode
, 
√w_i_pos
);

591 i‡(
c‹ru±
)

592 
c‹ru±
 |
	`Át_sync_öode
(
√w_öode
);

599 
	`¥ötk
–
KERN_ALERT
 "[cheon] do_msdos_rename,Érr_inode \n");

600 
îr2
 = 
	`Át_ªmove_íåõs
(
√w_dú
, &
söfo
);

601 i‡(
c‹ru±
)

602 
c‹ru±
 |
îr2
;

603 
söfo
.
bh
 = 
NULL
;

605 i‡(
c‹ru±
 < 0) {

606 
	`Át_fs_îr‹
(
√w_dú
->
i_sb
,

608 
__func__
, 
söfo
.
i_pos
);

610 
out
;

611 
	}
}

614 
	$msdos_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

615 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
)

617 
su≥r_block
 *
sb
 = 
ﬁd_dú
->
i_sb
;

618 
ﬁd_msdos_«me
[
MSDOS_NAME
], 
√w_msdos_«me
[MSDOS_NAME];

619 
îr
, 
is_hid
;

621 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

623 
îr
 = 
	`msdos_f‹m©_«me
(
ﬁd_díåy
->
d_«me
.
«me
,

624 
ﬁd_díåy
->
d_«me
.
Àn
, 
ﬁd_msdos_«me
,

625 &
	`MSDOS_SB
(
ﬁd_dú
->
i_sb
)->
›ti⁄s
);

626 i‡(
îr
)

627 
out
;

628 
îr
 = 
	`msdos_f‹m©_«me
(
√w_díåy
->
d_«me
.
«me
,

629 
√w_díåy
->
d_«me
.
Àn
, 
√w_msdos_«me
,

630 &
	`MSDOS_SB
(
√w_dú
->
i_sb
)->
›ti⁄s
);

631 i‡(
îr
)

632 
out
;

634 
is_hid
 =

635 (
√w_díåy
->
d_«me
.
«me
[0] ='.'Ë&& (
√w_msdos_«me
[0] != '.');

637 
îr
 = 
	`do_msdos_ª«me
(
ﬁd_dú
, 
ﬁd_msdos_«me
, 
ﬁd_díåy
,

638 
√w_dú
, 
√w_msdos_«me
, 
√w_díåy
, 
is_hid
);

639 
out
:

640 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

641 i‡(!
îr
)

642 
îr
 = 
	`Át_Êush_öodes
(
sb
, 
ﬁd_dú
, 
√w_dú
);

643  
îr
;

644 
	}
}

646 c⁄° 
öode_›î©i⁄s
 
	gmsdos_dú_öode_›î©i⁄s
 = {

647 .
¸óã
 = 
msdos_¸óã
,

648 .
	glookup
 = 
msdos_lookup
,

649 .
	gu∆ök
 = 
msdos_u∆ök
,

650 .
	gmkdú
 = 
msdos_mkdú
,

651 .
	grmdú
 = 
msdos_rmdú
,

652 .
	gª«me
 = 
msdos_ª«me
,

653 .
	g£èâr
 = 
Át_£èâr
,

654 .
	ggë©å
 = 
Át_gë©å
,

657 
	$£tup
(
su≥r_block
 *
sb
)

659 
	`MSDOS_SB
(
sb
)->
dú_›s
 = &
msdos_dú_öode_›î©i⁄s
;

660 
sb
->
s_d_›
 = &
msdos_díåy_›î©i⁄s
;

661 
sb
->
s_Êags
 |
MS_NOATIME
;

662 
	}
}

664 
	$msdos_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

666  
	`Át_fûl_su≥r
(
sb
, 
d©a
, 
sûít
, 0, 
£tup
);

667 
	}
}

669 
díåy
 *
	$msdos_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
,

670 
Êags
, c⁄° *
dev_«me
,

671 *
d©a
)

673  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
msdos_fûl_su≥r
);

674 
	}
}

676 
fûe_sy°em_ty≥
 
	gmsdos_fs_ty≥
 = {

677 .
ow√r
 = 
THIS_MODULE
,

678 .
	g«me
 = "msdos",

679 .
	gmou¡
 = 
msdos_mou¡
,

680 .
	gkûl_sb
 = 
kûl_block_su≥r
,

681 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

683 
MODULE_ALIAS_FS
("msdos");

685 
__öô
 
	$öô_msdos_fs
()

687  
	`ªgi°î_fûesy°em
(&
msdos_fs_ty≥
);

688 
	}
}

690 
__exô
 
	$exô_msdos_fs
()

692 
	`uƒegi°î_fûesy°em
(&
msdos_fs_ty≥
);

693 
	}
}

695 
MODULE_LICENSE
("GPL");

696 
MODULE_AUTHOR
("Werner Almesberger");

697 
MODULE_DESCRIPTION
("MS-DOS filesystem support");

699 
	$moduÀ_öô
(
öô_msdos_fs
)

700 
	`moduÀ_exô
(
exô_msdos_fs
)

	@namei_vfat.c

18 
	~<löux/kî√l.h
>

22 
	~<löux/moduÀ.h
>

23 
	~<löux/jiffõs.h
>

24 
	~<löux/˘y≥.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/buf„r_hód.h
>

27 
	~<löux/«mei.h
>

28 
	~"Át.h
"

39 
	$vÁt_ªvÆid©e_sh‹äame
(
díåy
 *dentry)

41 
ªt
 = 1;

42 
	`•ö_lock
(&
díåy
->
d_lock
);

43 i‡(
díåy
->
d_time
 !díåy->
d_∑ª¡
->
d_öode
->
i_vîsi⁄
)

44 
ªt
 = 0;

45 
	`•ö_u∆ock
(&
díåy
->
d_lock
);

46  
ªt
;

47 
	}
}

49 
	$vÁt_ªvÆid©e
(
díåy
 *díåy, 
Êags
)

51 i‡(
Êags
 & 
LOOKUP_RCU
)

52  -
ECHILD
;

55 i‡(
díåy
->
d_öode
)

57  
	`vÁt_ªvÆid©e_sh‹äame
(
díåy
);

58 
	}
}

60 
	$vÁt_ªvÆid©e_ci
(
díåy
 *díåy, 
Êags
)

62 i‡(
Êags
 & 
LOOKUP_RCU
)

63  -
ECHILD
;

75 i‡(
díåy
->
d_öode
)

82 i‡(!
Êags
)

90 i‡(
Êags
 & (
LOOKUP_CREATE
 | 
LOOKUP_RENAME_TARGET
))

93  
	`vÁt_ªvÆid©e_sh‹äame
(
díåy
);

94 
	}
}

97 
	$__vÁt_°rùèû_Àn
(
Àn
, c⁄° *
«me
)

99 
Àn
 && 
«me
[len - 1] == '.')

100 
Àn
--;

101  
Àn
;

102 
	}
}

104 
	$vÁt_°rùèû_Àn
(c⁄° 
q°r
 *qstr)

106  
	`__vÁt_°rùèû_Àn
(
q°r
->
Àn
, q°r->
«me
);

107 
	}
}

115 
	$vÁt_hash
(c⁄° 
díåy
 *díåy, c⁄° 
öode
 *inode,

116 
q°r
 *qstr)

118 
q°r
->
hash
 = 
	`fuŒ_«me_hash
(q°r->
«me
, 
	`vÁt_°rùèû_Àn
(qstr));

120 
	}
}

128 
	$vÁt_hashi
(c⁄° 
díåy
 *díåy, c⁄° 
öode
 *inode,

129 
q°r
 *qstr)

131 
∆s_èbÀ
 *
t
 = 
	`MSDOS_SB
(
díåy
->
d_sb
)->
∆s_io
;

132 c⁄° *
«me
;

133 
Àn
;

134 
hash
;

136 
«me
 = 
q°r
->name;

137 
Àn
 = 
	`vÁt_°rùèû_Àn
(
q°r
);

139 
hash
 = 
	`öô_«me_hash
();

140 
Àn
--)

141 
hash
 = 
	`∑πül_«me_hash
(
	`∆s_tﬁowî
(
t
, *
«me
++), hash);

142 
q°r
->
hash
 = 
	`íd_«me_hash
(hash);

145 
	}
}

150 
	$vÁt_cmpi
(c⁄° 
díåy
 *
∑ª¡
, c⁄° 
öode
 *
pöode
,

151 c⁄° 
díåy
 *díåy, c⁄° 
öode
 *inode,

152 
Àn
, c⁄° *
°r
, c⁄° 
q°r
 *
«me
)

154 
∆s_èbÀ
 *
t
 = 
	`MSDOS_SB
(
∑ª¡
->
d_sb
)->
∆s_io
;

155 
Æí
, 
bÀn
;

158 
Æí
 = 
	`vÁt_°rùèû_Àn
(
«me
);

159 
bÀn
 = 
	`__vÁt_°rùèû_Àn
(
Àn
, 
°r
);

160 i‡(
Æí
 =
bÀn
) {

161 i‡(
	`∆s_°∫icmp
(
t
, 
«me
->«me, 
°r
, 
Æí
) == 0)

165 
	}
}

170 
	$vÁt_cmp
(c⁄° 
díåy
 *
∑ª¡
, c⁄° 
öode
 *
pöode
,

171 c⁄° 
díåy
 *díåy, c⁄° 
öode
 *inode,

172 
Àn
, c⁄° *
°r
, c⁄° 
q°r
 *
«me
)

174 
Æí
, 
bÀn
;

177 
Æí
 = 
	`vÁt_°rùèû_Àn
(
«me
);

178 
bÀn
 = 
	`__vÁt_°rùèû_Àn
(
Àn
, 
°r
);

179 i‡(
Æí
 =
bÀn
) {

180 i‡(
	`°∫cmp
(
«me
->«me, 
°r
, 
Æí
) == 0)

184 
	}
}

186 c⁄° 
díåy_›î©i⁄s
 
	gvÁt_ci_díåy_›s
 = {

187 .
d_ªvÆid©e
 = 
vÁt_ªvÆid©e_ci
,

188 .
	gd_hash
 = 
vÁt_hashi
,

189 .
	gd_com∑ª
 = 
vÁt_cmpi
,

192 c⁄° 
díåy_›î©i⁄s
 
	gvÁt_díåy_›s
 = {

193 .
d_ªvÆid©e
 = 
vÁt_ªvÆid©e
,

194 .
	gd_hash
 = 
vÁt_hash
,

195 .
	gd_com∑ª
 = 
vÁt_cmp
,

200 
ölöe
 
wch¨_t
 
	$vÁt_bad_ch¨
(
wch¨_t
 
w
)

202  (
w
 < 0x0020)

203 || (
w
 == '*') || (w == '?') || (w == '<') || (w == '>')

204 || (
w
 == '|') || (w == '"') || (w == ':') || (w == '/')

205 || (
w
 == '\\');

206 
	}
}

208 
ölöe
 
wch¨_t
 
	$vÁt_ª∂a˚_ch¨
(
wch¨_t
 
w
)

210  (
w
 == '[') || (w == ']') || (w == ';') || (w == ',')

211 || (
w
 == '+') || (w == '=');

212 
	}
}

214 
wch¨_t
 
	$vÁt_skù_ch¨
(
wch¨_t
 
w
)

216  (
w
 == '.') || (w == ' ');

217 
	}
}

219 
ölöe
 
	$vÁt_is_u£d_badch¨s
(c⁄° 
wch¨_t
 *
s
, 
Àn
)

221 
i
;

223 
i
 = 0; i < 
Àn
; i++)

224 i‡(
	`vÁt_bad_ch¨
(
s
[
i
]))

225  -
EINVAL
;

227 i‡(
s
[
i
 - 1] == ' ')

228  -
EINVAL
;

231 
	}
}

233 
	$vÁt_föd_f‹m
(
öode
 *
dú
, *
«me
)

235 
Át_¶Ÿ_öfo
 
söfo
;

236 
îr
 = 
	`Át_sˇn
(
dú
, 
«me
, &
söfo
);

237 i‡(
îr
)

238  -
ENOENT
;

239 
	`bªl£
(
söfo
.
bh
);

241 
	}
}

263 
	ssh‹äame_öfo
 {

264 
	mlowî
:1,

265 
	muµî
:1,

266 
	mvÆid
:1;

268 
	#INIT_SHORTNAME_INFO
(
x
) do { \

269 (
x
)->
lowî
 = 1; \

270 (
x
)->
uµî
 = 1; \

271 (
x
)->
vÆid
 = 1; \

272 } 0)

	)

274 
ölöe
 
	$to_sh‹äame_ch¨
(
∆s_èbÀ
 *
∆s
,

275 *
buf
, 
buf_size
,

276 
wch¨_t
 *
§c
, 
sh‹äame_öfo
 *
öfo
)

278 
Àn
;

280 i‡(
	`vÁt_skù_ch¨
(*
§c
)) {

281 
öfo
->
vÆid
 = 0;

284 i‡(
	`vÁt_ª∂a˚_ch¨
(*
§c
)) {

285 
öfo
->
vÆid
 = 0;

286 
buf
[0] = '_';

290 
Àn
 = 
∆s
->
	`uni2ch¨
(*
§c
, 
buf
, 
buf_size
);

291 i‡(
Àn
 <= 0) {

292 
öfo
->
vÆid
 = 0;

293 
buf
[0] = '_';

294 
Àn
 = 1;

295 } i‡(
Àn
 == 1) {

296 
¥ev
 = 
buf
[0];

298 i‡(
buf
[0] >= 0x7F) {

299 
öfo
->
lowî
 = 0;

300 
öfo
->
uµî
 = 0;

303 
buf
[0] = 
	`∆s_touµî
(
∆s
, buf[0]);

304 i‡(
	`ißÕha
(
buf
[0])) {

305 i‡(
buf
[0] =
¥ev
)

306 
öfo
->
lowî
 = 0;

308 
öfo
->
uµî
 = 0;

311 
öfo
->
lowî
 = 0;

312 
öfo
->
uµî
 = 0;

315  
Àn
;

316 
	}
}

324 
	$vÁt_¸óã_sh‹äame
(
öode
 *
dú
, 
∆s_èbÀ
 *
∆s
,

325 
wch¨_t
 *
u«me
, 
uÀn
,

326 *
«me_ªs
, *
lˇ£
)

328 
Át_mou¡_›ti⁄s
 *
›ts
 = &
	`MSDOS_SB
(
dú
->
i_sb
)->
›ti⁄s
;

329 
wch¨_t
 *
ù
, *
ext_°¨t
, *
íd
, *
«me_°¨t
;

330 
ba£
[9], 
ext
[4], 
buf
[5], *
p
;

331 
ch¨buf
[
NLS_MAX_CHARSET_SIZE
];

332 
chl
, 
chi
;

333 
sz
 = 0, 
exéí
, 
ba£Àn
, 
i
, 
numèû_ba£Àn
, 
numèû2_ba£Àn
;

334 
is_sh‹äame
;

335 
sh‹äame_öfo
 
ba£_öfo
, 
ext_öfo
;

337 
is_sh‹äame
 = 1;

338 
	`INIT_SHORTNAME_INFO
(&
ba£_öfo
);

339 
	`INIT_SHORTNAME_INFO
(&
ext_öfo
);

342 
ext_°¨t
 = 
íd
 = &
u«me
[
uÀn
];

343 --
ext_°¨t
 >
u«me
) {

344 i‡(*
ext_°¨t
 == 0x002E) {

345 i‡(
ext_°¨t
 =
íd
 - 1) {

346 
sz
 = 
uÀn
;

347 
ext_°¨t
 = 
NULL
;

353 i‡(
ext_°¨t
 =
u«me
 - 1) {

354 
sz
 = 
uÀn
;

355 
ext_°¨t
 = 
NULL
;

356 } i‡(
ext_°¨t
) {

362 
«me_°¨t
 = &
u«me
[0];

363 
«me_°¨t
 < 
ext_°¨t
) {

364 i‡(!
	`vÁt_skù_ch¨
(*
«me_°¨t
))

366 
«me_°¨t
++;

368 i‡(
«me_°¨t
 !
ext_°¨t
) {

369 
sz
 = 
ext_°¨t
 - 
u«me
;

370 
ext_°¨t
++;

372 
sz
 = 
uÀn
;

373 
ext_°¨t
 = 
NULL
;

377 
numèû_ba£Àn
 = 6;

378 
numèû2_ba£Àn
 = 2;

379 
ba£Àn
 = 
i
 = 0, 
p
 = 
ba£
, 
ù
 = 
u«me
; i < 
sz
; i++, ip++) {

380 
chl
 = 
	`to_sh‹äame_ch¨
(
∆s
, 
ch¨buf
, (charbuf),

381 
ù
, &
ba£_öfo
);

382 i‡(
chl
 == 0)

385 i‡(
ba£Àn
 < 2 && (ba£À¿+ 
chl
) > 2)

386 
numèû2_ba£Àn
 = 
ba£Àn
;

387 i‡(
ba£Àn
 < 6 && (ba£À¿+ 
chl
) > 6)

388 
numèû_ba£Àn
 = 
ba£Àn
;

389 
chi
 = 0; chò< 
chl
; chi++) {

390 *
p
++ = 
ch¨buf
[
chi
];

391 
ba£Àn
++;

392 i‡(
ba£Àn
 >= 8)

395 i‡(
ba£Àn
 >= 8) {

396 i‡((
chi
 < 
chl
 - 1Ë|| (
ù
 + 1Ë- 
u«me
 < 
sz
)

397 
is_sh‹äame
 = 0;

401 i‡(
ba£Àn
 == 0) {

402  -
EINVAL
;

405 
exéí
 = 0;

406 i‡(
ext_°¨t
) {

407 
p
 = 
ext
, 
ù
 = 
ext_°¨t
; 
exéí
 < 3 && i∞< 
íd
; ip++) {

408 
chl
 = 
	`to_sh‹äame_ch¨
(
∆s
, 
ch¨buf
, (charbuf),

409 
ù
, &
ext_öfo
);

410 i‡(
chl
 == 0)

413 i‡((
exéí
 + 
chl
) > 3) {

414 
is_sh‹äame
 = 0;

417 
chi
 = 0; chò< 
chl
; chi++) {

418 *
p
++ = 
ch¨buf
[
chi
];

419 
exéí
++;

421 i‡(
exéí
 >= 3) {

422 i‡(
ù
 + 1 !
íd
)

423 
is_sh‹äame
 = 0;

428 
ext
[
exéí
] = '\0';

429 
ba£
[
ba£Àn
] = '\0';

432 i‡(
ba£
[0] =
DELETED_FLAG
)

433 
ba£
[0] = 0x05;

440 
	`mem£t
(
«me_ªs
, ' ', 
MSDOS_NAME
);

441 
	`mem˝y
(
«me_ªs
, 
ba£
, 
ba£Àn
);

442 
	`mem˝y
(
«me_ªs
 + 8, 
ext
, 
exéí
);

443 *
lˇ£
 = 0;

444 i‡(
is_sh‹äame
 && 
ba£_öfo
.
vÆid
 && 
ext_öfo
.valid) {

445 i‡(
	`vÁt_föd_f‹m
(
dú
, 
«me_ªs
) == 0)

446  -
EEXIST
;

448 i‡(
›ts
->
sh‹äame
 & 
VFAT_SFN_CREATE_WIN95
) {

449  (
ba£_öfo
.
uµî
 && 
ext_öfo
.upper);

450 } i‡(
›ts
->
sh‹äame
 & 
VFAT_SFN_CREATE_WINNT
) {

451 i‡((
ba£_öfo
.
uµî
 || ba£_öfo.
lowî
) &&

452 (
ext_öfo
.
uµî
 ||Éxt_öfo.
lowî
)) {

453 i‡(!
ba£_öfo
.
uµî
 && ba£_öfo.
lowî
)

454 *
lˇ£
 |
CASE_LOWER_BASE
;

455 i‡(!
ext_öfo
.
uµî
 &&Éxt_öfo.
lowî
)

456 *
lˇ£
 |
CASE_LOWER_EXT
;

461 
	`BUG
();

465 i‡(
›ts
->
numèû
 == 0)

466 i‡(
	`vÁt_föd_f‹m
(
dú
, 
«me_ªs
) < 0)

477 i‡(
ba£Àn
 > 6) {

478 
ba£Àn
 = 
numèû_ba£Àn
;

479 
«me_ªs
[7] = ' ';

481 
«me_ªs
[
ba£Àn
] = '~';

482 
i
 = 1; i < 10; i++) {

483 
«me_ªs
[
ba£Àn
 + 1] = 
i
 + '0';

484 i‡(
	`vÁt_föd_f‹m
(
dú
, 
«me_ªs
) < 0)

488 
i
 = 
jiffõs
;

489 
sz
 = (
jiffõs
 >> 16) & 0x7;

490 i‡(
ba£Àn
 > 2) {

491 
ba£Àn
 = 
numèû2_ba£Àn
;

492 
«me_ªs
[7] = ' ';

494 
«me_ªs
[
ba£Àn
 + 4] = '~';

495 
«me_ªs
[
ba£Àn
 + 5] = '1' + 
sz
;

497 
	`¢¥ötf
(
buf
, (buf), "%04X", 
i
 & 0xffff);

498 
	`mem˝y
(&
«me_ªs
[
ba£Àn
], 
buf
, 4);

499 i‡(
	`vÁt_föd_f‹m
(
dú
, 
«me_ªs
) < 0)

501 
i
 -= 11;

504 
	}
}

508 
	$xœã_to_uni
(c⁄° *
«me
, 
Àn
, *
ouäame
,

509 *
l⁄gÀn
, *
ouéí
, 
esˇ≥
, 
utf8
,

510 
∆s_èbÀ
 *
∆s
)

512 c⁄° *
ù
;

513 
nc
;

514 *
›
;

515 
ec
;

516 
i
, 
k
, 
fûl
;

517 
ch¨Àn
;

519 i‡(
utf8
) {

520 *
ouéí
 = 
	`utf8s_to_utf16s
(
«me
, 
Àn
, 
UTF16_HOST_ENDIAN
,

521 (
wch¨_t
 *Ë
ouäame
, 
FAT_LFN_LEN
 + 2);

522 i‡(*
ouéí
 < 0)

523  *
ouéí
;

524 i‡(*
ouéí
 > 
FAT_LFN_LEN
)

525  -
ENAMETOOLONG
;

527 
›
 = &
ouäame
[*
ouéí
 * (
wch¨_t
)];

529 
i
 = 0, 
ù
 = 
«me
, 
›
 = 
ouäame
, *
ouéí
 = 0;

530 
i
 < 
Àn
 && *
ouéí
 < 
FAT_LFN_LEN
;

531 *
ouéí
 += 1) {

532 i‡(
esˇ≥
 && (*
ù
 == ':')) {

533 i‡(
i
 > 
Àn
 - 5)

534  -
EINVAL
;

535 
ec
 = 0;

536 
k
 = 1; k < 5; k++) {

537 
nc
 = 
ù
[
k
];

538 
ec
 <<= 4;

539 i‡(
nc
 >= '0' &&Çc <= '9') {

540 
ec
 |
nc
 - '0';

543 i‡(
nc
 >= 'a' &&Çc <= 'f') {

544 
ec
 |
nc
 - ('a' - 10);

547 i‡(
nc
 >= 'A' &&Çc <= 'F') {

548 
ec
 |
nc
 - ('A' - 10);

551  -
EINVAL
;

553 *
›
++ = 
ec
 & 0xFF;

554 *
›
++ = 
ec
 >> 8;

555 
ù
 += 5;

556 
i
 += 5;

558 
ch¨Àn
 = 
∆s
->
	`ch¨2uni
(
ù
, 
Àn
 - 
i
,

559 (
wch¨_t
 *)
›
);

560 i‡(
ch¨Àn
 < 0)

561  -
EINVAL
;

562 
ù
 +
ch¨Àn
;

563 
i
 +
ch¨Àn
;

564 
›
 += 2;

567 i‡(
i
 < 
Àn
)

568  -
ENAMETOOLONG
;

571 *
l⁄gÀn
 = *
ouéí
;

572 i‡(*
ouéí
 % 13) {

573 *
›
++ = 0;

574 *
›
++ = 0;

575 *
ouéí
 += 1;

576 i‡(*
ouéí
 % 13) {

577 
fûl
 = 13 - (*
ouéí
 % 13);

578 
i
 = 0; i < 
fûl
; i++) {

579 *
›
++ = 0xff;

580 *
›
++ = 0xff;

582 *
ouéí
 +
fûl
;

587 
	}
}

589 
	$vÁt_buûd_¶Ÿs
(
öode
 *
dú
, c⁄° *
«me
,

590 
Àn
, 
is_dú
, 
˛u°î
,

591 
time•ec
 *
ts
,

592 
msdos_dú_¶Ÿ
 *
¶Ÿs
, *
ƒ_¶Ÿs
)

594 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
dú
->
i_sb
);

595 
Át_mou¡_›ti⁄s
 *
›ts
 = &
sbi
->
›ti⁄s
;

596 
msdos_dú_¶Ÿ
 *
ps
;

597 
msdos_dú_íåy
 *
de
;

598 
cksum
, 
lˇ£
;

599 
msdos_«me
[
MSDOS_NAME
];

600 
wch¨_t
 *
u«me
;

601 
__À16
 
time
, 
d©e
;

602 
u8
 
time_cs
;

603 
îr
, 
uÀn
, 
usize
, 
i
;

604 
loff_t
 
off£t
;

606 *
ƒ_¶Ÿs
 = 0;

608 
u«me
 = 
	`__gë«me
();

609 i‡(!
u«me
)

610  -
ENOMEM
;

612 
îr
 = 
	`xœã_to_uni
(
«me
, 
Àn
, (*)
u«me
, &
uÀn
, &
usize
,

613 
›ts
->
unicode_xœã
, o±s->
utf8
, 
sbi
->
∆s_io
);

614 i‡(
îr
)

615 
out_‰ì
;

617 
îr
 = 
	`vÁt_is_u£d_badch¨s
(
u«me
, 
uÀn
);

618 i‡(
îr
)

619 
out_‰ì
;

621 
îr
 = 
	`vÁt_¸óã_sh‹äame
(
dú
, 
sbi
->
∆s_disk
, 
u«me
, 
uÀn
,

622 
msdos_«me
, &
lˇ£
);

623 i‡(
îr
 < 0)

624 
out_‰ì
;

625 i‡(
îr
 == 1) {

626 
de
 = (
msdos_dú_íåy
 *)
¶Ÿs
;

627 
îr
 = 0;

628 
sh‹äame
;

632 
cksum
 = 
	`Át_checksum
(
msdos_«me
);

634 *
ƒ_¶Ÿs
 = 
usize
 / 13;

635 
ps
 = 
¶Ÿs
, 
i
 = *
ƒ_¶Ÿs
; i > 0; i--,Ös++) {

636 
ps
->
id
 = 
i
;

637 
ps
->
©å
 = 
ATTR_EXT
;

638 
ps
->
ª£rved
 = 0;

639 
ps
->
Æüs_checksum
 = 
cksum
;

640 
ps
->
°¨t
 = 0;

641 
off£t
 = (
i
 - 1) * 13;

642 
	`Átwch¨_to16
(
ps
->
«me0_4
, 
u«me
 + 
off£t
, 5);

643 
	`Átwch¨_to16
(
ps
->
«me5_10
, 
u«me
 + 
off£t
 + 5, 6);

644 
	`Átwch¨_to16
(
ps
->
«me11_12
, 
u«me
 + 
off£t
 + 11, 2);

646 
¶Ÿs
[0].
id
 |= 0x40;

647 
de
 = (
msdos_dú_íåy
 *)
ps
;

649 
sh‹äame
:

651 (*
ƒ_¶Ÿs
)++;

652 
	`mem˝y
(
de
->
«me
, 
msdos_«me
, 
MSDOS_NAME
);

653 
de
->
©å
 = 
is_dú
 ? 
ATTR_DIR
 : 
ATTR_ARCH
;

654 
de
->
lˇ£
 =Ücase;

655 
	`Át_time_unix2Át
(
sbi
, 
ts
, &
time
, &
d©e
, &
time_cs
);

656 
de
->
time
 = de->
˘ime
 =Åime;

657 
de
->
d©e
 = de->
cd©e
 = de->
ad©e
 = date;

658 
de
->
˘ime_cs
 = 
time_cs
;

659 
	`Át_£t_°¨t
(
de
, 
˛u°î
);

660 
de
->
size
 = 0;

661 
out_‰ì
:

662 
	`__puäame
(
u«me
);

663  
îr
;

664 
	}
}

666 
	$vÁt_add_íåy
(
öode
 *
dú
, 
q°r
 *
q«me
, 
is_dú
,

667 
˛u°î
, 
time•ec
 *
ts
,

668 
Át_¶Ÿ_öfo
 *
söfo
)

670 
msdos_dú_¶Ÿ
 *
¶Ÿs
;

671 
Àn
;

672 
îr
, 
ƒ_¶Ÿs
;

674 
Àn
 = 
	`vÁt_°rùèû_Àn
(
q«me
);

675 i‡(
Àn
 == 0)

676  -
ENOENT
;

678 
¶Ÿs
 = 
	`kmÆloc
((*¶ŸsË* 
MSDOS_SLOTS
, 
GFP_NOFS
);

679 i‡(
¶Ÿs
 =
NULL
)

680  -
ENOMEM
;

682 
îr
 = 
	`vÁt_buûd_¶Ÿs
(
dú
, 
q«me
->
«me
, 
Àn
, 
is_dú
, 
˛u°î
, 
ts
,

683 
¶Ÿs
, &
ƒ_¶Ÿs
);

684 i‡(
îr
)

685 
˛ónup
;

687 
îr
 = 
	`Át_add_íåõs
(
dú
, 
¶Ÿs
, 
ƒ_¶Ÿs
, 
söfo
);

688 i‡(
îr
)

689 
˛ónup
;

692 
dú
->
i_˘ime
 = dú->
i_mtime
 = dú->
i_©ime
 = *
ts
;

701 i‡(
	`IS_DIRSYNC
(
dú
))

702 ()
	`Át_sync_öode
(
dú
);

704 
	`m¨k_öode_dúty
(
dú
);

705 
˛ónup
:

706 
	`k‰ì
(
¶Ÿs
);

707  
îr
;

708 
	}
}

710 
	$vÁt_föd
(
öode
 *
dú
, 
q°r
 *
q«me
,

711 
Át_¶Ÿ_öfo
 *
söfo
)

713 
Àn
 = 
	`vÁt_°rùèû_Àn
(
q«me
);

714 i‡(
Àn
 == 0)

715  -
ENOENT
;

716  
	`Át_£¨ch_l⁄g
(
dú
, 
q«me
->
«me
, 
Àn
, 
söfo
);

717 
	}
}

723 
	$vÁt_d_™⁄_disc⁄n
(
díåy
 *dentry)

725  
	`IS_ROOT
(
díåy
Ë&& (díåy->
d_Êags
 & 
DCACHE_DISCONNECTED
);

726 
	}
}

728 
díåy
 *
	$vÁt_lookup
(
öode
 *
dú
, 
díåy
 *dentry,

729 
Êags
)

731 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

732 
Át_¶Ÿ_öfo
 
söfo
;

733 
öode
 *inode;

734 
díåy
 *
Æüs
;

735 
îr
;

739 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

741 
îr
 = 
	`vÁt_föd
(
dú
, &
díåy
->
d_«me
, &
söfo
);

742 i‡(
îr
) {

743 i‡(
îr
 =-
ENOENT
) {

744 
öode
 = 
NULL
;

745 
out
;

747 
îr‹
;

750 
öode
 = 
	`Át_buûd_öode
(
sb
, 
söfo
.
de
, söfo.
i_pos
);

751 
	`bªl£
(
söfo
.
bh
);

752 i‡(
	`IS_ERR
(
öode
)) {

753 
îr
 = 
	`PTR_ERR
(
öode
);

754 
îr‹
;

757 
Æüs
 = 
	`d_föd_Æüs
(
öode
);

758 i‡(
Æüs
 && !
	`vÁt_d_™⁄_disc⁄n
(alias)) {

766 
	`BUG_ON
(
	`d_unhashed
(
Æüs
));

767 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

768 
	`d_move
(
Æüs
, 
díåy
);

769 
	`ùut
(
öode
);

770 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

771  
Æüs
;

773 
	`dput
(
Æüs
);

775 
out
:

776 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

777 
díåy
->
d_time
 = díåy->
d_∑ª¡
->
d_öode
->
i_vîsi⁄
;

778 
díåy
 = 
	`d_•li˚_Æüs
(
öode
, dentry);

779 i‡(
díåy
)

781 
díåy
->
d_time
 = díåy->
d_∑ª¡
->
d_öode
->
i_vîsi⁄
;

785  
díåy
;

787 
îr‹
:

788 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

789  
	`ERR_PTR
(
îr
);

790 
	}
}

792 
	$vÁt_¸óã
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
,

793 
boﬁ
 
ex˛
)

795 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

796 
öode
 *inode;

797 
Át_¶Ÿ_öfo
 
söfo
;

798 
time•ec
 
ts
;

799 
îr
;

803 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

805 
ts
 = 
CURRENT_TIME_SEC_OPEL
;

807 
îr
 = 
	`vÁt_add_íåy
(
dú
, &
díåy
->
d_«me
, 0, 0, &
ts
, &
söfo
);

808 i‡(
îr
)

809 
out
;

810 
dú
->
i_vîsi⁄
++;

812 
öode
 = 
	`Át_buûd_öode
(
sb
, 
söfo
.
de
, söfo.
i_pos
);

813 
	`bªl£
(
söfo
.
bh
);

814 i‡(
	`IS_ERR
(
öode
)) {

815 
îr
 = 
	`PTR_ERR
(
öode
);

816 
out
;

818 
öode
->
i_vîsi⁄
++;

820 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
ts
;

835 
díåy
->
d_time
 = díåy->
d_∑ª¡
->
d_öode
->
i_vîsi⁄
;

837 
	`d_ö°™tüã
(
díåy
, 
öode
);

838 
out
:

839 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

840  
îr
;

841 
	}
}

843 
	$vÁt_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

845 
öode
 *öodê
díåy
->
d_öode
;

846 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

847 
Át_¶Ÿ_öfo
 
söfo
;

848 
îr
;

850 
	`¥ötk
–
KERN_ALERT
 "[cheon] vfat_rmdir \n" );

852 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

854 
îr
 = 
	`Át_dú_em±y
(
öode
);

855 i‡(
îr
)

856 
out
;

857 
îr
 = 
	`vÁt_föd
(
dú
, &
díåy
->
d_«me
, &
söfo
);

858 i‡(
îr
)

859 
out
;

861 
îr
 = 
	`Át_ªmove_íåõs
(
dú
, &
söfo
);

862 i‡(
îr
)

863 
out
;

864 
	`dr›_∆ök
(
dú
);

866 
	`˛ór_∆ök
(
öode
);

867 
öode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME_SEC_OPEL
;

872 
	`¥ötk
("[cheon] vfat_rmdir \n");

873 
	`¥ötk
("öode->i_mtime.tv_£¯: %lu \n", 
öode
->
i_mtime
.
tv_£c
 );

874 
	`¥ötk
("öode->i_mtime.tv_n£¯: %ld \n", 
öode
->
i_mtime
.
tv_n£c
 );

876 
	`Át_dëach
(
öode
);

877 
out
:

878 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

880  
îr
;

881 
	}
}

883 
	$vÁt_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

885 
öode
 *öodê
díåy
->
d_öode
;

886 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

887 
Át_¶Ÿ_öfo
 
söfo
;

888 
îr
;

893 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

895 
îr
 = 
	`vÁt_föd
(
dú
, &
díåy
->
d_«me
, &
söfo
);

896 i‡(
îr
)

897 
out
;

900 
îr
 = 
	`Át_ªmove_íåõs
(
dú
, &
söfo
);

901 i‡(
îr
)

902 
out
;

903 
	`˛ór_∆ök
(
öode
);

904 
öode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME_SEC_OPEL
;

913 
	`Át_dëach
(
öode
);

914 
out
:

915 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

917  
îr
;

918 
	}
}

920 
	$vÁt_mkdú
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

922 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

923 
öode
 *inode;

924 
Át_¶Ÿ_öfo
 
söfo
;

925 
time•ec
 
ts
;

926 
îr
, 
˛u°î
;

930 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

933 
ts
 = 
CURRENT_TIME_SEC_OPEL
;

934 
˛u°î
 = 
	`Át_Æloc_√w_dú
(
dú
, &
ts
);

935 i‡(
˛u°î
 < 0) {

936 
îr
 = 
˛u°î
;

937 
out
;

939 
îr
 = 
	`vÁt_add_íåy
(
dú
, &
díåy
->
d_«me
, 1, 
˛u°î
, &
ts
, &
söfo
);

940 i‡(
îr
)

941 
out_‰ì
;

942 
dú
->
i_vîsi⁄
++;

943 
	`öc_∆ök
(
dú
);

945 
öode
 = 
	`Át_buûd_öode
(
sb
, 
söfo
.
de
, söfo.
i_pos
);

946 
	`bªl£
(
söfo
.
bh
);

947 i‡(
	`IS_ERR
(
öode
)) {

948 
îr
 = 
	`PTR_ERR
(
öode
);

950 
out
;

952 
öode
->
i_vîsi⁄
++;

953 
	`£t_∆ök
(
öode
, 2);

954 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
ts
;

966 
díåy
->
d_time
 = díåy->
d_∑ª¡
->
d_öode
->
i_vîsi⁄
;

968 
	`d_ö°™tüã
(
díåy
, 
öode
);

970 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

973 
out_‰ì
:

975 
	`Át_‰ì_˛u°îs
(
dú
, 
˛u°î
);

976 
out
:

977 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

978  
îr
;

979 
	}
}

981 
	$vÁt_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

982 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
)

984 
buf„r_hód
 *
dŸdŸ_bh
;

985 
msdos_dú_íåy
 *
dŸdŸ_de
;

986 
öode
 *
ﬁd_öode
, *
√w_öode
;

987 
Át_¶Ÿ_öfo
 
ﬁd_söfo
, 
söfo
;

988 
time•ec
 
ts
;

989 
loff_t
 
√w_i_pos
;

990 
îr
, 
is_dú
, 
upd©e_dŸdŸ
, 
c‹ru±
 = 0;

991 
su≥r_block
 *
sb
 = 
ﬁd_dú
->
i_sb
;

993 
	`¥ötk
–
KERN_ALERT
 "[cheon] vfat_rename \n");

995 
ﬁd_söfo
.
bh
 = 
söfo
.bh = 
dŸdŸ_bh
 = 
NULL
;

996 
ﬁd_öode
 = 
ﬁd_díåy
->
d_öode
;

997 
√w_öode
 = 
√w_díåy
->
d_öode
;

998 
	`muãx_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

999 
îr
 = 
	`vÁt_föd
(
ﬁd_dú
, &
ﬁd_díåy
->
d_«me
, &
ﬁd_söfo
);

1000 i‡(
îr
)

1001 
out
;

1003 
is_dú
 = 
	`S_ISDIR
(
ﬁd_öode
->
i_mode
);

1004 
upd©e_dŸdŸ
 = (
is_dú
 && 
ﬁd_dú
 !
√w_dú
);

1005 i‡(
upd©e_dŸdŸ
) {

1006 i‡(
	`Át_gë_dŸdŸ_íåy
(
ﬁd_öode
, &
dŸdŸ_bh
, &
dŸdŸ_de
)) {

1007 
îr
 = -
EIO
;

1008 
out
;

1012 
ts
 = 
CURRENT_TIME_SEC_OPEL
;

1014 i‡(
√w_öode
) {

1015 i‡(
is_dú
) {

1016 
îr
 = 
	`Át_dú_em±y
(
√w_öode
);

1017 i‡(
îr
)

1018 
out
;

1020 
√w_i_pos
 = 
	`MSDOS_I
(
√w_öode
)->
i_pos
;

1021 
	`Át_dëach
(
√w_öode
);

1023 
îr
 = 
	`vÁt_add_íåy
(
√w_dú
, &
√w_díåy
->
d_«me
, 
is_dú
, 0,

1024 &
ts
, &
söfo
);

1025 i‡(
îr
)

1026 
out
;

1027 
√w_i_pos
 = 
söfo
.
i_pos
;

1029 
√w_dú
->
i_vîsi⁄
++;

1031 
	`Át_dëach
(
ﬁd_öode
);

1032 
	`Át_©èch
(
ﬁd_öode
, 
√w_i_pos
);

1033 i‡(
	`IS_DIRSYNC
(
√w_dú
)) {

1034 
îr
 = 
	`Át_sync_öode
(
ﬁd_öode
);

1035 i‡(
îr
)

1036 
îr‹_öode
;

1038 
	`m¨k_öode_dúty
(
ﬁd_öode
);

1040 i‡(
upd©e_dŸdŸ
) {

1041 
	`Át_£t_°¨t
(
dŸdŸ_de
, 
	`MSDOS_I
(
√w_dú
)->
i_log°¨t
);

1042 
	`m¨k_buf„r_dúty_öode
(
dŸdŸ_bh
, 
ﬁd_öode
);

1043 i‡(
	`IS_DIRSYNC
(
√w_dú
)) {

1044 
îr
 = 
	`sync_dúty_buf„r
(
dŸdŸ_bh
);

1045 i‡(
îr
)

1046 
îr‹_dŸdŸ
;

1048 
	`dr›_∆ök
(
ﬁd_dú
);

1049 i‡(!
√w_öode
)

1050 
	`öc_∆ök
(
√w_dú
);

1053 
îr
 = 
	`Át_ªmove_íåõs
(
ﬁd_dú
, &
ﬁd_söfo
);

1054 
ﬁd_söfo
.
bh
 = 
NULL
;

1055 i‡(
îr
)

1056 
îr‹_dŸdŸ
;

1057 
ﬁd_dú
->
i_vîsi⁄
++;

1058 
ﬁd_dú
->
i_˘ime
 = old_dú->
i_mtime
 = 
ts
;

1059 i‡(
	`IS_DIRSYNC
(
ﬁd_dú
))

1060 ()
	`Át_sync_öode
(
ﬁd_dú
);

1062 
	`m¨k_öode_dúty
(
ﬁd_dú
);

1064 i‡(
√w_öode
) {

1065 
	`dr›_∆ök
(
√w_öode
);

1066 i‡(
is_dú
)

1067 
	`dr›_∆ök
(
√w_öode
);

1068 
√w_öode
->
i_˘ime
 = 
ts
;

1070 
out
:

1071 
	`bªl£
(
söfo
.
bh
);

1072 
	`bªl£
(
dŸdŸ_bh
);

1073 
	`bªl£
(
ﬁd_söfo
.
bh
);

1074 
	`muãx_u∆ock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

1076  
îr
;

1078 
îr‹_dŸdŸ
:

1080 
c‹ru±
 = 1;

1082 i‡(
upd©e_dŸdŸ
) {

1083 
	`Át_£t_°¨t
(
dŸdŸ_de
, 
	`MSDOS_I
(
ﬁd_dú
)->
i_log°¨t
);

1084 
	`m¨k_buf„r_dúty_öode
(
dŸdŸ_bh
, 
ﬁd_öode
);

1085 
c‹ru±
 |
	`sync_dúty_buf„r
(
dŸdŸ_bh
);

1087 
îr‹_öode
:

1088 
	`Át_dëach
(
ﬁd_öode
);

1089 
	`Át_©èch
(
ﬁd_öode
, 
ﬁd_söfo
.
i_pos
);

1090 i‡(
√w_öode
) {

1091 
	`Át_©èch
(
√w_öode
, 
√w_i_pos
);

1092 i‡(
c‹ru±
)

1093 
c‹ru±
 |
	`Át_sync_öode
(
√w_öode
);

1100 
îr2
 = 
	`Át_ªmove_íåõs
(
√w_dú
, &
söfo
);

1101 i‡(
c‹ru±
)

1102 
c‹ru±
 |
îr2
;

1103 
söfo
.
bh
 = 
NULL
;

1105 i‡(
c‹ru±
 < 0) {

1106 
	`Át_fs_îr‹
(
√w_dú
->
i_sb
,

1108 
__func__
, 
söfo
.
i_pos
);

1110 
out
;

1111 
	}
}

1113 c⁄° 
öode_›î©i⁄s
 
	gvÁt_dú_öode_›î©i⁄s
 = {

1114 .
¸óã
 = 
vÁt_¸óã
,

1115 .
	glookup
 = 
vÁt_lookup
,

1116 .
	gu∆ök
 = 
vÁt_u∆ök
,

1117 .
	gmkdú
 = 
vÁt_mkdú
,

1118 .
	grmdú
 = 
vÁt_rmdú
,

1119 .
	gª«me
 = 
vÁt_ª«me
,

1120 .
	g£èâr
 = 
Át_£èâr
,

1121 .
	ggë©å
 = 
Át_gë©å
,

1124 
	$£tup
(
su≥r_block
 *
sb
)

1126 
	`MSDOS_SB
(
sb
)->
dú_›s
 = &
vÁt_dú_öode_›î©i⁄s
;

1127 i‡(
	`MSDOS_SB
(
sb
)->
›ti⁄s
.
«me_check
 != 's')

1128 
sb
->
s_d_›
 = &
vÁt_ci_díåy_›s
;

1130 
sb
->
s_d_›
 = &
vÁt_díåy_›s
;

1131 
	}
}

1133 
	$vÁt_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

1135 
ªs
;

1137 
ªs
 = 
	`Át_fûl_su≥r
(
sb
, 
d©a
, 
sûít
, 1, 
£tup
);

1141 
	`Át_upd©e_su≥r
–
sb
 );

1143  
ªs
;

1144 
	}
}

1146 
díåy
 *
	$vÁt_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
,

1147 
Êags
, c⁄° *
dev_«me
,

1148 *
d©a
)

1150 
	`¥ötk
–
KERN_ALERT
 "[cheon] 0130 1855\n");

1151 
	`¥ötk
–
KERN_ALERT
 "[cheon] vfat_mount !! \n");

1152  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
vÁt_fûl_su≥r
);

1153 
	}
}

1156 
kobje˘
 *
	g›ñ_Át_kobj
;

1158 
ssize_t
 
	$c⁄åﬁ_show
–
kobje˘
 *
kobj
, 
kobj_©åibuã
 *
©å
, *
buff
 )

1160  
	`¢¥ötf
–
buff
, 
PAGE_SIZE
, "%d \n", 1234 );

1161 
	}
}

1163 
ssize_t
 
	$c⁄åﬁ_°‹e
–
kobje˘
 *
kobj
, 
kobj_©åibuã
 *
©å
, c⁄° *
buff
, 
size_t
 
cou¡
 )

1165 
num
;

1167 
	`ssˇnf
–
buff
, "%d", &
num
 );

1169 
	`¥ötk
–
KERN_ALERT
 "num : %d \n", 
num
 );

1170 
	`¥ötk
–
KERN_ALERT
 "buf‡: %†\n", 
buff
 );

1172  
cou¡
;

1173 
	}
}

1176 
kobj_©åibuã
 
	gc⁄åﬁ_©å
 = 
__ATTR
–
c⁄åﬁ
, 0644, 
c⁄åﬁ_show
, 
c⁄åﬁ_°‹e
 );

1178 
©åibuã
 *
	g©åibuãs
[ ] = {

1179 &
c⁄åﬁ_©å
.
©å
,

1180 
NULL
,

1183 
©åibuã_group
 
	g©å_group
 = {

1184 .
©ås
 = 
©åibuãs
,

1187 
	$do_fs_sysfs_ªgi°øti⁄
( )

1189 
rc
;

1191 
›ñ_Át_kobj
 = 
	`kobje˘_¸óã_™d_add
–"OPEL_FAT", 
fs_kobj
 );

1193 if–!
›ñ_Át_kobj
 ){

1194 
	`¥ötk
–
KERN_ERR
 "UnableÅo create opel fatáttributes \n" );

1195 
out
;

1198 
rc
 = 
	`sysfs_¸óã_group
–
›ñ_Át_kobj
, &
©å_group
 );

1200 if–
rc
 )

1202 
	`¥ötk
–
KERN_ERR
 "UnableÅo create opel fatáttributes \n");

1203 
	`kobje˘_put
–
›ñ_Át_kobj
 );

1206 
out
:

1207  
rc
;

1208 
	}
}

1210 
	$do_fs_sysfs_uƒegi°øti⁄
( )

1212 
	`sysfs_ªmove_group
–
›ñ_Át_kobj
, &
©å_group
 );

1214 
	`kobje˘_put
–
›ñ_Át_kobj
 );

1215 
	`kobje˘_dñ
–
›ñ_Át_kobj
 );

1216 
	}
}

1221 
fûe_sy°em_ty≥
 
	gvÁt_fs_ty≥
 = {

1222 .
ow√r
 = 
THIS_MODULE
,

1223 .
	g«me
 = "vfat",

1224 .
	gmou¡
 = 
vÁt_mou¡
,

1225 .
	gkûl_sb
 = 
kûl_block_su≥r
,

1226 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

1228 
MODULE_ALIAS_FS
("vfat");

1230 
__öô
 
	$öô_vÁt_fs
()

1233 
rc
;

1234 
	`¥ötk
–
KERN_ALERT
 "[cheon] FAT sysfs Test!! \n");

1236 
rc
 = 
	`do_fs_sysfs_ªgi°øti⁄
();

1238 if–
rc
 ){

1239 
	`¥ötk
–
KERN_ALERT
 "[cheon] sysfsÑegistration faild \b");

1243  
	`ªgi°î_fûesy°em
(&
vÁt_fs_ty≥
);

1244 
	}
}

1246 
__exô
 
	$exô_vÁt_fs
()

1249 
	`uƒegi°î_fûesy°em
(&
vÁt_fs_ty≥
);

1250 
	}
}

1252 
MODULE_LICENSE
("GPL");

1253 
MODULE_DESCRIPTION
("VFAT filesystem support");

1254 
MODULE_AUTHOR
("Gordon Chaffee");

1256 
	$moduÀ_öô
(
öô_vÁt_fs
)

1257 
	`moduÀ_exô
(
exô_vÁt_fs
)

	@nfs.c

14 
	~<löux/exp‹tfs.h
>

15 
	~"Át.h
"

17 
	sÁt_fid
 {

18 
u32
 
	mi_gí
;

19 
u32
 
	mi_pos_low
;

20 
u16
 
	mi_pos_hi
;

21 
u16
 
	m∑ª¡_i_pos_hi
;

22 
u32
 
	m∑ª¡_i_pos_low
;

23 
u32
 
	m∑ª¡_i_gí
;

26 
	#FAT_FID_SIZE_WITHOUT_PARENT
 3

	)

27 
	#FAT_FID_SIZE_WITH_PARENT
 ((
Át_fid
)/(
u32
))

	)

32 
öode
 *
	$Át_dgë
(
su≥r_block
 *
sb
, 
i_log°¨t
)

34 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

35 
hli°_hód
 *
hód
;

36 
msdos_öode_öfo
 *
i
;

37 
öode
 *öodê
NULL
;

39 
hód
 = 
sbi
->
dú_hashèbÀ
 + 
	`Át_dú_hash
(
i_log°¨t
);

40 
	`•ö_lock
(&
sbi
->
dú_hash_lock
);

41 
	`hli°_f‹_óch_íåy
(
i
, 
hód
, 
i_dú_hash
) {

42 
	`BUG_ON
(
i
->
vfs_öode
.
i_sb
 !
sb
);

43 i‡(
i
->
i_log°¨t
 != i_logstart)

45 
öode
 = 
	`igøb
(&
i
->
vfs_öode
);

46 i‡(
öode
)

49 
	`•ö_u∆ock
(&
sbi
->
dú_hash_lock
);

50  
öode
;

51 
	}
}

53 
öode
 *
	$Át_ûookup
(
su≥r_block
 *
sb
, 
u64
 
öo
, 
loff_t
 
i_pos
)

55 i‡(
	`MSDOS_SB
(
sb
)->
›ti⁄s
.
nfs
 =
FAT_NFS_NOSTALE_RO
)

56  
	`Át_igë
(
sb
, 
i_pos
);

59 i‡((
öo
 < 
MSDOS_ROOT_INO
Ë|| (öÿ=
MSDOS_FSINFO_INO
))

60  
NULL
;

61  
	`ûookup
(
sb
, 
öo
);

63 
	}
}

65 
öode
 *
	$__Át_nfs_gë_öode
(
su≥r_block
 *
sb
,

66 
u64
 
öo
, 
u32
 
gíî©i⁄
, 
loff_t
 
i_pos
)

68 
öode
 *öodê
	`Át_ûookup
(
sb
, 
öo
, 
i_pos
);

70 i‡(
öode
 && 
gíî©i⁄
 && (öode->
i_gíî©i⁄
 != generation)) {

71 
	`ùut
(
öode
);

72 
öode
 = 
NULL
;

74 i‡(
öode
 =
NULL
 && 
	`MSDOS_SB
(
sb
)->
›ti⁄s
.
nfs
 =
FAT_NFS_NOSTALE_RO
) {

75 
buf„r_hód
 *
bh
 = 
NULL
;

76 
msdos_dú_íåy
 *
de
 ;

77 
£˘‹_t
 
blockƒ
;

78 
off£t
;

79 
	`Át_gë_blkƒ_off£t
(
	`MSDOS_SB
(
sb
), 
i_pos
, &
blockƒ
, &
off£t
);

80 
bh
 = 
	`sb_bªad
(
sb
, 
blockƒ
);

81 i‡(!
bh
) {

82 
	`Át_msg
(
sb
, 
KERN_ERR
,

84 (
Œu
)
blockƒ
);

85  
öode
;

87 
de
 = (
msdos_dú_íåy
 *)
bh
->
b_d©a
;

91 i‡(
	`IS_FREE
(
de
[
off£t
].
«me
))

92 
öode
 = 
NULL
;

94 
öode
 = 
	`Át_buûd_öode
(
sb
, &
de
[
off£t
], 
i_pos
);

95 
	`bªl£
(
bh
);

98  
öode
;

99 
	}
}

101 
öode
 *
	$Át_nfs_gë_öode
(
su≥r_block
 *
sb
,

102 
u64
 
öo
, 
u32
 
gíî©i⁄
)

105  
	`__Át_nfs_gë_öode
(
sb
, 
öo
, 
gíî©i⁄
, 0);

106 
	}
}

109 
	$Át_ícode_fh_no°Æe
(
öode
 *öode, 
__u32
 *
fh
, *
À≈
,

110 
öode
 *
∑ª¡
)

112 
Àn
 = *
À≈
;

113 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
öode
->
i_sb
);

114 
Át_fid
 *
fid
 = (Át_fid *Ë
fh
;

115 
loff_t
 
i_pos
;

116 
ty≥
 = 
FILEID_FAT_WITHOUT_PARENT
;

118 i‡(
∑ª¡
) {

119 i‡(
Àn
 < 
FAT_FID_SIZE_WITH_PARENT
) {

120 *
À≈
 = 
FAT_FID_SIZE_WITH_PARENT
;

121  
FILEID_INVALID
;

124 i‡(
Àn
 < 
FAT_FID_SIZE_WITHOUT_PARENT
) {

125 *
À≈
 = 
FAT_FID_SIZE_WITHOUT_PARENT
;

126  
FILEID_INVALID
;

130 
i_pos
 = 
	`Át_i_pos_ªad
(
sbi
, 
öode
);

131 *
À≈
 = 
FAT_FID_SIZE_WITHOUT_PARENT
;

132 
fid
->
i_gí
 = 
öode
->
i_gíî©i⁄
;

133 
fid
->
i_pos_low
 = 
i_pos
 & 0xFFFFFFFF;

134 
fid
->
i_pos_hi
 = (
i_pos
 >> 32) & 0xFFFF;

135 i‡(
∑ª¡
) {

136 
i_pos
 = 
	`Át_i_pos_ªad
(
sbi
, 
∑ª¡
);

137 
fid
->
∑ª¡_i_pos_hi
 = (
i_pos
 >> 32) & 0xFFFF;

138 
fid
->
∑ª¡_i_pos_low
 = 
i_pos
 & 0xFFFFFFFF;

139 
fid
->
∑ª¡_i_gí
 = 
∑ª¡
->
i_gíî©i⁄
;

140 
ty≥
 = 
FILEID_FAT_WITH_PARENT
;

141 *
À≈
 = 
FAT_FID_SIZE_WITH_PARENT
;

144  
ty≥
;

145 
	}
}

151 
díåy
 *
	$Át_fh_to_díåy
(
su≥r_block
 *
sb
, 
fid
 *fid,

152 
fh_Àn
, 
fh_ty≥
)

154  
	`gíîic_fh_to_díåy
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

155 
Át_nfs_gë_öode
);

156 
	}
}

158 
díåy
 *
	$Át_fh_to_díåy_no°Æe
(
su≥r_block
 *
sb
,

159 
fid
 *
fh
, 
fh_Àn
,

160 
fh_ty≥
)

162 
öode
 *öodê
NULL
;

163 
Át_fid
 *
fid
 = (Át_fid *)
fh
;

164 
loff_t
 
i_pos
;

166 
fh_ty≥
) {

167 
FILEID_FAT_WITHOUT_PARENT
:

168 i‡(
fh_Àn
 < 
FAT_FID_SIZE_WITHOUT_PARENT
)

169  
NULL
;

171 
FILEID_FAT_WITH_PARENT
:

172 i‡(
fh_Àn
 < 
FAT_FID_SIZE_WITH_PARENT
)

173  
NULL
;

176  
NULL
;

178 
i_pos
 = 
fid
->
i_pos_hi
;

179 
i_pos
 = (i_po†<< 32Ë| (
fid
->
i_pos_low
);

180 
öode
 = 
	`__Át_nfs_gë_öode
(
sb
, 0, 
fid
->
i_gí
, 
i_pos
);

182  
	`d_obèö_Æüs
(
öode
);

183 
	}
}

189 
díåy
 *
	$Át_fh_to_∑ª¡
(
su≥r_block
 *
sb
, 
fid
 *fid,

190 
fh_Àn
, 
fh_ty≥
)

192  
	`gíîic_fh_to_∑ª¡
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

193 
Át_nfs_gë_öode
);

194 
	}
}

196 
díåy
 *
	$Át_fh_to_∑ª¡_no°Æe
(
su≥r_block
 *
sb
,

197 
fid
 *
fh
, 
fh_Àn
,

198 
fh_ty≥
)

200 
öode
 *öodê
NULL
;

201 
Át_fid
 *
fid
 = (Át_fid *)
fh
;

202 
loff_t
 
i_pos
;

204 i‡(
fh_Àn
 < 
FAT_FID_SIZE_WITH_PARENT
)

205  
NULL
;

207 
fh_ty≥
) {

208 
FILEID_FAT_WITH_PARENT
:

209 
i_pos
 = 
fid
->
∑ª¡_i_pos_hi
;

210 
i_pos
 = (i_po†<< 32Ë| (
fid
->
∑ª¡_i_pos_low
);

211 
öode
 = 
	`__Át_nfs_gë_öode
(
sb
, 0, 
fid
->
∑ª¡_i_gí
, 
i_pos
);

215  
	`d_obèö_Æüs
(
öode
);

216 
	}
}

223 
öode
 *
	$Át_ªbuûd_∑ª¡
(
su≥r_block
 *
sb
, 
∑ª¡_log°¨t
)

225 
£¨ch_˛us
, 
˛us_to_m©ch
;

226 
msdos_dú_íåy
 *
de
;

227 
öode
 *
∑ª¡
 = 
NULL
;

228 
öode
 *
dummy_gønd_∑ª¡
 = 
NULL
;

229 
Át_¶Ÿ_öfo
 
söfo
;

230 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

231 
£˘‹_t
 
blkƒ
 = 
	`Át_˛us_to_blkƒ
(
sbi
, 
∑ª¡_log°¨t
);

232 
buf„r_hód
 *
∑ª¡_bh
 = 
	`sb_bªad
(
sb
, 
blkƒ
);

233 i‡(!
∑ª¡_bh
) {

234 
	`Át_msg
(
sb
, 
KERN_ERR
,

236  
NULL
;

239 
de
 = (
msdos_dú_íåy
 *Ë
∑ª¡_bh
->
b_d©a
;

240 
˛us_to_m©ch
 = 
	`Át_gë_°¨t
(
sbi
, &
de
[0]);

241 
£¨ch_˛us
 = 
	`Át_gë_°¨t
(
sbi
, &
de
[1]);

243 
dummy_gønd_∑ª¡
 = 
	`Át_dgë
(
sb
, 
£¨ch_˛us
);

244 i‡(!
dummy_gønd_∑ª¡
) {

245 
dummy_gønd_∑ª¡
 = 
	`√w_öode
(
sb
);

246 i‡(!
dummy_gønd_∑ª¡
) {

247 
	`bªl£
(
∑ª¡_bh
);

248  
∑ª¡
;

251 
dummy_gønd_∑ª¡
->
i_öo
 = 
	`iunique
(
sb
, 
MSDOS_ROOT_INO
);

252 
	`Át_fûl_öode
(
dummy_gønd_∑ª¡
, &
de
[1]);

253 
	`MSDOS_I
(
dummy_gønd_∑ª¡
)->
i_pos
 = -1;

256 i‡(!
	`Át_sˇn_log°¨t
(
dummy_gønd_∑ª¡
, 
˛us_to_m©ch
, &
söfo
))

257 
∑ª¡
 = 
	`Át_buûd_öode
(
sb
, 
söfo
.
de
, söfo.
i_pos
);

259 
	`bªl£
(
∑ª¡_bh
);

260 
	`ùut
(
dummy_gønd_∑ª¡
);

262  
∑ª¡
;

263 
	}
}

271 
díåy
 *
	$Át_gë_∑ª¡
(
díåy
 *
chûd_dú
)

273 
su≥r_block
 *
sb
 = 
chûd_dú
->
d_sb
;

274 
buf„r_hód
 *
bh
 = 
NULL
;

275 
msdos_dú_íåy
 *
de
;

276 
öode
 *
∑ª¡_öode
 = 
NULL
;

277 
msdos_sb_öfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

279 i‡(!
	`Át_gë_dŸdŸ_íåy
(
chûd_dú
->
d_öode
, &
bh
, &
de
)) {

280 
∑ª¡_log°¨t
 = 
	`Át_gë_°¨t
(
sbi
, 
de
);

281 
∑ª¡_öode
 = 
	`Át_dgë
(
sb
, 
∑ª¡_log°¨t
);

282 i‡(!
∑ª¡_öode
 && 
sbi
->
›ti⁄s
.
nfs
 =
FAT_NFS_NOSTALE_RO
)

283 
∑ª¡_öode
 = 
	`Át_ªbuûd_∑ª¡
(
sb
, 
∑ª¡_log°¨t
);

285 
	`bªl£
(
bh
);

287  
	`d_obèö_Æüs
(
∑ª¡_öode
);

288 
	}
}

290 c⁄° 
exp‹t_›î©i⁄s
 
	gÁt_exp‹t_›s
 = {

291 .
fh_to_díåy
 = 
Át_fh_to_díåy
,

292 .
	gfh_to_∑ª¡
 = 
Át_fh_to_∑ª¡
,

293 .
	ggë_∑ª¡
 = 
Át_gë_∑ª¡
,

296 c⁄° 
exp‹t_›î©i⁄s
 
	gÁt_exp‹t_›s_no°Æe
 = {

297 .
ícode_fh
 = 
Át_ícode_fh_no°Æe
,

298 .
	gfh_to_díåy
 = 
Át_fh_to_díåy_no°Æe
,

299 .
	gfh_to_∑ª¡
 = 
Át_fh_to_∑ª¡_no°Æe
,

300 .
	ggë_∑ª¡
 = 
Át_gë_∑ª¡
,

	@vfat.mod.c

1 
	~<löux/moduÀ.h
>

2 
	~<löux/vîmagic.h
>

3 
	~<löux/compûî.h
>

5 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

7 
moduÀ
 
__this_moduÀ


8 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

9 .
«me
 = 
KBUILD_MODNAME
,

10 .
	göô
 = 
öô_moduÀ
,

11 #ifde‡
CONFIG_MODULE_UNLOAD


12 .
	gexô
 = 
˛ónup_moduÀ
,

14 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

17 c⁄° 
modvîsi⁄_öfo
 
	g____vîsi⁄s
[]

18 
__u£d


19 
__©åibuã__
((
£˘i⁄
("__versions"))) = {

20 { 0x1da0d6ˇ, 
__VMLINUX_SYMBOL_STR
(
moduÀ_œyout
) },

21 { 0x7b99eb2f, 
__VMLINUX_SYMBOL_STR
(
Át_dëach
) },

22 { 0x„6823e6, 
__VMLINUX_SYMBOL_STR
(
kmÆloc_ˇches
) },

23 { 0x405c1144, 
__VMLINUX_SYMBOL_STR
(
gë_£c⁄ds
) },

24 { 0x11e0e337, 
__VMLINUX_SYMBOL_STR
(
dr›_∆ök
) },

25 { 0xa675804c, 
__VMLINUX_SYMBOL_STR
(
utf8s_to_utf16s
) },

26 { 0x343ff613, 
__VMLINUX_SYMBOL_STR
(
m¨k_buf„r_dúty_öode
) },

27 { 0xd6fbe4Á, 
__VMLINUX_SYMBOL_STR
(
__m¨k_öode_dúty
) },

28 { 0xadØbe1b, 
__VMLINUX_SYMBOL_STR
(
pv_lock_›s
) },

29 { 0xe69f429b, 
__VMLINUX_SYMBOL_STR
(
dput
) },

30 { 0x˚e11ccc, 
__VMLINUX_SYMBOL_STR
(
öc_∆ök
) },

31 { 0x8b486917, 
__VMLINUX_SYMBOL_STR
(
d_föd_Æüs
) },

32 { 0xb1bf412a, 
__VMLINUX_SYMBOL_STR
(
«mes_ˇchï
) },

33 { 0xe48e40c2, 
__VMLINUX_SYMBOL_STR
(
muãx_u∆ock
) },

34 { 0x71Á22b6, 
__VMLINUX_SYMBOL_STR
(
mou¡_bdev
) },

35 { 0xa973be29, 
__VMLINUX_SYMBOL_STR
(
Át_sync_öode
) },

36 { 0x5f044076, 
__VMLINUX_SYMBOL_STR
(
Át_add_íåõs
) },

37 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiffõs
) },

38 { 0x4717´d7, 
__VMLINUX_SYMBOL_STR
(
Át_ªmove_íåõs
) },

39 { 0xf65d7f98, 
__VMLINUX_SYMBOL_STR
(
Át_Æloc_√w_dú
) },

40 { 0x4502602a, 
__VMLINUX_SYMBOL_STR
(
Át_fûl_su≥r
) },

41 { 0x19ed1f80, 
__VMLINUX_SYMBOL_STR
(
Át_buûd_öode
) },

42 { 0x11089ac7, 
__VMLINUX_SYMBOL_STR
(
_˘y≥
) },

43 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
¥ötk
) },

44 { 0x604„828, 
__VMLINUX_SYMBOL_STR
(
Át_©èch
) },

45 { 0xa1c4c12, 
__VMLINUX_SYMBOL_STR
(
d_move
) },

46 { 0x5a921311, 
__VMLINUX_SYMBOL_STR
(
°∫cmp
) },

47 { 0x626ac375, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_‰ì
) },

48 { 0xf676ffba, 
__VMLINUX_SYMBOL_STR
(
muãx_lock
) },

49 { 0xa7190c66, 
__VMLINUX_SYMBOL_STR
(
£t_∆ök
) },

50 { 0xìb684a5, 
__VMLINUX_SYMBOL_STR
(
Át_upd©e_su≥r
) },

51 { 0x29009cbb, 
__VMLINUX_SYMBOL_STR
(
sync_dúty_buf„r
) },

52 { 0xe2338745, 
__VMLINUX_SYMBOL_STR
(
Át_gë©å
) },

53 { 0x4Ø4713, 
__VMLINUX_SYMBOL_STR
(
__bªl£
) },

54 { 0x5590a034, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc
) },

55 { 0xf0fdf6cb, 
__VMLINUX_SYMBOL_STR
(
__°ack_chk_Áû
) },

56 { 0xfc77c68f, 
__VMLINUX_SYMBOL_STR
(
kûl_block_su≥r
) },

57 { 0x359df40c, 
__VMLINUX_SYMBOL_STR
(
Át_£¨ch_l⁄g
) },

58 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__„¡ry__
) },

59 { 0x6f20960a, 
__VMLINUX_SYMBOL_STR
(
fuŒ_«me_hash
) },

60 { 0xcff920ef, 
__VMLINUX_SYMBOL_STR
(
time_‹dîög
) },

61 { 0x721679Ø, 
__VMLINUX_SYMBOL_STR
(
kmem_ˇche_Æloc_åa˚
) },

62 { 0xd52bf1˚, 
__VMLINUX_SYMBOL_STR
(
_øw_•ö_lock
) },

63 { 0xì6ba18e, 
__VMLINUX_SYMBOL_STR
(
Át_sˇn
) },

64 { 0xcc6b3a62, 
__VMLINUX_SYMBOL_STR
(
ªgi°î_fûesy°em
) },

65 { 0x3bf18c78, 
__VMLINUX_SYMBOL_STR
(
__Át_fs_îr‹
) },

66 { 0x1cd1ba02, 
__VMLINUX_SYMBOL_STR
(
ùut
) },

67 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
k‰ì
) },

68 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
mem˝y
) },

69 { 0xa03164af, 
__VMLINUX_SYMBOL_STR
(
d_•li˚_Æüs
) },

70 { 0x6cba5ba3, 
__VMLINUX_SYMBOL_STR
(
Át_£èâr
) },

71 { 0xc4b795b4, 
__VMLINUX_SYMBOL_STR
(
Át_‰ì_˛u°îs
) },

72 { 0x3a943293, 
__VMLINUX_SYMBOL_STR
(
Át_gë_dŸdŸ_íåy
) },

73 { 0xe6366e14, 
__VMLINUX_SYMBOL_STR
(
uƒegi°î_fûesy°em
) },

74 { 0x7bfbb668, 
__VMLINUX_SYMBOL_STR
(
Át_time_unix2Át
) },

75 { 0x28318305, 
__VMLINUX_SYMBOL_STR
(
¢¥ötf
) },

76 { 0xc60e0af5, 
__VMLINUX_SYMBOL_STR
(
Át_dú_em±y
) },

77 { 0xcc709d8a, 
__VMLINUX_SYMBOL_STR
(
d_ö°™tüã
) },

78 { 0xó06e503, 
__VMLINUX_SYMBOL_STR
(
˛ór_∆ök
) },

81 c⁄° 
	g__moduÀ_dïíds
[]

82 
__u£d


83 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

87 
MODULE_INFO
(
§cvîsi⁄
, "476437E0976B53519F34AD7");

	@/usr/include/linux/capability.h

13 #i‚de‡
_LINUX_CAPABILITY_H


14 
	#_LINUX_CAPABILITY_H


	)

16 
	~<löux/ty≥s.h
>

18 
	gèsk_°ru˘
;

31 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

32 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

34 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

35 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

37 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

38 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

40 
	s__u£r_ˇp_hódî_°ru˘
 {

41 
__u32
 
	mvîsi⁄
;

42 
	mpid
;

43 } *
	tˇp_u£r_hódî_t
;

45 
	s__u£r_ˇp_d©a_°ru˘
 {

46 
__u32
 
	mef„˘ive
;

47 
__u32
 
	m≥rmôãd
;

48 
__u32
 
	möhîôabÀ
;

49 } *
	tˇp_u£r_d©a_t
;

52 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

53 
	#VFS_CAP_REVISION_SHIFT
 24

	)

54 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

55 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

57 
	#VFS_CAP_REVISION_1
 0x01000000

	)

58 
	#VFS_CAP_U32_1
 1

	)

59 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

61 
	#VFS_CAP_REVISION_2
 0x02000000

	)

62 
	#VFS_CAP_U32_2
 2

	)

63 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

65 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_2


	)

66 
	#VFS_CAP_U32
 
VFS_CAP_U32_2


	)

67 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_2


	)

69 
	svfs_ˇp_d©a
 {

70 
__À32
 
	mmagic_ëc
;

72 
__À32
 
	m≥rmôãd
;

73 
__À32
 
	möhîôabÀ
;

74 } 
	md©a
[
VFS_CAP_U32
];

83 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

84 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

96 
	#CAP_CHOWN
 0

	)

102 
	#CAP_DAC_OVERRIDE
 1

	)

108 
	#CAP_DAC_READ_SEARCH
 2

	)

114 
	#CAP_FOWNER
 3

	)

123 
	#CAP_FSETID
 4

	)

129 
	#CAP_KILL
 5

	)

135 
	#CAP_SETGID
 6

	)

140 
	#CAP_SETUID
 7

	)

157 
	#CAP_SETPCAP
 8

	)

161 
	#CAP_LINUX_IMMUTABLE
 9

	)

166 
	#CAP_NET_BIND_SERVICE
 10

	)

170 
	#CAP_NET_BROADCAST
 11

	)

186 
	#CAP_NET_ADMIN
 12

	)

192 
	#CAP_NET_RAW
 13

	)

198 
	#CAP_IPC_LOCK
 14

	)

202 
	#CAP_IPC_OWNER
 15

	)

205 
	#CAP_SYS_MODULE
 16

	)

210 
	#CAP_SYS_RAWIO
 17

	)

214 
	#CAP_SYS_CHROOT
 18

	)

218 
	#CAP_SYS_PTRACE
 19

	)

222 
	#CAP_SYS_PACCT
 20

	)

261 
	#CAP_SYS_ADMIN
 21

	)

265 
	#CAP_SYS_BOOT
 22

	)

274 
	#CAP_SYS_NICE
 23

	)

288 
	#CAP_SYS_RESOURCE
 24

	)

294 
	#CAP_SYS_TIME
 25

	)

299 
	#CAP_SYS_TTY_CONFIG
 26

	)

303 
	#CAP_MKNOD
 27

	)

307 
	#CAP_LEASE
 28

	)

309 
	#CAP_AUDIT_WRITE
 29

	)

311 
	#CAP_AUDIT_CONTROL
 30

	)

313 
	#CAP_SETFCAP
 31

	)

321 
	#CAP_MAC_OVERRIDE
 32

	)

330 
	#CAP_MAC_ADMIN
 33

	)

334 
	#CAP_SYSLOG
 34

	)

338 
	#CAP_WAKE_ALARM
 35

	)

342 
	#CAP_BLOCK_SUSPEND
 36

	)

344 
	#CAP_LAST_CAP
 
CAP_BLOCK_SUSPEND


	)

346 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

352 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

353 
	#CAP_TO_MASK
(
x
Ë(1 << ((xË& 31)Ë

	)

	@/usr/include/linux/fs.h

1 #i‚de‡
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<löux/limôs.h
>

10 
	~<löux/io˘l.h
>

11 
	~<löux/ty≥s.h
>

24 #unde‡
NR_OPEN


25 
	#INR_OPEN_CUR
 1024

	)

26 
	#INR_OPEN_MAX
 4096

	)

28 
	#BLOCK_SIZE_BITS
 10

	)

29 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

31 
	#SEEK_SET
 0

	)

32 
	#SEEK_CUR
 1

	)

33 
	#SEEK_END
 2

	)

34 
	#SEEK_DATA
 3

	)

35 
	#SEEK_HOLE
 4

	)

36 
	#SEEK_MAX
 
SEEK_HOLE


	)

38 
	sf°rim_ønge
 {

39 
__u64
 
	m°¨t
;

40 
__u64
 
	mÀn
;

41 
__u64
 
	mmöÀn
;

45 
	sfûes_°©_°ru˘
 {

46 
	mƒ_fûes
;

47 
	mƒ_‰ì_fûes
;

48 
	mmax_fûes
;

51 
	söodes_°©_t
 {

52 
	mƒ_öodes
;

53 
	mƒ_unu£d
;

54 
	mdummy
[5];

58 
	#NR_FILE
 8192

	)

64 
	#MS_RDONLY
 1

	)

65 
	#MS_NOSUID
 2

	)

66 
	#MS_NODEV
 4

	)

67 
	#MS_NOEXEC
 8

	)

68 
	#MS_SYNCHRONOUS
 16

	)

69 
	#MS_REMOUNT
 32

	)

70 
	#MS_MANDLOCK
 64

	)

71 
	#MS_DIRSYNC
 128

	)

72 
	#MS_NOATIME
 1024

	)

73 
	#MS_NODIRATIME
 2048

	)

74 
	#MS_BIND
 4096

	)

75 
	#MS_MOVE
 8192

	)

76 
	#MS_REC
 16384

	)

77 
	#MS_VERBOSE
 32768

	)

79 
	#MS_SILENT
 32768

	)

80 
	#MS_POSIXACL
 (1<<16Ë

	)

81 
	#MS_UNBINDABLE
 (1<<17Ë

	)

82 
	#MS_PRIVATE
 (1<<18Ë

	)

83 
	#MS_SLAVE
 (1<<19Ë

	)

84 
	#MS_SHARED
 (1<<20Ë

	)

85 
	#MS_RELATIME
 (1<<21Ë

	)

86 
	#MS_KERNMOUNT
 (1<<22Ë

	)

87 
	#MS_I_VERSION
 (1<<23Ë

	)

88 
	#MS_STRICTATIME
 (1<<24Ë

	)

91 
	#MS_NOSEC
 (1<<28)

	)

92 
	#MS_BORN
 (1<<29)

	)

93 
	#MS_ACTIVE
 (1<<30)

	)

94 
	#MS_NOUSER
 (1<<31)

	)

99 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
)

	)

104 
	#MS_MGC_VAL
 0xC0ED0000

	)

105 
	#MS_MGC_MSK
 0xffff0000

	)

110 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

111 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

112 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

113 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

114 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

115 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

116 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

117 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

118 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

119 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

120 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

121 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

123 
	#BLKPG
 
	`_IO
(0x12,105)

	)

127 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

128 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

133 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

134 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

135 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

136 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

137 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

138 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

139 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

140 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

141 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

142 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

143 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

144 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

145 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

146 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

147 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

148 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

150 
	#BMAP_IOCTL
 1

	)

151 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

152 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

153 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

154 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

155 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

157 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

158 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

159 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

160 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

161 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

162 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

163 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

164 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

165 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

170 
	#FS_SECRM_FL
 0x00000001

	)

171 
	#FS_UNRM_FL
 0x00000002

	)

172 
	#FS_COMPR_FL
 0x00000004

	)

173 
	#FS_SYNC_FL
 0x00000008

	)

174 
	#FS_IMMUTABLE_FL
 0x00000010

	)

175 
	#FS_APPEND_FL
 0x00000020

	)

176 
	#FS_NODUMP_FL
 0x00000040

	)

177 
	#FS_NOATIME_FL
 0x00000080

	)

179 
	#FS_DIRTY_FL
 0x00000100

	)

180 
	#FS_COMPRBLK_FL
 0x00000200

	)

181 
	#FS_NOCOMP_FL
 0x00000400

	)

182 
	#FS_ECOMPR_FL
 0x00000800

	)

184 
	#FS_BTREE_FL
 0x00001000

	)

185 
	#FS_INDEX_FL
 0x00001000

	)

186 
	#FS_IMAGIC_FL
 0x00002000

	)

187 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

188 
	#FS_NOTAIL_FL
 0x00008000

	)

189 
	#FS_DIRSYNC_FL
 0x00010000

	)

190 
	#FS_TOPDIR_FL
 0x00020000

	)

191 
	#FS_EXTENT_FL
 0x00080000

	)

192 
	#FS_DIRECTIO_FL
 0x00100000

	)

193 
	#FS_NOCOW_FL
 0x00800000

	)

194 
	#FS_RESERVED_FL
 0x80000000

	)

196 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

197 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

200 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

201 
	#SYNC_FILE_RANGE_WRITE
 2

	)

202 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/kernel.h

1 #i‚de‡
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<löux/sysöfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

	@/usr/include/linux/msdos_fs.h

1 #i‚de‡
_LINUX_MSDOS_FS_H


2 
	#_LINUX_MSDOS_FS_H


	)

4 
	~<löux/ty≥s.h
>

5 
	~<löux/magic.h
>

6 
	~<asm/byã‹dî.h
>

12 
	#SECTOR_SIZE
 512

	)

13 
	#SECTOR_BITS
 9

	)

14 
	#MSDOS_DPB
 (
MSDOS_DPS
Ë

	)

15 
	#MSDOS_DPB_BITS
 4

	)

16 
	#MSDOS_DPS
 (
SECTOR_SIZE
 / (
msdos_dú_íåy
))

	)

17 
	#MSDOS_DPS_BITS
 4

	)

18 
	#MSDOS_LONGNAME
 256

	)

19 
	#CF_LE_W
(
v
Ë
	`À16_to_˝u
(v)

	)

20 
	#CF_LE_L
(
v
Ë
	`À32_to_˝u
(v)

	)

21 
	#CT_LE_W
(
v
Ë
	`˝u_to_À16
(v)

	)

22 
	#CT_LE_L
(
v
Ë
	`˝u_to_À32
(v)

	)

24 
	#MSDOS_ROOT_INO
 1

	)

25 
	#MSDOS_FSINFO_INO
 2

	)

27 
	#MSDOS_DIR_BITS
 5

	)

30 
	#FAT_MAX_DIR_ENTRIES
 (65536)

	)

31 
	#FAT_MAX_DIR_SIZE
 (
FAT_MAX_DIR_ENTRIES
 << 
MSDOS_DIR_BITS
)

	)

33 
	#ATTR_NONE
 0

	)

34 
	#ATTR_RO
 1

	)

35 
	#ATTR_HIDDEN
 2

	)

36 
	#ATTR_SYS
 4

	)

37 
	#ATTR_VOLUME
 8

	)

38 
	#ATTR_DIR
 16

	)

39 
	#ATTR_ARCH
 32

	)

42 
	#ATTR_UNUSED
 (
ATTR_VOLUME
 | 
ATTR_ARCH
 | 
ATTR_SYS
 | 
ATTR_HIDDEN
)

	)

44 
	#ATTR_EXT
 (
ATTR_RO
 | 
ATTR_HIDDEN
 | 
ATTR_SYS
 | 
ATTR_VOLUME
)

	)

46 
	#CASE_LOWER_BASE
 8

	)

47 
	#CASE_LOWER_EXT
 16

	)

49 
	#DELETED_FLAG
 0xe5

	)

50 
	#IS_FREE
(
n
Ë(!*“Ë|| *“Ë=
DELETED_FLAG
)

	)

52 
	#FAT_LFN_LEN
 255

	)

53 
	#MSDOS_NAME
 11

	)

54 
	#MSDOS_SLOTS
 21

	)

55 
	#MSDOS_DOT
 ". "

	)

56 
	#MSDOS_DOTDOT
 ".. "

	)

58 
	#FAT_FIRST_ENT
(
s
, 
x
Ë((
	`MSDOS_SB
(s)->
Át_bôs
 == 32 ? 0x0FFFFF00 : \

59 
	`MSDOS_SB
(
s
)->
Át_bôs
 =16 ? 0xFF00 : 0xF00Ë| (
x
))

	)

62 
	#FAT_START_ENT
 2

	)

65 
	#MAX_FAT12
 0xFF4

	)

66 
	#MAX_FAT16
 0xFFF4

	)

67 
	#MAX_FAT32
 0x0FFFFFF6

	)

68 
	#MAX_FAT
(
s
Ë(
	`MSDOS_SB
(s)->
Át_bôs
 =32 ? 
MAX_FAT32
 : \

69 
	`MSDOS_SB
(
s
)->
Át_bôs
 =16 ? 
MAX_FAT16
 : 
MAX_FAT12
)

	)

72 
	#BAD_FAT12
 0xFF7

	)

73 
	#BAD_FAT16
 0xFFF7

	)

74 
	#BAD_FAT32
 0x0FFFFFF7

	)

77 
	#EOF_FAT12
 0xFFF

	)

78 
	#EOF_FAT16
 0xFFFF

	)

79 
	#EOF_FAT32
 0x0FFFFFFF

	)

81 
	#FAT_ENT_FREE
 (0)

	)

82 
	#FAT_ENT_BAD
 (
BAD_FAT32
)

	)

83 
	#FAT_ENT_EOF
 (
EOF_FAT32
)

	)

85 
	#FAT_FSINFO_SIG1
 0x41615252

	)

86 
	#FAT_FSINFO_SIG2
 0x61417272

	)

87 
	#IS_FSINFO
(
x
Ë(
	`À32_to_˝u
((x)->
sig«tuª1
Ë=
FAT_FSINFO_SIG1
 \

88 && 
	`À32_to_˝u
((
x
)->
sig«tuª2
Ë=
FAT_FSINFO_SIG2
)

	)

90 
	#FAT_STATE_DIRTY
 0x01

	)

92 
	s__Át_dúít
 {

93 
	md_öo
;

94 
__kî√l_off_t
 
	md_off
;

95 
	md_ª˛í
;

96 
	md_«me
[256];

102 
	#VFAT_IOCTL_READDIR_BOTH
 
	`_IOR
('r', 1, 
__Át_dúít
[2])

	)

103 
	#VFAT_IOCTL_READDIR_SHORT
 
	`_IOR
('r', 2, 
__Át_dúít
[2])

	)

105 
	#FAT_IOCTL_GET_ATTRIBUTES
 
	`_IOR
('r', 0x10, 
__u32
)

	)

106 
	#FAT_IOCTL_SET_ATTRIBUTES
 
	`_IOW
('r', 0x11, 
__u32
)

	)

108 
	#FAT_IOCTL_GET_VOLUME_ID
 
	`_IOR
('r', 0x13, 
__u32
)

	)

110 
	sÁt_boŸ_£˘‹
 {

111 
__u8
 
	mign‹ed
[3];

112 
__u8
 
	msy°em_id
[8];

114 
__u8
 
	m£˘‹_size
[2];

115 
__u8
 
	m£c_≥r_˛us
;

116 
__À16
 
	mª£rved
;

117 
__u8
 
	mÁts
;

118 
__u8
 
	mdú_íåõs
[2];

119 
__u8
 
	m£˘‹s
[2];

120 
__u8
 
	mmedü
;

121 
__À16
 
	mÁt_Àngth
;

122 
__À16
 
	m£cs_åack
;

123 
__À16
 
	mhóds
;

124 
__À32
 
	mhiddí
;

125 
__À32
 
	mtŸÆ_£˘
;

130 
__u8
 
	mdrive_numbî
;

131 
__u8
 
	m°©e
;

133 
__u8
 
	msig«tuª
;

134 
__u8
 
	mvﬁ_id
[4];

135 
__u8
 
	mvﬁ_œbñ
[11];

136 
__u8
 
	mfs_ty≥
[8];

138 } 
	mÁt16
;

142 
__À32
 
	mÀngth
;

143 
__À16
 
	mÊags
;

145 
__u8
 
	mvîsi⁄
[2];

147 
__À32
 
	mroŸ_˛u°î
;

149 
__À16
 
	möfo_£˘‹
;

150 
__À16
 
	mbackup_boŸ
;

151 
__À16
 
	mª£rved2
[6];

153 
__u8
 
	mdrive_numbî
;

154 
__u8
 
	m°©e
;

156 
__u8
 
	msig«tuª
;

157 
__u8
 
	mvﬁ_id
[4];

158 
__u8
 
	mvﬁ_œbñ
[11];

159 
__u8
 
	mfs_ty≥
[8];

161 } 
	mÁt32
;

165 
	sÁt_boŸ_fsöfo
 {

166 
__À32
 
	msig«tuª1
;

167 
__À32
 
	mª£rved1
[120];

168 
__À32
 
	msig«tuª2
;

169 
__À32
 
	m‰ì_˛u°îs
;

170 
__À32
 
	m√xt_˛u°î
;

171 
__À32
 
	mª£rved2
[4];

174 
	smsdos_dú_íåy
 {

175 
__u8
 
	m«me
[
MSDOS_NAME
];

176 
__u8
 
	m©å
;

177 
__u8
 
	mlˇ£
;

178 
__u8
 
	m˘ime_cs
;

179 
__À16
 
	m˘ime
;

180 
__À16
 
	mcd©e
;

181 
__À16
 
	mad©e
;

182 
__À16
 
	m°¨thi
;

183 
__À16
 
	mtime
,
	md©e
,
	m°¨t
;

184 
__À32
 
	msize
;

188 
	smsdos_dú_¶Ÿ
 {

189 
__u8
 
	mid
;

190 
__u8
 
	m«me0_4
[10];

191 
__u8
 
	m©å
;

192 
__u8
 
	mª£rved
;

193 
__u8
 
	mÆüs_checksum
;

194 
__u8
 
	m«me5_10
[12];

195 
__À16
 
	m°¨t
;

196 
__u8
 
	m«me11_12
[4];

	@/usr/include/linux/string.h

1 #i‚de‡
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

6 
	~<°rög.h
>

	@/usr/include/linux/time.h

1 #i‚de‡
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	~<löux/ty≥s.h
>

7 #i‚de‡
_STRUCT_TIMESPEC


8 
	#_STRUCT_TIMESPEC


	)

9 
	stime•ec
 {

10 
__kî√l_time_t
 
	mtv_£c
;

11 
	mtv_n£c
;

15 
	stimevÆ
 {

16 
__kî√l_time_t
 
	mtv_£c
;

17 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

20 
	stimez⁄e
 {

21 
	mtz_möuãswe°
;

22 
	mtz_d°time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	sôimî•ec
 {

35 
time•ec
 
	mô_öãrvÆ
;

36 
time•ec
 
	mô_vÆue
;

39 
	sôimîvÆ
 {

40 
timevÆ
 
	mô_öãrvÆ
;

41 
timevÆ
 
	mô_vÆue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

57 
	#CLOCK_SGI_CYCLE
 10

	)

58 
	#CLOCK_TAI
 11

	)

60 
	#MAX_CLOCKS
 16

	)

61 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

62 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

67 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/uio.h

9 #i‚de‡
__LINUX_UIO_H


10 
	#__LINUX_UIO_H


	)

13 
	~<löux/ty≥s.h
>

16 
	siovec


18 *
	miov_ba£
;

19 
__kî√l_size_t
 
	miov_Àn
;

26 
	#UIO_FASTIOV
 8

	)

27 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/ioctl.h

1 #i‚de‡
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/io˘l.h
>

	@/usr/include/linux/limits.h

1 #i‚de‡
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/magic.h

1 #i‚de‡
__LINUX_MAGIC_H__


2 
	#__LINUX_MAGIC_H__


	)

4 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

5 
	#AFFS_SUPER_MAGIC
 0xadff

	)

6 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

7 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

8 
	#CODA_SUPER_MAGIC
 0x73757245

	)

9 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

10 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

11 
	#DEBUGFS_MAGIC
 0x64626720

	)

12 
	#SECURITYFS_MAGIC
 0x73636673

	)

13 
	#SELINUX_MAGIC
 0xf97cff8c

	)

14 
	#SMACK_MAGIC
 0x43415d53

	)

15 
	#RAMFS_MAGIC
 0x858458f6

	)

16 
	#TMPFS_MAGIC
 0x01021994

	)

17 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

18 
	#SQUASHFS_MAGIC
 0x73717368

	)

19 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

20 
	#EFS_SUPER_MAGIC
 0x414A53

	)

21 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

22 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

23 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

24 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

25 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

26 
	#NILFS_SUPER_MAGIC
 0x3434

	)

27 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

28 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

29 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

30 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

31 
	#PSTOREFS_MAGIC
 0x6165676C

	)

32 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

33 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

35 
	#MINIX_SUPER_MAGIC
 0x137F

	)

36 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

37 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

38 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

39 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

41 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

42 
	#NCP_SUPER_MAGIC
 0x564¯

	)

43 
	#NFS_SUPER_MAGIC
 0x6969

	)

44 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

45 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

46 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

48 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

51 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

52 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

53 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

55 
	#SMB_SUPER_MAGIC
 0x517B

	)

56 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

59 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

61 
	#V9FS_MAGIC
 0x01021997

	)

63 
	#BDEVFS_MAGIC
 0x62646576

	)

64 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

65 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

66 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

67 
	#PIPEFS_MAGIC
 0x50495045

	)

68 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

69 
	#SOCKFS_MAGIC
 0x534F434B

	)

70 
	#SYSFS_MAGIC
 0x62656572

	)

71 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

72 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

73 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

74 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

	@/usr/include/linux/sysinfo.h

1 #i‚de‡
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<löux/ty≥s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysöfo
 {

8 
__kî√l_l⁄g_t
 
	mu±ime
;

9 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

10 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

11 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

12 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

13 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

14 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

15 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

16 
__u16
 
	m¥ocs
;

17 
__u16
 
	m∑d
;

18 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

19 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

20 
__u32
 
	mmem_unô
;

21 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/linux/types.h

1 #i‚de‡
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty≥s.h
>

6 #i‚de‡
__ASSEMBLY__


8 
	~<löux/posix_ty≥s.h
>

16 #ifde‡
__CHECKER__


17 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

19 
	#__bôwi£__


	)

21 #ifde‡
__CHECK_ENDIAN__


22 
	#__bôwi£
 
__bôwi£__


	)

24 
	#__bôwi£


	)

27 
__u16
 
	t__bôwi£
 
	t__À16
;

28 
__u16
 
	t__bôwi£
 
	t__be16
;

29 
__u32
 
	t__bôwi£
 
	t__À32
;

30 
__u32
 
	t__bôwi£
 
	t__be32
;

31 
__u64
 
	t__bôwi£
 
	t__À64
;

32 
__u64
 
	t__bôwi£
 
	t__be64
;

34 
__u16
 
	t__bôwi£
 
	t__sum16
;

35 
__u32
 
	t__bôwi£
 
	t__wsum
;

46 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

47 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

48 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<„©uªs.h
>

27 
	g__BEGIN_DECLS


30 
	#__√ed_size_t


	)

31 
	#__√ed_NULL


	)

32 
	~<°ddef.h
>

39 #i‡
deföed
 
__˝lu•lus
 && (__˝lu•lu†>199711L || 
__GNUC_PREREQ
 (4, 4))

40 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

44 
__BEGIN_NAMESPACE_STD


46 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

47 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

50 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

51 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

52 
__END_NAMESPACE_STD


57 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN


58 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

59 
__c
, 
size_t
 
__n
)

60 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

64 
__BEGIN_NAMESPACE_STD


66 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

69 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

70 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

73 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


76 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

77 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

79 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #ifde‡
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


85  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


91  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

94 
	}
}

96 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

99 
__END_NAMESPACE_STD


101 #ifde‡
__USE_GNU


104 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


105 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

106 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

107 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

108 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

110 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

111 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

115 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


116 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

117 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

118 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

119 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

121 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

122 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

127 
__BEGIN_NAMESPACE_STD


129 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

132 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

133 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

134 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

137 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

138 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

140 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

141 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

144 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

145 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

147 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

148 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

151 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

152 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

154 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

155 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

156 
__THROW
 
	`__n⁄nuŒ
 ((2));

157 
__END_NAMESPACE_STD


159 #ifde‡
__USE_XOPEN2K8


163 
	~<xloˇÀ.h
>

166 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
__loˇÀ_t
 
__l
)

167 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

169 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

170 
__loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

173 #i‡
deföed
 
__USE_SVID
 || deföed 
__USE_BSD
 || deföed 
__USE_XOPEN_EXTENDED
 \

174 || 
deföed
 
__USE_XOPEN2K8


176 *
	$°rdup
 (c⁄° *
__s
)

177 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

183 #i‡
deföed
 
__USE_XOPEN2K8


184 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

185 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

188 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


190 
	#°rdu∑
(
s
) \

191 (
__exãnsi⁄__
 \

193 c⁄° *
__ﬁd
 = (
s
); \

194 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

195 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

196 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

197 
	}
}))

	)

200 
	#°∫du∑
(
s
, 
n
) \

201 (
__exãnsi⁄__
 \

203 c⁄° *
__ﬁd
 = (
s
); \

204 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

205 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

206 
__√w
[
__Àn
] = '\0'; \

207 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

208 }))

	)

211 
	g__BEGIN_NAMESPACE_STD


213 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


216 *
°rchr
 (*
__s
, 
__c
)

217 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

218 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

219 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

221 #ifde‡
__OPTIMIZE__


222 
__exã∫_Æways_ölöe
 *

223 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


225  
__buûtö_°rchr
 (
__s
, 
__c
);

228 
__exã∫_Æways_ölöe
 const *

229 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


231  
__buûtö_°rchr
 (
__s
, 
__c
);

236 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

237 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

240 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


243 *
	`°ºchr
 (*
__s
, 
__c
)

244 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

245 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

246 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

248 #ifde‡
__OPTIMIZE__


249 
__exã∫_Æways_ölöe
 *

250 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


252  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

255 
__exã∫_Æways_ölöe
 const *

256 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


258  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

261 
	}
}

263 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

264 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

266 
__END_NAMESPACE_STD


268 #ifde‡
__USE_GNU


271 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


272 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

273 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

274 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

275 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

277 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

278 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

282 
__BEGIN_NAMESPACE_STD


285 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

286 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

289 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

290 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

292 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


295 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

296 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

297 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

298 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

300 #ifde‡
__OPTIMIZE__


301 
__exã∫_Æways_ölöe
 *

302 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


304  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

307 
__exã∫_Æways_ölöe
 const *

308 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


310  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

313 
	}
}

315 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

316 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

319 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


322 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

323 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

324 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

325 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

327 #ifde‡
__OPTIMIZE__


328 
__exã∫_Æways_ölöe
 *

329 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


331  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

334 
__exã∫_Æways_ölöe
 const *

335 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


337  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

340 
	}
}

342 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

343 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

348 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

349 
__THROW
 
	`__n⁄nuŒ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

355 c⁄° *
__ª°ri˘
 
__dñim
,

356 **
__ª°ri˘
 
__ßve_±r
)

357 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

358 #i‡
deföed
 
__USE_POSIX
 || deföed 
__USE_MISC


359 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

360 **
__ª°ri˘
 
__ßve_±r
)

361 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

364 #ifde‡
__USE_GNU


366 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

368 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

369 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

370 c⁄° *
__√edÀ
)

371 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

373 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

374 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

378 #ifde‡
__USE_GNU


382 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

383 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

384 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

388 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

389 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

390 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

391 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

392 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

393 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$°æí
 (c⁄° *
__s
)

400 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

407 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

414 
__END_NAMESPACE_STD


415 #i‡
deföed
 
__USE_XOPEN2K
 || deföed 
__USE_MISC


423 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


426 #ifde‡
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

428 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

429 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

431 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

432 
__THROW
 
	`__n⁄nuŒ
 ((2));

433 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

438 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

439 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

443 #ifde‡
__USE_XOPEN2K8


445 *
	$°ªº‹_l
 (
__î∫um
, 
__loˇÀ_t
 
__l
Ë
__THROW
;

451 
	$__bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

453 #ifde‡
__USE_BSD


455 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

456 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

459 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

462 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

466 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`ödex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

471 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

474 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__exã∫_Æways_ölöe
 *

476 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


478  
	`__buûtö_ödex
 (
__s
, 
__c
);

481 
__exã∫_Æways_ölöe
 const *

482 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


484  
	`__buûtö_ödex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$ödex
 (c⁄° *
__s
, 
__c
)

490 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

494 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`rödex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

499 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

502 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__exã∫_Æways_ölöe
 *

504 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


506  
	`__buûtö_rödex
 (
__s
, 
__c
);

509 
__exã∫_Æways_ölöe
 const *

510 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


512  
	`__buûtö_rödex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$rödex
 (c⁄° *
__s
, 
__c
)

518 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

523 
	$ffs
 (
__i
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

527 #ifdef 
__USE_GNU


528 
	$ff¶
 (
__l
Ë
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

529 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

530 
__THROW
 
	`__©åibuã__
 ((
__c⁄°__
));

534 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

535 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

538 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

539 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

542 #ifdef 
__USE_GNU


545 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

546 
__loˇÀ_t
 
__loc
)

547 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

549 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

550 
size_t
 
__n
, 
__loˇÀ_t
 
__loc
)

551 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

554 #ifdef 
__USE_BSD


557 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

558 c⁄° *
__ª°ri˘
 
__dñim
)

559 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

562 #ifdef 
__USE_XOPEN2K8


564 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

567 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

568 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

569 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

570 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

574 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

575 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

576 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

577 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

578 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

579 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

582 #ifdef 
__USE_GNU


584 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

585 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

588 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

591 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

593 #i‚de‡
ba£«me


598 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


599 "C++" *
	$ba£«me
 (*
__fûíame
)

600 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

601 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

602 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

604 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

610 #i‡
deföed
 
__GNUC__
 && __GNUC__ >= 2

611 #i‡
deföed
 
__OPTIMIZE__
 && !deföed 
__OPTIMIZE_SIZE__
 \

612 && !
deföed
 
__NO_INLINE__
 && !deföed 
__˝lu•lus


632 
	~<bôs/°rög.h
>

635 
	~<bôs/°rög2.h
>

638 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


640 
	~<bôs/°rög3.h
>

644 
__END_DECLS


	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #unde‡
__USE_ISOC11


102 #unde‡
__USE_ISOC99


103 #unde‡
__USE_ISOC95


104 #unde‡
__USE_ISOCXX11


105 #unde‡
__USE_POSIX


106 #unde‡
__USE_POSIX2


107 #unde‡
__USE_POSIX199309


108 #unde‡
__USE_POSIX199506


109 #unde‡
__USE_XOPEN


110 #unde‡
__USE_XOPEN_EXTENDED


111 #unde‡
__USE_UNIX98


112 #unde‡
__USE_XOPEN2K


113 #unde‡
__USE_XOPEN2KXSI


114 #unde‡
__USE_XOPEN2K8


115 #unde‡
__USE_XOPEN2K8XSI


116 #unde‡
__USE_LARGEFILE


117 #unde‡
__USE_LARGEFILE64


118 #unde‡
__USE_FILE_OFFSET64


119 #unde‡
__USE_BSD


120 #unde‡
__USE_SVID


121 #unde‡
__USE_MISC


122 #unde‡
__USE_ATFILE


123 #unde‡
__USE_GNU


124 #unde‡
__USE_REENTRANT


125 #unde‡
__USE_FORTIFY_LEVEL


126 #unde‡
__KERNEL_STRICT_NAMES


130 #i‚de‡
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

143 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

150 #ifde‡
_GNU_SOURCE


151 #unde‡
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #unde‡
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #unde‡
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #unde‡
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #unde‡
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #unde‡
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #unde‡
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #unde‡
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #unde‡
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #unde‡
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #unde‡
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #unde‡
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

180 || (!
deföed
 
	g__STRICT_ANSI__
 \

181 && !
deföed
 
	g_ISOC99_SOURCE
 \

182 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

183 && !
deföed
 
	g_XOPEN_SOURCE
 \

184 && !
deföed
 
	g_BSD_SOURCE
 && !deföed 
	g_SVID_SOURCE
))

185 #unde‡
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #unde‡
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #unde‡
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #i‡(
deföed
 
_ISOC11_SOURCE
 \

195 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

201 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

207 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #i‡((
deföed
 
__˝lu•lus
 && __cplusplus >= 201103L) \

216 || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifde‡
_DEFAULT_SOURCE


224 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #unde‡
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #unde‡
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #i‡((!
deföed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #i‡
deföed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >1 || deföed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #i‡(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #unde‡
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #unde‡
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #i‡(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #unde‡
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #unde‡
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

285 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #unde‡
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #unde‡
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifde‡
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifde‡
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifde‡
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #i‡
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #i‡
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #i‡
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<°dc-¥edef.h
>

360 #unde‡
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

369 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

372 #i‚de‡
__ASSEMBLER__


373 #i‚de‡
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

388 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

389 && 
deföed
 
	g__exã∫_ölöe


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/°ubs.h
>

	@/usr/include/linux/posix_types.h

1 #i‚de‡
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<löux/°ddef.h
>

21 #unde‡
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__kî√l_fd_£t
;

29 (*
	t__kî√l_sigh™dÀr_t
)();

32 
	t__kî√l_key_t
;

33 
	t__kî√l_mqd_t
;

35 
	~<asm/posix_ty≥s.h
>

	@/usr/include/xlocale.h

20 #i‚de‡
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loˇÀ_°ru˘


30 
__loˇÀ_d©a
 *
	m__loˇÀs
[13];

33 c⁄° *
	m__˘y≥_b
;

34 c⁄° *
	m__˘y≥_tﬁowî
;

35 c⁄° *
	m__˘y≥_touµî
;

38 c⁄° *
	m__«mes
[13];

39 } *
	t__loˇÀ_t
;

42 
__loˇÀ_t
 
	tloˇÀ_t
;

	@/usr/include/linux/stddef.h

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
31
602
cache.c
config.c
dir.c
fat.h
fat.mod.c
fatent.c
file.c
inode.c
misc.c
namei_msdos.c
namei_vfat.c
nfs.c
vfat.mod.c
/usr/include/linux/capability.h
/usr/include/linux/fs.h
/usr/include/linux/kernel.h
/usr/include/linux/msdos_fs.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/uio.h
/usr/include/linux/ioctl.h
/usr/include/linux/limits.h
/usr/include/linux/magic.h
/usr/include/linux/sysinfo.h
/usr/include/linux/types.h
/usr/include/string.h
/usr/include/features.h
/usr/include/linux/posix_types.h
/usr/include/xlocale.h
/usr/include/linux/stddef.h
/usr/include/stdc-predef.h
