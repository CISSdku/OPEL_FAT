cscope 15 $HOME/ë‹¤ìš´ë¡œë“œ/OPEL/filesystem/fat_test/OPEL_FAT               0000281288
	@cache.c

11 
	~<lšux/fs.h
>

12 
	~<lšux/¦ab.h
>

13 
	~<lšux/bufãr_h—d.h
>

14 
	~"çt.h
"

17 
	#FAT_MAX_CACHE
 8

	)

19 
	sçt_ÿche
 {

20 
li¡_h—d
 
	mÿche_li¡
;

21 
	mÄ_cÚtig
;

22 
	mfþu¡”
;

23 
	mdþu¡”
;

26 
	sçt_ÿche_id
 {

27 
	mid
;

28 
	mÄ_cÚtig
;

29 
	mfþu¡”
;

30 
	mdþu¡”
;

33 
šlše
 
	$çt_max_ÿche
(
šode
 *inode)

35  
FAT_MAX_CACHE
;

36 
	}
}

38 
kmem_ÿche
 *
	gçt_ÿche_ÿch•
;

40 
	$š™_Úû
(*
foo
)

42 
çt_ÿche
 *
ÿche
 = (çt_ÿch*)
foo
;

44 
	`INIT_LIST_HEAD
(&
ÿche
->
ÿche_li¡
);

45 
	}
}

47 
__š™
 
	$çt_ÿche_š™
()

49 
çt_ÿche_ÿch•
 = 
	`kmem_ÿche_ü—‹
("fat_cache",

50 (
çt_ÿche
),

51 0, 
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
,

52 
š™_Úû
);

53 ià(
çt_ÿche_ÿch•
 =ð
NULL
)

54  -
ENOMEM
;

56 
	}
}

58 
	$çt_ÿche_de¡roy
()

60 
	`kmem_ÿche_de¡roy
(
çt_ÿche_ÿch•
);

61 
	}
}

63 
šlše
 
çt_ÿche
 *
	$çt_ÿche_®loc
(
šode
 *inode)

65  
	`kmem_ÿche_®loc
(
çt_ÿche_ÿch•
, 
GFP_NOFS
);

66 
	}
}

68 
šlše
 
	$çt_ÿche_ä“
(
çt_ÿche
 *
ÿche
)

70 
	`BUG_ON
(!
	`li¡_em±y
(&
ÿche
->
ÿche_li¡
));

71 
	`kmem_ÿche_ä“
(
çt_ÿche_ÿch•
, 
ÿche
);

72 
	}
}

74 
šlše
 
	$çt_ÿche_upd©e_Ìu
(
šode
 *inode,

75 
çt_ÿche
 *
ÿche
)

77 ià(
	`MSDOS_I
(
šode
)->
ÿche_Ìu
.
Ãxt
 !ð&
ÿche
->
ÿche_li¡
)

78 
	`li¡_move
(&
ÿche
->
ÿche_li¡
, &
	`MSDOS_I
(
šode
)->
ÿche_Ìu
);

79 
	}
}

81 
	$çt_ÿche_lookup
(
šode
 *šode, 
fþus
,

82 
çt_ÿche_id
 *
cid
,

83 *
ÿched_fþus
, *
ÿched_dþus
)

85 
çt_ÿche
 
noh™
 = { .
fþu¡”
 = 0, };

87 
çt_ÿche
 *
h™
 = &
noh™
, *
p
;

88 
off£t
 = -1;

90 
	`¥š_lock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

91 
	`li¡_fÜ_—ch_’Œy
(
p
, &
	`MSDOS_I
(
šode
)->
ÿche_Ìu
, 
ÿche_li¡
) {

93 ià(
p
->
fþu¡”
 <ð
fþus
 && 
h™
->fcluster <…->fcluster) {

94 
h™
 = 
p
;

95 ià((
h™
->
fþu¡”
 + h™->
Ä_cÚtig
è< 
fþus
) {

96 
off£t
 = 
h™
->
Ä_cÚtig
;

98 
off£t
 = 
fþus
 - 
h™
->
fþu¡”
;

103 ià(
h™
 !ð&
noh™
) {

104 
	`çt_ÿche_upd©e_Ìu
(
šode
, 
h™
);

106 
cid
->
id
 = 
	`MSDOS_I
(
šode
)->
ÿche_v®id_id
;

107 
cid
->
Ä_cÚtig
 = 
h™
->nr_contig;

108 
cid
->
fþu¡”
 = 
h™
->fcluster;

109 
cid
->
dþu¡”
 = 
h™
->dcluster;

110 *
ÿched_fþus
 = 
cid
->
fþu¡”
 + 
off£t
;

111 *
ÿched_dþus
 = 
cid
->
dþu¡”
 + 
off£t
;

113 
	`¥š_uÆock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

115  
off£t
;

116 
	}
}

118 
çt_ÿche
 *
	$çt_ÿche_m”ge
(
šode
 *inode,

119 
çt_ÿche_id
 *
Ãw
)

121 
çt_ÿche
 *
p
;

123 
	`li¡_fÜ_—ch_’Œy
(
p
, &
	`MSDOS_I
(
šode
)->
ÿche_Ìu
, 
ÿche_li¡
) {

125 ià(
p
->
fþu¡”
 =ð
Ãw
->fcluster) {

126 
	`BUG_ON
(
p
->
dþu¡”
 !ð
Ãw
->dcluster);

127 ià(
Ãw
->
Ä_cÚtig
 > 
p
->nr_contig)

128 
p
->
Ä_cÚtig
 = 
Ãw
->nr_contig;

129  
p
;

132  
NULL
;

133 
	}
}

135 
	$çt_ÿche_add
(
šode
 *šode, 
çt_ÿche_id
 *
Ãw
)

137 
çt_ÿche
 *
ÿche
, *
tmp
;

139 ià(
Ãw
->
fþu¡”
 == -1)

142 
	`¥š_lock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

143 ià(
Ãw
->
id
 !ð
FAT_CACHE_VALID
 &&

144 
Ãw
->
id
 !ð
	`MSDOS_I
(
šode
)->
ÿche_v®id_id
)

145 
out
;

147 
ÿche
 = 
	`çt_ÿche_m”ge
(
šode
, 
Ãw
);

148 ià(
ÿche
 =ð
NULL
) {

149 ià(
	`MSDOS_I
(
šode
)->
Ä_ÿches
 < 
	`çt_max_ÿche
(inode)) {

150 
	`MSDOS_I
(
šode
)->
Ä_ÿches
++;

151 
	`¥š_uÆock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

153 
tmp
 = 
	`çt_ÿche_®loc
(
šode
);

154 ià(!
tmp
) {

155 
	`¥š_lock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

156 
	`MSDOS_I
(
šode
)->
Ä_ÿches
--;

157 
	`¥š_uÆock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

161 
	`¥š_lock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

162 
ÿche
 = 
	`çt_ÿche_m”ge
(
šode
, 
Ãw
);

163 ià(
ÿche
 !ð
NULL
) {

164 
	`MSDOS_I
(
šode
)->
Ä_ÿches
--;

165 
	`çt_ÿche_ä“
(
tmp
);

166 
out_upd©e_Ìu
;

168 
ÿche
 = 
tmp
;

170 
li¡_h—d
 *
p
 = 
	`MSDOS_I
(
šode
)->
ÿche_Ìu
.
´ev
;

171 
ÿche
 = 
	`li¡_’Œy
(
p
, 
çt_ÿche
, 
ÿche_li¡
);

173 
ÿche
->
fþu¡”
 = 
Ãw
->fcluster;

174 
ÿche
->
dþu¡”
 = 
Ãw
->dcluster;

175 
ÿche
->
Ä_cÚtig
 = 
Ãw
->nr_contig;

177 
out_upd©e_Ìu
:

178 
	`çt_ÿche_upd©e_Ìu
(
šode
, 
ÿche
);

179 
out
:

180 
	`¥š_uÆock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

181 
	}
}

187 
	$__çt_ÿche_šv®_šode
(
šode
 *inode)

189 
msdos_šode_šfo
 *
i
 = 
	`MSDOS_I
(
šode
);

190 
çt_ÿche
 *
ÿche
;

192 !
	`li¡_em±y
(&
i
->
ÿche_Ìu
)) {

193 
ÿche
 = 
	`li¡_’Œy
(
i
->
ÿche_Ìu
.
Ãxt
,

194 
çt_ÿche
, 
ÿche_li¡
);

195 
	`li¡_d–_š™
(&
ÿche
->
ÿche_li¡
);

196 
i
->
Ä_ÿches
--;

197 
	`çt_ÿche_ä“
(
ÿche
);

200 
i
->
ÿche_v®id_id
++;

201 ià(
i
->
ÿche_v®id_id
 =ð
FAT_CACHE_VALID
)

202 
i
->
ÿche_v®id_id
++;

203 
	}
}

205 
	$çt_ÿche_šv®_šode
(
šode
 *inode)

207 
	`¥š_lock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

208 
	`__çt_ÿche_šv®_šode
(
šode
);

209 
	`¥š_uÆock
(&
	`MSDOS_I
(
šode
)->
ÿche_Ìu_lock
);

210 
	}
}

212 
šlše
 
	$ÿche_cÚtiguous
(
çt_ÿche_id
 *
cid
, 
dþus
)

214 
cid
->
Ä_cÚtig
++;

215  ((
cid
->
dþu¡”
 + cid->
Ä_cÚtig
è=ð
dþus
);

216 
	}
}

218 
šlše
 
	$ÿche_š™
(
çt_ÿche_id
 *
cid
, 
fþus
, 
dþus
)

220 
cid
->
id
 = 
FAT_CACHE_VALID
;

221 
cid
->
fþu¡”
 = 
fþus
;

222 
cid
->
dþu¡”
 = 
dþus
;

223 
cid
->
Ä_cÚtig
 = 0;

224 
	}
}

226 
	$çt_g‘_þu¡”
(
šode
 *šode, 
þu¡”
, *
fþus
, *
dþus
)

228 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

229 cÚ¡ 
lim™
 = 
sb
->
s_maxby‹s
 >> 
	`MSDOS_SB
(sb)->
þu¡”_b™s
;

230 
çt_’Œy
 
ç‹Á
;

231 
çt_ÿche_id
 
cid
;

232 
Ä
;

234 
	`BUG_ON
(
	`MSDOS_I
(
šode
)->
i_¡¬t
 == 0);

236 *
fþus
 = 0;

237 *
dþus
 = 
	`MSDOS_I
(
šode
)->
i_¡¬t
;

238 ià(
þu¡”
 == 0)

241 ià(
	`çt_ÿche_lookup
(
šode
, 
þu¡”
, &
cid
, 
fþus
, 
dþus
) < 0) {

246 
	`ÿche_š™
(&
cid
, -1, -1);

249 
	`ç‹Á_š™
(&
ç‹Á
);

250 *
fþus
 < 
þu¡”
) {

252 ià(*
fþus
 > 
lim™
) {

253 
	`çt_fs_”rÜ_¿‹lim™
(
sb
,

255 " (i_po %Îd)", 
__func__
,

256 
	`MSDOS_I
(
šode
)->
i_pos
);

257 
Ä
 = -
EIO
;

258 
out
;

261 
Ä
 = 
	`çt_’t_»ad
(
šode
, &
ç‹Á
, *
dþus
);

262 ià(
Ä
 < 0)

263 
out
;

264 ià(
Ä
 =ð
FAT_ENT_FREE
) {

265 
	`çt_fs_”rÜ_¿‹lim™
(
sb
,

267 
__func__
,

268 
	`MSDOS_I
(
šode
)->
i_pos
);

269 
Ä
 = -
EIO
;

270 
out
;

271 } ià(
Ä
 =ð
FAT_ENT_EOF
) {

272 
	`çt_ÿche_add
(
šode
, &
cid
);

273 
out
;

275 (*
fþus
)++;

276 *
dþus
 = 
Ä
;

277 ià(!
	`ÿche_cÚtiguous
(&
cid
, *
dþus
))

278 
	`ÿche_š™
(&
cid
, *
fþus
, *
dþus
);

280 
Ä
 = 0;

281 
	`çt_ÿche_add
(
šode
, &
cid
);

282 
out
:

283 
	`ç‹Á_b»l£
(&
ç‹Á
);

284  
Ä
;

285 
	}
}

287 
	$çt_bm­_þu¡”
(
šode
 *šode, 
þu¡”
)

289 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

290 
»t
, 
fþus
, 
dþus
;

292 ià(
	`MSDOS_I
(
šode
)->
i_¡¬t
 == 0)

295 
»t
 = 
	`çt_g‘_þu¡”
(
šode
, 
þu¡”
, &
fþus
, &
dþus
);

296 ià(
»t
 < 0)

297  
»t
;

298 ià(
»t
 =ð
FAT_ENT_EOF
) {

299 
	`çt_fs_”rÜ
(
sb
, "%s:„equest beyond EOF (i_pos %lld)",

300 
__func__
, 
	`MSDOS_I
(
šode
)->
i_pos
);

301  -
EIO
;

303  
dþus
;

304 
	}
}

306 
	$çt_bm­
(
šode
 *šode, 
£ùÜ_t
 
£ùÜ
, seùÜ_ˆ*
phys
,

307 *
m­³d_blocks
, 
ü—‹
)

309 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

310 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

311 cÚ¡ 
blocksize
 = 
sb
->
s_blocksize
;

312 cÚ¡ 
blocksize_b™s
 = 
sb
->
s_blocksize_b™s
;

313 
£ùÜ_t
 
Ï¡_block
;

314 
þu¡”
, 
off£t
;

316 *
phys
 = 0;

317 *
m­³d_blocks
 = 0;

318 ià((
sbi
->
çt_b™s
 !ð32è&& (
šode
->
i_šo
 =ð
MSDOS_ROOT_INO
)) {

319 ià(
£ùÜ
 < (
sbi
->
dœ_’Œ›s
 >> sbi->
dœ_³r_block_b™s
)) {

320 *
phys
 = 
£ùÜ
 + 
sbi
->
dœ_¡¬t
;

321 *
m­³d_blocks
 = 1;

326 
Ï¡_block
 = (
	`i_size_»ad
(
šode
è+ (
blocksize
 - 1)è>> 
blocksize_b™s
;

327 ià(
£ùÜ
 >ð
Ï¡_block
) {

328 ià(!
ü—‹
)

335 
Ï¡_block
 = (
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 + (
blocksize
 - 1))

336 >> 
blocksize_b™s
;

337 ià(
£ùÜ
 >ð
Ï¡_block
)

341 
þu¡”
 = 
£ùÜ
 >> (
sbi
->
þu¡”_b™s
 - 
sb
->
s_blocksize_b™s
);

342 
off£t
 = 
£ùÜ
 & (
sbi
->
£c_³r_þus
 - 1);

343 
þu¡”
 = 
	`çt_bm­_þu¡”
(
šode
, cluster);

344 ià(
þu¡”
 < 0)

345  
þu¡”
;

346 ià(
þu¡”
) {

347 *
phys
 = 
	`çt_þus_to_blkÄ
(
sbi
, 
þu¡”
è+ 
off£t
;

348 *
m­³d_blocks
 = 
sbi
->
£c_³r_þus
 - 
off£t
;

349 ià(*
m­³d_blocks
 > 
Ï¡_block
 - 
£ùÜ
)

350 *
m­³d_blocks
 = 
Ï¡_block
 - 
£ùÜ
;

353 
	}
}

	@config.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/š™.h
>

3 
	~<lšux/time.h
>

4 
	~<lšux/¦ab.h
>

5 
	~<lšux/£q_fže.h
>

6 
	~<lšux/·gem­.h
>

7 
	~<lšux/m·ge.h
>

8 
	~<lšux/bufãr_h—d.h
>

9 
	~<lšux/expÜtfs.h
>

10 
	~<lšux/mouÁ.h
>

11 
	~<lšux/vfs.h
>

12 
	~<lšux/·r£r.h
>

13 
	~<lšux/uio.h
>

14 
	~<lšux/wr™eback.h
>

15 
	~<lšux/log2.h
>

16 
	~<lšux/hash.h
>

17 
	~<asm/uÇligÃd.h
>

18 
	~"çt.h
"

20 cÚ¡ *
	gcÚfig_d©a
 = "Blackbox Configuration\r\n\r\nPartitioning Size[Percentage]\r\n\tBX_NORMAL =30\r\n\tBX_NORMAL_EVENT =20\r\n\tBX_PARKING_EVENT =10\r\n\tBX_MANUAL =5\r\n\tBX_IMAGE =5\r\n\tBX_ETC =30\r\n\r\nPreallocation Setting[MB]\r\n\tBX_NORMAL =32\r\n\tBX_NORMAL_EVENT =32\r\n\tBX_PARKING_EVENT =32\r\n\tBX_MANUAL =32\r\n\t\0";

24 
	gmsdos_Çme
[ 
MSDOS_NAME
 ] = "BXFS_CON";

26 
	$»ad_cÚfig_d©a
(
su³r_block
 *
sb
, *
d©a
)

32 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

34 
num_of_´e
 = 4;

35 
num_of_·r
 = 6;

36 
num_of_tÙ®
 = 
num_of_´e
 + 
num_of_·r
;

39 
i
;

40 
block_size
 = 512;

41 
couÁ
 = 0;

43 
»ad_v®
[20] = {0, };

45 
i
=0; i<
block_size
; i++)

48 if(
d©a
[
i
] == '='){

49 if(
d©a
[
i
+3] >= '0' && data[i+3] <= '9'){

50 
»ad_v®
[
couÁ
] = ((()(
d©a
[
i
+1])-48) * 100) + ((()(data[i+2])-48) * 10) + ((()(data[i+3])-48)) ;

51 
i
+=3;

53 if(
d©a
[
i
+2] >= '0' && data[i+2] <= '9'){

54 
»ad_v®
[
couÁ
] = ((()(
d©a
[
i
+1])-48) * 10) + ((()(data[i+2])-48)) ;

55 
i
+=2;

57 if(
d©a
[
i
+1] >= '0' && data[i+1] <= '9'){

58 
»ad_v®
[
couÁ
] = ((()(
d©a
[
i
+1])-48)) ;

59 
i
++;

62 
	`´štk
("Invalid config file data! \n");

66 
couÁ
++;

68 if(
couÁ
 >ð
num_of_tÙ®
){

69 
	`´štk
("[cheon] Complete data…arsing \n");

76 if(
couÁ
 < 
num_of_tÙ®
){

77 
	`´štk
("Some config date‡re dropped! \n");

85 
sbi
->
bx_¬—_¿tio
[
BX_NORMAL
] = 
»ad_v®
[0];

86 
sbi
->
bx_¬—_¿tio
[
BX_NORMAL_EVENT
] = 
»ad_v®
[1];

87 
sbi
->
bx_¬—_¿tio
[
BX_PARKING_EVENT
] = 
»ad_v®
[2];

88 
sbi
->
bx_¬—_¿tio
[
BX_MANUAL
] = 
»ad_v®
[3];

89 
sbi
->
bx_¬—_¿tio
[
BX_IMAGE
] = 
»ad_v®
[4];

90 
sbi
->
bx_¬—_¿tio
[
BX_ETC
] = 
»ad_v®
[5];

93 
sbi
->
bx_¬—_¿tio
[ 
BB_NORMAL
 ] = 
»ad_v®
[0];

94 
sbi
->
bx_¬—_¿tio
[ 
BB_NORMAL_EVENT
 ] = 
»ad_v®
[1];

95 
sbi
->
bx_¬—_¿tio
[ 
BB_PARKING
 ] = 
»ad_v®
[2];

96 
sbi
->
bx_¬—_¿tio
[ 
BB_MANUAL
 ] = 
»ad_v®
[3];

97 
sbi
->
bx_¬—_¿tio
[ 
BB_IMAGE
 ] = 
»ad_v®
[4];

98 
sbi
->
bx_¬—_¿tio
[ 
BB_ETC
 ] = 
»ad_v®
[5];

101 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_¬—_¿tio
[ 
BB_NORMAL
 ] );

102 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_¬—_¿tio
[ 
BB_NORMAL_EVENT
 ] );

103 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_¬—_¿tio
[ 
BB_PARKING
 ] );

104 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_¬—_¿tio
[ 
BB_MANUAL
 ] );

105 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_¬—_¿tio
[ 
BB_IMAGE
 ] );

106 
	`´štk
("[cheÚ] %u \n\n", 
sbi
->
bx_¬—_¿tio
[ 
BB_ETC
 ] );

111 
sbi
->
bx_´e_size
[
BX_NORMAL
] = 
»ad_v®
[6];

112 
sbi
->
bx_´e_size
[
BX_NORMAL_EVENT
] = 
»ad_v®
[7];

113 
sbi
->
bx_´e_size
[
BX_PARKING_EVENT
] = 
»ad_v®
[8];

114 
sbi
->
bx_´e_size
[
BX_MANUAL
] = 
»ad_v®
[9];

117 
sbi
->
bx_´e_size
[ 
BB_NORMAL
 ] = 
»ad_v®
[6];

118 
sbi
->
bx_´e_size
[ 
BB_NORMAL_EVENT
 ] = 
»ad_v®
[7];

119 
sbi
->
bx_´e_size
[ 
BB_PARKING
 ] = 
»ad_v®
[8];

120 
sbi
->
bx_´e_size
[ 
BB_MANUAL
 ] = 
»ad_v®
[9];

122 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_´e_size
[ 
BB_NORMAL
 ] );

123 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_´e_size
[ 
BB_NORMAL_EVENT
 ] );

124 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_´e_size
[ 
BB_PARKING
 ] );

125 
	`´štk
("[cheÚ] %u \n", 
sbi
->
bx_´e_size
[ 
BB_MANUAL
 ] );

130 
	}
}

132 
	$_çt_chaš_add
(
šode
 *šode, 
Ãw_dþus
, 
Ä_þu¡”
)

135 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

136 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

137 
»t
, 
Ãw_fþus
, 
Ï¡
;

143 
Ï¡
 = 
Ãw_fþus
 = 0;

147 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
Ãw_dþus
;

148 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = 
Ãw_dþus
;

156 
»t
 = 
	`çt_sync_šode
(
šode
);

157 ià(
»t
)

158  
»t
;

170 
šode
->
i_blocks
 = 
Ä_þu¡”
 << (
sbi
->
þu¡”_b™s
 - 9);

173 
	}
}

175 
	$bužd_cÚfig_fže
Ð
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
mode
 )

177 
msdos_dœ_’Œy
 
de
;

178 
çt_¦Ù_šfo
 
sšfo
;

179 
çt_¦Ù_šfo
 *
_sšfo
 = &
sšfo
;

180 
šode
 *šodð
NULL
;

182 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

183 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
Ð
sb
 );

185 
þu¡”_num
 = 0;

186 
”r
;

187 
þu¡”
 = 
sbi
->
çt_¡¬t
;

192 ifÐ!
	`çt_sÿn
Ð
dœ
, 
msdos_Çme
, &
sšfo
 ) )

194 
	`´štk
("[cheon] build_config_file :ƒxisting file ");

195 
	`b»l£
Ð
sšfo
.
bh
 );

196 
”r
 = -
EINVAL
;

197 
out
;

202 
	`memýy
Ð
de
.
Çme
, 
msdos_Çme
, 
MSDOS_NAME
 );

204 
de
.
©Œ
 = 0 ? 
ATTR_DIR
 : 
ATTR_ARCH
;

205 
de
.
lÿ£
 = 0;

206 
de
.
cd©e
 = de.
ad©e
 = 0;

207 
de
.
ùime
 = 0;

208 
de
.
ùime_cs
 = 0;

209 
de
.
time
 = 0;

210 
de
.
d©e
 = 0;

211 
de
.
¡¬t
 = 
	`ýu_to_Ë16
(
þu¡”_num
);

212 
de
.
¡¬thi
 = 
	`ýu_to_Ë16
(
þu¡”_num
) >> 16;

213 
de
.
size
 = 512;

215 
”r
 = 
	`çt_add_’Œ›s
Ð
dœ
, &
de
, 1, 
_sšfo
 );

216 
šode
 = 
	`çt_bužd_šode
Ð
sb
, 
sšfo
.
de
, sšfo.
i_pos
 );

218 
	`b»l£
Ð
sšfo
.
bh
 );

220 ià(
	`IS_ERR
(
šode
)) {

221 
”r
 = 
	`PTR_ERR
(
šode
);

222 
	`´štk
("[cheon] Error‡bout inode...\n");

223 
out
;

225 
	`´štk
("[cheon] Complete Create Config File \n");

228 ifÐ!
	`çt_sÿn
Ð
roÙ
, 
msdos_Çme
, &
sšfo
 ) )

230 
	`b»l£
Ð
sšfo
.
bh
 );

231 
	`´štk
("[cheon] config file‡lreadyƒxist \n");

237 ià(!
”r
){

238 
	`´štk
("[cheÚ] s¹ f©_æush_šode : %u \n", 
þu¡”
);

239 
”r
 = 
	`çt_æush_šodes
(
sb
, 
dœ
, 
šode
);

242 
	`´štk
("[cheÚ] s¹ f©_®loc_þu¡” : %u \n", 
þu¡”
);

243 
	`çt_®loc_þu¡”
(
šode
, &
þu¡”
, 
BX_ETC
);

245 
	`´štk
("[cheÚ] g‘ %d clu¡” \n", 
þu¡”
);

246 
	`_çt_chaš_add
Ð
šode
, 
þu¡”
, 1 );

250 
	`´štk
("[gandan] Error or Skipping \n");

253 
	`´štk
("[gandan] Complete cluster‡llocation for config file \n");

255 
out
:

256  
”r
;

257 
	}
}

260 
šlše
 
£ùÜ_t
 
	$çt_þus_to_blkÄ
(
msdos_sb_šfo
 *
sbi
, 
þus
)

262  ((
£ùÜ_t
)
þus
 - 
FAT_START_ENT
è* 
sbi
->
£c_³r_þus
 + sbi->
d©a_¡¬t
;

263 
	}
}

266 
	$Ý–_vçt_fšd_fÜm
Ð
msdos_sb_šfo
 *
sbi
, 
šode
 *
dœ
, *
Çme
, 
£ùÜ_t
 *
blkÄ
 )

268 
çt_¦Ù_šfo
 
sšfo
;

269 
”r
 = 
	`çt_sÿn_Ý–
(
dœ
, 
Çme
, &
sšfo
);

270 ià(
”r
)

271  -
ENOENT
;

273 
	`´štk
("[cheon] detect \n");

275 
£ùÜ_t
 
þus
 = 
sšfo
.
de
->
¡¬t
;

277 
	`b»l£
(
sšfo
.
bh
);

278 
	`´štk
("[cheÚ] sšfo' ¡¬ˆšfØ: %u \n", 
þus
 );

283 
	`¡rýy
Ð
sšfo
.
bh
->
b_d©a
, "test" );

285 
	`£t_bufãr_u±od©e
Ð
sšfo
.
bh
 );

286 
	`m¬k_bufãr_dœty_šode
Ð
sšfo
.
bh
, 
dœ
 );

290 *
blkÄ
 = ( (
þus
 - 
FAT_START_ENT
è* 
sbi
->
£c_³r_þus
 ) + sbi->
d©a_¡¬t
;

292 
	}
}

297 
	$çt_cÚfig_š™
(
su³r_block
 *
sb
)

299 
çt_¦Ù_šfo
 
sšfo
;

300 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

301 
d’Œy
 *
roÙ_de
 = 
sb
->
s_roÙ
;

302 
šode
 *
roÙ
 = 
roÙ_de
->
d_šode
;

304 
bufãr_h—d
 *
bh
;

305 
block_pos
;

306 
”r
;

308 
£ùÜ_t
 
blkÄ
;

310 
	`´štk
("[cheon] Start fat_config_init \n");

313 ifÐ!
	`çt_sÿn_Ý–
Ð
roÙ
, 
msdos_Çme
, &
sšfo
 ) )

315 
	`´štk
("[cheon] config file‡lreadyƒxist \n");

316 
	`b»l£
Ð
sšfo
.
bh
 );

318 
exi¡
;

322 
	`´štk
("[cheon] Create config File \n");

323 
”r
 = 
	`bužd_cÚfig_fže
Ð
roÙ
, 
roÙ_de
, 0 );

327 ifÐ
	`Ý–_vçt_fšd_fÜm
Ð
sbi
, 
roÙ
, 
msdos_Çme
, &
blkÄ
 ) =ð-
ENOENT
 )

328 
	`´štk
("[cheon] opel_vfat_find_formƒrror \n");

331 
	`´štk
("[cheÚ] blkÄ : %u \n", 
blkÄ
 );

336 
bh
 = 
	`sb_b»ad
Ð
sb
, 
blkÄ
 );

337 ifÐ!
bh
 )

339 
	`´štk
("[cheon] unableo„ead inode block \n");

340 
	`b»l£
(
bh
);

343 
	`¡rýy
Ð
bh
->
b_d©a
, 
cÚfig_d©a
 );

345 
	`m¬k_bufãr_dœty
(
bh
);

346 
”r
 = 
	`sync_dœty_bufãr
(
bh
);

347 
	`b»l£
(
bh
);

349 
	`´štk
("[cheon] Complete write data \n");

351 ià(
	`çt_sÿn
(
roÙ
, 
msdos_Çme
, &
sšfo
))

353 
	`´štk
("[cheon] <==Error==> Creation config file failed! \n");

360 
bh
 = 
	`sb_g‘blk
Ð
sb
, 
blkÄ
 );

361 ifÐ!
bh
 )

363 
	`´štk
("[cheon] sb_getblkƒrror \n");

365 
	`¡rýy
Ð
bh
->
b_d©a
, 
cÚfig_d©a
 );

375 
	`m¬k_bufãr_dœty
(
bh
);

376 
”r
 = 
	`sync_dœty_bufãr
(
bh
);

379 ià(
	`çt_sÿn
(
roÙ
, 
msdos_Çme
, &
sšfo
))

381 
	`´štk
("[gandan] <==Error==> Creation config file failed! \n");

385 
exi¡
:

388 
	`´štk
("[cheon] Data Read \n");

393 ifÐ
	`Ý–_vçt_fšd_fÜm
Ð
sbi
, 
roÙ
, 
msdos_Çme
, &
blkÄ
 ) =ð-
ENOENT
 )

394 
	`´štk
("[cheon] opel_vfat_find_formƒrror \n");

396 
	`´štk
("[cheÚ] blkÄ : %u \n", 
blkÄ
 );

397 
bh
 = 
	`sb_b»ad
Ð
sb
, 
blkÄ
 );

398 
	`»ad_cÚfig_d©a
Ð
sb
, 
bh
->
b_d©a
 );

399 
	`b»l£
Ð
bh
 );

401 
	`´štk
("[cheon] Start data„ead...complete\n");

404 
	}
}

405 
EXPORT_SYMBOL_GPL
Ð
çt_cÚfig_š™
 );

	@dir.c

16 
	~<lšux/moduË.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/time.h
>

19 
	~<lšux/bufãr_h—d.h
>

20 
	~<lšux/com·t.h
>

21 
	~<lšux/uacûss.h
>

22 
	~<lšux/k”Ãl.h
>

23 
	~"çt.h
"

30 
	#FAT_MAX_SHORT_SIZE
 ((
MSDOS_NAME
 + 1è* 
NLS_MAX_CHARSET_SIZE
 + 1)

	)

35 
	#FAT_MAX_UNI_CHARS
 ((
MSDOS_SLOTS
 - 1è* 13 + 1)

	)

36 
	#FAT_MAX_UNI_SIZE
 (
FAT_MAX_UNI_CHARS
 * (
wch¬_t
))

	)

38 
šlše
 
	$çt_tÞow”
(
c
)

40  ((
c
 >= 'A') && (c <= 'Z')) ? c+32 : c;

41 
	}
}

43 
šlše
 
loff_t
 
	$çt_make_i_pos
(
su³r_block
 *
sb
,

44 
bufãr_h—d
 *
bh
,

45 
msdos_dœ_’Œy
 *
de
)

47  ((
loff_t
)
bh
->
b_blockÄ
 << 
	`MSDOS_SB
(
sb
)->
dœ_³r_block_b™s
)

48 | (
de
 - (
msdos_dœ_’Œy
 *)
bh
->
b_d©a
);

49 
	}
}

51 
šlše
 
	$çt_dœ_»adah—d
(
šode
 *
dœ
, 
£ùÜ_t
 
iblock
,

52 
£ùÜ_t
 
phys
)

54 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

55 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

56 
bufãr_h—d
 *
bh
;

57 
£c
;

60 ià((
iblock
 & (
sbi
->
£c_³r_þus
 - 1)) || sbi->sec_per_clus == 1)

63 ià((
sbi
->
çt_b™s
 !ð32è&& (
dœ
->
i_šo
 =ð
MSDOS_ROOT_INO
))

66 
bh
 = 
	`sb_fšd_g‘_block
(
sb
, 
phys
);

67 ià(
bh
 =ð
NULL
 || !
	`bufãr_u±od©e
(bh)) {

68 
£c
 = 0; seø< 
sbi
->
£c_³r_þus
; sec++)

69 
	`sb_b»adah—d
(
sb
, 
phys
 + 
£c
);

71 
	`b»l£
(
bh
);

72 
	}
}

84 
	$çt__g‘_’Œy
(
šode
 *
dœ
, 
loff_t
 *
pos
,

85 
bufãr_h—d
 **
bh
, 
msdos_dœ_’Œy
 **
de
)

87 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

88 
£ùÜ_t
 
phys
, 
iblock
;

89 
m­³d_blocks
;

90 
”r
, 
off£t
;

92 
Ãxt
:

93 ià(*
bh
)

94 
	`b»l£
(*
bh
);

96 *
bh
 = 
NULL
;

97 
iblock
 = *
pos
 >> 
sb
->
s_blocksize_b™s
;

98 
”r
 = 
	`çt_bm­
(
dœ
, 
iblock
, &
phys
, &
m­³d_blocks
, 0);

99 ià(
”r
 || !
phys
)

102 
	`çt_dœ_»adah—d
(
dœ
, 
iblock
, 
phys
);

104 *
bh
 = 
	`sb_b»ad
(
sb
, 
phys
);

105 ià(*
bh
 =ð
NULL
) {

106 
	`çt_msg_¿‹lim™
(
sb
, 
KERN_ERR
,

107 "DœeùÜy b»ad(block %Îuèçžed", (
Îu
)
phys
);

109 *
pos
 = (
iblock
 + 1è<< 
sb
->
s_blocksize_b™s
;

110 
Ãxt
;

113 
off£t
 = *
pos
 & (
sb
->
s_blocksize
 - 1);

114 *
pos
 +ð(
msdos_dœ_’Œy
);

115 *
de
 = (
msdos_dœ_’Œy
 *)((*
bh
)->
b_d©a
 + 
off£t
);

118 
	}
}

120 
šlše
 
	$çt_g‘_’Œy
(
šode
 *
dœ
, 
loff_t
 *
pos
,

121 
bufãr_h—d
 **
bh
,

122 
msdos_dœ_’Œy
 **
de
)

125 ià(*
bh
 && *
de
 &&

126 (*
de
 - (
msdos_dœ_’Œy
 *)(*
bh
)->
b_d©a
) <

127 
	`MSDOS_SB
(
dœ
->
i_sb
)->
dœ_³r_block
 - 1) {

128 *
pos
 +ð(
msdos_dœ_’Œy
);

129 (*
de
)++;

132  
	`çt__g‘_’Œy
(
dœ
, 
pos
, 
bh
, 
de
);

133 
	}
}

145 
	$uni16_to_x8
(
su³r_block
 *
sb
, *
ascii
,

146 cÚ¡ 
wch¬_t
 *
uni
, 
Ën
, 
Æs_bË
 *
Æs
)

148 
uni_xÏ‹
 = 
	`MSDOS_SB
(
sb
)->
ÝtiÚs
.
unicode_xÏ‹
;

149 cÚ¡ 
wch¬_t
 *

;

150 
wch¬_t
 
ec
;

151 *
Ý
;

152 
ch¬Ën
;

154 

 = 
uni
;

155 
Ý
 = 
ascii
;

157 *

 && ((
Ën
 - 
NLS_MAX_CHARSET_SIZE
) > 0)) {

158 
ec
 = *

++;

159 
ch¬Ën
 = 
Æs
->
	`uni2ch¬
(
ec
, 
Ý
, 
NLS_MAX_CHARSET_SIZE
);

160 ià(
ch¬Ën
 > 0) {

161 
Ý
 +ð
ch¬Ën
;

162 
Ën
 -ð
ch¬Ën
;

164 ià(
uni_xÏ‹
 == 1) {

165 *
Ý
++ = ':';

166 
Ý
 = 
	`hex_by‹_·ck
(Ý, 
ec
 >> 8);

167 
Ý
 = 
	`hex_by‹_·ck
(Ý, 
ec
);

168 
Ën
 -= 5;

170 *
Ý
++ = '?';

171 
Ën
--;

176 ià(
	`uÆik–y
(*

)) {

177 
	`çt_msg
(
sb
, 
KERN_WARNING
,

181 *
Ý
 = 0;

182  
Ý
 - 
ascii
;

183 
	}
}

185 
šlše
 
	$çt_uni_to_x8
(
su³r_block
 *
sb
, cÚ¡ 
wch¬_t
 *
uni
,

186 *
buf
, 
size
)

188 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

189 ià(
sbi
->
ÝtiÚs
.
utf8
)

190  
	`utf16s_to_utf8s
(
uni
, 
FAT_MAX_UNI_CHARS
,

191 
UTF16_HOST_ENDIAN
, 
buf
, 
size
);

193  
	`uni16_to_x8
(
sb
, 
buf
, 
uni
, 
size
, 
sbi
->
Æs_io
);

194 
	}
}

196 
šlše
 

197 
	$çt_shÜt2uni
(
Æs_bË
 *
t
, *
c
, 
þ’
, 
wch¬_t
 *
uni
)

199 
ch¬Ën
;

201 
ch¬Ën
 = 
t
->
	`ch¬2uni
(
c
, 
þ’
, 
uni
);

202 ià(
ch¬Ën
 < 0) {

203 *
uni
 = 0x003f;

204 
ch¬Ën
 = 1;

206  
ch¬Ën
;

207 
	}
}

209 
šlše
 

210 
	$çt_shÜt2low”_uni
(
Æs_bË
 *
t
, *
c
,

211 
þ’
, 
wch¬_t
 *
uni
)

213 
ch¬Ën
;

214 
wch¬_t
 
wc
;

216 
ch¬Ën
 = 
t
->
	`ch¬2uni
(
c
, 
þ’
, &
wc
);

217 ià(
ch¬Ën
 < 0) {

218 *
uni
 = 0x003f;

219 
ch¬Ën
 = 1;

220 } ià(
ch¬Ën
 <= 1) {

221 
nc
 = 
t
->
ch¬£t2low”
[*
c
];

223 ià(!
nc
)

224 
nc
 = *
c
;

226 
ch¬Ën
 = 
t
->
	`ch¬2uni
(&
nc
, 1, 
uni
);

227 ià(
ch¬Ën
 < 0) {

228 *
uni
 = 0x003f;

229 
ch¬Ën
 = 1;

232 *
uni
 = 
wc
;

234  
ch¬Ën
;

235 
	}
}

237 
šlše
 

238 
	$çt_shÜŠame2uni
(
Æs_bË
 *
Æs
, *
buf
, 
buf_size
,

239 
wch¬_t
 *
uni_buf
, 
Ýt
, 
low”
)

241 
Ën
 = 0;

243 ià(
Ýt
 & 
VFAT_SFN_DISPLAY_LOWER
)

244 
Ën
 = 
	`çt_shÜt2low”_uni
(
Æs
, 
buf
, 
buf_size
, 
uni_buf
);

245 ià(
Ýt
 & 
VFAT_SFN_DISPLAY_WIN95
)

246 
Ën
 = 
	`çt_shÜt2uni
(
Æs
, 
buf
, 
buf_size
, 
uni_buf
);

247 ià(
Ýt
 & 
VFAT_SFN_DISPLAY_WINNT
) {

248 ià(
low”
)

249 
Ën
 = 
	`çt_shÜt2low”_uni
(
Æs
, 
buf
, 
buf_size
, 
uni_buf
);

251 
Ën
 = 
	`çt_shÜt2uni
(
Æs
, 
buf
, 
buf_size
, 
uni_buf
);

253 
Ën
 = 
	`çt_shÜt2uni
(
Æs
, 
buf
, 
buf_size
, 
uni_buf
);

255  
Ën
;

256 
	}
}

258 
šlše
 
	$çt_Çme_m©ch
(
msdos_sb_šfo
 *
sbi
,

259 cÚ¡ *
a
, 
a_Ën
,

260 cÚ¡ *
b
, 
b_Ën
)

262 ià(
a_Ën
 !ð
b_Ën
)

265 ià(
sbi
->
ÝtiÚs
.
Çme_check
 != 's')

266  !
	`Æs_¡ºicmp
(
sbi
->
Æs_io
, 
a
, 
b
, 
a_Ën
);

268  !
	`memcmp
(
a
, 
b
, 
a_Ën
);

269 
	}
}

271 ’um { 
	mPARSE_INVALID
 = 1, 
	mPARSE_NOT_LONGNAME
, 
	mPARSE_EOF
, };

283 
	$çt_·r£_lÚg
(
šode
 *
dœ
, 
loff_t
 *
pos
,

284 
bufãr_h—d
 **
bh
, 
msdos_dœ_’Œy
 **
de
,

285 
wch¬_t
 **
unicode
, *
Ä_¦Ùs
)

287 
msdos_dœ_¦Ù
 *
ds
;

288 
id
, 
¦Ù
, 
¦Ùs
, 
®Ÿs_checksum
;

290 ià(!*
unicode
) {

291 *
unicode
 = 
	`__g‘Çme
();

292 ià(!*
unicode
) {

293 
	`b»l£
(*
bh
);

294  -
ENOMEM
;

297 
·r£_lÚg
:

298 
¦Ùs
 = 0;

299 
ds
 = (
msdos_dœ_¦Ù
 *)*
de
;

300 
id
 = 
ds
->id;

301 ià(!(
id
 & 0x40))

302  
PARSE_INVALID
;

303 
¦Ùs
 = 
id
 & ~0x40;

304 ià(
¦Ùs
 > 20 || !slots)

305  
PARSE_INVALID
;

306 *
Ä_¦Ùs
 = 
¦Ùs
;

307 
®Ÿs_checksum
 = 
ds
->alias_checksum;

309 
¦Ù
 = 
¦Ùs
;

311 
off£t
;

313 
¦Ù
--;

314 
off£t
 = 
¦Ù
 * 13;

315 
	`çt16_towch¬
(*
unicode
 + 
off£t
, 
ds
->
Çme0_4
, 5);

316 
	`çt16_towch¬
(*
unicode
 + 
off£t
 + 5, 
ds
->
Çme5_10
, 6);

317 
	`çt16_towch¬
(*
unicode
 + 
off£t
 + 11, 
ds
->
Çme11_12
, 2);

319 ià(
ds
->
id
 & 0x40)

320 (*
unicode
)[
off£t
 + 13] = 0;

321 ià(
	`çt_g‘_’Œy
(
dœ
, 
pos
, 
bh
, 
de
) < 0)

322  
PARSE_EOF
;

323 ià(
¦Ù
 == 0)

325 
ds
 = (
msdos_dœ_¦Ù
 *)*
de
;

326 ià(
ds
->
©Œ
 !ð
ATTR_EXT
)

327  
PARSE_NOT_LONGNAME
;

328 ià((
ds
->
id
 & ~0x40è!ð
¦Ù
)

329 
·r£_lÚg
;

330 ià(
ds
->
®Ÿs_checksum
 !=‡lias_checksum)

331 
·r£_lÚg
;

333 ià((*
de
)->
Çme
[0] =ð
DELETED_FLAG
)

335 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_parse_long / DELETED_FLAG \n ");

336  
PARSE_INVALID
;

338 ià((*
de
)->
©Œ
 =ð
ATTR_EXT
)

339 
·r£_lÚg
;

340 ià(
	`IS_FREE
((*
de
)->
Çme
è|| ((*de)->
©Œ
 & 
ATTR_VOLUME
))

341  
PARSE_INVALID
;

342 ià(
	`çt_checksum
((*
de
)->
Çme
è!ð
®Ÿs_checksum
)

343 *
Ä_¦Ùs
 = 0;

346 
	}
}

357 
	$çt_·r£_shÜt
(
su³r_block
 *
sb
,

358 cÚ¡ 
msdos_dœ_’Œy
 *
de
,

359 *
Çme
, 
dÙ_hidd’
)

361 cÚ¡ 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

362 
isvçt
 = 
sbi
->
ÝtiÚs
.isvfat;

363 
noÿ£
 = 
sbi
->
ÝtiÚs
.nocase;

364 
Ýt_shÜŠame
 = 
sbi
->
ÝtiÚs
.
shÜŠame
;

365 
Æs_bË
 *
Æs_disk
 = 
sbi
->nls_disk;

366 
wch¬_t
 
uni_Çme
[14];

367 
c
, 
wÜk
[
MSDOS_NAME
];

368 *
±Çme
 = 
Çme
;

369 
chi
, 
chl
, 
i
, 
j
, 
k
;

370 
dÙoff£t
 = 0;

371 
Çme_Ën
 = 0, 
uni_Ën
 = 0;

373 ià(!
isvçt
 && 
dÙ_hidd’
 && (
de
->
©Œ
 & 
ATTR_HIDDEN
)) {

374 *
±Çme
++ = '.';

375 
dÙoff£t
 = 1;

378 
	`memýy
(
wÜk
, 
de
->
Çme
, (work));

380 ià(
wÜk
[0] == 0x05)

381 
wÜk
[0] = 0xE5;

384 
i
 = 0, 
j
 = 0; i < 8;) {

385 
c
 = 
wÜk
[
i
];

386 ià(!
c
)

388 
chl
 = 
	`çt_shÜŠame2uni
(
Æs_disk
, &
wÜk
[
i
], 8 - i,

389 &
uni_Çme
[
j
++], 
Ýt_shÜŠame
,

390 
de
->
lÿ£
 & 
CASE_LOWER_BASE
);

391 ià(
chl
 <= 1) {

392 ià(!
isvçt
)

393 
±Çme
[
i
] = 
noÿ£
 ? 
c
 : 
	`çt_tÞow”
(c);

394 
i
++;

395 ià(
c
 != ' ') {

396 
Çme_Ën
 = 
i
;

397 
uni_Ën
 = 
j
;

400 
uni_Ën
 = 
j
;

401 ià(
isvçt
)

402 
i
 +ð
	`mš
(
chl
, 8-i);

404 
chi
 = 0; ch˜< 
chl
 && 
i
 < 8; chi++, i++)

405 
±Çme
[
i
] = 
wÜk
[i];

407 ià(
chl
)

408 
Çme_Ën
 = 
i
;

412 
i
 = 
Çme_Ën
;

413 
j
 = 
uni_Ën
;

414 
	`çt_shÜt2uni
(
Æs_disk
, ".", 1, &
uni_Çme
[
j
++]);

415 ià(!
isvçt
)

416 
±Çme
[
i
] = '.';

417 
i
++;

420 
k
 = 8; k < 
MSDOS_NAME
;) {

421 
c
 = 
wÜk
[
k
];

422 ià(!
c
)

424 
chl
 = 
	`çt_shÜŠame2uni
(
Æs_disk
, &
wÜk
[
k
], 
MSDOS_NAME
 - k,

425 &
uni_Çme
[
j
++], 
Ýt_shÜŠame
,

426 
de
->
lÿ£
 & 
CASE_LOWER_EXT
);

427 ià(
chl
 <= 1) {

428 
k
++;

429 ià(!
isvçt
)

430 
±Çme
[
i
] = 
noÿ£
 ? 
c
 : 
	`çt_tÞow”
(c);

431 
i
++;

432 ià(
c
 != ' ') {

433 
Çme_Ën
 = 
i
;

434 
uni_Ën
 = 
j
;

437 
uni_Ën
 = 
j
;

438 ià(
isvçt
) {

439 
off£t
 = 
	`mš
(
chl
, 
MSDOS_NAME
-
k
);

440 
k
 +ð
off£t
;

441 
i
 +ð
off£t
;

443 
chi
 = 0; ch˜< 
chl
 && 
k
 < 
MSDOS_NAME
;

444 
chi
++, 
i
++, 
k
++) {

445 
±Çme
[
i
] = 
wÜk
[
k
];

448 ià(
chl
)

449 
Çme_Ën
 = 
i
;

453 ià(
Çme_Ën
 > 0) {

454 
Çme_Ën
 +ð
dÙoff£t
;

456 ià(
sbi
->
ÝtiÚs
.
isvçt
) {

457 
uni_Çme
[
uni_Ën
] = 0x0000;

458 
Çme_Ën
 = 
	`çt_uni_to_x8
(
sb
, 
uni_Çme
, 
Çme
,

459 
FAT_MAX_SHORT_SIZE
);

463  
Çme_Ën
;

464 
	}
}

469 
	$çt_£¬ch_lÚg
(
šode
 *šode, cÚ¡ *
Çme
,

470 
Çme_Ën
, 
çt_¦Ù_šfo
 *
sšfo
)

472 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

473 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

474 
bufãr_h—d
 *
bh
 = 
NULL
;

475 
msdos_dœ_’Œy
 *
de
;

476 
Ä_¦Ùs
;

477 
wch¬_t
 *
unicode
 = 
NULL
;

478 
buâame
[
FAT_MAX_SHORT_SIZE
];

479 
loff_t
 
ýos
 = 0;

480 
”r
, 
Ën
;

482 
”r
 = -
ENOENT
;

484 ià(
	`çt_g‘_’Œy
(
šode
, &
ýos
, &
bh
, &
de
) == -1)

485 
’d_of_dœ
;

486 
·r£_»cÜd
:

487 
Ä_¦Ùs
 = 0;

488 ià(
de
->
Çme
[0] =ð
DELETED_FLAG
)

493 ià(
de
->
©Œ
 !ð
ATTR_EXT
 && (de->©Œ & 
ATTR_VOLUME
))

495 ià(
de
->
©Œ
 !ð
ATTR_EXT
 && 
	`IS_FREE
(de->
Çme
))

497 ià(
de
->
©Œ
 =ð
ATTR_EXT
) {

498 
¡©us
 = 
	`çt_·r£_lÚg
(
šode
, &
ýos
, &
bh
, &
de
,

499 &
unicode
, &
Ä_¦Ùs
);

500 ià(
¡©us
 < 0) {

501 
”r
 = 
¡©us
;

502 
’d_of_dœ
;

503 } ià(
¡©us
 =ð
PARSE_INVALID
)

505 ià(
¡©us
 =ð
PARSE_NOT_LONGNAME
)

506 
·r£_»cÜd
;

507 ià(
¡©us
 =ð
PARSE_EOF
)

508 
’d_of_dœ
;

516 
Ën
 = 
	`çt_·r£_shÜt
(
sb
, 
de
, 
buâame
, 0);

517 ià(
Ën
 == 0)

521 ià(
	`çt_Çme_m©ch
(
sbi
, 
Çme
, 
Çme_Ën
, 
buâame
, 
Ën
))

522 
found
;

524 ià(
Ä_¦Ùs
) {

525 *
lÚgÇme
 = 
unicode
 + 
FAT_MAX_UNI_CHARS
;

526 
size
 = 
PATH_MAX
 - 
FAT_MAX_UNI_SIZE
;

529 
Ën
 = 
	`çt_uni_to_x8
(
sb
, 
unicode
, 
lÚgÇme
, 
size
);

530 ià(
	`çt_Çme_m©ch
(
sbi
, 
Çme
, 
Çme_Ën
, 
lÚgÇme
, 
Ën
))

531 
found
;

535 
found
:

536 
Ä_¦Ùs
++;

537 
sšfo
->
¦Ù_off
 = 
ýos
 - 
Ä_¦Ùs
 * (*
de
);

538 
sšfo
->
Ä_¦Ùs
 =‚r_slots;

539 
sšfo
->
de
 = de;

540 
sšfo
->
bh
 = bh;

541 
sšfo
->
i_pos
 = 
	`çt_make_i_pos
(
sb
, sšfo->
bh
, sšfo->
de
);

542 
”r
 = 0;

543 
’d_of_dœ
:

544 ià(
unicode
)

545 
	`__puŠame
(
unicode
);

547  
”r
;

548 
	}
}

549 
EXPORT_SYMBOL_GPL
(
çt_£¬ch_lÚg
);

551 
	sçt_ioùl_fžldœ_ÿÎback
 {

552 
__u£r
 *
	mdœ’t
;

553 
	m»suÉ
;

555 cÚ¡ *
	mlÚgÇme
;

556 
	mlÚg_Ën
;

557 cÚ¡ *
	mshÜŠame
;

558 
	mshÜt_Ën
;

561 
	$__çt_»addœ
(
šode
 *šode, 
fže
 *
fžp
, *
dœ’t
,

562 
fžldœ_t
 
fžldœ
, 
shÜt_Úly
, 
bÙh
)

564 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

565 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

566 
bufãr_h—d
 *
bh
;

567 
msdos_dœ_’Œy
 *
de
;

568 
Ä_¦Ùs
;

569 
wch¬_t
 *
unicode
 = 
NULL
;

570 
buâame
[
FAT_MAX_SHORT_SIZE
];

571 
isvçt
 = 
sbi
->
ÝtiÚs
.isvfat;

572 cÚ¡ *
fžl_Çme
 = 
NULL
;

573 
šum
;

574 
Íos
, 
dummy
, *
fu¼fu
 = &lpos;

575 
loff_t
 
ýos
;

576 
shÜt_Ën
 = 0, 
fžl_Ën
 = 0;

577 
»t
 = 0;

579 
	`mu‹x_lock
(&
sbi
->
s_lock
);

581 
ýos
 = 
fžp
->
f_pos
;

583 ià(
šode
->
i_šo
 =ð
MSDOS_ROOT_INO
) {

584 
ýos
 < 2) {

585 ià(
	`fžldœ
(
dœ’t
, "..", 
ýos
+1, cpos,

586 
MSDOS_ROOT_INO
, 
DT_DIR
) < 0)

587 
out
;

588 
ýos
++;

589 
fžp
->
f_pos
++;

591 ià(
ýos
 == 2) {

592 
dummy
 = 2;

593 
fu¼fu
 = &
dummy
;

594 
ýos
 = 0;

597 ià(
ýos
 & ((
msdos_dœ_’Œy
) - 1)) {

598 
»t
 = -
ENOENT
;

599 
out
;

602 
bh
 = 
NULL
;

603 
g‘_Ãw
:

604 ià(
	`çt_g‘_’Œy
(
šode
, &
ýos
, &
bh
, &
de
) == -1)

605 
’d_of_dœ
;

606 
·r£_»cÜd
:

607 
Ä_¦Ùs
 = 0;

612 ià(
isvçt
 && !
shÜt_Úly
) {

613 ià(
de
->
Çme
[0] =ð
DELETED_FLAG
)

616 
»cÜd_’d
;

618 ià(
de
->
©Œ
 !ð
ATTR_EXT
 && (de->©Œ & 
ATTR_VOLUME
))

621 
»cÜd_’d
;

623 ià(
de
->
©Œ
 !ð
ATTR_EXT
 && 
	`IS_FREE
(de->
Çme
))

625 
»cÜd_’d
;

628 ià((
de
->
©Œ
 & 
ATTR_VOLUME
è|| 
	`IS_FREE
(de->
Çme
))

629 
»cÜd_’d
;

632 ià(
isvçt
 && 
de
->
©Œ
 =ð
ATTR_EXT
) {

633 
¡©us
 = 
	`çt_·r£_lÚg
(
šode
, &
ýos
, &
bh
, &
de
,

634 &
unicode
, &
Ä_¦Ùs
);

635 ià(
¡©us
 < 0) {

636 
fžp
->
f_pos
 = 
ýos
;

637 
»t
 = 
¡©us
;

638 
out
;

639 } ià(
¡©us
 =ð
PARSE_INVALID
)

640 
»cÜd_’d
;

641 ià(
¡©us
 =ð
PARSE_NOT_LONGNAME
)

642 
·r£_»cÜd
;

643 ià(
¡©us
 =ð
PARSE_EOF
)

644 
’d_of_dœ
;

646 ià(
Ä_¦Ùs
) {

647 *
lÚgÇme
 = 
unicode
 + 
FAT_MAX_UNI_CHARS
;

648 
size
 = 
PATH_MAX
 - 
FAT_MAX_UNI_SIZE
;

649 
Ën
 = 
	`çt_uni_to_x8
(
sb
, 
unicode
, 
lÚgÇme
, 
size
);

651 
fžl_Çme
 = 
lÚgÇme
;

652 
fžl_Ën
 = 
Ën
;

654 ià(!
bÙh
)

655 
¡¬t_fžldœ
;

659 
shÜt_Ën
 = 
	`çt_·r£_shÜt
(
sb
, 
de
, 
buâame
, 
sbi
->
ÝtiÚs
.
dÙsOK
);

660 ià(
shÜt_Ën
 == 0)

661 
»cÜd_’d
;

663 ià(
Ä_¦Ùs
) {

665 
çt_ioùl_fžldœ_ÿÎback
 *
p
 = 
dœ’t
;

667 
p
->
lÚgÇme
 = 
fžl_Çme
;

668 
p
->
lÚg_Ën
 = 
fžl_Ën
;

669 
p
->
shÜŠame
 = 
buâame
;

670 
p
->
shÜt_Ën
 = short_len;

671 
fžl_Çme
 = 
NULL
;

672 
fžl_Ën
 = 0;

674 
fžl_Çme
 = 
buâame
;

675 
fžl_Ën
 = 
shÜt_Ën
;

678 
¡¬t_fžldœ
:

679 
Íos
 = 
ýos
 - (
Ä_¦Ùs
 + 1è* (
msdos_dœ_’Œy
);

680 ià(!
	`memcmp
(
de
->
Çme
, 
MSDOS_DOT
, 
MSDOS_NAME
))

681 
šum
 = 
šode
->
i_šo
;

682 ià(!
	`memcmp
(
de
->
Çme
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
)) {

683 
šum
 = 
	`·»Á_šo
(
fžp
->
f_·th
.
d’Œy
);

685 
loff_t
 
i_pos
 = 
	`çt_make_i_pos
(
sb
, 
bh
, 
de
);

686 
šode
 *
tmp
 = 
	`çt_ig‘
(
sb
, 
i_pos
);

687 ià(
tmp
) {

688 
šum
 = 
tmp
->
i_šo
;

689 
	`ut
(
tmp
);

691 
šum
 = 
	`iunique
(
sb
, 
MSDOS_ROOT_INO
);

694 ià(
	`fžldœ
(
dœ’t
, 
fžl_Çme
, 
fžl_Ën
, *
fu¼fu
, 
šum
,

695 (
de
->
©Œ
 & 
ATTR_DIR
è? 
DT_DIR
 : 
DT_REG
) < 0)

696 
fžl_çžed
;

698 
»cÜd_’d
:

699 
fu¼fu
 = &
Íos
;

700 
fžp
->
f_pos
 = 
ýos
;

701 
g‘_Ãw
;

702 
’d_of_dœ
:

703 
fžp
->
f_pos
 = 
ýos
;

704 
fžl_çžed
:

705 
	`b»l£
(
bh
);

706 ià(
unicode
)

707 
	`__puŠame
(
unicode
);

708 
out
:

709 
	`mu‹x_uÆock
(&
sbi
->
s_lock
);

710  
»t
;

711 
	}
}

713 
	$çt_»addœ
(
fže
 *
fžp
, *
dœ’t
, 
fžldœ_t
 
fžldœ
)

715 
šode
 *šodð
	`fže_šode
(
fžp
);

716  
	`__çt_»addœ
(
šode
, 
fžp
, 
dœ’t
, 
fžldœ
, 0, 0);

717 
	}
}

719 
	#FAT_IOCTL_FILLDIR_FUNC
(
func
, 
dœ’t_ty³
) \

720 
	`func
(*
__buf
, cÚ¡ *
Çme
, 
Çme_Ën
, \

721 
loff_t
 
off£t
, 
u64
 
šo
, 
d_ty³
) \

723 
çt_ioùl_fžldœ_ÿÎback
 *
buf
 = 
__buf
; \

724 
dœ’t_ty³
 
__u£r
 *
d1
 = 
buf
->
dœ’t
; \

725 
dœ’t_ty³
 
__u£r
 *
d2
 = 
d1
 + 1; \

727 ià(
buf
->
»suÉ
) \

728  -
EINVAL
; \

729 
buf
->
»suÉ
++; \

731 ià(
Çme
 !ð
NULL
) { \

733 ià(
Çme_Ën
 >ð(
d1
->
d_Çme
)) \

734 
Çme_Ën
 = (
d1
->
d_Çme
) - 1; \

736 ià(
	`put_u£r
(0, 
d2
->
d_Çme
) || \

737 
	`put_u£r
(0, &
d2
->
d_»þ’
) || \

738 
	`cÝy_to_u£r
(
d1
->
d_Çme
, 
Çme
, 
Çme_Ën
) || \

739 
	`put_u£r
(0, 
d1
->
d_Çme
 + 
Çme_Ën
) || \

740 
	`put_u£r
(
Çme_Ën
, &
d1
->
d_»þ’
)) \

741 
eçuÉ
; \

744 cÚ¡ *
lÚgÇme
 = 
buf
->longname; \

745 
lÚg_Ën
 = 
buf
->long_len; \

746 cÚ¡ *
shÜŠame
 = 
buf
->shortname; \

747 
shÜt_Ën
 = 
buf
->short_len; \

749 ià(
lÚg_Ën
 >ð(
d1
->
d_Çme
)) \

750 
lÚg_Ën
 = (
d1
->
d_Çme
) - 1; \

751 ià(
shÜt_Ën
 >ð(
d1
->
d_Çme
)) \

752 
shÜt_Ën
 = (
d1
->
d_Çme
) - 1; \

754 ià(
	`cÝy_to_u£r
(
d2
->
d_Çme
, 
lÚgÇme
, 
lÚg_Ën
) || \

755 
	`put_u£r
(0, 
d2
->
d_Çme
 + 
lÚg_Ën
) || \

756 
	`put_u£r
(
lÚg_Ën
, &
d2
->
d_»þ’
) || \

757 
	`put_u£r
(
šo
, &
d2
->
d_šo
) || \

758 
	`put_u£r
(
off£t
, &
d2
->
d_off
) || \

759 
	`cÝy_to_u£r
(
d1
->
d_Çme
, 
shÜŠame
, 
shÜt_Ën
) || \

760 
	`put_u£r
(0, 
d1
->
d_Çme
 + 
shÜt_Ën
) || \

761 
	`put_u£r
(
shÜt_Ën
, &
d1
->
d_»þ’
)) \

762 
eçuÉ
; \

765 
eçuÉ
: \

766 
buf
->
»suÉ
 = -
EFAULT
; \

767  -
EFAULT
; \

768 }

	)

770 
	$FAT_IOCTL_FILLDIR_FUNC
(
çt_ioùl_fžldœ
, 
__çt_dœ’t
)

772 
	$çt_ioùl_»addœ
(
šode
 *šode, 
fže
 *
fžp
,

773 
__u£r
 *
dœ’t
, 
fžldœ_t
 
fžldœ
,

774 
shÜt_Úly
, 
bÙh
)

776 
çt_ioùl_fžldœ_ÿÎback
 
buf
;

777 
»t
;

779 
buf
.
dœ’t
 = dirent;

780 
buf
.
»suÉ
 = 0;

781 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

782 
»t
 = -
ENOENT
;

783 ià(!
	`IS_DEADDIR
(
šode
)) {

784 
»t
 = 
	`__çt_»addœ
(
šode
, 
fžp
, &
buf
, 
fžldœ
,

785 
shÜt_Úly
, 
bÙh
);

787 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

788 ià(
»t
 >= 0)

789 
»t
 = 
buf
.
»suÉ
;

790  
»t
;

791 
	}
}

793 
	$çt_dœ_ioùl
(
fže
 *
fžp
, 
cmd
,

794 
¬g
)

796 
šode
 *šodð
	`fže_šode
(
fžp
);

797 
__çt_dœ’t
 
__u£r
 *
d1
 = (__çt_dœ’ˆ__u£¸*)
¬g
;

798 
shÜt_Úly
, 
bÙh
;

800 
cmd
) {

801 
VFAT_IOCTL_READDIR_SHORT
:

802 
shÜt_Úly
 = 1;

803 
bÙh
 = 0;

805 
VFAT_IOCTL_READDIR_BOTH
:

806 
shÜt_Úly
 = 0;

807 
bÙh
 = 1;

810  
	`çt_g’”ic_ioùl
(
fžp
, 
cmd
, 
¬g
);

813 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
d1
, (
__çt_dœ’t
[2])))

814  -
EFAULT
;

820 ià(
	`put_u£r
(0, &
d1
->
d_»þ’
))

821  -
EFAULT
;

823  
	`çt_ioùl_»addœ
(
šode
, 
fžp
, 
d1
, 
çt_ioùl_fžldœ
,

824 
shÜt_Úly
, 
bÙh
);

825 
	}
}

827 #ifdeà
CONFIG_COMPAT


828 
	#VFAT_IOCTL_READDIR_BOTH32
 
	`_IOR
('r', 1, 
com·t_dœ’t
[2])

	)

829 
	#VFAT_IOCTL_READDIR_SHORT32
 
	`_IOR
('r', 2, 
com·t_dœ’t
[2])

	)

831 
	$FAT_IOCTL_FILLDIR_FUNC
(
çt_com·t_ioùl_fžldœ
, 
com·t_dœ’t
)

833 
	$çt_com·t_dœ_ioùl
(
fže
 *
fžp
, 
cmd
,

834 
¬g
)

836 
šode
 *šodð
	`fže_šode
(
fžp
);

837 
com·t_dœ’t
 
__u£r
 *
d1
 = 
	`com·t_±r
(
¬g
);

838 
shÜt_Úly
, 
bÙh
;

840 
cmd
) {

841 
VFAT_IOCTL_READDIR_SHORT32
:

842 
shÜt_Úly
 = 1;

843 
bÙh
 = 0;

845 
VFAT_IOCTL_READDIR_BOTH32
:

846 
shÜt_Úly
 = 0;

847 
bÙh
 = 1;

850  
	`çt_g’”ic_ioùl
(
fžp
, 
cmd
, ()
¬g
);

853 ià(!
	`acûss_ok
(
VERIFY_WRITE
, 
d1
, (
com·t_dœ’t
[2])))

854  -
EFAULT
;

860 ià(
	`put_u£r
(0, &
d1
->
d_»þ’
))

861  -
EFAULT
;

863  
	`çt_ioùl_»addœ
(
šode
, 
fžp
, 
d1
, 
çt_com·t_ioùl_fžldœ
,

864 
shÜt_Úly
, 
bÙh
);

865 
	}
}

868 cÚ¡ 
fže_Ý”©iÚs
 
	gçt_dœ_Ý”©iÚs
 = {

869 .
Î£ek
 = 
g’”ic_fže_Î£ek
,

870 .
	g»ad
 = 
g’”ic_»ad_dœ
,

871 .
	g»addœ
 = 
çt_»addœ
,

872 .
	guÆocked_ioùl
 = 
çt_dœ_ioùl
,

873 #ifdeà
CONFIG_COMPAT


874 .
	gcom·t_ioùl
 = 
çt_com·t_dœ_ioùl
,

876 .
	gfsync
 = 
çt_fže_fsync
,

879 
	$çt_g‘_shÜt_’Œy
(
šode
 *
dœ
, 
loff_t
 *
pos
,

880 
bufãr_h—d
 **
bh
,

881 
msdos_dœ_’Œy
 **
de
)

883 
	`çt_g‘_’Œy
(
dœ
, 
pos
, 
bh
, 
de
) >= 0) {

885 ià(!
	`IS_FREE
((*
de
)->
Çme
è&& !((*de)->
©Œ
 & 
ATTR_VOLUME
))

888  -
ENOENT
;

889 
	}
}

900 
	$çt_g‘_dÙdÙ_’Œy
(
šode
 *
dœ
, 
bufãr_h—d
 **
bh
,

901 
msdos_dœ_’Œy
 **
de
)

903 
loff_t
 
off£t
 = 0;

905 *
de
 = 
NULL
;

906 
	`çt_g‘_shÜt_’Œy
(
dœ
, &
off£t
, 
bh
, 
de
) >= 0) {

907 ià(!
	`¡ºcmp
((*
de
)->
Çme
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
))

910  -
ENOENT
;

911 
	}
}

912 
EXPORT_SYMBOL_GPL
(
çt_g‘_dÙdÙ_’Œy
);

915 
	$çt_dœ_em±y
(
šode
 *
dœ
)

917 
bufãr_h—d
 *
bh
;

918 
msdos_dœ_’Œy
 *
de
;

919 
loff_t
 
ýos
;

920 
»suÉ
 = 0;

922 
bh
 = 
NULL
;

923 
ýos
 = 0;

924 
	`çt_g‘_shÜt_’Œy
(
dœ
, &
ýos
, &
bh
, &
de
) >= 0) {

925 ià(
	`¡ºcmp
(
de
->
Çme
, 
MSDOS_DOT
 , 
MSDOS_NAME
) &&

926 
	`¡ºcmp
(
de
->
Çme
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
)) {

927 
»suÉ
 = -
ENOTEMPTY
;

931 
	`b»l£
(
bh
);

932  
»suÉ
;

933 
	}
}

934 
EXPORT_SYMBOL_GPL
(
çt_dœ_em±y
);

940 
	$çt_subdœs
(
šode
 *
dœ
)

942 
bufãr_h—d
 *
bh
;

943 
msdos_dœ_’Œy
 *
de
;

944 
loff_t
 
ýos
;

945 
couÁ
 = 0;

947 
bh
 = 
NULL
;

948 
ýos
 = 0;

949 
	`çt_g‘_shÜt_’Œy
(
dœ
, &
ýos
, &
bh
, &
de
) >= 0) {

950 ià(
de
->
©Œ
 & 
ATTR_DIR
)

951 
couÁ
++;

953 
	`b»l£
(
bh
);

954  
couÁ
;

955 
	}
}

961 
	$çt_sÿn
(
šode
 *
dœ
, cÚ¡ *
Çme
,

962 
çt_¦Ù_šfo
 *
sšfo
)

964 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

966 
sšfo
->
¦Ù_off
 = 0;

967 
sšfo
->
bh
 = 
NULL
;

968 
	`çt_g‘_shÜt_’Œy
(
dœ
, &
sšfo
->
¦Ù_off
, &sšfo->
bh
,

969 &
sšfo
->
de
) >= 0) {

975 ià(!
	`¡ºcmp
(
sšfo
->
de
->
Çme
,‚ame, 
MSDOS_NAME
)) {

978 
sšfo
->
¦Ù_off
 -ð(*sšfo->
de
);

979 
sšfo
->
Ä_¦Ùs
 = 1;

980 
sšfo
->
i_pos
 = 
	`çt_make_i_pos
(
sb
, sšfo->
bh
, sšfo->
de
);

985  -
ENOENT
;

986 
	}
}

987 
EXPORT_SYMBOL_GPL
(
çt_sÿn
);

989 
	$çt_sÿn_Ý–
(
šode
 *
dœ
, cÚ¡ *
Çme
,

990 
çt_¦Ù_šfo
 *
sšfo
)

992 
i
 = 0;

993 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

995 
sšfo
->
¦Ù_off
 = 0;

996 
sšfo
->
bh
 = 
NULL
;

998  
i
 = 0 ; i < 50 ; i++ )

1000 
	`çt_g‘_shÜt_’Œy
(
dœ
, &
sšfo
->
¦Ù_off
, &sšfo->
bh
, &sšfo->
de
);

1004 ifÐ
	`¡r¡r
Ð
sšfo
->
de
->
Çme
, "CON" ) !ð
NULL
 && strstr(‚ame, "CON" ) != NULL )

1007 
	`´štk
Ð
KERN_ALERT
 "sšfo->de->Çm: %s %s\n", 
sšfo
->
de
->
Çme
,‚ame );

1010 
sšfo
->
¦Ù_off
 -ð(*sšfo->
de
);

1011 
sšfo
->
Ä_¦Ùs
 = 1;

1012 
sšfo
->
i_pos
 = 
	`çt_make_i_pos
(
sb
, sšfo->
bh
, sšfo->
de
);

1018 ià(!
	`¡ºcmp
(
sšfo
->
de
->
Çme
,‚ame, 
MSDOS_NAME
)) {

1020 
	`´štk
Ð
KERN_ALERT
 "============================\n");

1021 
	`´štk
Ð
KERN_ALERT
 "sšfo->de->Çm: %s %s\n", 
sšfo
->
de
->
Çme
,‚ame );

1024 
sšfo
->
¦Ù_off
 -ð(*sšfo->
de
);

1025 
sšfo
->
Ä_¦Ùs
 = 1;

1026 
sšfo
->
i_pos
 = 
	`çt_make_i_pos
(
sb
, sšfo->
bh
, sšfo->
de
);

1031  -
ENOENT
;

1032 
	}
}

1033 
EXPORT_SYMBOL_GPL
(
çt_sÿn_Ý–
);

1045 
	$çt_sÿn_log¡¬t
(
šode
 *
dœ
, 
i_log¡¬t
,

1046 
çt_¦Ù_šfo
 *
sšfo
)

1048 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1050 
sšfo
->
¦Ù_off
 = 0;

1051 
sšfo
->
bh
 = 
NULL
;

1052 
	`çt_g‘_shÜt_’Œy
(
dœ
, &
sšfo
->
¦Ù_off
, &sšfo->
bh
,

1053 &
sšfo
->
de
) >= 0) {

1054 ià(
	`çt_g‘_¡¬t
(
	`MSDOS_SB
(
sb
), 
sšfo
->
de
è=ð
i_log¡¬t
) {

1055 
sšfo
->
¦Ù_off
 -ð(*sšfo->
de
);

1056 
sšfo
->
Ä_¦Ùs
 = 1;

1057 
sšfo
->
i_pos
 = 
	`çt_make_i_pos
(
sb
, sšfo->
bh
, sšfo->
de
);

1061  -
ENOENT
;

1062 
	}
}

1064 
	$__çt_»move_’Œ›s
(
šode
 *
dœ
, 
loff_t
 
pos
, 
Ä_¦Ùs
)

1066 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1067 
bufãr_h—d
 *
bh
;

1068 
msdos_dœ_’Œy
 *
de
, *
’dp
;

1069 
”r
 = 0, 
Üig_¦Ùs
;

1071 
Ä_¦Ùs
) {

1072 
bh
 = 
NULL
;

1073 ià(
	`çt_g‘_’Œy
(
dœ
, &
pos
, &
bh
, &
de
) < 0) {

1074 
”r
 = -
EIO
;

1078 
Üig_¦Ùs
 = 
Ä_¦Ùs
;

1079 
’dp
 = (
msdos_dœ_’Œy
 *)(
bh
->
b_d©a
 + 
sb
->
s_blocksize
);

1080 
Ä_¦Ùs
 && 
de
 < 
’dp
) {

1084 
de
->
Çme
[0] = 
DELETED_FLAG
;

1085 
de
++;

1086 
Ä_¦Ùs
--;

1088 
	`m¬k_bufãr_dœty_šode
(
bh
, 
dœ
);

1089 ià(
	`IS_DIRSYNC
(
dœ
))

1090 
”r
 = 
	`sync_dœty_bufãr
(
bh
);

1091 
	`b»l£
(
bh
);

1092 ià(
”r
)

1096 
pos
 +ð((
Üig_¦Ùs
 - 
Ä_¦Ùs
è* (*
de
)) - (*de);

1099  
”r
;

1100 
	}
}

1102 
	$çt_»move_’Œ›s
(
šode
 *
dœ
, 
çt_¦Ù_šfo
 *
sšfo
)

1104 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1105 
msdos_dœ_’Œy
 *
de
;

1106 
bufãr_h—d
 *
bh
;

1107 
”r
 = 0, 
Ä_¦Ùs
;

1113 
Ä_¦Ùs
 = 
sšfo
->nr_slots;

1114 
de
 = 
sšfo
->de;

1115 
sšfo
->
de
 = 
NULL
;

1116 
bh
 = 
sšfo
->bh;

1117 
sšfo
->
bh
 = 
NULL
;

1118 
Ä_¦Ùs
 && 
de
 >ð(
msdos_dœ_’Œy
 *)
bh
->
b_d©a
) {

1120 
de
->
Çme
[0] = 
DELETED_FLAG
;

1121 
de
--;

1122 
Ä_¦Ùs
--;

1124 
	`m¬k_bufãr_dœty_šode
(
bh
, 
dœ
);

1125 ià(
	`IS_DIRSYNC
(
dœ
))

1126 
”r
 = 
	`sync_dœty_bufãr
(
bh
);

1127 
	`b»l£
(
bh
);

1128 ià(
”r
)

1129  
”r
;

1130 
dœ
->
i_v”siÚ
++;

1132 ià(
Ä_¦Ùs
) {

1138 
”r
 = 
	`__çt_»move_’Œ›s
(
dœ
, 
sšfo
->
¦Ù_off
, 
Ä_¦Ùs
);

1139 ià(
”r
) {

1140 
	`çt_msg
(
sb
, 
KERN_WARNING
,

1145 
dœ
->
i_mtime
 = dœ->
i_©ime
 = 
CURRENT_TIME_SEC
;

1154 ià(
	`IS_DIRSYNC
(
dœ
))

1155 ()
	`çt_sync_šode
(
dœ
);

1157 
	`m¬k_šode_dœty
(
dœ
);

1160 
	}
}

1161 
EXPORT_SYMBOL_GPL
(
çt_»move_’Œ›s
);

1163 
	$çt_z”Ûd_þu¡”
(
šode
 *
dœ
, 
£ùÜ_t
 
blkÄ
, 
Ä_u£d
,

1164 
bufãr_h—d
 **
bhs
, 
Ä_bhs
)

1166 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1167 
£ùÜ_t
 
Ï¡_blkÄ
 = 
blkÄ
 + 
	`MSDOS_SB
(
sb
)->
£c_³r_þus
;

1168 
”r
, 
i
, 
n
;

1171 
blkÄ
 +ð
Ä_u£d
;

1172 
n
 = 
Ä_u£d
;

1173 
blkÄ
 < 
Ï¡_blkÄ
) {

1174 
bhs
[
n
] = 
	`sb_g‘blk
(
sb
, 
blkÄ
);

1175 ià(!
bhs
[
n
]) {

1176 
”r
 = -
ENOMEM
;

1177 
”rÜ
;

1179 
	`mem£t
(
bhs
[
n
]->
b_d©a
, 0, 
sb
->
s_blocksize
);

1180 
	`£t_bufãr_u±od©e
(
bhs
[
n
]);

1181 
	`m¬k_bufãr_dœty_šode
(
bhs
[
n
], 
dœ
);

1183 
n
++;

1184 
blkÄ
++;

1185 ià(
n
 =ð
Ä_bhs
) {

1186 ià(
	`IS_DIRSYNC
(
dœ
)) {

1187 
”r
 = 
	`çt_sync_bhs
(
bhs
, 
n
);

1188 ià(
”r
)

1189 
”rÜ
;

1191 
i
 = 0; i < 
n
; i++)

1192 
	`b»l£
(
bhs
[
i
]);

1193 
n
 = 0;

1196 ià(
	`IS_DIRSYNC
(
dœ
)) {

1197 
”r
 = 
	`çt_sync_bhs
(
bhs
, 
n
);

1198 ià(
”r
)

1199 
”rÜ
;

1201 
i
 = 0; i < 
n
; i++)

1202 
	`b»l£
(
bhs
[
i
]);

1206 
”rÜ
:

1207 
i
 = 0; i < 
n
; i++)

1208 
	`bfÜg‘
(
bhs
[
i
]);

1209  
”r
;

1210 
	}
}

1212 
	$çt_®loc_Ãw_dœ
(
šode
 *
dœ
, 
time¥ec
 *
ts
)

1214 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1215 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1216 
bufãr_h—d
 *
bhs
[
MAX_BUF_PER_PAGE
];

1217 
msdos_dœ_’Œy
 *
de
;

1218 
£ùÜ_t
 
blkÄ
;

1219 
__Ë16
 
d©e
, 
time
;

1220 
u8
 
time_cs
;

1221 
”r
, 
þu¡”
;

1223 
”r
 = 
	`çt_®loc_þu¡”s
(
dœ
, &
þu¡”
, 1);

1224 ià(
”r
)

1225 
”rÜ
;

1227 
blkÄ
 = 
	`çt_þus_to_blkÄ
(
sbi
, 
þu¡”
);

1228 
bhs
[0] = 
	`sb_g‘blk
(
sb
, 
blkÄ
);

1229 ià(!
bhs
[0]) {

1230 
”r
 = -
ENOMEM
;

1231 
”rÜ_ä“
;

1234 
	`çt_time_unix2çt
(
sbi
, 
ts
, &
time
, &
d©e
, &
time_cs
);

1236 
de
 = (
msdos_dœ_’Œy
 *)
bhs
[0]->
b_d©a
;

1238 
	`memýy
(
de
[0].
Çme
, 
MSDOS_DOT
, 
MSDOS_NAME
);

1239 
	`memýy
(
de
[1].
Çme
, 
MSDOS_DOTDOT
, 
MSDOS_NAME
);

1240 
de
->
©Œ
 = de[1].©Œ = 
ATTR_DIR
;

1241 
de
[0].
lÿ£
 = de[1].lcase = 0;

1242 
de
[0].
time
 = de[1].time =ime;

1243 
de
[0].
d©e
 = de[1].date = date;

1244 ià(
sbi
->
ÝtiÚs
.
isvçt
) {

1246 
de
[0].
ùime
 = de[1].ùimð
time
;

1247 
de
[0].
ùime_cs
 = de[1].ùime_c ð
time_cs
;

1248 
de
[0].
ad©e
 = de[0].
cd©e
 = de[1].ad©ðde[1].cd©ð
d©e
;

1250 
de
[0].
ùime
 = de[1].ctime = 0;

1251 
de
[0].
ùime_cs
 = de[1].ctime_cs = 0;

1252 
de
[0].
ad©e
 = de[0].
cd©e
 = de[1].adate = de[1].cdate = 0;

1254 
	`çt_£t_¡¬t
(&
de
[0], 
þu¡”
);

1255 
	`çt_£t_¡¬t
(&
de
[1], 
	`MSDOS_I
(
dœ
)->
i_log¡¬t
);

1256 
de
[0].
size
 = de[1].size = 0;

1257 
	`mem£t
(
de
 + 2, 0, 
sb
->
s_blocksize
 - 2 * (*de));

1258 
	`£t_bufãr_u±od©e
(
bhs
[0]);

1259 
	`m¬k_bufãr_dœty_šode
(
bhs
[0], 
dœ
);

1261 
”r
 = 
	`çt_z”Ûd_þu¡”
(
dœ
, 
blkÄ
, 1, 
bhs
, 
MAX_BUF_PER_PAGE
);

1262 ià(
”r
)

1263 
”rÜ_ä“
;

1265  
þu¡”
;

1267 
”rÜ_ä“
:

1268 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_alloc_new_dir, fat_free_clusters \n");

1269 
	`çt_ä“_þu¡”s
(
dœ
, 
þu¡”
);

1270 
”rÜ
:

1271  
”r
;

1272 
	}
}

1273 
EXPORT_SYMBOL_GPL
(
çt_®loc_Ãw_dœ
);

1275 
	$çt_add_Ãw_’Œ›s
(
šode
 *
dœ
, *
¦Ùs
, 
Ä_¦Ùs
,

1276 *
Ä_þu¡”
, 
msdos_dœ_’Œy
 **
de
,

1277 
bufãr_h—d
 **
bh
, 
loff_t
 *
i_pos
)

1279 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1280 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1281 
bufãr_h—d
 *
bhs
[
MAX_BUF_PER_PAGE
];

1282 
£ùÜ_t
 
blkÄ
, 
¡¬t_blkÄ
, 
Ï¡_blkÄ
;

1283 
size
, 
cÝy
;

1284 
”r
, 
i
, 
n
, 
off£t
, 
þu¡”
[2];

1291 
size
 = 
Ä_¦Ùs
 * (
msdos_dœ_’Œy
);

1292 *
Ä_þu¡”
 = (
size
 + (
sbi
->
þu¡”_size
 - 1)è>> sbi->
þu¡”_b™s
;

1293 
	`BUG_ON
(*
Ä_þu¡”
 > 2);

1295 
”r
 = 
	`çt_®loc_þu¡”s
(
dœ
, 
þu¡”
, *
Ä_þu¡”
);

1296 ià(
”r
)

1297 
”rÜ
;

1304 
i
 = 
n
 = 
cÝy
 = 0;

1306 
¡¬t_blkÄ
 = 
blkÄ
 = 
	`çt_þus_to_blkÄ
(
sbi
, 
þu¡”
[
i
]);

1307 
Ï¡_blkÄ
 = 
¡¬t_blkÄ
 + 
sbi
->
£c_³r_þus
;

1308 
blkÄ
 < 
Ï¡_blkÄ
) {

1309 
bhs
[
n
] = 
	`sb_g‘blk
(
sb
, 
blkÄ
);

1310 ià(!
bhs
[
n
]) {

1311 
”r
 = -
ENOMEM
;

1312 
”rÜ_nomem
;

1316 
cÝy
 = 
	`mš
(
size
, 
sb
->
s_blocksize
);

1317 
	`memýy
(
bhs
[
n
]->
b_d©a
, 
¦Ùs
, 
cÝy
);

1318 
¦Ùs
 +ð
cÝy
;

1319 
size
 -ð
cÝy
;

1320 
	`£t_bufãr_u±od©e
(
bhs
[
n
]);

1321 
	`m¬k_bufãr_dœty_šode
(
bhs
[
n
], 
dœ
);

1322 ià(!
size
)

1324 
n
++;

1325 
blkÄ
++;

1327 } ++
i
 < *
Ä_þu¡”
);

1329 
	`mem£t
(
bhs
[
n
]->
b_d©a
 + 
cÝy
, 0, 
sb
->
s_blocksize
 - copy);

1330 
off£t
 = 
cÝy
 - (
msdos_dœ_’Œy
);

1331 
	`g‘_bh
(
bhs
[
n
]);

1332 *
bh
 = 
bhs
[
n
];

1333 *
de
 = (
msdos_dœ_’Œy
 *)((*
bh
)->
b_d©a
 + 
off£t
);

1334 *
i_pos
 = 
	`çt_make_i_pos
(
sb
, *
bh
, *
de
);

1337 
”r
 = 
	`çt_z”Ûd_þu¡”
(
dœ
, 
¡¬t_blkÄ
, ++
n
, 
bhs
, 
MAX_BUF_PER_PAGE
);

1338 ià(
”r
)

1339 
”rÜ_ä“
;

1341  
þu¡”
[0];

1343 
”rÜ_ä“
:

1344 
	`b»l£
(*
bh
);

1345 *
bh
 = 
NULL
;

1346 
n
 = 0;

1347 
”rÜ_nomem
:

1348 
i
 = 0; i < 
n
; i++)

1349 
	`bfÜg‘
(
bhs
[
i
]);

1351 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_add_new_entries, fat_free_clusters \n");

1352 
	`çt_ä“_þu¡”s
(
dœ
, 
þu¡”
[0]);

1353 
”rÜ
:

1354  
”r
;

1355 
	}
}

1357 
	$çt_add_’Œ›s
(
šode
 *
dœ
, *
¦Ùs
, 
Ä_¦Ùs
,

1358 
çt_¦Ù_šfo
 *
sšfo
)

1360 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

1361 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1362 
bufãr_h—d
 *
bh
, *
´ev
, *
bhs
[3];

1363 
msdos_dœ_’Œy
 *
	`unš™Ÿlized_v¬
(
de
);

1364 
”r
, 
ä“_¦Ùs
, 
i
, 
Ä_bhs
;

1365 
loff_t
 
pos
, 
i_pos
;

1367 
sšfo
->
Ä_¦Ùs
 =‚r_slots;

1370 
ä“_¦Ùs
 = 
Ä_bhs
 = 0;

1371 
bh
 = 
´ev
 = 
NULL
;

1372 
pos
 = 0;

1373 
”r
 = -
ENOSPC
;

1374 
	`çt_g‘_’Œy
(
dœ
, &
pos
, &
bh
, &
de
) > -1) {

1376 ià(
pos
 >ð
FAT_MAX_DIR_SIZE
)

1377 
”rÜ
;

1379 ià(
	`IS_FREE
(
de
->
Çme
)) {

1380 ià(
´ev
 !ð
bh
) {

1381 
	`g‘_bh
(
bh
);

1382 
bhs
[
Ä_bhs
] = 
´ev
 = 
bh
;

1383 
Ä_bhs
++;

1385 
ä“_¦Ùs
++;

1386 ià(
ä“_¦Ùs
 =ð
Ä_¦Ùs
)

1387 
found
;

1389 
i
 = 0; i < 
Ä_bhs
; i++)

1390 
	`b»l£
(
bhs
[
i
]);

1391 
´ev
 = 
NULL
;

1392 
ä“_¦Ùs
 = 
Ä_bhs
 = 0;

1395 ià(
dœ
->
i_šo
 =ð
MSDOS_ROOT_INO
) {

1396 ià(
sbi
->
çt_b™s
 != 32)

1397 
”rÜ
;

1398 } ià(
	`MSDOS_I
(
dœ
)->
i_¡¬t
 == 0) {

1399 
	`çt_msg
(
sb
, 
KERN_ERR
, "Corrupted directory (i_pos %lld)",

1400 
	`MSDOS_I
(
dœ
)->
i_pos
);

1401 
”r
 = -
EIO
;

1402 
”rÜ
;

1405 
found
:

1406 
”r
 = 0;

1407 
pos
 -ð
ä“_¦Ùs
 * (*
de
);

1408 
Ä_¦Ùs
 -ð
ä“_¦Ùs
;

1409 ià(
ä“_¦Ùs
) {

1415 
size
 = 
ä“_¦Ùs
 * (*
de
);

1416 
off£t
 = 
pos
 & (
sb
->
s_blocksize
 - 1);

1417 
lÚg_bhs
 = 
Ä_bhs
 - (
Ä_¦Ùs
 == 0);

1420 
i
 = 0; i < 
lÚg_bhs
; i++) {

1421 
cÝy
 = 
	`mš_t
(, 
sb
->
s_blocksize
 - 
off£t
, 
size
);

1422 
	`memýy
(
bhs
[
i
]->
b_d©a
 + 
off£t
, 
¦Ùs
, 
cÝy
);

1423 
	`m¬k_bufãr_dœty_šode
(
bhs
[
i
], 
dœ
);

1424 
off£t
 = 0;

1425 
¦Ùs
 +ð
cÝy
;

1426 
size
 -ð
cÝy
;

1428 ià(
lÚg_bhs
 && 
	`IS_DIRSYNC
(
dœ
))

1429 
”r
 = 
	`çt_sync_bhs
(
bhs
, 
lÚg_bhs
);

1430 ià(!
”r
 && 
i
 < 
Ä_bhs
) {

1432 
cÝy
 = 
	`mš_t
(, 
sb
->
s_blocksize
 - 
off£t
, 
size
);

1433 
	`memýy
(
bhs
[
i
]->
b_d©a
 + 
off£t
, 
¦Ùs
, 
cÝy
);

1434 
	`m¬k_bufãr_dœty_šode
(
bhs
[
i
], 
dœ
);

1435 ià(
	`IS_DIRSYNC
(
dœ
))

1436 
”r
 = 
	`sync_dœty_bufãr
(
bhs
[
i
]);

1438 
i
 = 0; i < 
Ä_bhs
; i++)

1439 
	`b»l£
(
bhs
[
i
]);

1440 ià(
”r
)

1441 
”rÜ_»move
;

1444 ià(
Ä_¦Ùs
) {

1445 
þu¡”
, 
Ä_þu¡”
;

1452 
þu¡”
 = 
	`çt_add_Ãw_’Œ›s
(
dœ
, 
¦Ùs
, 
Ä_¦Ùs
, &
Ä_þu¡”
,

1453 &
de
, &
bh
, &
i_pos
);

1454 ià(
þu¡”
 < 0) {

1455 
”r
 = 
þu¡”
;

1456 
”rÜ_»move
;

1458 
”r
 = 
	`çt_chaš_add
(
dœ
, 
þu¡”
, 
Ä_þu¡”
);

1459 ià(
”r
) {

1461 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_add_entries, fat_free_clusters \n");

1463 
	`çt_ä“_þu¡”s
(
dœ
, 
þu¡”
);

1464 
”rÜ_»move
;

1466 ià(
dœ
->
i_size
 & (
sbi
->
þu¡”_size
 - 1)) {

1467 
	`çt_fs_”rÜ
(
sb
, "Odd directory size");

1468 
dœ
->
i_size
 = (dœ->i_siz+ 
sbi
->
þu¡”_size
 - 1)

1469 & ~((
loff_t
)
sbi
->
þu¡”_size
 - 1);

1471 
dœ
->
i_size
 +ð
Ä_þu¡”
 << 
sbi
->
þu¡”_b™s
;

1472 
	`MSDOS_I
(
dœ
)->
mmu_´iv©e
 +ð
Ä_þu¡”
 << 
sbi
->
þu¡”_b™s
;

1474 
sšfo
->
¦Ù_off
 = 
pos
;

1475 
sšfo
->
de
 = de;

1476 
sšfo
->
bh
 = bh;

1477 
sšfo
->
i_pos
 = 
	`çt_make_i_pos
(
sb
, sšfo->
bh
, sšfo->
de
);

1481 
”rÜ
:

1482 
	`b»l£
(
bh
);

1483 
i
 = 0; i < 
Ä_bhs
; i++)

1484 
	`b»l£
(
bhs
[
i
]);

1485  
”r
;

1487 
”rÜ_»move
:

1488 
	`b»l£
(
bh
);

1489 ià(
ä“_¦Ùs
)

1490 
	`__çt_»move_’Œ›s
(
dœ
, 
pos
, 
ä“_¦Ùs
);

1491  
”r
;

1492 
	}
}

1493 
EXPORT_SYMBOL_GPL
(
çt_add_’Œ›s
);

	@fat.h

1 #iâdeà
_FAT_H


2 
	#_FAT_H


	)

4 
	~<lšux/bufãr_h—d.h
>

5 
	~<lšux/¡ršg.h
>

6 
	~<lšux/Æs.h
>

7 
	~<lšux/fs.h
>

8 
	~<lšux/hash.h
>

9 
	~<lšux/mu‹x.h
>

10 
	~<lšux/¿‹lim™.h
>

11 
	~<lšux/msdos_fs.h
>

13 
	#OFF
 0

	)

14 
	#ON
 1

	)

17 
	#NUM_1
 1

18 
	#NUM_2
 2

19 
	#NUM_3
 3

20 
	#NUM_4
 4

21 
	#NUM_5
 5

22 

	)

23 
	#NUM_6
 0

24 

	)

27 
	#DIR_1
 "nÜm®"

	)

28 
	#DIR_2
 "nÜm®_ev’t"

	)

29 
	#DIR_3
 "·rkšg"

	)

30 
	#DIR_4
 "·rkšg_ev’t"

	)

31 
	#DIR_5
 "hªdwÜk"

	)

39 
	#BB_NORMAL
 1

40 
	#BB_NORMAL_EVENT
 2

41 
	#BB_PARKING
 3

42 
	#BB_MANUAL
 4

43 
	#BB_IMAGE
 5

44 

	)

45 
	#BB_ETC
 0

46 

	)

49 
	#NORMAL_DIRECTORY
 "nÜm®"

	)

50 
	#NORMAL_EVENT_DIRECTORY
 "nÜm®_ev’t"

	)

51 
	#PARKING_DIRECTORY
 "·rkšg"

	)

52 
	#MANUAL_DIRECTORY
 "·rkšg_ev’t"

	)

53 
	#HANDWORK_DIRECTORY
 "hªdwÜk"

	)

55 
	#ETC_DIRECTORY
 "‘c"

	)

65 
	#SD_PAGE_SIZE
 4

	)

67 
	#CLUSTER_IN_PAGE
 (
SD_PAGE_SIZE
*256)

68 
	#CLUSTER_IN_BLOCK
 (128)

69 
	#BLOCK_IN_PAGE
 (
SD_PAGE_SIZE
 * 2)

72 

	)

74 
	#ûž
(
x
, 
y
è((xè+ (y - 1))/ (y)

	)

75 
	#æoÜ
(
x
, 
y
è(x)/(y)

	)

76 
	#FAT_ALLOC_CLUSTER
 0

	)

77 
	#FAT_FREE_CLUSTER
 1

	)

78 
	#BX_START
 0

	)

79 
	#BX_END
 1

	)

87 
	#BX_REUPDATE_META_DIFFER
 6

88 

	)

89 
	#NUM_EVNET
 5

90 

	)

91 
	#BX_NORMAL
 0

	)

92 
	#BX_NORMAL_EVENT
 1

	)

93 
	#BX_PARKING_EVENT
 2

	)

94 
	#BX_MANUAL
 3

	)

95 
	#BX_IMAGE
 4

	)

96 
	#BX_ETC
 9

	)

98 
	#NUM_EVNET_DIRECTORY
 6

99 

	)

101 
	#NORMAL_AREA_RATIO
 70

	)

102 
	#NORMAL_EVENT_AREA_RATIO
 20

	)

103 
	#PARKING_EVENT_AREA_RATIO
 10

	)

104 
	#MANUAL_AREA_RATIO
 1

	)

105 
	#IMAGE_AREA_RATIO
 1

	)

106 
	#ETC_AREA_RATIO
 7

	)

117 
	#VFAT_SFN_DISPLAY_LOWER
 0x0001

	)

118 
	#VFAT_SFN_DISPLAY_WIN95
 0x0002

	)

119 
	#VFAT_SFN_DISPLAY_WINNT
 0x0004

	)

120 
	#VFAT_SFN_CREATE_WIN95
 0x0100

	)

121 
	#VFAT_SFN_CREATE_WINNT
 0x0200

	)

123 
	#FAT_ERRORS_CONT
 1

	)

124 
	#FAT_ERRORS_PANIC
 2

	)

125 
	#FAT_ERRORS_RO
 3

	)

127 
	#FAT_NFS_STALE_RW
 1

	)

128 
	#FAT_NFS_NOSTALE_RO
 2

	)

130 
	sçt_mouÁ_ÝtiÚs
 {

131 
kuid_t
 
	mfs_uid
;

132 
kgid_t
 
	mfs_gid
;

133 
	mfs_fmask
;

134 
	mfs_dmask
;

135 
	mcod•age
;

136 
	mtime_off£t
;

137 *
	mioch¬£t
;

138 
	mshÜŠame
;

139 
	mÇme_check
;

140 
	m”rÜs
;

141 
	mnfs
;

142 
	m®low_utime
;

143 
	mqu›t
:1,

144 
	mshowexec
:1,

145 
	msys_immubË
:1,

146 
	mdÙsOK
:1,

147 
	misvçt
:1,

148 
	mutf8
:1,

149 
	municode_xÏ‹
:1,

150 
	mnumž
:1,

151 
	mæush
:1,

152 
	mnoÿ£
:1,

153 
	mu£ä“
:1,

154 
	mtz_£t
:1,

155 
	mrodœ
:1,

156 
	mdisÿrd
:1;

159 
	#FAT_HASH_BITS
 8

	)

160 
	#FAT_HASH_SIZE
 (1UL << 
FAT_HASH_BITS
)

	)

165 
	smsdos_sb_šfo
 {

166 
	m£c_³r_þus
;

167 
	mþu¡”_b™s
;

168 
	mþu¡”_size
;

169 
	mçts
, 
	mçt_b™s
;

170 
	mçt_¡¬t
;

171 
	mçt_Ëngth
;

172 
	mdœ_¡¬t
;

173 
	mdœ_’Œ›s
;

174 
	md©a_¡¬t
;

175 
	mmax_þu¡”
;

176 
	mroÙ_þu¡”
;

177 
	mfsšfo_£ùÜ
;

178 
mu‹x
 
	mçt_lock
;

179 
mu‹x
 
	mnfs_bužd_šode_lock
;

180 
mu‹x
 
	ms_lock
;

181 
	m´ev_ä“
;

182 
	mä“_þu¡”s
;

183 
	mä“_þus_v®id
;

184 
çt_mouÁ_ÝtiÚs
 
	mÝtiÚs
;

185 
Æs_bË
 *
	mÆs_disk
;

186 
Æs_bË
 *
	mÆs_io
;

187 cÚ¡ *
	mdœ_Ýs
;

188 
	mdœ_³r_block
;

189 
	mdœ_³r_block_b™s
;

191 
	mç‹Á_shiá
;

192 
ç‹Á_Ý”©iÚs
 *
	mç‹Á_Ýs
;

193 
šode
 *
	mçt_šode
;

194 
šode
 *
	mfsšfo_šode
;

196 
¿‹lim™_¡©e
 
	m¿‹lim™
;

198 
¥šlock_t
 
	mšode_hash_lock
;

199 
hli¡_h—d
 
	mšode_hashbË
[
FAT_HASH_SIZE
];

201 
¥šlock_t
 
	mdœ_hash_lock
;

202 
hli¡_h—d
 
	mdœ_hashbË
[
FAT_HASH_SIZE
];

204 
	mdœty
;

207 
	mbx_¡¬t_þu¡”
[10];

208 
	mbx_’d_þu¡”
[10];

209 
	mbx_ä“_þu¡”s
[10] ;

210 
	mbx_´ev_ä“
[10];

211 
	mbx_Ãxt_¡¬t
[10];

212 
	mbx_ä“_v®id
;

214 
	mbx_¬—_¿tio
[10];

215 
	mbx_´e_size
[10];

218 
	mi_šo
;

219 cÚ¡ * 
	mfže_Çme
;

220 
	mtime
;

221 
	mcouÁ
;

224 
	mbb_fže_¡¬t
;

225 
	mbb_¥aû_fuÎ
;

226 
	mbb_no_®loc
;

230 
	#FAT_CACHE_VALID
 0

	)

235 
	smsdos_šode_šfo
 {

236 
¥šlock_t
 
	mÿche_Ìu_lock
;

237 
li¡_h—d
 
	mÿche_Ìu
;

238 
	mÄ_ÿches
;

240 
	mÿche_v®id_id
;

243 
loff_t
 
	mmmu_´iv©e
;

245 
	mi_¡¬t
;

246 
	mi_log¡¬t
;

247 
	mi_©Œs
;

248 
loff_t
 
	mi_pos
;

249 
hli¡_node
 
	mi_çt_hash
;

250 
hli¡_node
 
	mi_dœ_hash
;

251 
rw_£m­hÜe
 
	mŒunÿ‹_lock
;

252 
šode
 
	mvfs_šode
;

255 
	sçt_¦Ù_šfo
 {

256 
loff_t
 
	mi_pos
;

257 
loff_t
 
	m¦Ù_off
;

258 
	mÄ_¦Ùs
;

259 
msdos_dœ_’Œy
 *
	mde
;

260 
bufãr_h—d
 *
	mbh
;

263 
šlše
 
msdos_sb_šfo
 *
	$MSDOS_SB
(
su³r_block
 *
sb
)

265  
sb
->
s_fs_šfo
;

266 
	}
}

268 
šlše
 
msdos_šode_šfo
 *
	$MSDOS_I
(
šode
 *inode)

270  
	`cÚš”_of
(
šode
, 
msdos_šode_šfo
, 
vfs_šode
);

271 
	}
}

280 
šlše
 
	$çt_mode_ÿn_hÞd_ro
(
šode
 *inode)

282 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

283 
umode_t
 
mask
;

285 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

286 ià(!
sbi
->
ÝtiÚs
.
rodœ
)

288 
mask
 = ~
sbi
->
ÝtiÚs
.
fs_dmask
;

290 
mask
 = ~
sbi
->
ÝtiÚs
.
fs_fmask
;

292 ià(!(
mask
 & 
S_IWUGO
))

295 
	}
}

298 
šlše
 
umode_t
 
	$çt_make_mode
(
msdos_sb_šfo
 *
sbi
,

299 
u8
 
©Œs
, 
umode_t
 
mode
)

301 ià(
©Œs
 & 
ATTR_RO
 && !(×‰r & 
ATTR_DIR
è&& !
sbi
->
ÝtiÚs
.
rodœ
))

302 
mode
 &ð~
S_IWUGO
;

304 ià(
©Œs
 & 
ATTR_DIR
)

305  (
mode
 & ~
sbi
->
ÝtiÚs
.
fs_dmask
è| 
S_IFDIR
;

307  (
mode
 & ~
sbi
->
ÝtiÚs
.
fs_fmask
è| 
S_IFREG
;

308 
	}
}

311 
šlše
 
u8
 
	$çt_make_©Œs
(
šode
 *inode)

313 
u8
 
©Œs
 = 
	`MSDOS_I
(
šode
)->
i_©Œs
;

314 ià(
	`S_ISDIR
(
šode
->
i_mode
))

315 
©Œs
 |ð
ATTR_DIR
;

316 ià(
	`çt_mode_ÿn_hÞd_ro
(
šode
è&& !(šode->
i_mode
 & 
S_IWUGO
))

317 
©Œs
 |ð
ATTR_RO
;

318  
©Œs
;

319 
	}
}

321 
šlše
 
	$çt_§ve_©Œs
(
šode
 *šode, 
u8
 
©Œs
)

323 ià(
	`çt_mode_ÿn_hÞd_ro
(
šode
))

324 
	`MSDOS_I
(
šode
)->
i_©Œs
 = 
©Œs
 & 
ATTR_UNUSED
;

326 
	`MSDOS_I
(
šode
)->
i_©Œs
 = 
©Œs
 & (
ATTR_UNUSED
 | 
ATTR_RO
);

327 
	}
}

329 
šlše
 
	$çt_checksum
(cÚ¡ 
__u8
 *
Çme
)

331 
s
 = 
Çme
[0];

332 
s
 = (s<<7è+ (s>>1è+ 
Çme
[1]; s = (s<<7) + (s>>1) +‚ame[2];

333 
s
 = (s<<7è+ (s>>1è+ 
Çme
[3]; s = (s<<7) + (s>>1) +‚ame[4];

334 
s
 = (s<<7è+ (s>>1è+ 
Çme
[5]; s = (s<<7) + (s>>1) +‚ame[6];

335 
s
 = (s<<7è+ (s>>1è+ 
Çme
[7]; s = (s<<7) + (s>>1) +‚ame[8];

336 
s
 = (s<<7è+ (s>>1è+ 
Çme
[9]; s = (s<<7) + (s>>1) +‚ame[10];

337  
s
;

338 
	}
}

340 
šlše
 
£ùÜ_t
 
	$çt_þus_to_blkÄ
(
msdos_sb_šfo
 *
sbi
, 
þus
)

342  ((
£ùÜ_t
)
þus
 - 
FAT_START_ENT
è* 
sbi
->
£c_³r_þus


343 + 
sbi
->
d©a_¡¬t
;

344 
	}
}

346 
šlše
 
	$çt_g‘_blkÄ_off£t
(
msdos_sb_šfo
 *
sbi
,

347 
loff_t
 
i_pos
, 
£ùÜ_t
 *
blkÄ
, *
off£t
)

349 *
blkÄ
 = 
i_pos
 >> 
sbi
->
dœ_³r_block_b™s
;

350 *
off£t
 = 
i_pos
 & (
sbi
->
dœ_³r_block
 - 1);

351 
	}
}

353 
šlše
 
loff_t
 
	$çt_i_pos_»ad
(
msdos_sb_šfo
 *
sbi
,

354 
šode
 *inode)

356 
loff_t
 
i_pos
;

357 #ià
BITS_PER_LONG
 == 32

358 
	`¥š_lock
(&
sbi
->
šode_hash_lock
);

360 
i_pos
 = 
	`MSDOS_I
(
šode
)->i_pos;

361 #ià
BITS_PER_LONG
 == 32

362 
	`¥š_uÆock
(&
sbi
->
šode_hash_lock
);

364  
i_pos
;

365 
	}
}

367 
šlše
 
	$çt16_towch¬
(
wch¬_t
 *
d¡
, cÚ¡ 
__u8
 *
¤c
, 
size_t
 
Ën
)

369 #ifdeà
__BIG_ENDIAN


370 
Ën
--) {

371 *
d¡
++ = 
¤c
[0] | (src[1] << 8);

372 
¤c
 += 2;

375 
	`memýy
(
d¡
, 
¤c
, 
Ën
 * 2);

377 
	}
}

379 
šlše
 
	$çt_g‘_¡¬t
(cÚ¡ 
msdos_sb_šfo
 *
sbi
,

380 cÚ¡ 
msdos_dœ_’Œy
 *
de
)

382 
þu¡”
 = 
	`Ë16_to_ýu
(
de
->
¡¬t
);

383 ià(
sbi
->
çt_b™s
 == 32)

384 
þu¡”
 |ð(
	`Ë16_to_ýu
(
de
->
¡¬thi
) << 16);

385  
þu¡”
;

386 
	}
}

388 
šlše
 
	$çt_£t_¡¬t
(
msdos_dœ_’Œy
 *
de
, 
þu¡”
)

390 
de
->
¡¬t
 = 
	`ýu_to_Ë16
(
þu¡”
);

391 
de
->
¡¬thi
 = 
	`ýu_to_Ë16
(
þu¡”
 >> 16);

392 
	}
}

394 
šlše
 
	$çtwch¬_to16
(
__u8
 *
d¡
, cÚ¡ 
wch¬_t
 *
¤c
, 
size_t
 
Ën
)

396 #ifdeà
__BIG_ENDIAN


397 
Ën
--) {

398 
d¡
[0] = *
¤c
 & 0x00FF;

399 
d¡
[1] = (*
¤c
 & 0xFF00) >> 8;

400 
d¡
 += 2;

401 
¤c
++;

404 
	`memýy
(
d¡
, 
¤c
, 
Ën
 * 2);

406 
	}
}

409 
çt_ÿche_šv®_šode
(
šode
 *inode);

410 
çt_g‘_þu¡”
(
šode
 *šode, 
þu¡”
,

411 *
fþus
, *
dþus
);

412 
çt_bm­
(
šode
 *šode, 
£ùÜ_t
 
£ùÜ
, seùÜ_ˆ*
phys
,

413 *
m­³d_blocks
, 
ü—‹
);

416 cÚ¡ 
fže_Ý”©iÚs
 
çt_dœ_Ý”©iÚs
;

417 
çt_£¬ch_lÚg
(
šode
 *šode, cÚ¡ *
Çme
,

418 
Çme_Ën
, 
çt_¦Ù_šfo
 *
sšfo
);

419 
çt_dœ_em±y
(
šode
 *
dœ
);

420 
çt_subdœs
(
šode
 *
dœ
);

421 
çt_sÿn
(
šode
 *
dœ
, cÚ¡ *
Çme
,

422 
çt_¦Ù_šfo
 *
sšfo
);

423 
çt_sÿn_log¡¬t
(
šode
 *
dœ
, 
i_log¡¬t
,

424 
çt_¦Ù_šfo
 *
sšfo
);

425 
çt_g‘_dÙdÙ_’Œy
(
šode
 *
dœ
, 
bufãr_h—d
 **
bh
,

426 
msdos_dœ_’Œy
 **
de
);

427 
çt_®loc_Ãw_dœ
(
šode
 *
dœ
, 
time¥ec
 *
ts
);

428 
çt_add_’Œ›s
(
šode
 *
dœ
, *
¦Ùs
, 
Ä_¦Ùs
,

429 
çt_¦Ù_šfo
 *
sšfo
);

430 
çt_»move_’Œ›s
(
šode
 *
dœ
, 
çt_¦Ù_šfo
 *
sšfo
);

434 
çt_sÿn_Ý–
(
šode
 *
dœ
, cÚ¡ *
Çme
,

435 
çt_¦Ù_šfo
 *
sšfo
);

440 
	sçt_’Œy
 {

441 
	m’Œy
;

443 
u8
 *
	m’t12_p
[2];

444 
__Ë16
 *
	m’t16_p
;

445 
__Ë32
 *
	m’t32_p
;

446 } 
	mu
;

447 
	mÄ_bhs
;

448 
bufãr_h—d
 *
	mbhs
[2];

449 
šode
 *
	mçt_šode
;

452 
šlše
 
	$ç‹Á_š™
(
çt_’Œy
 *
ç‹Á
)

454 
ç‹Á
->
Ä_bhs
 = 0;

455 
ç‹Á
->
’Œy
 = 0;

456 
ç‹Á
->
u
.
’t32_p
 = 
NULL
;

457 
ç‹Á
->
bhs
[0] = f©’t->bhs[1] = 
NULL
;

458 
ç‹Á
->
çt_šode
 = 
NULL
;

459 
	}
}

461 
šlše
 
	$ç‹Á_£t_’Œy
(
çt_’Œy
 *
ç‹Á
, 
’Œy
)

463 
ç‹Á
->
’Œy
 =ƒntry;

464 
ç‹Á
->
u
.
’t32_p
 = 
NULL
;

465 
	}
}

467 
šlše
 
	$ç‹Á_b»l£
(
çt_’Œy
 *
ç‹Á
)

469 
i
;

470 
ç‹Á
->
u
.
’t32_p
 = 
NULL
;

471 
i
 = 0; i < 
ç‹Á
->
Ä_bhs
; i++)

472 
	`b»l£
(
ç‹Á
->
bhs
[
i
]);

473 
ç‹Á
->
Ä_bhs
 = 0;

474 
ç‹Á
->
bhs
[0] = f©’t->bhs[1] = 
NULL
;

475 
ç‹Á
->
çt_šode
 = 
NULL
;

476 
	}
}

478 
ÿÎ_sysfs_cÚŒÞ_show
( );

480 
de_»upd©e
(
su³r_block
 *
sb
, 
šode
 *inode);

481 
þu¡”chaš_»upd©e
(
su³r_block
 *
sb
, 
šode
 *inode);

483 
v›w_ç‹Á_’Œy
( );

484 
g‘_¬—_numb”
Ð*
¬—
, 
šode
 *inode );

487 
çt_upd©e_su³r
(
su³r_block
 *
sb
);

488 
çt_cÚfig_š™
(
su³r_block
 *
sb
);

491 
çt_’t_acûss_š™
(
su³r_block
 *
sb
);

492 
çt_’t_»ad
(
šode
 *šode, 
çt_’Œy
 *
ç‹Á
,

493 
’Œy
);

494 
çt_’t_wr™e
(
šode
 *šode, 
çt_’Œy
 *
ç‹Á
,

495 
Ãw
, 
wa™
);

496 
çt_®loc_þu¡”s
(
šode
 *šode, *
þu¡”
,

497 
Ä_þu¡”
);

498 
çt_®loc_þu¡”
(
šode
 *šode, *
þu¡”
, 
mode
);

500 
çt_ä“_þu¡”s
(
šode
 *šode, 
þu¡”
);

501 
çt_couÁ_ä“_þu¡”s
(
su³r_block
 *
sb
);

503 
çt_couÁ_ä“_þu¡”s_fÜ_¬—
(
su³r_block
 *
sb
);

507 
çt_g’”ic_ioùl
(
fže
 *
fžp
, 
cmd
,

508 
¬g
);

509 cÚ¡ 
fže_Ý”©iÚs
 
çt_fže_Ý”©iÚs
;

510 cÚ¡ 
šode_Ý”©iÚs
 
çt_fže_šode_Ý”©iÚs
;

511 
çt_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
);

512 
çt_Œunÿ‹_blocks
(
šode
 *šode, 
loff_t
 
off£t
);

513 
çt_g‘©Œ
(
vfsmouÁ
 *
mÁ
, 
d’Œy
 *dentry,

514 
k¡©
 *
¡©
);

515 
çt_fže_fsync
(
fže
 *fže, 
loff_t
 
¡¬t
,†off_ˆ
’d
,

516 
d©async
);

519 
çt_©ch
(
šode
 *šode, 
loff_t
 
i_pos
);

520 
çt_d‘ach
(
šode
 *inode);

521 
šode
 *
çt_ig‘
(
su³r_block
 *
sb
, 
loff_t
 
i_pos
);

522 
šode
 *
çt_bužd_šode
(
su³r_block
 *
sb
,

523 
msdos_dœ_’Œy
 *
de
, 
loff_t
 
i_pos
);

524 
çt_sync_šode
(
šode
 *inode);

525 
çt_fžl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
sž’t
,

526 
isvçt
, (*
£tup
)(
su³r_block
 *));

527 
	`çt_fžl_šode
(
šode
 *šode, 
msdos_dœ_’Œy
 *
de
);

529 
	`çt_æush_šodes
(
su³r_block
 *
sb
, 
šode
 *
i1
,

530 
šode
 *
i2
);

531 
šlše
 
	$çt_dœ_hash
(
log¡¬t
)

533  
	`hash_32
(
log¡¬t
, 
FAT_HASH_BITS
);

534 
	}
}

537 
	$__´štf
(3, 4è
__cÞd


538 
	`__çt_fs_”rÜ
(
su³r_block
 *
sb
, 
»pÜt
, cÚ¡ *
fmt
, ...);

539 
	#çt_fs_”rÜ
(
sb
, 
fmt
, 
¬gs
...) \

540 
	`__çt_fs_”rÜ
(
sb
, 1, 
fmt
 , ## 
¬gs
)

	)

541 
	#çt_fs_”rÜ_¿‹lim™
(
sb
, 
fmt
, 
¬gs
...) \

542 
	`__çt_fs_”rÜ
(
sb
, 
	`__¿‹lim™
(&
	`MSDOS_SB
(sb)->
¿‹lim™
), 
fmt
 , ## 
¬gs
)

	)

543 
	$__´štf
(3, 4è
__cÞd


544 
	`çt_msg
(
su³r_block
 *
sb
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...);

545 
	#çt_msg_¿‹lim™
(
sb
, 
Ëv–
, 
fmt
, 
¬gs
...) \

547 ià(
	`__¿‹lim™
(&
	`MSDOS_SB
(
sb
)->
¿‹lim™
)) \

548 
	`çt_msg
(
sb
, 
Ëv–
, 
fmt
, ## 
¬gs
); \

549 
	}
} 0)

	)

550 
çt_þu¡”s_æush
(
su³r_block
 *
sb
);

551 
çt_chaš_add
(
šode
 *šode, 
Ãw_dþus
, 
Ä_þu¡”
);

552 
çt_time_çt2unix
(
msdos_sb_šfo
 *
sbi
, 
time¥ec
 *
ts
,

553 
__Ë16
 
__time
, __Ë16 
__d©e
, 
u8
 
time_cs
);

554 
çt_time_unix2çt
(
msdos_sb_šfo
 *
sbi
, 
time¥ec
 *
ts
,

555 
__Ë16
 *
time
, __Ë16 *
d©e
, 
u8
 *
time_cs
);

556 
çt_sync_bhs
(
bufãr_h—d
 **
bhs
, 
Ä_bhs
);

558 
çt_ÿche_š™
();

559 
çt_ÿche_de¡roy
();

562 cÚ¡ 
expÜt_Ý”©iÚs
 
çt_expÜt_Ýs
;

563 cÚ¡ 
expÜt_Ý”©iÚs
 
çt_expÜt_Ýs_no¡®e
;

566 
	tÎu
;

570 
time_Üd”šg
( );

573 
Üd”
 = 0;

574 
u64
 
´evious_£c
 = 0;

576 ifÐ
´evious_£c
 =ð
g‘_£cÚds
() )

578 
Üd”
++;

582 
Üd”
 = 0;

585 
´evious_£c
 = 
g‘_£cÚds
();

587  
Üd”
;

591 
	#CURRENT_TIME_SEC_OPEL
 ( ( 
time¥ec
 ){ 
	`g‘_£cÚds
(), 
	`time_Üd”šg
(è} )

	)

	@fat.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

20 { 0x1da0d6ÿ, 
__VMLINUX_SYMBOL_STR
(
moduË_Ïyout
) },

21 { 0x¯b31904, 
__VMLINUX_SYMBOL_STR
(
blkdev_issue_disÿrd
) },

22 { 0xb3f803ab, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_de¡roy
) },

23 { 0xã6823e6, 
__VMLINUX_SYMBOL_STR
(
km®loc_ÿches
) },

24 { 0x405c1144, 
__VMLINUX_SYMBOL_STR
(
g‘_£cÚds
) },

25 { 0x7129e5f8, 
__VMLINUX_SYMBOL_STR
(
hex_asc
) },

26 { 0xa27a64bc, 
__VMLINUX_SYMBOL_STR
(
sb_mš_blocksize
) },

27 { 0x343ff613, 
__VMLINUX_SYMBOL_STR
(
m¬k_bufãr_dœty_šode
) },

28 { 0xf5893abf, 
__VMLINUX_SYMBOL_STR
(
up_»ad
) },

29 { 0x75656941, 
__VMLINUX_SYMBOL_STR
(
__b»ad
) },

30 { 0x4c4ãf19, 
__VMLINUX_SYMBOL_STR
(
k”Ãl_¡ack
) },

31 { 0x4986f7dc, 
__VMLINUX_SYMBOL_STR
(
uÆßd_Æs
) },

32 { 0x4e80e6a4, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_Î£ek
) },

33 { 0xd6fbe4ç, 
__VMLINUX_SYMBOL_STR
(
__m¬k_šode_dœty
) },

34 { 0xad¯be1b, 
__VMLINUX_SYMBOL_STR
(
pv_lock_Ýs
) },

35 { 0x60a13e90, 
__VMLINUX_SYMBOL_STR
(
rcu_b¬r›r
) },

36 { 0x815b5dd4, 
__VMLINUX_SYMBOL_STR
(
m©ch_où®
) },

37 { 0x64999478, 
__VMLINUX_SYMBOL_STR
(
cÚge¡iÚ_wa™
) },

38 { 0x92a9c60c, 
__VMLINUX_SYMBOL_STR
(
time_to_tm
) },

39 { 0x751b22f5, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fh_to_·»Á
) },

40 { 0xd00630—, 
__VMLINUX_SYMBOL_STR
(
£q_puts
) },

41 { 0xacf4d843, 
__VMLINUX_SYMBOL_STR
(
m©ch_¡rdup
) },

42 { 0xf80f94b9, 
__VMLINUX_SYMBOL_STR
(
Î_rw_block
) },

43 { 0xÿe232b, 
__VMLINUX_SYMBOL_STR
(
utf16s_to_utf8s
) },

44 { 0x60022c76, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_aio_»ad
) },

45 { 0x5f2—640, 
__VMLINUX_SYMBOL_STR
(
£q_´štf
) },

46 { 0x6729d3df, 
__VMLINUX_SYMBOL_STR
(
__g‘_u£r_4
) },

47 { 0x44e9a829, 
__VMLINUX_SYMBOL_STR
(
m©ch_tok’
) },

48 { 0xb1bf412a, 
__VMLINUX_SYMBOL_STR
(
Çmes_ÿch•
) },

49 { 0xa4c87a2b, 
__VMLINUX_SYMBOL_STR
(
fžem­_fd©awa™_¿nge
) },

50 { 0xe48e40c2, 
__VMLINUX_SYMBOL_STR
(
mu‹x_uÆock
) },

51 { 0x85df9b6c, 
__VMLINUX_SYMBOL_STR
(
¡r£p
) },

52 { 0x9958f35f, 
__VMLINUX_SYMBOL_STR
(
g’”ic_»ad_dœ
) },

53 { 0x9dfd9691, 
__VMLINUX_SYMBOL_STR
(
ig¿b
) },

54 { 0x91715312, 
__VMLINUX_SYMBOL_STR
(
¥rštf
) },

55 { 0xd55bd8eb, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_aio_wr™e
) },

56 { 0x3ed15e48, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_£tsize
) },

57 { 0x57a6ccd0, 
__VMLINUX_SYMBOL_STR
(
down_»ad
) },

58 { 0x4f8b5ddb, 
__VMLINUX_SYMBOL_STR
(
_cÝy_to_u£r
) },

59 { 0xc2d4ac46, 
__VMLINUX_SYMBOL_STR
(
__š£¹_šode_hash
) },

60 { 0x42600f0c, 
__VMLINUX_SYMBOL_STR
(
m·ge_»ad·ges
) },

61 { 0xb8e7û2c, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_8
) },

62 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

63 { 0xe51af1c5, 
__VMLINUX_SYMBOL_STR
(
m·ge_»ad·ge
) },

64 { 0xa9997d55, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_sk
) },

65 { 0x737b“94, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_fs_time
) },

66 { 0xe76c7326, 
__VMLINUX_SYMBOL_STR
(
__mu‹x_š™
) },

67 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
´štk
) },

68 { 0x35799¯2, 
__VMLINUX_SYMBOL_STR
(
d_obš_®Ÿs
) },

69 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

70 { 0x43a46f63, 
__VMLINUX_SYMBOL_STR
(
wr™e_šode_now
) },

71 { 0x7c1372e8, 
__VMLINUX_SYMBOL_STR
(
·nic
) },

72 { 0x8628b40f, 
__VMLINUX_SYMBOL_STR
(
m·ge_wr™•ages
) },

73 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_cÚd_»sched
) },

74 { 0x5a921311, 
__VMLINUX_SYMBOL_STR
(
¡ºcmp
) },

75 { 0x626ac375, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_ä“
) },

76 { 0x16305289, 
__VMLINUX_SYMBOL_STR
(
w¬n_¦ow·th_nuÎ
) },

77 { 0xc3¯f0a9, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_1
) },

78 { 0xf676ffba, 
__VMLINUX_SYMBOL_STR
(
mu‹x_lock
) },

79 { 0xa7190c66, 
__VMLINUX_SYMBOL_STR
(
£t_Æšk
) },

80 { 0xe6d10d80, 
__VMLINUX_SYMBOL_STR
(
__wa™_Ú_bufãr
) },

81 { 0xf9b41805, 
__VMLINUX_SYMBOL_STR
(
£‰r_cÝy
) },

82 { 0x1e6d26a8, 
__VMLINUX_SYMBOL_STR
(
¡r¡r
) },

83 { 0x29009cbb, 
__VMLINUX_SYMBOL_STR
(
sync_dœty_bufãr
) },

84 { 0x9d8589c1, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_·geÿche
) },

85 { 0x4e3567f7, 
__VMLINUX_SYMBOL_STR
(
m©ch_št
) },

86 { 0x3b4ûb4a, 
__VMLINUX_SYMBOL_STR
(
up_wr™e
) },

87 { 0xe6e3b875, 
__VMLINUX_SYMBOL_STR
(
down_wr™e
) },

88 { 0x4¯4713, 
__VMLINUX_SYMBOL_STR
(
__b»l£
) },

89 { 0xã5d4bb2, 
__VMLINUX_SYMBOL_STR
(
sys_tz
) },

90 { 0xab905185, 
__VMLINUX_SYMBOL_STR
(
__f¢Ùify_·»Á
) },

91 { 0x5bd4450b, 
__VMLINUX_SYMBOL_STR
(
šode_š™_Úû
) },

92 { 0xd4919e6b, 
__VMLINUX_SYMBOL_STR
(
mÁ_drÝ_wr™e_fže
) },

93 { 0xc6cbbc89, 
__VMLINUX_SYMBOL_STR
(
ÿ·bË
) },

94 { 0xfÿfd8cb, 
__VMLINUX_SYMBOL_STR
(
šv®id©e_šode_bufãrs
) },

95 { 0x7171121c, 
__VMLINUX_SYMBOL_STR
(
ov”æowgid
) },

96 { 0x5590a034, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc
) },

97 { 0x9«39cc5, 
__VMLINUX_SYMBOL_STR
(
žookup
) },

98 { 0xb2fd5ûb, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_4
) },

99 { 0xa116b0f6, 
__VMLINUX_SYMBOL_STR
(
sync_m­pšg_bufãrs
) },

100 { 0x5de28794, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_mm­
) },

101 { 0xac36df2, 
__VMLINUX_SYMBOL_STR
(
block_wr™e_fuÎ_·ge
) },

102 { 0x908e63e, 
__VMLINUX_SYMBOL_STR
(
g’”ic_cÚt_ex·nd_sim¶e
) },

103 { 0x96e6623c, 
__VMLINUX_SYMBOL_STR
(
lßd_Æs
) },

104 { 0xf0fdf6cb, 
__VMLINUX_SYMBOL_STR
(
__¡ack_chk_çž
) },

105 { 0x79a38e61, 
__VMLINUX_SYMBOL_STR
(
___¿‹lim™
) },

106 { 0xe81e9d1f, 
__VMLINUX_SYMBOL_STR
(
g’”ic_wr™e_’d
) },

107 { 0x6d052c02, 
__VMLINUX_SYMBOL_STR
(
__b»adah—d
) },

108 { 0x1dd92de7, 
__VMLINUX_SYMBOL_STR
(
do_sync_»ad
) },

109 { 0x2d93f738, 
__VMLINUX_SYMBOL_STR
(
mÁ_wªt_wr™e_fže
) },

110 { 0x3ec16c3b, 
__VMLINUX_SYMBOL_STR
(
š_group_p
) },

111 { 0x5e95b1cd, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_umask
) },

112 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__ãÁry__
) },

113 { 0x99630e45, 
__VMLINUX_SYMBOL_STR
(
šode_chªge_ok
) },

114 { 0x721679¯, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc_Œaû
) },

115 { 0xd52bf1û, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_lock
) },

116 { 0xad1d320b, 
__VMLINUX_SYMBOL_STR
(
sync_šode_m‘ad©a
) },

117 { 0xb9506c98, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_ü—‹
) },

118 { 0x1cd1ba02, 
__VMLINUX_SYMBOL_STR
(
ut
) },

119 { 0xbdf99021, 
__VMLINUX_SYMBOL_STR
(
cÚt_wr™e_begš
) },

120 { 0x3e75e752, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_fsync
) },

121 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
kä“
) },

122 { 0x30d371fd, 
__VMLINUX_SYMBOL_STR
(
iunique
) },

123 { 0xe553891f, 
__VMLINUX_SYMBOL_STR
(
šode_dio_wa™
) },

124 { 0xc4d30941, 
__VMLINUX_SYMBOL_STR
(
do_sync_wr™e
) },

125 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
memýy
) },

126 { 0xa75312bc, 
__VMLINUX_SYMBOL_STR
(
ÿÎ_rcu_sched
) },

127 { 0x78594202, 
__VMLINUX_SYMBOL_STR
(
f¢Ùify
) },

128 { 0x28d3ûd7, 
__VMLINUX_SYMBOL_STR
(
wr™e_dœty_bufãr
) },

129 { 0x87295294, 
__VMLINUX_SYMBOL_STR
(
sb_£t_blocksize
) },

130 { 0x4af4e52a, 
__VMLINUX_SYMBOL_STR
(
__bfÜg‘
) },

131 { 0xc88f4d64, 
__VMLINUX_SYMBOL_STR
(
d_make_roÙ
) },

132 { 0xb4309756, 
__VMLINUX_SYMBOL_STR
(
__blockdev_dœeù_IO
) },

133 { 0x5a4896a8, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_2
) },

134 { 0xa6d0dbc, 
__VMLINUX_SYMBOL_STR
(
šode_Ãeds_sync
) },

135 { 0xb81015e0, 
__VMLINUX_SYMBOL_STR
(
fžem­_fd©awr™e_¿nge
) },

136 { 0xa869b68c, 
__VMLINUX_SYMBOL_STR
(
__fšd_g‘_block
) },

137 { 0x8b618d08, 
__VMLINUX_SYMBOL_STR
(
ov”æowuid
) },

138 { 0x3e72e2df, 
__VMLINUX_SYMBOL_STR
(
£cur™y_šode_£‰r
) },

139 { 0x13cdcb34, 
__VMLINUX_SYMBOL_STR
(
m¬k_bufãr_dœty
) },

140 { 0xf728a9c1, 
__VMLINUX_SYMBOL_STR
(
Ãw_šode
) },

141 { 0x384f8773, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_¥liû_»ad
) },

142 { 0xe61b840b, 
__VMLINUX_SYMBOL_STR
(
__g‘blk
) },

143 { 0xd57d5acc, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fh_to_d’Œy
) },

144 { 0xçbe19a3, 
__VMLINUX_SYMBOL_STR
(
þ—r_šode
) },

145 { 0x2a6e6109, 
__VMLINUX_SYMBOL_STR
(
__š™_rw£m
) },

146 { 0x73b6f85d, 
__VMLINUX_SYMBOL_STR
(
fžem­_æush
) },

147 { 0x7ÿ6d8“, 
__VMLINUX_SYMBOL_STR
(
g’”ic_block_bm­
) },

148 { 0x9c43«¯, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fžÏ‰r
) },

149 { 0xfd0abc8, 
__VMLINUX_SYMBOL_STR
(
fžem­_fd©awr™e
) },

150 { 0xe914e41e, 
__VMLINUX_SYMBOL_STR
(
¡rýy
) },

151 { 0x7331c998, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_šode_·ges
) },

154 cÚ¡ 
	g__moduË_d•’ds
[]

155 
__u£d


156 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

160 
MODULE_INFO
(
¤cv”siÚ
, "DC86301ECF505116D00518B");

	@fatent.c

6 
	~<lšux/moduË.h
>

7 
	~<lšux/fs.h
>

8 
	~<lšux/msdos_fs.h
>

9 
	~<lšux/blkdev.h
>

10 
	~"çt.h
"

12 
	#__DEBUG__


	)

16 
su³r_block
 *
	g‹mp_sb
;

18 
	sç‹Á_Ý”©iÚs
 {

19 (*
	m’t_blockÄ
)(
	msu³r_block
 *, , *, 
	m£ùÜ_t
 *);

20 (*
	m’t_£t_±r
)(
	mçt_’Œy
 *, );

21 (*
	m’t_b»ad
)(
	msu³r_block
 *, 
	mçt_’Œy
 *,

22 , 
	m£ùÜ_t
);

23 (*
	m’t_g‘
)(
	mçt_’Œy
 *);

24 (*
	m’t_put
)(
	mçt_’Œy
 *, );

25 (*
	m’t_Ãxt
)(
	mçt_’Œy
 *);

28 
DEFINE_SPINLOCK
(
çt12_’Œy_lock
);

30 
	$çt12_’t_blockÄ
(
su³r_block
 *
sb
, 
’Œy
,

31 *
off£t
, 
£ùÜ_t
 *
blockÄ
)

33 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

34 
by‹s
 = 
’Œy
 + (entry >> 1);

35 
	`WARN_ON
(
’Œy
 < 
FAT_START_ENT
 || 
sbi
->
max_þu¡”
 <=ƒntry);

36 *
off£t
 = 
by‹s
 & (
sb
->
s_blocksize
 - 1);

37 *
blockÄ
 = 
sbi
->
çt_¡¬t
 + (
by‹s
 >> 
sb
->
s_blocksize_b™s
);

38 
	}
}

40 
	$çt_’t_blockÄ
(
su³r_block
 *
sb
, 
’Œy
,

41 *
off£t
, 
£ùÜ_t
 *
blockÄ
)

43 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

44 
by‹s
 = (
’Œy
 << 
sbi
->
ç‹Á_shiá
);

45 
	`WARN_ON
(
’Œy
 < 
FAT_START_ENT
 || 
sbi
->
max_þu¡”
 <=ƒntry);

46 *
off£t
 = 
by‹s
 & (
sb
->
s_blocksize
 - 1);

47 *
blockÄ
 = 
sbi
->
çt_¡¬t
 + (
by‹s
 >> 
sb
->
s_blocksize_b™s
);

48 
	}
}

50 
	$çt12_’t_£t_±r
(
çt_’Œy
 *
ç‹Á
, 
off£t
)

52 
bufãr_h—d
 **
bhs
 = 
ç‹Á
->bhs;

53 ià(
ç‹Á
->
Ä_bhs
 == 1) {

54 
	`WARN_ON
(
off£t
 >ð(
bhs
[0]->
b_size
 - 1));

55 
ç‹Á
->
u
.
’t12_p
[0] = 
bhs
[0]->
b_d©a
 + 
off£t
;

56 
ç‹Á
->
u
.
’t12_p
[1] = 
bhs
[0]->
b_d©a
 + (
off£t
 + 1);

58 
	`WARN_ON
(
off£t
 !ð(
bhs
[0]->
b_size
 - 1));

59 
ç‹Á
->
u
.
’t12_p
[0] = 
bhs
[0]->
b_d©a
 + 
off£t
;

60 
ç‹Á
->
u
.
’t12_p
[1] = 
bhs
[1]->
b_d©a
;

62 
	}
}

64 
	$çt16_’t_£t_±r
(
çt_’Œy
 *
ç‹Á
, 
off£t
)

66 
	`WARN_ON
(
off£t
 & (2 - 1));

67 
ç‹Á
->
u
.
’t16_p
 = (
__Ë16
 *)(ç‹Á->
bhs
[0]->
b_d©a
 + 
off£t
);

68 
	}
}

70 
	$çt32_’t_£t_±r
(
çt_’Œy
 *
ç‹Á
, 
off£t
)

72 
	`WARN_ON
(
off£t
 & (4 - 1));

73 
ç‹Á
->
u
.
’t32_p
 = (
__Ë32
 *)(ç‹Á->
bhs
[0]->
b_d©a
 + 
off£t
);

74 
	}
}

76 
	$çt12_’t_b»ad
(
su³r_block
 *
sb
, 
çt_’Œy
 *
ç‹Á
,

77 
off£t
, 
£ùÜ_t
 
blockÄ
)

79 
bufãr_h—d
 **
bhs
 = 
ç‹Á
->bhs;

81 
	`WARN_ON
(
blockÄ
 < 
	`MSDOS_SB
(
sb
)->
çt_¡¬t
);

82 
ç‹Á
->
çt_šode
 = 
	`MSDOS_SB
(
sb
)->fat_inode;

84 
bhs
[0] = 
	`sb_b»ad
(
sb
, 
blockÄ
);

85 ià(!
bhs
[0])

86 
”r
;

88 ià((
off£t
 + 1è< 
sb
->
s_blocksize
)

89 
ç‹Á
->
Ä_bhs
 = 1;

92 
blockÄ
++;

93 
bhs
[1] = 
	`sb_b»ad
(
sb
, 
blockÄ
);

94 ià(!
bhs
[1])

95 
”r_b»l£
;

96 
ç‹Á
->
Ä_bhs
 = 2;

98 
	`çt12_’t_£t_±r
(
ç‹Á
, 
off£t
);

101 
”r_b»l£
:

102 
	`b»l£
(
bhs
[0]);

103 
”r
:

104 
	`çt_msg
(
sb
, 
KERN_ERR
, "FAT„—d fažed (blockÄ %Îu)", (
Îu
)
blockÄ
);

105  -
EIO
;

106 
	}
}

108 
	$çt_’t_b»ad
(
su³r_block
 *
sb
, 
çt_’Œy
 *
ç‹Á
,

109 
off£t
, 
£ùÜ_t
 
blockÄ
)

111 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
	`MSDOS_SB
(
sb
)->
ç‹Á_Ýs
;

113 
	`WARN_ON
(
blockÄ
 < 
	`MSDOS_SB
(
sb
)->
çt_¡¬t
);

114 
ç‹Á
->
çt_šode
 = 
	`MSDOS_SB
(
sb
)->fat_inode;

115 
ç‹Á
->
bhs
[0] = 
	`sb_b»ad
(
sb
, 
blockÄ
);

116 ià(!
ç‹Á
->
bhs
[0]) {

117 
	`çt_msg
(
sb
, 
KERN_ERR
, "FAT„ead failed (blocknr %llu)",

118 (
Îu
)
blockÄ
);

119  -
EIO
;

121 
ç‹Á
->
Ä_bhs
 = 1;

122 
Ýs
->
	`’t_£t_±r
(
ç‹Á
, 
off£t
);

124 
	}
}

126 
	$çt12_’t_g‘
(
çt_’Œy
 *
ç‹Á
)

128 
u8
 **
’t12_p
 = 
ç‹Á
->
u
.ent12_p;

129 
Ãxt
;

131 
	`¥š_lock
(&
çt12_’Œy_lock
);

132 ià(
ç‹Á
->
’Œy
 & 1)

133 
Ãxt
 = (*
’t12_p
[0] >> 4) | (*ent12_p[1] << 4);

135 
Ãxt
 = (*
’t12_p
[1] << 8) | *ent12_p[0];

136 
	`¥š_uÆock
(&
çt12_’Œy_lock
);

138 
Ãxt
 &= 0x0fff;

139 ià(
Ãxt
 >ð
BAD_FAT12
)

140 
Ãxt
 = 
FAT_ENT_EOF
;

141  
Ãxt
;

142 
	}
}

144 
	$çt16_’t_g‘
(
çt_’Œy
 *
ç‹Á
)

146 
Ãxt
 = 
	`Ë16_to_ýu
(*
ç‹Á
->
u
.
’t16_p
);

147 
	`WARN_ON
(()
ç‹Á
->
u
.
’t16_p
 & (2 - 1));

148 ià(
Ãxt
 >ð
BAD_FAT16
)

149 
Ãxt
 = 
FAT_ENT_EOF
;

150  
Ãxt
;

151 
	}
}

153 
	$çt32_’t_g‘
(
çt_’Œy
 *
ç‹Á
)

155 
Ãxt
 = 
	`Ë32_to_ýu
(*
ç‹Á
->
u
.
’t32_p
) & 0x0fffffff;

159 
	`WARN_ON
(()
ç‹Á
->
u
.
’t32_p
 & (4 - 1));

160 ià(
Ãxt
 >ð
BAD_FAT32
)

164 
Ãxt
 = 
FAT_ENT_EOF
;

166  
Ãxt
;

167 
	}
}

169 
	$çt12_’t_put
(
çt_’Œy
 *
ç‹Á
, 
Ãw
)

171 
u8
 **
’t12_p
 = 
ç‹Á
->
u
.ent12_p;

173 ià(
Ãw
 =ð
FAT_ENT_EOF
)

174 
Ãw
 = 
EOF_FAT12
;

176 
	`¥š_lock
(&
çt12_’Œy_lock
);

177 ià(
ç‹Á
->
’Œy
 & 1) {

178 *
’t12_p
[0] = (
Ãw
 << 4) | (*ent12_p[0] & 0x0f);

179 *
’t12_p
[1] = 
Ãw
 >> 4;

181 *
’t12_p
[0] = 
Ãw
 & 0xff;

182 *
’t12_p
[1] = (*’t12_p[1] & 0xf0è| (
Ãw
 >> 8);

184 
	`¥š_uÆock
(&
çt12_’Œy_lock
);

186 
	`m¬k_bufãr_dœty_šode
(
ç‹Á
->
bhs
[0], f©’t->
çt_šode
);

187 ià(
ç‹Á
->
Ä_bhs
 == 2)

188 
	`m¬k_bufãr_dœty_šode
(
ç‹Á
->
bhs
[1], f©’t->
çt_šode
);

189 
	}
}

191 
	$çt16_’t_put
(
çt_’Œy
 *
ç‹Á
, 
Ãw
)

193 ià(
Ãw
 =ð
FAT_ENT_EOF
)

194 
Ãw
 = 
EOF_FAT16
;

196 *
ç‹Á
->
u
.
’t16_p
 = 
	`ýu_to_Ë16
(
Ãw
);

197 
	`m¬k_bufãr_dœty_šode
(
ç‹Á
->
bhs
[0], f©’t->
çt_šode
);

198 
	}
}

200 
	$çt32_’t_put
(
çt_’Œy
 *
ç‹Á
, 
Ãw
)

203 ifÐ
Ãw
 =ð
FAT_ENT_FREE
 )

208 
	`WARN_ON
(
Ãw
 & 0xf0000000);

209 
Ãw
 |ð
	`Ë32_to_ýu
(*
ç‹Á
->
u
.
’t32_p
) & ~0x0fffffff;

210 *
ç‹Á
->
u
.
’t32_p
 = 
	`ýu_to_Ë32
(
Ãw
);

211 
	`m¬k_bufãr_dœty_šode
(
ç‹Á
->
bhs
[0], f©’t->
çt_šode
);

212 
	}
}

214 
	$çt12_’t_Ãxt
(
çt_’Œy
 *
ç‹Á
)

216 
u8
 **
’t12_p
 = 
ç‹Á
->
u
.ent12_p;

217 
bufãr_h—d
 **
bhs
 = 
ç‹Á
->bhs;

218 
u8
 *
Ãx
 = 
’t12_p
[1] + 1 + (
ç‹Á
->
’Œy
 & 1);

220 
ç‹Á
->
’Œy
++;

221 ià(
ç‹Á
->
Ä_bhs
 == 1) {

222 
	`WARN_ON
(
’t12_p
[0] > (
u8
 *)(
bhs
[0]->
b_d©a
 +

223 (
bhs
[0]->
b_size
 - 2)));

224 
	`WARN_ON
(
’t12_p
[1] > (
u8
 *)(
bhs
[0]->
b_d©a
 +

225 (
bhs
[0]->
b_size
 - 1)));

226 ià(
Ãx
 < (
u8
 *)(
bhs
[0]->
b_d©a
 + (bhs[0]->
b_size
 - 1))) {

227 
’t12_p
[0] = 
Ãx
 - 1;

228 
’t12_p
[1] = 
Ãx
;

232 
	`WARN_ON
(
’t12_p
[0] !ð(
u8
 *)(
bhs
[0]->
b_d©a
 +

233 (
bhs
[0]->
b_size
 - 1)));

234 
	`WARN_ON
(
’t12_p
[1] !ð(
u8
 *)
bhs
[1]->
b_d©a
);

235 
’t12_p
[0] = 
Ãx
 - 1;

236 
’t12_p
[1] = 
Ãx
;

237 
	`b»l£
(
bhs
[0]);

238 
bhs
[0] = bhs[1];

239 
ç‹Á
->
Ä_bhs
 = 1;

242 
’t12_p
[0] = 
NULL
;

243 
’t12_p
[1] = 
NULL
;

245 
	}
}

247 
	$çt16_’t_Ãxt
(
çt_’Œy
 *
ç‹Á
)

249 cÚ¡ 
bufãr_h—d
 *
bh
 = 
ç‹Á
->
bhs
[0];

250 
ç‹Á
->
’Œy
++;

251 ià(
ç‹Á
->
u
.
’t16_p
 < (
__Ë16
 *)(
bh
->
b_d©a
 + (bh->
b_size
 - 2))) {

252 
ç‹Á
->
u
.
’t16_p
++;

255 
ç‹Á
->
u
.
’t16_p
 = 
NULL
;

257 
	}
}

259 
	$çt32_’t_Ãxt
(
çt_’Œy
 *
ç‹Á
)

261 cÚ¡ 
bufãr_h—d
 *
bh
 = 
ç‹Á
->
bhs
[0];

262 
ç‹Á
->
’Œy
++;

263 ià(
ç‹Á
->
u
.
’t32_p
 < (
__Ë32
 *)(
bh
->
b_d©a
 + (bh->
b_size
 - 4))) {

264 
ç‹Á
->
u
.
’t32_p
++;

267 
ç‹Á
->
u
.
’t32_p
 = 
NULL
;

269 
	}
}

271 
ç‹Á_Ý”©iÚs
 
	gçt12_Ýs
 = {

272 .
’t_blockÄ
 = 
çt12_’t_blockÄ
,

273 .
	g’t_£t_±r
 = 
çt12_’t_£t_±r
,

274 .
	g’t_b»ad
 = 
çt12_’t_b»ad
,

275 .
	g’t_g‘
 = 
çt12_’t_g‘
,

276 .
	g’t_put
 = 
çt12_’t_put
,

277 .
	g’t_Ãxt
 = 
çt12_’t_Ãxt
,

280 
ç‹Á_Ý”©iÚs
 
	gçt16_Ýs
 = {

281 .
’t_blockÄ
 = 
çt_’t_blockÄ
,

282 .
	g’t_£t_±r
 = 
çt16_’t_£t_±r
,

283 .
	g’t_b»ad
 = 
çt_’t_b»ad
,

284 .
	g’t_g‘
 = 
çt16_’t_g‘
,

285 .
	g’t_put
 = 
çt16_’t_put
,

286 .
	g’t_Ãxt
 = 
çt16_’t_Ãxt
,

289 
ç‹Á_Ý”©iÚs
 
	gçt32_Ýs
 = {

290 .
’t_blockÄ
 = 
çt_’t_blockÄ
,

291 .
	g’t_£t_±r
 = 
çt32_’t_£t_±r
,

292 .
	g’t_b»ad
 = 
çt_’t_b»ad
,

293 .
	g’t_g‘
 = 
çt32_’t_g‘
,

294 .
	g’t_put
 = 
çt32_’t_put
,

295 .
	g’t_Ãxt
 = 
çt32_’t_Ãxt
,

298 
šlše
 
	$lock_çt
(
msdos_sb_šfo
 *
sbi
)

300 
	`mu‹x_lock
(&
sbi
->
çt_lock
);

301 
	}
}

303 
šlše
 
	$uÆock_çt
(
msdos_sb_šfo
 *
sbi
)

305 
	`mu‹x_uÆock
(&
sbi
->
çt_lock
);

306 
	}
}

308 
	$çt_’t_acûss_š™
(
su³r_block
 *
sb
)

310 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

312 
	`mu‹x_š™
(&
sbi
->
çt_lock
);

314 
sbi
->
çt_b™s
) {

316 
sbi
->
ç‹Á_shiá
 = 2;

317 
sbi
->
ç‹Á_Ýs
 = &
çt32_Ýs
;

320 
sbi
->
ç‹Á_shiá
 = 1;

321 
sbi
->
ç‹Á_Ýs
 = &
çt16_Ýs
;

324 
sbi
->
ç‹Á_shiá
 = -1;

325 
sbi
->
ç‹Á_Ýs
 = &
çt12_Ýs
;

328 
	}
}

330 
	$m¬k_fsšfo_dœty
(
su³r_block
 *
sb
)

332 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

334 ià(
sb
->
s_æags
 & 
MS_RDONLY
 || 
sbi
->
çt_b™s
 != 32)

337 
	`__m¬k_šode_dœty
(
sbi
->
fsšfo_šode
, 
I_DIRTY_SYNC
);

338 
	}
}

340 
šlše
 
	$çt_’t_upd©e_±r
(
su³r_block
 *
sb
,

341 
çt_’Œy
 *
ç‹Á
,

342 
off£t
, 
£ùÜ_t
 
blockÄ
)

344 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

345 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

346 
bufãr_h—d
 **
bhs
 = 
ç‹Á
->bhs;

349 ià(!
ç‹Á
->
Ä_bhs
 || 
bhs
[0]->
b_blockÄ
 !ð
blockÄ
)

351 ià(
sbi
->
çt_b™s
 == 12) {

352 ià((
off£t
 + 1è< 
sb
->
s_blocksize
) {

354 ià(
ç‹Á
->
Ä_bhs
 == 2) {

355 
	`b»l£
(
bhs
[1]);

356 
ç‹Á
->
Ä_bhs
 = 1;

360 ià(
ç‹Á
->
Ä_bhs
 != 2)

362 ià(
bhs
[1]->
b_blockÄ
 !ð(
blockÄ
 + 1))

366 
Ýs
->
	`’t_£t_±r
(
ç‹Á
, 
off£t
);

368 
	}
}

370 
	$çt_’t_»ad
(
šode
 *šode, 
çt_’Œy
 *
ç‹Á
, 
’Œy
)

372 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

373 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

374 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

375 
”r
, 
off£t
;

376 
£ùÜ_t
 
blockÄ
;

378 ià(
’Œy
 < 
FAT_START_ENT
 || 
sbi
->
max_þu¡”
 <=ƒntry) {

379 
	`ç‹Á_b»l£
(
ç‹Á
);

380 
	`çt_fs_”rÜ
(
sb
, "šv®id‡cûs tØFAT (’Œy 0x%08x)", 
’Œy
);

381  -
EIO
;

384 
	`ç‹Á_£t_’Œy
(
ç‹Á
, 
’Œy
);

385 
Ýs
->
	`’t_blockÄ
(
sb
, 
’Œy
, &
off£t
, &
blockÄ
);

387 ià(!
	`çt_’t_upd©e_±r
(
sb
, 
ç‹Á
, 
off£t
, 
blockÄ
)) {

388 
	`ç‹Á_b»l£
(
ç‹Á
);

389 
”r
 = 
Ýs
->
	`’t_b»ad
(
sb
, 
ç‹Á
, 
off£t
, 
blockÄ
);

390 ià(
”r
)

391  
”r
;

393  
Ýs
->
	`’t_g‘
(
ç‹Á
);

394 
	}
}

397 
	$çt_mœrÜ_bhs
(
su³r_block
 *
sb
, 
bufãr_h—d
 **
bhs
,

398 
Ä_bhs
)

400 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

401 
bufãr_h—d
 *
c_bh
;

402 
”r
, 
n
, 
cÝy
;

404 
”r
 = 0;

405 
cÝy
 = 1; cÝy < 
sbi
->
çts
; copy++) {

406 
£ùÜ_t
 
backup_çt
 = 
sbi
->
çt_Ëngth
 * 
cÝy
;

408 
n
 = 0;‚ < 
Ä_bhs
;‚++) {

409 
c_bh
 = 
	`sb_g‘blk
(
sb
, 
backup_çt
 + 
bhs
[
n
]->
b_blockÄ
);

410 ià(!
c_bh
) {

411 
”r
 = -
ENOMEM
;

412 
”rÜ
;

414 
	`memýy
(
c_bh
->
b_d©a
, 
bhs
[
n
]->b_d©a, 
sb
->
s_blocksize
);

415 
	`£t_bufãr_u±od©e
(
c_bh
);

416 
	`m¬k_bufãr_dœty_šode
(
c_bh
, 
sbi
->
çt_šode
);

417 ià(
sb
->
s_æags
 & 
MS_SYNCHRONOUS
)

418 
”r
 = 
	`sync_dœty_bufãr
(
c_bh
);

419 
	`b»l£
(
c_bh
);

420 ià(
”r
)

421 
”rÜ
;

424 
”rÜ
:

425  
”r
;

426 
	}
}

428 
	$çt_’t_wr™e
(
šode
 *šode, 
çt_’Œy
 *
ç‹Á
,

429 
Ãw
, 
wa™
)

431 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

432 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
	`MSDOS_SB
(
sb
)->
ç‹Á_Ýs
;

433 
”r
;

435 
Ýs
->
	`’t_put
(
ç‹Á
, 
Ãw
);

436 ià(
wa™
) {

437 
”r
 = 
	`çt_sync_bhs
(
ç‹Á
->
bhs
, f©’t->
Ä_bhs
);

438 ià(
”r
)

439  
”r
;

441  
	`çt_mœrÜ_bhs
(
sb
, 
ç‹Á
->
bhs
, f©’t->
Ä_bhs
);

442 
	}
}

444 
šlše
 
	$çt_’t_Ãxt
(
msdos_sb_šfo
 *
sbi
,

445 
çt_’Œy
 *
ç‹Á
)

447 ià(
sbi
->
ç‹Á_Ýs
->
	`’t_Ãxt
(
ç‹Á
)) {

448 ià(
ç‹Á
->
’Œy
 < 
sbi
->
max_þu¡”
)

452 
	}
}

454 
šlše
 
	$çt_’t_»ad_block
(
su³r_block
 *
sb
,

455 
çt_’Œy
 *
ç‹Á
)

457 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
	`MSDOS_SB
(
sb
)->
ç‹Á_Ýs
;

458 
£ùÜ_t
 
blockÄ
;

459 
off£t
;

461 
	`ç‹Á_b»l£
(
ç‹Á
);

462 
Ýs
->
	`’t_blockÄ
(
sb
, 
ç‹Á
->
’Œy
, &
off£t
, &
blockÄ
);

463  
Ýs
->
	`’t_b»ad
(
sb
, 
ç‹Á
, 
off£t
, 
blockÄ
);

464 
	}
}

466 
	$çt_cÞËù_bhs
(
bufãr_h—d
 **
bhs
, *
Ä_bhs
,

467 
çt_’Œy
 *
ç‹Á
)

469 
n
, 
i
;

471 
n
 = 0;‚ < 
ç‹Á
->
Ä_bhs
;‚++) {

472 
i
 = 0; i < *
Ä_bhs
; i++) {

473 ià(
ç‹Á
->
bhs
[
n
] =ðbhs[
i
])

476 ià(
i
 =ð*
Ä_bhs
) {

477 
	`g‘_bh
(
ç‹Á
->
bhs
[
n
]);

478 
bhs
[
i
] = 
ç‹Á
->bhs[
n
];

479 (*
Ä_bhs
)++;

482 
	}
}

484 
	$v›w_ç‹Á_’Œy
( )

486 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
Ð
‹mp_sb
 );

487 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

488 
çt_’Œy
 
ç‹Á
;

489 
couÁ
, 
”r
, 
i
;

490 
’Œy
 = 0;

492 
sucûssive_d©a
 = 1;

493 
‹mp_’Œy
 = 0;

494 
æag
 = 0, 
¡¬t
 = 0, 
’d
 = 0;

496 
	`´štk
Ð
KERN_ALERT
 "[cheon] view_fatent_entry()est \n");

497 
couÁ
 = 
FAT_START_ENT
;

499  
i
 = 1 ; i <= 4; i++ )

501 
	`ç‹Á_š™
Ð&
ç‹Á
 );

502 
	`ç‹Á_£t_’Œy
Ð&
ç‹Á
, 
sbi
->
bx_¡¬t_þu¡”
[ 
i
 ] );

504  
couÁ
 < 
sbi
->
max_þu¡”
 )

506 ifÐ
ç‹Á
.
’Œy
 >ð
sbi
->
max_þu¡”
 )

507 
ç‹Á
.
’Œy
 = 
FAT_START_ENT
;

509 
	`ç‹Á_£t_’Œy
Ð&
ç‹Á
, f©’t.
’Œy
 );

510 
”r
 = 
	`çt_’t_»ad_block
Ð
‹mp_sb
, &
ç‹Á
 );

511 ifÐ
”r
 )

512 
out
;

516 ifÐ
Ýs
->
	`’t_g‘
Ð&
ç‹Á
 ) =ð
FAT_ENT_FREE
 )

518 
’Œy
 = 
ç‹Á
.entry;

519 ifÐ
’Œy
 =ð
‹mp_’Œy
 + 1 )

521 
sucûssive_d©a
++;

523 ifÐ
æag
 =ð0 ) 
¡¬t
 = 
‹mp_’Œy
;

525 
’d
 = 
’Œy
;

527 
æag
 = 1;

529 
‹mp_’Œy
 = 
’Œy
;

534 ifÐ
æag
 == 1 )

536 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] [%d ~ %d ]\t: %luM \n",
¡¬t
, 
’d
, 
sucûssive_d©a
 * 4096 / 1024 / 1024 );

538 
sucûssive_d©a
 = 1;

539 
æag
 = 0;

542 ifÐ
ç‹Á
.
’Œy
 =ð
sbi
->
bx_’d_þu¡”
[ 
i
 ] )

544 ifÐ
æag
 == 1 )

546 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] [%d ~ %d ]\t: %luM \n",
¡¬t
, 
’d
, 
sucûssive_d©a
 * 4096 / 1024 / 1024 );

548 
sucûssive_d©a
 = 1;

549 
æag
 = 0;

551 
out
;

554  
	`çt_’t_Ãxt
Ð
sbi
, &
ç‹Á
 ) );

556 
out
:

557 
	`ç‹Á_b»l£
Ð&
ç‹Á
 );

561 
	}
}

562 
EXPORT_SYMBOL_GPL
Ð
v›w_ç‹Á_’Œy
 );

572 
	$v›w_ç‹Á_’Œy
( )

574 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
Ð
‹mp_sb
 );

575 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

576 
çt_’Œy
 
ç‹Á
;

577 
couÁ
, 
”r
, 
i
;

579 
	`´štk
Ð
KERN_ALERT
 "[cheon] view_fatent_entry() \n");

581 
couÁ
 = 
FAT_START_ENT
;

583  
i
 = 
BB_NORMAL
 ; i <ð
BB_IMAGE
 ; i++ )

585 
	`ç‹Á_š™
Ð&
ç‹Á
 );

586 
	`ç‹Á_£t_’Œy
Ð&
ç‹Á
, 
sbi
->
bx_¡¬t_þu¡”
[ 
i
 ] );

588  
couÁ
 < 
sbi
->
max_þu¡”
 )

590 ifÐ
ç‹Á
.
’Œy
 >ð
sbi
->
max_þu¡”
 )

591 
ç‹Á
.
’Œy
 = 
FAT_START_ENT
;

593 
	`ç‹Á_£t_’Œy
Ð&
ç‹Á
, f©’t.
’Œy
 );

594 
”r
 = 
	`çt_’t_»ad_block
Ð
‹mp_sb
, &
ç‹Á
 );

595 ifÐ
”r
 )

596 
out
;

599 ifÐ
Ýs
->
	`’t_g‘
Ð&
ç‹Á
 ) =ð
FAT_ENT_FREE
 )

601 
’Œy
 = 
ç‹Á
.entry;

603 
	`´štk
Ð
KERN_ALERT
 "[cheÚ]ƒÁry : %d \n", 
’Œy
 );

608 ifÐ
ç‹Á
.
’Œy
 =ð
sbi
->
bx_’d_þu¡”
[ 
i
 ] )

609 
out
;

612  
	`çt_’t_Ãxt
Ð
sbi
, &
ç‹Á
 ) );

615 
out
:

617 
	`ç‹Á_b»l£
Ð&
ç‹Á
 );

622 
	}
}

623 
EXPORT_SYMBOL_GPL
Ð
v›w_ç‹Á_’Œy
 );

626 
	$çt_®loc_þu¡”
Ð
šode
 *šode, *
þu¡”
, 
mode
 )

628 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

629 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

630 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

631 
çt_’Œy
 
ç‹Á
, 
´ev_’t
;

632 
bufãr_h—d
 *
bhs
[
MAX_BUF_PER_PAGE
];

633 
i
, 
couÁ
, 
”r
, 
Ä_bhs
, 
idx_þus
;

635 if(
mode
 == -1){

637 
	`´štk
("[cheon] Not 'etc'ype file‚eed one cluster‡llocation ! \n");

643 
	`lock_çt
(
sbi
);

645 
”r
 = 
Ä_bhs
 = 
idx_þus
 = 0;

646 
couÁ
 = 
FAT_START_ENT
;

647 
	`ç‹Á_š™
(&
´ev_’t
);

648 
	`ç‹Á_š™
(&
ç‹Á
);

650 
	`ç‹Á_£t_’Œy
(&
ç‹Á
, 0);

652 
couÁ
 < 
sbi
->
max_þu¡”
) {

653 ià(
ç‹Á
.
’Œy
 >ð
sbi
->
max_þu¡”
)

654 
ç‹Á
.
’Œy
 = 
FAT_START_ENT
;

655 if(
ç‹Á
.
’Œy
 < 
FAT_START_ENT
)

656 
ç‹Á
.
’Œy
 = 
FAT_START_ENT
;

659 
	`ç‹Á_£t_’Œy
(&
ç‹Á
, f©’t.
’Œy
);

660 
”r
 = 
	`çt_’t_»ad_block
(
sb
, &
ç‹Á
);

662 ià(
”r
)

663 
out
;

668 ià(
Ýs
->
	`’t_g‘
(&
ç‹Á
è=ð
FAT_ENT_FREE
) {

669 
’Œy
 = 
ç‹Á
.entry;

672 
Ýs
->
	`’t_put
(&
ç‹Á
, 
FAT_ENT_EOF
);

673 ià(
´ev_’t
.
Ä_bhs
)

674 
Ýs
->
	`’t_put
(&
´ev_’t
, 
’Œy
);

676 
	`çt_cÞËù_bhs
(
bhs
, &
Ä_bhs
, &
ç‹Á
);

678 
sbi
->
´ev_ä“
 = 
’Œy
;

682 ià(
sbi
->
ä“_þu¡”s
 != -1){

683 
sbi
->
ä“_þu¡”s
--;

688 
þu¡”
[
idx_þus
] = 
’Œy
;

689 
idx_þus
++;

691 
out
;

695 
couÁ
++;

696 ià(
couÁ
 =ð
sbi
->
max_þu¡”
)

698 } 
	`çt_’t_Ãxt
(
sbi
, &
ç‹Á
));

702 
out
:

703 
	`uÆock_çt
(
sbi
);

704 
	`m¬k_fsšfo_dœty
Ð
sb
 );

705 
	`ç‹Á_b»l£
(&
ç‹Á
);

706 ià(!
”r
) {

707 ià(
	`šode_Ãeds_sync
(
šode
))

708 
”r
 = 
	`çt_sync_bhs
(
bhs
, 
Ä_bhs
);

709 ià(!
”r
)

710 
”r
 = 
	`çt_mœrÜ_bhs
(
sb
, 
bhs
, 
Ä_bhs
);

712 
i
 = 0; i < 
Ä_bhs
; i++)

713 
	`b»l£
(
bhs
[
i
]);

715 ià(
”r
 && 
idx_þus
)

716 
	`çt_ä“_þu¡”s
(
šode
, 
þu¡”
[0]);

718  
”r
;

719 
	}
}

721 
	$çt_®loc_þu¡”s
(
šode
 *šode, *
þu¡”
, 
Ä_þu¡”
)

723 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

726 
‹mp_sb
 = 
sb
;

728 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

729 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

730 
çt_’Œy
 
ç‹Á
, 
´ev_’t
;

731 
bufãr_h—d
 *
bhs
[
MAX_BUF_PER_PAGE
];

732 
i
, 
couÁ
, 
”r
, 
Ä_bhs
, 
idx_þus
;

734 
d’Œy
 *d’Œy = 
NULL
;

735 
d’Œy
 *
p_d’Œy
 = 
NULL
;

736 
¬—
;

738 
	`BUG_ON
(
Ä_þu¡”
 > (
MAX_BUF_PER_PAGE
 / 2));

744 
d’Œy
 = 
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, d’Œy, 
d_u
.
d_®Ÿs
 );

745 
p_d’Œy
 = 
d’Œy
->
d_·»Á
;

748 
	`g‘_¬—_numb”
Ð&
¬—
, 
šode
 );

750 #ifdeà
__ORIGINAL_FAT_TEST__


751 ifÐ
¬—
 =ð
BB_ETC
 )

752 
¬—
 = 
BB_ETC
;

754 
¬—
 = 
BB_NORMAL
;

758 
	`lock_çt
(
sbi
);

759 ià(
sbi
->
ä“_þu¡”s
 !ð-1 && sbi->
ä“_þus_v®id
 &&

760 
sbi
->
ä“_þu¡”s
 < 
Ä_þu¡”
) {

761 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] NØ¥aû stÜag/ cu¼’ˆä“ %u /‚r_þu¡” %d \n", 
sbi
->
ä“_þu¡”s
, 
Ä_þu¡”
 );

762 
	`uÆock_çt
(
sbi
);

763  -
ENOSPC
;

765 #iâdeà
__ORIGINAL_FAT_TEST__


767 ifÐ
sbi
->
bb_¥aû_fuÎ
 =ð
OFF
 )

770 ifÐ
sbi
->
bx_ä“_þu¡”s
[ 
¬—
 ] < 
Ä_þu¡”
 )

772 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] NØ¥aû stÜag/ bx cu¼’ˆä“ %u /‚r_þu¡” %d /‡»¨: %d \n", 
sbi
->
bx_ä“_þu¡”s
[ 
¬—
 ], 
Ä_þu¡”
,‡rea );

774 
	`uÆock_çt
(
sbi
);

775  -
ENOSPC
;

784 
”r
 = 
Ä_bhs
 = 
idx_þus
 = 0;

785 
couÁ
 = 
FAT_START_ENT
;

786 
	`ç‹Á_š™
(&
´ev_’t
);

787 
	`ç‹Á_š™
(&
ç‹Á
);

790 
	`ç‹Á_£t_’Œy
(&
ç‹Á
, 
sbi
->
bx_´ev_ä“
[
¬—
] + 0 );

792 
couÁ
 < 
sbi
->
max_þu¡”
) {

793 ià(
ç‹Á
.
’Œy
 >ð
sbi
->
max_þu¡”
)

794 
ç‹Á
.
’Œy
 = 
FAT_START_ENT
;

795 
	`ç‹Á_£t_’Œy
(&
ç‹Á
, f©’t.
’Œy
);

796 
”r
 = 
	`çt_’t_»ad_block
(
sb
, &
ç‹Á
);

797 ià(
”r
)

798 
out
;

803 ifÐ
sbi
->
bb_¥aû_fuÎ
 =ð
ON
 )

805 ià(
Ýs
->
	`’t_g‘
(&
ç‹Á
è=ð
FAT_ENT_FREE
 )

807 
’Œy
 = 
ç‹Á
.entry;

810 
Ýs
->
	`’t_put
(&
ç‹Á
, 
FAT_ENT_EOF
);

811 ià(
´ev_’t
.
Ä_bhs
)

812 
Ýs
->
	`’t_put
(&
´ev_’t
, 
’Œy
);

815 
	`çt_cÞËù_bhs
(
bhs
, &
Ä_bhs
, &
ç‹Á
);

817 
sbi
->
´ev_ä“
 = 
’Œy
;

818 
sbi
->
bx_´ev_ä“
[ 
¬—
 ] = 
’Œy
;

821 ià(
sbi
->
ä“_þu¡”s
 != -1)

823 
sbi
->
ä“_þu¡”s
--;

824 
sbi
->
bx_ä“_þu¡”s
[ 
¬—
 ]--;

827 
þu¡”
[
idx_þus
] = 
’Œy
;

828 
idx_þus
++;

829 ià(
idx_þus
 =ð
Ä_þu¡”
)

830 
out
;

836 
´ev_’t
 = 
ç‹Á
;

842 ià(
Ýs
->
	`’t_g‘
(&
ç‹Á
è=ð
FAT_ENT_FREE
 && 
sbi
->
bx_¡¬t_þu¡”
[ 
¬—
 ] <ðç‹Á.
’Œy
 && sbi->
bx_’d_þu¡”
[‡rea ] >= fatent.entry )

844 
’Œy
 = 
ç‹Á
.entry;

847 
Ýs
->
	`’t_put
(&
ç‹Á
, 
FAT_ENT_EOF
);

848 ià(
´ev_’t
.
Ä_bhs
)

849 
Ýs
->
	`’t_put
(&
´ev_’t
, 
’Œy
);

852 
	`çt_cÞËù_bhs
(
bhs
, &
Ä_bhs
, &
ç‹Á
);

854 
sbi
->
´ev_ä“
 = 
’Œy
;

855 
sbi
->
bx_´ev_ä“
[ 
¬—
 ] = 
’Œy
;

858 ià(
sbi
->
ä“_þu¡”s
 != -1)

860 
sbi
->
ä“_þu¡”s
--;

861 
sbi
->
bx_ä“_þu¡”s
[ 
¬—
 ]--;

864 
þu¡”
[
idx_þus
] = 
’Œy
;

865 
idx_þus
++;

866 ià(
idx_þus
 =ð
Ä_þu¡”
)

867 
out
;

873 
´ev_’t
 = 
ç‹Á
;

876 
couÁ
++;

877 ià(
couÁ
 =ð
sbi
->
max_þu¡”
)

879 } 
	`çt_’t_Ãxt
(
sbi
, &
ç‹Á
));

883 
sbi
->
ä“_þu¡”s
 = 0;

884 
sbi
->
ä“_þus_v®id
 = 1;

885 
”r
 = -
ENOSPC
;

887 
out
:

889 
	`uÆock_çt
(
sbi
);

890 
	`m¬k_fsšfo_dœty
(
sb
);

891 
	`ç‹Á_b»l£
(&
ç‹Á
);

892 ià(!
”r
) {

893 ià(
	`šode_Ãeds_sync
(
šode
))

894 
”r
 = 
	`çt_sync_bhs
(
bhs
, 
Ä_bhs
);

895 ià(!
”r
)

896 
”r
 = 
	`çt_mœrÜ_bhs
(
sb
, 
bhs
, 
Ä_bhs
);

898 
i
 = 0; i < 
Ä_bhs
; i++)

901 
	`b»l£
(
bhs
[
i
]);

904 ià(
”r
 && 
idx_þus
)

906 
	`´štk
Ð
KERN_ALERT
 "[cheon] ==========fat_free_clustersest \n" );

907 
	`çt_ä“_þu¡”s
(
šode
, 
þu¡”
[0]);

910 #ifdeà
__DEBUG__


913  
”r
;

914 
	}
}

916 
	$çt_ä“_þu¡”s
(
šode
 *šode, 
þu¡”
)

918 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

919 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

920 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

921 
çt_’Œy
 
ç‹Á
;

922 
bufãr_h—d
 *
bhs
[
MAX_BUF_PER_PAGE
];

923 
i
, 
”r
, 
Ä_bhs
;

924 
fœ¡_þ
 = 
þu¡”
, 
dœty_fsšfo
 = 0;

929 
Ä_bhs
 = 0;

930 
	`ç‹Á_š™
(&
ç‹Á
);

931 
	`lock_çt
(
sbi
);

936 
þu¡”
 = 
	`çt_’t_»ad
(
šode
, &
ç‹Á
, cluster);

937 ià(
þu¡”
 < 0) {

938 
”r
 = 
þu¡”
;

939 
”rÜ
;

940 } ià(
þu¡”
 =ð
FAT_ENT_FREE
) {

941 
	`çt_fs_”rÜ
(
sb
, "%s: deleting FATƒntry beyond EOF",

942 
__func__
);

943 
”r
 = -
EIO
;

944 
”rÜ
;

950 ià(
sbi
->
ÝtiÚs
.
disÿrd
) {

956 ià(
þu¡”
 !ð
ç‹Á
.
’Œy
 + 1) {

957 
Ä_þus
 = 
ç‹Á
.
’Œy
 - 
fœ¡_þ
 + 1;

959 
	`sb_issue_disÿrd
(
sb
,

960 
	`çt_þus_to_blkÄ
(
sbi
, 
fœ¡_þ
),

961 
Ä_þus
 * 
sbi
->
£c_³r_þus
,

962 
GFP_NOFS
, 0);

964 
fœ¡_þ
 = 
þu¡”
;

970 
Ýs
->
	`’t_put
(&
ç‹Á
, 
FAT_ENT_FREE
);

971 ià(
sbi
->
ä“_þu¡”s
 != -1) {

972 
sbi
->
ä“_þu¡”s
++;

974 #ifdeà
__ORIGINAL_FAT_TEST__


976 ifÐ
sbi
->
bx_¡¬t_þu¡”
[ 
BB_ETC
 ] <ð
ç‹Á
.
’Œy
 && f©’t.’Œy <ðsbi->
bx_’d_þu¡”
[ BB_ETC ] )

977 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_ETC
 ])++;

979 
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL
 ]++;

982 #iâdeà
__ORIGINAL_FAT_TEST__


983 ifÐ
sbi
->
bx_¡¬t_þu¡”
[ 
BB_ETC
 ] <ð
ç‹Á
.
’Œy
 && f©’t.’Œy <ðsbi->
bx_’d_þu¡”
[ BB_ETC ] )

984 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_ETC
 ])++;

986 ifÐ
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL
 ] <ð
ç‹Á
.
’Œy
 && f©’t.’Œy <ðsbi->
bx_’d_þu¡”
[ BB_NORMAL ] )

987 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL
 ])++;

989 ifÐ
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL_EVENT
 ] <ð
ç‹Á
.
’Œy
 && f©’t.’Œy <ðsbi->
bx_’d_þu¡”
[ BB_NORMAL_EVENT ] )

990 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL_EVENT
 ])++;

992 ifÐ
sbi
->
bx_¡¬t_þu¡”
[ 
BB_PARKING
 ] <ð
ç‹Á
.
’Œy
 && f©’t.’Œy <ðsbi->
bx_’d_þu¡”
[ BB_PARKING ] )

993 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_PARKING
 ])++;

995 ifÐ
sbi
->
bx_¡¬t_þu¡”
[ 
BB_MANUAL
 ] <ð
ç‹Á
.
’Œy
 && f©’t.’Œy <ðsbi->
bx_’d_þu¡”
[ BB_MANUAL ] )

996 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_MANUAL
 ])++;

998 ifÐ
sbi
->
bx_¡¬t_þu¡”
[ 
BB_IMAGE
 ] <ð
ç‹Á
.
’Œy
 && f©’t.’Œy <ðsbi->
bx_’d_þu¡”
[ BB_IMAGE ] )

999 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_IMAGE
 ])++;

1003 #ifdeà
__DEBUG__


1006 
sbi
->
ä“_þu¡”s
, 
ç‹Á
.
’Œy
, sbi->
bx_ä“_þu¡”s
[1] );

1010 
dœty_fsšfo
 = 1;

1014 ià(
Ä_bhs
 + 
ç‹Á
.Ä_bh > 
MAX_BUF_PER_PAGE
) {

1015 ià(
sb
->
s_æags
 & 
MS_SYNCHRONOUS
) {

1016 
”r
 = 
	`çt_sync_bhs
(
bhs
, 
Ä_bhs
);

1017 ià(
”r
)

1018 
”rÜ
;

1020 
”r
 = 
	`çt_mœrÜ_bhs
(
sb
, 
bhs
, 
Ä_bhs
);

1021 ià(
”r
)

1022 
”rÜ
;

1023 
i
 = 0; i < 
Ä_bhs
; i++)

1024 
	`b»l£
(
bhs
[
i
]);

1025 
Ä_bhs
 = 0;

1027 
	`çt_cÞËù_bhs
(
bhs
, &
Ä_bhs
, &
ç‹Á
);

1028 } 
þu¡”
 !ð
FAT_ENT_EOF
);

1030 ià(
sb
->
s_æags
 & 
MS_SYNCHRONOUS
) {

1031 
”r
 = 
	`çt_sync_bhs
(
bhs
, 
Ä_bhs
);

1032 ià(
”r
)

1033 
”rÜ
;

1035 
”r
 = 
	`çt_mœrÜ_bhs
(
sb
, 
bhs
, 
Ä_bhs
);

1036 
”rÜ
:

1037 
	`ç‹Á_b»l£
(&
ç‹Á
);

1038 
i
 = 0; i < 
Ä_bhs
; i++)

1039 
	`b»l£
(
bhs
[
i
]);

1040 
	`uÆock_çt
(
sbi
);

1041 ià(
dœty_fsšfo
)

1042 
	`m¬k_fsšfo_dœty
(
sb
);

1044  
”r
;

1045 
	}
}

1046 
EXPORT_SYMBOL_GPL
(
çt_ä“_þu¡”s
);

1049 
	#FAT_READA_SIZE
 (128 * 1024)

	)

1051 
	$çt_’t_»ada
(
su³r_block
 *
sb
, 
çt_’Œy
 *
ç‹Á
,

1052 
»ada_blocks
)

1054 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
	`MSDOS_SB
(
sb
)->
ç‹Á_Ýs
;

1055 
£ùÜ_t
 
blockÄ
;

1056 
i
, 
off£t
;

1058 
Ýs
->
	`’t_blockÄ
(
sb
, 
ç‹Á
->
’Œy
, &
off£t
, &
blockÄ
);

1060 
i
 = 0; i < 
»ada_blocks
; i++)

1061 
	`sb_b»adah—d
(
sb
, 
blockÄ
 + 
i
);

1062 
	}
}

1064 
	$g‘_¬—_numb”
Ð*
¬—
, 
šode
 *inode )

1066 
d’Œy
 *d’Œy = 
NULL
;

1067 
d’Œy
 *
uµ”_d’Œy
 = 
NULL
;

1068 
‹mp_¬—
 = -1;

1070 
d’Œy
 = 
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, d’Œy, 
d_u
.
d_®Ÿs
 );

1072 ifÐ
	`S_ISDIR
Ð
šode
->
i_mode
è|| 
d’Œy
->
d_·»Á
 =ð
NULL
)

1074 
‹mp_¬—
 = 
BB_ETC
;

1076 
	`´štk
( "[cheon] DE,‡lloc ETC \n");

1080 
uµ”_d’Œy
 = 
d’Œy
->
d_·»Á
;

1082  
uµ”_d’Œy
 !ð
NULL
 )

1084 ifÐ
uµ”_d’Œy
->
d_Çme
.
Çme
 =ð
NULL
 )

1092 if(
	`¡rcmp
(
uµ”_d’Œy
->
d_Çme
.
Çme
, 
DIR_1
 ) == 0 )

1093 
‹mp_¬—
 = 
NUM_1
;

1095 if(
	`¡rcmp
(
uµ”_d’Œy
->
d_Çme
.
Çme
, 
DIR_2
 ) == 0 )

1096 
‹mp_¬—
 = 
NUM_2
;

1098 if(
	`¡rcmp
(
uµ”_d’Œy
->
d_Çme
.
Çme
, 
DIR_3
 ) == 0 )

1099 
‹mp_¬—
 = 
NUM_3
;

1101 if(
	`¡rcmp
(
uµ”_d’Œy
->
d_Çme
.
Çme
, 
DIR_4
 ) == 0 )

1102 
‹mp_¬—
 = 
NUM_4
;

1104 if(
	`¡rcmp
(
uµ”_d’Œy
->
d_Çme
.
Çme
, 
DIR_5
 ) == 0 )

1105 
‹mp_¬—
 = 
NUM_5
;

1108 ifÐ
‹mp_¬—
 != -1 )

1110 ifÐ!
	`¡rcmp
("/", 
uµ”_d’Œy
->
d_Çme
.
Çme
 ) )

1113 
uµ”_d’Œy
 =uµ”_d’Œy->
d_·»Á
;

1118 ifÐ
‹mp_¬—
 == -1 )

1120 *
¬—
 = 
BB_ETC
;

1124 *
¬—
 =
‹mp_¬—
;

1128 
	}
}

1130 
	$çt_couÁ_ä“_þu¡”s_fÜ_¬—
(
su³r_block
 *
sb
)

1132 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1133 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

1134 
çt_’Œy
 
ç‹Á
;

1135 
»ada_blocks
, 
»ada_mask
, 
cur_block
;

1136 
ä“
;

1138 
»ada_blocks
 = 
FAT_READA_SIZE
 >> 
sb
->
s_blocksize_b™s
;

1139 
»ada_mask
 = 
»ada_blocks
 - 1;

1140 
cur_block
 = 0;

1142 
ä“
 = 0;

1143 
	`ç‹Á_š™
(&
ç‹Á
);

1144 
	`ç‹Á_£t_’Œy
(&
ç‹Á
, 
FAT_START_ENT
);

1146 ifÐ
sbi
->
bx_ä“_v®id
 != -1 )

1147 
¬—_out
;

1150 
ç‹Á
.
’Œy
 < 
sbi
->
max_þu¡”
) {

1152 ià((
cur_block
 & 
»ada_mask
) == 0) {

1153 
»¡
 = 
sbi
->
çt_Ëngth
 - 
cur_block
;

1154 
	`çt_’t_»ada
(
sb
, &
ç‹Á
, 
	`mš
(
»ada_blocks
, 
»¡
));

1156 
cur_block
++;

1158 
	`çt_’t_»ad_block
(
sb
, &
ç‹Á
);

1161 ià(
Ýs
->
	`’t_g‘
(&
ç‹Á
è=ð
FAT_ENT_FREE
)

1163 
ä“
++;

1166 ifÐ
ç‹Á
.
’Œy
 < 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_ETC
 ] );

1168 ifÐ
ç‹Á
.
’Œy
 <ð
sbi
->
bx_’d_þu¡”
[ 
BB_ETC
 ] )

1169 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_ETC
 ])++;

1171 ifÐ
ç‹Á
.
’Œy
 <ð
sbi
->
bx_’d_þu¡”
[ 
BB_NORMAL
 ] )

1172 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL
 ])++;

1174 ifÐ
ç‹Á
.
’Œy
 <ð
sbi
->
bx_’d_þu¡”
[ 
BB_NORMAL_EVENT
 ] )

1175 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL_EVENT
 ])++;

1177 ifÐ
ç‹Á
.
’Œy
 <ð
sbi
->
bx_’d_þu¡”
[ 
BB_PARKING
 ] )

1178 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_PARKING
 ])++;

1180 ifÐ
ç‹Á
.
’Œy
 <ð
sbi
->
bx_’d_þu¡”
[ 
BB_MANUAL
 ] )

1181 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_MANUAL
 ])++;

1183 ifÐ
ç‹Á
.
’Œy
 <ð
sbi
->
bx_’d_þu¡”
[ 
BB_IMAGE
 ] )

1184 (
sbi
->
bx_ä“_þu¡”s
[ 
BB_IMAGE
 ])++;

1192 } 
	`çt_’t_Ãxt
(
sbi
, &
ç‹Á
));

1195 
sbi
->
bx_ä“_v®id
 = 1;

1197 
sbi
->
ä“_þu¡”s
 = 
ä“
;

1198 
sbi
->
ä“_þus_v®id
 = 1;

1199 
	`m¬k_fsšfo_dœty
(
sb
);

1200 
	`ç‹Á_b»l£
(&
ç‹Á
);

1202 
¬—_out
:

1204 
	}
}

1207 
	$çt_couÁ_ä“_þu¡”s
(
su³r_block
 *
sb
)

1209 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1210 
ç‹Á_Ý”©iÚs
 *
Ýs
 = 
sbi
->
ç‹Á_Ýs
;

1211 
çt_’Œy
 
ç‹Á
;

1212 
»ada_blocks
, 
»ada_mask
, 
cur_block
;

1213 
”r
 = 0, 
ä“
;

1215 
	`lock_çt
(
sbi
);

1216 ià(
sbi
->
ä“_þu¡”s
 !ð-1 && sbi->
ä“_þus_v®id
)

1217 
out
;

1219 
»ada_blocks
 = 
FAT_READA_SIZE
 >> 
sb
->
s_blocksize_b™s
;

1220 
»ada_mask
 = 
»ada_blocks
 - 1;

1221 
cur_block
 = 0;

1223 
ä“
 = 0;

1224 
	`ç‹Á_š™
(&
ç‹Á
);

1225 
	`ç‹Á_£t_’Œy
(&
ç‹Á
, 
FAT_START_ENT
);

1226 
ç‹Á
.
’Œy
 < 
sbi
->
max_þu¡”
) {

1228 ià((
cur_block
 & 
»ada_mask
) == 0) {

1229 
»¡
 = 
sbi
->
çt_Ëngth
 - 
cur_block
;

1230 
	`çt_’t_»ada
(
sb
, &
ç‹Á
, 
	`mš
(
»ada_blocks
, 
»¡
));

1232 
cur_block
++;

1234 
”r
 = 
	`çt_’t_»ad_block
(
sb
, &
ç‹Á
);

1235 ià(
”r
)

1236 
out
;

1239 ià(
Ýs
->
	`’t_g‘
(&
ç‹Á
è=ð
FAT_ENT_FREE
)

1241 
	`´štk
Ð
KERN_ALERT
 "fat_count_free_clusters free++ \n" );

1242 
ä“
++;

1244 } 
	`çt_’t_Ãxt
(
sbi
, &
ç‹Á
));

1246 
sbi
->
ä“_þu¡”s
 = 
ä“
;

1247 
sbi
->
ä“_þus_v®id
 = 1;

1248 
	`m¬k_fsšfo_dœty
(
sb
);

1249 
	`ç‹Á_b»l£
(&
ç‹Á
);

1250 
out
:

1251 
	`uÆock_çt
(
sbi
);

1252  
”r
;

1253 
	}
}

	@file.c

11 
	~<lšux/ÿ·bž™y.h
>

12 
	~<lšux/moduË.h
>

13 
	~<lšux/com·t.h
>

14 
	~<lšux/mouÁ.h
>

15 
	~<lšux/time.h
>

16 
	~<lšux/bufãr_h—d.h
>

17 
	~<lšux/wr™eback.h
>

18 
	~<lšux/backšg-dev.h
>

19 
	~<lšux/blkdev.h
>

20 
	~<lšux/f¢Ùify.h
>

21 
	~<lšux/£cur™y.h
>

22 
	~"çt.h
"

24 
	$çt_ioùl_g‘_©Œibu‹s
(
šode
 *šode, 
u32
 
__u£r
 *
u£r_©Œ
)

26 
u32
 
©Œ
;

28 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

29 
©Œ
 = 
	`çt_make_©Œs
(
šode
);

30 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

32  
	`put_u£r
(
©Œ
, 
u£r_©Œ
);

33 
	}
}

35 
	$çt_ioùl_£t_©Œibu‹s
(
fže
 *fže, 
u32
 
__u£r
 *
u£r_©Œ
)

37 
šode
 *šodð
	`fže_šode
(
fže
);

38 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

39 
is_dœ
 = 
	`S_ISDIR
(
šode
->
i_mode
);

40 
u32
 
©Œ
, 
Þd©Œ
;

41 
Ÿ‰r
 
Ÿ
;

42 
”r
;

44 
”r
 = 
	`g‘_u£r
(
©Œ
, 
u£r_©Œ
);

45 ià(
”r
)

46 
out
;

48 
”r
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

49 ià(
”r
)

50 
out
;

51 
	`mu‹x_lock
(&
šode
->
i_mu‹x
);

59 
©Œ
 &ð0xfà& ~(
ATTR_VOLUME
 | 
ATTR_DIR
);

61 
©Œ
 |ð(
	`MSDOS_I
(
šode
)->
i_©Œs
 & 
ATTR_VOLUME
) |

62 (
is_dœ
 ? 
ATTR_DIR
 : 0);

63 
Þd©Œ
 = 
	`çt_make_©Œs
(
šode
);

66 
Ÿ
.
Ÿ_v®id
 = 
ATTR_MODE
 | 
ATTR_CTIME
;

67 
Ÿ
.
Ÿ_ùime
 = 
	`cu¼’t_fs_time
(
šode
->
i_sb
);

68 ià(
is_dœ
)

69 
Ÿ
.
Ÿ_mode
 = 
	`çt_make_mode
(
sbi
, 
©Œ
, 
S_IRWXUGO
);

71 
Ÿ
.
Ÿ_mode
 = 
	`çt_make_mode
(
sbi
, 
©Œ
,

72 
S_IRUGO
 | 
S_IWUGO
 | (
šode
->
i_mode
 & 
S_IXUGO
));

76 ià(
šode
->
i_šo
 =ð
MSDOS_ROOT_INO
 && 
©Œ
 !ð
ATTR_DIR
) {

77 
”r
 = -
EINVAL
;

78 
out_uÆock_šode
;

81 ià(
sbi
->
ÝtiÚs
.
sys_immubË
 &&

82 ((
©Œ
 | 
Þd©Œ
è& 
ATTR_SYS
) &&

83 !
	`ÿ·bË
(
CAP_LINUX_IMMUTABLE
)) {

84 
”r
 = -
EPERM
;

85 
out_uÆock_šode
;

93 
”r
 = 
	`£cur™y_šode_£‰r
(
fže
->
f_·th
.
d’Œy
, &
Ÿ
);

94 ià(
”r
)

95 
out_uÆock_šode
;

98 
”r
 = 
	`çt_£‰r
(
fže
->
f_·th
.
d’Œy
, &
Ÿ
);

99 ià(
”r
)

100 
out_uÆock_šode
;

102 
	`f¢Ùify_chªge
(
fže
->
f_·th
.
d’Œy
, 
Ÿ
.
Ÿ_v®id
);

103 ià(
sbi
->
ÝtiÚs
.
sys_immubË
) {

104 ià(
©Œ
 & 
ATTR_SYS
)

105 
šode
->
i_æags
 |ð
S_IMMUTABLE
;

107 
šode
->
i_æags
 &ð~
S_IMMUTABLE
;

110 
	`çt_§ve_©Œs
(
šode
, 
©Œ
);

111 
	`m¬k_šode_dœty
(
šode
);

112 
out_uÆock_šode
:

113 
	`mu‹x_uÆock
(&
šode
->
i_mu‹x
);

114 
	`mÁ_drÝ_wr™e_fže
(
fže
);

115 
out
:

116  
”r
;

117 
	}
}

119 
	$çt_g’”ic_ioùl
(
fže
 *
fžp
, 
cmd
, 
¬g
)

121 
šode
 *šodð
	`fže_šode
(
fžp
);

122 
u32
 
__u£r
 *
u£r_©Œ
 = (u32 __u£¸*)
¬g
;

124 
cmd
) {

125 
FAT_IOCTL_GET_ATTRIBUTES
:

126  
	`çt_ioùl_g‘_©Œibu‹s
(
šode
, 
u£r_©Œ
);

127 
FAT_IOCTL_SET_ATTRIBUTES
:

128  
	`çt_ioùl_£t_©Œibu‹s
(
fžp
, 
u£r_©Œ
);

130  -
ENOTTY
;

132 
	}
}

134 #ifdeà
CONFIG_COMPAT


135 
	$çt_g’”ic_com·t_ioùl
(
fže
 *
fžp
, 
cmd
,

136 
¬g
)

139  
	`çt_g’”ic_ioùl
(
fžp
, 
cmd
, ()
	`com·t_±r
(
¬g
));

140 
	}
}

143 
	$çt_fže_»Ëa£
(
šode
 *šode, 
fže
 *
fžp
)

146 #ifdeà
__DEBUG__


147 
	`´štk
("[cheon] ====fat_file_release==== \n");

150 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
Ð
šode
->
i_sb
 );

151 
¬—_num
;

152 
u£d_size
 = ( )Ð
šode
->
i_size
 );

153 
´e_®loc_size
;

157 
	`g‘_¬—_numb”
Ð&
¬—_num
, 
šode
 );

158 
´e_®loc_size
 = 
sbi
->
bx_´e_size
[ 
¬—_num
 ] * 1024 * 1024;

160 ifÐ
¬—_num
 =ð
BB_ETC
 || 
sbi
->
bb_¥aû_fuÎ
 =ð
ON
 );

162 ifÐ
´e_®loc_size
 < 
šode
->
i_size
 )

164 
	`´štk
("[cheon] Error, Bad…rediction case \n");

168 
difãr
 = (
´e_®loc_size
 - 
u£d_size
) / ((pre_alloc_size) / 100 ) ;

170 #ifdeà
__DEBUG__


171 
	`´štk
("[cheÚ]‡»¨num %d,…»_®loøsiz%u \n", 
¬—_num
, 
´e_®loc_size
);

172 
	`´štk
("[cheÚ] FžsizCheck, P» : %u, R—È: %u, difã¸%d \n", 
´e_®loc_size
, ()
šode
->
i_size
, 
difãr
);

178 #ifdeà
__DEBUG__


179 
	`´štk
("[cheon] =============================================\n");

180 
	`´štk
("[cheon] Occur De/FAT„eupdate \n");

202 #ifdeà
__DEBUG__


203 
	`´štk
("[cheon] Not occur De/FAT„eupdate \n");

211 ià((
fžp
->
f_mode
 & 
FMODE_WRITE
) &&

212 
	`MSDOS_SB
(
šode
->
i_sb
)->
ÝtiÚs
.
æush
) {

213 
	`çt_æush_šodes
(
šode
->
i_sb
, inode, 
NULL
);

214 
	`cÚge¡iÚ_wa™
(
BLK_RW_ASYNC
, 
HZ
/10);

217 
	}
}

219 
	$çt_fže_fsync
(
fže
 *
fžp
, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

221 
šode
 *šodð
fžp
->
f_m­pšg
->
ho¡
;

222 
»s
, 
”r
;

224 
»s
 = 
	`g’”ic_fže_fsync
(
fžp
, 
¡¬t
, 
’d
, 
d©async
);

225 
”r
 = 
	`sync_m­pšg_bufãrs
(
	`MSDOS_SB
(
šode
->
i_sb
)->
çt_šode
->
i_m­pšg
);

227  
»s
 ?„e : 
”r
;

228 
	}
}

231 cÚ¡ 
fže_Ý”©iÚs
 
	gçt_fže_Ý”©iÚs
 = {

232 .
Î£ek
 = 
g’”ic_fže_Î£ek
,

233 .
	g»ad
 = 
do_sync_»ad
,

234 .
	gwr™e
 = 
do_sync_wr™e
,

235 .
	gaio_»ad
 = 
g’”ic_fže_aio_»ad
,

236 .
	gaio_wr™e
 = 
g’”ic_fže_aio_wr™e
,

237 .
	gmm­
 = 
g’”ic_fže_mm­
,

238 .
	g»Ëa£
 = 
çt_fže_»Ëa£
,

239 .
	guÆocked_ioùl
 = 
çt_g’”ic_ioùl
,

240 #ifdeà
CONFIG_COMPAT


241 .
	gcom·t_ioùl
 = 
çt_g’”ic_com·t_ioùl
,

243 .
	gfsync
 = 
çt_fže_fsync
,

244 .
	g¥liû_»ad
 = 
g’”ic_fže_¥liû_»ad
,

247 
	$çt_cÚt_ex·nd
(
šode
 *šode, 
loff_t
 
size
)

249 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

250 
loff_t
 
¡¬t
 = 
šode
->
i_size
, 
couÁ
 = 
size
 - inode->i_size;

251 
”r
;

253 
”r
 = 
	`g’”ic_cÚt_ex·nd_sim¶e
(
šode
, 
size
);

254 ià(
”r
)

255 
out
;

258 
šode
->
i_ùime
 = inode->
i_mtime
 = 
CURRENT_TIME_SEC
;

259 
	`m¬k_šode_dœty
(
šode
);

260 ià(
	`IS_SYNC
(
šode
)) {

261 
”r2
;

267 
”r
 = 
	`fžem­_fd©awr™e_¿nge
(
m­pšg
, 
¡¬t
,

268 
¡¬t
 + 
couÁ
 - 1);

269 
”r2
 = 
	`sync_m­pšg_bufãrs
(
m­pšg
);

270 ià(!
”r
)

271 
”r
 = 
”r2
;

272 
”r2
 = 
	`wr™e_šode_now
(
šode
, 1);

273 ià(!
”r
)

274 
”r
 = 
”r2
;

275 ià(!
”r
) {

276 
”r
 = 
	`fžem­_fd©awa™_¿nge
(
m­pšg
, 
¡¬t
,

277 
¡¬t
 + 
couÁ
 - 1);

280 
out
:

281  
”r
;

282 
	}
}

285 
	$çt_ä“
(
šode
 *šode, 
sk
)

287 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

288 
”r
, 
wa™
, 
ä“_¡¬t
, 
i_¡¬t
, 
i_log¡¬t
;

290 ià(
	`MSDOS_I
(
šode
)->
i_¡¬t
 == 0)

293 
	`çt_ÿche_šv®_šode
(
šode
);

295 
wa™
 = 
	`IS_DIRSYNC
(
šode
);

296 
i_¡¬t
 = 
ä“_¡¬t
 = 
	`MSDOS_I
(
šode
)->i_start;

297 
i_log¡¬t
 = 
	`MSDOS_I
(
šode
)->i_logstart;

300 ià(!
sk
) {

302 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 0;

303 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = 0;

305 
	`MSDOS_I
(
šode
)->
i_©Œs
 |ð
ATTR_ARCH
;

307 
šode
->
i_ùime
 = inode->
i_mtime
 = 
CURRENT_TIME_SEC
;

308 ià(
wa™
) {

309 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_free skip wait1 \n");

310 
”r
 = 
	`çt_sync_šode
(
šode
);

311 ià(
”r
) {

312 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = i_start;

313 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = i_logstart;

314  
”r
;

317 
	`m¬k_šode_dœty
(
šode
);

320 ià(
sk
) {

321 
çt_’Œy
 
ç‹Á
;

322 
»t
, 
fþus
, 
dþus
;

324 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_free skipest2 \n");

325 
»t
 = 
	`çt_g‘_þu¡”
(
šode
, 
sk
 - 1, &
fþus
, &
dþus
);

326 ià(
»t
 < 0)

327  
»t
;

328 ià(
»t
 =ð
FAT_ENT_EOF
)

331 
	`ç‹Á_š™
(&
ç‹Á
);

332 
»t
 = 
	`çt_’t_»ad
(
šode
, &
ç‹Á
, 
dþus
);

333 ià(
»t
 =ð
FAT_ENT_EOF
) {

334 
	`ç‹Á_b»l£
(&
ç‹Á
);

336 } ià(
»t
 =ð
FAT_ENT_FREE
) {

337 
	`çt_fs_”rÜ
(
sb
,

339 
__func__
, 
	`MSDOS_I
(
šode
)->
i_pos
);

340 
»t
 = -
EIO
;

341 } ià(
»t
 > 0) {

342 
”r
 = 
	`çt_’t_wr™e
(
šode
, &
ç‹Á
, 
FAT_ENT_EOF
, 
wa™
);

343 ià(
”r
)

344 
»t
 = 
”r
;

346 
	`ç‹Á_b»l£
(&
ç‹Á
);

347 ià(
»t
 < 0)

348  
»t
;

350 
ä“_¡¬t
 = 
»t
;

352 
šode
->
i_blocks
 = 
sk
 << (
	`MSDOS_SB
(
sb
)->
þu¡”_b™s
 - 9);

356  
	`çt_ä“_þu¡”s
(
šode
, 
ä“_¡¬t
);

357 
	}
}

359 
	$çt_Œunÿ‹_blocks
(
šode
 *šode, 
loff_t
 
off£t
)

361 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

362 cÚ¡ 
þu¡”_size
 = 
sbi
->cluster_size;

363 
Ä_þu¡”s
;

369 ià(
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 > 
off£t
)

370 
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 = 
off£t
;

372 
Ä_þu¡”s
 = (
off£t
 + (
þu¡”_size
 - 1)è>> 
sbi
->
þu¡”_b™s
;

374 
	`çt_ä“
(
šode
, 
Ä_þu¡”s
);

375 
	`çt_æush_šodes
(
šode
->
i_sb
, inode, 
NULL
);

376 
	}
}

378 
	$çt_g‘©Œ
(
vfsmouÁ
 *
mÁ
, 
d’Œy
 *d’Œy, 
k¡©
 *
¡©
)

380 
šode
 *šodð
d’Œy
->
d_šode
;

384 
	`g’”ic_fžÏ‰r
(
šode
, 
¡©
);

385 
¡©
->
blksize
 = 
	`MSDOS_SB
(
šode
->
i_sb
)->
þu¡”_size
;

387 ià(
	`MSDOS_SB
(
šode
->
i_sb
)->
ÝtiÚs
.
nfs
 =ð
FAT_NFS_NOSTALE_RO
) {

389 
¡©
->
šo
 = 
	`çt_i_pos_»ad
(
	`MSDOS_SB
(
šode
->
i_sb
), inode);

392 
	}
}

393 
EXPORT_SYMBOL_GPL
(
çt_g‘©Œ
);

395 
	$çt_§n™ize_mode
(cÚ¡ 
msdos_sb_šfo
 *
sbi
,

396 
šode
 *šode, 
umode_t
 *
mode_±r
)

398 
umode_t
 
mask
, 
³rm
;

405 ià(
	`S_ISREG
(
šode
->
i_mode
))

406 
mask
 = 
sbi
->
ÝtiÚs
.
fs_fmask
;

408 
mask
 = 
sbi
->
ÝtiÚs
.
fs_dmask
;

410 
³rm
 = *
mode_±r
 & ~(
S_IFMT
 | 
mask
);

418 ià((
³rm
 & (
S_IRUGO
 | 
S_IXUGO
)è!ð(
šode
->
i_mode
 & (S_IRUGO|S_IXUGO)))

419  -
EPERM
;

420 ià(
	`çt_mode_ÿn_hÞd_ro
(
šode
)) {

421 ià((
³rm
 & 
S_IWUGO
è&& (Õ”m & S_IWUGOè!ð(S_IWUGO & ~
mask
)))

422  -
EPERM
;

424 ià((
³rm
 & 
S_IWUGO
è!ð(S_IWUGO & ~
mask
))

425  -
EPERM
;

428 *
mode_±r
 &ð
S_IFMT
 | 
³rm
;

431 
	}
}

433 
	$çt_®low_£t_time
(
msdos_sb_šfo
 *
sbi
, 
šode
 *inode)

435 
umode_t
 
®low_utime
 = 
sbi
->
ÝtiÚs
.allow_utime;

437 ià(!
	`uid_eq
(
	`cu¼’t_fsuid
(), 
šode
->
i_uid
)) {

438 ià(
	`š_group_p
(
šode
->
i_gid
))

439 
®low_utime
 >>= 3;

440 ià(
®low_utime
 & 
MAY_WRITE
)

446 
	}
}

448 
	#TIMES_SET_FLAGS
 (
ATTR_MTIME_SET
 | 
ATTR_ATIME_SET
 | 
ATTR_TIMES_SET
)

	)

450 
	#FAT_VALID_MODE
 (
S_IFREG
 | 
S_IFDIR
 | 
S_IRWXUGO
)

	)

452 
	$çt_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
)

454 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
d’Œy
->
d_sb
);

455 
šode
 *šodð
d’Œy
->
d_šode
;

456 
Ÿ_v®id
;

457 
”rÜ
;

462 
Ÿ_v®id
 = 
©Œ
->ia_valid;

463 ià(
Ÿ_v®id
 & 
TIMES_SET_FLAGS
) {

464 ià(
	`çt_®low_£t_time
(
sbi
, 
šode
))

465 
©Œ
->
Ÿ_v®id
 &ð~
TIMES_SET_FLAGS
;

468 
”rÜ
 = 
	`šode_chªge_ok
(
šode
, 
©Œ
);

469 
©Œ
->
Ÿ_v®id
 = ia_valid;

470 ià(
”rÜ
) {

471 ià(
sbi
->
ÝtiÚs
.
qu›t
)

472 
”rÜ
 = 0;

473 
out
;

482 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
) {

483 
	`šode_dio_wa™
(
šode
);

485 ià(
©Œ
->
Ÿ_size
 > 
šode
->
i_size
) {

486 
”rÜ
 = 
	`çt_cÚt_ex·nd
(
šode
, 
©Œ
->
Ÿ_size
);

487 ià(
”rÜ
 || 
©Œ
->
Ÿ_v®id
 =ð
ATTR_SIZE
)

488 
out
;

489 
©Œ
->
Ÿ_v®id
 &ð~
ATTR_SIZE
;

493 ià(((
©Œ
->
Ÿ_v®id
 & 
ATTR_UID
) &&

494 (!
	`uid_eq
(
©Œ
->
Ÿ_uid
, 
sbi
->
ÝtiÚs
.
fs_uid
))) ||

495 ((
©Œ
->
Ÿ_v®id
 & 
ATTR_GID
) &&

496 (!
	`gid_eq
(
©Œ
->
Ÿ_gid
, 
sbi
->
ÝtiÚs
.
fs_gid
))) ||

497 ((
©Œ
->
Ÿ_v®id
 & 
ATTR_MODE
) &&

498 (
©Œ
->
Ÿ_mode
 & ~
FAT_VALID_MODE
)))

499 
”rÜ
 = -
EPERM
;

501 ià(
”rÜ
) {

502 ià(
sbi
->
ÝtiÚs
.
qu›t
)

503 
”rÜ
 = 0;

504 
out
;

511 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_MODE
) {

512 ià(
	`çt_§n™ize_mode
(
sbi
, 
šode
, &
©Œ
->
Ÿ_mode
) < 0)

513 
©Œ
->
Ÿ_v®id
 &ð~
ATTR_MODE
;

516 ià(
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
) {

517 
	`down_wr™e
(&
	`MSDOS_I
(
šode
)->
Œunÿ‹_lock
);

518 
	`Œunÿ‹_£tsize
(
šode
, 
©Œ
->
Ÿ_size
);

519 
	`çt_Œunÿ‹_blocks
(
šode
, 
©Œ
->
Ÿ_size
);

520 
	`up_wr™e
(&
	`MSDOS_I
(
šode
)->
Œunÿ‹_lock
);

523 
	`£‰r_cÝy
(
šode
, 
©Œ
);

524 
	`m¬k_šode_dœty
(
šode
);

525 
out
:

526  
”rÜ
;

527 
	}
}

528 
EXPORT_SYMBOL_GPL
(
çt_£‰r
);

530 cÚ¡ 
šode_Ý”©iÚs
 
	gçt_fže_šode_Ý”©iÚs
 = {

531 .
£‰r
 = 
çt_£‰r
,

532 .
	gg‘©Œ
 = 
çt_g‘©Œ
,

	@inode.c

13 
	#__DEBUG__


	)

15 
	~<lšux/moduË.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/time.h
>

18 
	~<lšux/¦ab.h
>

19 
	~<lšux/£q_fže.h
>

20 
	~<lšux/·gem­.h
>

21 
	~<lšux/m·ge.h
>

22 
	~<lšux/bufãr_h—d.h
>

23 
	~<lšux/mouÁ.h
>

24 
	~<lšux/aio.h
>

25 
	~<lšux/vfs.h
>

26 
	~<lšux/·r£r.h
>

27 
	~<lšux/uio.h
>

28 
	~<lšux/wr™eback.h
>

29 
	~<lšux/log2.h
>

30 
	~<lšux/hash.h
>

31 
	~<lšux/blkdev.h
>

32 
	~<asm/uÇligÃd.h
>

33 
	~"çt.h
"

35 #iâdeà
CONFIG_FAT_DEFAULT_IOCHARSET


37 
	#CONFIG_FAT_DEFAULT_IOCHARSET
 ""

	)

43 
	#COUNT_AREA_0
 76800

44 
	#COUNT_AREA_1
 524288

45 
	#COUNT_AREA_2
 262144

46 
	#COUNT_AREA_3
 262144

47 
	#COUNT_AREA_4
 131072

48 
	#COUNT_AREA_5
 131072

51 
	#COUNT_AREA_0
 76800

52 
	#COUNT_AREA_1
 1310720

	)

53 
	#COUNT_AREA_2
 100

	)

54 
	#COUNT_AREA_3
 100

	)

55 
	#COUNT_AREA_4
 100

	)

56 
	#COUNT_AREA_5
 100

	)

60 
	#COUNT_AREA_0
 76800

61 
	#COUNT_AREA_1
 10240

62 
	#COUNT_AREA_2
 5120

63 
	#COUNT_AREA_3
 5120

	)

64 
	#COUNT_AREA_4
 2560

	)

65 
	#COUNT_AREA_5
 2560

	)

69 
	#COUNT_AREA_0
 76800

70 
	#COUNT_AREA_1
 20480

71 
	#COUNT_AREA_2
 10240

72 
	#COUNT_AREA_3
 10240

	)

73 
	#COUNT_AREA_4
 5120

	)

74 
	#COUNT_AREA_5
 5120

	)

77 
	#COUNT_AREA_0
 2560

	)

78 
	#COUNT_AREA_1
 131072

	)

79 
	#COUNT_AREA_2
 131072

	)

80 
	#COUNT_AREA_3
 131072

	)

81 
	#COUNT_AREA_4
 131072

	)

82 
	#COUNT_AREA_5
 131072

	)

84 
	gçt_deçuÉ_cod•age
 = 
CONFIG_FAT_DEFAULT_CODEPAGE
;

85 
	gçt_deçuÉ_ioch¬£t
[] = 
CONFIG_FAT_DEFAULT_IOCHARSET
;

87 
	#PRE_ALLOC_ON
 1

	)

88 
	gçt_block
 = -1;

90 
	$time_Üd”šg
( )

92 
Üd”
 = 0;

93 
u64
 
´evious_£c
 = 0;

96 ifÐ
´evious_£c
 =ð
	`g‘_£cÚds
() )

98 
Üd”
++;

102 
Üd”
 = 0;

106 
´evious_£c
 = 
	`g‘_£cÚds
();

108  
Üd”
;

109 
	}
}

110 
EXPORT_SYMBOL_GPL
Ð
time_Üd”šg
 );

112 
	$de_»upd©e
(
su³r_block
 *
sb
, 
šode
 *inode){

113 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

114 
i_pos
;

115 
bufãr_h—d
 *
bh
[32];

116 
msdos_dœ_’Œy
 *
¿w_’Œy
;

117 
š·ge_¡¬t
, 
š·ge_’d
, 
š·ge_cur
;

118 
i
;

120 
	`´štk
("[cheon] Update DE \n");

121 
i_pos
 = 
	`MSDOS_I
(
šode
)->i_pos;

123 
š·ge_cur
 = 
i_pos
 >> 
sbi
->
dœ_³r_block_b™s
;

124 
š·ge_¡¬t
 = 
š·ge_cur
 - (š·ge_cu¸% 
BLOCK_IN_PAGE
);

125 
š·ge_’d
 = 
š·ge_¡¬t
 + 
BLOCK_IN_PAGE
 -1 ;

128 
	`´štk
("[cheÚ] DE infØ, I_po : %u \n", 
i_pos
);

129 
	`´štk
("[cheÚ] S¹ Cu¸End : %u / %u / %u \n", 
š·ge_¡¬t
, 
š·ge_cur
, 
š·ge_’d
);

131 
bh
[0] = 
	`sb_b»ad
(
sb
, 
š·ge_cur
);

132 
¿w_’Œy
 = &((
msdos_dœ_’Œy
 *è(
bh
[0]->
b_d©a
))

133 [
i_pos
 & (
sbi
->
dœ_³r_block
 - 1)];

140 
	`´štk
("[cheon] Edit size \n");

141 
	`m¬k_bufãr_dœty
(
bh
[0]);

142 
	`sync_dœty_bufãr
(
bh
[0]);

143 
	`b»l£
(
bh
[0]);

146 
i
=0; i< 
BLOCK_IN_PAGE
 ; i++)

147 
bh
[
i
] = 
	`sb_b»ad
(
sb
, 
š·ge_¡¬t
 + i);

149 
¿w_’Œy
 = &((
msdos_dœ_’Œy
 *è(
bh
[
š·ge_cur
-
š·ge_¡¬t
]->
b_d©a
))

150 [
i_pos
 & (
sbi
->
dœ_³r_block
 - 1)];

151 
¿w_’Œy
->
size
 = 
	`ýu_to_Ë32
(
šode
->
i_size
);

153 
	`´štk
("[cheon] Edit size \n");

155 
i
=0; i<
BLOCK_IN_PAGE
; i++){

156 
	`m¬k_bufãr_dœty
(
bh
[
i
]);

159 
	`çt_sync_bhs
(
bh
, 
BLOCK_IN_PAGE
);

162 
i
=0; i<
BLOCK_IN_PAGE
; i++){

163 
	`b»l£
(
bh
[
i
]);

167 
	`´štk
("[cheÚ] Upd©DE Com¶‘e,„—Èfžsiz%u\n", ()
šode
->
i_size
);

169 
	}
}

172 
	$þu¡”chaš_»upd©e
(
su³r_block
 *
sb
, 
šode
 *inode){

173 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

174 
d’Œy
 *
d’Œy_f
;

175 
¬—_num
;

176 
®loÿ‹d_size
;

177 
u£d_size
 = ()(
šode
->
i_size
);

178 
unu£d_size
;

180 
block_num
;

181 
Ãw_eof_þu¡”
;

183 
bufãr_h—d
 *
bh
[32];

184 
i
;

185 *
d©a
 = (*è
	`km®loc
(512, 
GFP_KERNEL
);

187 
¡¬t_block_pos
;

188 
upd©e_block_pos
;

189 
š·ge_¡¬t_block_pos
;

190 
š·ge_’d_block_pos
;

191 
eof_block_pos
;

192 
eof_š·ge_¡¬t_block_pos
;

193 
eof_š·ge_’d_block_pos
 ;

195 
Ãed_upd©e_þu¡”_numb”
;

196 
Üi_eof_þu¡”_numb”
;

198 
·ge_®igÃd_¡¬t
;

201 
d’Œy_f
 = 
	`li¡_’Œy
(
šode
->
i_d’Œy
.
fœ¡
, 
d’Œy
, 
d_u
.
d_®Ÿs
);

207 
	`g‘_¬—_numb”
(&
¬—_num
 , 
šode
);

208 
®loÿ‹d_size
 = 
sbi
->
bx_´e_size
[
¬—_num
] * 1024 * 1024;

209 
unu£d_size
 = 
®loÿ‹d_size
 - 
u£d_size
;

211 
·ge_®igÃd_¡¬t
 = 
sbi
->
çt_¡¬t
 - (sbi->çt_¡¬ˆ% 
BLOCK_IN_PAGE
);;

213 
	`´štk
("\n");

214 
	`´štk
("[cheon] -------------„eupdate check ----------- \n");

215 
	`´štk
("[cheÚ]…» : %u, u£d : %u \n", 
®loÿ‹d_size
, 
u£d_size
);

217 
Ãed_upd©e_þu¡”_numb”
 = 
	`æoÜ
(
u£d_size
, 
sbi
->
þu¡”_size
è+ (
	`MSDOS_I
(
šode
)->
i_log¡¬t
);

218 
Üi_eof_þu¡”_numb”
 = 
	`æoÜ
(
®loÿ‹d_size
, 
sbi
->
þu¡”_size
è+ (
	`MSDOS_I
(
šode
)->
i_log¡¬t
) -1;

220 
	`´štk
("[cheÚ]‚“d upd©ed_þu¡” / or˜eoànumb” : %u / %u \n", 
Ãed_upd©e_þu¡”_numb”
, 
Üi_eof_þu¡”_numb”
);

224 if(
Ãed_upd©e_þu¡”_numb”
 > 
sbi
->
bx_’d_þu¡”
[
¬—_num
])

225 
Ãed_upd©e_þu¡”_numb”
 =‚“d_upd©e_þu¡”_numb” - (
sbi
->
bx_’d_þu¡”
[
¬—_num
] - sbi->
bx_¡¬t_þu¡”
[area_num]) -1;

226 if(
Üi_eof_þu¡”_numb”
 > 
sbi
->
bx_’d_þu¡”
[
¬—_num
])

227 
Üi_eof_þu¡”_numb”
 = ori_eof_þu¡”_numb” - (
sbi
->
bx_’d_þu¡”
[
¬—_num
] - sbi->
bx_¡¬t_þu¡”
[area_num]) -1 ;

230 
	`´štk
("[cheÚ]‚“d upd©ed_þu¡” / or˜eoànumb” : %u / %u \n", 
Ãed_upd©e_þu¡”_numb”
, 
Üi_eof_þu¡”_numb”
);

237 
¡¬t_block_pos
 = ()
sbi
->
çt_¡¬t
 + 
	`æoÜ
(
	`MSDOS_I
(
šode
)->
i_log¡¬t
, 
CLUSTER_IN_BLOCK
);

238 
upd©e_block_pos
 = ()
sbi
->
çt_¡¬t
 + 
	`æoÜ
(
Ãed_upd©e_þu¡”_numb”
, 
CLUSTER_IN_BLOCK
);

239 
eof_block_pos
 = ()
sbi
->
çt_¡¬t
 + 
	`æoÜ
(
Üi_eof_þu¡”_numb”
, 
CLUSTER_IN_BLOCK
);

241 
š·ge_¡¬t_block_pos
 = ()
upd©e_block_pos
 - (upd©e_block_po % 
BLOCK_IN_PAGE
);

242 
š·ge_’d_block_pos
 = ()
š·ge_¡¬t_block_pos
 + 
BLOCK_IN_PAGE
 - 1;

244 
eof_š·ge_¡¬t_block_pos
 = ()
eof_block_pos
 - (eof_block_po % 
BLOCK_IN_PAGE
);

245 
eof_š·ge_’d_block_pos
 = ()
eof_š·ge_¡¬t_block_pos
 + 
BLOCK_IN_PAGE
 - 1;

248 
	`´štk
("[cheÚ] block s¹ : %d ,‡ligÃd s¹ : %u \n", 
sbi
->
çt_¡¬t
, 
·ge_®igÃd_¡¬t
);

249 
	`´štk
("[cheÚ] s¹ / upd©/ƒoàblock‚umb” : %u / %u / %u \n", 
¡¬t_block_pos
, 
upd©e_block_pos
, 
eof_block_pos
);

251 
	`´štk
("[cheÚ] iÅage_¡¬t_block_po / iÅage_’d_block_po : %u / %u \n", 
š·ge_¡¬t_block_pos
, 
š·ge_’d_block_pos
);

252 
	`´štk
("[cheÚ]ƒof_š·ge_¡¬t_block_po /ƒof_š·ge_’d_block_po : %u / %u \n", 
eof_š·ge_¡¬t_block_pos
, 
eof_š·ge_’d_block_pos
);

255 
	`´štk
("[cheÚ]…» siz:%u , R—Èsiz: %u \n", 
®loÿ‹d_size
, ()
šode
->
i_size
);

264 if(
š·ge_¡¬t_block_pos
 =ð
eof_š·ge_¡¬t_block_pos
){

265 
	`´štk
("[cheon] FAT update occur in same…age \n");

267 
i
=0; i<
BLOCK_IN_PAGE
; i++){

268 
bh
[
i
] = 
	`sb_b»ad
(
sb
, 
š·ge_¡¬t_block_pos
 + i);

272 
block_num
 = 
eof_block_pos
 - 
eof_š·ge_¡¬t_block_pos
;

273 
	`memýy
(
d©a
,
bh
[
block_num
]->
b_d©a
, 512 );

274 
i
=0; i< 
CLUSTER_IN_BLOCK
; i ++){

275 
	`´štk
("%u ", 
d©a
[
i
]);

276 if(
d©a
[
i
] == 0x0FFFFFFF){

277 
	`´štk
("\n[cheÚ] S—rch Offfffff, off£ˆ%d \n", 
i
);

279 if(
i
==0)

280 
d©a
[
i
] = data[i+1] - 1;

282 
d©a
[
i
] = data[i-1] + 1;

288 
	`´štk
("\n");

290 if(
i
 =ð
CLUSTER_IN_BLOCK
)

291 
	`´štk
("[cheon] Error, can't find…roper oldƒof \n");

292 
	`memýy
(
bh
[
block_num
]->
b_d©a
 ,
d©a
, 512 );

296 
block_num
 = 
upd©e_block_pos
 - 
eof_š·ge_¡¬t_block_pos
;

297 
	`memýy
(
d©a
,
bh
[
block_num
]->
b_d©a
 , 512 );

298 
Ãw_eof_þu¡”
 = (
	`MSDOS_I
(
šode
)->
i_log¡¬t
è+ 
	`ûž
(
u£d_size
, 
sbi
->
þu¡”_size
);

300 if(
Ãw_eof_þu¡”
 > 
sbi
->
bx_’d_þu¡”
[
¬—_num
])

301 
Ãw_eof_þu¡”
 =‚ew_eof_þu¡” - (
sbi
->
bx_’d_þu¡”
[
¬—_num
] - sbi->
bx_¡¬t_þu¡”
[area_num]) -1 ;

303 
	`´štk
("[cheÚ]‚ewƒoàþu¡”‚um : %u \n", 
Ãw_eof_þu¡”
 -1 );

305 
i
=0; i<
CLUSTER_IN_BLOCK
; i ++){

307 if(
d©a
[
i
] =ð
Ãw_eof_þu¡”
){

308 
	`´štk
("\n[cheÚ] S—rch‚ewƒoàpos™iÚ, clu¡”‚um %u \n", 
Ãw_eof_þu¡”
);

309 
d©a
[
i
] = 0x0FFFFFFF;

313 if(
i
 =ð
CLUSTER_IN_BLOCK
)

314 
	`´štk
("[cheon] Error, can't find…roper‚ewƒof \n");

316 
	`memýy
(
bh
[
block_num
]->
b_d©a
 ,
d©a
, 512 );

320 
i
=0; i<
BLOCK_IN_PAGE
; i++){

321 
	`m¬k_bufãr_dœty
(
bh
[
i
]);

324 
	`çt_sync_bhs
(
bh
, 
BLOCK_IN_PAGE
);

326 
i
=0; i<
BLOCK_IN_PAGE
; i++)

327 
	`b»l£
(
bh
[
i
]);

329 
	`´štk
("[cheon] Write FAT \n");

335 
	`´štk
("[cheon] FAT update occur inwo…age \n");

337 
i
=0; i<
BLOCK_IN_PAGE
; i++){

338 
bh
[
i
] = 
	`sb_b»ad
(
sb
, 
eof_š·ge_¡¬t_block_pos
 + i);

342 
block_num
 = 
eof_block_pos
 - 
eof_š·ge_¡¬t_block_pos
;

343 
	`memýy
(
d©a
,
bh
[
block_num
]->
b_d©a
, 512 );

344 
i
=0; i< 
CLUSTER_IN_BLOCK
; i ++){

346 if(
d©a
[
i
] == 0x0FFFFFFF){

347 
	`´štk
("\n[cheÚ] S—rch Offfffff, off£ˆ%d \n", 
i
);

349 if(
i
==0)

350 
d©a
[
i
] = data[i+1] - 1;

352 
d©a
[
i
] = data[i-1] + 1;

357 if(
i
 =ð
CLUSTER_IN_BLOCK
)

358 
	`´štk
("[cheon] Error, can't find…roper oldƒof \n");

359 
	`memýy
(
bh
[
block_num
]->
b_d©a
 ,
d©a
, 512 );

361 
	`Î_rw_block
(
WRITE
, 
BLOCK_IN_PAGE
, 
bh
);

362 
i
=0; i<
BLOCK_IN_PAGE
; i++)

363 
	`b»l£
(
bh
[
i
]);

364 
	`´štk
("[cheon] Origianl EoF…age Write \n");

366 
i
=0; i<
BLOCK_IN_PAGE
; i++){

367 
bh
[
i
] = 
	`sb_b»ad
(
sb
, 
š·ge_¡¬t_block_pos
 + i);

370 
block_num
 = 
upd©e_block_pos
 - 
š·ge_¡¬t_block_pos
;

371 
	`memýy
(
d©a
,
bh
[
block_num
]->
b_d©a
 , 512 );

372 
Ãw_eof_þu¡”
 = (
	`MSDOS_I
(
šode
)->
i_log¡¬t
è+ 
	`ûž
(
u£d_size
, 
sbi
->
þu¡”_size
) ;

373 
i
=0; i<
CLUSTER_IN_BLOCK
; i ++){

374 if(
d©a
[
i
] =ð
Ãw_eof_þu¡”
){

375 
	`´štk
("\n[cheÚ] S—rch‚ewƒoàpos™iÚ, clu¡”‚um %u\n", 
Ãw_eof_þu¡”
);

376 
d©a
[
i
] = 0x0FFFFFFF;

380 if(
i
 =ð
CLUSTER_IN_BLOCK
)

381 
	`´štk
("[cheon] Error, can't find…roper‚ewƒof \n");

383 
	`memýy
(
bh
[
block_num
]->
b_d©a
 ,
d©a
, 512 );

385 
i
=0; i<
BLOCK_IN_PAGE
; i++){

386 
	`m¬k_bufãr_dœty
(
bh
[
i
]);

389 
	`çt_sync_bhs
(
bh
, 
BLOCK_IN_PAGE
);

390 
i
=0; i<
BLOCK_IN_PAGE
; i++)

391 
	`b»l£
(
bh
[
i
]);

392 
	`´štk
("[cheon] New EoF…age Write \n");

397 
	`kä“
(
d©a
);

398 
sbi
->
bx_Ãxt_¡¬t
[
¬—_num
] = 
Ãw_eof_þu¡”
;

400 
	}
}

403 
	$fšd_v®id_Ãw_Ãxt
(
šode
 *šode, 
¬—
, * 
Ãxt
, * 
´ev
)

405 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

406 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

407 
bufãr_h—d
 *
´ev_bh
;

408 
bufãr_h—d
 *
Ãxt_bh
;

410 *
´ev_d©a
;

411 *
Ãxt_d©a
;

412 
block_pos
;

414 
þ_¡¬t
 = 
sbi
->
bx_¡¬t_þu¡”
[
¬—
];

415 
þ_’d
 = 
sbi
->
bx_’d_þu¡”
[
¬—
];

417 
block_¡¬t
 = 
çt_block
 + 
þ_¡¬t
/
CLUSTER_IN_BLOCK
;

418 
block_’d
 = 
çt_block
 + 
þ_’d
/
CLUSTER_IN_BLOCK
;

420 
Ãw_Ãxt
;

422 
i
, 
j
;

424 
block_pos
 = 
block_¡¬t
;

426 
	`´štk
("[cheon] Start valid‚ew‚ext... \n");

427 
	`´štk
("[cheÚ] A»¨:%d , cl_¡¬t,’d : %d/%d, block s¹,’d : %d/%d \n", 
¬—
, 
þ_¡¬t
, 
þ_’d
, 
block_¡¬t
, 
block_’d
);

430 if((
block_pos
 % 
BLOCK_IN_PAGE
) != BLOCK_IN_PAGE-1 )

431 
block_pos
 = block_po + (
BLOCK_IN_PAGE
 - 1 - (block_pos % BLOCK_IN_PAGE));

433 
	`´štk
("[cheÚ] block_po : %u \n", 
block_pos
 );

437  
block_pos
 + 1 <ð
block_’d
 )

440 
´ev_bh
 = 
	`sb_b»ad
(
sb
, 
block_pos
);

441 
Ãxt_bh
 = 
	`sb_b»ad
(
sb
, 
block_pos
+1);

443 
´ev_d©a
 = (*)
´ev_bh
->
b_d©a
;

444 
Ãxt_d©a
 = (*)
Ãxt_bh
->
b_d©a
;

446 
	`´štk
("[cheÚ] Now s—rchšg... %uh block,…»v_Ï¡ : %u,‚ext_fœ¡ : %u \n",
block_pos
, 
´ev_d©a
[
CLUSTER_IN_BLOCK
-1], 
Ãxt_d©a
[0]);

448 if((
´ev_d©a
[
CLUSTER_IN_BLOCK
-1] !ð0 &&…»v_d©a[CLUSTER_IN_BLOCK-1] !ð0x0fffffffè&& 
Ãxt_d©a
[0] == 0){

449 
	`´štk
("[cheÚ] Fšd clu¡”!†a¡ block : %d\n", 
block_pos
);

451 *
´ev
 = (
block_pos
 - 
çt_block
 + 1è* 
CLUSTER_IN_BLOCK
 - 1;

453 
i
=
BLOCK_IN_PAGE
; i>=0; i--){

454 
j
=
CLUSTER_IN_BLOCK
 ; j>=0; j--){

455 if(
´ev_d©a
[
j
] == 0x0fffffff){

458 
Ãw_Ãxt
 = 
block_pos
 - 
çt_block
;

459 
Ãw_Ãxt
 =‚ew_Ãxˆ* 
CLUSTER_IN_BLOCK
 ;

460 
Ãw_Ãxt
 =‚ew_Ãxˆ+ 
j
 + 1;

462 *
Ãxt
 = 
Ãw_Ãxt
;

464 
	`´štk
("[cheÚ] Com¶‘fšd :‚exˆ%u,…»v %u \n", *
Ãxt
, *
´ev
);

466 
	`b»l£
(
´ev_bh
);

467 
	`b»l£
(
Ãxt_bh
);

472 
block_pos
--;

473 
	`b»l£
(
´ev_bh
);

474 
´ev_bh
 = 
	`sb_b»ad
(
sb
, 
block_pos
);

475 
´ev_d©a
 = (*)
´ev_bh
->
b_d©a
;

478 
block_pos
 +ð
BLOCK_IN_PAGE
 ;

483 
block_pos
+=
BLOCK_IN_PAGE
 ;

484 
	`b»l£
(
´ev_bh
);

485 
	`b»l£
(
Ãxt_bh
);

488 
	`´štk
("[cheon] Error, Can't find valid value!! \n");

491 
	}
}

494 
´eAÎoc
(
su³r_block
 *
sb
, 
Ãxt
, 
´ev
, * 
Ãw_Ãxt
, \

495 * 
Ãw_´ev
, 
®loÿ‹d
, 
Ãed_to_®loc
, 
¬—
){

496 
msdos_sb_šfo
 *
	gsbi
 = 
MSDOS_SB
(
sb
);

498 
	gi
, 
	gj
;

499 
	g·ge_num
 = 0;

500 *
	gd©a
[100];

502 
	g¡¬t
 = 
´ev
+1;

503 
	gchaš
 = 
¡¬t
 + 1;

506 
	gnum_of_·ge
 = 
Ãed_to_®loc
 / 
CLUSTER_IN_PAGE
 ;

507 
	g·ge_off£t
 = 
Ãed_to_®loc
 % 
CLUSTER_IN_PAGE
 ;

509 
	gtwo_äag
 = -1;

510 
	gcouÁ
;

513 
	gnum_buf
 = 0;

514 
bufãr_h—d
 *
	gbh
[100];

515 
	gçt_block_pos
 = 
çt_block
 + 
¡¬t
 / 
CLUSTER_IN_BLOCK
 ;

517 #ifdeà
__DEBUG__


518 
´štk
("\n[cheon] ====== Preallocation start ============\n");

519 
´štk
("[cheÚ]…»AÎoø-‚exˆ: %u ,…»v : %d,‡Îoÿ‹d : %d,‚“d_tØ: %d \n", 
Ãxt
, 
´ev
, 
®loÿ‹d
, 
Ãed_to_®loc
);

520 
´štk
("[cheÚ]‚um_of_·g: %d,…age_off£ˆ: %d, CLUSTER_IN_PAGE : %d \n\n", 
num_of_·ge
, 
·ge_off£t
, 
CLUSTER_IN_PAGE
);

521 
´štk
("[cheÚ] f©_block_po : %u \n", 
çt_block_pos
 );

523 ifÐ
	gnum_of_·ge
 > 8 )

525 
´štk
("[cheon] ==================error,‚um_of_page is†arge!================== \n");

529 if(
	g¡¬t
 + 
	gÃed_to_®loc
 > 
	gsbi
->
	gbx_’d_þu¡”
[
¬—
])

531 
	gtwo_äag
 = 0;

533 if(
	g·ge_off£t
 == 0)

534 
couÁ
 = 
num_of_·ge
;

536 
	gcouÁ
 = 
num_of_·ge
+1;

538 
	gi
=1; i<=
couÁ
; i++){

539 if((
	g¡¬t
 - 1 + (
i
 * 
	gCLUSTER_IN_PAGE
)è<ð
sbi
->
bx_’d_þu¡”
[
¬—
])

540 
two_äag
++;

543 
´štk
("[cheÚ] Ca£ : Exeûed bÜd” oà¬—,wo_äag :%d \n", 
two_äag
);

547 
	gi
=0; i< 
	gnum_of_·ge
; i++)

548 
	gd©a
[
i
] = (*)
km®loc
((
SD_PAGE_SIZE
 * 1024),
GFP_KERNEL
);

552 
	gj
=0 ; j < 
	gnum_of_·ge
 ; j++)

554 
	gi
=0; i < 
	gCLUSTER_IN_PAGE
 ; i++)

556 
	gd©a
[
j
][
i
] = 
chaš
;

557 
	gchaš
++;

558 
	gÃed_to_®loc
--;

559 
	g®loÿ‹d
++;

564 
	gj
=0; j<
	gnum_of_·ge
; j++){

565 if(
	gj
==
two_äag
){

566 
´štk
("[cheon] First cluster update occur \n");

567 
	gchaš
 = 
sbi
->
bx_¡¬t_þu¡”
[
¬—
];

569 if(
	g·ge_num
 != 0)

570 
d©a
[
·ge_num
-1][
CLUSTER_IN_PAGE
 -1] = 
chaš
;

572 
	gchaš
++;

577 
	gi
=0; i<
	gCLUSTER_IN_PAGE
; i++){

578 
	gd©a
[
·ge_num
][
i
] = 
chaš
;

579 
	gchaš
++;

580 
	gÃed_to_®loc
--;

581 
	g®loÿ‹d
++;

583 
	g·ge_num
++;

588 
	gd©a
[7][1023] = 
FAT_ENT_EOF
;

590 #ifdeà
__DEBUG__


591 
´štk
("[cheÚ] d©a[·ge_num-1][CLUSTER_IN_PAGE -1] : %d \n", 
d©a
[
·ge_num
-1][
CLUSTER_IN_PAGE
 -1] );

592 
´štk
("[cheÚ] chaš : %u‚“d_to_®loø: %d‡Îoÿ‹d : %d \n", 
chaš
, 
Ãed_to_®loc
, 
®loÿ‹d
 );

595 
´štk
("[cheon] Fill†ast Page \n");

600 *
	gÃw_Ãxt
 = 
chaš
 - 1;

601 *
	gÃw_´ev
 = 
chaš
 - 2;

605 if(
	g·ge_off£t
 != 0){

606 if(
two_äag
 =ð0 && 
num_of_·ge
==0){

608 
chaš
 = 
sbi
->
bx_¡¬t_þu¡”
[
¬—
]+1;

611 
	gi
=0; i<
	g·ge_off£t
; i++){

612 
	gd©a
[
·ge_num
][
i
] = 
chaš
;

613 
	gchaš
++;

614 
	gÃed_to_®loc
--;

615 
	g®loÿ‹d
++;

618 
´štk
("[cheÚ] chaš : %u ", 
chaš
 );

621 
´štk
Ð
KERN_ALERT
 "[cheon] FAT_ENT_EOF \n");

622 
	gd©a
[
·ge_num
][
·ge_off£t
-1] = 
FAT_ENT_EOF
;

624 *
	gÃw_Ãxt
 = 
chaš
-1;

626 if(
	gÃed_to_®loc
 != 0)

627 
´štk
("[cheon] Allocation Failed, some Error! \n");

629 
	gi
=
·ge_off£t
; i<
	gCLUSTER_IN_PAGE
; i++){

630 
	gd©a
[
·ge_num
][
i
] = 
chaš
;

631 
	gchaš
++;

635 if(
	gchaš
 >ð
sbi
->
bx_’d_þu¡”
[
¬—
]){

636 
d©a
[
·ge_num
][
CLUSTER_IN_PAGE
-1] = 
sbi
->
bx_¡¬t_þu¡”
[
¬—
];

640 
	g·ge_num
++;

644 *
	gÃw_Ãxt
 = 
chaš
-1;

646 #ifdeà
__DEBUG__


647 
´štk
("[cheon] Fit…age \n");

652 *
	gÃw_´ev
 = 
chaš
 -2;

655 #ifdeà
__DEBUG__


656 
´štk
("[cheÚ]‚ew…»v ; %d ,‚ew‚exˆ: %d \n", *
Ãw_´ev
, *
Ãw_Ãxt
);

657 
´štk
("[cheÚ] C»%d…ages,Ø®loø-- clu¡”  \n", 
num_of_·ge
 );

661  
	gi
=0; i<
	g·ge_num
; i++ )

663 if(
	gi
 =ð
two_äag
)

665 
çt_block_pos
 = 
çt_block
 + 
sbi
->
bx_¡¬t_þu¡”
[
¬—
]/ 
CLUSTER_IN_BLOCK
 ;

668  
	gj
=0 ; j < 
	gBLOCK_IN_PAGE
 ; j++ )

673 
	gbh
[
num_buf
] = 
sb_b»ad
(
sb
, 
çt_block_pos
);

674 
memýy
Ð
bh
[
num_buf
]->
b_d©a
 , 
d©a
[
i
] + ( 
j
 * 
CLUSTER_IN_BLOCK
 ), 512 );

675 
m¬k_bufãr_dœty
Ð
bh
[ 
num_buf
 ] );

677 
	gnum_buf
++;

678 
	gçt_block_pos
++;

682 #ifdeà
__DEBUG__


683 
´štk
("[cheon] sync... \n");

684 
´štk
("[cheÚ] Com¶‘Wr™num oà%d bufãr Ú %dh block…os™iÚ\n", 
num_buf
, 
çt_block_pos
);

687 
çt_sync_bhs
(
bh
, 
num_buf
);

690  
	gi
 = 0 ; i < 
	gnum_of_·ge
 ; i++)

691 
kä“
(
d©a
[
i
]);

693 #ifdeà
__DEBUG__


694 
´štk
("[cheon] ====== Preallocation End ============\n\n");

701 
	$çt_hªdË_þu¡”
Ð
šode
 *šode, 
mode
 )

703 
”r
 = 0, 
þu¡”
 = 0, 
¬—
 = 0;

705 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

706 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

707 
d’Œy
 *d’Œy = 
NULL
;

709 
num_´e_®loc
 = 0;

711 
šum
 = -1;

712 
´e_couÁ
 = 16384;

714 
Ãxt_¡¬t
 = 0,

715 
Ãxt
 = 0,

716 
´ev
 = 0,

717 
Ãw_Ãxt
 = 0,

718 
Ãw_´ev
 = 0;

720 
®loÿ‹d
 = 0,

721 
Ãed_to_®loc
 = 0;

723 
‹¡_key
 = 0;

728 
	`g‘_¬—_numb”
Ð&
¬—
, 
šode
 );

731 ifÐ
¬—
 =ð
BB_ETC
 || 
sbi
->
bb_¥aû_fuÎ
 =ð
ON
 )

734 #ifdeà
__DEBUG__


735 
	`´štk
("[cheon] ETC & FULL of‡ny…artitioning : Using‚ormal‡llocation \n");

737 
NORMAL_ALLOC
;

742 
num_´e_®loc
 = ( 
sbi
->
bx_´e_size
[ 
¬—
 ] * 1024 ) / ( sbi->
þu¡”_size
 / 1024 );

748 if(
šum
==
šode
->
i_šo
 && 
´e_couÁ
 < 
num_´e_®loc
-1 ){

749 
´e_couÁ
++;

756 
d’Œy
 = 
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, d’Œy, 
d_u
.
d_®Ÿs
 );

757 ifÐ
d’Œy
 =ð
NULL
 )

759 
	`´štk
("[cheon] dentry…ointer is NULL \n");

760 
NORMAL_ALLOC
;

765 ifÐ
	`¡r¡r
Ð
d’Œy
->
d_Çme
.
Çme
, "avi" ) =ð
NULL
 )

769 
NORMAL_ALLOC
;

772 
šum
 = 
šode
->
i_šo
;

773 
´e_couÁ
 = 0;

779 
Ãxt_¡¬t
 = 
sbi
->
bx_Ãxt_¡¬t
[ 
¬—
 ];

784 ifÐ
Ãxt_¡¬t
 == -1 )

787 #ifdeà
__DEBUG__


788 
	`´štk
("[cheon] Restart or First Start of Pre-allocation \n");

792 ifÐ(
sbi
->
bx_ä“_þu¡”s
[ 
¬—
 ] + 
num_´e_®loc
è> sbi->
bx_’d_þu¡”
[‡»¨] - sbi->
bx_¡¬t_þu¡”
[‡rea ] )

795 #ifdeà
__DEBUG__


796 
	`´štk
("[cheon] Case 1 : Area : %d Current free : %u + Pre_Size : %d > Total Cluster : %u \n", \

797 
¬—
, 
sbi
->
bx_ä“_þu¡”s
[‡»¨], 
num_´e_®loc
, (sbi->
bx_’d_þu¡”
[‡»¨] - sbi->
bx_¡¬t_þu¡”
[‡rea ] + 1 ) );

800 
Ãxt
 = 
sbi
->
bx_´ev_ä“
[ 
¬—
 ] + 1;

801 
´ev
 = 
sbi
->
bx_´ev_ä“
[ 
¬—
 ];

803 
®loÿ‹d
 = 0;

804 
Ãed_to_®loc
 = 
num_´e_®loc
;

807 if(
Ãxt
 % 
CLUSTER_IN_PAGE
 != 0){

809 #ifdeà
__DEBUG__


810 
	`´štk
("[cheon] Align Check 1 \n");

812 
Ãxt
 =‚exˆ+ (
CLUSTER_IN_PAGE
 - (next % CLUSTER_IN_PAGE ));

813 
´ev
 = 
Ãxt
-1;

818 if((
sbi
->
çt_¡¬t
 % 8) != 0)

820 
	`´štk
("[cheon] sbi->fat_start %8 != 0 \n");

822 
adju¡
 = 
sbi
->
çt_¡¬t
 % 
BLOCK_IN_PAGE
 ;

823 
Ãxt
 =‚exˆ- (
adju¡
 * 
CLUSTER_IN_BLOCK
 );

824 
´ev
 = 
Ãxt
 - 1;

826 if(
Ãxt
 < 
sbi
->
bx_¡¬t_þu¡”
[
¬—
])

828 
Ãxt
 =‚exˆ+ 
CLUSTER_IN_PAGE
 ;

829 
´ev
 = 
Ãxt
 -1;

834 #ifdeà
__DEBUG__


835 
	`´štk
("[cheÚ]‚exˆ: %u…»v : %u \n", 
Ãxt
, 
´ev
 );

841 
	`´štk
("[cheon] case 2 :ƒxist old file \n");

842 
	`fšd_v®id_Ãw_Ãxt
Ð
šode
, 
¬—
, &
Ãxt
, &
´ev
 );

844 
®loÿ‹d
 = 
´ev
 - 
Ãxt
 + 1;

845 
Ãed_to_®loc
 = 
num_´e_®loc
 - 
®loÿ‹d
;

850 
	`´eAÎoc
(
sb
, 
Ãxt
, 
´ev
, &
Ãw_Ãxt
, &
Ãw_´ev
, 
®loÿ‹d
, 
Ãed_to_®loc
, 
¬—
);

854 #ifdeà
__DEBUG__


855 
	`´štk
("[cheÚ] inoded™ - s¹ %d \n", 
Ãxt
);

857 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
Ãxt
;

858 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = 
Ãxt
;

860 
šode
->
i_blocks
 = 
num_´e_®loc
 << (
sbi
->
þu¡”_b™s
 - 9);

861 
	`çt_sync_šode
(
šode
);

863 #ifdeà
__DEBUG__


864 
	`´štk
("[cheon]sb update \n");

867 
sbi
->
bx_ä“_þu¡”s
[
¬—
] -ð
num_´e_®loc
;

868 
sbi
->
ä“_þu¡”s
 -ð
num_´e_®loc
;

869 
sbi
->
bx_Ãxt_¡¬t
[
¬—
] = 
Ãw_Ãxt
;

870 
sbi
->
bx_´ev_ä“
[
¬—
] = 
Ãw_´ev
;

877 
Ãxt
 = 
sbi
->
bx_Ãxt_¡¬t
[
¬—
];

878 
´ev
 = 
sbi
->
bx_´ev_ä“
[
¬—
];

880 
®loÿ‹d
 = 
´ev
 - 
Ãxt
 + 1;

881 
Ãed_to_®loc
 = 
num_´e_®loc
 - 
®loÿ‹d
;

883 if(
Ãed_to_®loc
 < 0){

886 #ifdeà
__DEBUG__


887 
	`´štk
("[cheon] ---------------------------------------------\n");

888 
	`´štk
("[cheÚ]‚“dØ®loø: %d , Sk…»®lÿtiÚ.\n", 
Ãed_to_®loc
);

889 
	`´štk
("[cheÚ] inoded™ - s¹ %d \n", 
Ãxt
);

891 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
Ãxt
;

892 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = 
Ãxt
;

893 
šode
->
i_blocks
 +ð
num_´e_®loc
 << (
sbi
->
þu¡”_b™s
 - 9);

895 
sbi
->
bx_ä“_þu¡”s
[
¬—
] -ð
num_´e_®loc
;

896 
sbi
->
ä“_þu¡”s
 -ð
num_´e_®loc
;

898 
sbi
->
bx_Ãxt_¡¬t
[
¬—
] = sbi->bx_Ãxt_¡¬t[¬—] + 
num_´e_®loc
 -1;

903 #ifdeà
__DEBUG__


904 
	`´štk
("[cheon] ---------------------------------------------\n");

905 
	`´štk
("[cheÚ] s¹ w™h…»‡Îoÿ‹d f©,‚“dØ®loø: %d , [%d ~ %d] \n", 
Ãed_to_®loc
, 
´ev
, 
Ãxt
);

908 
	`´eAÎoc
(
sb
, 
Ãxt
, 
´ev
, &
Ãw_Ãxt
, &
Ãw_´ev
, 
®loÿ‹d
, 
Ãed_to_®loc
, 
¬—
);

910 
	`´štk
("[cheÚ] inoded™ - s¹ %d \n", 
Ãxt
);

911 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
Ãxt
;

912 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = 
Ãxt
;

913 
šode
->
i_blocks
 +ð
num_´e_®loc
 << (
sbi
->
þu¡”_b™s
 - 9);

915 
sbi
->
bx_ä“_þu¡”s
[
¬—
] -ð
num_´e_®loc
;

916 
sbi
->
ä“_þu¡”s
 -ð
num_´e_®loc
;

917 
sbi
->
bx_Ãxt_¡¬t
[
¬—
] = 
Ãw_Ãxt
;

918 
sbi
->
bx_´ev_ä“
[
¬—
] = 
Ãw_´ev
;

932 #ifdeà
__DEBUG__


933 
	`´štk
("[cheon] Complete‡lloc.... \n");

939 
NORMAL_ALLOC
:

942 
”r
 = 
	`çt_®loc_þu¡”s
Ð
šode
, &
þu¡”
, 1 );

943 ià(
”r
)

944  
”r
;

948 
”r
 = 
	`çt_chaš_add
(
šode
, 
þu¡”
, 1);

949 ià(
”r
)

951 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_chain_addƒrror !!!, fat_free_clusters\n");

952 
	`çt_ä“_þu¡”s
(
šode
, 
þu¡”
);

954  
”r
;

955 
	}
}

957 
	$çt_add_þu¡”
(
šode
 *inode)

959 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

961 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
Ð
sb
 );

962 
d’Œy
 *d’Œy = 
NULL
;

964 
v®
;

965 
time
;

969 
”r
, 
þu¡”
;

974 ifÐ
šode
->
i_d’Œy
.
fœ¡
 =ð
NULL
 )

976 
	`´štk
("[cheon] i_dentry.next : NULL \n");

980 ifÐ
sbi
->
i_šo
 == -1 )

982 
d’Œy
 = 
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, d’Œy, 
d_u
.
d_®Ÿs
 );

983 
sbi
->
i_šo
 = 
šode
->i_ino;

984 
sbi
->
fže_Çme
 = ( * ) 
d’Œy
->
d_Çme
.
Çme
;

986 ifÐ
sbi
->
i_šo
 !ð
šode
->i_ino )

988 
	`´štk
("[cheÚ -im] Fž: %s,im: %u, couÁ : %À\n", 
sbi
->
fže_Çme
, sbi->
time
, sbi->
couÁ
 );

990 
sbi
->
i_šo
 = 
šode
->i_ino;

991 
sbi
->
couÁ
 = 0;

992 
sbi
->
time
 = 0;

994 
d’Œy
 = 
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, d’Œy, 
d_u
.
d_®Ÿs
 );

995 
sbi
->
fže_Çme
 = ( * ) 
d’Œy
->
d_Çme
.
Çme
;

998 
sbi
->
couÁ
++;

1002 
v®
 = 
	`çt_hªdË_þu¡”
Ð
šode
, 
FAT_ALLOC_CLUSTER
 );

1006 
	`do_g‘timeofday
Ð&
Ãw_ts
 );

1008 ifÐ
Ãw_ts
.
tv_£c
 =ð
Þd_ts
.
tv_n£c
 )

1009 
time
 = 
Ãw_ts
.
tv_u£c
 - 
Þd_ts
.tv_usec;

1011 
time
 = 1000000 + 
Ãw_ts
.
tv_u£c
 - 
Þd_ts
.tv_usec;

1013 
sbi
->
time
 +=ime;

1015  
v®
;

1019 
”r
 = 
	`çt_®loc_þu¡”s
(
šode
, &
þu¡”
, 1);

1020 ià(
”r
)

1021  
”r
;

1026 ifÐ
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, 
d’Œy
, 
d_u
.
d_®Ÿs
 ) )

1028 
d’Œy
 = 
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, d’Œy, 
d_u
.
d_®Ÿs
 );

1030 
sbi
->
fže_Çme
 = ( * )
d’Œy
->
d_Çme
.
Çme
;

1032 ifÐ
sbi
->
fže_Çme
 )

1033 
	`´štk
Ð
KERN_ALERT
 "d’Œy->d_Çme.Çm: % \n", 
sbi
->
fže_Çme
 );

1043 
”r
 = 
	`çt_chaš_add
(
šode
, 
þu¡”
, 1);

1044 ià(
”r
)

1046 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_chain_addƒrror !!!, fat_free_clusters\n");

1047 
	`çt_ä“_þu¡”s
(
šode
, 
þu¡”
);

1049  
”r
;

1051 
	}
}

1052 
	$check_·ge_®ign
Ð*
þu¡”
, 
max_þu¡”
, 
çt_¡¬t
 )

1056 
adju¡
 = 
çt_¡¬t
 % 
BLOCK_IN_PAGE
;

1057 
off£t
 = (*
þu¡”
 + 
adju¡
 * 
CLUSTER_IN_BLOCK
è% 
CLUSTER_IN_PAGE
;

1059 *
þu¡”
 = *þu¡” + (
CLUSTER_IN_PAGE
 - 
off£t
);

1061 if(*
þu¡”
 >ð
max_þu¡”
)

1062 *
þu¡”
 = *þu¡” - 
CLUSTER_IN_PAGE
;

1064 
	}
}

1066 
	$çt_upd©e_su³r
(
su³r_block
 *
sb
){

1067 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1078 
sbi
->
bx_ä“_v®id
 = -1;

1079 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_ETC
 ] = 
FAT_START_ENT
 + 2;

1080 
	`check_·ge_®ign
Ð&
sbi
->
bx_¡¬t_þu¡”
[ 
BX_ETC
 ], sbi->
max_þu¡”
, sbi->
çt_¡¬t
 );

1084 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL
 ] = sbi->bx_¡¬t_þu¡”[ 
BB_ETC
 ] + ( sbi->
max_þu¡”
 * sbi->
bx_¬—_¿tio
[ BB_ETC ] ) / 100;

1085 
	`check_·ge_®ign
Ð&
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL
 ], sbi->
max_þu¡”
, sbi->
çt_¡¬t
 );

1087 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL_EVENT
 ] = sbi->bx_¡¬t_þu¡”[ 
BB_NORMAL
 ] + ( sbi->
max_þu¡”
 * sbi->
bx_¬—_¿tio
[ BB_NORMAL ] ) / 100;

1088 
	`check_·ge_®ign
Ð&
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL_EVENT
 ], sbi->
max_þu¡”
, sbi->
çt_¡¬t
 );

1090 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_PARKING
 ] = sbi->bx_¡¬t_þu¡”[ 
BB_NORMAL_EVENT
 ] + ( sbi->
max_þu¡”
 * sbi->
bx_¬—_¿tio
[ BB_NORMAL_EVENT ] ) / 100;

1091 
	`check_·ge_®ign
Ð&
sbi
->
bx_¡¬t_þu¡”
[ 
BB_PARKING
 ], sbi->
max_þu¡”
, sbi->
çt_¡¬t
 );

1093 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_MANUAL
 ] = sbi->bx_¡¬t_þu¡”[ 
BB_PARKING
 ] + ( sbi->
max_þu¡”
 * sbi->
bx_¬—_¿tio
[ BB_PARKING ] ) / 100;

1094 
	`check_·ge_®ign
Ð&
sbi
->
bx_¡¬t_þu¡”
[ 
BB_MANUAL
 ], sbi->
max_þu¡”
, sbi->
çt_¡¬t
 );

1096 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_IMAGE
 ] = sbi->bx_¡¬t_þu¡”[ 
BB_MANUAL
 ] + ( sbi->
max_þu¡”
 * sbi->
bx_¬—_¿tio
[ BB_MANUAL ] ) / 100;

1097 
	`check_·ge_®ign
Ð&
sbi
->
bx_¡¬t_þu¡”
[ 
BB_IMAGE
 ], sbi->
max_þu¡”
, sbi->
çt_¡¬t
 );

1099 
sbi
->
bx_’d_þu¡”
[ 
BB_ETC
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_NORMAL
 ] - 1;

1100 
sbi
->
bx_’d_þu¡”
[ 
BB_NORMAL
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_NORMAL_EVENT
 ] - 1;

1101 
sbi
->
bx_’d_þu¡”
[ 
BB_NORMAL_EVENT
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_PARKING
 ] - 1;

1102 
sbi
->
bx_’d_þu¡”
[ 
BB_PARKING
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_MANUAL
 ] - 1;

1103 
sbi
->
bx_’d_þu¡”
[ 
BB_MANUAL
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_IMAGE
 ] - 1;

1104 
sbi
->
bx_’d_þu¡”
[ 
BB_IMAGE
 ] = sbi->
max_þu¡”
 - 1;

1108 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_ETC
 ] = 
FAT_START_ENT
 + 2;

1109 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
;

1110 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_NORMAL_EVENT
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 );

1111 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_PARKING
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 ) + 
COUNT_AREA_2
;

1112 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_MANUAL
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 ) + 
COUNT_AREA_2
 + 
COUNT_AREA_3
;

1113 
sbi
->
bx_¡¬t_þu¡”
[ 
BB_IMAGE
 ] = 
FAT_START_ENT
 + 2 + 
COUNT_AREA_0
 + ( 
COUNT_AREA_1
 ) + 
COUNT_AREA_2
 + 
COUNT_AREA_3
 + 
COUNT_AREA_4
;

1115 
sbi
->
bx_’d_þu¡”
[ 
BB_ETC
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_NORMAL
 ] - 1;

1116 
sbi
->
bx_’d_þu¡”
[ 
BB_NORMAL
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_NORMAL_EVENT
 ] - 1;

1117 
sbi
->
bx_’d_þu¡”
[ 
BB_NORMAL_EVENT
] = sbi->
bx_¡¬t_þu¡”
[ 
BB_PARKING
 ] - 1;

1118 
sbi
->
bx_’d_þu¡”
[ 
BB_PARKING
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_MANUAL
 ] - 1;

1119 
sbi
->
bx_’d_þu¡”
[ 
BB_MANUAL
 ] = sbi->
bx_¡¬t_þu¡”
[ 
BB_IMAGE
 ] - 1;

1120 
sbi
->
bx_’d_þu¡”
[ 
BB_IMAGE
 ] = sbi->
bx_¡¬t_þu¡”
[ BB_IMAGE ] + 
COUNT_AREA_5
 - 1;

1123 
sbi
->
bx_´ev_ä“
[ 
BB_ETC
 ] = sbi->
bx_¡¬t_þu¡”
[ BB_ETC ];

1124 
sbi
->
bx_´ev_ä“
[ 
BB_NORMAL
 ] = sbi->
bx_¡¬t_þu¡”
[ BB_NORMAL ];

1125 
sbi
->
bx_´ev_ä“
[ 
BB_NORMAL_EVENT
 ] = sbi->
bx_¡¬t_þu¡”
[ BB_NORMAL_EVENT ];

1126 
sbi
->
bx_´ev_ä“
[ 
BB_PARKING
 ] = sbi->
bx_¡¬t_þu¡”
[ BB_PARKING ];

1127 
sbi
->
bx_´ev_ä“
[ 
BB_MANUAL
 ] = sbi->
bx_¡¬t_þu¡”
[ BB_MANUAL ];

1128 
sbi
->
bx_´ev_ä“
[ 
BB_IMAGE
 ] = sbi->
bx_¡¬t_þu¡”
[ BB_IMAGE ];

1130 
sbi
->
bx_Ãxt_¡¬t
[ 
BB_ETC
 ] = -1;

1131 
sbi
->
bx_Ãxt_¡¬t
[ 
BB_NORMAL
 ] = -1;

1132 
sbi
->
bx_Ãxt_¡¬t
[ 
BB_NORMAL_EVENT
 ] = -1;

1133 
sbi
->
bx_Ãxt_¡¬t
[ 
BB_PARKING
 ] = -1;

1134 
sbi
->
bx_Ãxt_¡¬t
[ 
BB_MANUAL
 ] = -1;

1135 
sbi
->
bx_Ãxt_¡¬t
[ 
BB_IMAGE
 ] = -1;

1137 
sbi
->
bx_ä“_þu¡”s
[ 
BB_ETC
 ] = 0;

1138 
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL
 ] = 0;

1139 
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL_EVENT
 ] = 0;

1140 
sbi
->
bx_ä“_þu¡”s
[ 
BB_PARKING
 ] = 0;

1141 
sbi
->
bx_ä“_þu¡”s
[ 
BB_MANUAL
 ] = 0;

1142 
sbi
->
bx_ä“_þu¡”s
[ 
BB_IMAGE
 ] = 0;

1144 
sbi
->
bb_fže_¡¬t
 = sbi->
bx_¡¬t_þu¡”
[ 
BB_NORMAL
 ];

1146 
sbi
->
bb_¥aû_fuÎ
 = 0;

1147 
sbi
->
bb_no_®loc
 = 0;

1149 
	`çt_couÁ_ä“_þu¡”s_fÜ_¬—
Ð
sb
 );

1151 
	`´štk
("[cheon] Complete cluster calculation \n");

1152 
	`´štk
("[cheÚ] 1. [%2d%%] ETC [%6d ~%6d] / F»%6d(%3d%%è/ MB : %d \n", 
sbi
->
bx_¬—_¿tio
[
BB_ETC
], sbi->
bx_¡¬t_þu¡”
[BB_ETC], sbi->
bx_’d_þu¡”
[BB_ETC],sbi->
bx_ä“_þu¡”s
[BB_ETC], \

1153 (
sbi
->
bx_ä“_þu¡”s
[
BB_ETC
] * 100è/ (sbi->
bx_’d_þu¡”
[BB_ETC] - sbi->
bx_¡¬t_þu¡”
[BB_ETC] + 1 ), sbi->bx_free_clusters[ BB_ETC ] * 4 / 1024 );

1155 
	`´štk
("[cheÚ] 2. [%2d%%] NÜm® [%6d ~%6d] / F»%6d(%3d%%è/ MB : %d\n", 
sbi
->
bx_¬—_¿tio
[
BB_NORMAL
], sbi->
bx_¡¬t_þu¡”
[BB_NORMAL], sbi->
bx_’d_þu¡”
[BB_NORMAL],sbi->
bx_ä“_þu¡”s
[BB_NORMAL], \

1156 (
sbi
->
bx_ä“_þu¡”s
[
BB_NORMAL
] * 100è/ (sbi->
bx_’d_þu¡”
[BB_NORMAL]-sbi->
bx_¡¬t_þu¡”
[BB_NORMAL] + 1 ) , sbi->bx_free_clusters[ BB_NORMAL ] * 4 / 1024 );

1158 
	`´štk
("[cheÚ] 3. [%2d%%] NÜm® Ev’ˆ [%6d ~%6d] / F»%6d(%3d%%è/ MB : %d \n", 
sbi
->
bx_¬—_¿tio
[
BB_NORMAL_EVENT
], sbi->
bx_¡¬t_þu¡”
[BB_NORMAL_EVENT], sbi->
bx_’d_þu¡”
[BB_NORMAL_EVENT],sbi->
bx_ä“_þu¡”s
[BB_NORMAL_EVENT], \

1159 (
sbi
->
bx_ä“_þu¡”s
[
BB_NORMAL_EVENT
] * 100è/ (sbi->
bx_’d_þu¡”
[BB_NORMAL_EVENT]-sbi->
bx_¡¬t_þu¡”
[BB_NORMAL_EVENT] + 1 ) , sbi->bx_free_clusters[ BB_NORMAL_EVENT ] * 4 / 1024 );

1161 
	`´štk
("[cheÚ] 4. [%2d%%] P¬kšg [%6d ~%6d] / F»%6d(%3d%%è/ MB : %d \n", 
sbi
->
bx_¬—_¿tio
[
BB_PARKING
], sbi->
bx_¡¬t_þu¡”
[BB_PARKING], sbi->
bx_’d_þu¡”
[BB_PARKING],sbi->
bx_ä“_þu¡”s
[BB_PARKING], \

1162 (
sbi
->
bx_ä“_þu¡”s
[
BB_PARKING
] * 100è/ (sbi->
bx_’d_þu¡”
[BB_PARKING]-sbi->
bx_¡¬t_þu¡”
[ BB_PARKING ] + 1) , sbi->bx_free_clusters[ BB_PARKING ] * 4 / 1024 );

1164 
	`´štk
("[cheÚ] 5. [%2d%%] P¬kšg Ev’ˆ[%6d ~%6d] / F»%6d(%3d%%è/ MB : %d \n", 
sbi
->
bx_¬—_¿tio
[
BB_MANUAL
], sbi->
bx_¡¬t_þu¡”
[BB_MANUAL], sbi->
bx_’d_þu¡”
[BB_MANUAL],sbi->
bx_ä“_þu¡”s
[BB_MANUAL], \

1165 (
sbi
->
bx_ä“_þu¡”s
[
BB_MANUAL
] * 100è/ (sbi->
bx_’d_þu¡”
[BB_MANUAL]-sbi->
bx_¡¬t_þu¡”
[BB_MANUAL] + 1) , sbi->bx_free_clusters[ BB_MANUAL ] * 4 / 1024 );

1167 
	`´štk
("[cheÚ] 6. [%2d%%] HªdWÜk [%6d ~%6d] / F»%6d(%3d%%è/ MB : %d \n", 
sbi
->
bx_¬—_¿tio
[
BB_IMAGE
], sbi->
bx_¡¬t_þu¡”
[BB_IMAGE], sbi->
bx_’d_þu¡”
[BB_IMAGE],sbi->
bx_ä“_þu¡”s
[BB_IMAGE], \

1168 (
sbi
->
bx_ä“_þu¡”s
[
BB_IMAGE
] * 100è/ (sbi->
bx_’d_þu¡”
[BB_IMAGE]-sbi->
bx_¡¬t_þu¡”
[BB_IMAGE] + 1) , sbi->bx_free_clusters[ BB_IMAGE ] * 4 / 1024 );

1172 
	`´štk
("[cheÚ] sbi->ä“_þu¡” : %d \n", 
sbi
->
ä“_þu¡”s
 );

1174 
	`´štk
("[cheÚ] sbi->ä“_þu¡” : %d \n", 
sbi
->
bx_ä“_þu¡”s
[ 
BB_ETC
 ] );

1175 
	`´štk
("[cheÚ] sbi->ä“_þu¡” : %d \n", 
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL
 ] );

1176 
	`´štk
("[cheÚ] sbi->ä“_þu¡” : %d \n", 
sbi
->
bx_ä“_þu¡”s
[ 
BB_NORMAL_EVENT
 ] );

1177 
	`´štk
("[cheÚ] sbi->ä“_þu¡” : %d \n", 
sbi
->
bx_ä“_þu¡”s
[ 
BB_PARKING
 ] );

1178 
	`´štk
("[cheÚ] sbi->ä“_þu¡” : %d \n", 
sbi
->
bx_ä“_þu¡”s
[ 
BB_MANUAL
 ] );

1179 
	`´štk
("[cheÚ] sbi->ä“_þu¡” : %d \n", 
sbi
->
bx_ä“_þu¡”s
[ 
BB_IMAGE
 ] );

1181 ifÐ
sbi
->
bx_ä“_þu¡”s
[ 
BB_ETC
 ] =ð0 || sbi->bx_ä“_þu¡”s[ 
BB_NORMAL
 ] =ð0 || sbi->bx_ä“_þu¡”s[ 
BB_NORMAL_EVENT
 ] == 0 ||

1182 
sbi
->
bx_ä“_þu¡”s
[ 
BB_PARKING
 ] =ð0 || sbi->bx_ä“_þu¡”s[ 
BB_MANUAL
 ] =ð0 || sbi->bx_ä“_þu¡”s[ 
BB_IMAGE
 ] == 0 )

1184 
	`´štk
("[cheon] Any…art is full, Our…olicyurn into‡ original FAT \n");

1185 
sbi
->
bb_¥aû_fuÎ
 = 
ON
;

1192 
	}
}

1193 
EXPORT_SYMBOL_GPL
Ð
çt_upd©e_su³r
 );

1195 
šlše
 
	$__çt_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1196 *
max_blocks
,

1197 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1199 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1200 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1201 
m­³d_blocks
;

1202 
£ùÜ_t
 
phys
;

1203 
”r
, 
off£t
;

1205 
”r
 = 
	`çt_bm­
(
šode
, 
iblock
, &
phys
, &
m­³d_blocks
, 
ü—‹
);

1206 ià(
”r
)

1207  
”r
; ià(
phys
è{ 
	`m­_bh
(
bh_»suÉ
, 
sb
,…hys); *
max_blocks
 = 
	`mš
(
m­³d_blocks
, *max_blocks);

1210 ià(!
ü—‹
)

1213 ià(
iblock
 !ð
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 >> 
sb
->
s_blocksize_b™s
) {

1214 
	`çt_fs_”rÜ
(
sb
, "corrupted file size (i_pos %lld, %lld)",

1215 
	`MSDOS_I
(
šode
)->
i_pos
, MSDOS_I(šode)->
mmu_´iv©e
);

1216  -
EIO
;

1219 
off£t
 = ()
iblock
 & (
sbi
->
£c_³r_þus
 - 1);

1220 ià(!
off£t
) {

1222 
”r
 = 
	`çt_add_þu¡”
(
šode
);

1223 ià(
”r
)

1224  
”r
;

1227 
m­³d_blocks
 = 
sbi
->
£c_³r_þus
 - 
off£t
;

1229 *
max_blocks
 = 
	`mš
(
m­³d_blocks
, *max_blocks);

1230 
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 +ð*
max_blocks
 << 
sb
->
s_blocksize_b™s
;

1232 
”r
 = 
	`çt_bm­
(
šode
, 
iblock
, &
phys
, &
m­³d_blocks
, 
ü—‹
);

1233 ià(
”r
)

1234  
”r
;

1236 
	`BUG_ON
(!
phys
);

1237 
	`BUG_ON
(*
max_blocks
 !ð
m­³d_blocks
);

1238 
	`£t_bufãr_Ãw
(
bh_»suÉ
);

1239 
	`m­_bh
(
bh_»suÉ
, 
sb
, 
phys
);

1242 
	}
}

1244 
	$çt_g‘_block
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

1245 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

1247 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1248 
max_blocks
 = 
bh_»suÉ
->
b_size
 >> 
šode
->
i_blkb™s
;

1249 
”r
;

1251 
”r
 = 
	`__çt_g‘_block
(
šode
, 
iblock
, &
max_blocks
, 
bh_»suÉ
, 
ü—‹
);

1252 ià(
”r
)

1253  
”r
;

1254 
bh_»suÉ
->
b_size
 = 
max_blocks
 << 
sb
->
s_blocksize_b™s
;

1260 
	}
}

1262 
	$çt_wr™•age
(
·ge
 *·ge, 
wr™eback_cÚŒÞ
 *
wbc
)

1265  
	`block_wr™e_fuÎ_·ge
(
·ge
, 
çt_g‘_block
, 
wbc
);

1266 
	}
}

1268 
	$çt_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

1269 
wr™eback_cÚŒÞ
 *
wbc
)

1272  
	`m·ge_wr™•ages
(
m­pšg
, 
wbc
, 
çt_g‘_block
);

1273 
	}
}

1275 
	$çt_»ad·ge
(
fže
 *fže, 
·ge
 *page)

1277  
	`m·ge_»ad·ge
(
·ge
, 
çt_g‘_block
);

1278 
	}
}

1280 
	$çt_»ad·ges
(
fže
 *fže, 
add»ss_¥aû
 *
m­pšg
,

1281 
li¡_h—d
 *
·ges
, 
Ä_·ges
)

1283  
	`m·ge_»ad·ges
(
m­pšg
, 
·ges
, 
Ä_·ges
, 
çt_g‘_block
);

1284 
	}
}

1286 
	$çt_wr™e_çžed
(
add»ss_¥aû
 *
m­pšg
, 
loff_t
 
to
)

1288 
šode
 *šodð
m­pšg
->
ho¡
;

1290 ià(
to
 > 
šode
->
i_size
) {

1291 
	`Œunÿ‹_·geÿche
(
šode
, 
to
, inode->
i_size
);

1292 
	`çt_Œunÿ‹_blocks
(
šode
, inode->
i_size
);

1294 
	}
}

1296 
	$çt_wr™e_begš
(
fže
 *fže, 
add»ss_¥aû
 *
m­pšg
,

1297 
loff_t
 
pos
, 
Ën
, 
æags
,

1298 
·ge
 **
·g•
, **
fsd©a
)

1300 
”r
;

1303 *
·g•
 = 
NULL
;

1304 
”r
 = 
	`cÚt_wr™e_begš
(
fže
, 
m­pšg
, 
pos
, 
Ën
, 
æags
,

1305 
·g•
, 
fsd©a
, 
çt_g‘_block
,

1306 &
	`MSDOS_I
(
m­pšg
->
ho¡
)->
mmu_´iv©e
);

1307 ià(
”r
 < 0)

1308 
	`çt_wr™e_çžed
(
m­pšg
, 
pos
 + 
Ën
);

1309  
”r
;

1310 
	}
}

1312 
	$çt_wr™e_’d
(
fže
 *fže, 
add»ss_¥aû
 *
m­pšg
,

1313 
loff_t
 
pos
, 
Ën
, 
cÝ›d
,

1314 
·ge
 *
·g•
, *
fsd©a
)

1316 
šode
 *šodð
m­pšg
->
ho¡
;

1317 
”r
;

1318 
”r
 = 
	`g’”ic_wr™e_’d
(
fže
, 
m­pšg
, 
pos
, 
Ën
, 
cÝ›d
, 
·g•
, 
fsd©a
);

1319 ià(
”r
 < 
Ën
)

1320 
	`çt_wr™e_çžed
(
m­pšg
, 
pos
 + 
Ën
);

1321 ià(!(
”r
 < 0è&& !(
	`MSDOS_I
(
šode
)->
i_©Œs
 & 
ATTR_ARCH
)) {

1323 
šode
->
i_mtime
 = inode->
i_ùime
 = 
CURRENT_TIME_SEC
;

1324 
	`MSDOS_I
(
šode
)->
i_©Œs
 |ð
ATTR_ARCH
;

1325 
	`m¬k_šode_dœty
(
šode
);

1327  
”r
;

1328 
	}
}

1330 
ssize_t
 
	$çt_dœeù_IO
(
rw
, 
kiocb
 *
iocb
,

1331 cÚ¡ 
iovec
 *
iov
,

1332 
loff_t
 
off£t
, 
Ä_£gs
)

1334 
fže
 *fžð
iocb
->
ki_fžp
;

1335 
add»ss_¥aû
 *
m­pšg
 = 
fže
->
f_m­pšg
;

1336 
šode
 *šodð
m­pšg
->
ho¡
;

1337 
ssize_t
 
»t
;

1339 ià(
rw
 =ð
WRITE
) {

1349 
loff_t
 
size
 = 
off£t
 + 
	`iov_Ëngth
(
iov
, 
Ä_£gs
);

1350 ià(
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 < 
size
)

1358 
»t
 = 
	`blockdev_dœeù_IO
(
rw
, 
iocb
, 
šode
, 
iov
, 
off£t
, 
Ä_£gs
,

1359 
çt_g‘_block
);

1360 ià(
»t
 < 0 && (
rw
 & 
WRITE
))

1361 
	`çt_wr™e_çžed
(
m­pšg
, 
off£t
 + 
	`iov_Ëngth
(
iov
, 
Ä_£gs
));

1363  
»t
;

1364 
	}
}

1366 
£ùÜ_t
 
	$_çt_bm­
(
add»ss_¥aû
 *
m­pšg
, 
£ùÜ_t
 
block
)

1368 
£ùÜ_t
 
blockÄ
;

1371 
	`down_»ad
(&
	`MSDOS_I
(
m­pšg
->
ho¡
)->
Œunÿ‹_lock
);

1372 
blockÄ
 = 
	`g’”ic_block_bm­
(
m­pšg
, 
block
, 
çt_g‘_block
);

1373 
	`up_»ad
(&
	`MSDOS_I
(
m­pšg
->
ho¡
)->
Œunÿ‹_lock
);

1375  
blockÄ
;

1376 
	}
}

1378 cÚ¡ 
add»ss_¥aû_Ý”©iÚs
 
	gçt_aÝs
 = {

1379 .
»ad·ge
 = 
çt_»ad·ge
,

1380 .
	g»ad·ges
 = 
çt_»ad·ges
,

1381 .
	gwr™•age
 = 
çt_wr™•age
,

1382 .
	gwr™•ages
 = 
çt_wr™•ages
,

1383 .
	gwr™e_begš
 = 
çt_wr™e_begš
,

1384 .
	gwr™e_’d
 = 
çt_wr™e_’d
,

1385 .
	gdœeù_IO
 = 
çt_dœeù_IO
,

1386 .
	gbm­
 = 
_çt_bm­


1413 
	$çt_hash_š™
(
su³r_block
 *
sb
)

1415 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1416 
i
;

1418 
	`¥š_lock_š™
(&
sbi
->
šode_hash_lock
);

1419 
i
 = 0; i < 
FAT_HASH_SIZE
; i++)

1420 
	`INIT_HLIST_HEAD
(&
sbi
->
šode_hashbË
[
i
]);

1421 
	}
}

1423 
šlše
 
	$çt_hash
(
loff_t
 
i_pos
)

1425  
	`hash_32
(
i_pos
, 
FAT_HASH_BITS
);

1426 
	}
}

1428 
	$dœ_hash_š™
(
su³r_block
 *
sb
)

1430 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1431 
i
;

1433 
	`¥š_lock_š™
(&
sbi
->
dœ_hash_lock
);

1434 
i
 = 0; i < 
FAT_HASH_SIZE
; i++)

1435 
	`INIT_HLIST_HEAD
(&
sbi
->
dœ_hashbË
[
i
]);

1436 
	}
}

1438 
	$çt_©ch
(
šode
 *šode, 
loff_t
 
i_pos
)

1440 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

1442 ià(
šode
->
i_šo
 !ð
MSDOS_ROOT_INO
) {

1443 
hli¡_h—d
 *
h—d
 = 
sbi
->
šode_hashbË


1444 + 
	`çt_hash
(
i_pos
);

1446 
	`¥š_lock
(&
sbi
->
šode_hash_lock
);

1447 
	`MSDOS_I
(
šode
)->
i_pos
 = i_pos;

1448 
	`hli¡_add_h—d
(&
	`MSDOS_I
(
šode
)->
i_çt_hash
, 
h—d
);

1449 
	`¥š_uÆock
(&
sbi
->
šode_hash_lock
);

1456 ià(
	`S_ISDIR
(
šode
->
i_mode
è&& 
sbi
->
ÝtiÚs
.
nfs
) {

1457 
hli¡_h—d
 *
d_h—d
 = 
sbi
->
dœ_hashbË
;

1458 
d_h—d
 +ð
	`çt_dœ_hash
(
	`MSDOS_I
(
šode
)->
i_log¡¬t
);

1460 
	`¥š_lock
(&
sbi
->
dœ_hash_lock
);

1461 
	`hli¡_add_h—d
(&
	`MSDOS_I
(
šode
)->
i_dœ_hash
, 
d_h—d
);

1462 
	`¥š_uÆock
(&
sbi
->
dœ_hash_lock
);

1464 
	}
}

1465 
EXPORT_SYMBOL_GPL
(
çt_©ch
);

1467 
	$çt_d‘ach
(
šode
 *inode)

1469 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

1470 
	`¥š_lock
(&
sbi
->
šode_hash_lock
);

1471 
	`MSDOS_I
(
šode
)->
i_pos
 = 0;

1472 
	`hli¡_d–_š™
(&
	`MSDOS_I
(
šode
)->
i_çt_hash
);

1473 
	`¥š_uÆock
(&
sbi
->
šode_hash_lock
);

1475 ià(
	`S_ISDIR
(
šode
->
i_mode
è&& 
sbi
->
ÝtiÚs
.
nfs
) {

1476 
	`¥š_lock
(&
sbi
->
dœ_hash_lock
);

1477 
	`hli¡_d–_š™
(&
	`MSDOS_I
(
šode
)->
i_dœ_hash
);

1478 
	`¥š_uÆock
(&
sbi
->
dœ_hash_lock
);

1480 
	}
}

1481 
EXPORT_SYMBOL_GPL
(
çt_d‘ach
);

1483 
šode
 *
	$çt_ig‘
(
su³r_block
 *
sb
, 
loff_t
 
i_pos
)

1485 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1486 
hli¡_h—d
 *
h—d
 = 
sbi
->
šode_hashbË
 + 
	`çt_hash
(
i_pos
);

1487 
msdos_šode_šfo
 *
i
;

1488 
šode
 *šodð
NULL
;

1490 
	`¥š_lock
(&
sbi
->
šode_hash_lock
);

1491 
	`hli¡_fÜ_—ch_’Œy
(
i
, 
h—d
, 
i_çt_hash
) {

1492 
	`BUG_ON
(
i
->
vfs_šode
.
i_sb
 !ð
sb
);

1493 ià(
i
->
i_pos
 != i_pos)

1495 
šode
 = 
	`ig¿b
(&
i
->
vfs_šode
);

1496 ià(
šode
)

1499 
	`¥š_uÆock
(&
sbi
->
šode_hash_lock
);

1500  
šode
;

1501 
	}
}

1503 
	$is_exec
(*
ex‹nsiÚ
)

1505 *
exe_ex‹nsiÚs
 = "EXECOMBAT", *
w®k
;

1507 
w®k
 = 
exe_ex‹nsiÚs
; *walk; walk += 3)

1508 ià(!
	`¡ºcmp
(
ex‹nsiÚ
, 
w®k
, 3))

1511 
	}
}

1513 
	$çt_ÿlc_dœ_size
(
šode
 *inode)

1515 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

1516 
»t
, 
fþus
, 
dþus
;

1518 
šode
->
i_size
 = 0;

1519 ià(
	`MSDOS_I
(
šode
)->
i_¡¬t
 == 0)

1522 
»t
 = 
	`çt_g‘_þu¡”
(
šode
, 
FAT_ENT_EOF
, &
fþus
, &
dþus
);

1523 ià(
»t
 < 0)

1524  
»t
;

1525 
šode
->
i_size
 = (
fþus
 + 1è<< 
sbi
->
þu¡”_b™s
;

1528 
	}
}

1531 
	$çt_fžl_šode
(
šode
 *šode, 
msdos_dœ_’Œy
 *
de
)

1533 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

1534 
”rÜ
;

1536 
	`MSDOS_I
(
šode
)->
i_pos
 = 0;

1537 
šode
->
i_uid
 = 
sbi
->
ÝtiÚs
.
fs_uid
;

1538 
šode
->
i_gid
 = 
sbi
->
ÝtiÚs
.
fs_gid
;

1539 
šode
->
i_v”siÚ
++;

1540 
šode
->
i_g’”©iÚ
 = 
	`g‘_£cÚds
();

1542 ià((
de
->
©Œ
 & 
ATTR_DIR
è&& !
	`IS_FREE
(de->
Çme
)) {

1543 
šode
->
i_g’”©iÚ
 &= ~1;

1544 
šode
->
i_mode
 = 
	`çt_make_mode
(
sbi
, 
de
->
©Œ
, 
S_IRWXUGO
);

1545 
šode
->
i_Ý
 = 
sbi
->
dœ_Ýs
;

1546 
šode
->
i_fÝ
 = &
çt_dœ_Ý”©iÚs
;

1548 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
	`çt_g‘_¡¬t
(
sbi
, 
de
);

1549 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = MSDOS_I(šode)->
i_¡¬t
;

1550 
”rÜ
 = 
	`çt_ÿlc_dœ_size
(
šode
);

1551 ià(
”rÜ
 < 0)

1552  
”rÜ
;

1553 
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 = inode->
i_size
;

1555 
	`£t_Æšk
(
šode
, 
	`çt_subdœs
(inode));

1557 
šode
->
i_g’”©iÚ
 |= 1;

1558 
šode
->
i_mode
 = 
	`çt_make_mode
(
sbi
, 
de
->
©Œ
,

1559 ((
sbi
->
ÝtiÚs
.
showexec
 && !
	`is_exec
(
de
->
Çme
 + 8))

1560 ? 
S_IRUGO
|
S_IWUGO
 : 
S_IRWXUGO
));

1561 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
	`çt_g‘_¡¬t
(
sbi
, 
de
);

1563 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = MSDOS_I(šode)->
i_¡¬t
;

1564 
šode
->
i_size
 = 
	`Ë32_to_ýu
(
de
->
size
);

1565 
šode
->
i_Ý
 = &
çt_fže_šode_Ý”©iÚs
;

1566 
šode
->
i_fÝ
 = &
çt_fže_Ý”©iÚs
;

1567 
šode
->
i_m­pšg
->
a_Ýs
 = &
çt_aÝs
;

1568 
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 = inode->
i_size
;

1570 ià(
de
->
©Œ
 & 
ATTR_SYS
) {

1571 ià(
sbi
->
ÝtiÚs
.
sys_immubË
)

1572 
šode
->
i_æags
 |ð
S_IMMUTABLE
;

1574 
	`çt_§ve_©Œs
(
šode
, 
de
->
©Œ
);

1576 
šode
->
i_blocks
 = ((šode->
i_size
 + (
sbi
->
þu¡”_size
 - 1))

1577 & ~((
loff_t
)
sbi
->
þu¡”_size
 - 1)) >> 9;

1579 
	`çt_time_çt2unix
(
sbi
, &
šode
->
i_mtime
, 
de
->
time
, de->
d©e
, 0);

1580 ià(
sbi
->
ÝtiÚs
.
isvçt
) {

1581 
	`çt_time_çt2unix
(
sbi
, &
šode
->
i_ùime
, 
de
->
ùime
,

1582 
de
->
cd©e
, de->
ùime_cs
);

1583 
	`çt_time_çt2unix
(
sbi
, &
šode
->
i_©ime
, 0, 
de
->
ad©e
, 0);

1586 
šode
->
i_ùime
 = inode->
i_©ime
 = inode->
i_mtime
;

1597 
	}
}

1599 
šlše
 
	$çt_lock_bužd_šode
(
msdos_sb_šfo
 *
sbi
)

1601 ià(
sbi
->
ÝtiÚs
.
nfs
 =ð
FAT_NFS_NOSTALE_RO
)

1602 
	`mu‹x_lock
(&
sbi
->
nfs_bužd_šode_lock
);

1603 
	}
}

1605 
šlše
 
	$çt_uÆock_bužd_šode
(
msdos_sb_šfo
 *
sbi
)

1607 ià(
sbi
->
ÝtiÚs
.
nfs
 =ð
FAT_NFS_NOSTALE_RO
)

1608 
	`mu‹x_uÆock
(&
sbi
->
nfs_bužd_šode_lock
);

1609 
	}
}

1611 
šode
 *
	$çt_bužd_šode
(
su³r_block
 *
sb
,

1612 
msdos_dœ_’Œy
 *
de
, 
loff_t
 
i_pos
)

1614 
šode
 *inode;

1615 
”r
;

1617 
	`çt_lock_bužd_šode
(
	`MSDOS_SB
(
sb
));

1618 
šode
 = 
	`çt_ig‘
(
sb
, 
i_pos
);

1619 ià(
šode
)

1620 
out
;

1621 
šode
 = 
	`Ãw_šode
(
sb
);

1622 ià(!
šode
) {

1623 
šode
 = 
	`ERR_PTR
(-
ENOMEM
);

1624 
out
;

1626 
šode
->
i_šo
 = 
	`iunique
(
sb
, 
MSDOS_ROOT_INO
);

1627 
šode
->
i_v”siÚ
 = 1;

1628 
”r
 = 
	`çt_fžl_šode
(
šode
, 
de
);

1629 ià(
”r
) {

1630 
	`ut
(
šode
);

1631 
šode
 = 
	`ERR_PTR
(
”r
);

1632 
out
;

1634 
	`çt_©ch
(
šode
, 
i_pos
);

1635 
	`š£¹_šode_hash
(
šode
);

1636 
out
:

1637 
	`çt_uÆock_bužd_šode
(
	`MSDOS_SB
(
sb
));

1638  
šode
;

1639 
	}
}

1641 
EXPORT_SYMBOL_GPL
(
çt_bužd_šode
);

1643 
	$çt_eviù_šode
(
šode
 *inode)

1645 
	`Œunÿ‹_šode_·ges
(&
šode
->
i_d©a
, 0);

1646 ià(!
šode
->
i_Æšk
) {

1647 
šode
->
i_size
 = 0;

1648 
	`çt_Œunÿ‹_blocks
(
šode
, 0);

1650 
	`šv®id©e_šode_bufãrs
(
šode
);

1651 
	`þ—r_šode
(
šode
);

1652 
	`çt_ÿche_šv®_šode
(
šode
);

1653 
	`çt_d‘ach
(
šode
);

1654 
	}
}

1656 
	$çt_£t_¡©e
(
su³r_block
 *
sb
,

1657 
£t
, 
fÜû
)

1659 
bufãr_h—d
 *
bh
;

1660 
çt_boÙ_£ùÜ
 *
b
;

1661 
msdos_sb_šfo
 *
sbi
 = 
sb
->
s_fs_šfo
;

1664 ià((
sb
->
s_æags
 & 
MS_RDONLY
è&& !
fÜû
)

1668 ià(
sbi
->
dœty
) {

1670 ià(
£t
)

1671 
	`çt_msg
(
sb
, 
KERN_WARNING
, "Volume was‚ot…roperly "

1677 
bh
 = 
	`sb_b»ad
(
sb
, 0);

1678 ià(
bh
 =ð
NULL
) {

1679 
	`çt_msg
(
sb
, 
KERN_ERR
, "unableo„ead boot sector "

1684 
b
 = (
çt_boÙ_£ùÜ
 *è
bh
->
b_d©a
;

1686 ià(
sbi
->
çt_b™s
 == 32) {

1687 ià(
£t
)

1688 
b
->
çt32
.
¡©e
 |ð
FAT_STATE_DIRTY
;

1690 
b
->
çt32
.
¡©e
 &ð~
FAT_STATE_DIRTY
;

1692 ià(
£t
)

1693 
b
->
çt16
.
¡©e
 |ð
FAT_STATE_DIRTY
;

1695 
b
->
çt16
.
¡©e
 &ð~
FAT_STATE_DIRTY
;

1698 
	`m¬k_bufãr_dœty
(
bh
);

1699 
	`sync_dœty_bufãr
(
bh
);

1700 
	`b»l£
(
bh
);

1701 
	}
}

1703 
	$çt_put_su³r
(
su³r_block
 *
sb
)

1705 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1707 
	`çt_£t_¡©e
(
sb
, 0, 0);

1709 
	`ut
(
sbi
->
fsšfo_šode
);

1710 
	`ut
(
sbi
->
çt_šode
);

1712 
	`uÆßd_Æs
(
sbi
->
Æs_disk
);

1713 
	`uÆßd_Æs
(
sbi
->
Æs_io
);

1715 ià(
sbi
->
ÝtiÚs
.
ioch¬£t
 !ð
çt_deçuÉ_ioch¬£t
)

1716 
	`kä“
(
sbi
->
ÝtiÚs
.
ioch¬£t
);

1718 
sb
->
s_fs_šfo
 = 
NULL
;

1719 
	`kä“
(
sbi
);

1720 
	}
}

1722 
kmem_ÿche
 *
	gçt_šode_ÿch•
;

1724 
šode
 *
	$çt_®loc_šode
(
su³r_block
 *
sb
)

1726 
msdos_šode_šfo
 *
ei
;

1727 
ei
 = 
	`kmem_ÿche_®loc
(
çt_šode_ÿch•
, 
GFP_NOFS
);

1728 ià(!
ei
)

1729  
NULL
;

1731 
	`š™_rw£m
(&
ei
->
Œunÿ‹_lock
);

1732  &
ei
->
vfs_šode
;

1733 
	}
}

1735 
	$çt_i_ÿÎback
(
rcu_h—d
 *
h—d
)

1737 
šode
 *šodð
	`cÚš”_of
(
h—d
, šode, 
i_rcu
);

1738 
	`kmem_ÿche_ä“
(
çt_šode_ÿch•
, 
	`MSDOS_I
(
šode
));

1739 
	}
}

1741 
	$çt_de¡roy_šode
(
šode
 *inode)

1743 
	`ÿÎ_rcu
(&
šode
->
i_rcu
, 
çt_i_ÿÎback
);

1744 
	}
}

1746 
	$š™_Úû
(*
foo
)

1748 
msdos_šode_šfo
 *
ei
 = (msdos_šode_šfØ*)
foo
;

1750 
	`¥š_lock_š™
(&
ei
->
ÿche_Ìu_lock
);

1751 
ei
->
Ä_ÿches
 = 0;

1752 
ei
->
ÿche_v®id_id
 = 
FAT_CACHE_VALID
 + 1;

1753 
	`INIT_LIST_HEAD
(&
ei
->
ÿche_Ìu
);

1754 
	`INIT_HLIST_NODE
(&
ei
->
i_çt_hash
);

1755 
	`INIT_HLIST_NODE
(&
ei
->
i_dœ_hash
);

1756 
	`šode_š™_Úû
(&
ei
->
vfs_šode
);

1757 
	}
}

1759 
__š™
 
	$çt_š™_šodeÿche
()

1761 
çt_šode_ÿch•
 = 
	`kmem_ÿche_ü—‹
("fat_inode_cache",

1762 (
msdos_šode_šfo
),

1763 0, (
SLAB_RECLAIM_ACCOUNT
|

1764 
SLAB_MEM_SPREAD
),

1765 
š™_Úû
);

1766 ià(
çt_šode_ÿch•
 =ð
NULL
)

1767  -
ENOMEM
;

1769 
	}
}

1771 
__ex™
 
	$çt_de¡roy_šodeÿche
()

1777 
	`rcu_b¬r›r
();

1778 
	`kmem_ÿche_de¡roy
(
çt_šode_ÿch•
);

1779 
	}
}

1781 
	$çt_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

1783 
Ãw_rdÚly
;

1784 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1785 *
æags
 |ð
MS_NODIRATIME
 | (
sbi
->
ÝtiÚs
.
isvçt
 ? 0 : 
MS_NOATIME
);

1788 
Ãw_rdÚly
 = *
æags
 & 
MS_RDONLY
;

1789 ià(
Ãw_rdÚly
 !ð(
sb
->
s_æags
 & 
MS_RDONLY
)) {

1790 ià(
Ãw_rdÚly
)

1791 
	`çt_£t_¡©e
(
sb
, 0, 0);

1793 
	`çt_£t_¡©e
(
sb
, 1, 1);

1796 
	}
}

1798 
	$çt_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

1800 
su³r_block
 *
sb
 = 
d’Œy
->
d_sb
;

1801 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1802 
u64
 
id
 = 
	`huge_’code_dev
(
sb
->
s_bdev
->
bd_dev
);

1805 ià(
sbi
->
ä“_þu¡”s
 =ð-1 || !sbi->
ä“_þus_v®id
) {

1806 
”r
 = 
	`çt_couÁ_ä“_þu¡”s
(
d’Œy
->
d_sb
);

1807 ià(
”r
)

1808  
”r
;

1811 
buf
->
f_ty³
 = 
d’Œy
->
d_sb
->
s_magic
;

1812 
buf
->
f_bsize
 = 
sbi
->
þu¡”_size
;

1813 
buf
->
f_blocks
 = 
sbi
->
max_þu¡”
 - 
FAT_START_ENT
;

1814 
buf
->
f_bä“
 = 
sbi
->
ä“_þu¡”s
;

1815 
buf
->
f_bavaž
 = 
sbi
->
ä“_þu¡”s
;

1816 
buf
->
f_fsid
.
v®
[0] = (
u32
)
id
;

1817 
buf
->
f_fsid
.
v®
[1] = (
u32
)(
id
 >> 32);

1818 
buf
->
f_Çm–’
 =

1819 (
sbi
->
ÝtiÚs
.
isvçt
 ? 
FAT_LFN_LEN
 : 12è* 
NLS_MAX_CHARSET_SIZE
;

1822 
	}
}

1824 
	$__çt_wr™e_šode
(
šode
 *šode, 
wa™
)

1826 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1827 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

1828 
bufãr_h—d
 *
bh
;

1829 
msdos_dœ_’Œy
 *
¿w_’Œy
;

1830 
loff_t
 
i_pos
;

1831 
£ùÜ_t
 
blockÄ
;

1832 
”r
, 
off£t
;

1839 ià(
šode
->
i_šo
 =ð
MSDOS_ROOT_INO
)

1843 ifÐ
	`S_ISDIR
Ð
šode
->
i_mode
 ) );

1846 ifÐ
šode
->
i_šo
 =ð
i_num
 )

1853 
i_num
 = 
šode
->
i_šo
;

1855 ifÐ
šode
->
i_size
 >= 25000 )

1857 
	`g‘_¬—_numb”
Ð&
¬—_num
, 
šode
 );

1859 
d’Œy
 = 
	`li¡_’Œy
Ð
šode
->
i_d’Œy
.
fœ¡
, d’Œy, 
d_u
.
d_®Ÿs
 );

1860 ifÐ
d’Œy
 =ð
NULL
 )

1862 
	`´štk
("[cheon] __fat_write_inode, dentry…ointer is NULL \n");

1866 ifÐ
d’Œy
->
d_Çme
.
Çme
 !ð
NULL
 )

1870 ifÐ
	`¡r¡r
Ð
d’Œy
->
d_Çme
.
Çme
, "avi" ) )

1871 
	`´štk
("[cheon] __fat_write_inode,‡vi file detected \n");

1885 
»Œy
:

1886 
i_pos
 = 
	`çt_i_pos_»ad
(
sbi
, 
šode
);

1887 ià(!
i_pos
)

1890 
	`çt_g‘_blkÄ_off£t
(
sbi
, 
i_pos
, &
blockÄ
, &
off£t
);

1891 
bh
 = 
	`sb_b»ad
(
sb
, 
blockÄ
);

1892 ià(!
bh
) {

1893 
	`çt_msg
(
sb
, 
KERN_ERR
, "unableo„ead inode block "

1894 "fÜ upd©šg (i_po %Îd)", 
i_pos
);

1895  -
EIO
;

1897 
	`¥š_lock
(&
sbi
->
šode_hash_lock
);

1898 ià(
i_pos
 !ð
	`MSDOS_I
(
šode
)->i_pos) {

1899 
	`¥š_uÆock
(&
sbi
->
šode_hash_lock
);

1900 
	`b»l£
(
bh
);

1901 
»Œy
;

1904 
¿w_’Œy
 = &((
msdos_dœ_’Œy
 *è(
bh
->
b_d©a
))[
off£t
];

1905 ià(
	`S_ISDIR
(
šode
->
i_mode
))

1906 
¿w_’Œy
->
size
 = 0;

1910 
¿w_’Œy
->
size
 = 
	`ýu_to_Ë32
(
šode
->
i_size
);

1912 
¿w_’Œy
->
©Œ
 = 
	`çt_make_©Œs
(
šode
);

1913 
	`çt_£t_¡¬t
(
¿w_’Œy
, 
	`MSDOS_I
(
šode
)->
i_log¡¬t
);

1914 
	`çt_time_unix2çt
(
sbi
, &
šode
->
i_mtime
, &
¿w_’Œy
->
time
,

1915 &
¿w_’Œy
->
d©e
, 
NULL
);

1917 ià(
sbi
->
ÝtiÚs
.
isvçt
) {

1918 
__Ë16
 
©ime
;

1919 
	`çt_time_unix2çt
(
sbi
, &
šode
->
i_ùime
, &
¿w_’Œy
->
ùime
,

1920 &
¿w_’Œy
->
cd©e
, &¿w_’Œy->
ùime_cs
);

1921 
	`çt_time_unix2çt
(
sbi
, &
šode
->
i_©ime
, &
©ime
,

1922 &
¿w_’Œy
->
ad©e
, 
NULL
);

1925 
	`¥š_uÆock
(&
sbi
->
šode_hash_lock
);

1926 
	`m¬k_bufãr_dœty
(
bh
);

1927 
”r
 = 0;

1928 ià(
wa™
)

1929 
”r
 = 
	`sync_dœty_bufãr
(
bh
);

1930 
	`b»l£
(
bh
);

1931  
”r
;

1932 
	}
}

1934 
	$çt_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒÞ
 *
wbc
)

1936 
”r
;

1938 ià(
šode
->
i_šo
 =ð
MSDOS_FSINFO_INO
) {

1939 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

1941 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

1942 
”r
 = 
	`çt_þu¡”s_æush
(
sb
);

1943 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

1945 
”r
 = 
	`__çt_wr™e_šode
(
šode
, 
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
);

1947  
”r
;

1948 
	}
}

1950 
	$çt_sync_šode
(
šode
 *inode)

1953 #ifdeà
__DEBUG__


1954 
	`´štk
Ð
KERN_ALERT
 "[cheon] fat_sync_inode \n");

1956  
	`__çt_wr™e_šode
(
šode
, 1);

1957 
	}
}

1959 
EXPORT_SYMBOL_GPL
(
çt_sync_šode
);

1961 
çt_show_ÝtiÚs
(
£q_fže
 *
m
, 
d’Œy
 *
roÙ
);

1962 cÚ¡ 
su³r_Ý”©iÚs
 
	gçt_sÝs
 = {

1963 .
®loc_šode
 = 
çt_®loc_šode
,

1964 .
	gde¡roy_šode
 = 
çt_de¡roy_šode
,

1965 .
	gwr™e_šode
 = 
çt_wr™e_šode
,

1966 .
	geviù_šode
 = 
çt_eviù_šode
,

1967 .
	gput_su³r
 = 
çt_put_su³r
,

1968 .
	g¡©fs
 = 
çt_¡©fs
,

1969 .
	g»mouÁ_fs
 = 
çt_»mouÁ
,

1971 .
	gshow_ÝtiÚs
 = 
çt_show_ÝtiÚs
,

1974 
	$çt_show_ÝtiÚs
(
£q_fže
 *
m
, 
d’Œy
 *
roÙ
)

1976 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
roÙ
->
d_sb
);

1977 
çt_mouÁ_ÝtiÚs
 *
Ýts
 = &
sbi
->
ÝtiÚs
;

1978 
isvçt
 = 
Ýts
->isvfat;

1980 ià(!
	`uid_eq
(
Ýts
->
fs_uid
, 
GLOBAL_ROOT_UID
))

1981 
	`£q_´štf
(
m
, ",uid=%u",

1982 
	`äom_kuid_munged
(&
š™_u£r_ns
, 
Ýts
->
fs_uid
));

1983 ià(!
	`gid_eq
(
Ýts
->
fs_gid
, 
GLOBAL_ROOT_GID
))

1984 
	`£q_´štf
(
m
, ",gid=%u",

1985 
	`äom_kgid_munged
(&
š™_u£r_ns
, 
Ýts
->
fs_gid
));

1986 
	`£q_´štf
(
m
, ",fmask=%04o", 
Ýts
->
fs_fmask
);

1987 
	`£q_´štf
(
m
, ",dmask=%04o", 
Ýts
->
fs_dmask
);

1988 ià(
Ýts
->
®low_utime
)

1989 
	`£q_´štf
(
m
, ",®low_utime=%04o", 
Ýts
->
®low_utime
);

1990 ià(
sbi
->
Æs_disk
)

1992 
	`£q_´štf
(
m
, ",cod•age=%s", &
sbi
->
Æs_disk
->
ch¬£t
[2]);

1993 ià(
isvçt
) {

1994 ià(
sbi
->
Æs_io
)

1995 
	`£q_´štf
(
m
, ",ioch¬£t=%s", 
sbi
->
Æs_io
->
ch¬£t
);

1997 
Ýts
->
shÜŠame
) {

1998 
VFAT_SFN_DISPLAY_WIN95
 | 
VFAT_SFN_CREATE_WIN95
:

1999 
	`£q_puts
(
m
, ",shortname=win95");

2001 
VFAT_SFN_DISPLAY_WINNT
 | 
VFAT_SFN_CREATE_WINNT
:

2002 
	`£q_puts
(
m
, ",shortname=winnt");

2004 
VFAT_SFN_DISPLAY_WINNT
 | 
VFAT_SFN_CREATE_WIN95
:

2005 
	`£q_puts
(
m
, ",shortname=mixed");

2007 
VFAT_SFN_DISPLAY_LOWER
 | 
VFAT_SFN_CREATE_WIN95
:

2008 
	`£q_puts
(
m
, ",shortname=lower");

2011 
	`£q_puts
(
m
, ",shortname=unknown");

2015 ià(
Ýts
->
Çme_check
 != 'n')

2016 
	`£q_´štf
(
m
, ",check=%c", 
Ýts
->
Çme_check
);

2017 ià(
Ýts
->
u£ä“
)

2018 
	`£q_puts
(
m
, ",usefree");

2019 ià(
Ýts
->
qu›t
)

2020 
	`£q_puts
(
m
, ",quiet");

2021 ià(
Ýts
->
showexec
)

2022 
	`£q_puts
(
m
, ",showexec");

2023 ià(
Ýts
->
sys_immubË
)

2024 
	`£q_puts
(
m
, ",sys_immutable");

2025 ià(!
isvçt
) {

2026 ià(
Ýts
->
dÙsOK
)

2027 
	`£q_puts
(
m
, ",dotsOK=yes");

2028 ià(
Ýts
->
noÿ£
)

2029 
	`£q_puts
(
m
, ",nocase");

2031 ià(
Ýts
->
utf8
)

2032 
	`£q_puts
(
m
, ",utf8");

2033 ià(
Ýts
->
unicode_xÏ‹
)

2034 
	`£q_puts
(
m
, ",uni_xlate");

2035 ià(!
Ýts
->
numž
)

2036 
	`£q_puts
(
m
, ",nonumtail");

2037 ià(
Ýts
->
rodœ
)

2038 
	`£q_puts
(
m
, ",rodir");

2040 ià(
Ýts
->
æush
)

2041 
	`£q_puts
(
m
, ",flush");

2042 ià(
Ýts
->
tz_£t
) {

2043 ià(
Ýts
->
time_off£t
)

2044 
	`£q_´štf
(
m
, ",time_off£t=%d", 
Ýts
->
time_off£t
);

2046 
	`£q_puts
(
m
, ",tz=UTC");

2048 ià(
Ýts
->
”rÜs
 =ð
FAT_ERRORS_CONT
)

2049 
	`£q_puts
(
m
, ",errors=continue");

2050 ià(
Ýts
->
”rÜs
 =ð
FAT_ERRORS_PANIC
)

2051 
	`£q_puts
(
m
, ",errors=panic");

2053 
	`£q_puts
(
m
, ",errors=remount-ro");

2054 ià(
Ýts
->
nfs
 =ð
FAT_NFS_NOSTALE_RO
)

2055 
	`£q_puts
(
m
, ",nfs=nostale_ro");

2056 ià(
Ýts
->
nfs
)

2057 
	`£q_puts
(
m
, ",nfs=stale_rw");

2058 ià(
Ýts
->
disÿrd
)

2059 
	`£q_puts
(
m
, ",discard");

2062 
	}
}

2065 
	mO±_check_n
, 
	mO±_check_r
, 
	mO±_check_s
, 
	mO±_uid
, 
	mO±_gid
,

2066 
	mO±_umask
, 
	mO±_dmask
, 
	mO±_fmask
, 
	mO±_®low_utime
, 
	mO±_cod•age
,

2067 
	mO±_u£ä“
, 
	mO±_noÿ£
, 
	mO±_qu›t
, 
	mO±_showexec
, 
	mO±_debug
,

2068 
	mO±_immubË
, 
	mO±_dÙs
, 
	mO±_nodÙs
,

2069 
	mO±_ch¬£t
, 
	mO±_shÜŠame_low”
, 
	mO±_shÜŠame_wš95
,

2070 
	mO±_shÜŠame_wšÁ
, 
	mO±_shÜŠame_mixed
, 
	mO±_utf8_no
, 
	mO±_utf8_yes
,

2071 
	mO±_uni_xl_no
, 
	mO±_uni_xl_yes
, 
	mO±_nÚumž_no
, 
	mO±_nÚumž_yes
,

2072 
	mO±_obsÞ‘e
, 
	mO±_æush
, 
	mO±_tz_utc
, 
	mO±_rodœ
, 
	mO±_”r_cÚt
,

2073 
	mO±_”r_·nic
, 
	mO±_”r_ro
, 
	mO±_disÿrd
, 
	mO±_nfs
, 
	mO±_time_off£t
,

2074 
	mO±_nfs_¡®e_rw
, 
	mO±_nfs_no¡®e_ro
, 
	mO±_”r
,

2077 cÚ¡ 
m©ch_bË_t
 
	gçt_tok’s
 = {

2078 {
O±_check_r
, "check=relaxed"},

2079 {
O±_check_s
, "check=strict"},

2080 {
O±_check_n
, "check=normal"},

2081 {
O±_check_r
, "check=r"},

2082 {
O±_check_s
, "check=s"},

2083 {
O±_check_n
, "check=n"},

2084 {
O±_uid
, "uid=%u"},

2085 {
O±_gid
, "gid=%u"},

2086 {
O±_umask
, "umask=%o"},

2087 {
O±_dmask
, "dmask=%o"},

2088 {
O±_fmask
, "fmask=%o"},

2089 {
O±_®low_utime
, "allow_utime=%o"},

2090 {
O±_cod•age
, "codepage=%u"},

2091 {
O±_u£ä“
, "usefree"},

2092 {
O±_noÿ£
, "nocase"},

2093 {
O±_qu›t
, "quiet"},

2094 {
O±_showexec
, "showexec"},

2095 {
O±_debug
, "debug"},

2096 {
O±_immubË
, "sys_immutable"},

2097 {
O±_æush
, "flush"},

2098 {
O±_tz_utc
, "tz=UTC"},

2099 {
O±_time_off£t
, "time_offset=%d"},

2100 {
O±_”r_cÚt
, "errors=continue"},

2101 {
O±_”r_·nic
, "errors=panic"},

2102 {
O±_”r_ro
, "errors=remount-ro"},

2103 {
O±_disÿrd
, "discard"},

2104 {
O±_nfs_¡®e_rw
, "nfs"},

2105 {
O±_nfs_¡®e_rw
, "nfs=stale_rw"},

2106 {
O±_nfs_no¡®e_ro
, "nfs=nostale_ro"},

2107 {
O±_obsÞ‘e
, "conv=binary"},

2108 {
O±_obsÞ‘e
, "conv=text"},

2109 {
O±_obsÞ‘e
, "conv=auto"},

2110 {
O±_obsÞ‘e
, "conv=b"},

2111 {
O±_obsÞ‘e
, "conv=t"},

2112 {
O±_obsÞ‘e
, "conv=a"},

2113 {
O±_obsÞ‘e
, "fat=%u"},

2114 {
O±_obsÞ‘e
, "blocksize=%u"},

2115 {
O±_obsÞ‘e
, "cvf_format=%20s"},

2116 {
O±_obsÞ‘e
, "cvf_options=%100s"},

2117 {
O±_obsÞ‘e
, "posix"},

2118 {
O±_”r
, 
NULL
},

2120 cÚ¡ 
m©ch_bË_t
 
	gmsdos_tok’s
 = {

2121 {
O±_nodÙs
, "nodots"},

2122 {
O±_nodÙs
, "dotsOK=no"},

2123 {
O±_dÙs
, "dots"},

2124 {
O±_dÙs
, "dotsOK=yes"},

2125 {
O±_”r
, 
NULL
}

2127 cÚ¡ 
m©ch_bË_t
 
	gvçt_tok’s
 = {

2128 {
O±_ch¬£t
, "iocharset=%s"},

2129 {
O±_shÜŠame_low”
, "shortname=lower"},

2130 {
O±_shÜŠame_wš95
, "shortname=win95"},

2131 {
O±_shÜŠame_wšÁ
, "shortname=winnt"},

2132 {
O±_shÜŠame_mixed
, "shortname=mixed"},

2133 {
O±_utf8_no
, "utf8=0"},

2134 {
O±_utf8_no
, "utf8=no"},

2135 {
O±_utf8_no
, "utf8=false"},

2136 {
O±_utf8_yes
, "utf8=1"},

2137 {
O±_utf8_yes
, "utf8=yes"},

2138 {
O±_utf8_yes
, "utf8=true"},

2139 {
O±_utf8_yes
, "utf8"},

2140 {
O±_uni_xl_no
, "uni_xlate=0"},

2141 {
O±_uni_xl_no
, "uni_xlate=no"},

2142 {
O±_uni_xl_no
, "uni_xlate=false"},

2143 {
O±_uni_xl_yes
, "uni_xlate=1"},

2144 {
O±_uni_xl_yes
, "uni_xlate=yes"},

2145 {
O±_uni_xl_yes
, "uni_xlate=true"},

2146 {
O±_uni_xl_yes
, "uni_xlate"},

2147 {
O±_nÚumž_no
, "nonumtail=0"},

2148 {
O±_nÚumž_no
, "nonumtail=no"},

2149 {
O±_nÚumž_no
, "nonumtail=false"},

2150 {
O±_nÚumž_yes
, "nonumtail=1"},

2151 {
O±_nÚumž_yes
, "nonumtail=yes"},

2152 {
O±_nÚumž_yes
, "nonumtail=true"},

2153 {
O±_nÚumž_yes
, "nonumtail"},

2154 {
O±_rodœ
, "rodir"},

2155 {
O±_”r
, 
NULL
}

2158 
	$·r£_ÝtiÚs
(
su³r_block
 *
sb
, *
ÝtiÚs
, 
is_vçt
,

2159 
sž’t
, *
debug
, 
çt_mouÁ_ÝtiÚs
 *
Ýts
)

2161 *
p
;

2162 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

2163 
ÝtiÚ
;

2164 *
ioch¬£t
;

2166 
Ýts
->
isvçt
 = 
is_vçt
;

2168 
Ýts
->
fs_uid
 = 
	`cu¼’t_uid
();

2169 
Ýts
->
fs_gid
 = 
	`cu¼’t_gid
();

2170 
Ýts
->
fs_fmask
 = o±s->
fs_dmask
 = 
	`cu¼’t_umask
();

2171 
Ýts
->
®low_utime
 = -1;

2172 
Ýts
->
cod•age
 = 
çt_deçuÉ_cod•age
;

2173 
Ýts
->
ioch¬£t
 = 
çt_deçuÉ_ioch¬£t
;

2174 ià(
is_vçt
) {

2175 
Ýts
->
shÜŠame
 = 
VFAT_SFN_DISPLAY_WINNT
|
VFAT_SFN_CREATE_WIN95
;

2176 
Ýts
->
rodœ
 = 0;

2178 
Ýts
->
shÜŠame
 = 0;

2179 
Ýts
->
rodœ
 = 1;

2181 
Ýts
->
Çme_check
 = 'n';

2182 
Ýts
->
qu›t
 = o±s->
showexec
 = o±s->
sys_immubË
 = o±s->
dÙsOK
 = 0;

2183 
Ýts
->
utf8
 = o±s->
unicode_xÏ‹
 = 0;

2184 
Ýts
->
numž
 = 1;

2185 
Ýts
->
u£ä“
 = o±s->
noÿ£
 = 0;

2186 
Ýts
->
tz_£t
 = 0;

2187 
Ýts
->
nfs
 = 0;

2188 
Ýts
->
”rÜs
 = 
FAT_ERRORS_RO
;

2189 *
debug
 = 0;

2191 ià(!
ÝtiÚs
)

2192 
out
;

2194 (
p
 = 
	`¡r£p
(&
ÝtiÚs
, ",")è!ð
NULL
) {

2195 
tok’
;

2196 ià(!*
p
)

2199 
tok’
 = 
	`m©ch_tok’
(
p
, 
çt_tok’s
, 
¬gs
);

2200 ià(
tok’
 =ð
O±_”r
) {

2201 ià(
is_vçt
)

2202 
tok’
 = 
	`m©ch_tok’
(
p
, 
vçt_tok’s
, 
¬gs
);

2204 
tok’
 = 
	`m©ch_tok’
(
p
, 
msdos_tok’s
, 
¬gs
);

2206 
tok’
) {

2207 
O±_check_s
:

2208 
Ýts
->
Çme_check
 = 's';

2210 
O±_check_r
:

2211 
Ýts
->
Çme_check
 = 'r';

2213 
O±_check_n
:

2214 
Ýts
->
Çme_check
 = 'n';

2216 
O±_u£ä“
:

2217 
Ýts
->
u£ä“
 = 1;

2219 
O±_noÿ£
:

2220 ià(!
is_vçt
)

2221 
Ýts
->
noÿ£
 = 1;

2224 
Ýts
->
shÜŠame
 = 
VFAT_SFN_DISPLAY_WIN95


2225 | 
VFAT_SFN_CREATE_WIN95
;

2228 
O±_qu›t
:

2229 
Ýts
->
qu›t
 = 1;

2231 
O±_showexec
:

2232 
Ýts
->
showexec
 = 1;

2234 
O±_debug
:

2235 *
debug
 = 1;

2237 
O±_immubË
:

2238 
Ýts
->
sys_immubË
 = 1;

2240 
O±_uid
:

2241 ià(
	`m©ch_št
(&
¬gs
[0], &
ÝtiÚ
))

2242  -
EINVAL
;

2243 
Ýts
->
fs_uid
 = 
	`make_kuid
(
	`cu¼’t_u£r_ns
(), 
ÝtiÚ
);

2244 ià(!
	`uid_v®id
(
Ýts
->
fs_uid
))

2245  -
EINVAL
;

2247 
O±_gid
:

2248 ià(
	`m©ch_št
(&
¬gs
[0], &
ÝtiÚ
))

2249  -
EINVAL
;

2250 
Ýts
->
fs_gid
 = 
	`make_kgid
(
	`cu¼’t_u£r_ns
(), 
ÝtiÚ
);

2251 ià(!
	`gid_v®id
(
Ýts
->
fs_gid
))

2252  -
EINVAL
;

2254 
O±_umask
:

2255 ià(
	`m©ch_où®
(&
¬gs
[0], &
ÝtiÚ
))

2256  -
EINVAL
;

2257 
Ýts
->
fs_fmask
 = o±s->
fs_dmask
 = 
ÝtiÚ
;

2259 
O±_dmask
:

2260 ià(
	`m©ch_où®
(&
¬gs
[0], &
ÝtiÚ
))

2261  -
EINVAL
;

2262 
Ýts
->
fs_dmask
 = 
ÝtiÚ
;

2264 
O±_fmask
:

2265 ià(
	`m©ch_où®
(&
¬gs
[0], &
ÝtiÚ
))

2266  -
EINVAL
;

2267 
Ýts
->
fs_fmask
 = 
ÝtiÚ
;

2269 
O±_®low_utime
:

2270 ià(
	`m©ch_où®
(&
¬gs
[0], &
ÝtiÚ
))

2271  -
EINVAL
;

2272 
Ýts
->
®low_utime
 = 
ÝtiÚ
 & (
S_IWGRP
 | 
S_IWOTH
);

2274 
O±_cod•age
:

2275 ià(
	`m©ch_št
(&
¬gs
[0], &
ÝtiÚ
))

2276  -
EINVAL
;

2277 
Ýts
->
cod•age
 = 
ÝtiÚ
;

2279 
O±_æush
:

2280 
Ýts
->
æush
 = 1;

2282 
O±_time_off£t
:

2283 ià(
	`m©ch_št
(&
¬gs
[0], &
ÝtiÚ
))

2284  -
EINVAL
;

2285 ià(
ÝtiÚ
 < -12 * 60 || option > 12 * 60)

2286  -
EINVAL
;

2287 
Ýts
->
tz_£t
 = 1;

2288 
Ýts
->
time_off£t
 = 
ÝtiÚ
;

2290 
O±_tz_utc
:

2291 
Ýts
->
tz_£t
 = 1;

2292 
Ýts
->
time_off£t
 = 0;

2294 
O±_”r_cÚt
:

2295 
Ýts
->
”rÜs
 = 
FAT_ERRORS_CONT
;

2297 
O±_”r_·nic
:

2298 
Ýts
->
”rÜs
 = 
FAT_ERRORS_PANIC
;

2300 
O±_”r_ro
:

2301 
Ýts
->
”rÜs
 = 
FAT_ERRORS_RO
;

2303 
O±_nfs_¡®e_rw
:

2304 
Ýts
->
nfs
 = 
FAT_NFS_STALE_RW
;

2306 
O±_nfs_no¡®e_ro
:

2307 
Ýts
->
nfs
 = 
FAT_NFS_NOSTALE_RO
;

2311 
O±_dÙs
:

2312 
Ýts
->
dÙsOK
 = 1;

2314 
O±_nodÙs
:

2315 
Ýts
->
dÙsOK
 = 0;

2319 
O±_ch¬£t
:

2320 ià(
Ýts
->
ioch¬£t
 !ð
çt_deçuÉ_ioch¬£t
)

2321 
	`kä“
(
Ýts
->
ioch¬£t
);

2322 
ioch¬£t
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

2323 ià(!
ioch¬£t
)

2324  -
ENOMEM
;

2325 
Ýts
->
ioch¬£t
 = iocharset;

2327 
O±_shÜŠame_low”
:

2328 
Ýts
->
shÜŠame
 = 
VFAT_SFN_DISPLAY_LOWER


2329 | 
VFAT_SFN_CREATE_WIN95
;

2331 
O±_shÜŠame_wš95
:

2332 
Ýts
->
shÜŠame
 = 
VFAT_SFN_DISPLAY_WIN95


2333 | 
VFAT_SFN_CREATE_WIN95
;

2335 
O±_shÜŠame_wšÁ
:

2336 
Ýts
->
shÜŠame
 = 
VFAT_SFN_DISPLAY_WINNT


2337 | 
VFAT_SFN_CREATE_WINNT
;

2339 
O±_shÜŠame_mixed
:

2340 
Ýts
->
shÜŠame
 = 
VFAT_SFN_DISPLAY_WINNT


2341 | 
VFAT_SFN_CREATE_WIN95
;

2343 
O±_utf8_no
:

2344 
Ýts
->
utf8
 = 0;

2346 
O±_utf8_yes
:

2347 
Ýts
->
utf8
 = 1;

2349 
O±_uni_xl_no
:

2350 
Ýts
->
unicode_xÏ‹
 = 0;

2352 
O±_uni_xl_yes
:

2353 
Ýts
->
unicode_xÏ‹
 = 1;

2355 
O±_nÚumž_no
:

2356 
Ýts
->
numž
 = 1;

2358 
O±_nÚumž_yes
:

2359 
Ýts
->
numž
 = 0;

2361 
O±_rodœ
:

2362 
Ýts
->
rodœ
 = 1;

2364 
O±_disÿrd
:

2365 
Ýts
->
disÿrd
 = 1;

2369 
O±_obsÞ‘e
:

2370 
	`çt_msg
(
sb
, 
KERN_INFO
, "\"%s\" option is obsolete, "

2371 "nÙ suµÜ‹d‚ow", 
p
);

2375 ià(!
sž’t
) {

2376 
	`çt_msg
(
sb
, 
KERN_ERR
,

2378 "Ü missšg v®ue", 
p
);

2380  -
EINVAL
;

2384 
out
:

2386 ià(!
	`¡rcmp
(
Ýts
->
ioch¬£t
, "utf8")) {

2387 
	`çt_msg
(
sb
, 
KERN_WARNING
, "utf8 is‚ot‡„ecommended IO charset"

2393 ià(
Ýts
->
®low_utime
 == ()-1)

2394 
Ýts
->
®low_utime
 = ~Ýts->
fs_dmask
 & (
S_IWGRP
 | 
S_IWOTH
);

2395 ià(
Ýts
->
unicode_xÏ‹
)

2396 
Ýts
->
utf8
 = 0;

2397 ià(
Ýts
->
nfs
 =ð
FAT_NFS_NOSTALE_RO
) {

2398 
sb
->
s_æags
 |ð
MS_RDONLY
;

2399 
sb
->
s_expÜt_Ý
 = &
çt_expÜt_Ýs_no¡®e
;

2403 
	}
}

2405 
	$çt_»ad_roÙ
(
šode
 *inode)

2407 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

2408 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

2409 
”rÜ
;

2411 
	`MSDOS_I
(
šode
)->
i_pos
 = 
MSDOS_ROOT_INO
;

2412 
šode
->
i_uid
 = 
sbi
->
ÝtiÚs
.
fs_uid
;

2413 
šode
->
i_gid
 = 
sbi
->
ÝtiÚs
.
fs_gid
;

2414 
šode
->
i_v”siÚ
++;

2415 
šode
->
i_g’”©iÚ
 = 0;

2416 
šode
->
i_mode
 = 
	`çt_make_mode
(
sbi
, 
ATTR_DIR
, 
S_IRWXUGO
);

2417 
šode
->
i_Ý
 = 
sbi
->
dœ_Ýs
;

2418 
šode
->
i_fÝ
 = &
çt_dœ_Ý”©iÚs
;

2419 ià(
sbi
->
çt_b™s
 == 32) {

2420 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
sbi
->
roÙ_þu¡”
;

2421 
”rÜ
 = 
	`çt_ÿlc_dœ_size
(
šode
);

2422 ià(
”rÜ
 < 0)

2423  
”rÜ
;

2425 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 0;

2426 
šode
->
i_size
 = 
sbi
->
dœ_’Œ›s
 * (
msdos_dœ_’Œy
);

2428 
šode
->
i_blocks
 = ((šode->
i_size
 + (
sbi
->
þu¡”_size
 - 1))

2429 & ~((
loff_t
)
sbi
->
þu¡”_size
 - 1)) >> 9;

2430 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = 0;

2431 
	`MSDOS_I
(
šode
)->
mmu_´iv©e
 = inode->
i_size
;

2433 
	`çt_§ve_©Œs
(
šode
, 
ATTR_DIR
);

2434 
šode
->
i_mtime
.
tv_£c
 = inode->
i_©ime
.tv_£øðšode->
i_ùime
.tv_sec = 0;

2435 
šode
->
i_mtime
.
tv_n£c
 = inode->
i_©ime
.tv_n£øðšode->
i_ùime
.tv_nsec = 0;

2436 
	`£t_Æšk
(
šode
, 
	`çt_subdœs
(inode)+2);

2439 
	}
}

2441 
	$ÿlc_çt_þu¡”s
(
su³r_block
 *
sb
)

2443 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

2446 ià(
sbi
->
çt_b™s
 != 12) {

2447 
’t_³r_£c
 = 
sb
->
s_blocksize
 * 8 / 
sbi
->
çt_b™s
;

2448  
’t_³r_£c
 * 
sbi
->
çt_Ëngth
;

2451  
sbi
->
çt_Ëngth
 * 
sb
->
s_blocksize
 * 8 / sbi->
çt_b™s
;

2452 
	}
}

2457 
çt_fžl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
sž’t
, 
isvçt
,

2458 (*
£tup
)(
su³r_block
 *))

2460 
šode
 *
roÙ_šode
 = 
NULL
, *
çt_šode
 = NULL;

2461 
šode
 *
fsšfo_šode
 = 
NULL
;

2462 
bufãr_h—d
 *
bh
;

2463 
çt_boÙ_£ùÜ
 *
b
;

2464 
msdos_sb_šfo
 *
sbi
;

2465 
u16
 
logiÿl_£ùÜ_size
;

2466 
u32
 
tÙ®_£ùÜs
, 
tÙ®_þu¡”s
, 
çt_þu¡”s
, 
roÙdœ_£ùÜs
;

2467 
debug
;

2468 
medŸ
;

2469 
”rÜ
;

2470 
buf
[50];

2478 
sbi
 = 
	`kz®loc
((
msdos_sb_šfo
), 
GFP_KERNEL
);

2479 ià(!
sbi
)

2480  -
ENOMEM
;

2481 
sb
->
s_fs_šfo
 = 
sbi
;

2483 
sb
->
s_æags
 |ð
MS_NODIRATIME
;

2484 
sb
->
s_magic
 = 
MSDOS_SUPER_MAGIC
;

2485 
sb
->
s_Ý
 = &
çt_sÝs
;

2486 
sb
->
s_expÜt_Ý
 = &
çt_expÜt_Ýs
;

2487 
	`mu‹x_š™
(&
sbi
->
nfs_bužd_šode_lock
);

2488 
	`¿‹lim™_¡©e_š™
(&
sbi
->
¿‹lim™
, 
DEFAULT_RATELIMIT_INTERVAL
,

2489 
DEFAULT_RATELIMIT_BURST
);

2491 
”rÜ
 = 
	`·r£_ÝtiÚs
(
sb
, 
d©a
, 
isvçt
, 
sž’t
, &
debug
, &
sbi
->
ÝtiÚs
);

2492 ià(
”rÜ
)

2493 
out_çž
;

2495 
	`£tup
(
sb
);

2497 
”rÜ
 = -
EIO
;

2498 
	`sb_mš_blocksize
(
sb
, 512);

2500 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sb->blocksiz: %u\n", 
sb
->
s_blocksize
);

2503 
bh
 = 
	`sb_b»ad
(
sb
, 0);

2504 ià(
bh
 =ð
NULL
) {

2505 
	`çt_msg
(
sb
, 
KERN_ERR
, "unableo„ead boot sector");

2506 
out_çž
;

2509 
b
 = (
çt_boÙ_£ùÜ
 *è
bh
->
b_d©a
;

2510 ià(!
b
->
»£rved
) {

2511 ià(!
sž’t
)

2512 
	`çt_msg
(
sb
, 
KERN_ERR
, "bogus‚umber of„eserved sectors");

2513 
	`b»l£
(
bh
);

2514 
out_šv®id
;

2516 ià(!
b
->
çts
) {

2517 ià(!
sž’t
)

2518 
	`çt_msg
(
sb
, 
KERN_ERR
, "bogus‚umber of FAT structure");

2519 
	`b»l£
(
bh
);

2520 
out_šv®id
;

2528 
medŸ
 = 
b
->media;

2529 ià(!
	`çt_v®id_medŸ
(
medŸ
)) {

2530 ià(!
sž’t
)

2531 
	`çt_msg
(
sb
, 
KERN_ERR
, "invalid media value (0x%02x)",

2532 
medŸ
);

2533 
	`b»l£
(
bh
);

2534 
out_šv®id
;

2536 
logiÿl_£ùÜ_size
 = 
	`g‘_uÇligÃd_Ë16
(&
b
->
£ùÜ_size
);

2537 
	`´štk
Ð
KERN_ALERT
 "[cheÚ]†ogiÿl_£ùÜ_siz: %u\n", 
logiÿl_£ùÜ_size
 );

2539 ià(!
	`is_pow”_of_2
(
logiÿl_£ùÜ_size
)

2540 || (
logiÿl_£ùÜ_size
 < 512)

2541 || (
logiÿl_£ùÜ_size
 > 4096)) {

2542 ià(!
sž’t
)

2543 
	`çt_msg
(
sb
, 
KERN_ERR
, "bogus†ogical sector size %u",

2544 
logiÿl_£ùÜ_size
);

2545 
	`b»l£
(
bh
);

2546 
out_šv®id
;

2548 
sbi
->
£c_³r_þus
 = 
b
->sec_per_clus;

2550 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sec_³r_þu : %u \n", 
sbi
->
£c_³r_þus
 );

2552 ià(!
	`is_pow”_of_2
(
sbi
->
£c_³r_þus
)) {

2553 ià(!
sž’t
)

2554 
	`çt_msg
(
sb
, 
KERN_ERR
, "bogus sectors…er cluster %u",

2555 
sbi
->
£c_³r_þus
);

2556 
	`b»l£
(
bh
);

2557 
out_šv®id
;

2561 ià(
logiÿl_£ùÜ_size
 < 
sb
->
s_blocksize
) {

2562 
	`çt_msg
(
sb
, 
KERN_ERR
, "logical sector sizeoo small for device"

2563 " (logiÿÈ£ùÜ sizð%u)", 
logiÿl_£ùÜ_size
);

2564 
	`b»l£
(
bh
);

2565 
out_çž
;

2567 ià(
logiÿl_£ùÜ_size
 > 
sb
->
s_blocksize
) {

2568 
	`b»l£
(
bh
);

2570 ià(!
	`sb_£t_blocksize
(
sb
, 
logiÿl_£ùÜ_size
)) {

2571 
	`çt_msg
(
sb
, 
KERN_ERR
, "unableo set blocksize %u",

2572 
logiÿl_£ùÜ_size
);

2573 
out_çž
;

2575 
bh
 = 
	`sb_b»ad
(
sb
, 0);

2576 ià(
bh
 =ð
NULL
) {

2577 
	`çt_msg
(
sb
, 
KERN_ERR
, "unableo„ead boot sector"

2579 
sb
->
s_blocksize
);

2580 
out_çž
;

2582 
b
 = (
çt_boÙ_£ùÜ
 *è
bh
->
b_d©a
;

2585 
	`mu‹x_š™
(&
sbi
->
s_lock
);

2586 
sbi
->
þu¡”_size
 = 
sb
->
s_blocksize
 * sbi->
£c_³r_þus
;

2587 
sbi
->
þu¡”_b™s
 = 
	`ffs
(sbi->
þu¡”_size
) - 1;

2588 
sbi
->
çts
 = 
b
->fats;

2589 
sbi
->
çt_b™s
 = 0;

2590 
sbi
->
çt_¡¬t
 = 
	`Ë16_to_ýu
(
b
->
»£rved
);

2591 
çt_block
 = 
sbi
->
çt_¡¬t
;

2593 
sbi
->
çt_Ëngth
 = 
	`Ë16_to_ýu
(
b
->fat_length);

2594 
sbi
->
roÙ_þu¡”
 = 0;

2595 
sbi
->
ä“_þu¡”s
 = -1;

2596 
sbi
->
ä“_þus_v®id
 = 0;

2597 
sbi
->
´ev_ä“
 = 
FAT_START_ENT
;

2598 
sb
->
s_maxby‹s
 = 0xffffffff;

2600 ià(!
sbi
->
çt_Ëngth
 && 
b
->
çt32
.
Ëngth
) {

2601 
çt_boÙ_fsšfo
 *
fsšfo
;

2602 
bufãr_h—d
 *
fsšfo_bh
;

2605 
sbi
->
çt_b™s
 = 32;

2606 
sbi
->
çt_Ëngth
 = 
	`Ë32_to_ýu
(
b
->
çt32
.
Ëngth
);

2607 
sbi
->
roÙ_þu¡”
 = 
	`Ë32_to_ýu
(
b
->
çt32
.root_cluster);

2610 
sbi
->
fsšfo_£ùÜ
 = 
	`Ë16_to_ýu
(
b
->
çt32
.
šfo_£ùÜ
);

2611 ià(
sbi
->
fsšfo_£ùÜ
 == 0)

2612 
sbi
->
fsšfo_£ùÜ
 = 1;

2614 
fsšfo_bh
 = 
	`sb_b»ad
(
sb
, 
sbi
->
fsšfo_£ùÜ
);

2615 ià(
fsšfo_bh
 =ð
NULL
) {

2616 
	`çt_msg
(
sb
, 
KERN_ERR
, "bread failed, FSINFO block"

2617 " (£ùÜ = %lu)", 
sbi
->
fsšfo_£ùÜ
);

2618 
	`b»l£
(
bh
);

2619 
out_çž
;

2622 
fsšfo
 = (
çt_boÙ_fsšfo
 *)
fsšfo_bh
->
b_d©a
;

2623 ià(!
	`IS_FSINFO
(
fsšfo
)) {

2624 
	`çt_msg
(
sb
, 
KERN_WARNING
, "Invalid FSINFO signature: "

2626 
	`Ë32_to_ýu
(
fsšfo
->
sigÇtu»1
),

2627 
	`Ë32_to_ýu
(
fsšfo
->
sigÇtu»2
),

2628 
sbi
->
fsšfo_£ùÜ
);

2630 ià(
sbi
->
ÝtiÚs
.
u£ä“
)

2631 
sbi
->
ä“_þus_v®id
 = 1;

2632 
sbi
->
ä“_þu¡”s
 = 
	`Ë32_to_ýu
(
fsšfo
->free_clusters);

2633 
sbi
->
´ev_ä“
 = 
	`Ë32_to_ýu
(
fsšfo
->
Ãxt_þu¡”
);

2636 
	`b»l£
(
fsšfo_bh
);

2639 
sbi
->
dœ_³r_block
 = 
sb
->
s_blocksize
 / (
msdos_dœ_’Œy
);

2640 
sbi
->
dœ_³r_block_b™s
 = 
	`ffs
(sbi->
dœ_³r_block
) - 1;

2642 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->dœ_³r_block : %d, sbi->dœ_³r_block_b™ : %d \n", 
sbi
->
dœ_³r_block
, sbi->
dœ_³r_block_b™s
 );

2643 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sb->s_blocksiz: %u \n", 
sb
->
s_blocksize
 );

2644 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->þu¡”_sizðsb->s_blocksiz* sbi->£c_³r_þu : %u\n", 
sbi
->
þu¡”_size
 );

2645 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->çt Òumb” oàçtè: %u \n", 
sbi
->
çts
 );

2646 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->çt_Ëngth : %u \n", 
sbi
->
çt_Ëngth
 );

2647 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->çt_¡¬ˆ: %u \n", 
sbi
->
çt_¡¬t
 );

2649 
sbi
->
dœ_¡¬t
 = sbi->
çt_¡¬t
 + sbi->
çts
 * sbi->
çt_Ëngth
;

2650 
sbi
->
dœ_’Œ›s
 = 
	`g‘_uÇligÃd_Ë16
(&
b
->dir_entries);

2652 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->dœ_¡¬ˆ : %u \n", 
sbi
->
dœ_¡¬t
 );

2653 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->dœ_’Œ›  : %u \n", 
sbi
->
dœ_’Œ›s
 );

2655 ià(
sbi
->
dœ_’Œ›s
 & (sbi->
dœ_³r_block
 - 1)) {

2656 ià(!
sž’t
)

2657 
	`çt_msg
(
sb
, 
KERN_ERR
, "bogus directory-entries…er block"

2658 " (%u)", 
sbi
->
dœ_’Œ›s
);

2659 
	`b»l£
(
bh
);

2660 
out_šv®id
;

2663 
roÙdœ_£ùÜs
 = 
sbi
->
dœ_’Œ›s


2664 * (
msdos_dœ_’Œy
è/ 
sb
->
s_blocksize
;

2665 
sbi
->
d©a_¡¬t
 = sbi->
dœ_¡¬t
 + 
roÙdœ_£ùÜs
;

2667 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] sbi->d©a_¡¬ˆ : %u \n", 
sbi
->
d©a_¡¬t
 );

2669 
tÙ®_£ùÜs
 = 
	`g‘_uÇligÃd_Ë16
(&
b
->
£ùÜs
);

2670 ià(
tÙ®_£ùÜs
 == 0)

2671 
tÙ®_£ùÜs
 = 
	`Ë32_to_ýu
(
b
->
tÙ®_£ù
);

2673 
tÙ®_þu¡”s
 = (
tÙ®_£ùÜs
 - 
sbi
->
d©a_¡¬t
è/ sbi->
£c_³r_þus
;

2675 
	`´štk
Ð
KERN_ALERT
 "[cheÚ]Ù®_þu¡” ðÑÙ®_£ùÜ - sbi->d©a_¡¬tè/ sbi->£c_³r_þu  : %u \n", 
tÙ®_þu¡”s
 );

2677 ià(
sbi
->
çt_b™s
 != 32)

2678 
sbi
->
çt_b™s
 = (
tÙ®_þu¡”s
 > 
MAX_FAT12
) ? 16 : 12;

2681 ià(
sbi
->
çt_b™s
 == 32)

2682 
sbi
->
dœty
 = 
b
->
çt32
.
¡©e
 & 
FAT_STATE_DIRTY
;

2684 
sbi
->
dœty
 = 
b
->
çt16
.
¡©e
 & 
FAT_STATE_DIRTY
;

2687 
çt_þu¡”s
 = 
	`ÿlc_çt_þu¡”s
(
sb
);

2688 
tÙ®_þu¡”s
 = 
	`mš
ÑÙ®_þu¡”s, 
çt_þu¡”s
 - 
FAT_START_ENT
);

2690 
	`´štk
Ð
KERN_ALERT
 "[cheÚ] f©_þu¡” ðÿlc_çt_þu¡”s(sb): %u \n", 
çt_þu¡”s
 );

2691 
	`´štk
Ð
KERN_ALERT
 "[cheÚ]Ù®_þu¡” : mšÑÙ®_þu¡”s, f©_þu¡” - FAT_START_ENTè: %u \n", 
tÙ®_þu¡”s
 );

2693 ià(
tÙ®_þu¡”s
 > 
	`MAX_FAT
(
sb
)) {

2694 ià(!
sž’t
)

2695 
	`çt_msg
(
sb
, 
KERN_ERR
, "count of clustersoo big (%u)",

2696 
tÙ®_þu¡”s
);

2697 
	`b»l£
(
bh
);

2698 
out_šv®id
;

2701 
sbi
->
max_þu¡”
 = 
tÙ®_þu¡”s
 + 
FAT_START_ENT
;

2703 ià(
sbi
->
ä“_þu¡”s
 !ð-1 && sbi->ä“_þu¡” > 
tÙ®_þu¡”s
)

2704 
sbi
->
ä“_þu¡”s
 = -1;

2706 
sbi
->
´ev_ä“
 %ðsbi->
max_þu¡”
;

2707 ià(
sbi
->
´ev_ä“
 < 
FAT_START_ENT
)

2708 
sbi
->
´ev_ä“
 = 
FAT_START_ENT
;

2710 
	`b»l£
(
bh
);

2713 
	`çt_hash_š™
(
sb
);

2714 
	`dœ_hash_š™
(
sb
);

2715 
	`çt_’t_acûss_š™
(
sb
);

2725 
”rÜ
 = -
EINVAL
;

2726 
	`¥rštf
(
buf
, "ý%d", 
sbi
->
ÝtiÚs
.
cod•age
);

2727 
sbi
->
Æs_disk
 = 
	`lßd_Æs
(
buf
);

2728 ià(!
sbi
->
Æs_disk
) {

2729 
	`çt_msg
(
sb
, 
KERN_ERR
, "cod•ag% nÙ found", 
buf
);

2730 
out_çž
;

2734 ià(
sbi
->
ÝtiÚs
.
isvçt
) {

2735 
sbi
->
Æs_io
 = 
	`lßd_Æs
(sbi->
ÝtiÚs
.
ioch¬£t
);

2736 ià(!
sbi
->
Æs_io
) {

2737 
	`çt_msg
(
sb
, 
KERN_ERR
, "IO charset %s‚ot found",

2738 
sbi
->
ÝtiÚs
.
ioch¬£t
);

2739 
out_çž
;

2743 
”rÜ
 = -
ENOMEM
;

2744 
çt_šode
 = 
	`Ãw_šode
(
sb
);

2745 ià(!
çt_šode
)

2746 
out_çž
;

2747 
	`MSDOS_I
(
çt_šode
)->
i_pos
 = 0;

2748 
sbi
->
çt_šode
 = fat_inode;

2750 
fsšfo_šode
 = 
	`Ãw_šode
(
sb
);

2751 ià(!
fsšfo_šode
)

2752 
out_çž
;

2753 
fsšfo_šode
->
i_šo
 = 
MSDOS_FSINFO_INO
;

2754 
sbi
->
fsšfo_šode
 = fsinfo_inode;

2755 
	`š£¹_šode_hash
(
fsšfo_šode
);

2757 
roÙ_šode
 = 
	`Ãw_šode
(
sb
);

2758 ià(!
roÙ_šode
)

2759 
out_çž
;

2760 
roÙ_šode
->
i_šo
 = 
MSDOS_ROOT_INO
;

2761 
roÙ_šode
->
i_v”siÚ
 = 1;

2762 
”rÜ
 = 
	`çt_»ad_roÙ
(
roÙ_šode
);

2763 ià(
”rÜ
 < 0) {

2764 
	`ut
(
roÙ_šode
);

2765 
out_çž
;

2767 
”rÜ
 = -
ENOMEM
;

2768 
	`š£¹_šode_hash
(
roÙ_šode
);

2769 
	`çt_©ch
(
roÙ_šode
, 0);

2770 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
roÙ_šode
);

2771 ià(!
sb
->
s_roÙ
) {

2772 
	`çt_msg
(
sb
, 
KERN_ERR
, "get„oot inode failed");

2773 
out_çž
;

2776 ià(
sbi
->
ÝtiÚs
.
disÿrd
) {

2777 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
sb
->
s_bdev
);

2778 ià(!
	`blk_queue_disÿrd
(
q
))

2779 
	`çt_msg
(
sb
, 
KERN_WARNING
,

2784 
	`çt_£t_¡©e
(
sb
, 1, 0);

2786 
sbi
->
couÁ
 = 0;

2787 
sbi
->
time
 = 0;

2788 
sbi
->
i_šo
 = -1;

2789 
sbi
->
fže_Çme
 = 
NULL
;

2797 
out_šv®id
:

2798 
”rÜ
 = -
EINVAL
;

2799 ià(!
sž’t
)

2800 
	`çt_msg
(
sb
, 
KERN_INFO
, "Can't find‡ valid FAT filesystem");

2802 
out_çž
:

2803 ià(
fsšfo_šode
)

2804 
	`ut
(
fsšfo_šode
);

2805 ià(
çt_šode
)

2806 
	`ut
(
çt_šode
);

2807 
	`uÆßd_Æs
(
sbi
->
Æs_io
);

2808 
	`uÆßd_Æs
(
sbi
->
Æs_disk
);

2809 ià(
sbi
->
ÝtiÚs
.
ioch¬£t
 !ð
çt_deçuÉ_ioch¬£t
)

2810 
	`kä“
(
sbi
->
ÝtiÚs
.
ioch¬£t
);

2811 
sb
->
s_fs_šfo
 = 
NULL
;

2812 
	`kä“
(
sbi
);

2813  
”rÜ
;

2814 
	}
}

2816 
EXPORT_SYMBOL_GPL
(
çt_fžl_su³r
);

2824 
	$wr™eback_šode
(
šode
 *inode)

2827 
»t
;

2833 
»t
 = 
	`sync_šode_m‘ad©a
(
šode
, 0);

2834 ià(!
»t
)

2835 
»t
 = 
	`fžem­_fd©awr™e
(
šode
->
i_m­pšg
);

2836  
»t
;

2837 
	}
}

2847 
	$çt_æush_šodes
(
su³r_block
 *
sb
, 
šode
 *
i1
, šod*
i2
)

2849 
»t
 = 0;

2850 ià(!
	`MSDOS_SB
(
sb
)->
ÝtiÚs
.
æush
)

2852 ià(
i1
)

2853 
»t
 = 
	`wr™eback_šode
(
i1
);

2854 ià(!
»t
 && 
i2
)

2855 
»t
 = 
	`wr™eback_šode
(
i2
);

2856 ià(!
»t
) {

2857 
add»ss_¥aû
 *
m­pšg
 = 
sb
->
s_bdev
->
bd_šode
->
i_m­pšg
;

2858 
»t
 = 
	`fžem­_æush
(
m­pšg
);

2860  
»t
;

2861 
	}
}

2862 
EXPORT_SYMBOL_GPL
(
çt_æush_šodes
);

2864 
__š™
 
	$š™_çt_fs
()

2866 
”r
;

2868 
”r
 = 
	`çt_ÿche_š™
();

2869 ià(
”r
)

2870  
”r
;

2872 
”r
 = 
	`çt_š™_šodeÿche
();

2873 ià(
”r
)

2874 
çžed
;

2878 
çžed
:

2879 
	`çt_ÿche_de¡roy
();

2880  
”r
;

2881 
	}
}

2883 
__ex™
 
	$ex™_çt_fs
()

2885 
	`çt_ÿche_de¡roy
();

2886 
	`çt_de¡roy_šodeÿche
();

2887 
	}
}

2889 
	$moduË_š™
(
š™_çt_fs
)

2890 
	$moduË_ex™
(
ex™_çt_fs
)

2892 
	`MODULE_LICENSE
("GPL");

	@misc.c

9 
	~<lšux/moduË.h
>

10 
	~<lšux/fs.h
>

11 
	~<lšux/bufãr_h—d.h
>

12 
	~<lšux/time.h
>

13 
	~"çt.h
"

23 
	$__çt_fs_”rÜ
(
su³r_block
 *
sb
, 
»pÜt
, cÚ¡ *
fmt
, ...)

25 
çt_mouÁ_ÝtiÚs
 *
Ýts
 = &
	`MSDOS_SB
(
sb
)->
ÝtiÚs
;

26 
va_li¡
 
¬gs
;

27 
va_fÜm©
 
vaf
;

29 ià(
»pÜt
) {

30 
	`va_¡¬t
(
¬gs
, 
fmt
);

31 
vaf
.
fmt
 = fmt;

32 
vaf
.
va
 = &
¬gs
;

33 
	`´štk
(
KERN_ERR
 "FAT-f (%s):ƒ¼Ü, %pV\n", 
sb
->
s_id
, &
vaf
);

34 
	`va_’d
(
¬gs
);

37 ià(
Ýts
->
”rÜs
 =ð
FAT_ERRORS_PANIC
)

38 
	`·nic
("FAT-f (%s): f ·niøäom…»viou ”rÜ\n", 
sb
->
s_id
);

39 ià(
Ýts
->
”rÜs
 =ð
FAT_ERRORS_RO
 && !(
sb
->
s_æags
 & 
MS_RDONLY
)) {

40 
sb
->
s_æags
 |ð
MS_RDONLY
;

41 
	`´štk
(
KERN_ERR
 "FAT-fs (%s): Filesystem has been "

42 "£ˆ»ad-Úly\n", 
sb
->
s_id
);

44 
	}
}

45 
EXPORT_SYMBOL_GPL
(
__çt_fs_”rÜ
);

51 
	$çt_msg
(
su³r_block
 *
sb
, cÚ¡ *
Ëv–
, cÚ¡ *
fmt
, ...)

53 
va_fÜm©
 
vaf
;

54 
va_li¡
 
¬gs
;

56 
	`va_¡¬t
(
¬gs
, 
fmt
);

57 
vaf
.
fmt
 = fmt;

58 
vaf
.
va
 = &
¬gs
;

59 
	`´štk
("%sFAT-f (%s): %pV\n", 
Ëv–
, 
sb
->
s_id
, &
vaf
);

60 
	`va_’d
(
¬gs
);

61 
	}
}

65 
	$çt_þu¡”s_æush
(
su³r_block
 *
sb
)

67 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

68 
bufãr_h—d
 *
bh
;

69 
çt_boÙ_fsšfo
 *
fsšfo
;

71 ià(
sbi
->
çt_b™s
 != 32)

74 
bh
 = 
	`sb_b»ad
(
sb
, 
sbi
->
fsšfo_£ùÜ
);

75 ià(
bh
 =ð
NULL
) {

76 
	`çt_msg
(
sb
, 
KERN_ERR
, "bread failed in fat_clusters_flush");

77  -
EIO
;

80 
fsšfo
 = (
çt_boÙ_fsšfo
 *)
bh
->
b_d©a
;

82 ià(!
	`IS_FSINFO
(
fsšfo
)) {

83 
	`çt_msg
(
sb
, 
KERN_ERR
, "Invalid FSINFO signature: "

85 
	`Ë32_to_ýu
(
fsšfo
->
sigÇtu»1
),

86 
	`Ë32_to_ýu
(
fsšfo
->
sigÇtu»2
),

87 
sbi
->
fsšfo_£ùÜ
);

89 ià(
sbi
->
ä“_þu¡”s
 != -1)

90 
fsšfo
->
ä“_þu¡”s
 = 
	`ýu_to_Ë32
(
sbi
->free_clusters);

91 ià(
sbi
->
´ev_ä“
 != -1)

92 
fsšfo
->
Ãxt_þu¡”
 = 
	`ýu_to_Ë32
(
sbi
->
´ev_ä“
);

93 
	`m¬k_bufãr_dœty
(
bh
);

95 
	`b»l£
(
bh
);

98 
	}
}

104 
	$çt_chaš_add
(
šode
 *šode, 
Ãw_dþus
, 
Ä_þu¡”
)

106 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

107 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

108 
»t
, 
Ãw_fþus
, 
Ï¡
;

114 
Ï¡
 = 
Ãw_fþus
 = 0;

115 ià(
	`MSDOS_I
(
šode
)->
i_¡¬t
) {

116 
fþus
, 
dþus
;

118 
»t
 = 
	`çt_g‘_þu¡”
(
šode
, 
FAT_ENT_EOF
, &
fþus
, &
dþus
);

119 ià(
»t
 < 0)

120  
»t
;

121 
Ãw_fþus
 = 
fþus
 + 1;

122 
Ï¡
 = 
dþus
;

126 ià(
Ï¡
) {

127 
çt_’Œy
 
ç‹Á
;

129 
	`ç‹Á_š™
(&
ç‹Á
);

130 
»t
 = 
	`çt_’t_»ad
(
šode
, &
ç‹Á
, 
Ï¡
);

131 ià(
»t
 >= 0) {

132 
wa™
 = 
	`šode_Ãeds_sync
(
šode
);

133 
»t
 = 
	`çt_’t_wr™e
(
šode
, &
ç‹Á
, 
Ãw_dþus
, 
wa™
);

134 
	`ç‹Á_b»l£
(&
ç‹Á
);

136 ià(
»t
 < 0)

137  
»t
;

144 
	`MSDOS_I
(
šode
)->
i_¡¬t
 = 
Ãw_dþus
;

145 
	`MSDOS_I
(
šode
)->
i_log¡¬t
 = 
Ãw_dþus
;

150 ià(
	`S_ISDIR
(
šode
->
i_mode
è&& 
	`IS_DIRSYNC
(inode)) {

151 
»t
 = 
	`çt_sync_šode
(
šode
);

152 ià(
»t
)

153  
»t
;

155 
	`m¬k_šode_dœty
(
šode
);

157 ià(
Ãw_fþus
 !ð(
šode
->
i_blocks
 >> (
sbi
->
þu¡”_b™s
 - 9))) {

158 
	`çt_fs_”rÜ
(
sb
, "clusters badly computed (%d != %llu)",

159 
Ãw_fþus
,

160 (
Îu
)(
šode
->
i_blocks
 >> (
sbi
->
þu¡”_b™s
 - 9)));

161 
	`çt_ÿche_šv®_šode
(
šode
);

163 
šode
->
i_blocks
 +ð
Ä_þu¡”
 << (
sbi
->
þu¡”_b™s
 - 9);

166 
	}
}

168 
timezÚe
 
sys_tz
;

180 
	#SECS_PER_MIN
 60

	)

181 
	#SECS_PER_HOUR
 (60 * 60)

	)

182 
	#SECS_PER_DAY
 (
SECS_PER_HOUR
 * 24)

	)

184 
	#DAYS_DELTA
 (365 * 10 + 2)

	)

186 
	#YEAR_2100
 120

	)

187 
	#IS_LEAP_YEAR
(
y
è(!((yè& 3è&& (yè!ð
YEAR_2100
)

	)

190 
time_t
 
	gdays_š_y—r
[] = {

197 
	$çt_time_çt2unix
(
msdos_sb_šfo
 *
sbi
, 
time¥ec
 *
ts
,

198 
__Ë16
 
__time
, __Ë16 
__d©e
, 
u8
 
time_cs
)

200 
u16
 
time
 = 
	`Ë16_to_ýu
(
__time
), 
d©e
 =†e16_to_ýu(
__d©e
);

201 
time_t
 
£cÚd
, 
day
, 
Ë­_day
, 
mÚth
, 
y—r
;

204 
y—r
 = 
d©e
 >> 9;

205 
mÚth
 = 
	`max
(1, (
d©e
 >> 5) & 0xf);

206 
day
 = 
	`max
(1, 
d©e
 & 0x1f) - 1;

208 
Ë­_day
 = (
y—r
 + 3) / 4;

209 ià(
y—r
 > 
YEAR_2100
)

210 
Ë­_day
--;

211 ià(
	`IS_LEAP_YEAR
(
y—r
è&& 
mÚth
 > 2)

212 
Ë­_day
++;

214 
£cÚd
 = (
time
 & 0x1f) << 1;

215 
£cÚd
 +ð((
time
 >> 5è& 0x3fè* 
SECS_PER_MIN
;

216 
£cÚd
 +ð(
time
 >> 11è* 
SECS_PER_HOUR
;

217 
£cÚd
 +ð(
y—r
 * 365 + 
Ë­_day


218 + 
days_š_y—r
[
mÚth
] + 
day


219 + 
DAYS_DELTA
è* 
SECS_PER_DAY
;

221 ià(!
sbi
->
ÝtiÚs
.
tz_£t
)

222 
£cÚd
 +ð
sys_tz
.
tz_mšu‹swe¡
 * 
SECS_PER_MIN
;

224 
£cÚd
 -ð
sbi
->
ÝtiÚs
.
time_off£t
 * 
SECS_PER_MIN
;

226 ià(
time_cs
) {

227 
ts
->
tv_£c
 = 
£cÚd
 + (
time_cs
 / 100);

228 
ts
->
tv_n£c
 = (
time_cs
 % 100) * 10000000;

237 
ts
->
tv_£c
 = 
£cÚd
;

238 
ts
->
tv_n£c
 = 0;

247 
	}
}

250 
	$çt_time_unix2çt
(
msdos_sb_šfo
 *
sbi
, 
time¥ec
 *
ts
,

251 
__Ë16
 *
time
, __Ë16 *
d©e
, 
u8
 *
time_cs
)

253 
tm
m;

254 
	`time_to_tm
(
ts
->
tv_£c
,

255 (
sbi
->
ÝtiÚs
.
tz_£t
 ? sbi->ÝtiÚs.
time_off£t
 :

256 -
sys_tz
.
tz_mšu‹swe¡
è* 
SECS_PER_MIN
, &
tm
);

259 ià(
tm
.
tm_y—r
 < 1980 - 1900) {

260 *
time
 = 0;

261 *
d©e
 = 
	`ýu_to_Ë16
((0 << 9) | (1 << 5) | 1);

262 ià(
time_cs
)

263 *
time_cs
 = 0;

266 ià(
tm
.
tm_y—r
 > 2107 - 1900) {

267 *
time
 = 
	`ýu_to_Ë16
((23 << 11) | (59 << 5) | 29);

268 *
d©e
 = 
	`ýu_to_Ë16
((127 << 9) | (12 << 5) | 31);

269 ià(
time_cs
)

270 *
time_cs
 = 199;

275 
tm
.
tm_y—r
 -= 80;

277 
tm
.
tm_mÚ
++;

279 
tm
.
tm_£c
 >>= 1;

281 *
time
 = 
	`ýu_to_Ë16
(
tm
.
tm_hour
 << 11 |m.
tm_mš
 << 5 |m.
tm_£c
);

282 *
d©e
 = 
	`ýu_to_Ë16
(
tm
.
tm_y—r
 << 9 |m.
tm_mÚ
 << 5 |m.
tm_mday
);

283 ià(
time_cs
)

285 *
time_cs
 = (
ts
->
tv_£c
 & 1è* 100 +s->
tv_n£c
 / 10000000;

291 
	}
}

292 
EXPORT_SYMBOL_GPL
(
çt_time_unix2çt
);

294 
	$çt_sync_bhs
(
bufãr_h—d
 **
bhs
, 
Ä_bhs
)

296 
i
, 
”r
 = 0;

298 
i
 = 0; i < 
Ä_bhs
; i++)

299 
	`wr™e_dœty_bufãr
(
bhs
[
i
], 
WRITE
);

301 
i
 = 0; i < 
Ä_bhs
; i++) {

302 
	`wa™_Ú_bufãr
(
bhs
[
i
]);

303 ià(!
”r
 && !
	`bufãr_u±od©e
(
bhs
[
i
]))

304 
”r
 = -
EIO
;

306  
”r
;

307 
	}
}

	@namei_msdos.c

9 
	~<lšux/moduË.h
>

10 
	~<lšux/time.h
>

11 
	~<lšux/bufãr_h—d.h
>

12 
	~"çt.h
"

15 
	gbad_ch¬s
[] = "*?<>|\"";

16 
	gbad_if_¡riù
[] = "+=,; ";

19 
	$msdos_fÜm©_Çme
(cÚ¡ *
Çme
, 
Ën
,

20 *
»s
, 
çt_mouÁ_ÝtiÚs
 *
Ýts
)

28 *
w®k
;

29 
c
;

30 
¥aû
;

32 ià(
Çme
[0] == '.') {

33 ià(
Ýts
->
dÙsOK
) {

35 
Çme
++;

36 
Ën
--;

38  -
EINVAL
;

43 
¥aû
 = 1;

44 
c
 = 0;

45 
w®k
 = 
»s
; 
Ën
 && walk -„es < 8; walk++) {

46 
c
 = *
Çme
++;

47 
Ën
--;

48 ià(
Ýts
->
Çme_check
 !ð'r' && 
	`¡rchr
(
bad_ch¬s
, 
c
))

49  -
EINVAL
;

50 ià(
Ýts
->
Çme_check
 =ð's' && 
	`¡rchr
(
bad_if_¡riù
, 
c
))

51  -
EINVAL
;

52 ià(
c
 >ð'A' && c <ð'Z' && 
Ýts
->
Çme_check
 == 's')

53  -
EINVAL
;

54 ià(
c
 < ' ' || c == ':' || c == '\\')

55  -
EINVAL
;

64 ià((
»s
 =ð
w®k
è&& (
c
 == 0xE5))

65 
c
 = 0x05;

66 ià(
c
 == '.')

68 
¥aû
 = (
c
 == ' ');

69 *
w®k
 = (!
Ýts
->
noÿ£
 && 
c
 >= 'a' && c <= 'z') ? c - 32 : c;

71 ià(
¥aû
)

72  -
EINVAL
;

73 ià(
Ýts
->
Çme_check
 =ð's' && 
Ën
 && 
c
 != '.') {

74 
c
 = *
Çme
++;

75 
Ën
--;

76 ià(
c
 != '.')

77  -
EINVAL
;

79 
c
 !ð'.' && 
Ën
--)

80 
c
 = *
Çme
++;

81 ià(
c
 == '.') {

82 
w®k
 - 
»s
 < 8)

83 *
w®k
++ = ' ';

84 
Ën
 > 0 && 
w®k
 - 
»s
 < 
MSDOS_NAME
) {

85 
c
 = *
Çme
++;

86 
Ën
--;

87 ià(
Ýts
->
Çme_check
 !ð'r' && 
	`¡rchr
(
bad_ch¬s
, 
c
))

88  -
EINVAL
;

89 ià(
Ýts
->
Çme_check
 == 's' &&

90 
	`¡rchr
(
bad_if_¡riù
, 
c
))

91  -
EINVAL
;

92 ià(
c
 < ' ' || c == ':' || c == '\\')

93  -
EINVAL
;

94 ià(
c
 == '.') {

95 ià(
Ýts
->
Çme_check
 == 's')

96  -
EINVAL
;

99 ià(
c
 >ð'A' && c <ð'Z' && 
Ýts
->
Çme_check
 == 's')

100  -
EINVAL
;

101 
¥aû
 = 
c
 == ' ';

102 ià(!
Ýts
->
noÿ£
 && 
c
 >= 'a' && c <= 'z')

103 *
w®k
++ = 
c
 - 32;

105 *
w®k
++ = 
c
;

107 ià(
¥aû
)

108  -
EINVAL
;

109 ià(
Ýts
->
Çme_check
 =ð's' && 
Ën
)

110  -
EINVAL
;

112 
w®k
 - 
»s
 < 
MSDOS_NAME
)

113 *
w®k
++ = ' ';

116 
	}
}

119 
	$msdos_fšd
(
šode
 *
dœ
, cÚ¡ *
Çme
, 
Ën
,

120 
çt_¦Ù_šfo
 *
sšfo
)

122 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
dœ
->
i_sb
);

123 
msdos_Çme
[
MSDOS_NAME
];

124 
”r
;

126 
”r
 = 
	`msdos_fÜm©_Çme
(
Çme
, 
Ën
, 
msdos_Çme
, &
sbi
->
ÝtiÚs
);

127 ià(
”r
)

128  -
ENOENT
;

130 
”r
 = 
	`çt_sÿn
(
dœ
, 
msdos_Çme
, 
sšfo
);

131 ià(!
”r
 && 
sbi
->
ÝtiÚs
.
dÙsOK
) {

132 ià(
Çme
[0] == '.') {

133 ià(!(
sšfo
->
de
->
©Œ
 & 
ATTR_HIDDEN
))

134 
”r
 = -
ENOENT
;

136 ià(
sšfo
->
de
->
©Œ
 & 
ATTR_HIDDEN
)

137 
”r
 = -
ENOENT
;

139 ià(
”r
)

140 
	`b»l£
(
sšfo
->
bh
);

142  
”r
;

143 
	}
}

151 
	$msdos_hash
(cÚ¡ 
d’Œy
 *d’Œy, cÚ¡ 
šode
 *inode,

152 
q¡r
 *qstr)

154 
çt_mouÁ_ÝtiÚs
 *
ÝtiÚs
 = &
	`MSDOS_SB
(
d’Œy
->
d_sb
)->options;

155 
msdos_Çme
[
MSDOS_NAME
];

156 
”rÜ
;

158 
”rÜ
 = 
	`msdos_fÜm©_Çme
(
q¡r
->
Çme
, q¡r->
Ën
, 
msdos_Çme
, 
ÝtiÚs
);

159 ià(!
”rÜ
)

160 
q¡r
->
hash
 = 
	`fuÎ_Çme_hash
(
msdos_Çme
, 
MSDOS_NAME
);

162 
	}
}

168 
	$msdos_cmp
(cÚ¡ 
d’Œy
 *
·»Á
, cÚ¡ 
šode
 *
pšode
,

169 cÚ¡ 
d’Œy
 *d’Œy, cÚ¡ 
šode
 *inode,

170 
Ën
, cÚ¡ *
¡r
, cÚ¡ 
q¡r
 *
Çme
)

172 
çt_mouÁ_ÝtiÚs
 *
ÝtiÚs
 = &
	`MSDOS_SB
(
·»Á
->
d_sb
)->options;

173 
a_msdos_Çme
[
MSDOS_NAME
], 
b_msdos_Çme
[MSDOS_NAME];

174 
”rÜ
;

176 
”rÜ
 = 
	`msdos_fÜm©_Çme
(
Çme
->Çme,‚ame->
Ën
, 
a_msdos_Çme
, 
ÝtiÚs
);

177 ià(
”rÜ
)

178 
Þd_com·»
;

179 
”rÜ
 = 
	`msdos_fÜm©_Çme
(
¡r
, 
Ën
, 
b_msdos_Çme
, 
ÝtiÚs
);

180 ià(
”rÜ
)

181 
Þd_com·»
;

182 
”rÜ
 = 
	`memcmp
(
a_msdos_Çme
, 
b_msdos_Çme
, 
MSDOS_NAME
);

183 
out
:

184  
”rÜ
;

186 
Þd_com·»
:

187 
”rÜ
 = 1;

188 ià(
Çme
->
Ën
 ==†en)

189 
”rÜ
 = 
	`memcmp
(
Çme
->Çme, 
¡r
, 
Ën
);

190 
out
;

191 
	}
}

193 cÚ¡ 
d’Œy_Ý”©iÚs
 
	gmsdos_d’Œy_Ý”©iÚs
 = {

194 .
d_hash
 = 
msdos_hash
,

195 .
	gd_com·»
 = 
msdos_cmp
,

203 
d’Œy
 *
	$msdos_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry,

204 
æags
)

206 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

207 
çt_¦Ù_šfo
 
sšfo
;

208 
šode
 *inode;

209 
”r
;

211 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

212 
”r
 = 
	`msdos_fšd
(
dœ
, 
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
, &
sšfo
);

213 
”r
) {

214 -
ENOENT
:

215 
šode
 = 
NULL
;

218 
šode
 = 
	`çt_bužd_šode
(
sb
, 
sšfo
.
de
, sšfo.
i_pos
);

219 
	`b»l£
(
sšfo
.
bh
);

222 
šode
 = 
	`ERR_PTR
(
”r
);

224 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

225  
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

226 
	}
}

229 
	$msdos_add_’Œy
(
šode
 *
dœ
, cÚ¡ *
Çme
,

230 
is_dœ
, 
is_hid
, 
þu¡”
,

231 
time¥ec
 *
ts
, 
çt_¦Ù_šfo
 *
sšfo
)

233 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
dœ
->
i_sb
);

234 
msdos_dœ_’Œy
 
de
;

235 
__Ë16
 
time
, 
d©e
;

236 
”r
;

238 
	`memýy
(
de
.
Çme
,‚ame, 
MSDOS_NAME
);

239 
de
.
©Œ
 = 
is_dœ
 ? 
ATTR_DIR
 : 
ATTR_ARCH
;

240 ià(
is_hid
)

241 
de
.
©Œ
 |ð
ATTR_HIDDEN
;

242 
de
.
lÿ£
 = 0;

243 
	`çt_time_unix2çt
(
sbi
, 
ts
, &
time
, &
d©e
, 
NULL
);

244 
de
.
cd©e
 = de.
ad©e
 = 0;

245 
de
.
ùime
 = 0;

246 
de
.
ùime_cs
 = 0;

247 
de
.
time
 =ime;

248 
de
.
d©e
 = date;

249 
	`çt_£t_¡¬t
(&
de
, 
þu¡”
);

250 
de
.
size
 = 0;

252 
”r
 = 
	`çt_add_’Œ›s
(
dœ
, &
de
, 1, 
sšfo
);

253 ià(
”r
)

254  
”r
;

256 
dœ
->
i_ùime
 = dœ->
i_mtime
 = *
ts
;

257 ià(
	`IS_DIRSYNC
(
dœ
))

258 ()
	`çt_sync_šode
(
dœ
);

260 
	`m¬k_šode_dœty
(
dœ
);

263 
	}
}

266 
	$msdos_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
,

267 
boÞ
 
exþ
)

269 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

270 
šode
 *šodð
NULL
;

271 
çt_¦Ù_šfo
 
sšfo
;

272 
time¥ec
 
ts
;

273 
msdos_Çme
[
MSDOS_NAME
];

274 
”r
, 
is_hid
;

276 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

278 
”r
 = 
	`msdos_fÜm©_Çme
(
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
,

279 
msdos_Çme
, &
	`MSDOS_SB
(
sb
)->
ÝtiÚs
);

280 ià(
”r
)

281 
out
;

282 
is_hid
 = (
d’Œy
->
d_Çme
.
Çme
[0] =ð'.'è&& (
msdos_Çme
[0] != '.');

284 ià(!
	`çt_sÿn
(
dœ
, 
msdos_Çme
, &
sšfo
)) {

285 
	`b»l£
(
sšfo
.
bh
);

286 
”r
 = -
EINVAL
;

287 
out
;

290 
ts
 = 
CURRENT_TIME_SEC
;

292 
”r
 = 
	`msdos_add_’Œy
(
dœ
, 
msdos_Çme
, 0, 
is_hid
, 0, &
ts
, &
sšfo
);

293 ià(
”r
)

294 
out
;

295 
šode
 = 
	`çt_bužd_šode
(
sb
, 
sšfo
.
de
, sšfo.
i_pos
);

296 
	`b»l£
(
sšfo
.
bh
);

297 ià(
	`IS_ERR
(
šode
)) {

298 
”r
 = 
	`PTR_ERR
(
šode
);

299 
out
;

301 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
ts
;

304 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

305 
out
:

306 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

307 ià(!
”r
)

308 
”r
 = 
	`çt_æush_šodes
(
sb
, 
dœ
, 
šode
);

309  
”r
;

310 
	}
}

313 
	$msdos_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

315 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

316 
šode
 *šodð
d’Œy
->
d_šode
;

317 
çt_¦Ù_šfo
 
sšfo
;

318 
”r
;

320 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

325 
”r
 = 
	`çt_dœ_em±y
(
šode
);

326 ià(
”r
)

327 
out
;

328 
”r
 = 
	`msdos_fšd
(
dœ
, 
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
, &
sšfo
);

329 ià(
”r
)

330 
out
;

332 
	`´štk
Ð
KERN_ALERT
 "[cheon] msdos_rmdir \n" );

333 
”r
 = 
	`çt_»move_’Œ›s
(
dœ
, &
sšfo
);

334 ià(
”r
)

335 
out
;

336 
	`drÝ_Æšk
(
dœ
);

338 
	`þ—r_Æšk
(
šode
);

339 
šode
->
i_ùime
 = 
CURRENT_TIME_SEC
;

341 
	`çt_d‘ach
(
šode
);

342 
out
:

343 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

344 ià(!
”r
)

345 
”r
 = 
	`çt_æush_šodes
(
sb
, 
dœ
, 
šode
);

347  
”r
;

348 
	}
}

351 
	$msdos_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

353 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

354 
çt_¦Ù_šfo
 
sšfo
;

355 
šode
 *inode;

356 
msdos_Çme
[
MSDOS_NAME
];

357 
time¥ec
 
ts
;

358 
”r
, 
is_hid
, 
þu¡”
;

360 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

362 
”r
 = 
	`msdos_fÜm©_Çme
(
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
,

363 
msdos_Çme
, &
	`MSDOS_SB
(
sb
)->
ÝtiÚs
);

364 ià(
”r
)

365 
out
;

366 
is_hid
 = (
d’Œy
->
d_Çme
.
Çme
[0] =ð'.'è&& (
msdos_Çme
[0] != '.');

368 ià(!
	`çt_sÿn
(
dœ
, 
msdos_Çme
, &
sšfo
)) {

369 
	`b»l£
(
sšfo
.
bh
);

370 
”r
 = -
EINVAL
;

371 
out
;

375 
ts
 = 
CURRENT_TIME_SEC
;

376 
þu¡”
 = 
	`çt_®loc_Ãw_dœ
(
dœ
, &
ts
);

377 ià(
þu¡”
 < 0) {

378 
”r
 = 
þu¡”
;

379 
out
;

381 
”r
 = 
	`msdos_add_’Œy
(
dœ
, 
msdos_Çme
, 1, 
is_hid
, 
þu¡”
, &
ts
, &
sšfo
);

382 ià(
”r
)

383 
out_ä“
;

384 
	`šc_Æšk
(
dœ
);

386 
šode
 = 
	`çt_bužd_šode
(
sb
, 
sšfo
.
de
, sšfo.
i_pos
);

387 
	`b»l£
(
sšfo
.
bh
);

388 ià(
	`IS_ERR
(
šode
)) {

389 
”r
 = 
	`PTR_ERR
(
šode
);

391 
out
;

393 
	`£t_Æšk
(
šode
, 2);

394 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
ts
;

397 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

399 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

400 
	`çt_æush_šodes
(
sb
, 
dœ
, 
šode
);

403 
out_ä“
:

404 
	`´štk
Ð
KERN_ALERT
 "[cheon] msdos_mkdir, fat_free_clusters \n" );

405 
	`çt_ä“_þu¡”s
(
dœ
, 
þu¡”
);

406 
out
:

407 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

408  
”r
;

409 
	}
}

412 
	$msdos_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

414 
šode
 *šodð
d’Œy
->
d_šode
;

415 
su³r_block
 *
sb
 = 
šode
->
i_sb
;

416 
çt_¦Ù_šfo
 
sšfo
;

417 
”r
;

419 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

420 
”r
 = 
	`msdos_fšd
(
dœ
, 
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
, &
sšfo
);

421 ià(
”r
)

422 
out
;

424 
	`´štk
Ð
KERN_ALERT
 "[cheon] msdos_unlink \n" );

425 
”r
 = 
	`çt_»move_’Œ›s
(
dœ
, &
sšfo
);

426 ià(
”r
)

427 
out
;

428 
	`þ—r_Æšk
(
šode
);

430 
šode
->
i_ùime
 = 
CURRENT_TIME_SEC
;

431 
	`çt_d‘ach
(
šode
);

432 
out
:

433 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

434 ià(!
”r
)

435 
”r
 = 
	`çt_æush_šodes
(
sb
, 
dœ
, 
šode
);

437  
”r
;

438 
	}
}

440 
	$do_msdos_»Çme
(
šode
 *
Þd_dœ
, *
Þd_Çme
,

441 
d’Œy
 *
Þd_d’Œy
,

442 
šode
 *
Ãw_dœ
, *
Ãw_Çme
,

443 
d’Œy
 *
Ãw_d’Œy
, 
is_hid
)

445 
bufãr_h—d
 *
dÙdÙ_bh
;

446 
msdos_dœ_’Œy
 *
dÙdÙ_de
;

447 
šode
 *
Þd_šode
, *
Ãw_šode
;

448 
çt_¦Ù_šfo
 
Þd_sšfo
, 
sšfo
;

449 
time¥ec
 
ts
;

450 
loff_t
 
Ãw_i_pos
;

451 
”r
, 
Þd_©Œs
, 
is_dœ
, 
upd©e_dÙdÙ
, 
cÜru±
 = 0;

453 
Þd_sšfo
.
bh
 = 
sšfo
.bh = 
dÙdÙ_bh
 = 
NULL
;

454 
Þd_šode
 = 
Þd_d’Œy
->
d_šode
;

455 
Ãw_šode
 = 
Ãw_d’Œy
->
d_šode
;

457 
”r
 = 
	`çt_sÿn
(
Þd_dœ
, 
Þd_Çme
, &
Þd_sšfo
);

458 ià(
”r
) {

459 
”r
 = -
EIO
;

460 
out
;

463 
is_dœ
 = 
	`S_ISDIR
(
Þd_šode
->
i_mode
);

464 
upd©e_dÙdÙ
 = (
is_dœ
 && 
Þd_dœ
 !ð
Ãw_dœ
);

465 ià(
upd©e_dÙdÙ
) {

466 ià(
	`çt_g‘_dÙdÙ_’Œy
(
Þd_šode
, &
dÙdÙ_bh
, &
dÙdÙ_de
)) {

467 
”r
 = -
EIO
;

468 
out
;

472 
Þd_©Œs
 = 
	`MSDOS_I
(
Þd_šode
)->
i_©Œs
;

473 
”r
 = 
	`çt_sÿn
(
Ãw_dœ
, 
Ãw_Çme
, &
sšfo
);

474 ià(!
”r
) {

475 ià(!
Ãw_šode
) {

477 ià(
sšfo
.
de
 !ð
Þd_sšfo
.de) {

478 
”r
 = -
EINVAL
;

479 
out
;

481 ià(
is_hid
)

482 
	`MSDOS_I
(
Þd_šode
)->
i_©Œs
 |ð
ATTR_HIDDEN
;

484 
	`MSDOS_I
(
Þd_šode
)->
i_©Œs
 &ð~
ATTR_HIDDEN
;

485 ià(
	`IS_DIRSYNC
(
Þd_dœ
)) {

486 
”r
 = 
	`çt_sync_šode
(
Þd_šode
);

487 ià(
”r
) {

488 
	`MSDOS_I
(
Þd_šode
)->
i_©Œs
 = 
Þd_©Œs
;

489 
out
;

492 
	`m¬k_šode_dœty
(
Þd_šode
);

494 
Þd_dœ
->
i_v”siÚ
++;

496 
Þd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 = 
CURRENT_TIME_SEC
;

497 ià(
	`IS_DIRSYNC
(
Þd_dœ
))

498 ()
	`çt_sync_šode
(
Þd_dœ
);

500 
	`m¬k_šode_dœty
(
Þd_dœ
);

501 
out
;

505 
ts
 = 
CURRENT_TIME_SEC
;

507 ià(
Ãw_šode
) {

508 ià(
”r
)

509 
out
;

510 ià(
is_dœ
) {

511 
”r
 = 
	`çt_dœ_em±y
(
Ãw_šode
);

512 ià(
”r
)

513 
out
;

515 
Ãw_i_pos
 = 
	`MSDOS_I
(
Ãw_šode
)->
i_pos
;

516 
	`çt_d‘ach
(
Ãw_šode
);

518 
”r
 = 
	`msdos_add_’Œy
(
Ãw_dœ
, 
Ãw_Çme
, 
is_dœ
, 
is_hid
, 0,

519 &
ts
, &
sšfo
);

520 ià(
”r
)

521 
out
;

522 
Ãw_i_pos
 = 
sšfo
.
i_pos
;

524 
Ãw_dœ
->
i_v”siÚ
++;

526 
	`çt_d‘ach
(
Þd_šode
);

527 
	`çt_©ch
(
Þd_šode
, 
Ãw_i_pos
);

528 ià(
is_hid
)

529 
	`MSDOS_I
(
Þd_šode
)->
i_©Œs
 |ð
ATTR_HIDDEN
;

531 
	`MSDOS_I
(
Þd_šode
)->
i_©Œs
 &ð~
ATTR_HIDDEN
;

532 ià(
	`IS_DIRSYNC
(
Ãw_dœ
)) {

533 
”r
 = 
	`çt_sync_šode
(
Þd_šode
);

534 ià(
”r
)

535 
”rÜ_šode
;

537 
	`m¬k_šode_dœty
(
Þd_šode
);

539 ià(
upd©e_dÙdÙ
) {

540 
	`çt_£t_¡¬t
(
dÙdÙ_de
, 
	`MSDOS_I
(
Ãw_dœ
)->
i_log¡¬t
);

541 
	`m¬k_bufãr_dœty_šode
(
dÙdÙ_bh
, 
Þd_šode
);

542 ià(
	`IS_DIRSYNC
(
Ãw_dœ
)) {

543 
”r
 = 
	`sync_dœty_bufãr
(
dÙdÙ_bh
);

544 ià(
”r
)

545 
”rÜ_dÙdÙ
;

547 
	`drÝ_Æšk
(
Þd_dœ
);

548 ià(!
Ãw_šode
)

549 
	`šc_Æšk
(
Ãw_dœ
);

552 
	`´štk
Ð
KERN_ALERT
 "[cheon] do_msdos_rename \n");

553 
”r
 = 
	`çt_»move_’Œ›s
(
Þd_dœ
, &
Þd_sšfo
);

554 
Þd_sšfo
.
bh
 = 
NULL
;

555 ià(
”r
)

556 
”rÜ_dÙdÙ
;

557 
Þd_dœ
->
i_v”siÚ
++;

558 
Þd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 = 
ts
;

559 ià(
	`IS_DIRSYNC
(
Þd_dœ
))

560 ()
	`çt_sync_šode
(
Þd_dœ
);

562 
	`m¬k_šode_dœty
(
Þd_dœ
);

564 ià(
Ãw_šode
) {

565 
	`drÝ_Æšk
(
Ãw_šode
);

566 ià(
is_dœ
)

567 
	`drÝ_Æšk
(
Ãw_šode
);

568 
Ãw_šode
->
i_ùime
 = 
ts
;

570 
out
:

571 
	`b»l£
(
sšfo
.
bh
);

572 
	`b»l£
(
dÙdÙ_bh
);

573 
	`b»l£
(
Þd_sšfo
.
bh
);

574  
”r
;

576 
”rÜ_dÙdÙ
:

578 
cÜru±
 = 1;

580 ià(
upd©e_dÙdÙ
) {

581 
	`çt_£t_¡¬t
(
dÙdÙ_de
, 
	`MSDOS_I
(
Þd_dœ
)->
i_log¡¬t
);

582 
	`m¬k_bufãr_dœty_šode
(
dÙdÙ_bh
, 
Þd_šode
);

583 
cÜru±
 |ð
	`sync_dœty_bufãr
(
dÙdÙ_bh
);

585 
”rÜ_šode
:

586 
	`çt_d‘ach
(
Þd_šode
);

587 
	`çt_©ch
(
Þd_šode
, 
Þd_sšfo
.
i_pos
);

588 
	`MSDOS_I
(
Þd_šode
)->
i_©Œs
 = 
Þd_©Œs
;

589 ià(
Ãw_šode
) {

590 
	`çt_©ch
(
Ãw_šode
, 
Ãw_i_pos
);

591 ià(
cÜru±
)

592 
cÜru±
 |ð
	`çt_sync_šode
(
Ãw_šode
);

599 
	`´štk
Ð
KERN_ALERT
 "[cheon] do_msdos_rename,ƒrr_inode \n");

600 
”r2
 = 
	`çt_»move_’Œ›s
(
Ãw_dœ
, &
sšfo
);

601 ià(
cÜru±
)

602 
cÜru±
 |ð
”r2
;

603 
sšfo
.
bh
 = 
NULL
;

605 ià(
cÜru±
 < 0) {

606 
	`çt_fs_”rÜ
(
Ãw_dœ
->
i_sb
,

608 
__func__
, 
sšfo
.
i_pos
);

610 
out
;

611 
	}
}

614 
	$msdos_»Çme
(
šode
 *
Þd_dœ
, 
d’Œy
 *
Þd_d’Œy
,

615 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

617 
su³r_block
 *
sb
 = 
Þd_dœ
->
i_sb
;

618 
Þd_msdos_Çme
[
MSDOS_NAME
], 
Ãw_msdos_Çme
[MSDOS_NAME];

619 
”r
, 
is_hid
;

621 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

623 
”r
 = 
	`msdos_fÜm©_Çme
(
Þd_d’Œy
->
d_Çme
.
Çme
,

624 
Þd_d’Œy
->
d_Çme
.
Ën
, 
Þd_msdos_Çme
,

625 &
	`MSDOS_SB
(
Þd_dœ
->
i_sb
)->
ÝtiÚs
);

626 ià(
”r
)

627 
out
;

628 
”r
 = 
	`msdos_fÜm©_Çme
(
Ãw_d’Œy
->
d_Çme
.
Çme
,

629 
Ãw_d’Œy
->
d_Çme
.
Ën
, 
Ãw_msdos_Çme
,

630 &
	`MSDOS_SB
(
Ãw_dœ
->
i_sb
)->
ÝtiÚs
);

631 ià(
”r
)

632 
out
;

634 
is_hid
 =

635 (
Ãw_d’Œy
->
d_Çme
.
Çme
[0] =ð'.'è&& (
Ãw_msdos_Çme
[0] != '.');

637 
”r
 = 
	`do_msdos_»Çme
(
Þd_dœ
, 
Þd_msdos_Çme
, 
Þd_d’Œy
,

638 
Ãw_dœ
, 
Ãw_msdos_Çme
, 
Ãw_d’Œy
, 
is_hid
);

639 
out
:

640 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

641 ià(!
”r
)

642 
”r
 = 
	`çt_æush_šodes
(
sb
, 
Þd_dœ
, 
Ãw_dœ
);

643  
”r
;

644 
	}
}

646 cÚ¡ 
šode_Ý”©iÚs
 
	gmsdos_dœ_šode_Ý”©iÚs
 = {

647 .
ü—‹
 = 
msdos_ü—‹
,

648 .
	glookup
 = 
msdos_lookup
,

649 .
	guÆšk
 = 
msdos_uÆšk
,

650 .
	gmkdœ
 = 
msdos_mkdœ
,

651 .
	grmdœ
 = 
msdos_rmdœ
,

652 .
	g»Çme
 = 
msdos_»Çme
,

653 .
	g£‰r
 = 
çt_£‰r
,

654 .
	gg‘©Œ
 = 
çt_g‘©Œ
,

657 
	$£tup
(
su³r_block
 *
sb
)

659 
	`MSDOS_SB
(
sb
)->
dœ_Ýs
 = &
msdos_dœ_šode_Ý”©iÚs
;

660 
sb
->
s_d_Ý
 = &
msdos_d’Œy_Ý”©iÚs
;

661 
sb
->
s_æags
 |ð
MS_NOATIME
;

662 
	}
}

664 
	$msdos_fžl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
sž’t
)

666  
	`çt_fžl_su³r
(
sb
, 
d©a
, 
sž’t
, 0, 
£tup
);

667 
	}
}

669 
d’Œy
 *
	$msdos_mouÁ
(
fže_sy¡em_ty³
 *
fs_ty³
,

670 
æags
, cÚ¡ *
dev_Çme
,

671 *
d©a
)

673  
	`mouÁ_bdev
(
fs_ty³
, 
æags
, 
dev_Çme
, 
d©a
, 
msdos_fžl_su³r
);

674 
	}
}

676 
fže_sy¡em_ty³
 
	gmsdos_fs_ty³
 = {

677 .
owÃr
 = 
THIS_MODULE
,

678 .
	gÇme
 = "msdos",

679 .
	gmouÁ
 = 
msdos_mouÁ
,

680 .
	gkžl_sb
 = 
kžl_block_su³r
,

681 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

683 
MODULE_ALIAS_FS
("msdos");

685 
__š™
 
	$š™_msdos_fs
()

687  
	`»gi¡”_fžesy¡em
(&
msdos_fs_ty³
);

688 
	}
}

690 
__ex™
 
	$ex™_msdos_fs
()

692 
	`uÄegi¡”_fžesy¡em
(&
msdos_fs_ty³
);

693 
	}
}

695 
MODULE_LICENSE
("GPL");

696 
MODULE_AUTHOR
("Werner Almesberger");

697 
MODULE_DESCRIPTION
("MS-DOS filesystem support");

699 
	$moduË_š™
(
š™_msdos_fs
)

700 
	`moduË_ex™
(
ex™_msdos_fs
)

	@namei_vfat.c

18 
	~<lšux/k”Ãl.h
>

22 
	~<lšux/moduË.h
>

23 
	~<lšux/jiff›s.h
>

24 
	~<lšux/ùy³.h
>

25 
	~<lšux/¦ab.h
>

26 
	~<lšux/bufãr_h—d.h
>

27 
	~<lšux/Çmei.h
>

28 
	~"çt.h
"

39 
	$vçt_»v®id©e_shÜŠame
(
d’Œy
 *dentry)

41 
»t
 = 1;

42 
	`¥š_lock
(&
d’Œy
->
d_lock
);

43 ià(
d’Œy
->
d_time
 !ðd’Œy->
d_·»Á
->
d_šode
->
i_v”siÚ
)

44 
»t
 = 0;

45 
	`¥š_uÆock
(&
d’Œy
->
d_lock
);

46  
»t
;

47 
	}
}

49 
	$vçt_»v®id©e
(
d’Œy
 *d’Œy, 
æags
)

51 ià(
æags
 & 
LOOKUP_RCU
)

52  -
ECHILD
;

55 ià(
d’Œy
->
d_šode
)

57  
	`vçt_»v®id©e_shÜŠame
(
d’Œy
);

58 
	}
}

60 
	$vçt_»v®id©e_ci
(
d’Œy
 *d’Œy, 
æags
)

62 ià(
æags
 & 
LOOKUP_RCU
)

63  -
ECHILD
;

75 ià(
d’Œy
->
d_šode
)

82 ià(!
æags
)

90 ià(
æags
 & (
LOOKUP_CREATE
 | 
LOOKUP_RENAME_TARGET
))

93  
	`vçt_»v®id©e_shÜŠame
(
d’Œy
);

94 
	}
}

97 
	$__vçt_¡rž_Ën
(
Ën
, cÚ¡ *
Çme
)

99 
Ën
 && 
Çme
[len - 1] == '.')

100 
Ën
--;

101  
Ën
;

102 
	}
}

104 
	$vçt_¡rž_Ën
(cÚ¡ 
q¡r
 *qstr)

106  
	`__vçt_¡rž_Ën
(
q¡r
->
Ën
, q¡r->
Çme
);

107 
	}
}

115 
	$vçt_hash
(cÚ¡ 
d’Œy
 *d’Œy, cÚ¡ 
šode
 *inode,

116 
q¡r
 *qstr)

118 
q¡r
->
hash
 = 
	`fuÎ_Çme_hash
(q¡r->
Çme
, 
	`vçt_¡rž_Ën
(qstr));

120 
	}
}

128 
	$vçt_hashi
(cÚ¡ 
d’Œy
 *d’Œy, cÚ¡ 
šode
 *inode,

129 
q¡r
 *qstr)

131 
Æs_bË
 *
t
 = 
	`MSDOS_SB
(
d’Œy
->
d_sb
)->
Æs_io
;

132 cÚ¡ *
Çme
;

133 
Ën
;

134 
hash
;

136 
Çme
 = 
q¡r
->name;

137 
Ën
 = 
	`vçt_¡rž_Ën
(
q¡r
);

139 
hash
 = 
	`š™_Çme_hash
();

140 
Ën
--)

141 
hash
 = 
	`·¹Ÿl_Çme_hash
(
	`Æs_tÞow”
(
t
, *
Çme
++), hash);

142 
q¡r
->
hash
 = 
	`’d_Çme_hash
(hash);

145 
	}
}

150 
	$vçt_cmpi
(cÚ¡ 
d’Œy
 *
·»Á
, cÚ¡ 
šode
 *
pšode
,

151 cÚ¡ 
d’Œy
 *d’Œy, cÚ¡ 
šode
 *inode,

152 
Ën
, cÚ¡ *
¡r
, cÚ¡ 
q¡r
 *
Çme
)

154 
Æs_bË
 *
t
 = 
	`MSDOS_SB
(
·»Á
->
d_sb
)->
Æs_io
;

155 
®’
, 
bËn
;

158 
®’
 = 
	`vçt_¡rž_Ën
(
Çme
);

159 
bËn
 = 
	`__vçt_¡rž_Ën
(
Ën
, 
¡r
);

160 ià(
®’
 =ð
bËn
) {

161 ià(
	`Æs_¡ºicmp
(
t
, 
Çme
->Çme, 
¡r
, 
®’
) == 0)

165 
	}
}

170 
	$vçt_cmp
(cÚ¡ 
d’Œy
 *
·»Á
, cÚ¡ 
šode
 *
pšode
,

171 cÚ¡ 
d’Œy
 *d’Œy, cÚ¡ 
šode
 *inode,

172 
Ën
, cÚ¡ *
¡r
, cÚ¡ 
q¡r
 *
Çme
)

174 
®’
, 
bËn
;

177 
®’
 = 
	`vçt_¡rž_Ën
(
Çme
);

178 
bËn
 = 
	`__vçt_¡rž_Ën
(
Ën
, 
¡r
);

179 ià(
®’
 =ð
bËn
) {

180 ià(
	`¡ºcmp
(
Çme
->Çme, 
¡r
, 
®’
) == 0)

184 
	}
}

186 cÚ¡ 
d’Œy_Ý”©iÚs
 
	gvçt_ci_d’Œy_Ýs
 = {

187 .
d_»v®id©e
 = 
vçt_»v®id©e_ci
,

188 .
	gd_hash
 = 
vçt_hashi
,

189 .
	gd_com·»
 = 
vçt_cmpi
,

192 cÚ¡ 
d’Œy_Ý”©iÚs
 
	gvçt_d’Œy_Ýs
 = {

193 .
d_»v®id©e
 = 
vçt_»v®id©e
,

194 .
	gd_hash
 = 
vçt_hash
,

195 .
	gd_com·»
 = 
vçt_cmp
,

200 
šlše
 
wch¬_t
 
	$vçt_bad_ch¬
(
wch¬_t
 
w
)

202  (
w
 < 0x0020)

203 || (
w
 == '*') || (w == '?') || (w == '<') || (w == '>')

204 || (
w
 == '|') || (w == '"') || (w == ':') || (w == '/')

205 || (
w
 == '\\');

206 
	}
}

208 
šlše
 
wch¬_t
 
	$vçt_»¶aû_ch¬
(
wch¬_t
 
w
)

210  (
w
 == '[') || (w == ']') || (w == ';') || (w == ',')

211 || (
w
 == '+') || (w == '=');

212 
	}
}

214 
wch¬_t
 
	$vçt_sk_ch¬
(
wch¬_t
 
w
)

216  (
w
 == '.') || (w == ' ');

217 
	}
}

219 
šlše
 
	$vçt_is_u£d_badch¬s
(cÚ¡ 
wch¬_t
 *
s
, 
Ën
)

221 
i
;

223 
i
 = 0; i < 
Ën
; i++)

224 ià(
	`vçt_bad_ch¬
(
s
[
i
]))

225  -
EINVAL
;

227 ià(
s
[
i
 - 1] == ' ')

228  -
EINVAL
;

231 
	}
}

233 
	$vçt_fšd_fÜm
(
šode
 *
dœ
, *
Çme
)

235 
çt_¦Ù_šfo
 
sšfo
;

236 
”r
 = 
	`çt_sÿn
(
dœ
, 
Çme
, &
sšfo
);

237 ià(
”r
)

238  -
ENOENT
;

239 
	`b»l£
(
sšfo
.
bh
);

241 
	}
}

263 
	sshÜŠame_šfo
 {

264 
	mlow”
:1,

265 
	muµ”
:1,

266 
	mv®id
:1;

268 
	#INIT_SHORTNAME_INFO
(
x
) do { \

269 (
x
)->
low”
 = 1; \

270 (
x
)->
uµ”
 = 1; \

271 (
x
)->
v®id
 = 1; \

272 } 0)

	)

274 
šlše
 
	$to_shÜŠame_ch¬
(
Æs_bË
 *
Æs
,

275 *
buf
, 
buf_size
,

276 
wch¬_t
 *
¤c
, 
shÜŠame_šfo
 *
šfo
)

278 
Ën
;

280 ià(
	`vçt_sk_ch¬
(*
¤c
)) {

281 
šfo
->
v®id
 = 0;

284 ià(
	`vçt_»¶aû_ch¬
(*
¤c
)) {

285 
šfo
->
v®id
 = 0;

286 
buf
[0] = '_';

290 
Ën
 = 
Æs
->
	`uni2ch¬
(*
¤c
, 
buf
, 
buf_size
);

291 ià(
Ën
 <= 0) {

292 
šfo
->
v®id
 = 0;

293 
buf
[0] = '_';

294 
Ën
 = 1;

295 } ià(
Ën
 == 1) {

296 
´ev
 = 
buf
[0];

298 ià(
buf
[0] >= 0x7F) {

299 
šfo
->
low”
 = 0;

300 
šfo
->
uµ”
 = 0;

303 
buf
[0] = 
	`Æs_touµ”
(
Æs
, buf[0]);

304 ià(
	`i§Íha
(
buf
[0])) {

305 ià(
buf
[0] =ð
´ev
)

306 
šfo
->
low”
 = 0;

308 
šfo
->
uµ”
 = 0;

311 
šfo
->
low”
 = 0;

312 
šfo
->
uµ”
 = 0;

315  
Ën
;

316 
	}
}

324 
	$vçt_ü—‹_shÜŠame
(
šode
 *
dœ
, 
Æs_bË
 *
Æs
,

325 
wch¬_t
 *
uÇme
, 
uËn
,

326 *
Çme_»s
, *
lÿ£
)

328 
çt_mouÁ_ÝtiÚs
 *
Ýts
 = &
	`MSDOS_SB
(
dœ
->
i_sb
)->
ÝtiÚs
;

329 
wch¬_t
 *

, *
ext_¡¬t
, *
’d
, *
Çme_¡¬t
;

330 
ba£
[9], 
ext
[4], 
buf
[5], *
p
;

331 
ch¬buf
[
NLS_MAX_CHARSET_SIZE
];

332 
chl
, 
chi
;

333 
sz
 = 0, 
exŽ’
, 
ba£Ën
, 
i
, 
numž_ba£Ën
, 
numž2_ba£Ën
;

334 
is_shÜŠame
;

335 
shÜŠame_šfo
 
ba£_šfo
, 
ext_šfo
;

337 
is_shÜŠame
 = 1;

338 
	`INIT_SHORTNAME_INFO
(&
ba£_šfo
);

339 
	`INIT_SHORTNAME_INFO
(&
ext_šfo
);

342 
ext_¡¬t
 = 
’d
 = &
uÇme
[
uËn
];

343 --
ext_¡¬t
 >ð
uÇme
) {

344 ià(*
ext_¡¬t
 == 0x002E) {

345 ià(
ext_¡¬t
 =ð
’d
 - 1) {

346 
sz
 = 
uËn
;

347 
ext_¡¬t
 = 
NULL
;

353 ià(
ext_¡¬t
 =ð
uÇme
 - 1) {

354 
sz
 = 
uËn
;

355 
ext_¡¬t
 = 
NULL
;

356 } ià(
ext_¡¬t
) {

362 
Çme_¡¬t
 = &
uÇme
[0];

363 
Çme_¡¬t
 < 
ext_¡¬t
) {

364 ià(!
	`vçt_sk_ch¬
(*
Çme_¡¬t
))

366 
Çme_¡¬t
++;

368 ià(
Çme_¡¬t
 !ð
ext_¡¬t
) {

369 
sz
 = 
ext_¡¬t
 - 
uÇme
;

370 
ext_¡¬t
++;

372 
sz
 = 
uËn
;

373 
ext_¡¬t
 = 
NULL
;

377 
numž_ba£Ën
 = 6;

378 
numž2_ba£Ën
 = 2;

379 
ba£Ën
 = 
i
 = 0, 
p
 = 
ba£
, 

 = 
uÇme
; i < 
sz
; i++, ip++) {

380 
chl
 = 
	`to_shÜŠame_ch¬
(
Æs
, 
ch¬buf
, (charbuf),

381 

, &
ba£_šfo
);

382 ià(
chl
 == 0)

385 ià(
ba£Ën
 < 2 && (ba£ËÀ+ 
chl
) > 2)

386 
numž2_ba£Ën
 = 
ba£Ën
;

387 ià(
ba£Ën
 < 6 && (ba£ËÀ+ 
chl
) > 6)

388 
numž_ba£Ën
 = 
ba£Ën
;

389 
chi
 = 0; ch˜< 
chl
; chi++) {

390 *
p
++ = 
ch¬buf
[
chi
];

391 
ba£Ën
++;

392 ià(
ba£Ën
 >= 8)

395 ià(
ba£Ën
 >= 8) {

396 ià((
chi
 < 
chl
 - 1è|| (

 + 1è- 
uÇme
 < 
sz
)

397 
is_shÜŠame
 = 0;

401 ià(
ba£Ën
 == 0) {

402  -
EINVAL
;

405 
exŽ’
 = 0;

406 ià(
ext_¡¬t
) {

407 
p
 = 
ext
, 

 = 
ext_¡¬t
; 
exŽ’
 < 3 && i°< 
’d
; ip++) {

408 
chl
 = 
	`to_shÜŠame_ch¬
(
Æs
, 
ch¬buf
, (charbuf),

409 

, &
ext_šfo
);

410 ià(
chl
 == 0)

413 ià((
exŽ’
 + 
chl
) > 3) {

414 
is_shÜŠame
 = 0;

417 
chi
 = 0; ch˜< 
chl
; chi++) {

418 *
p
++ = 
ch¬buf
[
chi
];

419 
exŽ’
++;

421 ià(
exŽ’
 >= 3) {

422 ià(

 + 1 !ð
’d
)

423 
is_shÜŠame
 = 0;

428 
ext
[
exŽ’
] = '\0';

429 
ba£
[
ba£Ën
] = '\0';

432 ià(
ba£
[0] =ð
DELETED_FLAG
)

433 
ba£
[0] = 0x05;

440 
	`mem£t
(
Çme_»s
, ' ', 
MSDOS_NAME
);

441 
	`memýy
(
Çme_»s
, 
ba£
, 
ba£Ën
);

442 
	`memýy
(
Çme_»s
 + 8, 
ext
, 
exŽ’
);

443 *
lÿ£
 = 0;

444 ià(
is_shÜŠame
 && 
ba£_šfo
.
v®id
 && 
ext_šfo
.valid) {

445 ià(
	`vçt_fšd_fÜm
(
dœ
, 
Çme_»s
) == 0)

446  -
EEXIST
;

448 ià(
Ýts
->
shÜŠame
 & 
VFAT_SFN_CREATE_WIN95
) {

449  (
ba£_šfo
.
uµ”
 && 
ext_šfo
.upper);

450 } ià(
Ýts
->
shÜŠame
 & 
VFAT_SFN_CREATE_WINNT
) {

451 ià((
ba£_šfo
.
uµ”
 || ba£_šfo.
low”
) &&

452 (
ext_šfo
.
uµ”
 ||ƒxt_šfo.
low”
)) {

453 ià(!
ba£_šfo
.
uµ”
 && ba£_šfo.
low”
)

454 *
lÿ£
 |ð
CASE_LOWER_BASE
;

455 ià(!
ext_šfo
.
uµ”
 &&ƒxt_šfo.
low”
)

456 *
lÿ£
 |ð
CASE_LOWER_EXT
;

461 
	`BUG
();

465 ià(
Ýts
->
numž
 == 0)

466 ià(
	`vçt_fšd_fÜm
(
dœ
, 
Çme_»s
) < 0)

477 ià(
ba£Ën
 > 6) {

478 
ba£Ën
 = 
numž_ba£Ën
;

479 
Çme_»s
[7] = ' ';

481 
Çme_»s
[
ba£Ën
] = '~';

482 
i
 = 1; i < 10; i++) {

483 
Çme_»s
[
ba£Ën
 + 1] = 
i
 + '0';

484 ià(
	`vçt_fšd_fÜm
(
dœ
, 
Çme_»s
) < 0)

488 
i
 = 
jiff›s
;

489 
sz
 = (
jiff›s
 >> 16) & 0x7;

490 ià(
ba£Ën
 > 2) {

491 
ba£Ën
 = 
numž2_ba£Ën
;

492 
Çme_»s
[7] = ' ';

494 
Çme_»s
[
ba£Ën
 + 4] = '~';

495 
Çme_»s
[
ba£Ën
 + 5] = '1' + 
sz
;

497 
	`¢´štf
(
buf
, (buf), "%04X", 
i
 & 0xffff);

498 
	`memýy
(&
Çme_»s
[
ba£Ën
], 
buf
, 4);

499 ià(
	`vçt_fšd_fÜm
(
dœ
, 
Çme_»s
) < 0)

501 
i
 -= 11;

504 
	}
}

508 
	$xÏ‹_to_uni
(cÚ¡ *
Çme
, 
Ën
, *
ouŠame
,

509 *
lÚgËn
, *
ouŽ’
, 
esÿ³
, 
utf8
,

510 
Æs_bË
 *
Æs
)

512 cÚ¡ *

;

513 
nc
;

514 *
Ý
;

515 
ec
;

516 
i
, 
k
, 
fžl
;

517 
ch¬Ën
;

519 ià(
utf8
) {

520 *
ouŽ’
 = 
	`utf8s_to_utf16s
(
Çme
, 
Ën
, 
UTF16_HOST_ENDIAN
,

521 (
wch¬_t
 *è
ouŠame
, 
FAT_LFN_LEN
 + 2);

522 ià(*
ouŽ’
 < 0)

523  *
ouŽ’
;

524 ià(*
ouŽ’
 > 
FAT_LFN_LEN
)

525  -
ENAMETOOLONG
;

527 
Ý
 = &
ouŠame
[*
ouŽ’
 * (
wch¬_t
)];

529 
i
 = 0, 

 = 
Çme
, 
Ý
 = 
ouŠame
, *
ouŽ’
 = 0;

530 
i
 < 
Ën
 && *
ouŽ’
 < 
FAT_LFN_LEN
;

531 *
ouŽ’
 += 1) {

532 ià(
esÿ³
 && (*

 == ':')) {

533 ià(
i
 > 
Ën
 - 5)

534  -
EINVAL
;

535 
ec
 = 0;

536 
k
 = 1; k < 5; k++) {

537 
nc
 = 

[
k
];

538 
ec
 <<= 4;

539 ià(
nc
 >= '0' &&‚c <= '9') {

540 
ec
 |ð
nc
 - '0';

543 ià(
nc
 >= 'a' &&‚c <= 'f') {

544 
ec
 |ð
nc
 - ('a' - 10);

547 ià(
nc
 >= 'A' &&‚c <= 'F') {

548 
ec
 |ð
nc
 - ('A' - 10);

551  -
EINVAL
;

553 *
Ý
++ = 
ec
 & 0xFF;

554 *
Ý
++ = 
ec
 >> 8;

555 

 += 5;

556 
i
 += 5;

558 
ch¬Ën
 = 
Æs
->
	`ch¬2uni
(

, 
Ën
 - 
i
,

559 (
wch¬_t
 *)
Ý
);

560 ià(
ch¬Ën
 < 0)

561  -
EINVAL
;

562 

 +ð
ch¬Ën
;

563 
i
 +ð
ch¬Ën
;

564 
Ý
 += 2;

567 ià(
i
 < 
Ën
)

568  -
ENAMETOOLONG
;

571 *
lÚgËn
 = *
ouŽ’
;

572 ià(*
ouŽ’
 % 13) {

573 *
Ý
++ = 0;

574 *
Ý
++ = 0;

575 *
ouŽ’
 += 1;

576 ià(*
ouŽ’
 % 13) {

577 
fžl
 = 13 - (*
ouŽ’
 % 13);

578 
i
 = 0; i < 
fžl
; i++) {

579 *
Ý
++ = 0xff;

580 *
Ý
++ = 0xff;

582 *
ouŽ’
 +ð
fžl
;

587 
	}
}

589 
	$vçt_bužd_¦Ùs
(
šode
 *
dœ
, cÚ¡ *
Çme
,

590 
Ën
, 
is_dœ
, 
þu¡”
,

591 
time¥ec
 *
ts
,

592 
msdos_dœ_¦Ù
 *
¦Ùs
, *
Ä_¦Ùs
)

594 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
dœ
->
i_sb
);

595 
çt_mouÁ_ÝtiÚs
 *
Ýts
 = &
sbi
->
ÝtiÚs
;

596 
msdos_dœ_¦Ù
 *
ps
;

597 
msdos_dœ_’Œy
 *
de
;

598 
cksum
, 
lÿ£
;

599 
msdos_Çme
[
MSDOS_NAME
];

600 
wch¬_t
 *
uÇme
;

601 
__Ë16
 
time
, 
d©e
;

602 
u8
 
time_cs
;

603 
”r
, 
uËn
, 
usize
, 
i
;

604 
loff_t
 
off£t
;

606 *
Ä_¦Ùs
 = 0;

608 
uÇme
 = 
	`__g‘Çme
();

609 ià(!
uÇme
)

610  -
ENOMEM
;

612 
”r
 = 
	`xÏ‹_to_uni
(
Çme
, 
Ën
, (*)
uÇme
, &
uËn
, &
usize
,

613 
Ýts
->
unicode_xÏ‹
, o±s->
utf8
, 
sbi
->
Æs_io
);

614 ià(
”r
)

615 
out_ä“
;

617 
”r
 = 
	`vçt_is_u£d_badch¬s
(
uÇme
, 
uËn
);

618 ià(
”r
)

619 
out_ä“
;

621 
”r
 = 
	`vçt_ü—‹_shÜŠame
(
dœ
, 
sbi
->
Æs_disk
, 
uÇme
, 
uËn
,

622 
msdos_Çme
, &
lÿ£
);

623 ià(
”r
 < 0)

624 
out_ä“
;

625 ià(
”r
 == 1) {

626 
de
 = (
msdos_dœ_’Œy
 *)
¦Ùs
;

627 
”r
 = 0;

628 
shÜŠame
;

632 
cksum
 = 
	`çt_checksum
(
msdos_Çme
);

634 *
Ä_¦Ùs
 = 
usize
 / 13;

635 
ps
 = 
¦Ùs
, 
i
 = *
Ä_¦Ùs
; i > 0; i--,…s++) {

636 
ps
->
id
 = 
i
;

637 
ps
->
©Œ
 = 
ATTR_EXT
;

638 
ps
->
»£rved
 = 0;

639 
ps
->
®Ÿs_checksum
 = 
cksum
;

640 
ps
->
¡¬t
 = 0;

641 
off£t
 = (
i
 - 1) * 13;

642 
	`çtwch¬_to16
(
ps
->
Çme0_4
, 
uÇme
 + 
off£t
, 5);

643 
	`çtwch¬_to16
(
ps
->
Çme5_10
, 
uÇme
 + 
off£t
 + 5, 6);

644 
	`çtwch¬_to16
(
ps
->
Çme11_12
, 
uÇme
 + 
off£t
 + 11, 2);

646 
¦Ùs
[0].
id
 |= 0x40;

647 
de
 = (
msdos_dœ_’Œy
 *)
ps
;

649 
shÜŠame
:

651 (*
Ä_¦Ùs
)++;

652 
	`memýy
(
de
->
Çme
, 
msdos_Çme
, 
MSDOS_NAME
);

653 
de
->
©Œ
 = 
is_dœ
 ? 
ATTR_DIR
 : 
ATTR_ARCH
;

654 
de
->
lÿ£
 =†case;

655 
	`çt_time_unix2çt
(
sbi
, 
ts
, &
time
, &
d©e
, &
time_cs
);

658 
time
 = 123;

659 
de
->
time
 = de->
ùime
 =ime;

660 
de
->
d©e
 = de->
cd©e
 = de->
ad©e
 = date;

661 
de
->
ùime_cs
 = 
time_cs
;

663 
	`çt_£t_¡¬t
(
de
, 
þu¡”
);

664 
de
->
size
 = 0;

665 
out_ä“
:

666 
	`__puŠame
(
uÇme
);

667  
”r
;

668 
	}
}

670 
	$vçt_add_’Œy
(
šode
 *
dœ
, 
q¡r
 *
qÇme
, 
is_dœ
,

671 
þu¡”
, 
time¥ec
 *
ts
,

672 
çt_¦Ù_šfo
 *
sšfo
)

674 
msdos_dœ_¦Ù
 *
¦Ùs
;

675 
Ën
;

676 
”r
, 
Ä_¦Ùs
;

678 
Ën
 = 
	`vçt_¡rž_Ën
(
qÇme
);

679 ià(
Ën
 == 0)

680  -
ENOENT
;

682 
¦Ùs
 = 
	`km®loc
((*¦Ùsè* 
MSDOS_SLOTS
, 
GFP_NOFS
);

683 ià(
¦Ùs
 =ð
NULL
)

684  -
ENOMEM
;

686 
”r
 = 
	`vçt_bužd_¦Ùs
(
dœ
, 
qÇme
->
Çme
, 
Ën
, 
is_dœ
, 
þu¡”
, 
ts
,

687 
¦Ùs
, &
Ä_¦Ùs
);

688 ià(
”r
)

689 
þ—nup
;

691 
”r
 = 
	`çt_add_’Œ›s
(
dœ
, 
¦Ùs
, 
Ä_¦Ùs
, 
sšfo
);

692 ià(
”r
)

693 
þ—nup
;

696 
dœ
->
i_ùime
 = dœ->
i_mtime
 = dœ->
i_©ime
 = *
ts
;

705 ià(
	`IS_DIRSYNC
(
dœ
))

706 ()
	`çt_sync_šode
(
dœ
);

708 
	`m¬k_šode_dœty
(
dœ
);

709 
þ—nup
:

710 
	`kä“
(
¦Ùs
);

711  
”r
;

712 
	}
}

714 
	$vçt_fšd
(
šode
 *
dœ
, 
q¡r
 *
qÇme
,

715 
çt_¦Ù_šfo
 *
sšfo
)

717 
Ën
 = 
	`vçt_¡rž_Ën
(
qÇme
);

718 ià(
Ën
 == 0)

719  -
ENOENT
;

720  
	`çt_£¬ch_lÚg
(
dœ
, 
qÇme
->
Çme
, 
Ën
, 
sšfo
);

721 
	}
}

727 
	$vçt_d_ªÚ_discÚn
(
d’Œy
 *dentry)

729  
	`IS_ROOT
(
d’Œy
è&& (d’Œy->
d_æags
 & 
DCACHE_DISCONNECTED
);

730 
	}
}

732 
d’Œy
 *
	$vçt_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry,

733 
æags
)

735 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

736 
çt_¦Ù_šfo
 
sšfo
;

737 
šode
 *inode;

738 
d’Œy
 *
®Ÿs
;

739 
”r
;

743 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

745 
”r
 = 
	`vçt_fšd
(
dœ
, &
d’Œy
->
d_Çme
, &
sšfo
);

746 ià(
”r
) {

747 ià(
”r
 =ð-
ENOENT
) {

748 
šode
 = 
NULL
;

749 
out
;

751 
”rÜ
;

754 
šode
 = 
	`çt_bužd_šode
(
sb
, 
sšfo
.
de
, sšfo.
i_pos
);

755 
	`b»l£
(
sšfo
.
bh
);

756 ià(
	`IS_ERR
(
šode
)) {

757 
”r
 = 
	`PTR_ERR
(
šode
);

758 
”rÜ
;

761 
®Ÿs
 = 
	`d_fšd_®Ÿs
(
šode
);

762 ià(
®Ÿs
 && !
	`vçt_d_ªÚ_discÚn
(alias)) {

770 
	`BUG_ON
(
	`d_unhashed
(
®Ÿs
));

771 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

772 
	`d_move
(
®Ÿs
, 
d’Œy
);

773 
	`ut
(
šode
);

774 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

775  
®Ÿs
;

777 
	`dput
(
®Ÿs
);

779 
out
:

780 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

781 
d’Œy
->
d_time
 = d’Œy->
d_·»Á
->
d_šode
->
i_v”siÚ
;

782 
d’Œy
 = 
	`d_¥liû_®Ÿs
(
šode
, dentry);

783 ià(
d’Œy
)

785 
d’Œy
->
d_time
 = d’Œy->
d_·»Á
->
d_šode
->
i_v”siÚ
;

789  
d’Œy
;

791 
”rÜ
:

792 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

793  
	`ERR_PTR
(
”r
);

794 
	}
}

796 
	$vçt_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
,

797 
boÞ
 
exþ
)

799 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

800 
šode
 *inode;

801 
çt_¦Ù_šfo
 
sšfo
;

802 
time¥ec
 
ts
;

803 
”r
;

807 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

810 
ts
 = 
CURRENT_TIME_SEC
;

811 
”r
 = 
	`vçt_add_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, 0, 0, &
ts
, &
sšfo
);

812 ià(
”r
)

813 
out
;

814 
dœ
->
i_v”siÚ
++;

816 
šode
 = 
	`çt_bužd_šode
(
sb
, 
sšfo
.
de
, sšfo.
i_pos
);

817 
	`b»l£
(
sšfo
.
bh
);

818 ià(
	`IS_ERR
(
šode
)) {

819 
”r
 = 
	`PTR_ERR
(
šode
);

820 
out
;

822 
šode
->
i_v”siÚ
++;

824 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
ts
;

829 
d’Œy
->
d_time
 = d’Œy->
d_·»Á
->
d_šode
->
i_v”siÚ
;

831 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

832 
out
:

833 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

834  
”r
;

835 
	}
}

837 
	$vçt_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

839 
šode
 *šodð
d’Œy
->
d_šode
;

840 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

841 
çt_¦Ù_šfo
 
sšfo
;

842 
”r
;

844 
	`´štk
Ð
KERN_ALERT
 "[cheon] vfat_rmdir \n" );

846 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

848 
”r
 = 
	`çt_dœ_em±y
(
šode
);

849 ià(
”r
)

850 
out
;

851 
”r
 = 
	`vçt_fšd
(
dœ
, &
d’Œy
->
d_Çme
, &
sšfo
);

852 ià(
”r
)

853 
out
;

855 
”r
 = 
	`çt_»move_’Œ›s
(
dœ
, &
sšfo
);

856 ià(
”r
)

857 
out
;

858 
	`drÝ_Æšk
(
dœ
);

860 
	`þ—r_Æšk
(
šode
);

862 
šode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME_SEC
;

866 
	`´štk
("[cheon] vfat_rmdir \n");

867 
	`´štk
("šode->i_mtime.tv_£ø: %lu \n", 
šode
->
i_mtime
.
tv_£c
 );

868 
	`´štk
("šode->i_mtime.tv_n£ø: %ld \n", 
šode
->
i_mtime
.
tv_n£c
 );

870 
	`çt_d‘ach
(
šode
);

871 
out
:

872 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

874  
”r
;

875 
	}
}

877 
	$vçt_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

879 
šode
 *šodð
d’Œy
->
d_šode
;

880 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

881 
çt_¦Ù_šfo
 
sšfo
;

882 
”r
;

887 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

889 
”r
 = 
	`vçt_fšd
(
dœ
, &
d’Œy
->
d_Çme
, &
sšfo
);

890 ià(
”r
)

891 
out
;

894 
”r
 = 
	`çt_»move_’Œ›s
(
dœ
, &
sšfo
);

895 ià(
”r
)

896 
out
;

897 
	`þ—r_Æšk
(
šode
);

899 
šode
->
i_mtime
 = inode->
i_©ime
 = 
CURRENT_TIME_SEC
;

907 
	`çt_d‘ach
(
šode
);

908 
out
:

909 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

911  
”r
;

912 
	}
}

914 
	$vçt_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

916 
su³r_block
 *
sb
 = 
dœ
->
i_sb
;

917 
šode
 *inode;

918 
çt_¦Ù_šfo
 
sšfo
;

919 
time¥ec
 
ts
;

920 
”r
, 
þu¡”
;

924 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

926 
ts
 = 
CURRENT_TIME_SEC
;

928 
þu¡”
 = 
	`çt_®loc_Ãw_dœ
(
dœ
, &
ts
);

929 ià(
þu¡”
 < 0) {

930 
”r
 = 
þu¡”
;

931 
out
;

933 
”r
 = 
	`vçt_add_’Œy
(
dœ
, &
d’Œy
->
d_Çme
, 1, 
þu¡”
, &
ts
, &
sšfo
);

934 ià(
”r
)

935 
out_ä“
;

936 
dœ
->
i_v”siÚ
++;

937 
	`šc_Æšk
(
dœ
);

939 
šode
 = 
	`çt_bužd_šode
(
sb
, 
sšfo
.
de
, sšfo.
i_pos
);

940 
	`b»l£
(
sšfo
.
bh
);

941 ià(
	`IS_ERR
(
šode
)) {

942 
”r
 = 
	`PTR_ERR
(
šode
);

944 
out
;

946 
šode
->
i_v”siÚ
++;

947 
	`£t_Æšk
(
šode
, 2);

948 
šode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_ùime
 = 
ts
;

960 
d’Œy
->
d_time
 = d’Œy->
d_·»Á
->
d_šode
->
i_v”siÚ
;

962 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

964 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

967 
out_ä“
:

969 
	`çt_ä“_þu¡”s
(
dœ
, 
þu¡”
);

970 
out
:

971 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

972  
”r
;

973 
	}
}

975 
	$vçt_»Çme
(
šode
 *
Þd_dœ
, 
d’Œy
 *
Þd_d’Œy
,

976 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
)

978 
bufãr_h—d
 *
dÙdÙ_bh
;

979 
msdos_dœ_’Œy
 *
dÙdÙ_de
;

980 
šode
 *
Þd_šode
, *
Ãw_šode
;

981 
çt_¦Ù_šfo
 
Þd_sšfo
, 
sšfo
;

982 
time¥ec
 
ts
;

983 
loff_t
 
Ãw_i_pos
;

984 
”r
, 
is_dœ
, 
upd©e_dÙdÙ
, 
cÜru±
 = 0;

985 
su³r_block
 *
sb
 = 
Þd_dœ
->
i_sb
;

989 
Þd_sšfo
.
bh
 = 
sšfo
.bh = 
dÙdÙ_bh
 = 
NULL
;

990 
Þd_šode
 = 
Þd_d’Œy
->
d_šode
;

991 
Ãw_šode
 = 
Ãw_d’Œy
->
d_šode
;

992 
	`mu‹x_lock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

993 
”r
 = 
	`vçt_fšd
(
Þd_dœ
, &
Þd_d’Œy
->
d_Çme
, &
Þd_sšfo
);

994 ià(
”r
)

995 
out
;

997 
is_dœ
 = 
	`S_ISDIR
(
Þd_šode
->
i_mode
);

998 
upd©e_dÙdÙ
 = (
is_dœ
 && 
Þd_dœ
 !ð
Ãw_dœ
);

999 ià(
upd©e_dÙdÙ
) {

1000 ià(
	`çt_g‘_dÙdÙ_’Œy
(
Þd_šode
, &
dÙdÙ_bh
, &
dÙdÙ_de
)) {

1001 
”r
 = -
EIO
;

1002 
out
;

1007 
ts
 = 
CURRENT_TIME_SEC
;

1008 ià(
Ãw_šode
) {

1009 ià(
is_dœ
) {

1010 
”r
 = 
	`çt_dœ_em±y
(
Ãw_šode
);

1011 ià(
”r
)

1012 
out
;

1014 
Ãw_i_pos
 = 
	`MSDOS_I
(
Ãw_šode
)->
i_pos
;

1015 
	`çt_d‘ach
(
Ãw_šode
);

1017 
”r
 = 
	`vçt_add_’Œy
(
Ãw_dœ
, &
Ãw_d’Œy
->
d_Çme
, 
is_dœ
, 0,

1018 &
ts
, &
sšfo
);

1019 ià(
”r
)

1020 
out
;

1021 
Ãw_i_pos
 = 
sšfo
.
i_pos
;

1023 
Ãw_dœ
->
i_v”siÚ
++;

1025 
	`çt_d‘ach
(
Þd_šode
);

1026 
	`çt_©ch
(
Þd_šode
, 
Ãw_i_pos
);

1027 ià(
	`IS_DIRSYNC
(
Ãw_dœ
)) {

1028 
”r
 = 
	`çt_sync_šode
(
Þd_šode
);

1029 ià(
”r
)

1030 
”rÜ_šode
;

1032 
	`m¬k_šode_dœty
(
Þd_šode
);

1034 ià(
upd©e_dÙdÙ
) {

1035 
	`çt_£t_¡¬t
(
dÙdÙ_de
, 
	`MSDOS_I
(
Ãw_dœ
)->
i_log¡¬t
);

1036 
	`m¬k_bufãr_dœty_šode
(
dÙdÙ_bh
, 
Þd_šode
);

1037 ià(
	`IS_DIRSYNC
(
Ãw_dœ
)) {

1038 
”r
 = 
	`sync_dœty_bufãr
(
dÙdÙ_bh
);

1039 ià(
”r
)

1040 
”rÜ_dÙdÙ
;

1042 
	`drÝ_Æšk
(
Þd_dœ
);

1043 ià(!
Ãw_šode
)

1044 
	`šc_Æšk
(
Ãw_dœ
);

1047 
”r
 = 
	`çt_»move_’Œ›s
(
Þd_dœ
, &
Þd_sšfo
);

1048 
Þd_sšfo
.
bh
 = 
NULL
;

1049 ià(
”r
)

1050 
”rÜ_dÙdÙ
;

1051 
Þd_dœ
->
i_v”siÚ
++;

1052 
Þd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 = 
ts
;

1053 ià(
	`IS_DIRSYNC
(
Þd_dœ
))

1054 ()
	`çt_sync_šode
(
Þd_dœ
);

1056 
	`m¬k_šode_dœty
(
Þd_dœ
);

1058 ià(
Ãw_šode
) {

1059 
	`drÝ_Æšk
(
Ãw_šode
);

1060 ià(
is_dœ
)

1061 
	`drÝ_Æšk
(
Ãw_šode
);

1062 
Ãw_šode
->
i_ùime
 = 
ts
;

1064 
out
:

1065 
	`b»l£
(
sšfo
.
bh
);

1066 
	`b»l£
(
dÙdÙ_bh
);

1067 
	`b»l£
(
Þd_sšfo
.
bh
);

1068 
	`mu‹x_uÆock
(&
	`MSDOS_SB
(
sb
)->
s_lock
);

1070  
”r
;

1072 
”rÜ_dÙdÙ
:

1074 
cÜru±
 = 1;

1076 ià(
upd©e_dÙdÙ
) {

1077 
	`çt_£t_¡¬t
(
dÙdÙ_de
, 
	`MSDOS_I
(
Þd_dœ
)->
i_log¡¬t
);

1078 
	`m¬k_bufãr_dœty_šode
(
dÙdÙ_bh
, 
Þd_šode
);

1079 
cÜru±
 |ð
	`sync_dœty_bufãr
(
dÙdÙ_bh
);

1081 
”rÜ_šode
:

1082 
	`çt_d‘ach
(
Þd_šode
);

1083 
	`çt_©ch
(
Þd_šode
, 
Þd_sšfo
.
i_pos
);

1084 ià(
Ãw_šode
) {

1085 
	`çt_©ch
(
Ãw_šode
, 
Ãw_i_pos
);

1086 ià(
cÜru±
)

1087 
cÜru±
 |ð
	`çt_sync_šode
(
Ãw_šode
);

1094 
”r2
 = 
	`çt_»move_’Œ›s
(
Ãw_dœ
, &
sšfo
);

1095 ià(
cÜru±
)

1096 
cÜru±
 |ð
”r2
;

1097 
sšfo
.
bh
 = 
NULL
;

1099 ià(
cÜru±
 < 0) {

1100 
	`çt_fs_”rÜ
(
Ãw_dœ
->
i_sb
,

1102 
__func__
, 
sšfo
.
i_pos
);

1104 
out
;

1105 
	}
}

1107 cÚ¡ 
šode_Ý”©iÚs
 
	gvçt_dœ_šode_Ý”©iÚs
 = {

1108 .
ü—‹
 = 
vçt_ü—‹
,

1109 .
	glookup
 = 
vçt_lookup
,

1110 .
	guÆšk
 = 
vçt_uÆšk
,

1111 .
	gmkdœ
 = 
vçt_mkdœ
,

1112 .
	grmdœ
 = 
vçt_rmdœ
,

1113 .
	g»Çme
 = 
vçt_»Çme
,

1114 .
	g£‰r
 = 
çt_£‰r
,

1115 .
	gg‘©Œ
 = 
çt_g‘©Œ
,

1118 
	$£tup
(
su³r_block
 *
sb
)

1120 
	`MSDOS_SB
(
sb
)->
dœ_Ýs
 = &
vçt_dœ_šode_Ý”©iÚs
;

1121 ià(
	`MSDOS_SB
(
sb
)->
ÝtiÚs
.
Çme_check
 != 's')

1122 
sb
->
s_d_Ý
 = &
vçt_ci_d’Œy_Ýs
;

1124 
sb
->
s_d_Ý
 = &
vçt_d’Œy_Ýs
;

1125 
	}
}

1127 
	$vçt_fžl_su³r
(
su³r_block
 *
sb
, *
d©a
, 
sž’t
)

1129 
»s
;

1131 
»s
 = 
	`çt_fžl_su³r
(
sb
, 
d©a
, 
sž’t
, 1, 
£tup
);

1134 
	`çt_cÚfig_š™
Ð
sb
 );

1135 
	`çt_upd©e_su³r
Ð
sb
 );

1137  
»s
;

1138 
	}
}

1140 
d’Œy
 *
	$vçt_mouÁ
(
fže_sy¡em_ty³
 *
fs_ty³
,

1141 
æags
, cÚ¡ *
dev_Çme
,

1142 *
d©a
)

1144 
	`´štk
Ð
KERN_ALERT
 "[cheon] 0711 1702\n");

1145 
	`´štk
Ð
KERN_ALERT
 "[cheon] vfat_mount !! \n");

1146  
	`mouÁ_bdev
(
fs_ty³
, 
æags
, 
dev_Çme
, 
d©a
, 
vçt_fžl_su³r
);

1147 
	}
}

1150 
	$ÿÎ_sysfs_cÚŒÞ_show
( )

1152 
	`´štk
Ð
KERN_ALERT
 "call_sysfs_control_show\n");

1153 
	}
}

1156 
kobjeù
 *
	gÝ–_çt_kobj
;

1158 
ssize_t
 
	$cÚŒÞ_show
Ð
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
©Œ
, *
buff
 )

1160 
	`´štk
Ð
KERN_ALERT
 "[cheon] sysfs control_show()");

1163  
	`¢´štf
Ð
buff
, 
PAGE_SIZE
, "%d \n", 1234 );

1164 
	}
}

1166 
ssize_t
 
	$cÚŒÞ_¡Üe
Ð
kobjeù
 *
kobj
, 
kobj_©Œibu‹
 *
©Œ
, cÚ¡ *
buff
, 
size_t
 
couÁ
 )

1168 
num
;

1170 
	`ssÿnf
Ð
buff
, "%d", &
num
 );

1172 
	`´štk
Ð
KERN_ALERT
 "num : %d \n", 
num
 );

1173 
	`´štk
Ð
KERN_ALERT
 "bufà: % \n", 
buff
 );

1175  
couÁ
;

1176 
	}
}

1179 
kobj_©Œibu‹
 
	gcÚŒÞ_©Œ
 = 
__ATTR
Ð
cÚŒÞ
, 0644, 
cÚŒÞ_show
, 
cÚŒÞ_¡Üe
 );

1181 
©Œibu‹
 *
	g©Œibu‹s
[ ] = {

1182 &
cÚŒÞ_©Œ
.
©Œ
,

1183 
NULL
,

1186 
©Œibu‹_group
 
	g©Œ_group
 = {

1187 .
©Œs
 = 
©Œibu‹s
,

1190 
	$do_fs_sysfs_»gi¡¿tiÚ
( )

1192 
rc
;

1194 
Ý–_çt_kobj
 = 
	`kobjeù_ü—‹_ªd_add
Ð"OPEL_FAT", 
fs_kobj
 );

1196 ifÐ!
Ý–_çt_kobj
 ){

1197 
	`´štk
Ð
KERN_ERR
 "Unableo create opel fat‡ttributes \n" );

1198 
out
;

1201 
rc
 = 
	`sysfs_ü—‹_group
Ð
Ý–_çt_kobj
, &
©Œ_group
 );

1203 ifÐ
rc
 )

1205 
	`´štk
Ð
KERN_ERR
 "Unableo create opel fat‡ttributes \n");

1206 
	`kobjeù_put
Ð
Ý–_çt_kobj
 );

1209 
out
:

1210  
rc
;

1211 
	}
}

1213 
	$do_fs_sysfs_uÄegi¡¿tiÚ
( )

1215 
	`sysfs_»move_group
Ð
Ý–_çt_kobj
, &
©Œ_group
 );

1217 
	`kobjeù_put
Ð
Ý–_çt_kobj
 );

1218 
	`kobjeù_d–
Ð
Ý–_çt_kobj
 );

1219 
	}
}

1224 
fže_sy¡em_ty³
 
	gvçt_fs_ty³
 = {

1225 .
owÃr
 = 
THIS_MODULE
,

1226 .
	gÇme
 = "vfat",

1227 .
	gmouÁ
 = 
vçt_mouÁ
,

1228 .
	gkžl_sb
 = 
kžl_block_su³r
,

1229 .
	gfs_æags
 = 
FS_REQUIRES_DEV
,

1231 
MODULE_ALIAS_FS
("vfat");

1233 
__š™
 
	$š™_vçt_fs
()

1236 
rc
;

1237 
	`´štk
Ð
KERN_ALERT
 "[cheon] FAT sysfs Test!! \n");

1239 
rc
 = 
	`do_fs_sysfs_»gi¡¿tiÚ
();

1241 ifÐ
rc
 ){

1242 
	`´štk
Ð
KERN_ALERT
 "[cheon] sysfs„egistration faild \b");

1246  
	`»gi¡”_fžesy¡em
(&
vçt_fs_ty³
);

1247 
	}
}

1249 
__ex™
 
	$ex™_vçt_fs
()

1251 
	`do_fs_sysfs_uÄegi¡¿tiÚ
();

1252 
	`uÄegi¡”_fžesy¡em
(&
vçt_fs_ty³
);

1253 
	}
}

1255 
MODULE_LICENSE
("GPL");

1256 
MODULE_DESCRIPTION
("VFAT filesystem support");

1257 
MODULE_AUTHOR
("Gordon Chaffee");

1259 
	$moduË_š™
(
š™_vçt_fs
)

1260 
	`moduË_ex™
(
ex™_vçt_fs
)

	@nfs.c

14 
	~<lšux/expÜtfs.h
>

15 
	~"çt.h
"

17 
	sçt_fid
 {

18 
u32
 
	mi_g’
;

19 
u32
 
	mi_pos_low
;

20 
u16
 
	mi_pos_hi
;

21 
u16
 
	m·»Á_i_pos_hi
;

22 
u32
 
	m·»Á_i_pos_low
;

23 
u32
 
	m·»Á_i_g’
;

26 
	#FAT_FID_SIZE_WITHOUT_PARENT
 3

	)

27 
	#FAT_FID_SIZE_WITH_PARENT
 ((
çt_fid
)/(
u32
))

	)

32 
šode
 *
	$çt_dg‘
(
su³r_block
 *
sb
, 
i_log¡¬t
)

34 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

35 
hli¡_h—d
 *
h—d
;

36 
msdos_šode_šfo
 *
i
;

37 
šode
 *šodð
NULL
;

39 
h—d
 = 
sbi
->
dœ_hashbË
 + 
	`çt_dœ_hash
(
i_log¡¬t
);

40 
	`¥š_lock
(&
sbi
->
dœ_hash_lock
);

41 
	`hli¡_fÜ_—ch_’Œy
(
i
, 
h—d
, 
i_dœ_hash
) {

42 
	`BUG_ON
(
i
->
vfs_šode
.
i_sb
 !ð
sb
);

43 ià(
i
->
i_log¡¬t
 != i_logstart)

45 
šode
 = 
	`ig¿b
(&
i
->
vfs_šode
);

46 ià(
šode
)

49 
	`¥š_uÆock
(&
sbi
->
dœ_hash_lock
);

50  
šode
;

51 
	}
}

53 
šode
 *
	$çt_žookup
(
su³r_block
 *
sb
, 
u64
 
šo
, 
loff_t
 
i_pos
)

55 ià(
	`MSDOS_SB
(
sb
)->
ÝtiÚs
.
nfs
 =ð
FAT_NFS_NOSTALE_RO
)

56  
	`çt_ig‘
(
sb
, 
i_pos
);

59 ià((
šo
 < 
MSDOS_ROOT_INO
è|| (šØ=ð
MSDOS_FSINFO_INO
))

60  
NULL
;

61  
	`žookup
(
sb
, 
šo
);

63 
	}
}

65 
šode
 *
	$__çt_nfs_g‘_šode
(
su³r_block
 *
sb
,

66 
u64
 
šo
, 
u32
 
g’”©iÚ
, 
loff_t
 
i_pos
)

68 
šode
 *šodð
	`çt_žookup
(
sb
, 
šo
, 
i_pos
);

70 ià(
šode
 && 
g’”©iÚ
 && (šode->
i_g’”©iÚ
 != generation)) {

71 
	`ut
(
šode
);

72 
šode
 = 
NULL
;

74 ià(
šode
 =ð
NULL
 && 
	`MSDOS_SB
(
sb
)->
ÝtiÚs
.
nfs
 =ð
FAT_NFS_NOSTALE_RO
) {

75 
bufãr_h—d
 *
bh
 = 
NULL
;

76 
msdos_dœ_’Œy
 *
de
 ;

77 
£ùÜ_t
 
blockÄ
;

78 
off£t
;

79 
	`çt_g‘_blkÄ_off£t
(
	`MSDOS_SB
(
sb
), 
i_pos
, &
blockÄ
, &
off£t
);

80 
bh
 = 
	`sb_b»ad
(
sb
, 
blockÄ
);

81 ià(!
bh
) {

82 
	`çt_msg
(
sb
, 
KERN_ERR
,

84 (
Îu
)
blockÄ
);

85  
šode
;

87 
de
 = (
msdos_dœ_’Œy
 *)
bh
->
b_d©a
;

91 ià(
	`IS_FREE
(
de
[
off£t
].
Çme
))

92 
šode
 = 
NULL
;

94 
šode
 = 
	`çt_bužd_šode
(
sb
, &
de
[
off£t
], 
i_pos
);

95 
	`b»l£
(
bh
);

98  
šode
;

99 
	}
}

101 
šode
 *
	$çt_nfs_g‘_šode
(
su³r_block
 *
sb
,

102 
u64
 
šo
, 
u32
 
g’”©iÚ
)

105  
	`__çt_nfs_g‘_šode
(
sb
, 
šo
, 
g’”©iÚ
, 0);

106 
	}
}

109 
	$çt_’code_fh_no¡®e
(
šode
 *šode, 
__u32
 *
fh
, *
ËÅ
,

110 
šode
 *
·»Á
)

112 
Ën
 = *
ËÅ
;

113 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
šode
->
i_sb
);

114 
çt_fid
 *
fid
 = (çt_fid *è
fh
;

115 
loff_t
 
i_pos
;

116 
ty³
 = 
FILEID_FAT_WITHOUT_PARENT
;

118 ià(
·»Á
) {

119 ià(
Ën
 < 
FAT_FID_SIZE_WITH_PARENT
) {

120 *
ËÅ
 = 
FAT_FID_SIZE_WITH_PARENT
;

121  
FILEID_INVALID
;

124 ià(
Ën
 < 
FAT_FID_SIZE_WITHOUT_PARENT
) {

125 *
ËÅ
 = 
FAT_FID_SIZE_WITHOUT_PARENT
;

126  
FILEID_INVALID
;

130 
i_pos
 = 
	`çt_i_pos_»ad
(
sbi
, 
šode
);

131 *
ËÅ
 = 
FAT_FID_SIZE_WITHOUT_PARENT
;

132 
fid
->
i_g’
 = 
šode
->
i_g’”©iÚ
;

133 
fid
->
i_pos_low
 = 
i_pos
 & 0xFFFFFFFF;

134 
fid
->
i_pos_hi
 = (
i_pos
 >> 32) & 0xFFFF;

135 ià(
·»Á
) {

136 
i_pos
 = 
	`çt_i_pos_»ad
(
sbi
, 
·»Á
);

137 
fid
->
·»Á_i_pos_hi
 = (
i_pos
 >> 32) & 0xFFFF;

138 
fid
->
·»Á_i_pos_low
 = 
i_pos
 & 0xFFFFFFFF;

139 
fid
->
·»Á_i_g’
 = 
·»Á
->
i_g’”©iÚ
;

140 
ty³
 = 
FILEID_FAT_WITH_PARENT
;

141 *
ËÅ
 = 
FAT_FID_SIZE_WITH_PARENT
;

144  
ty³
;

145 
	}
}

151 
d’Œy
 *
	$çt_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *fid,

152 
fh_Ën
, 
fh_ty³
)

154  
	`g’”ic_fh_to_d’Œy
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

155 
çt_nfs_g‘_šode
);

156 
	}
}

158 
d’Œy
 *
	$çt_fh_to_d’Œy_no¡®e
(
su³r_block
 *
sb
,

159 
fid
 *
fh
, 
fh_Ën
,

160 
fh_ty³
)

162 
šode
 *šodð
NULL
;

163 
çt_fid
 *
fid
 = (çt_fid *)
fh
;

164 
loff_t
 
i_pos
;

166 
fh_ty³
) {

167 
FILEID_FAT_WITHOUT_PARENT
:

168 ià(
fh_Ën
 < 
FAT_FID_SIZE_WITHOUT_PARENT
)

169  
NULL
;

171 
FILEID_FAT_WITH_PARENT
:

172 ià(
fh_Ën
 < 
FAT_FID_SIZE_WITH_PARENT
)

173  
NULL
;

176  
NULL
;

178 
i_pos
 = 
fid
->
i_pos_hi
;

179 
i_pos
 = (i_po << 32è| (
fid
->
i_pos_low
);

180 
šode
 = 
	`__çt_nfs_g‘_šode
(
sb
, 0, 
fid
->
i_g’
, 
i_pos
);

182  
	`d_obš_®Ÿs
(
šode
);

183 
	}
}

189 
d’Œy
 *
	$çt_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *fid,

190 
fh_Ën
, 
fh_ty³
)

192  
	`g’”ic_fh_to_·»Á
(
sb
, 
fid
, 
fh_Ën
, 
fh_ty³
,

193 
çt_nfs_g‘_šode
);

194 
	}
}

196 
d’Œy
 *
	$çt_fh_to_·»Á_no¡®e
(
su³r_block
 *
sb
,

197 
fid
 *
fh
, 
fh_Ën
,

198 
fh_ty³
)

200 
šode
 *šodð
NULL
;

201 
çt_fid
 *
fid
 = (çt_fid *)
fh
;

202 
loff_t
 
i_pos
;

204 ià(
fh_Ën
 < 
FAT_FID_SIZE_WITH_PARENT
)

205  
NULL
;

207 
fh_ty³
) {

208 
FILEID_FAT_WITH_PARENT
:

209 
i_pos
 = 
fid
->
·»Á_i_pos_hi
;

210 
i_pos
 = (i_po << 32è| (
fid
->
·»Á_i_pos_low
);

211 
šode
 = 
	`__çt_nfs_g‘_šode
(
sb
, 0, 
fid
->
·»Á_i_g’
, 
i_pos
);

215  
	`d_obš_®Ÿs
(
šode
);

216 
	}
}

223 
šode
 *
	$çt_»bužd_·»Á
(
su³r_block
 *
sb
, 
·»Á_log¡¬t
)

225 
£¬ch_þus
, 
þus_to_m©ch
;

226 
msdos_dœ_’Œy
 *
de
;

227 
šode
 *
·»Á
 = 
NULL
;

228 
šode
 *
dummy_g¿nd_·»Á
 = 
NULL
;

229 
çt_¦Ù_šfo
 
sšfo
;

230 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

231 
£ùÜ_t
 
blkÄ
 = 
	`çt_þus_to_blkÄ
(
sbi
, 
·»Á_log¡¬t
);

232 
bufãr_h—d
 *
·»Á_bh
 = 
	`sb_b»ad
(
sb
, 
blkÄ
);

233 ià(!
·»Á_bh
) {

234 
	`çt_msg
(
sb
, 
KERN_ERR
,

236  
NULL
;

239 
de
 = (
msdos_dœ_’Œy
 *è
·»Á_bh
->
b_d©a
;

240 
þus_to_m©ch
 = 
	`çt_g‘_¡¬t
(
sbi
, &
de
[0]);

241 
£¬ch_þus
 = 
	`çt_g‘_¡¬t
(
sbi
, &
de
[1]);

243 
dummy_g¿nd_·»Á
 = 
	`çt_dg‘
(
sb
, 
£¬ch_þus
);

244 ià(!
dummy_g¿nd_·»Á
) {

245 
dummy_g¿nd_·»Á
 = 
	`Ãw_šode
(
sb
);

246 ià(!
dummy_g¿nd_·»Á
) {

247 
	`b»l£
(
·»Á_bh
);

248  
·»Á
;

251 
dummy_g¿nd_·»Á
->
i_šo
 = 
	`iunique
(
sb
, 
MSDOS_ROOT_INO
);

252 
	`çt_fžl_šode
(
dummy_g¿nd_·»Á
, &
de
[1]);

253 
	`MSDOS_I
(
dummy_g¿nd_·»Á
)->
i_pos
 = -1;

256 ià(!
	`çt_sÿn_log¡¬t
(
dummy_g¿nd_·»Á
, 
þus_to_m©ch
, &
sšfo
))

257 
·»Á
 = 
	`çt_bužd_šode
(
sb
, 
sšfo
.
de
, sšfo.
i_pos
);

259 
	`b»l£
(
·»Á_bh
);

260 
	`ut
(
dummy_g¿nd_·»Á
);

262  
·»Á
;

263 
	}
}

271 
d’Œy
 *
	$çt_g‘_·»Á
(
d’Œy
 *
chžd_dœ
)

273 
su³r_block
 *
sb
 = 
chžd_dœ
->
d_sb
;

274 
bufãr_h—d
 *
bh
 = 
NULL
;

275 
msdos_dœ_’Œy
 *
de
;

276 
šode
 *
·»Á_šode
 = 
NULL
;

277 
msdos_sb_šfo
 *
sbi
 = 
	`MSDOS_SB
(
sb
);

279 ià(!
	`çt_g‘_dÙdÙ_’Œy
(
chžd_dœ
->
d_šode
, &
bh
, &
de
)) {

280 
·»Á_log¡¬t
 = 
	`çt_g‘_¡¬t
(
sbi
, 
de
);

281 
·»Á_šode
 = 
	`çt_dg‘
(
sb
, 
·»Á_log¡¬t
);

282 ià(!
·»Á_šode
 && 
sbi
->
ÝtiÚs
.
nfs
 =ð
FAT_NFS_NOSTALE_RO
)

283 
·»Á_šode
 = 
	`çt_»bužd_·»Á
(
sb
, 
·»Á_log¡¬t
);

285 
	`b»l£
(
bh
);

287  
	`d_obš_®Ÿs
(
·»Á_šode
);

288 
	}
}

290 cÚ¡ 
expÜt_Ý”©iÚs
 
	gçt_expÜt_Ýs
 = {

291 .
fh_to_d’Œy
 = 
çt_fh_to_d’Œy
,

292 .
	gfh_to_·»Á
 = 
çt_fh_to_·»Á
,

293 .
	gg‘_·»Á
 = 
çt_g‘_·»Á
,

296 cÚ¡ 
expÜt_Ý”©iÚs
 
	gçt_expÜt_Ýs_no¡®e
 = {

297 .
’code_fh
 = 
çt_’code_fh_no¡®e
,

298 .
	gfh_to_d’Œy
 = 
çt_fh_to_d’Œy_no¡®e
,

299 .
	gfh_to_·»Á
 = 
çt_fh_to_·»Á_no¡®e
,

300 .
	gg‘_·»Á
 = 
çt_g‘_·»Á
,

	@vfat.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

7 
moduË
 
__this_moduË


8 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

9 .
Çme
 = 
KBUILD_MODNAME
,

10 .
	gš™
 = 
š™_moduË
,

11 #ifdeà
CONFIG_MODULE_UNLOAD


12 .
	gex™
 = 
þ—nup_moduË
,

14 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

17 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

18 
__u£d


19 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

20 { 0x1da0d6ÿ, 
__VMLINUX_SYMBOL_STR
(
moduË_Ïyout
) },

21 { 0x54554948, 
__VMLINUX_SYMBOL_STR
(
kobjeù_put
) },

22 { 0x7b99eb2f, 
__VMLINUX_SYMBOL_STR
(
çt_d‘ach
) },

23 { 0xã6823e6, 
__VMLINUX_SYMBOL_STR
(
km®loc_ÿches
) },

24 { 0x405c1144, 
__VMLINUX_SYMBOL_STR
(
g‘_£cÚds
) },

25 { 0x11e0e337, 
__VMLINUX_SYMBOL_STR
(
drÝ_Æšk
) },

26 { 0xa675804c, 
__VMLINUX_SYMBOL_STR
(
utf8s_to_utf16s
) },

27 { 0x343ff613, 
__VMLINUX_SYMBOL_STR
(
m¬k_bufãr_dœty_šode
) },

28 { 0xd6fbe4ç, 
__VMLINUX_SYMBOL_STR
(
__m¬k_šode_dœty
) },

29 { 0xad¯be1b, 
__VMLINUX_SYMBOL_STR
(
pv_lock_Ýs
) },

30 { 0xe69f429b, 
__VMLINUX_SYMBOL_STR
(
dput
) },

31 { 0xûe11ccc, 
__VMLINUX_SYMBOL_STR
(
šc_Æšk
) },

32 { 0x8b486917, 
__VMLINUX_SYMBOL_STR
(
d_fšd_®Ÿs
) },

33 { 0xb1bf412a, 
__VMLINUX_SYMBOL_STR
(
Çmes_ÿch•
) },

34 { 0xe48e40c2, 
__VMLINUX_SYMBOL_STR
(
mu‹x_uÆock
) },

35 { 0x71ç22b6, 
__VMLINUX_SYMBOL_STR
(
mouÁ_bdev
) },

36 { 0xa973be29, 
__VMLINUX_SYMBOL_STR
(
çt_sync_šode
) },

37 { 0x9ded188e, 
__VMLINUX_SYMBOL_STR
(
kobjeù_d–
) },

38 { 0x5f044076, 
__VMLINUX_SYMBOL_STR
(
çt_add_’Œ›s
) },

39 { 0xb98b80fd, 
__VMLINUX_SYMBOL_STR
(
sysfs_»move_group
) },

40 { 0x7d11c268, 
__VMLINUX_SYMBOL_STR
(
jiff›s
) },

41 { 0x4717«d7, 
__VMLINUX_SYMBOL_STR
(
çt_»move_’Œ›s
) },

42 { 0xecc3c7d7, 
__VMLINUX_SYMBOL_STR
(
kobjeù_ü—‹_ªd_add
) },

43 { 0xf65d7f98, 
__VMLINUX_SYMBOL_STR
(
çt_®loc_Ãw_dœ
) },

44 { 0x4502602a, 
__VMLINUX_SYMBOL_STR
(
çt_fžl_su³r
) },

45 { 0x19ed1f80, 
__VMLINUX_SYMBOL_STR
(
çt_bužd_šode
) },

46 { 0x11089ac7, 
__VMLINUX_SYMBOL_STR
(
_ùy³
) },

47 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
´štk
) },

48 { 0x20c55«0, 
__VMLINUX_SYMBOL_STR
(
ssÿnf
) },

49 { 0xf1448f3a, 
__VMLINUX_SYMBOL_STR
(
sysfs_ü—‹_group
) },

50 { 0x604ã828, 
__VMLINUX_SYMBOL_STR
(
çt_©ch
) },

51 { 0xa1c4c12, 
__VMLINUX_SYMBOL_STR
(
d_move
) },

52 { 0x5a921311, 
__VMLINUX_SYMBOL_STR
(
¡ºcmp
) },

53 { 0x626ac375, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_ä“
) },

54 { 0xf676ffba, 
__VMLINUX_SYMBOL_STR
(
mu‹x_lock
) },

55 { 0xa7190c66, 
__VMLINUX_SYMBOL_STR
(
£t_Æšk
) },

56 { 0x“b684a5, 
__VMLINUX_SYMBOL_STR
(
çt_upd©e_su³r
) },

57 { 0x29009cbb, 
__VMLINUX_SYMBOL_STR
(
sync_dœty_bufãr
) },

58 { 0xe2338745, 
__VMLINUX_SYMBOL_STR
(
çt_g‘©Œ
) },

59 { 0x4¯4713, 
__VMLINUX_SYMBOL_STR
(
__b»l£
) },

60 { 0x5590a034, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc
) },

61 { 0xe9011563, 
__VMLINUX_SYMBOL_STR
(
fs_kobj
) },

62 { 0xf0fdf6cb, 
__VMLINUX_SYMBOL_STR
(
__¡ack_chk_çž
) },

63 { 0xfc77c68f, 
__VMLINUX_SYMBOL_STR
(
kžl_block_su³r
) },

64 { 0x359df40c, 
__VMLINUX_SYMBOL_STR
(
çt_£¬ch_lÚg
) },

65 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__ãÁry__
) },

66 { 0xb01d8a79, 
__VMLINUX_SYMBOL_STR
(
çt_cÚfig_š™
) },

67 { 0x6f20960a, 
__VMLINUX_SYMBOL_STR
(
fuÎ_Çme_hash
) },

68 { 0x721679¯, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc_Œaû
) },

69 { 0xd52bf1û, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_lock
) },

70 { 0x“6ba18e, 
__VMLINUX_SYMBOL_STR
(
çt_sÿn
) },

71 { 0xcc6b3a62, 
__VMLINUX_SYMBOL_STR
(
»gi¡”_fžesy¡em
) },

72 { 0x3bf18c78, 
__VMLINUX_SYMBOL_STR
(
__çt_fs_”rÜ
) },

73 { 0x1cd1ba02, 
__VMLINUX_SYMBOL_STR
(
ut
) },

74 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
kä“
) },

75 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
memýy
) },

76 { 0xa03164af, 
__VMLINUX_SYMBOL_STR
(
d_¥liû_®Ÿs
) },

77 { 0x6cba5ba3, 
__VMLINUX_SYMBOL_STR
(
çt_£‰r
) },

78 { 0xc4b795b4, 
__VMLINUX_SYMBOL_STR
(
çt_ä“_þu¡”s
) },

79 { 0x3a943293, 
__VMLINUX_SYMBOL_STR
(
çt_g‘_dÙdÙ_’Œy
) },

80 { 0xe6366e14, 
__VMLINUX_SYMBOL_STR
(
uÄegi¡”_fžesy¡em
) },

81 { 0xbdb6e637, 
__VMLINUX_SYMBOL_STR
(
çt_time_unix2çt
) },

82 { 0x28318305, 
__VMLINUX_SYMBOL_STR
(
¢´štf
) },

83 { 0xc60e0af5, 
__VMLINUX_SYMBOL_STR
(
çt_dœ_em±y
) },

84 { 0xcc709d8a, 
__VMLINUX_SYMBOL_STR
(
d_š¡ªtŸ‹
) },

85 { 0x—06e503, 
__VMLINUX_SYMBOL_STR
(
þ—r_Æšk
) },

88 cÚ¡ 
	g__moduË_d•’ds
[]

89 
__u£d


90 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

94 
MODULE_INFO
(
¤cv”siÚ
, "48E176712E7496AB16F5867");

	@/usr/include/linux/capability.h

13 #iâdeà
_LINUX_CAPABILITY_H


14 
	#_LINUX_CAPABILITY_H


	)

16 
	~<lšux/ty³s.h
>

18 
	gsk_¡ruù
;

31 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

32 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

34 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

35 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

37 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

38 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

40 
	s__u£r_ÿp_h—d”_¡ruù
 {

41 
__u32
 
	mv”siÚ
;

42 
	mpid
;

43 } *
	tÿp_u£r_h—d”_t
;

45 
	s__u£r_ÿp_d©a_¡ruù
 {

46 
__u32
 
	mefãùive
;

47 
__u32
 
	m³rm™‹d
;

48 
__u32
 
	mšh”™abË
;

49 } *
	tÿp_u£r_d©a_t
;

52 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

53 
	#VFS_CAP_REVISION_SHIFT
 24

	)

54 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

55 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

57 
	#VFS_CAP_REVISION_1
 0x01000000

	)

58 
	#VFS_CAP_U32_1
 1

	)

59 
	#XATTR_CAPS_SZ_1
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

61 
	#VFS_CAP_REVISION_2
 0x02000000

	)

62 
	#VFS_CAP_U32_2
 2

	)

63 
	#XATTR_CAPS_SZ_2
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

65 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_2


	)

66 
	#VFS_CAP_U32
 
VFS_CAP_U32_2


	)

67 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_2


	)

69 
	svfs_ÿp_d©a
 {

70 
__Ë32
 
	mmagic_‘c
;

72 
__Ë32
 
	m³rm™‹d
;

73 
__Ë32
 
	mšh”™abË
;

74 } 
	md©a
[
VFS_CAP_U32
];

83 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

84 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

96 
	#CAP_CHOWN
 0

	)

102 
	#CAP_DAC_OVERRIDE
 1

	)

108 
	#CAP_DAC_READ_SEARCH
 2

	)

114 
	#CAP_FOWNER
 3

	)

123 
	#CAP_FSETID
 4

	)

129 
	#CAP_KILL
 5

	)

135 
	#CAP_SETGID
 6

	)

140 
	#CAP_SETUID
 7

	)

157 
	#CAP_SETPCAP
 8

	)

161 
	#CAP_LINUX_IMMUTABLE
 9

	)

166 
	#CAP_NET_BIND_SERVICE
 10

	)

170 
	#CAP_NET_BROADCAST
 11

	)

186 
	#CAP_NET_ADMIN
 12

	)

192 
	#CAP_NET_RAW
 13

	)

198 
	#CAP_IPC_LOCK
 14

	)

202 
	#CAP_IPC_OWNER
 15

	)

205 
	#CAP_SYS_MODULE
 16

	)

210 
	#CAP_SYS_RAWIO
 17

	)

214 
	#CAP_SYS_CHROOT
 18

	)

218 
	#CAP_SYS_PTRACE
 19

	)

222 
	#CAP_SYS_PACCT
 20

	)

261 
	#CAP_SYS_ADMIN
 21

	)

265 
	#CAP_SYS_BOOT
 22

	)

274 
	#CAP_SYS_NICE
 23

	)

288 
	#CAP_SYS_RESOURCE
 24

	)

294 
	#CAP_SYS_TIME
 25

	)

299 
	#CAP_SYS_TTY_CONFIG
 26

	)

303 
	#CAP_MKNOD
 27

	)

307 
	#CAP_LEASE
 28

	)

309 
	#CAP_AUDIT_WRITE
 29

	)

311 
	#CAP_AUDIT_CONTROL
 30

	)

313 
	#CAP_SETFCAP
 31

	)

321 
	#CAP_MAC_OVERRIDE
 32

	)

330 
	#CAP_MAC_ADMIN
 33

	)

334 
	#CAP_SYSLOG
 34

	)

338 
	#CAP_WAKE_ALARM
 35

	)

342 
	#CAP_BLOCK_SUSPEND
 36

	)

344 
	#CAP_LAST_CAP
 
CAP_BLOCK_SUSPEND


	)

346 
	#ÿp_v®id
(
x
è((xè>ð0 && (xè<ð
CAP_LAST_CAP
)

	)

352 
	#CAP_TO_INDEX
(
x
è((xè>> 5è

	)

353 
	#CAP_TO_MASK
(
x
è(1 << ((xè& 31)è

	)

	@/usr/include/linux/fs.h

1 #iâdeà
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<lšux/lim™s.h
>

10 
	~<lšux/ioùl.h
>

11 
	~<lšux/ty³s.h
>

24 #undeà
NR_OPEN


25 
	#INR_OPEN_CUR
 1024

	)

26 
	#INR_OPEN_MAX
 4096

	)

28 
	#BLOCK_SIZE_BITS
 10

	)

29 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

31 
	#SEEK_SET
 0

	)

32 
	#SEEK_CUR
 1

	)

33 
	#SEEK_END
 2

	)

34 
	#SEEK_DATA
 3

	)

35 
	#SEEK_HOLE
 4

	)

36 
	#SEEK_MAX
 
SEEK_HOLE


	)

38 
	sf¡rim_¿nge
 {

39 
__u64
 
	m¡¬t
;

40 
__u64
 
	mËn
;

41 
__u64
 
	mmšËn
;

45 
	sfžes_¡©_¡ruù
 {

46 
	mÄ_fžes
;

47 
	mÄ_ä“_fžes
;

48 
	mmax_fžes
;

51 
	sšodes_¡©_t
 {

52 
	mÄ_šodes
;

53 
	mÄ_unu£d
;

54 
	mdummy
[5];

58 
	#NR_FILE
 8192

	)

64 
	#MS_RDONLY
 1

	)

65 
	#MS_NOSUID
 2

	)

66 
	#MS_NODEV
 4

	)

67 
	#MS_NOEXEC
 8

	)

68 
	#MS_SYNCHRONOUS
 16

	)

69 
	#MS_REMOUNT
 32

	)

70 
	#MS_MANDLOCK
 64

	)

71 
	#MS_DIRSYNC
 128

	)

72 
	#MS_NOATIME
 1024

	)

73 
	#MS_NODIRATIME
 2048

	)

74 
	#MS_BIND
 4096

	)

75 
	#MS_MOVE
 8192

	)

76 
	#MS_REC
 16384

	)

77 
	#MS_VERBOSE
 32768

	)

79 
	#MS_SILENT
 32768

	)

80 
	#MS_POSIXACL
 (1<<16è

	)

81 
	#MS_UNBINDABLE
 (1<<17è

	)

82 
	#MS_PRIVATE
 (1<<18è

	)

83 
	#MS_SLAVE
 (1<<19è

	)

84 
	#MS_SHARED
 (1<<20è

	)

85 
	#MS_RELATIME
 (1<<21è

	)

86 
	#MS_KERNMOUNT
 (1<<22è

	)

87 
	#MS_I_VERSION
 (1<<23è

	)

88 
	#MS_STRICTATIME
 (1<<24è

	)

91 
	#MS_NOSEC
 (1<<28)

	)

92 
	#MS_BORN
 (1<<29)

	)

93 
	#MS_ACTIVE
 (1<<30)

	)

94 
	#MS_NOUSER
 (1<<31)

	)

99 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
)

	)

104 
	#MS_MGC_VAL
 0xC0ED0000

	)

105 
	#MS_MGC_MSK
 0xffff0000

	)

110 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

111 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

112 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

113 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

114 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

115 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

116 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

117 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

118 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

119 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

120 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

121 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

123 
	#BLKPG
 
	`_IO
(0x12,105)

	)

127 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

128 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

133 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

134 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

135 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

136 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

137 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

138 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

139 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

140 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

141 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

142 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

143 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

144 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

145 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

146 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

147 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

148 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

150 
	#BMAP_IOCTL
 1

	)

151 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

152 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

153 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

154 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

155 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

157 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

158 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

159 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

160 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

161 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

162 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

163 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

164 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

165 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

170 
	#FS_SECRM_FL
 0x00000001

	)

171 
	#FS_UNRM_FL
 0x00000002

	)

172 
	#FS_COMPR_FL
 0x00000004

	)

173 
	#FS_SYNC_FL
 0x00000008

	)

174 
	#FS_IMMUTABLE_FL
 0x00000010

	)

175 
	#FS_APPEND_FL
 0x00000020

	)

176 
	#FS_NODUMP_FL
 0x00000040

	)

177 
	#FS_NOATIME_FL
 0x00000080

	)

179 
	#FS_DIRTY_FL
 0x00000100

	)

180 
	#FS_COMPRBLK_FL
 0x00000200

	)

181 
	#FS_NOCOMP_FL
 0x00000400

	)

182 
	#FS_ECOMPR_FL
 0x00000800

	)

184 
	#FS_BTREE_FL
 0x00001000

	)

185 
	#FS_INDEX_FL
 0x00001000

	)

186 
	#FS_IMAGIC_FL
 0x00002000

	)

187 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

188 
	#FS_NOTAIL_FL
 0x00008000

	)

189 
	#FS_DIRSYNC_FL
 0x00010000

	)

190 
	#FS_TOPDIR_FL
 0x00020000

	)

191 
	#FS_EXTENT_FL
 0x00080000

	)

192 
	#FS_DIRECTIO_FL
 0x00100000

	)

193 
	#FS_NOCOW_FL
 0x00800000

	)

194 
	#FS_RESERVED_FL
 0x80000000

	)

196 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

197 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

200 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

201 
	#SYNC_FILE_RANGE_WRITE
 2

	)

202 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/kernel.h

1 #iâdeà
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<lšux/sysšfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`ty³of
(x))×è- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

	@/usr/include/linux/msdos_fs.h

1 #iâdeà
_LINUX_MSDOS_FS_H


2 
	#_LINUX_MSDOS_FS_H


	)

4 
	~<lšux/ty³s.h
>

5 
	~<lšux/magic.h
>

6 
	~<asm/by‹Üd”.h
>

12 
	#SECTOR_SIZE
 512

	)

13 
	#SECTOR_BITS
 9

	)

14 
	#MSDOS_DPB
 (
MSDOS_DPS
è

	)

15 
	#MSDOS_DPB_BITS
 4

	)

16 
	#MSDOS_DPS
 (
SECTOR_SIZE
 / (
msdos_dœ_’Œy
))

	)

17 
	#MSDOS_DPS_BITS
 4

	)

18 
	#MSDOS_LONGNAME
 256

	)

19 
	#CF_LE_W
(
v
è
	`Ë16_to_ýu
(v)

	)

20 
	#CF_LE_L
(
v
è
	`Ë32_to_ýu
(v)

	)

21 
	#CT_LE_W
(
v
è
	`ýu_to_Ë16
(v)

	)

22 
	#CT_LE_L
(
v
è
	`ýu_to_Ë32
(v)

	)

24 
	#MSDOS_ROOT_INO
 1

	)

25 
	#MSDOS_FSINFO_INO
 2

	)

27 
	#MSDOS_DIR_BITS
 5

	)

30 
	#FAT_MAX_DIR_ENTRIES
 (65536)

	)

31 
	#FAT_MAX_DIR_SIZE
 (
FAT_MAX_DIR_ENTRIES
 << 
MSDOS_DIR_BITS
)

	)

33 
	#ATTR_NONE
 0

	)

34 
	#ATTR_RO
 1

	)

35 
	#ATTR_HIDDEN
 2

	)

36 
	#ATTR_SYS
 4

	)

37 
	#ATTR_VOLUME
 8

	)

38 
	#ATTR_DIR
 16

	)

39 
	#ATTR_ARCH
 32

	)

42 
	#ATTR_UNUSED
 (
ATTR_VOLUME
 | 
ATTR_ARCH
 | 
ATTR_SYS
 | 
ATTR_HIDDEN
)

	)

44 
	#ATTR_EXT
 (
ATTR_RO
 | 
ATTR_HIDDEN
 | 
ATTR_SYS
 | 
ATTR_VOLUME
)

	)

46 
	#CASE_LOWER_BASE
 8

	)

47 
	#CASE_LOWER_EXT
 16

	)

49 
	#DELETED_FLAG
 0xe5

	)

50 
	#IS_FREE
(
n
è(!*Òè|| *Òè=ð
DELETED_FLAG
)

	)

52 
	#FAT_LFN_LEN
 255

	)

53 
	#MSDOS_NAME
 11

	)

54 
	#MSDOS_SLOTS
 21

	)

55 
	#MSDOS_DOT
 ". "

	)

56 
	#MSDOS_DOTDOT
 ".. "

	)

58 
	#FAT_FIRST_ENT
(
s
, 
x
è((
	`MSDOS_SB
(s)->
çt_b™s
 == 32 ? 0x0FFFFF00 : \

59 
	`MSDOS_SB
(
s
)->
çt_b™s
 =ð16 ? 0xFF00 : 0xF00è| (
x
))

	)

62 
	#FAT_START_ENT
 2

	)

65 
	#MAX_FAT12
 0xFF4

	)

66 
	#MAX_FAT16
 0xFFF4

	)

67 
	#MAX_FAT32
 0x0FFFFFF6

	)

68 
	#MAX_FAT
(
s
è(
	`MSDOS_SB
(s)->
çt_b™s
 =ð32 ? 
MAX_FAT32
 : \

69 
	`MSDOS_SB
(
s
)->
çt_b™s
 =ð16 ? 
MAX_FAT16
 : 
MAX_FAT12
)

	)

72 
	#BAD_FAT12
 0xFF7

	)

73 
	#BAD_FAT16
 0xFFF7

	)

74 
	#BAD_FAT32
 0x0FFFFFF7

	)

77 
	#EOF_FAT12
 0xFFF

	)

78 
	#EOF_FAT16
 0xFFFF

	)

79 
	#EOF_FAT32
 0x0FFFFFFF

	)

81 
	#FAT_ENT_FREE
 (0)

	)

82 
	#FAT_ENT_BAD
 (
BAD_FAT32
)

	)

83 
	#FAT_ENT_EOF
 (
EOF_FAT32
)

	)

85 
	#FAT_FSINFO_SIG1
 0x41615252

	)

86 
	#FAT_FSINFO_SIG2
 0x61417272

	)

87 
	#IS_FSINFO
(
x
è(
	`Ë32_to_ýu
((x)->
sigÇtu»1
è=ð
FAT_FSINFO_SIG1
 \

88 && 
	`Ë32_to_ýu
((
x
)->
sigÇtu»2
è=ð
FAT_FSINFO_SIG2
)

	)

90 
	#FAT_STATE_DIRTY
 0x01

	)

92 
	s__çt_dœ’t
 {

93 
	md_šo
;

94 
__k”Ãl_off_t
 
	md_off
;

95 
	md_»þ’
;

96 
	md_Çme
[256];

102 
	#VFAT_IOCTL_READDIR_BOTH
 
	`_IOR
('r', 1, 
__çt_dœ’t
[2])

	)

103 
	#VFAT_IOCTL_READDIR_SHORT
 
	`_IOR
('r', 2, 
__çt_dœ’t
[2])

	)

105 
	#FAT_IOCTL_GET_ATTRIBUTES
 
	`_IOR
('r', 0x10, 
__u32
)

	)

106 
	#FAT_IOCTL_SET_ATTRIBUTES
 
	`_IOW
('r', 0x11, 
__u32
)

	)

108 
	#FAT_IOCTL_GET_VOLUME_ID
 
	`_IOR
('r', 0x13, 
__u32
)

	)

110 
	sçt_boÙ_£ùÜ
 {

111 
__u8
 
	mignÜed
[3];

112 
__u8
 
	msy¡em_id
[8];

114 
__u8
 
	m£ùÜ_size
[2];

115 
__u8
 
	m£c_³r_þus
;

116 
__Ë16
 
	m»£rved
;

117 
__u8
 
	mçts
;

118 
__u8
 
	mdœ_’Œ›s
[2];

119 
__u8
 
	m£ùÜs
[2];

120 
__u8
 
	mmedŸ
;

121 
__Ë16
 
	mçt_Ëngth
;

122 
__Ë16
 
	m£cs_Œack
;

123 
__Ë16
 
	mh—ds
;

124 
__Ë32
 
	mhidd’
;

125 
__Ë32
 
	mtÙ®_£ù
;

130 
__u8
 
	mdrive_numb”
;

131 
__u8
 
	m¡©e
;

133 
__u8
 
	msigÇtu»
;

134 
__u8
 
	mvÞ_id
[4];

135 
__u8
 
	mvÞ_Ïb–
[11];

136 
__u8
 
	mfs_ty³
[8];

138 } 
	mçt16
;

142 
__Ë32
 
	mËngth
;

143 
__Ë16
 
	mæags
;

145 
__u8
 
	mv”siÚ
[2];

147 
__Ë32
 
	mroÙ_þu¡”
;

149 
__Ë16
 
	mšfo_£ùÜ
;

150 
__Ë16
 
	mbackup_boÙ
;

151 
__Ë16
 
	m»£rved2
[6];

153 
__u8
 
	mdrive_numb”
;

154 
__u8
 
	m¡©e
;

156 
__u8
 
	msigÇtu»
;

157 
__u8
 
	mvÞ_id
[4];

158 
__u8
 
	mvÞ_Ïb–
[11];

159 
__u8
 
	mfs_ty³
[8];

161 } 
	mçt32
;

165 
	sçt_boÙ_fsšfo
 {

166 
__Ë32
 
	msigÇtu»1
;

167 
__Ë32
 
	m»£rved1
[120];

168 
__Ë32
 
	msigÇtu»2
;

169 
__Ë32
 
	mä“_þu¡”s
;

170 
__Ë32
 
	mÃxt_þu¡”
;

171 
__Ë32
 
	m»£rved2
[4];

174 
	smsdos_dœ_’Œy
 {

175 
__u8
 
	mÇme
[
MSDOS_NAME
];

176 
__u8
 
	m©Œ
;

177 
__u8
 
	mlÿ£
;

178 
__u8
 
	mùime_cs
;

179 
__Ë16
 
	mùime
;

180 
__Ë16
 
	mcd©e
;

181 
__Ë16
 
	mad©e
;

182 
__Ë16
 
	m¡¬thi
;

183 
__Ë16
 
	mtime
,
	md©e
,
	m¡¬t
;

184 
__Ë32
 
	msize
;

188 
	smsdos_dœ_¦Ù
 {

189 
__u8
 
	mid
;

190 
__u8
 
	mÇme0_4
[10];

191 
__u8
 
	m©Œ
;

192 
__u8
 
	m»£rved
;

193 
__u8
 
	m®Ÿs_checksum
;

194 
__u8
 
	mÇme5_10
[12];

195 
__Ë16
 
	m¡¬t
;

196 
__u8
 
	mÇme11_12
[4];

	@/usr/include/linux/string.h

1 #iâdeà
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

6 
	~<¡ršg.h
>

	@/usr/include/linux/time.h

1 #iâdeà
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	~<lšux/ty³s.h
>

7 #iâdeà
_STRUCT_TIMESPEC


8 
	#_STRUCT_TIMESPEC


	)

9 
	stime¥ec
 {

10 
__k”Ãl_time_t
 
	mtv_£c
;

11 
	mtv_n£c
;

15 
	stimev®
 {

16 
__k”Ãl_time_t
 
	mtv_£c
;

17 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

20 
	stimezÚe
 {

21 
	mtz_mšu‹swe¡
;

22 
	mtz_d¡time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	s™im”¥ec
 {

35 
time¥ec
 
	m™_š‹rv®
;

36 
time¥ec
 
	m™_v®ue
;

39 
	s™im”v®
 {

40 
timev®
 
	m™_š‹rv®
;

41 
timev®
 
	m™_v®ue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

57 
	#CLOCK_SGI_CYCLE
 10

	)

58 
	#CLOCK_TAI
 11

	)

60 
	#MAX_CLOCKS
 16

	)

61 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

62 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

67 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/uio.h

9 #iâdeà
__LINUX_UIO_H


10 
	#__LINUX_UIO_H


	)

13 
	~<lšux/ty³s.h
>

16 
	siovec


18 *
	miov_ba£
;

19 
__k”Ãl_size_t
 
	miov_Ën
;

26 
	#UIO_FASTIOV
 8

	)

27 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/ioctl.h

1 #iâdeà
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/ioùl.h
>

	@/usr/include/linux/limits.h

1 #iâdeà
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/magic.h

1 #iâdeà
__LINUX_MAGIC_H__


2 
	#__LINUX_MAGIC_H__


	)

4 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

5 
	#AFFS_SUPER_MAGIC
 0xadff

	)

6 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

7 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

8 
	#CODA_SUPER_MAGIC
 0x73757245

	)

9 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

10 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

11 
	#DEBUGFS_MAGIC
 0x64626720

	)

12 
	#SECURITYFS_MAGIC
 0x73636673

	)

13 
	#SELINUX_MAGIC
 0xf97cff8c

	)

14 
	#SMACK_MAGIC
 0x43415d53

	)

15 
	#RAMFS_MAGIC
 0x858458f6

	)

16 
	#TMPFS_MAGIC
 0x01021994

	)

17 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

18 
	#SQUASHFS_MAGIC
 0x73717368

	)

19 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

20 
	#EFS_SUPER_MAGIC
 0x414A53

	)

21 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

22 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

23 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

24 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

25 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

26 
	#NILFS_SUPER_MAGIC
 0x3434

	)

27 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

28 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

29 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

30 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

31 
	#PSTOREFS_MAGIC
 0x6165676C

	)

32 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

33 
	#HOSTFS_SUPER_MAGIC
 0x00c0fãe

	)

35 
	#MINIX_SUPER_MAGIC
 0x137F

	)

36 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

37 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

38 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

39 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

41 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

42 
	#NCP_SUPER_MAGIC
 0x564ø

	)

43 
	#NFS_SUPER_MAGIC
 0x6969

	)

44 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

45 
	#QNX4_SUPER_MAGIC
 0x002à

	)

46 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

48 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

51 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

52 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

53 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

55 
	#SMB_SUPER_MAGIC
 0x517B

	)

56 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

59 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

61 
	#V9FS_MAGIC
 0x01021997

	)

63 
	#BDEVFS_MAGIC
 0x62646576

	)

64 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

65 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

66 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

67 
	#PIPEFS_MAGIC
 0x50495045

	)

68 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

69 
	#SOCKFS_MAGIC
 0x534F434B

	)

70 
	#SYSFS_MAGIC
 0x62656572

	)

71 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

72 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

73 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

74 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

	@/usr/include/linux/sysinfo.h

1 #iâdeà
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<lšux/ty³s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysšfo
 {

8 
__k”Ãl_lÚg_t
 
	mu±ime
;

9 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

10 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

11 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

12 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

13 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

14 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

15 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

16 
__u16
 
	m´ocs
;

17 
__u16
 
	m·d
;

18 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

19 
__k”Ãl_ulÚg_t
 
	mä“high
;

20 
__u32
 
	mmem_un™
;

21 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

39 #ià
defšed
 
__ýlu¥lus
 && (__ýlu¥lu >ð199711L || 
__GNUC_PREREQ
 (4, 4))

40 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

44 
__BEGIN_NAMESPACE_STD


46 *
	$memýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

47 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

50 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

51 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

52 
__END_NAMESPACE_STD


57 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN


58 *
	$memcýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

59 
__c
, 
size_t
 
__n
)

60 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

64 
__BEGIN_NAMESPACE_STD


66 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

69 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

70 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

73 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


76 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

77 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

79 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ifdeà
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


85  
	`__bužtš_memchr
 (
__s
, 
__c
, 
__n
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


91  
	`__bužtš_memchr
 (
__s
, 
__c
, 
__n
);

94 
	}
}

96 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

99 
__END_NAMESPACE_STD


101 #ifdeà
__USE_GNU


104 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


105 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

106 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

107 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

108 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

110 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

111 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

115 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


116 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

117 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

118 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

119 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

121 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

122 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

127 
__BEGIN_NAMESPACE_STD


129 *
	$¡rýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

132 *
	$¡ºýy
 (*
__»¡riù
 
__de¡
,

133 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

137 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

138 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

141 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

144 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

145 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

151 
	$¡rcÞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

152 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

154 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

155 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

156 
__THROW
 
	`__nÚnuÎ
 ((2));

157 
__END_NAMESPACE_STD


159 #ifdeà
__USE_XOPEN2K8


163 
	~<xloÿË.h
>

166 
	$¡rcÞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

167 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

169 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

170 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

173 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 \

174 || 
defšed
 
__USE_XOPEN2K8


176 *
	$¡rdup
 (cÚ¡ *
__s
)

177 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_XOPEN2K8


184 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

185 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

188 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


190 
	#¡rdu·
(
s
) \

191 (
__ex‹nsiÚ__
 \

193 cÚ¡ *
__Þd
 = (
s
); \

194 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Þd
) + 1; \

195 *
__Ãw
 = (*è
	`__bužtš_®loÿ
 (
__Ën
); \

196 (*è
	`memýy
 (
__Ãw
, 
__Þd
, 
__Ën
); \

197 
	}
}))

	)

200 
	#¡ºdu·
(
s
, 
n
) \

201 (
__ex‹nsiÚ__
 \

203 cÚ¡ *
__Þd
 = (
s
); \

204 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Þd
, (
n
)); \

205 *
__Ãw
 = (*è
	`__bužtš_®loÿ
 (
__Ën
 + 1); \

206 
__Ãw
[
__Ën
] = '\0'; \

207 (*è
	`memýy
 (
__Ãw
, 
__Þd
, 
__Ën
); \

208 }))

	)

211 
	g__BEGIN_NAMESPACE_STD


213 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


216 *
¡rchr
 (*
__s
, 
__c
)

217 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

218 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

219 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

221 #ifdeà
__OPTIMIZE__


222 
__ex‹º_®ways_šlše
 *

223 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


225  
__bužtš_¡rchr
 (
__s
, 
__c
);

228 
__ex‹º_®ways_šlše
 const *

229 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


231  
__bužtš_¡rchr
 (
__s
, 
__c
);

236 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

237 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


243 *
	`¡¼chr
 (*
__s
, 
__c
)

244 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

245 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

246 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

248 #ifdeà
__OPTIMIZE__


249 
__ex‹º_®ways_šlše
 *

250 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


252  
	`__bužtš_¡¼chr
 (
__s
, 
__c
);

255 
__ex‹º_®ways_šlše
 const *

256 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


258  
	`__bužtš_¡¼chr
 (
__s
, 
__c
);

261 
	}
}

263 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

264 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

266 
__END_NAMESPACE_STD


268 #ifdeà
__USE_GNU


271 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


272 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

273 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

274 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

275 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

278 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

282 
__BEGIN_NAMESPACE_STD


285 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

286 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

289 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

290 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


295 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

296 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

297 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

298 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

300 #ifdeà
__OPTIMIZE__


301 
__ex‹º_®ways_šlše
 *

302 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


304  
	`__bužtš_¡½brk
 (
__s
, 
__acû±
);

307 
__ex‹º_®ways_šlše
 const *

308 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


310  
	`__bužtš_¡½brk
 (
__s
, 
__acû±
);

313 
	}
}

315 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

316 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


322 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

323 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

324 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

325 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

327 #ifdeà
__OPTIMIZE__


328 
__ex‹º_®ways_šlše
 *

329 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


331  
	`__bužtš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

334 
__ex‹º_®ways_šlše
 const *

335 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


337  
	`__bužtš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

340 
	}
}

342 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

343 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

348 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

349 
__THROW
 
	`__nÚnuÎ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

355 cÚ¡ *
__»¡riù
 
__d–im
,

356 **
__»¡riù
 
__§ve_±r
)

357 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

358 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


359 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

360 **
__»¡riù
 
__§ve_±r
)

361 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

364 #ifdeà
__USE_GNU


366 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

368 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

369 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

370 cÚ¡ *
__ÃedË
)

371 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

374 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

378 #ifdeà
__USE_GNU


382 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

383 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

384 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

388 *
	$__mempýy
 (*
__»¡riù
 
__de¡
,

389 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

390 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

391 *
	$mempýy
 (*
__»¡riù
 
__de¡
,

392 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

393 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

400 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

407 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

414 
__END_NAMESPACE_STD


415 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_MISC


423 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


426 #ifdeà
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

428 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

429 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

431 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

433 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

438 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

439 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

443 #ifdeà
__USE_XOPEN2K8


445 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

451 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

453 #ifdeà
__USE_BSD


455 
	$bcÝy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

462 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

466 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`šdex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

471 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

474 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__ex‹º_®ways_šlše
 *

476 
	`šdex
 (*
__s
, 
__c
è
__THROW


478  
	`__bužtš_šdex
 (
__s
, 
__c
);

481 
__ex‹º_®ways_šlše
 const *

482 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


484  
	`__bužtš_šdex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

490 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`ršdex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

499 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

502 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__ex‹º_®ways_šlše
 *

504 
	`ršdex
 (*
__s
, 
__c
è
__THROW


506  
	`__bužtš_ršdex
 (
__s
, 
__c
);

509 
__ex‹º_®ways_šlše
 const *

510 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


512  
	`__bužtš_ršdex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

518 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

523 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

527 #ifdef 
__USE_GNU


528 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

530 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

534 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

535 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

538 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

539 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

542 #ifdef 
__USE_GNU


545 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

546 
__loÿË_t
 
__loc
)

547 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

549 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

550 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

551 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

554 #ifdef 
__USE_BSD


557 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

558 cÚ¡ *
__»¡riù
 
__d–im
)

559 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

562 #ifdef 
__USE_XOPEN2K8


564 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

567 *
	$__¡pýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

568 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$¡pýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

570 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

574 *
	$__¡²ýy
 (*
__»¡riù
 
__de¡
,

575 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

576 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 *
	$¡²ýy
 (*
__»¡riù
 
__de¡
,

578 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

579 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

582 #ifdef 
__USE_GNU


584 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

585 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

588 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

591 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

593 #iâdeà
ba£Çme


598 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


599 "C++" *
	$ba£Çme
 (*
__fž’ame
)

600 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

601 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__fž’ame
)

602 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

604 *
	$ba£Çme
 (cÚ¡ *
__fž’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

610 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

611 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

612 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ýlu¥lus


632 
	~<b™s/¡ršg.h
>

635 
	~<b™s/¡ršg2.h
>

638 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


640 
	~<b™s/¡ršg3.h
>

644 
__END_DECLS


	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

101 #undeà
__USE_ISOC11


102 #undeà
__USE_ISOC99


103 #undeà
__USE_ISOC95


104 #undeà
__USE_ISOCXX11


105 #undeà
__USE_POSIX


106 #undeà
__USE_POSIX2


107 #undeà
__USE_POSIX199309


108 #undeà
__USE_POSIX199506


109 #undeà
__USE_XOPEN


110 #undeà
__USE_XOPEN_EXTENDED


111 #undeà
__USE_UNIX98


112 #undeà
__USE_XOPEN2K


113 #undeà
__USE_XOPEN2KXSI


114 #undeà
__USE_XOPEN2K8


115 #undeà
__USE_XOPEN2K8XSI


116 #undeà
__USE_LARGEFILE


117 #undeà
__USE_LARGEFILE64


118 #undeà
__USE_FILE_OFFSET64


119 #undeà
__USE_BSD


120 #undeà
__USE_SVID


121 #undeà
__USE_MISC


122 #undeà
__USE_ATFILE


123 #undeà
__USE_GNU


124 #undeà
__USE_REENTRANT


125 #undeà
__USE_FORTIFY_LEVEL


126 #undeà
__KERNEL_STRICT_NAMES


130 #iâdeà
_LOOSE_KERNEL_NAMES


131 
	#__KERNEL_STRICT_NAMES


	)

141 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


142 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

143 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ð((
maj
è<< 16è+ (
mš
))

	)

145 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

150 #ifdeà
_GNU_SOURCE


151 #undeà
_ISOC95_SOURCE


152 
	#_ISOC95_SOURCE
 1

	)

153 #undeà
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #undeà
_ISOC11_SOURCE


156 
	#_ISOC11_SOURCE
 1

	)

157 #undeà
_POSIX_SOURCE


158 
	#_POSIX_SOURCE
 1

	)

159 #undeà
_POSIX_C_SOURCE


160 
	#_POSIX_C_SOURCE
 200809L

	)

161 #undeà
_XOPEN_SOURCE


162 
	#_XOPEN_SOURCE
 700

	)

163 #undeà
_XOPEN_SOURCE_EXTENDED


164 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

165 #undeà
_LARGEFILE64_SOURCE


166 
	#_LARGEFILE64_SOURCE
 1

	)

167 #undeà
_DEFAULT_SOURCE


168 
	#_DEFAULT_SOURCE
 1

	)

169 #undeà
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #undeà
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #undeà
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #ià(
defšed
 
_DEFAULT_SOURCE
 \

180 || (!
defšed
 
	g__STRICT_ANSI__
 \

181 && !
defšed
 
	g_ISOC99_SOURCE
 \

182 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

183 && !
defšed
 
	g_XOPEN_SOURCE
 \

184 && !
defšed
 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
))

185 #undeà
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

187 #undeà
_BSD_SOURCE


188 
	#_BSD_SOURCE
 1

	)

189 #undeà
_SVID_SOURCE


190 
	#_SVID_SOURCE
 1

	)

194 #ià(
defšed
 
_ISOC11_SOURCE
 \

195 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

196 
	#__USE_ISOC11
 1

	)

200 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

201 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

202 
	#__USE_ISOC99
 1

	)

206 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

207 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

208 
	#__USE_ISOC95
 1

	)

215 #ià((
defšed
 
__ýlu¥lus
 && __cplusplus >= 201103L) \

216 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

217 
	#__USE_ISOCXX11
 1

	)

223 #ifdeà
_DEFAULT_SOURCE


224 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


225 
	#__USE_POSIX_IMPLICITLY
 1

	)

227 #undeà
_POSIX_SOURCE


228 
	#_POSIX_SOURCE
 1

	)

229 #undeà
_POSIX_C_SOURCE


230 
	#_POSIX_C_SOURCE
 200809L

	)

232 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

233 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

234 
	#_POSIX_SOURCE
 1

	)

235 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

236 
	#_POSIX_C_SOURCE
 2

	)

237 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

238 
	#_POSIX_C_SOURCE
 199506L

	)

239 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

240 
	#_POSIX_C_SOURCE
 200112L

	)

242 
	#_POSIX_C_SOURCE
 200809L

	)

244 
	#__USE_POSIX_IMPLICITLY
 1

	)

247 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ð1 || defšed 
_XOPEN_SOURCE


248 
	#__USE_POSIX
 1

	)

251 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ð2 || defšed 
_XOPEN_SOURCE


252 
	#__USE_POSIX2
 1

	)

255 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

256 
	#__USE_POSIX199309
 1

	)

259 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

260 
	#__USE_POSIX199506
 1

	)

263 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

264 
	#__USE_XOPEN2K
 1

	)

265 #undeà
__USE_ISOC95


266 
	#__USE_ISOC95
 1

	)

267 #undeà
__USE_ISOC99


268 
	#__USE_ISOC99
 1

	)

271 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

272 
	#__USE_XOPEN2K8
 1

	)

273 #undeà
_ATFILE_SOURCE


274 
	#_ATFILE_SOURCE
 1

	)

277 #ifdef 
_XOPEN_SOURCE


278 
	#__USE_XOPEN
 1

	)

279 #ià(
_XOPEN_SOURCE
 - 0) >= 500

280 
	#__USE_XOPEN_EXTENDED
 1

	)

281 
	#__USE_UNIX98
 1

	)

282 #undeà
_LARGEFILE_SOURCE


283 
	#_LARGEFILE_SOURCE
 1

	)

284 #ià(
_XOPEN_SOURCE
 - 0) >= 600

285 #ià(
_XOPEN_SOURCE
 - 0) >= 700

286 
	#__USE_XOPEN2K8
 1

	)

287 
	#__USE_XOPEN2K8XSI
 1

	)

289 
	#__USE_XOPEN2K
 1

	)

290 
	#__USE_XOPEN2KXSI
 1

	)

291 #undeà
__USE_ISOC95


292 
	#__USE_ISOC95
 1

	)

293 #undeà
__USE_ISOC99


294 
	#__USE_ISOC99
 1

	)

297 #ifdeà
_XOPEN_SOURCE_EXTENDED


298 
	#__USE_XOPEN_EXTENDED
 1

	)

303 #ifdeà
_LARGEFILE_SOURCE


304 
	#__USE_LARGEFILE
 1

	)

307 #ifdeà
_LARGEFILE64_SOURCE


308 
	#__USE_LARGEFILE64
 1

	)

311 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

312 
	#__USE_FILE_OFFSET64
 1

	)

315 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


316 
	#__USE_MISC
 1

	)

319 #ifdef 
_BSD_SOURCE


320 
	#__USE_BSD
 1

	)

323 #ifdef 
_SVID_SOURCE


324 
	#__USE_SVID
 1

	)

327 #ifdef 
_ATFILE_SOURCE


328 
	#__USE_ATFILE
 1

	)

331 #ifdef 
_GNU_SOURCE


332 
	#__USE_GNU
 1

	)

335 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


336 
	#__USE_REENTRANT
 1

	)

339 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

340 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

341 #ià
_FORTIFY_SOURCE
 > 1

342 
	#__USE_FORTIFY_LEVEL
 2

	)

344 
	#__USE_FORTIFY_LEVEL
 1

	)

347 
	#__USE_FORTIFY_LEVEL
 0

	)

352 
	~<¡dc-´edef.h
>

360 #undeà
__GNU_LIBRARY__


361 
	#__GNU_LIBRARY__
 6

	)

365 
	#__GLIBC__
 2

	)

366 
	#__GLIBC_MINOR__
 19

	)

368 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

369 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ð((
maj
è<< 16è+ (
mš
))

	)

372 #iâdeà
__ASSEMBLER__


373 #iâdeà
_SYS_CDEFS_H


374 
	~<sys/cdefs.h
>

379 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


380 
	#__USE_LARGEFILE
 1

	)

381 
	#__USE_LARGEFILE64
 1

	)

387 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

388 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

389 && 
defšed
 
	g__ex‹º_šlše


390 
	#__USE_EXTERN_INLINES
 1

	)

398 
	~<gnu/¡ubs.h
>

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__k”Ãl_fd_£t
;

29 (*
	t__k”Ãl_sighªdËr_t
)();

32 
	t__k”Ãl_key_t
;

33 
	t__k”Ãl_mqd_t
;

35 
	~<asm/posix_ty³s.h
>

	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tÞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/linux/stddef.h

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

54 
	#__STDC_ISO_10646__
 201103L

	)

57 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
31
602
cache.c
config.c
dir.c
fat.h
fat.mod.c
fatent.c
file.c
inode.c
misc.c
namei_msdos.c
namei_vfat.c
nfs.c
vfat.mod.c
/usr/include/linux/capability.h
/usr/include/linux/fs.h
/usr/include/linux/kernel.h
/usr/include/linux/msdos_fs.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/uio.h
/usr/include/linux/ioctl.h
/usr/include/linux/limits.h
/usr/include/linux/magic.h
/usr/include/linux/sysinfo.h
/usr/include/linux/types.h
/usr/include/string.h
/usr/include/features.h
/usr/include/linux/posix_types.h
/usr/include/xlocale.h
/usr/include/linux/stddef.h
/usr/include/stdc-predef.h
